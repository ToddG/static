                                                       ATmega48A/PA/88A/PA/168A/PA/328/P
                                                           megaAVR® Data Sheet
Introduction

The ATmega48A/PA/88A/PA/168A/PA/328/P is a low power, CMOS 8-bit microcontrollers based on the
AVR® enhanced RISC architecture. By executing instructions in a single clock cycle, the devices achieve
CPU throughput approaching one million instructions per second (MIPS) per megahertz, allowing the sys-
tem designer to optimize power consumption versus processing speed.



Features

   High Performance, Low Power AVR® 8-Bit Microcontroller Family

   Advanced RISC Architecture
                  ̶           131 Powerful Instructions – Most Single Clock Cycle Execution
                  ̶           32 x 8 General Purpose Working Registers
                  ̶           Fully Static Operation
                  ̶           Up to 20 MIPS Throughput at 20MHz
                  ̶           On-chip 2-cycle Multiplier

   High Endurance Non-volatile Memory Segments
              ̶               4/8/16/32KBytes of In-System Self-Programmable Flash program memory
              ̶               256/512/512/1KBytes EEPROM
              ̶               512/1K/1K/2KBytes Internal SRAM
              ̶               Write/Erase Cycles: 10,000 Flash/100,000 EEPROM
                          ̶   Data retention: 20 years at 85°C/100 years at 25°C(1)
                      ̶       Optional Boot Code Section with Independent Lock Bits
                                  In-System Programming by On-chip Boot Program
                                  True Read-While-Write Operation
      ̶                       Programming Lock for Software Security

   QTouch® library support
          ̶                   Capacitive touch buttons, sliders and wheels
          ̶                   QTouch and QMatrix™ acquisition
          ̶                   Up to 64 sense channels

   Peripheral Features
              ̶               Two 8-bit Timer/Counters with Separate Prescaler and Compare Mode
              ̶               One 16-bit Timer/Counter with Separate Prescaler, Compare Mode, and Capture Mode



 2020 Microchip Technology Inc.                                       Data Sheet Complete             DS40002061B-page 1
                                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

                            ̶       Real Time Counter with Separate Oscillator
                            ̶       Six PWM Channels
                            ̶       8-channel 10-bit ADC in TQFP and VQFN package
                                        Temperature Measurement
                ̶                   6-channel 10-bit ADC in SPDIP Package
                                        Temperature Measurement
                ̶                   Programmable Serial USART
                ̶                   Master/Slave SPI Serial Interface
            ̶                       Byte-oriented 2-wire Serial Interface (Philips I2C compatible)
        ̶                           Programmable Watchdog Timer with Separate On-chip Oscillator
                                ̶   On-chip Analog Comparator
                                ̶   Interrupt and Wake-up on Pin Change

   Special Microcontroller Features
                        ̶           Power-on Reset and Programmable Brown-out Detection
                    ̶               Internal Calibrated Oscillator
                    ̶               External and Internal Interrupt Sources
                    ̶               Six Sleep Modes: Idle, ADC Noise Reduction, Power-save, Power-down, Standby, and Extended Standby

   I/O and Packages
                        ̶           23 Programmable I/O Lines
                    ̶               28-pin SPDIP, 32-lead TQFP, 28-pad VQFN and 32-pad VQFN

   Operating Voltage:
                        ̶           1.8 - 5.5V

   Temperature Range:
                        ̶           -40°C to 85°C

   Speed Grade:
                        ̶           0 - 4MHz@1.8 - 5.5V, 0 - 10MHz@2.7 - 5.5.V, 0 - 20MHz @ 4.5 - 5.5V

   Power Consumption at 1MHz, 1.8V, 25°C
                        ̶           Active Mode: 0.2mA
                    ̶               Power-down Mode: 0.1µA
                                    • Power-save Mode: 0.75µA (Including 32kHz RTC)


Note:                               1. See “Data Retention” on page 17 for details.




 2020 Microchip Technology Inc.                                                         Data Sheet Complete                DS40002061B-page 2
                                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Table of Contents
1     Pin Configurations                      .............................................................................................................. 12

         1.1          Pin Descriptions............................................................................................... 13

2     Overview .................................................................................................................................... 15
         2.1          Block Diagram ................................................................................................. 15
         2.2          Comparison Between Processors ................................................................... 16

3     Resources              ................................................................................................................................ 17

4     Data Retention                  ....................................................................................................................... 17

5     About Code Examples                             ...................................................................................................... 17

6     Capacitive Touch Sensing                                 ............................................................................................. 17

7     AVR CPU Core                    ....................................................................................................................... 18

         7.1          Overview.......................................................................................................... 18
         7.2          ALU – Arithmetic Logic Unit............................................................................. 19
         7.3          Status Register ................................................................................................ 19
         7.4          General Purpose Register File ........................................................................ 20
         7.5          Stack Pointer ................................................................................................... 22
         7.6          Instruction Execution Timing ........................................................................... 23
         7.7          Reset and Interrupt Handling........................................................................... 23

8     AVR Memories                    ....................................................................................................................... 26

         8.1          Overview.......................................................................................................... 26
         8.2          In-System Reprogrammable Flash Program Memory ..................................... 26
         8.3          SRAM Data Memory........................................................................................ 28
         8.4          EEPROM Data Memory .................................................................................. 29
         8.5          I/O Memory...................................................................................................... 30
         8.6          Register Description ........................................................................................ 31

9     System Clock and Clock Options .............................................................................. 36
         9.1          Clock Systems and their Distribution ............................................................... 36
         9.2          Clock Sources ................................................................................................. 37
         9.3          Low Power Crystal Oscillator........................................................................... 38
         9.4          Full Swing Crystal Oscillator ............................................................................ 39
         9.5          Low Frequency Crystal Oscillator .................................................................... 42
         9.6          Calibrated Internal RC Oscillator ..................................................................... 43
         9.7          128kHz Internal Oscillator ............................................................................... 43



 2020 Microchip Technology Inc.                                                           Data Sheet Complete                                                     DS40002061B-page 3
                                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

            9.8          External Clock ................................................................................................. 44
            9.9          Clock Output Buffer ......................................................................................... 45
            9.10         Timer/Counter Oscillator.................................................................................. 45
            9.11         System Clock Prescaler .................................................................................. 45
            9.12         Register Description ........................................................................................ 46

10 Power Management and Sleep Modes                                                      ................................................................... 48

            10.1         Sleep Modes.................................................................................................... 48
            10.2         BOD Disable(1) ................................................................................................ 49
            10.3         Idle Mode......................................................................................................... 49
            10.4         ADC Noise Reduction Mode............................................................................ 49
            10.5         Power-down Mode........................................................................................... 49
            10.6         Power-save Mode............................................................................................ 50
            10.7         Standby Mode ................................................................................................. 50
            10.8         Extended Standby Mode ................................................................................. 51
            10.9         Power Reduction Register ............................................................................... 51
            10.10        Minimizing Power Consumption ...................................................................... 51
            10.11        Register Description ........................................................................................ 53

11 System Control and Reset                                    ............................................................................................. 56

            11.1         Resetting the AVR ........................................................................................... 56
            11.2         Reset Sources ................................................................................................. 56
            11.3         Power-on Reset............................................................................................... 57
            11.4         External Reset ................................................................................................. 58
            11.5         Brown-out Detection ........................................................................................ 58
            11.6         Watchdog System Reset ................................................................................. 59
            11.7         Internal Voltage Reference .............................................................................. 59
            11.8         Watchdog Timer .............................................................................................. 60
            11.9         Register Description ........................................................................................ 63

12 Interrupts ................................................................................................................................... 66
            12.1         Interrupt Vectors in ATmega48A and ATmega48PA ....................................... 66
            12.2         Interrupt Vectors in ATmega88A and ATmega88PA ....................................... 68
            12.3         Interrupt Vectors in ATmega168A and ATmega168PA ................................... 71
            12.4         Interrupt Vectors in ATmega328 and ATmega328P........................................ 74
            12.5         Register Description ........................................................................................ 77

13 External Interrupts                         .............................................................................................................. 79

            13.1         Pin Change Interrupt Timing............................................................................ 79



 2020 Microchip Technology Inc.                                                           Data Sheet Complete                                                     DS40002061B-page 4
                                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

            13.2         Register Description ........................................................................................ 80

14 I/O-Ports ..................................................................................................................................... 84
            14.1         Overview.......................................................................................................... 84
            14.2         Ports as General Digital I/O ............................................................................. 85
            14.3         Alternate Port Functions .................................................................................. 89
            14.4         Register Description ...................................................................................... 100

15 8-bit Timer/Counter0 with PWM                                        ................................................................................ 102

            15.1         Features ........................................................................................................ 102
            15.2         Overview........................................................................................................ 102
            15.3         Timer/Counter Clock Sources ....................................................................... 103
            15.4         Counter Unit .................................................................................................. 103
            15.5         Output Compare Unit..................................................................................... 104
            15.6         Compare Match Output Unit .......................................................................... 106
            15.7         Modes of Operation ....................................................................................... 107
            15.8         Timer/Counter Timing Diagrams ................................................................... 111
            15.9         Register Description ...................................................................................... 113

16 16-bit Timer/Counter1 with PWM                                          ............................................................................. 120

            16.1         Features ........................................................................................................ 120
            16.2         Overview........................................................................................................ 120
            16.3         Accessing 16-bit Registers ............................................................................ 122
            16.4         Timer/Counter Clock Sources ....................................................................... 125
            16.5         Counter Unit .................................................................................................. 125
            16.6         Input Capture Unit ......................................................................................... 126
            16.7         Output Compare Units ................................................................................... 128
            16.8         Compare Match Output Unit .......................................................................... 130
            16.9         Modes of Operation ....................................................................................... 131
            16.10        Timer/Counter Timing Diagrams ................................................................... 138
            16.11        Register Description ...................................................................................... 140

17 Timer/Counter0 and Timer/Counter1 Prescalers                                                            ........................................... 147

            17.1         Internal Clock Source .................................................................................... 147
            17.2         Prescaler Reset ............................................................................................. 147
            17.3         External Clock Source ................................................................................... 147
            17.4         Register Description ...................................................................................... 149

18 8-bit Timer/Counter2 with PWM and Asynchronous Operation                                                                               ........... 150

            18.1         Features ........................................................................................................ 150


 2020 Microchip Technology Inc.                                                         Data Sheet Complete                                                   DS40002061B-page 5
                                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

            18.2        Overview........................................................................................................ 150
            18.3        Timer/Counter Clock Sources ....................................................................... 151
            18.4        Counter Unit .................................................................................................. 151
            18.5        Output Compare Unit..................................................................................... 152
            18.6        Compare Match Output Unit .......................................................................... 154
            18.7        Modes of Operation ....................................................................................... 155
            18.8        Timer/Counter Timing Diagrams ................................................................... 159
            18.9        Asynchronous Operation of Timer/Counter2 ................................................. 160
            18.10       Timer/Counter Prescaler ............................................................................... 161
            18.11       Register Description ...................................................................................... 162

19 SPI – Serial Peripheral Interface ............................................................................... 169
            19.1        Features ........................................................................................................ 169
            19.2        Overview........................................................................................................ 169
            19.3        SS Pin Functionality ...................................................................................... 174
            19.4        Data Modes ................................................................................................... 174
            19.5        Register Description ...................................................................................... 176

20 USART0 .................................................................................................................................... 179
            20.1        Features ........................................................................................................ 179
            20.2        Overview........................................................................................................ 179
            20.3        Clock Generation ........................................................................................... 180
            20.4        Frame Formats .............................................................................................. 183
            20.5        USART Initialization....................................................................................... 184
            20.6        Data Transmission – The USART Transmitter .............................................. 185
            20.7        Data Reception – The USART Receiver ....................................................... 188
            20.8        Asynchronous Data Reception ...................................................................... 192
            20.9        Multi-processor Communication Mode .......................................................... 195
            20.10       Examples of Baud Rate Setting..................................................................... 196
            20.11       Register Description ...................................................................................... 200

21 USART in SPI Mode .......................................................................................................... 205
            21.1        Features ........................................................................................................ 205
            21.2        Overview........................................................................................................ 205
            21.3        Clock Generation ........................................................................................... 205
            21.4        SPI Data Modes and Timing.......................................................................... 206
            21.5        Frame Formats .............................................................................................. 206
            21.6        Data Transfer................................................................................................. 209




 2020 Microchip Technology Inc.                                                      Data Sheet Complete                                            DS40002061B-page 6
                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

         21.7     AVR USART MSPIM vs. AVR SPI ................................................................ 211
         21.8     Register Description ...................................................................................... 212

22 2-wire Serial Interface                   ..................................................................................................... 215

         22.1     Features ........................................................................................................ 215
         22.2     2-wire Serial Interface Bus Definition ............................................................ 215
         22.3     Data Transfer and Frame Format .................................................................. 216
         22.4     Multi-master Bus Systems, Arbitration and Synchronization ......................... 219
         22.5     Overview of the TWI Module ......................................................................... 221
         22.6     Using the TWI................................................................................................ 223
         22.7     Transmission Modes ..................................................................................... 225
         22.8     Multi-master Systems and Arbitration............................................................ 238
         22.9     Register Description ...................................................................................... 239

23 Analog Comparator                     .......................................................................................................... 243

         23.1     Overview........................................................................................................ 243
         23.2     Analog Comparator Multiplexed Input ........................................................... 243
         23.3     Register Description ...................................................................................... 244

24 Analog-to-Digital Converter                            ........................................................................................ 246

         24.1     Features ........................................................................................................ 246
         24.2     Overview........................................................................................................ 246
         24.3     Starting a Conversion .................................................................................... 248
         24.4     Prescaling and Conversion Timing ................................................................ 249
         24.5     Changing Channel or Reference Selection ................................................... 251
         24.6     ADC Noise Canceler ..................................................................................... 252
         24.7     ADC Conversion Result................................................................................. 256
         24.8     Temperature Measurement ........................................................................... 256
         24.9     Register Description ...................................................................................... 257

25 debugWIRE On-chip Debug System ...................................................................... 262
         25.1     Features ........................................................................................................ 262
         25.2     Overview........................................................................................................ 262
         25.3     Physical Interface .......................................................................................... 262
         25.4     Software Break Points ................................................................................... 263
         25.5     Limitations of debugWIRE ............................................................................. 263
         25.6     Register Description ...................................................................................... 263

26 Self-Programming the Flash, ATmega 48A/48PA .......................................... 264
         26.1     Overview........................................................................................................ 264


 2020 Microchip Technology Inc.                                                   Data Sheet Complete                                                    DS40002061B-page 7
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

         26.2     Addressing the Flash During Self-Programming ........................................... 265
         26.3     Register Description ...................................................................................... 270

27 Boot Loader Support – Read-While-Write Self-Programming                                                                      ............... 272

         27.1     Features ........................................................................................................ 272
         27.2     Overview........................................................................................................ 272
         27.3     Application and Boot Loader Flash Sections ................................................. 272
         27.4     Read-While-Write and No Read-While-Write Flash Sections........................ 273
         27.5     Boot Loader Lock Bits ................................................................................... 275
         27.6     Entering the Boot Loader Program ................................................................ 276
         27.7     Addressing the Flash During Self-Programming ........................................... 277
         27.8     Self-Programming the Flash .......................................................................... 278
         27.9     Register Description ...................................................................................... 287

28 Memory Programming                         .................................................................................................... 289

         28.1     Program And Data Memory Lock Bits ........................................................... 289
         28.2     Fuse Bits........................................................................................................ 290
         28.3     Signature Bytes ............................................................................................. 293
         28.4     Calibration Byte ............................................................................................. 293
         28.5     Page Size ...................................................................................................... 294
         28.6     Parallel Programming Parameters, Pin Mapping, and Commands ............... 294
         28.7     Parallel Programming .................................................................................... 296
         28.8     Serial Downloading........................................................................................ 303

29 Electrical Characteristics – (TA = -40°C to 85°C)                                                 ........................................... 308

         29.1     Absolute Maximum Ratings* ......................................................................... 308
         29.2     DC Characteristics......................................................................................... 308
         29.3     Speed Grades ............................................................................................... 312
         29.4     Clock Characteristics ..................................................................................... 313
         29.5     System and Reset Characteristics ................................................................ 314
         29.6     SPI Timing Characteristics ............................................................................ 315
         29.7     Two-wire Serial Interface Characteristics ...................................................... 317
         29.8     ADC Characteristics ...................................................................................... 319
         29.9     Parallel Programming Characteristics ........................................................... 320

30 Electrical Characteristics (TA = -40°C to 105°C)                                                 ............................................ 322

         30.1     Absolute Maximum Ratings* ......................................................................... 322
         30.2     DC Characteristics......................................................................................... 322

31 Typical Characteristics – (TA = -40°C to 85°C) ................................................ 326


 2020 Microchip Technology Inc.                                                  Data Sheet Complete                                                    DS40002061B-page 8
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

         31.1     ATmega48A Typical Characteristics ............................................................. 327
         31.2     ATmega48PA Typical Characteristics ........................................................... 352
         31.3     ATmega88A Typical Characteristics ............................................................. 377
         31.4     ATmega88PA Typical Characteristics ........................................................... 401
         31.5     ATmega168A Typical Characteristics ........................................................... 427
         31.6     ATmega168PA Typical Characteristics ......................................................... 451
         31.7     ATmega328 Typical Characteristics .............................................................. 477
         31.8     ATmega328P Typical Characteristics ........................................................... 501

32 ATmega48PA Typical Characteristics – (TA = -40°C to 105°C) ............. 526
         32.1     Active Supply Current .................................................................................... 526
         32.2     Idle Supply Current ........................................................................................ 529
         32.3     Power-down Supply Current.......................................................................... 531
         32.4     Standby Supply Current ................................................................................ 532
         32.5     Pin Pull-Up..................................................................................................... 533
         32.6     Pin Driver Strength ........................................................................................ 536
         32.7     Pin Threshold and Hysteresis........................................................................ 538
         32.8     BOD Threshold .............................................................................................. 541
         32.9     Internal Oscillator Speed ............................................................................... 542
         32.10    Current Consumption of Peripheral Units ...................................................... 545
         32.11    Current Consumption in Reset and Reset Pulsewidth .................................. 547

33 ATmega88PA Typical Characteristics – (TA = -40°C to 105°C) ............. 549
         33.1     Active Supply Current .................................................................................... 549
         33.2     Idle Supply Current ........................................................................................ 552
         33.3     Power-down Supply Current.......................................................................... 554
         33.4     Power-save Supply Current........................................................................... 555
         33.5     Pin Pull-Up..................................................................................................... 556
         33.6     Pin Driver Strength ........................................................................................ 559
         33.7     Pin Threshold and Hysteresis........................................................................ 561
         33.8     BOD Threshold .............................................................................................. 564
         33.9     Internal Oscillator Speed ............................................................................... 565
         33.10    Current Consumption of Peripheral Units ...................................................... 568
         33.11    Current Consumption in Reset and Reset Pulsewidth .................................. 570

34 ATmega168PA Typical Characteristics – (TA = -40°C to 105°C)                                                          .......... 572

         34.1     Active Supply Current .................................................................................... 572
         34.2     Idle Supply Current ........................................................................................ 575




 2020 Microchip Technology Inc.                                            Data Sheet Complete                                          DS40002061B-page 9
                                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

           34.3       Power-down Supply Current.......................................................................... 577
           34.4       Power-save Supply Current........................................................................... 578
           34.5       Standby Supply Current ................................................................................ 579
           34.6       Pin Pull-Up..................................................................................................... 579
           34.7       Pin Driver Strength ........................................................................................ 582
           34.8       Pin Threshold and Hysteresis........................................................................ 584
           34.9       BOD Threshold .............................................................................................. 587
           34.10      Internal Oscillator Speed ............................................................................... 590
           34.11      Current Consumption of Peripheral Units ...................................................... 592
           34.12      Current Consumption in Reset and Reset Pulsewidth .................................. 595

35 ATmega328P Typical Characteristics – (TA = -40°C to 105°C) .............. 597
           35.1       ATmega328P Active Supply Current ............................................................. 597
           35.2       Idle Supply Current ........................................................................................ 600
           35.3       Power-down Supply Current.......................................................................... 602
           35.4       Power-save Supply Current........................................................................... 603
           35.5       Standby Supply Current ................................................................................ 604
           35.6       Pin Pull-Up..................................................................................................... 604
           35.7       Pin Driver Strength ........................................................................................ 607
           35.8       Pin Threshold and Hysteresis........................................................................ 609
           35.9       BOD Threshold .............................................................................................. 612
           35.10      Internal Oscillator Speed ............................................................................... 614
           35.11      Current Consumption of Peripheral Units ...................................................... 617
           35.12      Current Consumption in Reset and Reset Pulsewidth .................................. 619

36 Register Summary ............................................................................................................. 621

37 Instruction Set Summary                             .............................................................................................. 625

38 Ordering Information                        ....................................................................................................... 628

           38.1       ATmega48A .................................................................................................. 628
           38.2       ATmega48PA ................................................................................................ 629
           38.3       ATmega88A................................................................................................... 630
           38.4       ATmega88PA ................................................................................................ 631
           38.5       ATmega168A................................................................................................. 632
           38.6       ATmega168PA ............................................................................................. 633
           38.7       ATmega328 .................................................................................................. 634
           38.8       ATmega328P ................................................................................................ 635

39 Packaging Information                          ................................................................................................... 636



 2020 Microchip Technology Inc.                                                      Data Sheet Complete                                                    DS40002061B-page 10
                                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

          39.1       32A ................................................................................................................ 636
          39.2       28M1.............................................................................................................. 638
          39.3       32M1-A .......................................................................................................... 641
          39.4       28P3 .............................................................................................................. 644

40 Errata         ......................................................................................................................................... 645

41 Datasheet Revision History ......................................................................................... 646
          41.1       Rev. B – 08/2020 ........................................................................................... 646
          41.2       Rev. A – 10/2018 ........................................................................................... 646
          41.3       Rev. 8271J – 11/2015 ................................................................................... 646
          41.4       Rev. 8271I – 10/2014 .................................................................................... 646
          41.5       Rev. 8271H – 08/2014................................................................................... 647
          41.6       Rev. 8271G – 02/2013 .................................................................................. 647
          41.7       Rev. 8271F – 08/2012 ................................................................................... 647
          41.8       Rev. 8271E – 07/2012 ................................................................................... 647
          41.9       Rev. 8271D – 05/11....................................................................................... 648
          41.10      Rev. 8271C – 08/10....................................................................................... 648
          41.11      Rev. 8271B – 04/10....................................................................................... 648
          41.12      Rev. 8271A – 12/09....................................................................................... 649




 2020 Microchip Technology Inc.                                                           Data Sheet Complete                                                    DS40002061B-page 11
                                                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

1.      Pin Configurations
Figure 1-1.          Pinout ATmega48A/PA/88A/PA/168A/PA/328/P
                                                                32 TQFP Top View                                                                                            28 6PDIP




                                                                 PC4 (ADC4/SDA/PCINT12)
                                                                 PC5 (ADC5/SCL/PCINT13)
                                                                 PC6 (RESET/PCINT14)



                                                                 PC3 (ADC3/PCINT11)
                                                                 PC2 (ADC2/PCINT10)
                                                                 PD2 (INT0/PCINT18)

                                                                 PD0 (RXD/PCINT16)
                                                                 PD1 (TXD/PCINT17)
                                                                                                                                                   (PCINT14/RESET) PC6     1           28    PC5 (ADC5/SCL/PCINT13)


                                                                 32
                                                                 31
                                                                 30
                                                                 29
                                                                 28
                                                                 27
                                                                 26
                                                                 25
                                                                                                                                                     (PCINT16/RXD) PD0     2           27    PC4 (ADC4/SDA/PCINT12)
                                                                                                                                                      (PCINT17/TXD) PD1    3           26    PC3 (ADC3/PCINT11)
                           (PCINT19/OC2B/INT1) PD3      1                                          24     PC1 (ADC1/PCINT9)
                                                                                                                                                     (PCINT18/INT0) PD2    4           25    PC2 (ADC2/PCINT10)
                              (PCINT20/XCK/T0) PD4      2                                          23     PC0 (ADC0/PCINT8)
                                                                                                                                              (PCINT19/OC2B/INT1) PD3      5           24    PC1 (ADC1/PCINT9)
                                              GND       3                                          22     ADC7
                                                                                                                                                  (PCINT20/XCK/T0) PD4     6           23    PC0 (ADC0/PCINT8)
                                              VCC       4                                          21     GND
                                                                                                                                                                   VCC     7           22    GND
                                              GND       5                                          20     AREF
                                                                                                                                                                   GND     8           21    AREF
                                              VCC       6                                          19     ADC6
                                                                                                                                            (PCINT6/XTAL1/TOSC1) PB6       9           20    AVCC
                         (PCINT6/XTAL1/TOSC1) PB6       7                                          18     AVCC
                                                                                                                                            (PCINT7/XTAL2/TOSC2) PB7       10          19    PB5 (SCK/PCINT5)
                         (PCINT7/XTAL2/TOSC2) PB7       8                                          17     PB5 (SCK/PCINT5)
                                                                                                                                                (PCINT21/OC0B/T1) PD5      11          18    PB4 (MISO/PCINT4)
                                                                                                                                              (PCINT22/OC0A/AIN0) PD6      12          17    PB3 (MOSI/OC2A/PCINT3)
                                                                 10
                                                                 11
                                                                 12
                                                                 13
                                                                 14
                                                                 15
                                                                 16
                                                                 9




                                                                                                                                                     (PCINT23/AIN1) PD7    13          16    PB2 (SS/OC1B/PCINT2)
                                                                    (PCINT21/OC0B/T1) PD5
                                                                 (PCINT22/OC0A/AIN0) PD6
                                                                        (PCINT23/AIN1) PD7
                                                                   (PCINT0/CLKO/ICP1) PB0
                                                                        (PCINT1/OC1A) PB1
                                                                     (PCINT2/SS/OC1B) PB2
                                                                  (PCINT3/OC2A/MOSI) PB3
                                                                         (PCINT4/MISO) PB4




                                                                                                                                               (PCINT0/CLKO/ICP1) PB0      14          15    PB1 (OC1A/PCINT1)




                                                                28 94)1 Top View                                                                                      32 94)1 Top View




                                                                                                                                                                      PC4 (ADC4/SDA/PCINT12)
                                                                                                                                                                      PC5 (ADC5/SCL/PCINT13)
                                                                  PC4 (ADC4/SDA/PCINT12)
                                                                  PC5 (ADC5/SCL/PCINT13)




                                                                                                                                                                      PC6 (RESET/PCINT14)
                                                                  PC6 (RESET/PCINT14)




                                                                                                                                                                      PC3 (ADC3/PCINT11)
                                                                                                                                                                      PC2 (ADC2/PCINT10)
                                                                  PC3 (ADC3/PCINT11)




                                                                                                                                                                      PD2 (INT0/PCINT18)

                                                                                                                                                                      PD0 (RXD/PCINT16)
                                                                                                                                                                      PD1 (TXD/PCINT17)
                                                                  PD2 (INT0/PCINT18)

                                                                  PD0 (RXD/PCINT16)
                                                                  PD1 (TXD/PCINT17)




                                                                                                                                                                      32
                                                                                                                                                                      31
                                                                                                                                                                      30
                                                                                                                                                                      29
                                                                                                                                                                      28
                                                                                                                                                                      27
                                                                                                                                                                      26
                                                                                                                                                                      25
                                                                  28
                                                                  27
                                                                  26
                                                                  25
                                                                  24
                                                                  23
                                                                  22




                             (PCINT19/OC2B/INT1) PD3        1                                 21        PC2 (ADC2/PCINT10)         (PCINT19/OC2B/INT1) PD3     1                                  24   PC1 (ADC1/PCINT9)
                                 (PCINT20/XCK/T0) PD4       2                                 20        PC1 (ADC1/PCINT9)             (PCINT20/XCK/T0) PD4     2                                  23   PC0 (ADC0/PCINT8)
                                                 VCC        3                                 19        PC0 (ADC0/PCINT8)                             GND      3                                  22   ADC7
                                                 GND        4                                 18        GND                                           VCC      4                                  21   GND
                           (PCINT6/XTAL1/TOSC1) PB6         5                                 17        AREF                                          GND      5                                  20   AREF
                           (PCINT7/XTAL2/TOSC2) PB7         6                                 16        AVCC                                          VCC      6                                  19   ADC6
                               (PCINT21/OC0B/T1) PD5        7                                 15        PB5 (SCK/PCINT5)         (PCINT6/XTAL1/TOSC1) PB6      7                                  18   AVCC
                                                                                                                                 (PCINT7/XTAL2/TOSC2) PB7      8                                  17   PB5 (SCK/PCINT5)
                                                                  10
                                                                  11
                                                                  12
                                                                  13
                                                                  14
                                                                  8
                                                                  9




                                                                                                                                                                      10
                                                                                                                                                                      11
                                                                                                                                                                      12
                                                                                                                                                                      13
                                                                                                                                                                      14
                                                                                                                                                                      15
                                                                                                                                                                      16
                                                                                                                                                                      9
                                                                  (PCINT22/OC0A/AIN0) PD6
                                                                         (PCINT23/AIN1) PD7
                                                                    (PCINT0/CLKO/ICP1) PB0
                                                                         (PCINT1/OC1A) PB1
                                                                      (PCINT2/SS/OC1B) PB2
                                                                   (PCINT3/OC2A/MOSI) PB3
                                                                          (PCINT4/MISO) PB4




                                                                                                                                                                         (PCINT21/OC0B/T1) PD5
                                                                                                                                                                      (PCINT22/OC0A/AIN0) PD6
                                                                                                                                                                             (PCINT23/AIN1) PD7
                                                                                                                                                                        (PCINT0/CLKO/ICP1) PB0
                                                                                                                                                                             (PCINT1/OC1A) PB1
                                                                                                                                                                          (PCINT2/SS/OC1B) PB2
                                                                                                                                                                       (PCINT3/OC2A/MOSI) PB3
                                                                                                                                                                              (PCINT4/MISO) PB4




              NOTE: Bottom pad should be soldered to ground.
                                                                                                                     NOTE: Bottom pad should be soldered to ground.




          2020 Microchip Technology Inc.                                                                                Data Sheet Complete                                                            DS40002061B-page 12
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

1.1     Pin Descriptions

1.1.1   VCC
        Digital supply voltage.

1.1.2   GND
        Ground.

1.1.3   Port B (PB7:0) XTAL1/XTAL2/TOSC1/TOSC2
        Port B is an 8-bit bi-directional I/O port with internal pull-up resistors (selected for each bit). The Port B output
        buffers have symmetrical drive characteristics with both high sink and source capability. As inputs, Port B pins
        that are externally pulled low will source current if the pull-up resistors are activated. The Port B pins are tri-
        stated when a reset condition becomes active, even if the clock is not running.
        Depending on the clock selection fuse settings, PB6 can be used as input to the inverting Oscillator amplifier
        and input to the internal clock operating circuit.
        Depending on the clock selection fuse settings, PB7 can be used as output from the inverting Oscillator
        amplifier.
        If the Internal Calibrated RC Oscillator is used as chip clock source, PB7...6 is used as TOSC2...1 input for the
        Asynchronous Timer/Counter2 if the AS2 bit in ASSR is set.
        The various special features of Port B are elaborated in ”Alternate Functions of Port B” on page 91 and ”System
        Clock and Clock Options” on page 36.

1.1.4   Port C (PC5:0)
        Port C is a 7-bit bi-directional I/O port with internal pull-up resistors (selected for each bit). The PC5...0 output
        buffers have symmetrical drive characteristics with both high sink and source capability. As inputs, Port C pins
        that are externally pulled low will source current if the pull-up resistors are activated. The Port C pins are tri-
        stated when a reset condition becomes active, even if the clock is not running.

1.1.5   PC6/RESET
        If the RSTDISBL Fuse is programmed, PC6 is used as an I/O pin. Note that the electrical characteristics of PC6
        differ from those of the other pins of Port C.
        If the RSTDISBL Fuse is unprogrammed, PC6 is used as a Reset input. A low level on this pin for longer than
        the minimum pulse length will generate a Reset, even if the clock is not running. The minimum pulse length is
        given in Table 29-11 on page 314. Shorter pulses are not ensured to generate a Reset.
        The various special features of Port C are elaborated in ”Alternate Functions of Port C” on page 94.

1.1.6   Port D (PD7:0)
        Port D is an 8-bit bi-directional I/O port with internal pull-up resistors (selected for each bit). The Port D output
        buffers have symmetrical drive characteristics with both high sink and source capability. As inputs, Port D pins
        that are externally pulled low will source current if the pull-up resistors are activated. The Port D pins are tri-
        stated when a reset condition becomes active, even if the clock is not running.
        The various special features of Port D are elaborated in ”Alternate Functions of Port D” on page 97.




         2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 13
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

1.1.7   AVCC
        AVCC is the supply voltage pin for the A/D Converter, PC3:0, and ADC7:6. It should be externally connected to
        VCC, even if the ADC is not used. If the ADC is used, it should be connected to VCC through a low-pass filter.
        Note that PC6...4 use digital supply voltage, VCC.

1.1.8   AREF
        AREF is the analog reference pin for the A/D Converter.

1.1.9   ADC7:6 (TQFP and VQFN Package Only)
        In the TQFP and VQFN package, ADC7:6 serve as analog inputs to the A/D converter. These pins are powered
        from the analog supply and serve as 10-bit ADC channels.




         2020 Microchip Technology Inc.                   Data Sheet Complete                      DS40002061B-page 14
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

2.    Overview
      The ATmega48A/PA/88A/PA/168A/PA/328/P is a low-power CMOS 8-bit microcontroller based on the AVR
      enhanced RISC architecture. By executing powerful instructions in a single clock cycle, the
      ATmega48A/PA/88A/PA/168A/PA/328/P achieves throughputs approaching 1 MIPS per MHz allowing the
      system designer to optimize power consumption versus processing speed.

2.1   Block Diagram

      Figure 2-1.    Block Diagram




                                                                         VCC
                                                        GND
                                          Watchdog        Power                 debugWIRE
                                           Timer        Supervision
                                          Watchdog      POR / BOD &
                                                                                 PROGRAM
                                          Oscillator      RESET                    LOGIC



                                          Oscillator
                                                              Flash                  SRAM
                                           Circuits /
                                            Clock
                                          Generation


                                                                               CPU

                                           EEPROM

                                                                                                            AVCC

                                                                                                            AREF

                                                                                                            GND

                                                                                                    2
                                          8bit T/C 0     16bit T/C 1             A/D Conv.
                                DATABUS




                                                              Analog              Internal      6
                                          8bit T/C 2
                                                              Comp.              Bandgap




                                           USART 0             SPI                    TWI




                                          PORT D (8)    PORT B (8)              PORT C (7)


                                                                                                             RESET


                                                                                                            XTAL[1..2]


                                             PD[0..7]         PB[0..7]               PC[0..6]   ADC[6..7]


      The AVR core combines a rich instruction set with 32 general purpose working registers. All the 32 registers are
      directly connected to the Arithmetic Logic Unit (ALU), allowing two independent registers to be accessed in one
      single instruction executed in one clock cycle. The resulting architecture is more code efficient while achieving
      throughputs up to ten times faster than conventional CISC microcontrollers.




       2020 Microchip Technology Inc.                         Data Sheet Complete                                       DS40002061B-page 15
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

      The ATmega48A/PA/88A/PA/168A/PA/328/P provides the following features: 4K/8Kbytes of In-System
      Programmable Flash with Read-While-Write capabilities, 256/512/512/1Kbytes EEPROM, 512/1K/1K/2Kbytes
      SRAM, 23 general purpose I/O lines, 32 general purpose working registers, three flexible Timer/Counters with
      compare modes, internal and external interrupts, a serial programmable USART, a byte-oriented 2-wire Serial
      Interface, an SPI serial port, a 6-channel 10-bit ADC (8 channels in TQFP and VQFN packages), a
      programmable Watchdog Timer with internal Oscillator, and five software selectable power saving modes. The
      Idle mode stops the CPU while allowing the SRAM, Timer/Counters, USART, 2-wire Serial Interface, SPI port,
      and interrupt system to continue functioning. The Power-down mode saves the register contents but freezes the
      Oscillator, disabling all other chip functions until the next interrupt or hardware reset. In Power-save mode, the
      asynchronous timer continues to run, allowing the user to maintain a timer base while the rest of the device is
      sleeping. The ADC Noise Reduction mode stops the CPU and all I/O modules except asynchronous timer and
      ADC, to minimize switching noise during ADC conversions. In Standby mode, the crystal/resonator Oscillator is
      running while the rest of the device is sleeping. This allows very fast start-up combined with low power
      consumption.
      Microchip offers the QTouch library for embedding capacitive touch buttons, sliders and wheels functionality into
      AVR® microcontrollers. The patented charge-transfer signal acquisition offers robust sensing and includes fully
      debounced reporting of touch keys and includes Adjacent Key Suppression™ (AKS™) technology for
      unambiguous detection of key events. The easy-to-use QTouch Suite toolchain allows you to explore, develop
      and debug your own touch applications.
      The device is manufactured using Microchip’s high density non-volatile memory technology. The On-chip ISP
      Flash allows the program memory to be reprogrammed In-System through an SPI serial interface, by a
      conventional non-volatile memory programmer, or by an On-chip Boot program running on the AVR core. The
      Boot program can use any interface to download the application program in the Application Flash memory.
      Software in the Boot Flash section will continue to run while the Application Flash section is updated, providing
      true Read-While-Write operation. By combining an 8-bit RISC CPU with In-System Self-Programmable Flash on
      a monolithic chip, the ATmega48A/PA/88A/PA/168A/PA/328/P is a powerful microcontroller that provides a
      highly flexible and cost effective solution to many embedded control applications.
      The ATmega48A/PA/88A/PA/168A/PA/328/P AVR is supported with a full suite of program and system
      development tools including: C Compilers, Macro Assemblers, Program Debugger/Simulators, In-Circuit
      Emulators, and Evaluation kits.

2.2   Comparison Between Processors
      The ATmega48A/PA/88A/PA/168A/PA/328/P differ only in memory sizes, boot loader support, and interrupt
      vector sizes. Table 2-1 summarizes the different memory and interrupt vector sizes for the devices.

      Table 2-1.     Memory Size Summary
       Device              Flash          EEPROM          RAM               Interrupt Vector Size
       ATmega48A           4KBytes        256Bytes        512Bytes          1 instruction word/vector
       ATmega48PA          4KBytes        256Bytes        512Bytes          1 instruction word/vector
       ATmega88A           8KBytes        512Bytes        1KBytes           1 instruction word/vector
       ATmega88PA          8KBytes        512Bytes        1KBytes           1 instruction word/vector
       ATmega168A          16KBytes       512Bytes        1KBytes           2 instruction words/vector
       ATmega168PA         16KBytes       512Bytes        1KBytes           2 instruction words/vector
       ATmega328           32KBytes       1KBytes         2KBytes           2 instruction words/vector
       ATmega328P          32KBytes       1KBytes         2KBytes           2 instruction words/vector




       2020 Microchip Technology Inc.                     Data Sheet Complete                           DS40002061B-page 16
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

     ATmega48A/PA/88A/PA/168A/PA/328/P support a real Read-While-Write Self-Programming mechanism.
     There is a separate Boot Loader Section, and the SPM instruction can only execute from there. In ATmega
     48A/48PA there is no Read-While-Write support and no separate Boot Loader Section. The SPM instruction can
     execute from the entire Flash


3.   Resources
     A comprehensive set of development tools, application notes and data sheets are available for download on
     www.microchip.com
     Note:   1.


4.   Data Retention
     Reliability Qualification results show that the projected data retention failure rate is much less than 1 PPM over
     20 years at 85°C or 100 years at 25°C.


5.   About Code Examples
     This documentation contains simple code examples that briefly show how to use various parts of the device.
     These code examples assume that the part specific header file is included before compilation. Be aware that not
     all C compiler vendors include bit definitions in the header files and interrupt handling in C is compiler
     dependent. Confirm with the C compiler documentation for more details.
     For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
     be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
     “SBRS”, “SBRC”, “SBR”, and “CBR”.


6.   Capacitive Touch Sensing
     The QTouch Library provides a simple to use solution to realize touch sensitive interfaces on most AVR
     microcontrollers. The QTouch Library includes support for the QTouch and QMatrix™ acquisition methods.
     Touch sensing can be added to any application by linking the appropriate QTouch Library for the AVR
     Microcontroller. This is done by using a simple set of APIs to define the touch channels and sensors, and then
     calling the touch sensing APIs to retrieve the channel information and determine the touch sensor states.
     The QTouch Library is FREE and downloadable from the Microchip website at the following location
     http://www.microchip.com. For implementation details and other information, refer to the QTouch Library User
     Guide - also available for download from the Microchip website.




      2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 17
                                             ATmega48A/PA/88A/PA/168A/PA/328/P


7.    AVR CPU Core

7.1   Overview
      This section discusses the AVR core architecture in general. The main function of the CPU core is to ensure
      correct program execution. The CPU must therefore be able to access memories, perform calculations, control
      peripherals, and handle interrupts.

      Figure 7-1.    Block Diagram of the AVR Architecture


                                                                                             Data Bus 8-bit


                                               Program                                       Status
                               Flash
                                               Counter                                     and Control
                              Program
                              Memory

                                                                                                               Interrupt
                                                                                             32 x 8              Unit
                              Instruction                                                   General
                               Register                                                     Purpose              SPI
                                                                                           Registrers            Unit

                              Instruction                                                                     Watchdog
                               Decoder                                                                         Timer
                                                                     Indirect Addressing
                                                 Direct Addressing




                                                                                              ALU               Analog
                             Control Lines                                                                    Comparator



                                                                                                              I/O Module1


                                                                                              Data            I/O Module 2
                                                                                             SRAM


                                                                                                              I/O Module n
                                                                                           EEPROM



                                                                                            I/O Lines




      In order to maximize performance and parallelism, the AVR uses a Harvard architecture – with separate
      memories and buses for program and data. Instructions in the program memory are executed with a single level
      pipelining. While one instruction is being executed, the next instruction is pre-fetched from the program memory.
      This concept enables instructions to be executed in every clock cycle. The program memory is In-System
      Reprogrammable Flash memory.
      The fast-access Register File contains 32 x 8-bit general purpose working registers with a single clock cycle
      access time. This allows single-cycle Arithmetic Logic Unit (ALU) operation. In a typical ALU operation, two




       2020 Microchip Technology Inc.                                Data Sheet Complete                               DS40002061B-page 18
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

      operands are output from the Register File, the operation is executed, and the result is stored back in the
      Register File – in one clock cycle.
      Six of the 32 registers can be used as three 16-bit indirect address register pointers for Data Space addressing
      – enabling efficient address calculations. One of the these address pointers can also be used as an address
      pointer for look up tables in Flash program memory. These added function registers are the 16-bit X-, Y-, and Z-
      register, described later in this section.
      The ALU supports arithmetic and logic operations between registers or between a constant and a register.
      Single register operations can also be executed in the ALU. After an arithmetic operation, the Status Register is
      updated to reflect information about the result of the operation.
      Program flow is provided by conditional and unconditional jump and call instructions, able to directly address the
      whole address space. Most AVR instructions have a single 16-bit word format. Every program memory address
      contains a 16- or 32-bit instruction.
      Program Flash memory space is divided in two sections, the Boot Program section and the Application Program
      section. Both sections have dedicated Lock bits for write and read/write protection. The SPM instruction that
      writes into the Application Flash memory section must reside in the Boot Program section.
      During interrupts and subroutine calls, the return address Program Counter (PC) is stored on the Stack. The
      Stack is effectively allocated in the general data SRAM, and consequently the Stack size is only limited by the
      total SRAM size and the usage of the SRAM. All user programs must initialize the SP in the Reset routine
      (before subroutines or interrupts are executed). The Stack Pointer (SP) is read/write accessible in the I/O space.
      The data SRAM can easily be accessed through the five different addressing modes supported in the AVR
      architecture.
      The memory spaces in the AVR architecture are all linear and regular memory maps.
      A flexible interrupt module has its control registers in the I/O space with an additional Global Interrupt Enable bit
      in the Status Register. All interrupts have a separate Interrupt Vector in the Interrupt Vector table. The interrupts
      have priority in accordance with their Interrupt Vector position. The lower the Interrupt Vector address, the
      higher the priority.
      The I/O memory space contains 64 addresses for CPU peripheral functions as Control Registers, SPI, and other
      I/O functions. The I/O Memory can be accessed directly, or as the Data Space locations following those of the
      Register File, 0x20 - 0x5F. In addition, the ATmega48A/PA/88A/PA/168A/PA/328/P has Extended I/O space
      from 0x60 - 0xFF in SRAM where only the ST/STS/STD and LD/LDS/LDD instructions can be used.

7.2   ALU – Arithmetic Logic Unit
      The high-performance AVR ALU operates in direct connection with all the 32 general purpose working registers.
      Within a single clock cycle, arithmetic operations between general purpose registers or between a register and
      an immediate are executed. The ALU operations are divided into three main categories – arithmetic, logical, and
      bit-functions. Some implementations of the architecture also provide a powerful multiplier supporting both
      signed/unsigned multiplication and fractional format. See the “Instruction Set” section for a detailed description.

7.3   Status Register
      The Status Register contains information about the result of the most recently executed arithmetic instruction.
      This information can be used for altering program flow in order to perform conditional operations. Note that the
      Status Register is updated after all ALU operations, as specified in the Instruction Set Reference. This will in
      many cases remove the need for using the dedicated compare instructions, resulting in faster and more
      compact code.
      The Status Register is not automatically stored when entering an interrupt routine and restored when returning
      from an interrupt. This must be handled by software.




       2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 19
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

7.3.1   SREG – AVR Status Register
        The AVR Status Register – SREG – is defined as:
         Bit               7           6        5       4       3         2          1       0
         0x3F (0x5F)       I           T       H        S       V         N         Z        C      SREG
         Read/Write       R/W        R/W       R/W     R/W     R/W       R/W        R/W     R/W
         Initial Value     0           0        0       0       0         0          0       0


        • Bit 7 – I: Global Interrupt Enable
        The Global Interrupt Enable bit must be set for the interrupts to be enabled. The individual interrupt enable
        control is then performed in separate control registers. If the Global Interrupt Enable Register is cleared, none of
        the interrupts are enabled independent of the individual interrupt enable settings. The I-bit is cleared by
        hardware after an interrupt has occurred, and is set by the RETI instruction to enable subsequent interrupts.
        The I-bit can also be set and cleared by the application with the SEI and CLI instructions, as described in the
        instruction set reference.

        • Bit 6 – T: Bit Copy Storage
        The Bit Copy instructions BLD (Bit LoaD) and BST (Bit STore) use the T-bit as source or destination for the
        operated bit. A bit from a register in the Register File can be copied into T by the BST instruction, and a bit in T
        can be copied into a bit in a register in the Register File by the BLD instruction.

        • Bit 5 – H: Half Carry Flag
        The Half Carry Flag H indicates a Half Carry in some arithmetic operations. Half Carry Is useful in BCD
        arithmetic. See the “Instruction Set Description” for detailed information.

        • Bit 4 – S: Sign Bit, S = N  V
        The S-bit is always an exclusive or between the Negative Flag N and the Two’s Complement Overflow Flag V.
        See the “Instruction Set Description” for detailed information.

        • Bit 3 – V: Two’s Complement Overflow Flag
        The Two’s Complement Overflow Flag V supports two’s complement arithmetic. See the “Instruction Set
        Description” for detailed information.

        • Bit 2 – N: Negative Flag
        The Negative Flag N indicates a negative result in an arithmetic or logic operation. See the “Instruction Set
        Description” for detailed information.

        • Bit 1 – Z: Zero Flag
        The Zero Flag Z indicates a zero result in an arithmetic or logic operation. See the “Instruction Set Description”
        for detailed information.

        • Bit 0 – C: Carry Flag
        The Carry Flag C indicates a carry in an arithmetic or logic operation. See the “Instruction Set Description” for
        detailed information.



7.4     General Purpose Register File
        The Register File is optimized for the AVR Enhanced RISC instruction set. In order to achieve the required
        performance and flexibility, the following input/output schemes are supported by the Register File:
               One 8-bit output operand and one 8-bit result input



         2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 20
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

               Two 8-bit output operands and one 8-bit result input
               Two 8-bit output operands and one 16-bit result input
               One 16-bit output operand and one 16-bit result input
        Figure 7-2 shows the structure of the 32 general purpose working registers in the CPU.

        Figure 7-2.       AVR CPU General Purpose Working Registers

                                               7              0               Addr.

                                                        R0                    0x00
                                                        R1                    0x01
                                                        R2                    0x02
                                                        …
                                                        R13                   0x0D
                      General                           R14                   0x0E
                      Purpose                           R15                   0x0F
                      Working                           R16                   0x10
                      Registers                         R17                   0x11
                                                        …
                                                        R26                   0x1A              X-register Low Byte
                                                        R27                   0x1B              X-register High Byte
                                                        R28                   0x1C              Y-register Low Byte
                                                        R29                   0x1D              Y-register High Byte
                                                        R30                   0x1E              Z-register Low Byte
                                                        R31                   0x1F              Z-register High Byte


        Most of the instructions operating on the Register File have direct access to all registers, and most of them are
        single cycle instructions.
        As shown in Figure 7-2, each register is also assigned a data memory address, mapping them directly into the
        first 32 locations of the user Data Space. Although not being physically implemented as SRAM locations, this
        memory organization provides great flexibility in access of the registers, as the X-, Y- and Z-pointer registers
        can be set to index any register in the file.

7.4.1   The X-register, Y-register, and Z-register
        The registers R26...R31 have some added functions to their general purpose usage. These registers are 16-bit
        address pointers for indirect addressing of the data space. The three indirect address registers X, Y, and Z are
        defined as described in Figure 7-3.

        Figure 7-3.       The X-, Y-, and Z-registers

                                  15            XH                                     XL                        0
         X-register               7                               0    7                                         0
                                  R27 (0x1B)                           R26 (0x1A)


                                  15            YH                                     YL                        0
         Y-register               7                               0    7                                         0
                                  R29 (0x1D)                           R28 (0x1C)

                                  15            ZH                                     ZL                        0
         Z-register               7             0                      7                    0
                                  R31 (0x1F)                           R30 (0x1E)

        In the different addressing modes these address registers have functions as fixed displacement, automatic
        increment, and automatic decrement (see the instruction set reference for details).




         2020 Microchip Technology Inc.                              Data Sheet Complete                              DS40002061B-page 21
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

7.5     Stack Pointer
        The Stack is mainly used for storing temporary data, for storing local variables and for storing return addresses
        after interrupts and subroutine calls. Note that the Stack is implemented as growing from higher to lower
        memory locations. The Stack Pointer Register always points to the top of the Stack. The Stack Pointer points to
        the data SRAM Stack area where the Subroutine and Interrupt Stacks are located. A Stack PUSH command will
        decrease the Stack Pointer.
        The Stack in the data SRAM must be defined by the program before any subroutine calls are executed or
        interrupts are enabled. Initial Stack Pointer value equals the last address of the internal SRAM and the Stack
        Pointer must be set to point above start of the SRAM, see Table 8-3 on page 28.
        See Table 7-1 for Stack Pointer details.

        Table 7-1.       Stack Pointer instructions
         Instruction      Stack pointer       Description
         PUSH             Decremented by 1    Data is pushed onto the stack
         CALL                                 Return address is pushed onto the stack with a subroutine call or
         ICALL            Decremented by 2    interrupt
         RCALL
         POP              Incremented by 1    Data is popped from the stack
         RET              Incremented by 2    Return address is popped from the stack with return from
         RETI                                 subroutine or return from interrupt

        The AVR Stack Pointer is implemented as two 8-bit registers in the I/O space. The number of bits actually used
        is implementation dependent. Note that the data space in some implementations of the AVR architecture is so
        small that only SPL is needed. In this case, the SPH Register will not be present.

7.5.1   SPH and SPL – Stack Pointer High and Stack Pointer Low Register


         Bit               15       14         13       12         11         10         9         8
         0x3E (0x5E)     SP15     SP14       SP13     SP12       SP11      SP10         SP9      SP8       SPH
         0x3D (0x5D)      SP7      SP6        SP5      SP4       SP3          SP2       SP1      SP0       SPL
                           7        6          5         4         3           2         1         0
         Read/Write       R/W      R/W        R/W      R/W        R/W         R/W       R/W      R/W
                          R/W      R/W        R/W      R/W        R/W         R/W       R/W      R/W
         Initial Value   RAMEND   RAMEND     RAMEND   RAMEND    RAMEND     RAMEND      RAMEND   RAMEND

                         RAMEND   RAMEND     RAMEND   RAMEND    RAMEND     RAMEND      RAMEND   RAMEND




         2020 Microchip Technology Inc.                         Data Sheet Complete                          DS40002061B-page 22
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

7.6   Instruction Execution Timing
      This section describes the general access timing concepts for instruction execution. The AVR CPU is driven by
      the CPU clock clkCPU, directly generated from the selected clock source for the chip. No internal clock division is
      used.
      Figure 7-4 shows the parallel instruction fetches and instruction executions enabled by the Harvard architecture
      and the fast-access Register File concept. This is the basic pipelining concept to obtain up to 1 MIPS per MHz
      with the corresponding unique results for functions per cost, functions per clocks, and functions per power-unit.

      Figure 7-4.    The Parallel Instruction Fetches and Instruction Executions
                                                     T1              T2               T3              T4



                                         clkCPU
                        1st Instruction Fetch
                     1st Instruction Execute
                      2nd Instruction Fetch
                    2nd Instruction Execute
                       3rd Instruction Fetch
                    3rd Instruction Execute
                       4th Instruction Fetch


      Figure 7-5 shows the internal timing concept for the Register File. In a single clock cycle an ALU operation using
      two register operands is executed, and the result is stored back to the destination register.

      Figure 7-5.    Single Cycle ALU Operation
                                                     T1               T2              T3               T4



                                         clkCPU
                        Total Execution Time

                    Register Operands Fetch

                     ALU Operation Execute

                           Result Write Back




7.7   Reset and Interrupt Handling
      The AVR provides several different interrupt sources. These interrupts and the separate Reset Vector each
      have a separate program vector in the program memory space. All interrupts are assigned individual enable bits
      which must be written logic one together with the Global Interrupt Enable bit in the Status Register in order to
      enable the interrupt. Depending on the Program Counter value, interrupts may be automatically disabled when
      Boot Lock bits BLB02 or BLB12 are programmed. This feature improves software security. See the section
      ”Memory Programming” on page 289 for details.
      The lowest addresses in the program memory space are by default defined as the Reset and Interrupt Vectors.
      The complete list of vectors is shown in ”Interrupts” on page 66. The list also determines the priority levels of the
      different interrupts. The lower the address the higher is the priority level. RESET has the highest priority, and
      next is INT0 – the External Interrupt Request 0. The Interrupt Vectors can be moved to the start of the Boot
      Flash section by setting the IVSEL bit in the MCU Control Register (MCUCR). Refer to ”Interrupts” on page 66
      for more information. The Reset Vector can also be moved to the start of the Boot Flash section by




       2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 23
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

programming the BOOTRST Fuse, see ”Boot Loader Support – Read-While-Write Self-Programming” on page
272.
When an interrupt occurs, the Global Interrupt Enable I-bit is cleared and all interrupts are disabled. The user
software can write logic one to the I-bit to enable nested interrupts. All enabled interrupts can then interrupt the
current interrupt routine. The I-bit is automatically set when a Return from Interrupt instruction – RETI – is
executed.
There are basically two types of interrupts. The first type is triggered by an event that sets the Interrupt Flag. For
these interrupts, the Program Counter is vectored to the actual Interrupt Vector in order to execute the interrupt
handling routine, and hardware clears the corresponding Interrupt Flag. Interrupt Flags can also be cleared by
writing a logic one to the flag bit position(s) to be cleared. If an interrupt condition occurs while the
corresponding interrupt enable bit is cleared, the Interrupt Flag will be set and remembered until the interrupt is
enabled, or the flag is cleared by software. Similarly, if one or more interrupt conditions occur while the Global
Interrupt Enable bit is cleared, the corresponding Interrupt Flag(s) will be set and remembered until the Global
Interrupt Enable bit is set, and will then be executed by order of priority.
The second type of interrupts will trigger as long as the interrupt condition is present. These interrupts do not
necessarily have Interrupt Flags. If the interrupt condition disappears before the interrupt is enabled, the
interrupt will not be triggered.
When the AVR exits from an interrupt, it will always return to the main program and execute one more
instruction before any pending interrupt is served.
Note that the Status Register is not automatically stored when entering an interrupt routine, nor restored when
returning from an interrupt routine. This must be handled by software.
When using the CLI instruction to disable interrupts, the interrupts will be immediately disabled. No interrupt will
be executed after the CLI instruction, even if it occurs simultaneously with the CLI instruction. The following
example shows how this can be used to avoid interrupts during the timed EEPROM write sequence.


 Assembly Code Example
          in           r16, SREG                      ; store SREG value
          cli                            ; disable interrupts during timed
          sequence
          sbi          EECR, EEMPE                         ; start EEPROM write
          sbi          EECR, EEPE
          out          SREG, r16                           ; restore SREG value (I-
          bit)
 C Code Example
          char cSREG;
          cSREG = SREG;                       /* store SREG value */
          /* disable interrupts during timed sequence */
          _CLI();
          EECR |= (1<<EEMPE); /* start EEPROM write */
          EECR |= (1<<EEPE);
          SREG = cSREG; /* restore SREG value (I-bit) */

When using the SEI instruction to enable interrupts, the instruction following SEI will be executed before any
pending interrupts, as shown in this example.




 2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 24
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


         Assembly Code Example
                  sei             ; set Global Interrupt Enable
                  sleep           ; enter sleep, waiting for interrupt
                  ; note: will enter sleep before any pending interrupt(s)
         C Code Example
                  __enable_interrupt(); /* set Global Interrupt Enable */
                  __sleep(); /* enter sleep, waiting for interrupt */
                  /* note: will enter sleep before any pending interrupt(s) */


7.7.1   Interrupt Response Time
        The interrupt execution response for all the enabled AVR interrupts is four clock cycles minimum. After four
        clock cycles the program vector address for the actual interrupt handling routine is executed. During this four
        clock cycle period, the Program Counter is pushed onto the Stack. The vector is normally a jump to the interrupt
        routine, and this jump takes three clock cycles. If an interrupt occurs during execution of a multi-cycle
        instruction, this instruction is completed before the interrupt is served. If an interrupt occurs when the MCU is in
        sleep mode, the interrupt execution response time is increased by four clock cycles. This increase comes in
        addition to the start-up time from the selected sleep mode.
        A return from an interrupt handling routine takes four clock cycles. During these four clock cycles, the Program
        Counter (two bytes) is popped back from the Stack, the Stack Pointer is incremented by two, and the I-bit in
        SREG is set.




         2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 25
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


8.    AVR Memories

8.1   Overview
      This section describes the different memories in the ATmega48A/PA/88A/PA/168A/PA/328/P. The AVR
      architecture has two main memory spaces, the Data Memory and the Program Memory space. In addition, the
      ATmega48A/PA/88A/PA/168A/PA/328/P features an EEPROM Memory for data storage. All three memory
      spaces are linear and regular.

8.2   In-System Reprogrammable Flash Program Memory
      The ATmega48A/PA/88A/PA/168A/PA/328/P contains 4/8/16/32Kbytes On-chip In-System Reprogrammable
      Flash memory for program storage. Since all AVR instructions are 16 or 32 bits wide, the Flash is organized as
      2/4/8/16K x 16. For software security, the Flash Program memory space is divided into two sections, Boot
      Loader Section and Application Program Section in ATmega88PA and ATmega168PA. See SPMEN description
      in section ”SPMCSR – Store Program Memory Control and Status Register” on page 287 for more details.
      The Flash memory has an endurance of at least 10,000 write/erase cycles. The
      ATmega48A/PA/88A/PA/168A/PA/328/P Program Counter (PC) is 11/12/13/14 bits wide, thus addressing the
      2/4/8/16K program memory locations. The operation of Boot Program section and associated Boot Lock bits for
      software protection are described in detail in ”Self-Programming the Flash, ATmega 48A/48PA” on page 264
      and ”Boot Loader Support – Read-While-Write Self-Programming” on page 272. ”Memory Programming” on
      page 289 contains a detailed description on Flash Programming in SPI- or Parallel Programming mode.
      Constant tables can be allocated within the entire program memory address space (see the LPM – Load
      Program Memory instruction description).
      Timing diagrams for instruction fetch and execution are presented in ”Instruction Execution Timing” on page 23.




       2020 Microchip Technology Inc.                   Data Sheet Complete                      DS40002061B-page 26
                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 8-1.    Program Memory Map ATmega 48A/48PA
                                      Program Memory

                                                                   0x0000




                                   Application Flash Section




                                                                   0x7FF


Figure 8-2.    Program Memory Map ATmega88A, ATmega88PA, ATmega168A, ATmega168PA, ATmega328 and
               ATmega328P
                                      Program Memory

                                                                 0x0000




                                   Application Flash Section




                                     Boot Flash Section
                                                                 0x0FFF/0x1FFF/0x3FFF




 2020 Microchip Technology Inc.                      Data Sheet Complete               DS40002061B-page 27
                                            ATmega48A/PA/88A/PA/168A/PA/328/P


8.3   SRAM Data Memory
      Figure 8-3 shows how the ATmega48A/PA/88A/PA/168A/PA/328/P SRAM Memory is organized.
      The ATmega48A/PA/88A/PA/168A/PA/328/P is a complex microcontroller with more peripheral units than can
      be supported within the 64 locations reserved in the Opcode for the IN and OUT instructions. For the Extended
      I/O space from 0x60 - 0xFF in SRAM, only the ST/STS/STD and LD/LDS/LDD instructions can be used.
      The lower 768/1280/1280/2303 data memory locations address both the Register File, the I/O memory,
      Extended I/O memory, and the internal data SRAM. The first 32 locations address the Register File, the next 64
      location the standard I/O memory, then 160 locations of Extended I/O memory, and the next
      512/1024/1024/2048 locations address the internal data SRAM.
      The five different addressing modes for the data memory cover: Direct, Indirect with Displacement, Indirect,
      Indirect with Pre-decrement, and Indirect with Post-increment. In the Register File, registers R26 to R31 feature
      the indirect addressing pointer registers.
      The direct addressing reaches the entire data space.
      The Indirect with Displacement mode reaches 63 address locations from the base address given by the Y- or Z-
      register.
      When using register indirect addressing modes with automatic pre-decrement and post-increment, the address
      registers X, Y, and Z are decremented or incremented.
      The 32 general purpose working registers, 64 I/O Registers, 160 Extended I/O Registers, and the
      512/1024/1024/2048 bytes of internal data SRAM in the ATmega48A/PA/88A/PA/168A/PA/328/P are all
      accessible through all these addressing modes. The Register File is described in ”General Purpose Register
      File” on page 20.

      Figure 8-3.    Data Memory Map


                                             Data Memory
                                              32 Registers          0x0000 - 0x001F
                                            64 I/O Registers        0x0020 - 0x005F
                                            160 Ext I/O Reg.        0x0060 - 0x00FF
                                                                    0x0100
                                             Internal SRAM
                                         (512/1024/1024/2048 x 8)
                                                                    0x02FF/0x04FF/0x4FF/0x08FF




       2020 Microchip Technology Inc.                    Data Sheet Complete                       DS40002061B-page 28
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


8.3.1   Data Memory Access Times
        This section describes the general access timing concepts for internal memory access. The internal data SRAM
        access is performed in two clkCPU cycles as described in Figure 8-4.

        Figure 8-4.    On-chip Data SRAM Access Cycles
                                                  T1                   T2                 T3



                                 clkCPU
                              Address       Compute Address        Address valid

                                  Data




                                                                                                       Write
                                   WR

                                  Data




                                                                                                       Read
                                    RD



                                                  Memory Access Instruction         Next Instruction




8.4     EEPROM Data Memory
        The ATmega48A/PA/88A/PA/168A/PA/328/P contains 256/512/512/1Kbytes of data EEPROM memory. It is
        organized as a separate data space, in which single bytes can be read and written. The EEPROM has an
        endurance of at least 100,000 write/erase cycles. The access between the EEPROM and the CPU is described
        in the following, specifying the EEPROM Address Registers, the EEPROM Data Register, and the EEPROM
        Control Register.
        ”Memory Programming” on page 289 contains a detailed description on EEPROM Programming in SPI or
        Parallel Programming mode.

8.4.1   EEPROM Read/Write Access
        The EEPROM Access Registers are accessible in the I/O space.
        The write access time for the EEPROM is given in Table 8-2. A self-timing function, however, lets the user
        software detect when the next byte can be written. If the user code contains instructions that write the EEPROM,
        some precautions must be taken. In heavily filtered power supplies, VCC is likely to rise or fall slowly on power-
        up/down. This causes the device for some period of time to run at a voltage lower than specified as minimum for
        the clock frequency used. See ”Preventing EEPROM Corruption” on page 30 for details on how to avoid
        problems in these situations.
        In order to prevent unintentional EEPROM writes, a specific write procedure must be followed. Refer to the
        description of the EEPROM Control Register for details on this.
        When the EEPROM is read, the CPU is halted for four clock cycles before the next instruction is executed.
        When the EEPROM is written, the CPU is halted for two clock cycles before the next instruction is executed.




         2020 Microchip Technology Inc.                      Data Sheet Complete                              DS40002061B-page 29
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

8.4.2   Preventing EEPROM Corruption
        During periods of low VCC, the EEPROM data can be corrupted because the supply voltage is too low for the
        CPU and the EEPROM to operate properly. These issues are the same as for board level systems using
        EEPROM, and the same design solutions should be applied.
        An EEPROM data corruption can be caused by two situations when the voltage is too low. First, a regular write
        sequence to the EEPROM requires a minimum voltage to operate correctly. Secondly, the CPU itself can
        execute instructions incorrectly, if the supply voltage is too low.
        EEPROM data corruption can easily be avoided by following this design recommendation:
        Keep the AVR RESET active (low) during periods of insufficient power supply voltage. This can be done by
        enabling the internal Brown-out Detector (BOD). If the detection level of the internal BOD does not match the
        needed detection level, an external low VCC reset Protection circuit can be used. If a reset occurs while a write
        operation is in progress, the write operation will be completed provided that the power supply voltage is
        sufficient.

8.5     I/O Memory
        The I/O space definition of the ATmega48A/PA/88A/PA/168A/PA/328/P is shown in ”Register Summary” on
        page 621.
        All ATmega48A/PA/88A/PA/168A/PA/328/P I/Os and peripherals are placed in the I/O space. All I/O locations
        may be accessed by the LD/LDS/LDD and ST/STS/STD instructions, transferring data between the 32 general
        purpose working registers and the I/O space. I/O Registers within the address range 0x00 - 0x1F are directly bit-
        accessible using the SBI and CBI instructions. In these registers, the value of single bits can be checked by
        using the SBIS and SBIC instructions. Refer to the instruction set section for more details. When using the I/O
        specific commands IN and OUT, the I/O addresses 0x00 - 0x3F must be used. When addressing I/O Registers
        as data space using LD and ST instructions, 0x20 must be added to these addresses. The
        ATmega48A/PA/88A/PA/168A/PA/328/P is a complex microcontroller with more peripheral units than can be
        supported within the 64 location reserved in Opcode for the IN and OUT instructions. For the Extended I/O
        space from 0x60 - 0xFF in SRAM, only the ST/STS/STD and LD/LDS/LDD instructions can be used.
        For compatibility with future devices, reserved bits should be written to zero if accessed. Reserved I/O memory
        addresses should never be written.
        Some of the Status Flags are cleared by writing a logical one to them. Note that, unlike most other AVRs, the
        CBI and SBI instructions will only operate on the specified bit, and can therefore be used on registers containing
        such Status Flags. The CBI and SBI instructions work with registers 0x00 to 0x1F only.
        The I/O and peripherals control registers are explained in later sections.

8.5.1   General Purpose I/O Registers
        The ATmega48A/PA/88A/PA/168A/PA/328/P contains three General Purpose I/O Registers. These registers
        can be used for storing any information, and they are particularly useful for storing global variables and Status
        Flags. General Purpose I/O Registers within the address range 0x00 - 0x1F are directly bit-accessible using the
        SBI, CBI, SBIS, and SBIC instructions.




         2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 30
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

8.6     Register Description

8.6.1   EEARH and EEARL – The EEPROM Address Register
         Bit                 15            14             13             12                11               10                9            8
         0x22 (0x42)          –            –              –               –                –                 –          EEAR9(1)        EEAR8(1)      EEARH
         0x21 (0x41)       EEAR7      EEAR6      EEAR5               EEAR4            EEAR3                EEAR2         EEAR1           EEAR0        EEARL

                              7            6              5               4                 3                2                1            0
         Read/Write           R            R              R               R                R                 R                R           R/W
                             R/W        R/W           R/W                R/W               R/W              R/W           R/W             R/W
         Initial Value        0            0              0               0                 0                0                0            X
                              X            X              X               X                X                 X                X            X


        • Bits [15:10] – Reserved
        These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

        • Bits 9:0 – EEAR[9:0]: EEPROM Address
        The EEPROM Address Registers – EEARH and EEARL specify the EEPROM address in the
        256/512/512/1Kbytes EEPROM space. The EEPROM data bytes are addressed linearly between 0 and
        255/511/511/1023. The initial value of EEAR is undefined. A proper value must be written before the EEPROM
        may be accessed.
        Note:       1.   EEAR9 and EEAR8 are unused bits in ATmega 48A/48PA and must always be written to zero.

8.6.2   EEDR – The EEPROM Data Register
         Bit                  7        6         5              4               3                2           1            0
         0x20 (0x40)        MSB                                                                                         LSB            EEDR
         Read/Write          R/W      R/W       R/W            R/W             R/W              R/W         R/W          R/W
         Initial Value        0        0         0              0               0                0           0            0


        • Bits 7:0 – EEDR[7:0]: EEPROM Data
        For the EEPROM write operation, the EEDR Register contains the data to be written to the EEPROM in the
        address given by the EEAR Register. For the EEPROM read operation, the EEDR contains the data read out
        from the EEPROM at the address given by EEAR.

8.6.3   EECR – The EEPROM Control Register
         Bit                  7            6          5              4                3                2            1              0
         0x1F (0x3F)          –            –    EEPM1          EEPM0                EERIE            EEMPE        EEPE            EERE         EECR
         Read/Write           R            R         R/W            R/W              R/W              R/W          R/W            R/W
         Initial Value        0            0         X               X                0                0           X               0


        • Bits 7:6 – Reserved
        These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

        • Bits 5, 4 – EEPM1 and EEPM0: EEPROM Programming Mode Bits
        The EEPROM Programming mode bit setting defines which programming action that will be triggered when
        writing EEPE. It is possible to program data in one atomic operation (erase the old value and program the new
        value) or to split the Erase and Write operations in two different operations. The Programming times for the
        different modes are shown in Table 8-1. While EEPE is set, any write to EEPMn will be ignored. During reset,
        the EEPMn bits will be reset to 0b00 unless the EEPROM is busy programming.




         2020 Microchip Technology Inc.                                       Data Sheet Complete                                        DS40002061B-page 31
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


Table 8-1.     EEPROM Mode Bits
                            Programming
  EEPM1        EEPM0            Time         Operation
      0           0                3.4ms     Erase and Write in one operation (Atomic Operation)
      0           1                1.8ms     Erase Only
      1           0                1.8ms     Write Only
      1           1                 –        Reserved for future use

• Bit 3 – EERIE: EEPROM Ready Interrupt Enable
Writing EERIE to one enables the EEPROM Ready Interrupt if the I bit in SREG is set. Writing EERIE to zero
disables the interrupt. The EEPROM Ready interrupt generates a constant interrupt when EEPE is cleared. The
interrupt will not be generated during EEPROM write or SPM.

• Bit 2 – EEMPE: EEPROM Master Write Enable
The EEMPE bit determines whether setting EEPE to one causes the EEPROM to be written. When EEMPE is
set, setting EEPE within four clock cycles will write data to the EEPROM at the selected address If EEMPE is
zero, setting EEPE will have no effect. When EEMPE has been written to one by software, hardware clears the
bit to zero after four clock cycles. See the description of the EEPE bit for an EEPROM write procedure.

• Bit 1 – EEPE: EEPROM Write Enable
The EEPROM Write Enable Signal EEPE is the write strobe to the EEPROM. When address and data are
correctly set up, the EEPE bit must be written to one to write the value into the EEPROM. The EEMPE bit must
be written to one before a logical one is written to EEPE, otherwise no EEPROM write takes place. The
following procedure should be followed when writing the EEPROM (the order of steps 3 and 4 is not essential):
 1.   Wait until EEPE becomes zero.
 2.   Wait until SPMEN in SPMCSR becomes zero.
 3.   Write new EEPROM address to EEAR (optional).
 4.   Write new EEPROM data to EEDR (optional).
 5.   Write a logical one to the EEMPE bit while writing a zero to EEPE in EECR.
 6.   Within four clock cycles after setting EEMPE, write a logical one to EEPE.
The EEPROM can not be programmed during a CPU write to the Flash memory. The software must check that
the Flash programming is completed before initiating a new EEPROM write. Step 2 is only relevant if the
software contains a Boot Loader allowing the CPU to program the Flash. If the Flash is never being updated by
the CPU, step 2 can be omitted. See ”Boot Loader Support – Read-While-Write Self-Programming” on page 272
for details about Boot programming.
Caution: An interrupt between step 5 and step 6 will make the write cycle fail, since the EEPROM Master Write
Enable will time-out. If an interrupt routine accessing the EEPROM is interrupting another EEPROM access, the
EEAR or EEDR Register will be modified, causing the interrupted EEPROM access to fail. It is recommended to
have the Global Interrupt Flag cleared during all the steps to avoid these problems.
When the write access time has elapsed, the EEPE bit is cleared by hardware. The user software can poll this
bit and wait for a zero before writing the next byte. When EEPE has been set, the CPU is halted for two cycles
before the next instruction is executed.




 2020 Microchip Technology Inc.                      Data Sheet Complete                          DS40002061B-page 32
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

• Bit 0 – EERE: EEPROM Read Enable
The EEPROM Read Enable Signal EERE is the read strobe to the EEPROM. When the correct address is set
up in the EEAR Register, the EERE bit must be written to a logic one to trigger the EEPROM read. The
EEPROM read access takes one instruction, and the requested data is available immediately. When the
EEPROM is read, the CPU is halted for four cycles before the next instruction is executed.
The user should poll the EEPE bit before starting the read operation. If a write operation is in progress, it is
neither possible to read the EEPROM, nor to change the EEAR Register.
The calibrated Oscillator is used to time the EEPROM accesses. Table 8-2 lists the typical programming time for
EEPROM access from the CPU.

Table 8-2.     EEPROM Programming Time
 Symbol                   Number of Calibrated RC Oscillator Cycles         Typ Programming Time
 EEPROM write
                                           26,368                                  3.3ms
 (from CPU)

The following code examples show one assembly and one C function for writing to the EEPROM. The examples
assume that interrupts are controlled (e.g. by disabling interrupts globally) so that no interrupts will occur during
execution of these functions. The examples also assume that no Flash Boot Loader is present in the software. If
such code is present, the EEPROM write function must also wait for any ongoing SPM command to finish.




 2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 33
                                   ATmega48A/PA/88A/PA/168A/PA/328/P


 Assembly Code Example
          EEPROM_write:
                ; Wait for completion of previous write
                sbic       EECR,EEPE
                rjmp       EEPROM_write
                ; Set up address (r18:r17) in address register
                out        EEARH, r18
                out        EEARL, r17
                ; Write data (r16) to Data Register
                out        EEDR,r16
                ; Write logical one to EEMPE
                sbi        EECR,EEMPE
                ; Start eeprom write by setting EEPE
                sbi        EECR,EEPE
                ret
 C Code Example
          void EEPROM_write(unsigned int uiAddress, unsigned char ucData)
          {
                /* Wait for completion of previous write */
                while(EECR & (1<<EEPE))
                   ;
                /* Set up address and Data Registers */
                EEAR = uiAddress;
                EEDR = ucData;
                /* Write logical one to EEMPE */
                EECR |= (1<<EEMPE);
                /* Start eeprom write by setting EEPE */
                EECR |= (1<<EEPE);
          }

The next code examples show assembly and C functions for reading the EEPROM. The examples assume that
interrupts are controlled so that no interrupts will occur during execution of these functions.




 2020 Microchip Technology Inc.               Data Sheet Complete                  DS40002061B-page 34
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P


         Assembly Code Example
                         EEPROM_read:
                               ; Wait for completion of previous write
                               sbic       EECR,EEPE
                               rjmp       EEPROM_read
                               ; Set up address (r18:r17) in address register
                               out        EEARH, r18
                               out        EEARL, r17
                               ; Start eeprom read by writing EERE
                               sbi        EECR,EERE
                               ; Read data from Data Register
                               in         r16,EEDR
                               ret
         C Code Example
                         unsigned char EEPROM_read(unsigned int uiAddress)
                         {
                               /* Wait for completion of previous write */
                               while(EECR & (1<<EEPE))
                                  ;
                               /* Set up address register */
                               EEAR = uiAddress;
                               /* Start eeprom read by writing EERE */
                               EECR |= (1<<EERE);
                               /* Return data from Data Register */
                               return EEDR;
                         }


8.6.4   GPIOR2 – General Purpose I/O Register 2
         Bit                   7      6      5       4     3         2           1     0
         0x2B (0x4B)         MSB                                                      LSB   GPIOR2
         Read/Write           R/W    R/W    R/W     R/W   R/W       R/W         R/W   R/W
         Initial Value         0      0      0       0     0         0           0     0


8.6.5   GPIOR1 – General Purpose I/O Register 1
         Bit                   7      6      5       4     3         2           1     0
         0x2A (0x4A)         MSB                                                      LSB   GPIOR1
         Read/Write           R/W    R/W    R/W     R/W   R/W       R/W         R/W   R/W
         Initial Value         0      0      0       0     0         0           0     0


8.6.6   GPIOR0 – General Purpose I/O Register 0
         Bit                   7      6      5       4     3         2           1     0
         0x1E (0x3E)         MSB                                                      LSB   GPIOR0
         Read/Write           R/W    R/W    R/W     R/W   R/W       R/W         R/W   R/W
         Initial Value         0      0      0       0     0         0           0     0




         2020 Microchip Technology Inc.                  Data Sheet Complete                   DS40002061B-page 35
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

9.      System Clock and Clock Options

9.1     Clock Systems and their Distribution
        Figure 9-1 presents the principal clock systems in the AVR and their distribution. All of the clocks need not be
        active at a given time. In order to reduce power consumption, the clocks to modules not being used can be
        halted by using different sleep modes, as described in ”Power Management and Sleep Modes” on page 48. The
        clock systems are detailed below.

        Figure 9-1.    Clock Distribution

                          Asynchronous     General I/O                                                                     Flash and
                                                                  ADC                CPU Core              RAM
                          Timer/Counter     Modules                                                                        EEPROM




                                                                      clkADC


                                                clkI/O        AVR Clock              clkCPU
                                                              Control Unit

                                               clkASY                                clkFLASH


                                                              System Clock            Reset Logic        Watchdog Timer
                                                               Prescaler



                                                                      Source clock              Watchdog clock

                                                                 Clock                                       Watchdog
                                                               Multiplexer                                   Oscillator




                          Timer/Counter                                  Crystal                Low-frequency             Calibrated RC
                                             External Clock
                            Oscillator                                  Oscillator              Crystal Oscillator          Oscillator




9.1.1   CPU Clock – clkCPU
        The CPU clock is routed to parts of the system concerned with operation of the AVR core. Examples of such
        modules are the General Purpose Register File, the Status Register and the data memory holding the Stack
        Pointer. Halting the CPU clock inhibits the core from performing general operations and calculations.

9.1.2   I/O Clock – clkI/O
        The I/O clock is used by the majority of the I/O modules, like Timer/Counters, SPI, and USART. The I/O clock is
        also used by the External Interrupt module, but note that start condition detection in the USI module is carried
        out asynchronously when clkI/O is halted, TWI address recognition in all sleep modes.
        Note:   Note that if a level triggered interrupt is used for wake-up from Power-down, the required level must be held long
                enough for the MCU to complete the wake-up to trigger the level interrupt. If the level disappears before the end of
                the Start-up Time, the MCU will still wake up, but no interrupt will be generated. The start-up time is defined by the
                SUT and CKSEL Fuses as described in ”System Clock and Clock Options” on page 36.




         2020 Microchip Technology Inc.                                Data Sheet Complete                                       DS40002061B-page 36
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

9.1.3   Flash Clock – clkFLASH
        The Flash clock controls operation of the Flash interface. The Flash clock is usually active simultaneously with
        the CPU clock.

9.1.4   Asynchronous Timer Clock – clkASY
        The Asynchronous Timer clock allows the Asynchronous Timer/Counter to be clocked directly from an external
        clock or an external 32kHz clock crystal. The dedicated clock domain allows using this Timer/Counter as a real-
        time counter even when the device is in sleep mode.

9.1.5   ADC Clock – clkADC
        The ADC is provided with a dedicated clock domain. This allows halting the CPU and I/O clocks in order to
        reduce noise generated by digital circuitry. This gives more accurate ADC conversion results.

9.2     Clock Sources
        The device has the following clock source options, selectable by Flash Fuse bits as shown below. The clock
        from the selected source is input to the AVR clock generator, and routed to the appropriate modules.

        Table 9-1.     Device Clocking Options Select(1)
         Device Clocking Option                                               CKSEL3...0
         Low Power Crystal Oscillator                                         1111 - 1000
         Full Swing Crystal Oscillator                                        0111 - 0110
         Low Frequency Crystal Oscillator                                     0101 - 0100
         Internal 128kHz RC Oscillator                                              0011
         Calibrated Internal RC Oscillator                                          0010
         External Clock                                                             0000
         Reserved                                                                   0001

        Note:   1.   For all fuses “1” means unprogrammed while “0” means programmed.

9.2.1   Default Clock Source
        The device is shipped with internal RC oscillator at 8.0MHz and with the fuse CKDIV8 programmed, resulting in
        1.0MHz system clock. The startup time is set to maximum and time-out period enabled. (CKSEL = "0010", SUT
        = "10", CKDIV8 = "0"). The default setting ensures that all users can make their desired clock source setting
        using any available programming interface.

9.2.2   Clock Startup Sequence
        Any clock source needs a sufficient VCC to start oscillating and a minimum number of oscillating cycles before it
        can be considered stable.
        To ensure sufficient VCC, the device issues an internal reset with a time-out delay (tTOUT) after the device reset is
        released by all other reset sources. ”System Control and Reset” on page 56 describes the start conditions for
        the internal reset. The delay (tTOUT) is timed from the Watchdog Oscillator and the number of cycles in the delay
        is set by the SUTx and CKSELx fuse bits. The selectable delays are shown in Table 9-2. The frequency of the
        Watchdog Oscillator is voltage dependent as shown in ”Typical Characteristics – (TA = -40°C to 85°C)” on page
        326.




         2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 37
                                             ATmega48A/PA/88A/PA/168A/PA/328/P


      Table 9-2.     Number of Watchdog Oscillator Cycles
          Typ Time-out (VCC = 5.0V)        Typ Time-out (VCC = 3.0V)                Number of Cycles
                     0ms                              0ms                                  0
                    4.1ms                             4.3ms                               512
                     65ms                             69ms                             8K (8,192)

      Main purpose of the delay is to keep the AVR in reset until it is supplied with minimum VCC. The delay will not
      monitor the actual voltage and it will be required to select a delay longer than the VCC rise time. If this is not
      possible, an internal or external Brown-Out Detection circuit should be used. A BOD circuit will ensure sufficient
      VCC before it releases the reset, and the time-out delay can be disabled. Disabling the time-out delay without
      utilizing a Brown-Out Detection circuit is not recommended.
      The oscillator is required to oscillate for a minimum number of cycles before the clock is considered stable. An
      internal ripple counter monitors the oscillator output clock, and keeps the internal reset active for a given
      number of clock cycles. The reset is then released and the device will start to execute. The recommended
      oscillator start-up time is dependent on the clock type, and varies from 6 cycles for an externally applied clock to
      32K cycles for a low frequency crystal.
      The start-up sequence for the clock includes both the time-out delay and the start-up time when the device
      starts up from reset. When starting up from Power-save or Power-down mode, VCC is assumed to be at a
      sufficient level and only the start-up time is included.

9.3   Low Power Crystal Oscillator
      Pins XTAL1 and XTAL2 are input and output, respectively, of an inverting amplifier which can be configured for
      use as an On-chip Oscillator, as shown in Figure 9-2 on page 38. Either a quartz crystal or a ceramic resonator
      may be used.
      This Crystal Oscillator is a low power oscillator, with reduced voltage swing on the XTAL2 output. It gives the
      lowest power consumption, but is not capable of driving other clock inputs, and may be more susceptible to
      noise in noisy environments. In these cases, refer to the ”Full Swing Crystal Oscillator” on page 39.
      C1 and C2 should always be equal for both crystals and resonators. The optimal value of the capacitors
      depends on the crystal or resonator in use, the amount of stray capacitance, and the electromagnetic noise of
      the environment. Some initial guidelines for choosing capacitors for use with crystals are given in Table 9-3 on
      page 39. For ceramic resonators, the capacitor values given by the manufacturer should be used.

      Figure 9-2.    Crystal Oscillator Connections

                                               C2
                                                                       XTAL2 (TOSC2)

                                                C1
                                                                       XTAL1 (TOSC1)

                                                                       GND




      The Low Power Oscillator can operate in three different modes, each optimized for a specific frequency range.
      The operating mode is selected by the fuses CKSEL3...1 as shown in Table 9-3 on page 39.




       2020 Microchip Technology Inc.                        Data Sheet Complete                      DS40002061B-page 38
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P


      Table 9-3.        Low Power Crystal Oscillator Operating Modes(3)
           Frequency Range                        Recommended Range for
                (MHz)                             Capacitors C1 and C2 (pF)                     CKSEL3...1(1)
                   0.4 - 0.9                                   –                                     100(2)
                   0.9 - 3.0                                12 - 22                                   101
                   3.0 - 8.0                                12 - 22                                   110
                8.0 - 16.0                                  12 - 22                                   111

      Notes:   1.     This is the recommended CKSEL settings for the difference frequency ranges.
               2.     This option should not be used with crystals, only with ceramic resonators.
               3.     If the crystal frequency exceeds the specification of the device (depends on VCC), the CKDIV8 Fuse can be
                      programmed in order to divide the internal frequency by 8. It must be ensured that the resulting divided clock
                      meets the frequency specification of the device.
      The CKSEL0 Fuse together with the SUT1...0 Fuses select the start-up times as shown in Table 9-4.

      Table 9-4.        Start-up Times for the Low Power Crystal Oscillator Clock Selection
                                         Start-up Time from           Additional Delay
       Oscillator Source /                Power-down and                from Reset
       Power Conditions                     Power-save                  (VCC = 5.0V)         CKSEL0         SUT1...0
       Ceramic resonator, fast
                                               258 CK                 14CK + 4.1ms(1)            0            00
       rising power
       Ceramic resonator, slowly
                                               258 CK                 14CK + 65ms(1)             0            01
       rising power
       Ceramic resonator, BOD
                                                1K CK                     14CK(2)                0            10
       enabled
       Ceramic resonator, fast
                                                1K CK                 14CK + 4.1ms(2)            0            11
       rising power
       Ceramic resonator, slowly
                                                1K CK                 14CK + 65ms(2)             1            00
       rising power
       Crystal Oscillator, BOD
                                               16K CK                      14CK                  1            01
       enabled
       Crystal Oscillator, fast
                                               16K CK                  14CK + 4.1ms              1            10
       rising power
       Crystal Oscillator, slowly
                                               16K CK                  14CK + 65ms               1            11
       rising power
      Notes:   1.     These options should only be used when not operating close to the maximum frequency of the device, and
                      only if frequency stability at start-up is not important for the application. These options are not suitable for
                      crystals.
               2.     These options are intended for use with ceramic resonators and will ensure frequency stability at start-up. They
                      can also be used with crystals when not operating close to the maximum frequency of the device, and if
                      frequency stability at start-up is not important for the application.

9.4   Full Swing Crystal Oscillator
      Pins XTAL1 and XTAL2 are input and output, respectively, of an inverting amplifier which can be configured for
      use as an On-chip Oscillator, as shown in Figure 9-2 on page 38. Either a quartz crystal or a ceramic resonator
      may be used.




       2020 Microchip Technology Inc.                             Data Sheet Complete                             DS40002061B-page 39
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

This Crystal Oscillator is a full swing oscillator, with rail-to-rail swing on the XTAL2 output. This is useful for
driving other clock inputs and in noisy environments. The current consumption is higher than the ”Low Power
Crystal Oscillator” on page 38. Note that the Full Swing Crystal Oscillator will only operate for VCC = 2.7 - 5.5
volts.
C1 and C2 should always be equal for both crystals and resonators. The optimal value of the capacitors
depends on the crystal or resonator in use, the amount of stray capacitance, and the electromagnetic noise of
the environment. Some initial guidelines for choosing capacitors for use with crystals are given in Table 9-6 on
page 40. For ceramic resonators, the capacitor values given by the manufacturer should be used.
The operating mode is selected by the fuses CKSEL3...1 as shown in Table 9-5.

Table 9-5.        Full Swing Crystal Oscillator operating modes
 Frequency Range(1)                       Recommended Range for
 (MHz)                                    Capacitors C1 and C2 (pF)                 CKSEL3...1
             0.4 - 20                                12 - 22                                  011

Notes:   1.    If the cryatal frequency exceeds the specification of the device (depends on VCC), the CKDIV8 Fuse can be
               programmed in order to divide the internal frequency by 8. It must be ensured that the resulting divided clock
               meets the frequency specification of the device.

Figure 9-3.       Crystal Oscillator Connections

                                              C2
                                                                      XTAL2 (TOSC2)

                                              C1
                                                                      XTAL1 (TOSC1)

                                                                      GND




Table 9-6.        Start-up Times for the Full Swing Crystal Oscillator Clock Selection
                                   Start-up Time from          Additional Delay
 Oscillator Source /                Power-down and               from Reset
 Power Conditions                     Power-save                 (VCC = 5.0V)        CKSEL0         SUT1...0
 Ceramic resonator, fast
                                        258 CK                 14CK + 4.1ms(1)           0            00
 rising power
 Ceramic resonator, slowly
                                        258 CK                 14CK + 65ms(1)            0            01
 rising power
 Ceramic resonator, BOD
                                         1K CK                     14CK(2)               0            10
 enabled
 Ceramic resonator, fast
                                         1K CK                 14CK + 4.1ms(2)           0            11
 rising power
 Ceramic resonator, slowly
                                         1K CK                 14CK + 65ms(2)            1            00
 rising power




 2020 Microchip Technology Inc.                           Data Sheet Complete                             DS40002061B-page 40
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Table 9-6.      Start-up Times for the Full Swing Crystal Oscillator Clock Selection (Continued)
                                   Start-up Time from        Additional Delay
 Oscillator Source /                Power-down and             from Reset
 Power Conditions                     Power-save               (VCC = 5.0V)          CKSEL0       SUT1...0
 Crystal Oscillator, BOD
                                        16K CK                     14CK                  1           01
 enabled
 Crystal Oscillator, fast
                                        16K CK                14CK + 4.1ms               1           10
 rising power
 Crystal Oscillator, slowly
                                        16K CK                 14CK + 65ms               1           11
 rising power
Notes:   1.   These options should only be used when not operating close to the maximum frequency of the device, and
              only if frequency stability at start-up is not important for the application. These options are not suitable for
              crystals.
         2.   These options are intended for use with ceramic resonators and will ensure frequency stability at start-up. They
              can also be used with crystals when not operating close to the maximum frequency of the device, and if
              frequency stability at start-up is not important for the application.




 2020 Microchip Technology Inc.                          Data Sheet Complete                             DS40002061B-page 41
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

9.5   Low Frequency Crystal Oscillator
      The Low-frequency Crystal Oscillator is optimized for use with a 32.768kHz watch crystal. When selecting
      crystals, load capacitance and crystal’s Equivalent Series Resistance, ESR must be taken into consideration.
      Both values are specified by the crystal vendor. ATmega48A/PA/88A/PA/168A/PA/328/P oscillator is optimized
      for very low power consumption, and thus when selecting crystals, see Table 9-7 for maximum ESR
      recommendations on 6.5pF, 9.0pF and 12.5pF crystals

      Table 9-7.          Maximum ESR Recommendation for 32.768kHz Crystal
                             Crystal CL (pF)                                        Max ESR [k](1)
                                   6.5                                                      75
                                   9.0                                                      65
                                   12.5                                                     30

      Note:        1. Maximum ESR is typical value based on characterization
      The Low-frequency Crystal Oscillator provides an internal load capacitance, see Table 9-8 at each TOSC pin.

      Table 9-8.          Capacitance for Low-frequency Oscillator
                          Device                      32kHz Osc. Type      Cap(Xtal1/Tosc1)       Cap(Xtal2/Tosc2)
       ATmega48A/PA/88A/PA/168A/PA/3                    System Osc.               18pF                    8pF
                   28/P
                                                        Timer Osc.                18pF                    8pF

      The capacitance (Ce+Ci) needed at each TOSC pin can be calculated by using:
      C = 2  CL – C s
      where:
                   ̶     Ce - is optional external capacitors as described in Figure 9-2 on page 38
                   ̶     Ci - is the pin capacitance in Table 9-8
                   ̶     CL - is the load capacitance for a 32.768kHz crystal specified by the crystal vendor
                   ̶     CS - is the total stray capacitance for one TOSC pin.
      Crystals specifying load capacitance (CL) higher than 6 pF, require external capacitors applied as described in
      Figure 9-2 on page 38.
      The Low-frequency Crystal Oscillator must be selected by setting the CKSEL Fuses to “0110” or “0111”, as
      shown in Table 9-10 on page 42. Start-up times are determined by the SUT Fuses as shown in Table 9-9.

      Table 9-9.          Start-up Times for the Low-frequency Crystal Oscillator Clock Selection
        SUT1...0           Additional Delay from Reset (VCC = 5.0V)        Recommended Usage
              00                               4 CK                        Fast rising power or BOD enabled
              01                          4 CK + 4.1ms                     Slowly rising power
              10                          4 CK + 65ms                      Stable frequency at start-up
              11                                                     Reserved

      Table 9-10.         Start-up Times for the Low-frequency Crystal Oscillator Clock Selection
       CKSEL3...                     Start-up Time from
          0                      Power-down and Power-save                 Recommended Usage
                   (1)
         0100                                  1K CK
          0101                              32K CK                         Stable frequency at start-up




       2020 Microchip Technology Inc.                                Data Sheet Complete                       DS40002061B-page 42
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

      Note:    1.   This option should only be used if frequency stability at start-up is not important for the application


9.6   Calibrated Internal RC Oscillator
      By default, the Internal RC Oscillator provides an approximate 8.0MHz clock. Though voltage and temperature
      dependent, this clock can be very accurately calibrated by the user. See Table 29-9 on page 313 for more
      details. The device is shipped with the CKDIV8 Fuse programmed. See ”System Clock Prescaler” on page 45
      for more details.
      This clock may be selected as the system clock by programming the CKSEL Fuses as shown in Table 9-11. If
      selected, it will operate with no external components. During reset, hardware loads the pre-programmed
      calibration value into the OSCCAL Register and thereby automatically calibrates the RC Oscillator. The
      accuracy of this calibration is shown as Factory calibration in Table 29-9 on page 313.
      By changing the OSCCAL register from SW, see ”OSCCAL – Oscillator Calibration Register” on page 46, it is
      possible to get a higher calibration accuracy than by using the factory calibration. The accuracy of this
      calibration is shown as User calibration in Table 29-9 on page 313.
      When this Oscillator is used as the chip clock, the Watchdog Oscillator will still be used for the Watchdog Timer
      and for the Reset Time-out. For more information on the pre-programmed calibration value, see the section
      ”Calibration Byte” on page 293.

      Table 9-11.     Internal Calibrated RC Oscillator Operating Modes
                    Frequency Range(2) (MHz)                                       CKSEL3...0
                              7.3 - 8.1                                               0010(1)

      Notes:   1.   The device is shipped with this option selected.
               2.   If 8MHz frequency exceeds the specification of the device (depends on VCC), the CKDIV8 Fuse can be
                    programmed in order to divide the internal frequency by 8.
      When this Oscillator is selected, start-up times are determined by the SUT Fuses as shown in Table 9-12.

      Table 9-12.     Start-up times for the internal calibrated RC Oscillator clock selection
                                          Start-up Time from Power-          Additional Delay from
       Power Conditions                     down and Power-save               Reset (VCC = 5.0V)          SUT1...0
                                                                                            (1)
       BOD enabled                                  6 CK                             14CK                     00
       Fast rising power                            6 CK                         14CK + 4.1ms                 01
                                                                                                   (2)
       Slowly rising power                          6 CK                         14CK + 65ms                  10
                                                  Reserved                                                    11

      Note:    1.   If the RSTDISBL fuse is programmed, this start-up time will be increased to
                    14CK + 4.1ms to ensure programming mode can be entered.
               2.   The device is shipped with this option selected.

9.7   128kHz Internal Oscillator
      The 128kHz internal Oscillator is a low power Oscillator providing a clock of 128kHz. The frequency is nominal
      at 3V and 25C. This clock may be select as the system clock by programming the CKSEL Fuses to “11” as
      shown in Table 9-13.

      Table 9-13.     128kHz Internal Oscillator Operating Modes
                             Nominal Frequency(1)                                         CKSEL3...0
                                    128kHz                                                        0011

      Note:    1.   Note that the 128kHz oscillator is a very low power clock source, and is not designed for high accuracy.




       2020 Microchip Technology Inc.                            Data Sheet Complete                              DS40002061B-page 43
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

      When this clock source is selected, start-up times are determined by the SUT Fuses as shown in Table 9-14.

      Table 9-14.     Start-up Times for the 128kHz Internal Oscillator
                                         Start-up Time from Power-        Additional Delay from
          Power Conditions                 down and Power-save                    Reset                SUT1...0
                                                                                          (1)
       BOD enabled                                 6 CK                            14CK                   00
       Fast rising power                           6 CK                        14CK + 4ms                 01
       Slowly rising power                         6 CK                        14CK + 64ms                10
                                                 Reserved                                                 11

      Note:   1.    If the RSTDISBL fuse is programmed, this start-up time will be increased to
                    14CK + 4.1ms to ensure programming mode can be entered.

9.8   External Clock
      To drive the device from an external clock source, XTAL1 should be driven as shown in Figure 9-4. To run the
      device on an external clock, the CKSEL Fuses must be programmed to “0000” (see Table 9-15).

      Table 9-15.     Crystal Oscillator Clock Frequency
                                 Frequency                                             CKSEL3...0
                                  0 - 20MHz                                                     0000

      Figure 9-4.     External Clock Drive Configuration


                                                   PB7                     XTAL2


                                            EXTERNAL
                                               CLOCK                       XTAL1
                                              SIGNAL

                                                                           GND




      When this clock source is selected, start-up times are determined by the SUT Fuses as shown in Table 9-16.


      Table 9-16.     Start-up Times for the External Clock Selection
                                         Start-up Time from Power-        Additional Delay from
          Power Conditions                 down and Power-save             Reset (VCC = 5.0V)          SUT1...0
       BOD enabled                                 6 CK                              14CK                00
       Fast rising power                           6 CK                       14CK + 4.1ms               01
       Slowly rising power                         6 CK                       14CK + 65ms                10
                                                 Reserved                                                11
      When applying an external clock, it is required to avoid sudden changes in the applied clock frequency to
      ensure stable operation of the MCU. A variation in frequency of more than 2% from one clock cycle to the next
      can lead to unpredictable behavior. If changes of more than 2% is required, ensure that the MCU is kept in
      Reset during the changes.




       2020 Microchip Technology Inc.                         Data Sheet Complete                             DS40002061B-page 44
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

       Note that the System Clock Prescaler can be used to implement run-time changes of the internal clock
       frequency while still ensuring stable operation. Refer to ”System Clock Prescaler” on page 45 for details.

9.9    Clock Output Buffer
       The device can output the system clock on the CLKO pin. To enable the output, the CKOUT Fuse has to be
       programmed. This mode is suitable when the chip clock is used to drive other circuits on the system. The clock
       also will be output during reset, and the normal operation of I/O pin will be overridden when the fuse is
       programmed. Any clock source, including the internal RC Oscillator, can be selected when the clock is output on
       CLKO. If the System Clock Prescaler is used, it is the divided system clock that is output.

9.10   Timer/Counter Oscillator
       ATmega48A/PA/88A/PA/168A/PA/328/P uses the same crystal oscillator for Low-frequency Oscillator and
       Timer/Counter Oscillator. See ”Low Frequency Crystal Oscillator” on page 42 for details on the oscillator and
       crystal requirements.
       ATmega48A/PA/88A/PA/168A/PA/328/P share the Timer/Counter Oscillator Pins (TOSC1 and TOSC2) with
       XTAL1 and XTAL2. When using the Timer/Counter Oscillator, the system clock needs to be four times the
       oscillator frequency. Due to this and the pin sharing, the Timer/Counter Oscillator can only be used when the
       Calibrated Internal RC Oscillator is selected as system clock source.
       Applying an external clock source to TOSC1 can be done if EXTCLK in the ASSR Register is written to logic
       one. See ”Asynchronous Operation of Timer/Counter2” on page 160 for further description on selecting external
       clock as input instead of a 32.768kHz watch crystal.

9.11   System Clock Prescaler
       The ATmega48A/PA/88A/PA/168A/PA/328/P has a system clock prescaler, and the system clock can be
       divided by setting the ”CLKPR – Clock Prescale Register” on page 46. This feature can be used to decrease the
       system clock frequency and the power consumption when the requirement for processing power is low. This can
       be used with all clock source options, and it will affect the clock frequency of the CPU and all synchronous
       peripherals. clkI/O, clkADC, clkCPU, and clkFLASH are divided by a factor as shown in Table 29-11 on page 314.
       When switching between prescaler settings, the System Clock Prescaler ensures that no glitches occurs in the
       clock system. It also ensures that no intermediate frequency is higher than neither the clock frequency
       corresponding to the previous setting, nor the clock frequency corresponding to the new setting. The ripple
       counter that implements the prescaler runs at the frequency of the undivided clock, which may be faster than the
       CPU's clock frequency. Hence, it is not possible to determine the state of the prescaler - even if it were
       readable, and the exact time it takes to switch from one clock division to the other cannot be exactly predicted.
       From the time the CLKPS values are written, it takes between T1 + T2 and T1 + 2 * T2 before the new clock
       frequency is active. In this interval, 2 active clock edges are produced. Here, T1 is the previous clock period,
       and T2 is the period corresponding to the new prescaler setting.
       To avoid unintentional changes of clock frequency, a special write procedure must be followed to change the
       CLKPS bits:
        1.   Write the Clock Prescaler Change Enable (CLKPCE) bit to one and all other bits in CLKPR to zero.
        2.   Within four cycles, write the desired value to CLKPS while writing a zero to CLKPCE.
       Interrupts must be disabled when changing prescaler setting to make sure the write procedure is not interrupted.




        2020 Microchip Technology Inc.                    Data Sheet Complete                       DS40002061B-page 45
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P


9.12   Register Description

9.12.1 OSCCAL – Oscillator Calibration Register
        Bit               7          6         5             4            3              2       1           0
        (0x66)           CAL7      CAL6       CAL5         CAL4          CAL3       CAL2       CAL1        CAL0      OSCCAL
        Read/Write       R/W        R/W       R/W          R/W           R/W            R/W     R/W        R/W
        Initial Value                               Device Specific Calibration Value


       • Bits 7:0 – CAL[7:0]: Oscillator Calibration Value
       The Oscillator Calibration Register is used to trim the Calibrated Internal RC Oscillator to remove process
       variations from the oscillator frequency. A pre-programmed calibration value is automatically written to this
       register during chip reset, giving the Factory calibrated frequency as specified in Table 29-9 on page 313. The
       application software can write this register to change the oscillator frequency. The oscillator can be calibrated to
       frequencies as specified in Table 29-9 on page 313. Calibration outside that range is not ensured.
       Note that this oscillator is used to time EEPROM and Flash write accesses, and these write times will be
       affected accordingly. If the EEPROM or Flash are written, do not calibrate to more than 8.8MHz. Otherwise, the
       EEPROM or Flash write may fail.
       The CAL7 bit determines the range of operation for the oscillator. Setting this bit to 0 gives the lowest frequency
       range, setting this bit to 1 gives the highest frequency range. The two frequency ranges are overlapping, in other
       words a setting of OSCCAL = 0x7F gives a higher frequency than OSCCAL = 0x80.
       The CAL6...0 bits are used to tune the frequency within the selected range. A setting of 0x00 gives the lowest
       frequency in that range, and a setting of 0x7F gives the highest frequency in the range.

9.12.2 CLKPR – Clock Prescale Register
        Bit                7              6           5              4              3           2                1       0
        (0x61)          CLKPCE            –           –              –          CLKPS3        CLKPS2      CLKPS1      CLKPS0    CLKPR
        Read/Write        R/W             R           R              R            R/W          R/W           R/W        R/W
        Initial Value      0              0           0              0                         See Bit Description


       • Bit 7 – CLKPCE: Clock Prescaler Change Enable
       The CLKPCE bit must be written to logic one to enable change of the CLKPS bits. The CLKPCE bit is only
       updated when the other bits in CLKPR are simultaneously written to zero. CLKPCE is cleared by hardware four
       cycles after it is written or when CLKPS bits are written. Rewriting the CLKPCE bit within this time-out period
       does neither extend the time-out period, nor clear the CLKPCE bit.

       • Bits 3:0 – CLKPS[3:0]: Clock Prescaler Select Bits 3 - 0
       These bits define the division factor between the selected clock source and the internal system clock. These bits
       can be written run-time to vary the clock frequency to suit the application requirements. As the divider divides
       the master clock input to the MCU, the speed of all synchronous peripherals is reduced when a division factor is
       used. The division factors are given in Table 9-17 on page 47.
       The CKDIV8 Fuse determines the initial value of the CLKPS bits. If CKDIV8 is unprogrammed, the CLKPS bits
       will be reset to “0000”. If CKDIV8 is programmed, CLKPS bits are reset to “0011”, giving a division factor of 8 at
       start up. This feature should be used if the selected clock source has a higher frequency than the maximum
       frequency of the device at the present operating conditions. Note that any value can be written to the CLKPS
       bits regardless of the CKDIV8 Fuse setting. The Application software must ensure that a sufficient division factor
       is chosen if the selected clock source has a higher frequency than the maximum frequency of the device at the
       present operating conditions. The device is shipped with the CKDIV8 Fuse programmed.




        2020 Microchip Technology Inc.                                  Data Sheet Complete                             DS40002061B-page 46
                                        ATmega48A/PA/88A/PA/168A/PA/328/P


Table 9-17.    Clock Prescaler Select
   CLKPS3            CLKPS2        CLKPS1    CLKPS0             Clock Division Factor
       0                 0              0       0                        1
       0                 0              0       1                        2
       0                 0              1       0                        4
       0                 0              1       1                        8
       0                 1              0       0                        16
       0                 1              0       1                        32
       0                 1              1       0                        64
       0                 1              1       1                       128
       1                 0              0       0                       256
       1                 0              0       1                     Reserved
       1                 0              1       0                     Reserved
       1                 0              1       1                     Reserved
       1                 1              0       0                     Reserved
       1                 1              0       1                     Reserved
       1                 1              1       0                     Reserved
       1                 1              1       1                     Reserved




 2020 Microchip Technology Inc.              Data Sheet Complete                       DS40002061B-page 47
                                                                        ATmega48A/PA/88A/PA/168A/PA/328/P


10.      Power Management and Sleep Modes
         Sleep modes enable the application to shut down unused modules in the MCU, thereby saving power. The AVR
         provides various sleep modes allowing the user to tailor the power consumption to the application’s
         requirements.
         When enabled, the Brown-out Detector (BOD) actively monitors the power supply voltage during the sleep
         periods. To further save power, it is possible to disable the BOD in some sleep modes. See ”BOD Disable(1)” on
         page 49 for more details.

10.1     Sleep Modes
         Figure 9-1 on page 36 presents the different clock systems in the ATmega48A/PA/88A/PA/168A/PA/328/P, and
         their distribution. The figure is helpful in selecting an appropriate sleep mode. Table 10-1 shows the different
         sleep modes, their wake up sources BOD disable ability.(1)
         Note:         1. BOD disable is only available for ATmega48PA/88PA/168PA/328P.

Table 10-1.         Active Clock Domains and Wake-up Sources in the Different Sleep Modes
                                    Active Clock Domains                       Oscillators                                                     Wake-up Sources
                                                                            Source Enabled


                                                                                             Timer Oscillator



                                                                                                                INT1, INT0 and




                                                                                                                                                          SPM/EEPROM




                                                                                                                                                                                                BOD Disable
                                                                                                                                 TWI Address
                                                                                                                Pin Change
                                                                            Main Clock




                                                                                                                                                                                    Other I/O

                                                                                                                                                                                                Software
                                                                                             Enabled
                                       clkFLASH




                                                                                                                                                 Timer2



                                                                                                                                                          Ready
                                                                                                                                 Match
                           clkCPU




                                                          clkADC


                                                                   clkASY




                                                                                                                                                                              WDT
                                                                                                                                                                        ADC
                                                  clkIO




 Sleep Mode
 Idle                                             X       X         X           X              X(2)                 X               X             X          X          X     X      X
 ADC Noise
                                                          X         X           X              X(2)                 X               X            X(2)        X          X     X
 Reduction
 Power-down                                                                                                         X               X                                         X                   X
                                                                                                    (2)
 Power-save                                                         X                          X                    X               X             X                           X                   X
           (1)
 Standby                                                                        X                                   X               X                                         X                   X
 Extended
                                                                   X(2)         X              X(2)                 X               X             X                           X                   X
 Standby
Notes:   1.      Only recommended with external crystal or resonator selected as clock source.
         2.      If Timer/Counter2 is running in asynchronous mode.



         To enter any of the six sleep modes, the SE bit in SMCR must be written to logic one and a SLEEP instruction
         must be executed. The SM2, SM1, and SM0 bits in the SMCR Register select which sleep mode (Idle, ADC
         Noise Reduction, Power-down, Power-save, Standby, or Extended Standby) will be activated by the SLEEP
         instruction. See Table 10-2 on page 53 for a summary.
         If an enabled interrupt occurs while the MCU is in a sleep mode, the MCU wakes up. The MCU is then halted for
         four cycles in addition to the start-up time, executes the interrupt routine, and resumes execution from the
         instruction following SLEEP. The contents of the Register File and SRAM are unaltered when the device wakes
         up from sleep. If a reset occurs during sleep mode, the MCU wakes up and executes from the Reset Vector.




          2020 Microchip Technology Inc.                                                       Data Sheet Complete                                                    DS40002061B-page 48
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

10.2   BOD Disable(1)
       When the Brown-out Detector (BOD) is enabled by BODLEVEL fuses - see Table 28-7 on page 291 and
       onwards, the BOD is actively monitoring the power supply voltage during a sleep period. To save power, it is
       possible to disable the BOD by software for some of the sleep modes, see Table 10-1 on page 48. The sleep
       mode power consumption will then be at the same level as when BOD is globally disabled by fuses. If BOD is
       disabled in software, the BOD function is turned off immediately after entering the sleep mode. Upon wake-up
       from sleep, BOD is automatically enabled again. This ensures safe operation in case the VCC level has dropped
       during the sleep period.
       When the BOD has been disabled, the wake-up time from sleep mode will be approximately 60 µs to ensure
       that the BOD is working correctly before the MCU continues executing code.
       BOD disable is controlled by bit 6, BODS (BOD Sleep) in the control register MCUCR, see ”MCUCR – MCU
       Control Register” on page 54. Writing this bit to one turns off the BOD in relevant sleep modes, while a zero in
       this bit keeps BOD active. Default setting keeps BOD active, i.e. BODS set to zero.
       Writing to the BODS bit is controlled by a timed sequence and an enable bit, see ”MCUCR – MCU Control
       Register” on page 54.
       Note:   1. BOD disable only available in picoPower® devices ATmega48PA/88PA/168PA/328P


10.3   Idle Mode
       When the SM2...0 bits are written to 000, the SLEEP instruction makes the MCU enter Idle mode, stopping the
       CPU but allowing the SPI, USART, Analog Comparator, ADC, 2-wire Serial Interface, Timer/Counters,
       Watchdog, and the interrupt system to continue operating. This sleep mode basically halts clkCPU and clkFLASH,
       while allowing the other clocks to run.
       Idle mode enables the MCU to wake up from external triggered interrupts as well as internal ones like the Timer
       Overflow and USART Transmit Complete interrupts. If wake-up from the Analog Comparator interrupt is not
       required, the Analog Comparator can be powered down by setting the ACD bit in the Analog Comparator
       Control and Status Register – ACSR. This will reduce power consumption in Idle mode. If the ADC is enabled, a
       conversion starts automatically when this mode is entered.

10.4   ADC Noise Reduction Mode
       When the SM2...0 bits are written to 001, the SLEEP instruction makes the MCU enter ADC Noise Reduction
       mode, stopping the CPU but allowing the ADC, the external interrupts, the 2-wire Serial Interface address
       watch, Timer/Counter2(1), and the Watchdog to continue operating (if enabled). This sleep mode basically halts
       clkI/O, clkCPU, and clkFLASH, while allowing the other clocks to run.
       This improves the noise environment for the ADC, enabling higher resolution measurements. If the ADC is
       enabled, a conversion starts automatically when this mode is entered. Apart from the ADC Conversion
       Complete interrupt, only an External Reset, a Watchdog System Reset, a Watchdog Interrupt, a Brown-out
       Reset, a 2-wire Serial Interface address match, a Timer/Counter2 interrupt, an SPM/EEPROM ready interrupt,
       an external level interrupt on INT0 or INT1 or a pin change interrupt can wake up the MCU from ADC Noise
       Reduction mode.
       Note:   1. Timer/Counter2 will only keep running in asynchronous mode, see ”8-bit Timer/Counter2 with PWM and Asyn-
                  chronous Operation” on page 150 for details.


10.5   Power-down Mode
       When the SM2...0 bits are written to 010, the SLEEP instruction makes the MCU enter Power-down mode. In
       this mode, the external Oscillator is stopped, while the external interrupts, the 2-wire Serial Interface address
       watch, and the Watchdog continue operating (if enabled). Only an External Reset, a Watchdog System Reset, a
       Watchdog Interrupt, a Brown-out Reset, a 2-wire Serial Interface address match, an external level interrupt on



        2020 Microchip Technology Inc.                     Data Sheet Complete                        DS40002061B-page 49
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       INT0 or INT1, or a pin change interrupt can wake up the MCU. This sleep mode basically halts all generated
       clocks, allowing operation of asynchronous modules only.
       Note:   If a level triggered interrupt is used for wake-up from Power-down, the required level must be held long enough for
               the MCU to complete the wake-up to trigger the level interrupt. If the level disappears before the end of the Start-up
               Time, the MCU will still wake up, but no interrupt will be generated. ”External Interrupts” on page 79. The start-up
               time is defined by the SUT and CKSEL Fuses as described in ”System Clock and Clock Options” on page 36.
       When waking up from Power-down mode, there is a delay from the wake-up condition occurs until the wake-up
       becomes effective. This allows the clock to restart and become stable after having been stopped. The wake-up
       period is defined by the same CKSEL Fuses that define the Reset Time-out period, as described in ”Clock
       Sources” on page 37.

10.6   Power-save Mode
       When the SM2...0 bits are written to 011, the SLEEP instruction makes the MCU enter Power-save mode. This
       mode is identical to Power-down, with one exception:
       If Timer/Counter2 is enabled, it will keep running during sleep. The device can wake up from either Timer
       Overflow or Output Compare event from Timer/Counter2 if the corresponding Timer/Counter2 interrupt enable
       bits are set in TIMSK2, and the Global Interrupt Enable bit in SREG is set.
       If Timer/Counter2 is not running, Power-down mode is recommended instead of Power-save mode.
       The Timer/Counter2 can be clocked both synchronously and asynchronously in Power-save mode. If
       Timer/Counter2 is not using the asynchronous clock, the Timer/Counter Oscillator is stopped during sleep. If
       Timer/Counter2 is not using the synchronous clock, the clock source is stopped during sleep. Note that even if
       the synchronous clock is running in Power-save, this clock is only available for Timer/Counter2.

10.7   Standby Mode
       When the SM2...0 bits are 110 and an external crystal/resonator clock option is selected, the SLEEP instruction
       makes the MCU enter Standby mode. This mode is identical to Power-down with the exception that the
       Oscillator is kept running. From Standby mode, the device wakes up in six clock cycles.




        2020 Microchip Technology Inc.                          Data Sheet Complete                           DS40002061B-page 50
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

10.8   Extended Standby Mode
       When the SM2...0 bits are 111 and an external crystal/resonator clock option is selected, the SLEEP instruction
       makes the MCU enter Extended Standby mode. This mode is identical to Power-save with the exception that
       the Oscillator is kept running. From Extended Standby mode, the device wakes up in six clock cycles.

10.9   Power Reduction Register
       The Power Reduction Register (PRR), see ”PRR – Power Reduction Register” on page 54, provides a method
       to stop the clock to individual peripherals to reduce power consumption. The current state of the peripheral is
       frozen and the I/O registers can not be read or written. Resources used by the peripheral when stopping the
       clock will remain occupied, hence the peripheral should in most cases be disabled before stopping the clock.
       Waking up a module, which is done by clearing the bit in PRR, puts the module in the same state as before
       shutdown.
       Module shutdown can be used in Idle mode and Active mode to significantly reduce the overall power
       consumption. In all other sleep modes, the clock is already stopped.

10.10 Minimizing Power Consumption
       There are several possibilities to consider when trying to minimize the power consumption in an AVR controlled
       system. In general, sleep modes should be used as much as possible, and the sleep mode should be selected
       so that as few as possible of the device’s functions are operating. All functions not needed should be disabled.
       In particular, the following modules may need special consideration when trying to achieve the lowest possible
       power consumption.

10.10.1 Analog to Digital Converter
       If enabled, the ADC will be enabled in all sleep modes. To save power, the ADC should be disabled before
       entering any sleep mode. When the ADC is turned off and on again, the next conversion will be an extended
       conversion. Refer to ”Analog-to-Digital Converter” on page 246 for details on ADC operation.

10.10.2 Analog Comparator
       When entering Idle mode, the Analog Comparator should be disabled if not used. When entering ADC Noise
       Reduction mode, the Analog Comparator should be disabled. In other sleep modes, the Analog Comparator is
       automatically disabled. However, if the Analog Comparator is set up to use the Internal Voltage Reference as
       input, the Analog Comparator should be disabled in all sleep modes. Otherwise, the Internal Voltage Reference
       will be enabled, independent of sleep mode. Refer to ”Analog Comparator” on page 243 for details on how to
       configure the Analog Comparator.

10.10.3 Brown-out Detector
       If the Brown-out Detector is not needed by the application, this module should be turned off. If the Brown-out
       Detector is enabled by the BODLEVEL Fuses, it will be enabled in all sleep modes, and hence, always consume
       power. In the deeper sleep modes, this will contribute significantly to the total current consumption. Refer to
       ”Brown-out Detection” on page 58 for details on how to configure the Brown-out Detector.




         2020 Microchip Technology Inc.                   Data Sheet Complete                      DS40002061B-page 51
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

10.10.4 Internal Voltage Reference
       The Internal Voltage Reference will be enabled when needed by the Brown-out Detection, the Analog
       Comparator or the ADC. If these modules are disabled as described in the sections above, the internal voltage
       reference will be disabled and it will not be consuming power. When turned on again, the user must allow the
       reference to start up before the output is used. If the reference is kept on in sleep mode, the output can be used
       immediately. Refer to ”Internal Voltage Reference” on page 59 for details on the start-up time.

10.10.5 Watchdog Timer
       If the Watchdog Timer is not needed in the application, the module should be turned off. If the Watchdog Timer
       is enabled, it will be enabled in all sleep modes and hence always consume power. In the deeper sleep modes,
       this will contribute significantly to the total current consumption. Refer to ”Watchdog Timer” on page 60 for
       details on how to configure the Watchdog Timer.

10.10.6 Port Pins
       When entering a sleep mode, all port pins should be configured to use minimum power. The most important is
       then to ensure that no pins drive resistive loads. In sleep modes where both the I/O clock (clkI/O) and the ADC
       clock (clkADC) are stopped, the input buffers of the device will be disabled. This ensures that no power is
       consumed by the input logic when not needed. In some cases, the input logic is needed for detecting wake-up
       conditions, and it will then be enabled. Refer to the section ”Digital Input Enable and Sleep Modes” on page 88
       for details on which pins are enabled. If the input buffer is enabled and the input signal is left floating or have an
       analog signal level close to VCC/2, the input buffer will use excessive power.
       For analog input pins, the digital input buffer should be disabled at all times. An analog signal level close to
       VCC/2 on an input pin can cause significant current even in active mode. Digital input buffers can be disabled by
       writing to the Digital Input Disable Registers (DIDR1 and DIDR0). Refer to ”DIDR1 – Digital Input Disable
       Register 1” on page 245 and ”DIDR0 – Digital Input Disable Register 0” on page 260 for details.

10.10.7 On-chip Debug System
       If the On-chip debug system is enabled by the DWEN Fuse and the chip enters sleep mode, the main clock
       source is enabled and hence always consumes power. In the deeper sleep modes, this will contribute
       significantly to the total current consumption.




         2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 52
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P


10.11 Register Description

10.11.1 SMCR – Sleep Mode Control Register
       The Sleep Mode Control Register contains control bits for power management.
        Bit                  7         6       5         4           3         2           1     0
        0x33 (0x53)          –         –       –         –          SM2       SM1         SM0   SE    SMCR
        Read/Write           R         R       R         R          R/W       R/W         R/W   R/W
        Initial Value        0         0       0         0           0         0           0     0


       • Bits [7:4]: Reserved
       These bits are unused in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always be read as zero.

       • Bits 3:1 – SM[2:0]: Sleep Mode Select Bits 2, 1, and 0
       These bits select between the five available sleep modes as shown in Table 10-2.

       Table 10-2.       Sleep Mode Select
               SM2               SM1               SM0       Sleep Mode
                 0                0                 0        Idle
                 0                0                 1        ADC Noise Reduction
                 0                1                 0        Power-down
                 0                1                 1        Power-save
                 1                0                 0        Reserved
                 1                0                 1        Reserved
                 1                1                 0        Standby(1)
                 1                1                 1        External Standby(1)

       Note:       1.   Standby mode is only recommended for use with external crystals or resonators.

       • Bit 0 – SE: Sleep Enable
       The SE bit must be written to logic one to make the MCU enter the sleep mode when the SLEEP instruction is
       executed. To avoid the MCU entering the sleep mode unless it is the programmer’s purpose, it is recommended
       to write the Sleep Enable (SE) bit to one just before the execution of the SLEEP instruction and to clear it
       immediately after waking up.




        2020 Microchip Technology Inc.                             Data Sheet Complete                  DS40002061B-page 53
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

10.11.2 MCUCR – MCU Control Register


        Bit               7             6                5               4             3           2          1    0
                                            (1)               (1)
        0x35 (0x55)       –       BODS             BODSE                PUD            –           –      IVSEL   IVCE         MCUCR

        Read/Write        R         R/W                 R/W             R/W            R           R      R/W     R/W
        Initial Value     0             0                0               0             0           0          0    0


       • Bit 6 – BODS: BOD Sleep(1)
       The BODS bit must be written to logic one in order to turn off BOD during sleep, see Table 10-1 on page 48.
       Writing to the BODS bit is controlled by a timed sequence and an enable bit, BODSE in MCUCR. To disable
       BOD in relevant sleep modes, both BODS and BODSE must first be set to one. Then, to set the BODS bit,
       BODS must be set to one and BODSE must be set to zero within four clock cycles.
       The BODS bit is active three clock cycles after it is set. A sleep instruction must be executed while BODS is
       active in order to turn off the BOD for the actual sleep mode. The BODS bit is automatically cleared after three
       clock cycles.

       • Bit 5 – BODSE: BOD Sleep Enable(1)
       BODSE enables setting of BODS control bit, as explained in BODS bit description. BOD disable is controlled by
       a timed sequence.
       Note:       1. BODS and BODSE only available for picoPower devices ATmega48PA/88PA/168PA/328P

10.11.3 PRR – Power Reduction Register

        Bit               7         6               5               4              3          2           1            0
        (0x64)          PRTWI   PRTIM2            PRTIM0            –          PRTIM1      PRSPI       PRUSART0   PRADC          PRR
        Read/Write       R/W       R/W             R/W              R            R/W         R/W         R/W        R/W
        Initial Value     0         0               0               0              0          0           0            0


       • Bit 7 – PRTWI: Power Reduction TWI
       Writing a logic one to this bit shuts down the TWI by stopping the clock to the module. When waking up the TWI
       again, the TWI should be re initialized to ensure proper operation.
       • Bit 6 – PRTIM2: Power Reduction Timer/Counter2
       Writing a logic one to this bit shuts down the Timer/Counter2 module in synchronous mode (AS2 is 0). When the
       Timer/Counter2 is enabled, operation will continue like before the shutdown.

       • Bit 5 – PRTIM0: Power Reduction Timer/Counter0
       Writing a logic one to this bit shuts down the Timer/Counter0 module. When the Timer/Counter0 is enabled,
       operation will continue like before the shutdown.

       • Bit 4 – Reserved
       This bit is reserved in ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

       • Bit 3 – PRTIM1: Power Reduction Timer/Counter1
       Writing a logic one to this bit shuts down the Timer/Counter1 module. When the Timer/Counter1 is enabled,
       operation will continue like before the shutdown.




        2020 Microchip Technology Inc.                                      Data Sheet Complete                           DS40002061B-page 54
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

• Bit 2 – PRSPI: Power Reduction Serial Peripheral Interface
If using debugWIRE On-chip Debug System, this bit should not be written to one. Writing a logic one to this bit
shuts down the Serial Peripheral Interface by stopping the clock to the module. When waking up the SPI again,
the SPI should be re initialized to ensure proper operation.

• Bit 1 – PRUSART0: Power Reduction USART0
Writing a logic one to this bit shuts down the USART by stopping the clock to the module. When waking up the
USART again, the USART should be re initialized to ensure proper operation.

• Bit 0 – PRADC: Power Reduction ADC
Writing a logic one to this bit shuts down the ADC. The ADC must be disabled before shut down. The analog
comparator cannot use the ADC input MUX when the ADC is shut down.




 2020 Microchip Technology Inc.                   Data Sheet Complete                      DS40002061B-page 55
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


11.    System Control and Reset

11.1   Resetting the AVR
       During reset, all I/O Registers are set to their initial values, and the program starts execution from the Reset
       Vector. For ATmega168A/168PA/328/328P the instruction placed at the Reset Vector must be a JMP –
       Absolute Jump – instruction to the reset handling routine. For the ATmega 48A/48PA and ATmega88A/88PA,
       the instruction placed at the Reset Vector must be an RJMP – Relative Jump – instruction to the reset handling
       routine. If the program never enables an interrupt source, the Interrupt Vectors are not used, and regular
       program code can be placed at these locations. This is also the case if the Reset Vector is in the Application
       section while the Interrupt Vectors are in the Boot section or vice versa
       (ATmega88A/88PA/168A/168PA/328/328P only). The circuit diagram in Figure 11-1 on page 57 shows the
       reset logic. Table 29-11 on page 314 defines the electrical parameters of the reset circuitry.
       The I/O ports of the AVR are immediately reset to their initial state when a reset source goes active. This does
       not require any clock source to be running.
       After all reset sources have gone inactive, a delay counter is invoked, stretching the internal reset. This allows
       the power to reach a stable level before normal operation starts. The time-out period of the delay counter is
       defined by the user through the SUT and CKSEL Fuses. The different selections for the delay period are
       presented in ”Clock Sources” on page 37.

11.2   Reset Sources
       The ATmega48A/PA/88A/PA/168A/PA/328/P has four sources of reset:
            Power-on Reset. The MCU is reset when the supply voltage is below the Power-on Reset threshold
             (VPOT).
            External Reset. The MCU is reset when a low level is present on the RESET pin for longer than the
             minimum pulse length.
            Watchdog System Reset. The MCU is reset when the Watchdog Timer period expires and the Watchdog
             System Reset mode is enabled.
            Brown-out Reset. The MCU is reset when the supply voltage VCC is below the Brown-out Reset threshold
             (VBOT) and the Brown-out Detector is enabled.




        2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 56
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 11-1.    Reset Logic
                                                                                        DATA BUS



                                                                                       MCU Status
                                                                                     Register (MCUSR)




                                                                                       PORF
                                                                                       BORF
                                                                                      EXTRF
                                                                                      WDRF
                                                               Power-on Reset
                                                                  Circuit



                                                                 Brown-out
                       BODLEVEL [2..0]                          Reset Circuit


                                         Pull-up Resistor




                                          SPIKE
                                          FILTER



                       RSTDISBL
                                                                 Watchdog
                                                                 Oscillator


                                                                  Clock         CK          Delay Counters
                                                                 Generator                                   TIMEOUT


                                                              CKSEL[3:0]
                                                                SUT[1:0]



11.3   Power-on Reset
       A Power-on Reset (POR) pulse is generated by an On-chip detection circuit. The detection level is defined in
       ”System and Reset Characteristics” on page 314. The POR is activated whenever VCC is below the detection
       level. The POR circuit can be used to trigger the start-up Reset, as well as to detect a failure in supply voltage.
       A Power-on Reset (POR) circuit ensures that the device is reset from Power-on. Reaching the Power-on Reset
       threshold voltage invokes the delay counter, which determines how long the device is kept in RESET after VCC
       rise. The RESET signal is activated again, without any delay, when VCC decreases below the detection level.

       Figure 11-2.    MCU Start-up, RESET Tied to VCC

                                                      VPOT
                           VCC


                                                      VRST
                         RESET


                                                             tTOUT
                      TIME-OUT




                      INTERNAL
                         RESET




        2020 Microchip Technology Inc.                                       Data Sheet Complete                      DS40002061B-page 57
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 11-3.    MCU Start-up, RESET Extended Externally

                                            VPOT
                           VCC


                                                                VRST
                         RESET


                                                                    tTOUT
                      TIME-OUT




                      INTERNAL
                         RESET



11.4   External Reset
       An External Reset is generated by a low level on the RESET pin. Reset pulses longer than the minimum pulse
       width (see ”System and Reset Characteristics” on page 314) will generate a reset, even if the clock is not
       running. Shorter pulses are not ensured to generate a reset. When the applied signal reaches the Reset
       Threshold Voltage – VRST – on its positive edge, the delay counter starts the MCU after the Time-out period –
       tTOUT – has expired. The External Reset can be disabled by the RSTDISBL fuse, see Table 28-7 on page 291.

       Figure 11-4.    External Reset During Operation
                            CC




11.5   Brown-out Detection
       ATmega48A/PA/88A/PA/168A/PA/328/P has an On-chip Brown-out Detection (BOD) circuit for monitoring the
       VCC level during operation by comparing it to a fixed trigger level. The trigger level for the BOD can be selected
       by the BODLEVEL Fuses. The trigger level has a hysteresis to ensure spike free Brown-out Detection. The
       hysteresis on the detection level should be interpreted as VBOT+ = VBOT + VHYST/2 and VBOT- = VBOT -
       VHYST/2.When the BOD is enabled, and VCC decreases to a value below the trigger level (VBOT- in Figure 11-5 on
       page 59), the Brown-out Reset is immediately activated. When VCC increases above the trigger level (VBOT+ in
       Figure 11-5 on page 59), the delay counter starts the MCU after the Time-out period tTOUT has expired.
       The BOD circuit will only detect a drop in VCC if the voltage stays below the trigger level for longer than tBOD
       given in ”System and Reset Characteristics” on page 314.




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 58
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 11-5.   Brown-out Reset During Operation

                                      VCC                                           VBOT+
                                                      VBOT-



                                    RESET




                                 TIME-OUT                                           tTOUT




                                 INTERNAL
                                    RESET



11.6   Watchdog System Reset
       When the Watchdog times out, it will generate a short reset pulse of one CK cycle duration. On the falling edge
       of this pulse, the delay timer starts counting the Time-out period tTOUT. Refer to page 60 for details on operation
       of the Watchdog Timer.

       Figure 11-6.   Watchdog System Reset During Operation
                            CC




                                                       CK




11.7   Internal Voltage Reference
       ATmega48A/PA/88A/PA/168A/PA/328/P features an internal bandgap reference. This reference is used for
       Brown-out Detection, and it can be used as an input to the Analog Comparator or the ADC.

11.7.1 Voltage Reference Enable Signals and Start-up Time
       The voltage reference has a start-up time that may influence the way it should be used. The start-up time is
       given in ”System and Reset Characteristics” on page 314. To save power, the reference is not always turned on.
       The reference is on during the following situations:
       1. When the BOD is enabled (by programming the BODLEVEL [2:0] Fuses).
        2.   When the bandgap reference is connected to the Analog Comparator (by setting the ACBG bit in ACSR).
        3.   When the ADC is enabled.
       Thus, when the BOD is not enabled, after setting the ACBG bit or enabling the ADC, the user must always allow
       the reference to start up before the output from the Analog Comparator or ADC is used. To reduce power
       consumption in Power-down mode, the user can avoid the three conditions above to ensure that the reference
       is turned off before entering Power-down mode.




        2020 Microchip Technology Inc.                       Data Sheet Complete                     DS40002061B-page 59
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

11.8   Watchdog Timer
11.8.1 Features
       • Clocked from separate On-chip Oscillator
       • 3 Operating modes
           – Interrupt
           – System Reset
           – Interrupt and System Reset
       • Selectable Time-out period from 16ms to 8s
       • Possible Hardware fuse Watchdog always on (WDTON) for fail-safe mode
11.8.2 Overview
       ATmega48A/PA/88A/PA/168A/PA/328/P has an Enhanced Watchdog Timer (WDT). The WDT is a timer
       counting cycles of a separate on-chip 128kHz oscillator. The WDT gives an interrupt or a system reset when the
       counter reaches a given time-out value. In normal operation mode, it is required that the system uses the WDR
       - Watchdog Timer Reset - instruction to restart the counter before the time-out value is reached. If the system
       doesn't restart the counter, an interrupt or system reset will be issued.
       Figure 11-7.   Watchdog Timer

                                            128kHz
                                          OSCILLATOR
                                                            OSC/2K
                                                            OSC/4K
                                                            OSC/8K
                                                           OSC/16K
                                                           OSC/32K
                                                           OSC/64K
                                                          OSC/128K
                                                          OSC/256K
                                                          OSC/512K
                                                         OSC/1024K
                                                                                  WDP0
                                                                                  WDP1
                                      WATCHDOG                                    WDP2
                                      RESET                                       WDP3

                                              WDE
                                                                                    MCU RESET


                                              WDIF


                                                                                    INTERRUPT
                                              WDIE


       In Interrupt mode, the WDT gives an interrupt when the timer expires. This interrupt can be used to wake the
       device from sleep-modes, and also as a general system timer. One example is to limit the maximum time
       allowed for certain operations, giving an interrupt when the operation has run longer than expected. In System
       Reset mode, the WDT gives a reset when the timer expires. This is typically used to prevent system hang-up in
       case of runaway code. The third mode, Interrupt and System Reset mode, combines the other two modes by
       first giving an interrupt and then switch to System Reset mode. This mode will for instance allow a safe
       shutdown by saving critical parameters before a system reset.
       The Watchdog always on (WDTON) fuse, if programmed, will force the Watchdog Timer to System Reset mode.
       With the fuse programmed the System Reset mode bit (WDE) and Interrupt mode bit (WDIE) are locked to 1
       and 0 respectively. To further ensure program security, alterations to the Watchdog set-up must follow timed
       sequences. The sequence for clearing WDE and changing time-out configuration is as follows:
        1.   In the same operation, write a logic one to the Watchdog change enable bit (WDCE) and WDE. A logic
             one must be written to WDE regardless of the previous value of the WDE bit.
        2.   Within the next four clock cycles, write the WDE and Watchdog prescaler bits (WDP) as desired, but with
             the WDCE bit cleared. This must be done in one operation.
       The following code example shows one assembly and one C function for turning off the Watchdog Timer. The
       example assumes that interrupts are controlled (e.g. by disabling interrupts globally) so that no interrupts will
       occur during the execution of these functions.



        2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 60
                                      ATmega48A/PA/88A/PA/168A/PA/328/P


 Assembly Code Example(1)
          WDT_off:
                ; Turn off global interrupt
                cli
                ; Reset Watchdog Timer
                wdr
                ; Clear WDRF in MCUSR
                in    r16, MCUSR
                andi r16, ~(1<<WDRF)
                out   MCUSR, r16
                ; Write logical one to WDCE and WDE
                ; Keep old prescaler setting to prevent unintentional
          time-out
                lds r16, WDTCSR
                ori   r16, (1<<WDCE) | (1<<WDE)
                sts WDTCSR, r16
                ; Turn off WDT
                ldi   r16, (0<<WDE)
                sts WDTCSR, r16
                ; Turn on global interrupt
                sei
                ret
 C Code Example(1)
          void WDT_off(void)
          {
                __disable_interrupt();
                __watchdog_reset();
                /* Clear WDRF in MCUSR */
                MCUSR &= ~(1<<WDRF);
                /* Write logical one to WDCE and WDE */
                /* Keep old prescaler setting to prevent unintentional
          time-out */
                WDTCSR |= (1<<WDCE) | (1<<WDE);
                /* Turn off WDT */
                WDTCSR = 0x00;
                __enable_interrupt();
          }

Note:   1.   See ”About Code Examples” on page 17.


Note: If the Watchdog is accidentally enabled, for example by a runaway pointer or brown-out condition, the
device will be reset and the Watchdog Timer will stay enabled. If the code is not set up to handle the Watchdog,
this might lead to an eternal loop of time-out resets. To avoid this situation, the application software should
always clear the Watchdog System Reset Flag (WDRF) and the WDE control bit in the initialization routine,
even if the Watchdog is not in use.




 2020 Microchip Technology Inc.                     Data Sheet Complete                     DS40002061B-page 61
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

The following code example shows one assembly and one C function for changing the time-out value of the
Watchdog Timer.
 Assembly Code Example(1)
          WDT_Prescaler_Change:
                ; Turn off global interrupt
                cli
                ; Reset Watchdog Timer
                wdr
                ; Start timed sequence
                lds r16, WDTCSR
                ori   r16, (1<<WDCE) | (1<<WDE)
                sts WDTCSR, r16
                ; -- Got four cycles to set the new values from here -
                ; Set new prescaler(time-out) value = 64K cycles (~0.5 s)
                ldi   r16, (1<<WDE) | (1<<WDP2) | (1<<WDP0)
                sts WDTCSR, r16
                ; -- Finished setting new values, used 2 cycles -
                ; Turn on global interrupt
                sei
                ret
 C Code Example(1)
          void WDT_Prescaler_Change(void)
          {
                __disable_interrupt();
                __watchdog_reset();
                /* Start timed sequence */
                WDTCSR |= (1<<WDCE) | (1<<WDE);
                /* Set new prescaler(time-out) value = 64K cycles (~0.5
          s) */
                WDTCSR = (1<<WDE) | (1<<WDP2) | (1<<WDP0);
                __enable_interrupt();
          }

Note:   1.   See ”About Code Examples” on page 17.


Note: The Watchdog Timer should be reset before any change of the WDP bits, since a change in the WDP bits
can result in a time-out when switching to a shorter time-out period.




 2020 Microchip Technology Inc.                     Data Sheet Complete                DS40002061B-page 62
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


11.9   Register Description

11.9.1 MCUSR – MCU Status Register
       The MCU Status Register provides information on which reset source caused an MCU reset.
        Bit                 7             6         5          4              3           2              1             0
        0x34 (0x54)        –              –        –           –            WDRF        BORF          EXTRF          PORF    MCUSR
        Read/Write         R              R        R           R             R/W         R/W           R/W            R/W
        Initial Value       0             0         0          0                         See Bit Description


       • Bit 7:4: Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 3 – WDRF: Watchdog System Reset Flag
       This bit is set if a Watchdog System Reset occurs. The bit is reset by a Power-on Reset, or by writing a logic
       zero to the flag.

       • Bit 2 – BORF: Brown-out Reset Flag
       This bit is set if a Brown-out Reset occurs. The bit is reset by a Power-on Reset, or by writing a logic zero to the
       flag.

       • Bit 1 – EXTRF: External Reset Flag
       This bit is set if an External Reset occurs. The bit is reset by a Power-on Reset, or by writing a logic zero to the
       flag.

       • Bit 0 – PORF: Power-on Reset Flag
       This bit is set if a Power-on Reset occurs. The bit is reset only by writing a logic zero to the flag.
       To make use of the Reset Flags to identify a reset condition, the user should read and then Reset the MCUSR
       as early as possible in the program. If the register is cleared before another reset occurs, the source of the reset
       can be found by examining the Reset Flags.

11.9.2 WDTCSR – Watchdog Timer Control Register
        Bit                7          6        5          4             3           2             1             0
        (0x60)          WDIF        WDIE      WDP3      WDCE          WDE          WDP2        WDP1            WDP0    WDTCSR
        Read/Write        R/W        R/W      R/W        R/W           R/W         R/W          R/W            R/W
        Initial Value      0          0        0          0             X           0             0             0


       • Bit 7 – WDIF: Watchdog Interrupt Flag
       This bit is set when a time-out occurs in the Watchdog Timer and the Watchdog Timer is configured for interrupt.
       WDIF is cleared by hardware when executing the corresponding interrupt handling vector. Alternatively, WDIF is
       cleared by writing a logic one to the flag. When the I-bit in SREG and WDIE are set, the Watchdog Time-out
       Interrupt is executed.

       • Bit 6 – WDIE: Watchdog Interrupt Enable
       When this bit is written to one and the I-bit in the Status Register is set, the Watchdog Interrupt is enabled. If
       WDE is cleared in combination with this setting, the Watchdog Timer is in Interrupt Mode, and the
       corresponding interrupt is executed if time-out in the Watchdog Timer occurs. If WDE is set, the Watchdog
       Timer is in Interrupt and System Reset Mode. The first time-out in the Watchdog Timer will set WDIF. Executing




        2020 Microchip Technology Inc.                            Data Sheet Complete                                 DS40002061B-page 63
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

the corresponding interrupt vector will clear WDIE and WDIF automatically by hardware (the Watchdog goes to
System Reset Mode). This is useful for keeping the Watchdog Timer security while using the interrupt. To stay
in Interrupt and System Reset Mode, WDIE must be set after each interrupt. This should however not be done
within the interrupt service routine itself, as this might compromise the safety-function of the Watchdog System
Reset mode. If the interrupt is not executed before the next time-out, a System Reset will be applied.

Table 11-1.         Watchdog Timer Configuration
             (1)
 WDTON                  WDE          WDIE     Mode                           Action on Time-out
        1                 0           0       Stopped                        None
        1                 0           1       Interrupt Mode                 Interrupt
        1                 1           0       System Reset Mode              Reset
                                              Interrupt and System Reset     Interrupt, then go to System
        1                 1           1
                                              Mode                           Reset Mode
        0                 x           x       System Reset Mode              Reset

Note:       1.     WDTON Fuse set to “0” means programmed and “1” means unprogrammed.

• Bit 4 – WDCE: Watchdog Change Enable
This bit is used in timed sequences for changing WDE and prescaler bits. To clear the WDE bit, and/or change
the prescaler bits, WDCE must be set.
Once written to one, hardware will clear WDCE after four clock cycles.

• Bit 3 – WDE: Watchdog System Reset Enable
WDE is overridden by WDRF in MCUSR. This means that WDE is always set when WDRF is set. To clear
WDE, WDRF must be cleared first. This feature ensures multiple resets during conditions causing failure, and a
safe start-up after the failure.

• Bit 5, 2:0 - WDP[3:0]: Watchdog Timer Prescaler 3, 2, 1 and 0
The WDP[3:0] bits determine the Watchdog Timer prescaling when the Watchdog Timer is running. The
different prescaling values and their corresponding time-out periods are shown in Table 11-2 on page 64.

Table 11-2.         Watchdog Timer Prescale Select
                                               Number of WDT Oscillator           Typical Time-out at
 WDP3              WDP2       WDP1   WDP0              Cycles                         VCC = 5.0V
    0               0          0          0          2K (2048) cycles                    16ms
    0               0          0          1          4K (4096) cycles                    32ms
    0               0          1          0          8K (8192) cycles                    64ms
    0               0          1          1        16K (16384) cycles                    0.125 s
    0               1          0          0        32K (32768) cycles                    0.25 s
    0               1          0          1        64K (65536) cycles                     0.5 s
    0               1          1          0       128K (131072) cycles                    1.0 s
    0               1          1          1       256K (262144) cycles                    2.0 s
    1               0          0          0       512K (524288) cycles                    4.0 s
    1               0          0          1     1024K (1048576) cycles                    8.0 s




 2020 Microchip Technology Inc.                           Data Sheet Complete                          DS40002061B-page 64
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Table 11-2.    Watchdog Timer Prescale Select (Continued)
                                           Number of WDT Oscillator        Typical Time-out at
 WDP3         WDP2     WDP1        WDP0            Cycles                      VCC = 5.0V
    1          0          1         0
    1          0          1         1
    1          1          0         0
                                                                Reserved
    1          1          0         1
    1          1          1         0
    1          1          1         1




 2020 Microchip Technology Inc.                     Data Sheet Complete                         DS40002061B-page 65
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P


12.         Interrupts
            This section describes the specifics of the interrupt handling as performed in
            ATmega48A/PA/88A/PA/168A/PA/328/P. For a general explanation of the AVR interrupt handling, refer to
            ”Reset and Interrupt Handling” on page 23.
            The interrupt vectors in ATmega 48A/48PA, ATmega88A/88PA, ATmega168A/168PA and ATmega328/328P
            are generally the same, with the following differences:
                 Each Interrupt Vector occupies two instruction words in ATmega168A/168PA and ATmega328/328P, and
                  one instruction word in ATmega 48A/48PA and ATmega88A/88PA.
                 ATmega 48A/48PA does not have a separate Boot Loader Section. In ATmega88A/88PA,
                  ATmega168A/168PA and ATmega328/328P, the Reset Vector is affected by the BOOTRST fuse, and the
                  Interrupt Vector start address is affected by the IVSEL bit in MCUCR.

12.1        Interrupt Vectors in ATmega48A and ATmega48PA

Table 12-1.       Reset and Interrupt Vectors in ATmega48A and ATmega48PA
 Vector No.       Program Address        Source          Interrupt Definition
       1                 0x000           RESET           External Pin, Power-on Reset, Brown-out Reset and Watchdog System Reset

       2                 0x001           INT0            External Interrupt Request 0
       3                 0x002           INT1            External Interrupt Request 1
       4                 0x003           PCINT0          Pin Change Interrupt Request 0
       5                 0x004           PCINT1          Pin Change Interrupt Request 1
       6                 0x005           PCINT2          Pin Change Interrupt Request 2
       7                 0x006           WDT             Watchdog Time-out Interrupt
       8                 0x007           TIMER2_COMPA    Timer/Counter2 Compare Match A
       9                 0x008           TIMER2_COMPB    Timer/Counter2 Compare Match B
       10                0x009           TIMER2_OVF      Timer/Counter2 Overflow
       11                0x00A           TIMER1_CAPT     Timer/Counter1 Capture Event
       12                0x00B           TIMER1_COMPA    Timer/Counter1 Compare Match A
       13                0x00C           TIMER1_COMPB    Timer/Counter1 Compare Match B
       14                0x00D           TIMER1_OVF      Timer/Counter1 Overflow
       15                0x00E           TIMER0_COMPA    Timer/Counter0 Compare Match A
       16                0x00F           TIMER0_COMPB    Timer/Counter0 Compare Match B
       17                0x010           TIMER0_OVF      Timer/Counter0 Overflow
       18                0x011           SPI_STC         SPI Serial Transfer Complete
       19                0x012           USART_RX        USART Rx Complete
       20                0x013           USART_UDRE      USART, Data Register Empty
       21                0x014           USART_TX        USART, Tx Complete
       22                0x015           ADC             ADC Conversion Complete
       23                0x016           EE_READY        EEPROM Ready




             2020 Microchip Technology Inc.                 Data Sheet Complete                           DS40002061B-page 66
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Table 12-1.     Reset and Interrupt Vectors in ATmega48A and ATmega48PA (Continued)
 Vector No.     Program Address        Source               Interrupt Definition
     24                0x017           ANALOG_COMP          Analog Comparator
     25                0x018           TWI                  2-wire Serial Interface
     26                0x019           SPM_Ready            Store Program Memory Ready

          The most typical and general program setup for the Reset and Interrupt Vector Addresses in ATmega 48A/48PA
          is:
                  Address Labels             Code                 Comments
                  0x000                      rjmp   RESET         ; Reset Handler
                  0x001                      rjmp   EXT_INT0      ; IRQ0 Handler
                  0x002                      rjmp   EXT_INT1      ; IRQ1 Handler
                  0x003                      rjmp   PCINT0        ; PCINT0 Handler
                  0x004                      rjmp   PCINT1        ; PCINT1 Handler
                  0x005                      rjmp   PCINT2        ; PCINT2 Handler
                  0x006                      rjmp   WDT           ; Watchdog Timer Handler
                  0x007                      rjmp   TIM2_COMPA    ; Timer2 Compare A Handler
                  0x008                      rjmp   TIM2_COMPB    ; Timer2 Compare B Handler
                  0x009                      rjmp   TIM2_OVF      ; Timer2 Overflow Handler
                  0x00A                      rjmp   TIM1_CAPT     ; Timer1 Capture Handler
                  0x00B                      rjmp   TIM1_COMPA    ; Timer1 Compare A Handler
                  0x00C                      rjmp   TIM1_COMPB    ; Timer1 Compare B Handler
                  0x00D                      rjmp   TIM1_OVF       ; Timer1 Overflow Handler
                  0x00E                      rjmp   TIM0_COMPA     ; Timer0 Compare A Handler
                  0x00F                      rjmp   TIM0_COMPB     ; Timer0 Compare B Handler
                  0x010                      rjmp   TIM0_OVF       ; Timer0 Overflow Handler
                  0x011                      rjmp   SPI_STC        ; SPI Transfer Complete Handler
                  0x012                      rjmp   USART_RXC      ; USART, RX Complete Handler
                  0x013                      rjmp   USART_UDRE     ; USART, UDR Empty Handler
                  0x014                      rjmp   USART_TXC      ; USART, TX Complete Handler
                  0x015                      rjmp   ADC            ; ADC Conversion Complete Handler
                  0x016                      rjmp   EE_RDY         ; EEPROM Ready Handler
                  0x017                      rjmp   ANA_COMP       ; Analog Comparator Handler
                  0x018                      rjmp   TWI            ; 2-wire Serial Interface Handler
                  0x019                      rjmp                 ; SPM_RDYStore Program Memory Ready
                  Handler
                  ;
                  0x01A RESET:               ldi   r16, high(RAMEND); Main program start
                  0x01B                      out   SPH,r16      ; Set Stack Pointer to top of RAM
                  0x01C                      ldi   r16, low(RAMEND)
                  0x01D                      out   SPL,r16
                  0x01E                      sei                ; Enable interrupts
                  0x01F                      <instr> xxx
                    ... ...                  ...    ...




           2020 Microchip Technology Inc.                       Data Sheet Complete              DS40002061B-page 67
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

12.2          Interrupt Vectors in ATmega88A and ATmega88PA

Table 12-2.           Reset and Interrupt Vectors in ATmega88A and ATmega88PA
                             Program
 Vector No.                 Address(2)             Source                          Interrupt Definition
         1                    0x000(1)             RESET                           External Pin, Power-on Reset, Brown-out Reset and Watchdog System Reset

         2                     0x001               INT0                            External Interrupt Request 0
         3                     0x002               INT1                            External Interrupt Request 1
         4                     0x003               PCINT0                          Pin Change Interrupt Request 0
         5                     0x004               PCINT1                          Pin Change Interrupt Request 1
         6                     0x005               PCINT2                          Pin Change Interrupt Request 2
         7                     0x006               WDT                             Watchdog Time-out Interrupt
         8                     0x007               TIMER2_COMPA                    Timer/Counter2 Compare Match A
         9                     0x008               TIMER2_COMPB                    Timer/Counter2 Compare Match B
         10                    0x009               TIMER2_OVF                      Timer/Counter2 Overflow
         11                    0x00A               TIMER1_CAPT                     Timer/Counter1 Capture Event
         12                    0x00B               TIMER1_COMPA                    Timer/Counter1 Compare Match A
         13                    0x00C               TIMER1_COMPB                    Timer/Counter1 Compare Match B
         14                    0x00D               TIMER1_OVF                      Timer/Counter1 Overflow
         15                    0x00E               TIMER0_COMPA                    Timer/Counter0 Compare Match A
         16                    0x00F               TIMER0_COMPB                    Timer/Counter0 Compare Match B
         17                    0x010               TIMER0_OVF                      Timer/Counter0 Overflow
         18                    0x011               SPI_STC                         SPI Serial Transfer Complete
         19                    0x012               USART_RX                        USART Rx Complete
         20                    0x013               USART_UDRE                      USART, Data Register Empty
         21                    0x014               USART_TX                        USART, Tx Complete
         22                    0x015               ADC                             ADC Conversion Complete
         23                    0x016               EE_READY                        EEPROM Ready
         24                    0x017               ANALOG_COMP                     Analog Comparator
         25                    0x018               TWI                             2-wire Serial Interface
         26                    0x019               SPM_Ready                       Store Program Memory Ready
Notes:        1.   When the BOOTRST Fuse is programmed, the device will jump to the Boot Loader address at reset, see ”Boot Loader Support – Read-While-Write Self-
                   Programming” on page 272.
              2.   When the IVSEL bit in MCUCR is set, Interrupt Vectors will be moved to the start of the Boot Flash Section. The address of each Interrupt Vector will then
                   be the address in this table added to the start address of the Boot Flash Section.



              Table 12-3 on page 69 shows reset and Interrupt Vectors placement for the various combinations of BOOTRST
              and IVSEL settings. If the program never enables an interrupt source, the Interrupt Vectors are not used, and
              regular program code can be placed at these locations. This is also the case if the Reset Vector is in the
              Application section while the Interrupt Vectors are in the Boot section or vice versa.




               2020 Microchip Technology Inc.                                          Data Sheet Complete                                        DS40002061B-page 68
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

Table 12-3.    Reset and Interrupt Vectors Placement in ATmega88A and ATmega88PA(1)
   BOOTRST           IVSEL         Reset Address             Interrupt Vectors Start Address
        1               0          0x000                     0x001
        1               1          0x000                     Boot Reset Address + 0x001
        0               0          Boot Reset Address        0x001
        0               1          Boot Reset Address        Boot Reset Address + 0x001
Note:   1.    The Boot Reset Address is shown in Table 27-7 on page 284. For the BOOTRST Fuse “1” means
              unprogrammed while “0” means programmed.
The most typical and general program setup for the Reset and Interrupt Vector Addresses in ATmega88A/88PA
is:
        Address       Labels Code                        Comments
        0x000                rjmp          RESET         ; Reset Handler
        0x001                rjmp          EXT_INT0      ; IRQ0 Handler
        0x002                rjmp          EXT_INT1      ; IRQ1 Handler
        0x003                rjmp          PCINT0        ; PCINT0 Handler
        0x004                rjmp          PCINT1        ; PCINT1 Handler
        0x005                rjmp          PCINT2        ; PCINT2 Handler
        0x006                rjmp          WDT           ; Watchdog Timer Handler
        0x007                rjmp          TIM2_COMPA    ; Timer2 Compare A Handler
        0X008                rjmp          TIM2_COMPB    ; Timer2 Compare B Handler
        0x009                rjmp          TIM2_OVF      ; Timer2 Overflow Handler
        0x00A                rjmp          TIM1_CAPT     ; Timer1 Capture Handler
        0x00B                rjmp          TIM1_COMPA    ; Timer1 Compare A Handler
        0x00C                rjmp          TIM1_COMPB    ; Timer1 Compare B Handler
        0x00D                rjmp          TIM1_OVF      ; Timer1 Overflow Handler
        0x00E                rjmp          TIM0_COMPA    ; Timer0 Compare A Handler
        0x00F                rjmp          TIM0_COMPB    ; Timer0 Compare B Handler
        0x010                rjmp          TIM0_OVF      ; Timer0 Overflow Handler
        0x011                rjmp          SPI_STC       ; SPI Transfer Complete Handler
        0x012                rjmp          USART_RXC     ; USART, RX Complete Handler
        0x013                rjmp          USART_UDRE    ; USART, UDR Empty Handler
        0x014                rjmp          USART_TXC     ; USART, TX Complete Handler
        0x015                rjmp          ADC           ; ADC Conversion Complete Handler
        0x016                rjmp          EE_RDY        ; EEPROM Ready Handler
        0x017                rjmp          ANA_COMP      ; Analog Comparator Handler
        0x018                rjmp          TWI           ; 2-wire Serial Interface Handler
        0x019                rjmp          SPM_RDY       ; Store Program Memory Ready Handler
        ;
        0x01A         RESET: ldi   r16, high(RAMEND); Main program start
        0x01B                out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x01C                ldi   r16, low(RAMEND)
        0x01D                out   SPL,r16
        0x01E                sei               ; Enable interrupts
        0x01F                <instr> xxx
When the BOOTRST Fuse is unprogrammed, the Boot section size set to 2Kbytes and the IVSEL bit in the
MCUCR Register is set before any interrupts are enabled, the most typical and general program setup for the
Reset and Interrupt Vector Addresses in ATmega88A/88PA is:
        Address       Labels Code                      Comments
        0x000         RESET: ldi           r16,high(RAMEND); Main program start
        0x001                out           SPH,r16     ; Set Stack Pointer to top of RAM



 2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 69
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

        0x002                      ldi   r16,low(RAMEND)
        0x003                      out   SPL,r16
        0x004                      sei                ; Enable interrupts
        0x005                      <instr> xxx
        ;
        .org 0xC01
        0xC01                      rjmp   EXT_INT0    ; IRQ0 Handler
        0xC02                      rjmp   EXT_INT1    ; IRQ1 Handler
        ...                        ...    ...         ;
        0xC19                      rjmp   SPM_RDY     ; Store Program Memory Ready Handler
When the BOOTRST Fuse is programmed and the Boot section size set to 2Kbytes, the most typical and
general program setup for the Reset and Interrupt Vector Addresses in ATmega88A/88PA is:
        Address                                       LabelsCodeComments
        .org 0x001
        0x001                      rjmp   EXT_INT0    ; IRQ0 Handler
        0x002                      rjmp   EXT_INT1    ; IRQ1 Handler
        ...                        ...    ...         ;
        0x019                      rjmp   SPM_RDY     ; Store Program Memory Ready Handler
        ;
        .org 0xC00
        0xC00    RESET:            ldi   r16,high(RAMEND); Main program start
        0xC01                      out   SPH,r16     ; Set Stack Pointer to top of RAM
        0xC02                      ldi   r16,low(RAMEND)
        0xC03                      out   SPL,r16
        0xC04                      sei               ; Enable interrupts
        0xC05                      <instr> xxx
When the BOOTRST Fuse is programmed, the Boot section size set to 2Kbytes and the IVSEL bit in the
MCUCR Register is set before any interrupts are enabled, the most typical and general program setup for the
Reset and Interrupt Vector Addresses in ATmega88A/88PA is:
        Address Labels             Code               Comments
        ;
        .org 0xC00
        0xC00                      rjmp   RESET       ;   Reset handler
        0xC01                      rjmp   EXT_INT0    ;   IRQ0 Handler
        0xC02                      rjmp   EXT_INT1    ;   IRQ1 Handler
        ...                        ...    ...         ;
        0xC19                      rjmp   SPM_RDY     ;   Store Program Memory Ready Handler
        ;
        0xC1A    RESET:            ldi   r16,high(RAMEND); Main program start
        0xC1B                      out   SPH,r16     ; Set Stack Pointer to top of RAM
        0xC1C                      ldi   r16,low(RAMEND)
        0xC1D                      out   SPL,r16
        0xC1E                      sei               ; Enable interrupts
        0xC1F                      <instr> xxx




 2020 Microchip Technology Inc.                     Data Sheet Complete                  DS40002061B-page 70
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

12.3          Interrupt Vectors in ATmega168A and ATmega168PA

Table 12-4.           Reset and Interrupt Vectors in ATmega168A and ATmega168PA
                             Program
  VectorNo.                 Address(2)             Source                          Interrupt Definition
         1                   0x0000(1)             RESET                           External Pin, Power-on Reset, Brown-out Reset and Watchdog System Reset

         2                    0x0002               INT0                            External Interrupt Request 0
         3                    0x0004               INT1                            External Interrupt Request 1
         4                    0x0006               PCINT0                          Pin Change Interrupt Request 0
         5                    0x0008               PCINT1                          Pin Change Interrupt Request 1
         6                    0x000A               PCINT2                          Pin Change Interrupt Request 2
         7                    0x000C               WDT                             Watchdog Time-out Interrupt
         8                    0x000E               TIMER2_COMPA                    Timer/Counter2 Compare Match A
         9                    0x0010               TIMER2_COMPB                    Timer/Counter2 Compare Match B
         10                   0x0012               TIMER2_OVF                      Timer/Counter2 Overflow
         11                   0x0014               TIMER1_CAPT                     Timer/Counter1 Capture Event
         12                   0x0016               TIMER1_COMPA                    Timer/Counter1 Compare Match A
         13                   0x0018               TIMER1_COMPB                    Timer/Counter1 Compare Match B
         14                   0x001A               TIMER1_OVF                      Timer/Counter1 Overflow
         15                   0x001C               TIMER0_COMPA                    Timer/Counter0 Compare Match A
         16                   0x001E               TIMER0_COMPB                    Timer/Counter0 Compare Match B
         17                   0x0020               TIMER0_OVF                      Timer/Counter0 Overflow
         18                   0x0022               SPI_STC                         SPI Serial Transfer Complete
         19                   0x0024               USART_RX                        USART Rx Complete
         20                   0x0026               USART_UDRE                      USART, Data Register Empty
         21                   0x0028               USART_TX                        USART, Tx Complete
         22                   0x002A               ADC                             ADC Conversion Complete
         23                   0x002C               EE_READY                        EEPROM Ready
         24                   0x002E               ANALOG_COMP                     Analog Comparator
         25                   0x0030               TWI                             2-wire Serial Interface
         26                   0x0032               SPM_Ready                       Store Program Memory Ready
Notes:        1.   When the BOOTRST Fuse is programmed, the device will jump to the Boot Loader address at reset, see ”Boot Loader Support – Read-While-Write Self-
                   Programming” on page 272.
              2.   When the IVSEL bit in MCUCR is set, Interrupt Vectors will be moved to the start of the Boot Flash Section. The address of each Interrupt Vector will then
                   be the address in this table added to the start address of the Boot Flash Section.



              Table 12-5 on page 72 shows reset and Interrupt Vectors placement for the various combinations of BOOTRST
              and IVSEL settings. If the program never enables an interrupt source, the Interrupt Vectors are not used, and




               2020 Microchip Technology Inc.                                          Data Sheet Complete                                        DS40002061B-page 71
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

regular program code can be placed at these locations. This is also the case if the Reset Vector is in the
Application section while the Interrupt Vectors are in the Boot section or vice versa.

Table 12-5.    Reset and Interrupt Vectors Placement in ATmega168A and ATmega168PA(1)
   BOOTRST           IVSEL         Reset Address           Interrupt Vectors Start Address
        1               0          0x000                   0x002
        1               1          0x000                   Boot Reset Address + 0x0002
        0               0          Boot Reset Address      0x002
        0               1          Boot Reset Address      Boot Reset Address + 0x0002

Note:   1.    The Boot Reset Address is shown in Table 27-7 on page 284. For the BOOTRST Fuse “1” means
              unprogrammed while “0” means programmed.
The most typical and general program setup for the Reset and Interrupt Vector Addresses in
ATmega168A/168PA is:
        Address       Labels Code                        Comments
        0x0000               jmp           RESET         ; Reset Handler
        0x0002               jmp           EXT_INT0      ; IRQ0 Handler
        0x0004               jmp           EXT_INT1      ; IRQ1 Handler
        0x0006               jmp           PCINT0        ; PCINT0 Handler
        0x0008               jmp           PCINT1        ; PCINT1 Handler
        0x000A               jmp           PCINT2        ; PCINT2 Handler
        0x000C               jmp           WDT           ; Watchdog Timer Handler
        0x000E               jmp           TIM2_COMPA    ; Timer2 Compare A Handler
        0x0010               jmp           TIM2_COMPB    ; Timer2 Compare B Handler
        0x0012               jmp           TIM2_OVF      ; Timer2 Overflow Handler
        0x0014               jmp           TIM1_CAPT     ; Timer1 Capture Handler
        0x0016               jmp           TIM1_COMPA    ; Timer1 Compare A Handler
        0x0018               jmp           TIM1_COMPB    ; Timer1 Compare B Handler
        0x001A               jmp           TIM1_OVF      ; Timer1 Overflow Handler
        0x001C               jmp           TIM0_COMPA    ; Timer0 Compare A Handler
        0x001E               jmp           TIM0_COMPB    ; Timer0 Compare B Handler
        0x0020               jmp           TIM0_OVF      ; Timer0 Overflow Handler
        0x0022               jmp           SPI_STC       ; SPI Transfer Complete Handler
        0x0024               jmp           USART_RXC     ; USART, RX Complete Handler
        0x0026               jmp           USART_UDRE    ; USART, UDR Empty Handler
        0x0028               jmp           USART_TXC     ; USART, TX Complete Handler
        0x002A               jmp           ADC           ; ADC Conversion Complete Handler
        0x002C               jmp           EE_RDY        ; EEPROM Ready Handler
        0x002E               jmp           ANA_COMP      ; Analog Comparator Handler
        0x0030               jmp           TWI           ; 2-wire Serial Interface Handler
        0x0032               jmp           SPM_RDY       ; Store Program Memory Ready Handler
        ;
        0x0034        RESET: ldi   r16, high(RAMEND); Main program start
        0x0035               out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x0036               ldi   r16, low(RAMEND)
        0x0037               out   SPL,r16
        0x0038               sei               ; Enable interrupts
        0x0039               <instr> xxx
          ...         ...    ...    ...
When the BOOTRST Fuse is unprogrammed, the Boot section size set to 2Kbytes and the IVSEL bit in the
MCUCR Register is set before any interrupts are enabled, the most typical and general program setup for the
Reset and Interrupt Vector Addresses in ATmega168A/168PA is:




 2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 72
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

        Address Labels             Code              Comments
        0x0000   RESET:            ldi   r16,high(RAMEND); Main program start
        0x0001                     out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x0002                     ldi   r16,low(RAMEND)
        0x0003                     out   SPL,r16
        0x0004                     sei               ; Enable interrupts
        0x0005                     <instr> xxx
        ;
        .org 0x1C02
        0x1C02                     jmp    EXT_INT0    ; IRQ0 Handler
        0x1C04                     jmp    EXT_INT1    ; IRQ1 Handler
        ...                        ...    ...         ;
        0x1C32                     jmp    SPM_RDY     ; Store Program Memory Ready Handler
When the BOOTRST Fuse is programmed and the Boot section size set to 2Kbytes, the most typical and
general program setup for the Reset and Interrupt Vector Addresses in ATmega168A/168PA is:


        Address Labels             Code               Comments
        .org 0x0002
        0x0002                     jmp    EXT_INT0    ; IRQ0 Handler
        0x0004                     jmp    EXT_INT1    ; IRQ1 Handler
        ...                        ...    ...         ;
        0x0032                     jmp    SPM_RDY     ; Store Program Memory Ready Handler
        ;
        .org 0x1C00
        0x1C00   RESET:            ldi   r16,high(RAMEND); Main program start
        0x1C01                     out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x1C02                     ldi   r16,low(RAMEND)
        0x1C03                     out   SPL,r16
        0x1C04                     sei                ; Enable interrupts
        0x1C05                     <instr> xxx
When the BOOTRST Fuse is programmed, the Boot section size set to 2Kbytes and the IVSEL bit in the
MCUCR Register is set before any interrupts are enabled, the most typical and general program setup for the
Reset and Interrupt Vector Addresses in ATmega168A/168PA is:
        Address Labels             Code               Comments
        ;
        .org 0x1C00
        0x1C00                     jmp    RESET       ;   Reset handler
        0x1C02                     jmp    EXT_INT0    ;   IRQ0 Handler
        0x1C04                     jmp    EXT_INT1    ;   IRQ1 Handler
        ...                        ...    ...         ;
        0x1C32                     jmp    SPM_RDY     ;   Store Program Memory Ready Handler
        ;
        0x1C3    RESET:            ldi   r16,high(RAMEND); Main program start
        0x1C35                     out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x1C36                     ldi   r16,low(RAMEND)
        0x1C37                     out   SPL,r16
        0x1C38                     sei               ; Enable interrupts
        0x1C39                     <instr> xxx




 2020 Microchip Technology Inc.                     Data Sheet Complete                  DS40002061B-page 73
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

12.4          Interrupt Vectors in ATmega328 and ATmega328P

Table 12-6.           Reset and Interrupt Vectors in ATmega328 and ATmega328P
                             Program
  VectorNo.                 Address(2)             Source                          Interrupt Definition
         1                   0x0000(1)             RESET                           External Pin, Power-on Reset, Brown-out Reset and Watchdog System Reset

         2                    0x0002               INT0                            External Interrupt Request 0
         3                    0x0004               INT1                            External Interrupt Request 1
         4                    0x0006               PCINT0                          Pin Change Interrupt Request 0
         5                    0x0008               PCINT1                          Pin Change Interrupt Request 1
         6                    0x000A               PCINT2                          Pin Change Interrupt Request 2
         7                    0x000C               WDT                             Watchdog Time-out Interrupt
         8                    0x000E               TIMER2_COMPA                    Timer/Counter2 Compare Match A
         9                    0x0010               TIMER2_COMPB                    Timer/Counter2 Compare Match B
         10                   0x0012               TIMER2_OVF                      Timer/Counter2 Overflow
         11                   0x0014               TIMER1_CAPT                     Timer/Counter1 Capture Event
         12                   0x0016               TIMER1_COMPA                    Timer/Counter1 Compare Match A
         13                   0x0018               TIMER1_COMPB                    Timer/Counter1 Compare Match B
         14                   0x001A               TIMER1_OVF                      Timer/Counter1 Overflow
         15                   0x001C               TIMER0_COMPA                    Timer/Counter0 Compare Match A
         16                   0x001E               TIMER0_COMPB                    Timer/Counter0 Compare Match B
         17                   0x0020               TIMER0_OVF                      Timer/Counter0 Overflow
         18                   0x0022               SPI_STC                         SPI Serial Transfer Complete
         19                   0x0024               USART_RX                        USART Rx Complete
         20                   0x0026               USART_UDRE                      USART, Data Register Empty
         21                   0x0028               USART_TX                        USART, Tx Complete
         22                   0x002A               ADC                             ADC Conversion Complete
         23                   0x002C               EE_READY                        EEPROM Ready
         24                   0x002E               ANALOG_COMP                     Analog Comparator
         25                   0x0030               TWI                             2-wire Serial Interface
         26                   0x0032               SPM_Ready                       Store Program Memory Ready
Notes:        1.   When the BOOTRST Fuse is programmed, the device will jump to the Boot Loader address at reset, see ”Boot Loader Support – Read-While-Write Self-
                   Programming” on page 272.
              2.   When the IVSEL bit in MCUCR is set, Interrupt Vectors will be moved to the start of the Boot Flash Section. The address of each Interrupt Vector will then
                   be the address in this table added to the start address of the Boot Flash Section.

              Table 12-7 on page 75 shows reset and Interrupt Vectors placement for the various combinations of BOOTRST
              and IVSEL settings. If the program never enables an interrupt source, the Interrupt Vectors are not used, and




               2020 Microchip Technology Inc.                                          Data Sheet Complete                                        DS40002061B-page 74
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

regular program code can be placed at these locations. This is also the case if the Reset Vector is in the
Application section while the Interrupt Vectors are in the Boot section or vice versa.

Table 12-7.    Reset and Interrupt Vectors Placement in ATmega328 and ATmega328P(1)
   BOOTRST           IVSEL         Reset Address           Interrupt Vectors Start Address
        1               0          0x000                   0x002
        1               1          0x000                   Boot Reset Address + 0x0002
        0               0          Boot Reset Address      0x002
        0               1          Boot Reset Address      Boot Reset Address + 0x0002

Note:   1.    The Boot Reset Address is shown in Table 27-7 on page 284. For the BOOTRST Fuse “1” means
              unprogrammed while “0” means programmed.
The most typical and general program setup for the Reset and Interrupt Vector Addresses in ATmega328/328P
is:
        Address       Labels Code                        Comments
        0x0000               jmp           RESET         ; Reset Handler
        0x0002               jmp           EXT_INT0      ; IRQ0 Handler
        0x0004               jmp           EXT_INT1      ; IRQ1 Handler
        0x0006               jmp           PCINT0        ; PCINT0 Handler
        0x0008               jmp           PCINT1        ; PCINT1 Handler
        0x000A               jmp           PCINT2        ; PCINT2 Handler
        0x000C               jmp           WDT           ; Watchdog Timer Handler
        0x000E               jmp           TIM2_COMPA    ; Timer2 Compare A Handler
        0x0010               jmp           TIM2_COMPB    ; Timer2 Compare B Handler
        0x0012               jmp           TIM2_OVF      ; Timer2 Overflow Handler
        0x0014               jmp           TIM1_CAPT     ; Timer1 Capture Handler
        0x0016               jmp           TIM1_COMPA    ; Timer1 Compare A Handler
        0x0018               jmp           TIM1_COMPB    ; Timer1 Compare B Handler
        0x001A               jmp           TIM1_OVF      ; Timer1 Overflow Handler
        0x001C               jmp           TIM0_COMPA    ; Timer0 Compare A Handler
        0x001E               jmp           TIM0_COMPB    ; Timer0 Compare B Handler
        0x0020               jmp           TIM0_OVF      ; Timer0 Overflow Handler
        0x0022               jmp           SPI_STC       ; SPI Transfer Complete Handler
        0x0024               jmp           USART_RXC     ; USART, RX Complete Handler
        0x0026               jmp           USART_UDRE    ; USART, UDR Empty Handler
        0x0028               jmp           USART_TXC     ; USART, TX Complete Handler
        0x002A               jmp           ADC           ; ADC Conversion Complete Handler
        0x002C               jmp           EE_RDY        ; EEPROM Ready Handler
        0x002E               jmp           ANA_COMP      ; Analog Comparator Handler
        0x0030               jmp           TWI           ; 2-wire Serial Interface Handler
        0x0032               jmp           SPM_RDY       ; Store Program Memory Ready Handler
        ;
        0x0034        RESET: ldi   r16, high(RAMEND); Main program start
        0x0035               out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x0036               ldi   r16, low(RAMEND)
        0x0037               out   SPL,r16
        0x0038               sei               ; Enable interrupts
        0x0039               <instr> xxx
          ...          ...   ...    ...
When the BOOTRST Fuse is unprogrammed, the Boot section size set to 2Kbytes and the IVSEL bit in the
MCUCR Register is set before any interrupts are enabled, the most typical and general program setup for the
Reset and Interrupt Vector Addresses in ATmega328/328P is:




 2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 75
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

        Address Labels             Code              Comments
        0x0000   RESET:            ldi   r16,high(RAMEND); Main program start
        0x0001                     out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x0002                     ldi   r16,low(RAMEND)
        0x0003                     out   SPL,r16
        0x0004                     sei               ; Enable interrupts
        0x0005                     <instr> xxx
        ;
        .org 0x3C02
        0x3C02                     jmp    EXT_INT0    ; IRQ0 Handler
        0x3C04                     jmp    EXT_INT1    ; IRQ1 Handler
        ...                        ...    ...         ;
        0x3C32                     jmp    SPM_RDY     ; Store Program Memory Ready Handler
When the BOOTRST Fuse is programmed and the Boot section size set to 2Kbytes, the most typical and
general program setup for the Reset and Interrupt Vector Addresses in ATmega328/328P is:
        Address Labels             Code               Comments
        .org 0x0002
        0x0002                     jmp    EXT_INT0    ; IRQ0 Handler
        0x0004                     jmp    EXT_INT1    ; IRQ1 Handler
        ...                        ...    ...         ;
        0x0032                     jmp    SPM_RDY     ; Store Program Memory Ready Handler
        ;
        .org 0x3C00
        0x3C00   RESET:            ldi   r16,high(RAMEND); Main program start
        0x3C01                     out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x3C02                     ldi   r16,low(RAMEND)
        0x3C03                     out   SPL,r16
        0x3C04                     sei               ; Enable interrupts
        0x3C05                     <instr> xxx
When the BOOTRST Fuse is programmed, the Boot section size set to 2Kbytes and the IVSEL bit in the
MCUCR Register is set before any interrupts are enabled, the most typical and general program setup for the
Reset and Interrupt Vector Addresses in ATmega328/328P is:
        Address Labels             Code               Comments
        ;
        .org 0x3C00
        0x3C00                     jmp    RESET       ;   Reset handler
        0x3C02                     jmp    EXT_INT0    ;   IRQ0 Handler
        0x3C04                     jmp    EXT_INT1    ;   IRQ1 Handler
        ...                        ...    ...         ;
        0x3C32                     jmp    SPM_RDY     ;   Store Program Memory Ready Handler
        ;
        0x3C34   RESET:            ldi   r16,high(RAMEND); Main program start
        0x3C35                     out   SPH,r16     ; Set Stack Pointer to top of RAM
        0x3C36                     ldi   r16,low(RAMEND)
        0x3C37                     out   SPL,r16
        0x3C38                     sei               ; Enable interrupts
        0x3C39                     <instr> xxx




 2020 Microchip Technology Inc.                     Data Sheet Complete                  DS40002061B-page 76
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

12.5   Register Description

12.5.1 Moving Interrupts Between Application and Boot Space, ATmega88A/88PA, ATmega168A/168PA and
       ATmega328/328P
       The MCU Control Register controls the placement of the Interrupt Vector table.
       MCUCR – MCU Control Register

        Bit                  7           6            5           4             3            2       1           0
                                             (1)           (1)
        0x35 (0x55)          –       BODS          BODSE         PUD            –            –    IVSEL        IVCE        MCUCR
        Read/Write           R         R/W           R/W         R/W            R            R      R/W         R/W
        Initial Value        0           0            0           0             0            0       0           0

       Note:       1. BODS and BODSE only available for picoPower devices ATmega48PA/88PA/168PA/328P

       • Bit 1 – IVSEL: Interrupt Vector Select
       When the IVSEL bit is cleared (zero), the Interrupt Vectors are placed at the start of the Flash memory. When
       this bit is set (one), the Interrupt Vectors are moved to the beginning of the Boot Loader section of the Flash.
       The actual address of the start of the Boot Flash Section is determined by the BOOTSZ Fuses. Refer to the
       section ”Boot Loader Support – Read-While-Write Self-Programming” on page 272 for details. To avoid
       unintentional changes of Interrupt Vector tables, a special write procedure must be followed to change the
       IVSEL bit:
        1.     Write the Interrupt Vector Change Enable (IVCE) bit to one.
        2.     Within four cycles, write the desired value to IVSEL while writing a zero to IVCE.
       Interrupts will automatically be disabled while this sequence is executed. Interrupts are disabled in the cycle
       IVCE is set, and they remain disabled until after the instruction following the write to IVSEL. If IVSEL is not
       written, interrupts remain disabled for four cycles. The I-bit in the Status Register is unaffected by the automatic
       disabling.
       Note:       If Interrupt Vectors are placed in the Boot Loader section and Boot Lock bit BLB02 is programmed, interrupts are
                   disabled while executing from the Application section. If Interrupt Vectors are placed in the Application section and
                   Boot Lock bit BLB12 is programed, interrupts are disabled while executing from the Boot Loader section. Refer to
                   the section ”Boot Loader Support – Read-While-Write Self-Programming” on page 272 for details on Boot Lock bits.
       • Bit 0 – IVCE: Interrupt Vector Change Enable
       The IVCE bit must be written to logic one to enable change of the IVSEL bit. IVCE is cleared by hardware four
       cycles after it is written or when IVSEL is written. Setting the IVCE bit will disable interrupts, as explained in the
       IVSEL description above. See Code Example below.




        2020 Microchip Technology Inc.                                Data Sheet Complete                           DS40002061B-page 77
                                   ATmega48A/PA/88A/PA/168A/PA/328/P


 Assembly Code Example
          Move_interrupts:
                ; Enable change of Interrupt Vectors
                ldi        r16, (1<<IVCE)
                out        MCUCR, r16
                ; Move interrupts to Boot Flash section
                ldi        r16, (1<<IVSEL)
                out        MCUCR, r16
                ret
 C Code Example
          void Move_interrupts(void)
          {
                /* Enable change of Interrupt Vectors */
                MCUCR = (1<<IVCE);
                /* Move interrupts to Boot Flash section */
                MCUCR = (1<<IVSEL);
          }




 2020 Microchip Technology Inc.          Data Sheet Complete   DS40002061B-page 78
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P


13.    External Interrupts
       The External Interrupts are triggered by the INT0 and INT1 pins or any of the PCINT23...0 pins. Observe that, if
       enabled, the interrupts will trigger even if the INT0 and INT1 or PCINT23...0 pins are configured as outputs. This
       feature provides a way of generating a software interrupt. The pin change interrupt PCI2 will trigger if any
       enabled PCINT[23:16] pin toggles. The pin change interrupt PCI1 will trigger if any enabled PCINT[14:8] pin
       toggles. The pin change interrupt PCI0 will trigger if any enabled PCINT[7:0] pin toggles. The PCMSK2,
       PCMSK1 and PCMSK0 Registers control which pins contribute to the pin change interrupts. Pin change
       interrupts on PCINT23...0 are detected asynchronously. This implies that these interrupts can be used for
       waking the part also from sleep modes other than Idle mode.
       The External Interrupts can be triggered by a falling or rising edge or a low level. This is set up as indicated in
       the specification for the External Interrupt Control Registers – EICRA (INT2:0). When the external interrupt is
       enabled and is configured as level triggered, the interrupt will trigger as long as the pin is held low. Low level
       interrupts and the edge interrupt on INT2:0 are detected asynchronously. This implies that these interrupts can
       be used for waking the part also from sleep modes other than Idle mode. The I/O clock is halted in all sleep
       modes except Idle mode.
       Note:   Note that if a level triggered interrupt is used for wake-up from Power-down, the required level must be held long
               enough for the MCU to complete the wake-up to trigger the level interrupt. If the level disappears before the end of
               the Start-up Time, the MCU will still wake up, but no interrupt will be generated. The start-up time is defined by the
               SUT and CKSEL Fuses as described in ”System Clock and Clock Options” on page 36.

13.1   Pin Change Interrupt Timing
       An example of timing of a pin change interrupt is shown in Figure 13-1.

       Figure 13-1.   Timing of pin change interrupts
                                                pin_lat                                pcint_in_(0)
                                PCINT(0)                  D   Q                                       0         pcint_syn   pcint_setflag
                                           LE
                                                                  pin_sync                                                                  PCIF
                                                                                                      x
                                     clk
                                                                       PCINT(0) in PCMSK(x)
                                                                                                          clk




                                    clk



                             PCINT(0)



                                pin_lat



                             pin_sync



                          pcint_in_(0)



                             pcint_syn



                          pcint_setflag



                                 PCIF




        2020 Microchip Technology Inc.                                                               Data Sheet Complete                          DS40002061B-page 79
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

13.2   Register Description

13.2.1 EICRA – External Interrupt Control Register A
       The External Interrupt Control Register A contains control bits for interrupt sense control.
        Bit                7         6        5         4         3         2           1         0
        (0x69)             –         –        –         –       ISC11     ISC10       ISC01    ISC00   EICRA
        Read/Write         R         R        R         R        R/W       R/W         R/W       R/W
        Initial Value      0         0        0         0         0         0           0         0


       • Bit 7:4 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 3, 2 – ISC11, ISC10: Interrupt Sense Control 1 Bit 1 and Bit 0
       The External Interrupt 1 is activated by the external pin INT1 if the SREG I-flag and the corresponding interrupt
       mask are set. The level and edges on the external INT1 pin that activate the interrupt are defined in Table 13-1.
       The value on the INT1 pin is sampled before detecting edges. If edge or toggle interrupt is selected, pulses that
       last longer than one clock period will generate an interrupt. Shorter pulses are not ensured to generate an
       interrupt. If low level interrupt is selected, the low level must be held until the completion of the currently
       executing instruction to generate an interrupt.

       Table 13-1.      Interrupt 1 Sense Control
              ISC11      ISC10      Description
               0           0        The low level of INT1 generates an interrupt request.
               0           1        Any logical change on INT1 generates an interrupt request.
               1           0        The falling edge of INT1 generates an interrupt request.
               1           1        The rising edge of INT1 generates an interrupt request.

       • Bit 1, 0 – ISC01, ISC00: Interrupt Sense Control 0 Bit 1 and Bit 0
       The External Interrupt 0 is activated by the external pin INT0 if the SREG I-flag and the corresponding interrupt
       mask are set. The level and edges on the external INT0 pin that activate the interrupt are defined in Table 13-2.
       The value on the INT0 pin is sampled before detecting edges. If edge or toggle interrupt is selected, pulses that
       last longer than one clock period will generate an interrupt. Shorter pulses are not ensured to generate an
       interrupt. If low level interrupt is selected, the low level must be held until the completion of the currently
       executing instruction to generate an interrupt.

       Table 13-2.      Interrupt 0 Sense Control
              ISC01      ISC00      Description
               0           0        The low level of INT0 generates an interrupt request.
               0           1        Any logical change on INT0 generates an interrupt request.
               1           0        The falling edge of INT0 generates an interrupt request.
               1           1        The rising edge of INT0 generates an interrupt request.




        2020 Microchip Technology Inc.                         Data Sheet Complete                       DS40002061B-page 80
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


13.2.2 EIMSK – External Interrupt Mask Register
        Bit                7         6       5       4         3         2           1       0
        0x1D (0x3D)       –          –       –       –         –         –         INT1    INT0    EIMSK
        Read/Write        R          R       R       R         R         R          R/W     R/W
        Initial Value      0         0       0       0         0         0           0       0


       • Bit 7:2 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 1 – INT1: External Interrupt Request 1 Enable
       When the INT1 bit is set (one) and the I-bit in the Status Register (SREG) is set (one), the external pin interrupt
       is enabled. The Interrupt Sense Control1 bits 1/0 (ISC11 and ISC10) in the External Interrupt Control Register A
       (EICRA) define whether the external interrupt is activated on rising and/or falling edge of the INT1 pin or level
       sensed. Activity on the pin will cause an interrupt request even if INT1 is configured as an output. The
       corresponding interrupt of External Interrupt Request 1 is executed from the INT1 Interrupt Vector.

       • Bit 0 – INT0: External Interrupt Request 0 Enable
       When the INT0 bit is set (one) and the I-bit in the Status Register (SREG) is set (one), the external pin interrupt
       is enabled. The Interrupt Sense Control0 bits 1/0 (ISC01 and ISC00) in the External Interrupt Control Register A
       (EICRA) define whether the external interrupt is activated on rising and/or falling edge of the INT0 pin or level
       sensed. Activity on the pin will cause an interrupt request even if INT0 is configured as an output. The
       corresponding interrupt of External Interrupt Request 0 is executed from the INT0 Interrupt Vector.

13.2.3 EIFR – External Interrupt Flag Register
        Bit                7         6       5       4         3         2           1       0
        0x1C (0x3C)       –          –       –       –         –         –         INTF1   INTF0   EIFR
        Read/Write        R          R       R       R         R         R          R/W     R/W
        Initial Value      0         0       0       0         0         0           0       0


       • Bit 7:2 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 1 – INTF1: External Interrupt Flag 1
       When an edge or logic change on the INT1 pin triggers an interrupt request, INTF1 becomes set (one). If the I-
       bit in SREG and the INT1 bit in EIMSK are set (one), the MCU will jump to the corresponding Interrupt Vector.
       The flag is cleared when the interrupt routine is executed. Alternatively, the flag can be cleared by writing a
       logical one to it. This flag is always cleared when INT1 is configured as a level interrupt.

       • Bit 0 – INTF0: External Interrupt Flag 0
       When an edge or logic change on the INT0 pin triggers an interrupt request, INTF0 becomes set (one). If the I-
       bit in SREG and the INT0 bit in EIMSK are set (one), the MCU will jump to the corresponding Interrupt Vector.
       The flag is cleared when the interrupt routine is executed. Alternatively, the flag can be cleared by writing a
       logical one to it. This flag is always cleared when INT0 is configured as a level interrupt.




        2020 Microchip Technology Inc.                      Data Sheet Complete                      DS40002061B-page 81
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

13.2.4 PCICR – Pin Change Interrupt Control Register
        Bit                7         6      5        4         3        2           1       0
        (0x68)            –          –      –        –        –      PCIE2        PCIE1   PCIE0   PCICR
        Read/Write        R          R      R        R        R        R/W         R/W     R/W
        Initial Value      0         0      0        0         0        0           0       0


       • Bit 7:3 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 2 – PCIE2: Pin Change Interrupt Enable 2
       When the PCIE2 bit is set (one) and the I-bit in the Status Register (SREG) is set (one), pin change interrupt 2 is
       enabled. Any change on any enabled PCINT[23:16] pin will cause an interrupt. The corresponding interrupt of
       Pin Change Interrupt Request is executed from the PCI2 Interrupt Vector. PCINT[23:16] pins are enabled
       individually by the PCMSK2 Register.

       • Bit 1 – PCIE1: Pin Change Interrupt Enable 1
       When the PCIE1 bit is set (one) and the I-bit in the Status Register (SREG) is set (one), pin change interrupt 1 is
       enabled. Any change on any enabled PCINT[14:8] pin will cause an interrupt. The corresponding interrupt of Pin
       Change Interrupt Request is executed from the PCI1 Interrupt Vector. PCINT[14:8] pins are enabled individually
       by the PCMSK1 Register.

       • Bit 0 – PCIE0: Pin Change Interrupt Enable 0
       When the PCIE0 bit is set (one) and the I-bit in the Status Register (SREG) is set (one), pin change interrupt 0 is
       enabled. Any change on any enabled PCINT[7:0] pin will cause an interrupt. The corresponding interrupt of Pin
       Change Interrupt Request is executed from the PCI0 Interrupt Vector. PCINT[7:0] pins are enabled individually
       by the PCMSK0 Register.

13.2.5 PCIFR – Pin Change Interrupt Flag Register
        Bit                7         6      5        4         3        2           1       0
        0x1B (0x3B)       –          –      –        –        –      PCIF2        PCIF1   PCIF0   PCIFR
        Read/Write        R          R      R        R        R        R/W         R/W     R/W
        Initial Value      0         0      0        0         0        0           0       0


       • Bit 7:3 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 2 – PCIF2: Pin Change Interrupt Flag 2
       When a logic change on any PCINT[23:16] pin triggers an interrupt request, PCIF2 becomes set (one). If the I-
       bit in SREG and the PCIE2 bit in PCICR are set (one), the MCU will jump to the corresponding Interrupt Vector.
       The flag is cleared when the interrupt routine is executed. Alternatively, the flag can be cleared by writing a
       logical one to it.

       • Bit 1 – PCIF1: Pin Change Interrupt Flag 1
       When a logic change on any PCINT[14:8] pin triggers an interrupt request, PCIF1 becomes set (one). If the I-bit
       in SREG and the PCIE1 bit in PCICR are set (one), the MCU will jump to the corresponding Interrupt Vector.
       The flag is cleared when the interrupt routine is executed. Alternatively, the flag can be cleared by writing a
       logical one to it.




        2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 82
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P


      • Bit 0 – PCIF0: Pin Change Interrupt Flag 0
      When a logic change on any PCINT[7:0] pin triggers an interrupt request, PCIF0 becomes set (one). If the I-bit
      in SREG and the PCIE0 bit in PCICR are set (one), the MCU will jump to the corresponding Interrupt Vector.
      The flag is cleared when the interrupt routine is executed. Alternatively, the flag can be cleared by writing a
      logical one to it.

13.2.6 PCMSK2 – Pin Change Mask Register 2
       Bit                  7             6         5            4               3             2             1             0
       (0x6D)          PCINT23      PCINT22    PCINT21      PCINT20       PCINT19        PCINT18       PCINT17       PCINT16       PCMSK2
       Read/Write        R/W             R/W       R/W          R/W             R/W          R/W           R/W           R/W
       Initial Value        0             0         0            0               0             0             0             0


      • Bit 7:0 – PCINT[23:16]: Pin Change Enable Mask 23...16
      Each PCINT[23:16]-bit selects whether pin change interrupt is enabled on the corresponding I/O pin. If
      PCINT[23:16] is set and the PCIE2 bit in PCICR is set, pin change interrupt is enabled on the corresponding I/O
      pin. If PCINT[23:16] is cleared, pin change interrupt on the corresponding I/O pin is disabled.

13.2.7 PCMSK1 – Pin Change Mask Register 1
       Bit                      7         6             5            4               3             2             1             0
       (0x6C)               –       PCINT14    PCINT13       PCINT12           PCINT11       PCINT10       PCINT9        PCINT8     PCMSK1
       Read/Write           R            R/W       R/W            R/W            R/W           R/W           R/W           R/W
       Initial Value            0         0             0            0               0             0             0             0


      • Bit 7 – Reserved
      This bit is an unused bit in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

      • Bit 6:0 – PCINT[14:8]: Pin Change Enable Mask 14...8
      Each PCINT[14:8]-bit selects whether pin change interrupt is enabled on the corresponding I/O pin. If
      PCINT[14:8] is set and the PCIE1 bit in PCICR is set, pin change interrupt is enabled on the corresponding I/O
      pin. If PCINT[14:8] is cleared, pin change interrupt on the corresponding I/O pin is disabled.

13.2.8 PCMSK0 – Pin Change Mask Register 0
       Bit              7            6         5            4              3             2             1             0
       (0x6B)           PCINT7       PCINT6    PCINT5       PCINT4         PCINT3        PCINT2        PCINT1        PCINT0        PCMSK0
       Read/Write       R/W          R/W       R/W          R/W            R/W           R/W           R/W           R/W
       Initial Value    0            0         0            0              0             0             0             0


      • Bit 7:0 – PCINT[7:0]: Pin Change Enable Mask 7...0
      Each PCINT[7:0] bit selects whether pin change interrupt is enabled on the corresponding I/O pin. If PCINT[7:0]
      is set and the PCIE0 bit in PCICR is set, pin change interrupt is enabled on the corresponding I/O pin. If
      PCINT[7:0] is cleared, pin change interrupt on the corresponding I/O pin is disabled.




        2020 Microchip Technology Inc.                              Data Sheet Complete                                 DS40002061B-page 83
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


14.    I/O-Ports

14.1   Overview
       All AVR ports have true Read-Modify-Write functionality when used as general digital I/O ports. This means that
       the direction of one port pin can be changed without unintentionally changing the direction of any other pin with
       the SBI and CBI instructions. The same applies when changing drive value (if configured as output) or
       enabling/disabling of pull-up resistors (if configured as input). Each output buffer has symmetrical drive
       characteristics with both high sink and source capability. The pin driver is strong enough to drive LED displays
       directly. All port pins have individually selectable pull-up resistors with a supply-voltage invariant resistance. All
       I/O pins have protection diodes to both VCC and Ground as indicated in Figure 14-1. Refer to ”Electrical
       Characteristics – (TA = -40°C to 85°C)” on page 308 for a complete list of parameters.

       Figure 14-1.   I/O Pin Equivalent Schematic




                                                                                     Rpu

                                Pxn                                                         Logic

                                                   Cpin
                                                                                   See Figure
                                                                              "General Digital I/O" for
                                                                                     Details


       All registers and bit references in this section are written in general form. A lower case “x” represents the
       numbering letter for the port, and a lower case “n” represents the bit number. However, when using the register
       or bit defines in a program, the precise form must be used. For example, PORTB3 for bit no. 3 in Port B, here
       documented generally as PORTxn. The physical I/O Registers and bit locations are listed in ”Register
       Description” on page 100.
       Three I/O memory address locations are allocated for each port, one each for the Data Register – PORTx, Data
       Direction Register – DDRx, and the Port Input Pins – PINx. The Port Input Pins I/O location is read only, while
       the Data Register and the Data Direction Register are read/write. However, writing a logic one to a bit in the
       PINx Register, will result in a toggle in the corresponding bit in the Data Register. In addition, the Pull-up Disable
       – PUD bit in MCUCR disables the pull-up function for all pins in all ports when set.
       Using the I/O port as General Digital I/O is described in ”Ports as General Digital I/O” on page 85. Most port pins
       are multiplexed with alternate functions for the peripheral features on the device. How each alternate function
       interferes with the port pin is described in ”Alternate Port Functions” on page 89. Refer to the individual module
       sections for a full description of the alternate functions.
       Note that enabling the alternate function of some of the port pins does not affect the use of the other pins in the
       port as general digital I/O.




        2020 Microchip Technology Inc.                       Data Sheet Complete                         DS40002061B-page 84
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

14.2   Ports as General Digital I/O
       The ports are bi-directional I/O ports with optional internal pull-ups. Figure 14-2 shows a functional description of
       one I/O-port pin, here generically called Pxn.

       Figure 14-2.   General Digital I/O(1)



                                                                                                          PUD


                                                                                        Q       D
                                                                                         DDxn

                                                                                        Q CLR

                                                                                                          WDx
                                                                                        RESET
                                                                                                          RDx




                                                                                                                           DATA BUS
                                                                                                             1
                        Pxn                                                             Q       D
                                                                                        PORTxn               0
                                                                                        Q CLR


                                                                                        RESET
                                                                                                                    WPx
                                                                                                              WRx
                                                               SLEEP                                RRx


                                                                       SYNCHRONIZER
                                                                                                          RPx
                                                                        D   Q   D   Q
                                                                                PINxn

                                                                        L   Q       Q



                                                                                                          clk I/O



                                                                        WDx:    WRITE DDRx
                                    PUD:      PULLUP DISABLE            RDx:    READ DDRx
                                    SLEEP:    SLEEP CONTROL             WRx:    WRITE PORTx
                                    clkI/O:   I/O CLOCK                 RRx:    READ PORTx REGISTER
                                                                        RPx:    READ PORTx PIN
                                                                        WPx:    WRITE PINx REGISTER


       Note:   1. WRx, WPx, WDx, RRx, RPx, and RDx are common to all pins within the same port. clkI/O, SLEEP, and PUD are
                  common to all ports.

14.2.1 Configuring the Pin
       Each port pin consists of three register bits: DDxn, PORTxn, and PINxn. As shown in ”Register Description” on
       page 100, the DDxn bits are accessed at the DDRx I/O address, the PORTxn bits at the PORTx I/O address,
       and the PINxn bits at the PINx I/O address.
       The DDxn bit in the DDRx Register selects the direction of this pin. If DDxn is written logic one, Pxn is
       configured as an output pin. If DDxn is written logic zero, Pxn is configured as an input pin.
       If PORTxn is written logic one when the pin is configured as an input pin, the pull-up resistor is activated. To
       switch the pull-up resistor off, PORTxn has to be written logic zero or the pin has to be configured as an output
       pin. The port pins are tri-stated when reset condition becomes active, even if no clocks are running.
       If PORTxn is written logic one when the pin is configured as an output pin, the port pin is driven high (one). If
       PORTxn is written logic zero when the pin is configured as an output pin, the port pin is driven low (zero).

14.2.2 Toggling the Pin
       Writing a logic one to PINxn toggles the value of PORTxn, independent on the value of DDRxn. Note that the
       SBI instruction can be used to toggle one single bit in a port.




        2020 Microchip Technology Inc.                           Data Sheet Complete                                     DS40002061B-page 85
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

14.2.3 Switching Between Input and Output
       When switching between tri-state ({DDxn, PORTxn} = 0b00) and output high ({DDxn, PORTxn} = 0b11), an
       intermediate state with either pull-up enabled {DDxn, PORTxn} = 0b01) or output low ({DDxn, PORTxn} = 0b10)
       must occur. Normally, the pull-up enabled state is fully acceptable, as a high-impedance environment will not
       notice the difference between a strong high driver and a pull-up. If this is not the case, the PUD bit in the
       MCUCR Register can be set to disable all pull-ups in all ports.
       Switching between input with pull-up and output low generates the same problem. The user must use either the
       tri-state ({DDxn, PORTxn} = 0b00) or the output high state ({DDxn, PORTxn} = 0b11) as an intermediate step.
       Table 14-1 summarizes the control signals for the pin value.

       Table 14-1.     Port Pin Configurations
                                     PUD
        DDxn         PORTxn      (in MCUCR)       I/O         Pull-up        Comment
           0           0              X          Input          No           Tri-state (Hi-Z)
           0           1                  0      Input         Yes           Pxn will source current if ext. pulled low.
           0           1                  1      Input          No           Tri-state (Hi-Z)
           1           0              X          Output         No           Output Low (Sink)
           1           1              X          Output         No           Output High (Source)


14.2.4 Reading the Pin Value
       Independent of the setting of Data Direction bit DDxn, the port pin can be read through the PINxn Register bit.
       As shown in Figure 14-2, the PINxn Register bit and the preceding latch constitute a synchronizer. This is
       needed to avoid metastability if the physical pin changes value near the edge of the internal clock, but it also
       introduces a delay. Figure 14-3 shows a timing diagram of the synchronization when reading an externally
       applied pin value. The maximum and minimum propagation delays are denoted tpd,max and tpd,min respectively.

       Figure 14-3.    Synchronization when Reading an Externally Applied Pin value



                           SYSTEM CLK

                       INSTRUCTIONS                     XXX                      XXX               in r17, PINx


                           SYNC LATCH

                                   PINxn

                                      r17                                  0x00                                    0xFF

                                                                     t pd, max

                                                                                       t pd, min




       Consider the clock period starting shortly after the first falling edge of the system clock. The latch is closed when
       the clock is low, and goes transparent when the clock is high, as indicated by the shaded region of the “SYNC
       LATCH” signal. The signal value is latched when the system clock goes low. It is clocked into the PINxn
       Register at the succeeding positive clock edge. As indicated by the two arrows tpd,max and tpd,min, a single




        2020 Microchip Technology Inc.                           Data Sheet Complete                                 DS40002061B-page 86
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

signal transition on the pin will be delayed between ½ and 1½ system clock period depending upon the time of
assertion.
When reading back a software assigned pin value, a nop instruction must be inserted as indicated in Figure 14-
4. The out instruction sets the “SYNC LATCH” signal at the positive edge of the clock. In this case, the delay tpd
through the synchronizer is 1 system clock period.

Figure 14-4.   Synchronization when Reading a Software Assigned Pin Value



                  SYSTEM CLK

                               r16                                      0xFF


               INSTRUCTIONS             out PORTx, r16           nop           in r17, PINx


                  SYNC LATCH

                            PINxn

                               r17                            0x00                            0xFF

                                                                 t pd




The following code example shows how to set port B pins 0 and 1 high, 2 and 3 low, and define the port pins
from 4 to 7 as input with pull-ups assigned to port pins 6 and 7. The resulting pin values are read back again, but
as previously discussed, a nop instruction is included to be able to read back the value recently assigned to
some of the pins.




 2020 Microchip Technology Inc.                         Data Sheet Complete                    DS40002061B-page 87
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

        Assembly Code Example(1)
                       ...
                       ; Define pull-ups and set outputs high
                       ; Define directions for port pins
                       ldi              r16,(1<<PB7)|(1<<PB6)|(1<<PB1)|(1<<PB0)
                       ldi
                 r17,(1<<DDB3)|(1<<DDB2)|(1<<DDB1)|(1<<DDB0)
                       out              PORTB,r16
                       out              DDRB,r17
                       ; Insert nop for synchronization
                       nop
                       ; Read port pins
                       in               r16,PINB
                       ...
        C Code Example
                 unsigned char i;
                       ...
                       /* Define pull-ups and set outputs high */
                       /* Define directions for port pins */
                       PORTB = (1<<PB7)|(1<<PB6)|(1<<PB1)|(1<<PB0);
                       DDRB = (1<<DDB3)|(1<<DDB2)|(1<<DDB1)|(1<<DDB0);
                       /* Insert nop for synchronization*/
                       __no_operation();
                       /* Read port pins */
                       i = PINB;
                       ...
       Note:   1.   For the assembly program, two temporary registers are used to minimize the time from pull-ups are set on pins
                    0, 1, 6, and 7, until the direction bits are correctly set, defining bit 2 and 3 as low and redefining bits 0 and 1 as
                    strong high drivers.

14.2.5 Digital Input Enable and Sleep Modes
       As shown in Figure 14-2, the digital input signal can be clamped to ground at the input of the Schmitt Trigger.
       The signal denoted SLEEP in the figure, is set by the MCU Sleep Controller in Power-down mode, Power-save
       mode, and Standby mode to avoid high power consumption if some input signals are left floating, or have an
       analog signal level close to VCC/2.
       SLEEP is overridden for port pins enabled as external interrupt pins. If the external interrupt request is not
       enabled, SLEEP is active also for these pins. SLEEP is also overridden by various other alternate functions as
       described in ”Alternate Port Functions” on page 89.
       If a logic high level (“one”) is present on an asynchronous external interrupt pin configured as “Interrupt on
       Rising Edge, Falling Edge, or Any Logic Change on Pin” while the external interrupt is not enabled, the
       corresponding External Interrupt Flag will be set when resuming from the above mentioned Sleep mode, as the
       clamping in these sleep mode produces the requested logic change.

14.2.6 Unconnected Pins
       If some pins are unused, it is recommended to ensure that these pins have a defined level. Even though most of
       the digital inputs are disabled in the deep sleep modes as described above, floating inputs should be avoided to
       reduce current consumption in all other modes where the digital inputs are enabled (Reset, Active mode and
       Idle mode).




        2020 Microchip Technology Inc.                            Data Sheet Complete                             DS40002061B-page 88
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

       The simplest method to ensure a defined level of an unused pin, is to enable the internal pull-up. In this case,
       the pull-up will be disabled during reset. If low power consumption during reset is important, it is recommended
       to use an external pull-up or pull-down. Connecting unused pins directly to VCC or GND is not recommended,
       since this may cause excessive currents if the pin is accidentally configured as an output.

14.3   Alternate Port Functions
       Most port pins have alternate functions in addition to being general digital I/Os. Figure 14-5 shows how the port
       pin control signals from the simplified Figure 14-2 on page 85 can be overridden by alternate functions. The
       overriding signals may not be present in all port pins, but the figure serves as a generic description applicable to
       all port pins in the AVR microcontroller family.

       Figure 14-5.   Alternate Port Functions(1)
                                                                      PUOExn

                                                                      PUOVxn
                                                           1

                                                           0
                                                                                                                                PUD



                                                                      DDOExn

                                                                      DDOVxn
                                                           1

                                                           0                                                    Q D
                                                                                                                DDxn

                                                                                                                Q CLR

                                                                                                                                WDx
                                                                      PVOExn                                    RESET
                                                                                                                                RDx
                                                                      PVOVxn




                                                                                                                                                               DATA BUS
                                                           1                                                                1
                       Pxn
                                                           0                                                    Q       D   0
                                                                                                                PORTxn
                                                                                                                                              PTOExn
                                                                                                                Q CLR
                                                                      DIEOExn

                                                                                                                                                       WPx
                                                                      DIEOVxn                                   RESET
                                                           1                                                                            WRx
                                                                                                                                RRx
                                                           0          SLEEP

                                                                                  SYNCHRONIZER
                                                                                                                                RPx
                                                                                        SET
                                                                                    D         Q   D         Q
                                                                                                  PINxn

                                                                                    L   CLR   Q       CLR   Q



                                                                                                                            clk I/O



                                                                                                                                DIxn



                                                                                                                                AIOxn



                       PUOExn:    Pxn PULL-UP OVERRIDE ENABLE                     PUD:            PULLUP DISABLE
                       PUOVxn:    Pxn PULL-UP OVERRIDE VALUE                      WDx:            WRITE DDRx
                       DDOExn:    Pxn DATA DIRECTION OVERRIDE ENABLE              RDx:            READ DDRx
                       DDOVxn:    Pxn DATA DIRECTION OVERRIDE VALUE               RRx:            READ PORTx REGISTER
                       PVOExn:    Pxn PORT VALUE OVERRIDE ENABLE                  WRx:            WRITE PORTx
                       PVOVxn:    Pxn PORT VALUE OVERRIDE VALUE                   RPx:            READ PORTx PIN
                       DIEOExn:   Pxn DIGITAL INPUT-ENABLE OVERRIDE ENABLE        WPx:            WRITE PINx
                       DIEOVxn:   Pxn DIGITAL INPUT-ENABLE OVERRIDE VALUE         clkI/O:         I/O CLOCK
                       SLEEP:     SLEEP CONTROL                                   DIxn:           DIGITAL INPUT PIN n ON PORTx
                       PTOExn:    Pxn, PORT TOGGLE OVERRIDE ENABLE                AIOxn:          ANALOG INPUT/OUTPUT PIN n ON PORTx



       Note:   1. WRx, WPx, WDx, RRx, RPx, and RDx are common to all pins within the same port. clkI/O, SLEEP, and PUD are
                  common to all ports. All other signals are unique for each pin.




        2020 Microchip Technology Inc.                                         Data Sheet Complete                                                          DS40002061B-page 89
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Table 14-2 summarizes the function of the overriding signals. The pin and port indexes from Figure 14-5 on
page 89 are not shown in the succeeding tables. The overriding signals are generated internally in the modules
having the alternate function.

Table 14-2.    Generic Description of Overriding Signals for Alternate Functions
 Signal Name        Full Name          Description
                                       If this signal is set, the pull-up enable is controlled by the PUOV
                    Pull-up Override
 PUOE                                  signal. If this signal is cleared, the pull-up is enabled when
                    Enable
                                       {DDxn, PORTxn, PUD} = 0b010.
                                       If PUOE is set, the pull-up is enabled/disabled when PUOV is
                    Pull-up Override
 PUOV                                  set/cleared, regardless of the setting of the DDxn, PORTxn,
                    Value
                                       and PUD Register bits.
                                       If this signal is set, the Output Driver Enable is controlled by the
                    Data Direction
 DDOE                                  DDOV signal. If this signal is cleared, the Output driver is
                    Override Enable
                                       enabled by the DDxn Register bit.
                                       If DDOE is set, the Output Driver is enabled/disabled when
                    Data Direction
 DDOV                                  DDOV is set/cleared, regardless of the setting of the DDxn
                    Override Value
                                       Register bit.
                                       If this signal is set and the Output Driver is enabled, the port
                    Port Value         value is controlled by the PVOV signal. If PVOE is cleared, and
 PVOE
                    Override Enable    the Output Driver is enabled, the port Value is controlled by the
                                       PORTxn Register bit.
                    Port Value         If PVOE is set, the port value is set to PVOV, regardless of the
 PVOV
                    Override Value     setting of the PORTxn Register bit.
                    Port Toggle
 PTOE                                  If PTOE is set, the PORTxn Register bit is inverted.
                    Override Enable
                    Digital Input      If this bit is set, the Digital Input Enable is controlled by the
 DIEOE              Enable Override    DIEOV signal. If this signal is cleared, the Digital Input Enable
                    Enable             is determined by MCU state (Normal mode, sleep mode).
                    Digital Input      If DIEOE is set, the Digital Input is enabled/disabled when
 DIEOV              Enable Override    DIEOV is set/cleared, regardless of the MCU state (Normal
                    Value              mode, sleep mode).
                                       This is the Digital Input to alternate functions. In the figure, the
                                       signal is connected to the output of the Schmitt Trigger but
 DI                 Digital Input      before the synchronizer. Unless the Digital Input is used as a
                                       clock source, the module with the alternate function will use its
                                       own synchronizer.
                                       This is the Analog Input/output to/from alternate functions. The
                    Analog
 AIO                                   signal is connected directly to the pad, and can be used bi-
                    Input/Output
                                       directionally.

The following subsections shortly describe the alternate functions for each port, and relate the overriding signals
to the alternate function. Refer to the alternate function description for further details.




 2020 Microchip Technology Inc.                       Data Sheet Complete                               DS40002061B-page 90
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


14.3.1 Alternate Functions of Port B
       The Port B pins with alternate functions are shown in Table 14-3.

       Table 14-3.    Port B Pins Alternate Functions
          Port Pin      Alternate Functions
                        XTAL2 (Chip Clock Oscillator pin 2)
            PB7         TOSC2 (Timer Oscillator pin 2)
                        PCINT7 (Pin Change Interrupt 7)
                        XTAL1 (Chip Clock Oscillator pin 1 or External clock input)
            PB6         TOSC1 (Timer Oscillator pin 1)
                        PCINT6 (Pin Change Interrupt 6)
                        SCK (SPI Bus Master clock Input)
            PB5
                        PCINT5 (Pin Change Interrupt 5)
                        MISO (SPI Bus Master Input/Slave Output)
            PB4
                        PCINT4 (Pin Change Interrupt 4)
                        MOSI (SPI Bus Master Output/Slave Input)
            PB3         OC2A (Timer/Counter2 Output Compare Match A Output)
                        PCINT3 (Pin Change Interrupt 3)
                        SS (SPI Bus Master Slave select)
            PB2         OC1B (Timer/Counter1 Output Compare Match B Output)
                        PCINT2 (Pin Change Interrupt 2)
                        OC1A (Timer/Counter1 Output Compare Match A Output)
            PB1
                        PCINT1 (Pin Change Interrupt 1)
                        ICP1 (Timer/Counter1 Input Capture Input)
            PB0         CLKO (Divided System Clock Output)
                        PCINT0 (Pin Change Interrupt 0)

       The alternate pin configuration is as follows:

       • XTAL2/TOSC2/PCINT7 – Port B, Bit 7
       XTAL2: Chip clock Oscillator pin 2. Used as clock pin for crystal Oscillator or Low-frequency crystal Oscillator.
       When used as a clock pin, the pin can not be used as an I/O pin.
       TOSC2: Timer Oscillator pin 2. Used only if internal calibrated RC Oscillator is selected as chip clock source,
       and the asynchronous timer is enabled by the correct setting in ASSR. When the AS2 bit in ASSR is set (one)
       and the EXCLK bit is cleared (zero) to enable asynchronous clocking of Timer/Counter2 using the Crystal
       Oscillator, pin PB7 is disconnected from the port, and becomes the inverting output of the Oscillator amplifier. In
       this mode, a crystal Oscillator is connected to this pin, and the pin cannot be used as an I/O pin.
       PCINT7: Pin Change Interrupt source 7. The PB7 pin can serve as an external interrupt source.
       If PB7 is used as a clock pin, DDB7, PORTB7 and PINB7 will all read 0.

       • XTAL1/TOSC1/PCINT6 – Port B, Bit 6
       XTAL1: Chip clock Oscillator pin 1. Used for all chip clock sources except internal calibrated RC Oscillator.
       When used as a clock pin, the pin can not be used as an I/O pin.
       TOSC1: Timer Oscillator pin 1. Used only if internal calibrated RC Oscillator is selected as chip clock source,
       and the asynchronous timer is enabled by the correct setting in ASSR. When the AS2 bit in ASSR is set (one) to
       enable asynchronous clocking of Timer/Counter2, pin PB6 is disconnected from the port, and becomes the
       input of the inverting Oscillator amplifier. In this mode, a crystal Oscillator is connected to this pin, and the pin
       can not be used as an I/O pin.



        2020 Microchip Technology Inc.                       Data Sheet Complete                       DS40002061B-page 91
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

PCINT6: Pin Change Interrupt source 6. The PB6 pin can serve as an external interrupt source.
If PB6 is used as a clock pin, DDB6, PORTB6 and PINB6 will all read 0.

• SCK/PCINT5 – Port B, Bit 5
SCK: Master Clock output, Slave Clock input pin for SPI channel. When the SPI is enabled as a Slave, this pin
is configured as an input regardless of the setting of DDB5. When the SPI is enabled as a Master, the data
direction of this pin is controlled by DDB5. When the pin is forced by the SPI to be an input, the pull-up can still
be controlled by the PORTB5 bit.
PCINT5: Pin Change Interrupt source 5. The PB5 pin can serve as an external interrupt source.

• MISO/PCINT4 – Port B, Bit 4
MISO: Master Data input, Slave Data output pin for SPI channel. When the SPI is enabled as a Master, this pin
is configured as an input regardless of the setting of DDB4. When the SPI is enabled as a Slave, the data
direction of this pin is controlled by DDB4. When the pin is forced by the SPI to be an input, the pull-up can still
be controlled by the PORTB4 bit.
PCINT4: Pin Change Interrupt source 4. The PB4 pin can serve as an external interrupt source.

• MOSI/OC2/PCINT3 – Port B, Bit 3
MOSI: SPI Master Data output, Slave Data input for SPI channel. When the SPI is enabled as a Slave, this pin
is configured as an input regardless of the setting of DDB3. When the SPI is enabled as a Master, the data
direction of this pin is controlled by DDB3. When the pin is forced by the SPI to be an input, the pull-up can still
be controlled by the PORTB3 bit.
OC2, Output Compare Match Output: The PB3 pin can serve as an external output for the Timer/Counter2
Compare Match. The PB3 pin has to be configured as an output (DDB3 set (one)) to serve this function. The
OC2 pin is also the output pin for the PWM mode timer function.
PCINT3: Pin Change Interrupt source 3. The PB3 pin can serve as an external interrupt source.

• SS/OC1B/PCINT2 – Port B, Bit 2
SS: Slave Select input. When the SPI is enabled as a Slave, this pin is configured as an input regardless of the
setting of DDB2. As a Slave, the SPI is activated when this pin is driven low. When the SPI is enabled as a
Master, the data direction of this pin is controlled by DDB2. When the pin is forced by the SPI to be an input, the
pull-up can still be controlled by the PORTB2 bit.
OC1B, Output Compare Match output: The PB2 pin can serve as an external output for the Timer/Counter1
Compare Match B. The PB2 pin has to be configured as an output (DDB2 set (one)) to serve this function. The
OC1B pin is also the output pin for the PWM mode timer function.
PCINT2: Pin Change Interrupt source 2. The PB2 pin can serve as an external interrupt source.

• OC1A/PCINT1 – Port B, Bit 1
OC1A, Output Compare Match output: The PB1 pin can serve as an external output for the Timer/Counter1
Compare Match A. The PB1 pin has to be configured as an output (DDB1 set (one)) to serve this function. The
OC1A pin is also the output pin for the PWM mode timer function.
PCINT1: Pin Change Interrupt source 1. The PB1 pin can serve as an external interrupt source.




 2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 92
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

• ICP1/CLKO/PCINT0 – Port B, Bit 0
ICP1, Input Capture Pin: The PB0 pin can act as an Input Capture Pin for Timer/Counter1.
CLKO, Divided System Clock: The divided system clock can be output on the PB0 pin. The divided system clock
will be output if the CKOUT Fuse is programmed, regardless of the PORTB0 and DDB0 settings. It will also be
output during reset.
PCINT0: Pin Change Interrupt source 0. The PB0 pin can serve as an external interrupt source.
Table 14-4 and Table 14-5 on page 94 relate the alternate functions of Port B to the overriding signals shown in
Figure 14-5 on page 89. SPI MSTR INPUT and SPI SLAVE OUTPUT constitute the MISO signal, while MOSI is
divided into SPI MSTR OUTPUT and SPI SLAVE INPUT.


Table 14-4.        Overriding Signals for Alternate Functions in PB7...PB4
 Signal        PB7/XTAL2/             PB6/XTAL1/            PB5/SCK/              PB4/MISO/
 Name          TOSC2/PCINT7(1)        TOSC1/PCINT6(1)       PCINT5                PCINT4
               INTRC • EXTCK+
 PUOE                                 INTRC + AS2           SPE • MSTR            SPE • MSTR
               AS2
 PUOV          0                      0                     PORTB5 • PUD          PORTB4 • PUD
               INTRC • EXTCK+
 DDOE                                 INTRC + AS2           SPE • MSTR            SPE • MSTR
               AS2
 DDOV          0                      0                     0                     0
 PVOE          0                      0                     SPE • MSTR            SPE • MSTR
                                                                                  SPI SLAVE
 PVOV          0                      0                     SCK OUTPUT
                                                                                  OUTPUT
               INTRC • EXTCK +
                                      INTRC + AS2 +
 DIEOE         AS2 + PCINT7 •                               PCINT5 • PCIE0        PCINT4 • PCIE0
                                      PCINT6 • PCIE0
               PCIE0
               (INTRC + EXTCK) •
 DIEOV                                INTRC • AS2           1                     1
               AS2
                                                            PCINT5 INPUT          PCINT4 INPUT
 DI            PCINT7 INPUT           PCINT6 INPUT
                                                            SCK INPUT             SPI MSTR INPUT
                                      Oscillator/Clock
 AIO           Oscillator Output                            –                     –
                                      Input
Notes:    1.   INTRC means that one of the internal RC Oscillators are selected (by the CKSEL fuses), EXTCK means that
               external clock is selected (by the CKSEL fuses)




 2020 Microchip Technology Inc.                         Data Sheet Complete                       DS40002061B-page 93
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P


       Table 14-5.       Overriding Signals for Alternate Functions in PB3...PB0
        Signal       PB3/MOSI/              PB2/SS/                   PB1/OC1A/          PB0/ICP1/
        Name         OC2/PCINT3             OC1B/PCINT2               PCINT1             PCINT0
        PUOE         SPE • MSTR             SPE • MSTR                0                  0
        PUOV         PORTB3 • PUD           PORTB2 • PUD              0                  0
        DDOE         SPE • MSTR             SPE • MSTR                0                  0
        DDOV         0                      0                         0                  0
                     SPE • MSTR +
        PVOE                                OC1B ENABLE               OC1A ENABLE        0
                     OC2A ENABLE
                     SPI MSTR OUTPUT
        PVOV                                OC1B                      OC1A               0
                     + OC2A
        DIEOE        PCINT3 • PCIE0         PCINT2 • PCIE0            PCINT1 • PCIE0     PCINT0 • PCIE0
        DIEOV        1                      1                         1                  1
                     PCINT3 INPUT           PCINT2 INPUT                                 PCINT0 INPUT
        DI                                                            PCINT1 INPUT
                     SPI SLAVE INPUT        SPI SS                                       ICP1 INPUT
        AIO          –                      –                         –                  –


14.3.2 Alternate Functions of Port C
       The Port C pins with alternate functions are shown in Table 14-6.

       Table 14-6.       Port C Pins Alternate Functions
              Port Pin        Alternate Function
                              RESET (Reset pin)
               PC6
                              PCINT14 (Pin Change Interrupt 14)
                              ADC5 (ADC Input Channel 5)
               PC5            SCL (2-wire Serial Bus Clock Line)
                              PCINT13 (Pin Change Interrupt 13)
                              ADC4 (ADC Input Channel 4)
               PC4            SDA (2-wire Serial Bus Data Input/Output Line)
                              PCINT12 (Pin Change Interrupt 12)
                              ADC3 (ADC Input Channel 3)
               PC3
                              PCINT11 (Pin Change Interrupt 11)
                              ADC2 (ADC Input Channel 2)
               PC2
                              PCINT10 (Pin Change Interrupt 10)
                              ADC1 (ADC Input Channel 1)
               PC1
                              PCINT9 (Pin Change Interrupt 9)
                              ADC0 (ADC Input Channel 0)
               PC0
                              PCINT8 (Pin Change Interrupt 8)




        2020 Microchip Technology Inc.                            Data Sheet Complete                    DS40002061B-page 94
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

The alternate pin configuration is as follows:

• RESET/PCINT14 – Port C, Bit 6
RESET, Reset pin: When the RSTDISBL Fuse is programmed, this pin functions as a normal I/O pin, and the
part will have to rely on Power-on Reset and Brown-out Reset as its reset sources. When the RSTDISBL Fuse
is unprogrammed, the reset circuitry is connected to the pin, and the pin can not be used as an I/O pin.
If PC6 is used as a reset pin, DDC6, PORTC6 and PINC6 will all read 0.
PCINT14: Pin Change Interrupt source 14. The PC6 pin can serve as an external interrupt source.

• SCL/ADC5/PCINT13 – Port C, Bit 5
SCL, 2-wire Serial Interface Clock: When the TWEN bit in TWCR is set (one) to enable the 2-wire Serial
Interface, pin PC5 is disconnected from the port and becomes the Serial Clock I/O pin for the 2-wire Serial
Interface. In this mode, there is a spike filter on the pin to suppress spikes shorter than 50 ns on the input signal,
and the pin is driven by an open drain driver with slew-rate limitation.
PC5 can also be used as ADC input Channel 5. Note that ADC input channel 5 uses digital power.
PCINT13: Pin Change Interrupt source 13. The PC5 pin can serve as an external interrupt source.

• SDA/ADC4/PCINT12 – Port C, Bit 4
SDA, 2-wire Serial Interface Data: When the TWEN bit in TWCR is set (one) to enable the 2-wire Serial
Interface, pin PC4 is disconnected from the port and becomes the Serial Data I/O pin for the 2-wire Serial
Interface. In this mode, there is a spike filter on the pin to suppress spikes shorter than 50 ns on the input signal,
and the pin is driven by an open drain driver with slew-rate limitation.
PC4 can also be used as ADC input Channel 4. Note that ADC input channel 4 uses digital power.
PCINT12: Pin Change Interrupt source 12. The PC4 pin can serve as an external interrupt source.

• ADC3/PCINT11 – Port C, Bit 3
PC3 can also be used as ADC input Channel 3. Note that ADC input channel 3 uses analog power.
PCINT11: Pin Change Interrupt source 11. The PC3 pin can serve as an external interrupt source.

• ADC2/PCINT10 – Port C, Bit 2
PC2 can also be used as ADC input Channel 2. Note that ADC input channel 2 uses analog power.
PCINT10: Pin Change Interrupt source 10. The PC2 pin can serve as an external interrupt source.




 2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 95
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


• ADC1/PCINT9 – Port C, Bit 1
PC1 can also be used as ADC input Channel 1. Note that ADC input channel 1 uses analog power.
PCINT9: Pin Change Interrupt source 9. The PC1 pin can serve as an external interrupt source.

• ADC0/PCINT8 – Port C, Bit 0
PC0 can also be used as ADC input Channel 0. Note that ADC input channel 0 uses analog power.
PCINT8: Pin Change Interrupt source 8. The PC0 pin can serve as an external interrupt source.
Table 14-7 and Table 14-8 relate the alternate functions of Port C to the overriding signals shown in Figure 14-5
on page 89.

Table 14-7.        Overriding Signals for Alternate Functions in PC6...PC4(1)
 Signal
 Name          PC6/RESET/PCINT14           PC5/SCL/ADC5/PCINT13            PC4/SDA/ADC4/PCINT12
 PUOE          RSTDISBL                    TWEN                            TWEN
 PUOV          1                           PORTC5 • PUD                    PORTC4 • PUD
 DDOE          RSTDISBL                    TWEN                            TWEN
 DDOV          0                           SCL_OUT                         SDA_OUT
 PVOE          0                           TWEN                            TWEN
 PVOV          0                           0                               0
               RSTDISBL + PCINT14 •
 DIEOE                                     PCINT13 • PCIE1 + ADC5D         PCINT12 • PCIE1 + ADC4D
               PCIE1
 DIEOV         RSTDISBL                    PCINT13 • PCIE1                 PCINT12 • PCIE1
 DI            PCINT14 INPUT               PCINT13 INPUT                   PCINT12 INPUT
 AIO           RESET INPUT                 ADC5 INPUT / SCL INPUT          ADC4 INPUT / SDA INPUT

Note:     1.   When enabled, the 2-wire Serial Interface enables slew-rate controls on the output pins PC4 and PC5. This is
               not shown in the figure. In addition, spike filters are connected between the AIO outputs shown in the port
               figure and the digital logic of the TWI module.




 2020 Microchip Technology Inc.                          Data Sheet Complete                         DS40002061B-page 96
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


       Table 14-8.       Overriding Signals for Alternate Functions in PC3...PC0
        Signal       PC3/ADC3/              PC2/ADC2/              PC1/ADC1/          PC0/ADC0/
        Name         PCINT11                PCINT10                PCINT9             PCINT8
        PUOE         0                      0                      0                  0
        PUOV         0                      0                      0                  0
        DDOE         0                      0                      0                  0
        DDOV         0                      0                      0                  0
        PVOE         0                      0                      0                  0
        PVOV         0                      0                      0                  0
                     PCINT11 • PCIE1 +      PCINT10 • PCIE1 +      PCINT9 • PCIE1 +   PCINT8 • PCIE1 +
        DIEOE
                     ADC3D                  ADC2D                  ADC1D              ADC0D
        DIEOV        PCINT11 • PCIE1        PCINT10 • PCIE1        PCINT9 • PCIE1     PCINT8 • PCIE1
        DI           PCINT11 INPUT          PCINT10 INPUT          PCINT9 INPUT       PCINT8 INPUT
        AIO          ADC3 INPUT             ADC2 INPUT             ADC1 INPUT         ADC0 INPUT



14.3.3 Alternate Functions of Port D
       The Port D pins with alternate functions are shown in Table 14-9.

       Table 14-9.       Port D Pins Alternate Functions
              Port Pin         Alternate Function
                               AIN1 (Analog Comparator Negative Input)
                 PD7
                               PCINT23 (Pin Change Interrupt 23)
                               AIN0 (Analog Comparator Positive Input)
                 PD6           OC0A (Timer/Counter0 Output Compare Match A Output)
                               PCINT22 (Pin Change Interrupt 22)
                               T1 (Timer/Counter 1 External Counter Input)
                 PD5           OC0B (Timer/Counter0 Output Compare Match B Output)
                               PCINT21 (Pin Change Interrupt 21)
                               XCK (USART External Clock Input/Output)
                 PD4           T0 (Timer/Counter 0 External Counter Input)
                               PCINT20 (Pin Change Interrupt 20)
                               INT1 (External Interrupt 1 Input)
                 PD3           OC2B (Timer/Counter2 Output Compare Match B Output)
                               PCINT19 (Pin Change Interrupt 19)
                               INT0 (External Interrupt 0 Input)
                 PD2
                               PCINT18 (Pin Change Interrupt 18)
                               TXD (USART Output Pin)
                 PD1
                               PCINT17 (Pin Change Interrupt 17)
                               RXD (USART Input Pin)
                 PD0
                               PCINT16 (Pin Change Interrupt 16)




        2020 Microchip Technology Inc.                         Data Sheet Complete                    DS40002061B-page 97
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

The alternate pin configuration is as follows:

• AIN1/OC2B/PCINT23 – Port D, Bit 7
AIN1, Analog Comparator Negative Input. Configure the port pin as input with the internal pull-up switched off to
avoid the digital port function from interfering with the function of the Analog Comparator.
PCINT23: Pin Change Interrupt source 23. The PD7 pin can serve as an external interrupt source.

• AIN0/OC0A/PCINT22 – Port D, Bit 6
AIN0, Analog Comparator Positive Input. Configure the port pin as input with the internal pull-up switched off to
avoid the digital port function from interfering with the function of the Analog Comparator.
OC0A, Output Compare Match output: The PD6 pin can serve as an external output for the Timer/Counter0
Compare Match A. The PD6 pin has to be configured as an output (DDD6 set (one)) to serve this function. The
OC0A pin is also the output pin for the PWM mode timer function.
PCINT22: Pin Change Interrupt source 22. The PD6 pin can serve as an external interrupt source.

• T1/OC0B/PCINT21 – Port D, Bit 5
T1, Timer/Counter1 counter source.
OC0B, Output Compare Match output: The PD5 pin can serve as an external output for the Timer/Counter0
Compare Match B. The PD5 pin has to be configured as an output (DDD5 set (one)) to serve this function. The
OC0B pin is also the output pin for the PWM mode timer function.
PCINT21: Pin Change Interrupt source 21. The PD5 pin can serve as an external interrupt source.

• XCK/T0/PCINT20 – Port D, Bit 4
XCK, USART external clock.
T0, Timer/Counter0 counter source.
PCINT20: Pin Change Interrupt source 20. The PD4 pin can serve as an external interrupt source.

• INT1/OC2B/PCINT19 – Port D, Bit 3
INT1, External Interrupt source 1: The PD3 pin can serve as an external interrupt source.
OC2B, Output Compare Match output: The PD3 pin can serve as an external output for the Timer/Counter0
Compare Match B. The PD3 pin has to be configured as an output (DDD3 set (one)) to serve this function. The
OC2B pin is also the output pin for the PWM mode timer function.
PCINT19: Pin Change Interrupt source 19. The PD3 pin can serve as an external interrupt source.

• INT0/PCINT18 – Port D, Bit 2
INT0, External Interrupt source 0: The PD2 pin can serve as an external interrupt source.
PCINT18: Pin Change Interrupt source 18. The PD2 pin can serve as an external interrupt source.
• TXD/PCINT17 – Port D, Bit 1
TXD, Transmit Data (Data output pin for the USART). When the USART Transmitter is enabled, this pin is
configured as an output regardless of the value of DDD1.
PCINT17: Pin Change Interrupt source 17. The PD1 pin can serve as an external interrupt source.




 2020 Microchip Technology Inc.                    Data Sheet Complete                       DS40002061B-page 98
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

• RXD/PCINT16 – Port D, Bit 0
RXD, Receive Data (Data input pin for the USART). When the USART Receiver is enabled this pin is configured
as an input regardless of the value of DDD0. When the USART forces this pin to be an input, the pull-up can still
be controlled by the PORTD0 bit.
PCINT16: Pin Change Interrupt source 16. The PD0 pin can serve as an external interrupt source.
Table 14-10 and Table 14-11 relate the alternate functions of Port D to the overriding signals shown in Figure
14-5 on page 89.


Table 14-10.    Overriding Signals for Alternate Functions PD7...PD4
 Signal     PD7/AIN1               PD6/AIN0/             PD5/T1/OC0B/        PD4/XCK/
 Name       /PCINT23               OC0A/PCINT22          PCINT21             T0/PCINT20
 PUOE       0                      0                     0                   0
 PUO        0                      0                     0                   0
 DDOE       0                      0                     0                   0
 DDOV       0                      0                     0                   0
 PVOE       0                      OC0A ENABLE           OC0B ENABLE         UMSEL
 PVOV       0                      OC0A                  OC0B                XCK OUTPUT
 DIEOE      PCINT23 • PCIE2        PCINT22 • PCIE2       PCINT21 • PCIE2     PCINT20 • PCIE2
 DIEOV      1                      1                     1                   1
                                                                             PCINT20 INPUT
                                                         PCINT21 INPUT
 DI         PCINT23 INPUT          PCINT22 INPUT                             XCK INPUT
                                                         T1 INPUT
                                                                             T0 INPUT
 AIO        AIN1 INPUT             AIN0 INPUT            –                   –



Table 14-11.    Overriding Signals for Alternate Functions in PD3...PD0
 Signal     PD3/OC2B/INT1/         PD2/INT0/             PD1/TXD/            PD0/RXD/
 Name       PCINT19                PCINT18               PCINT17             PCINT16
 PUOE       0                      0                     TXEN                RXEN
 PUO        0                      0                     0                   PORTD0 • PUD
 DDOE       0                      0                     TXEN                RXEN
 DDOV       0                      0                     1                   0
 PVOE       OC2B ENABLE            0                     TXEN                0
 PVOV       OC2B                   0                     TXD                 0
            INT1 ENABLE +          INT0 ENABLE +
 DIEOE                                                   PCINT17 • PCIE2     PCINT16 • PCIE2
            PCINT19 • PCIE2        PCINT18 • PCIE1
 DIEOV      1                      1                     1                   1
            PCINT19 INPUT          PCINT18 INPUT                             PCINT16 INPUT
 DI                                                      PCINT17 INPUT
            INT1 INPUT             INT0 INPUT                                RXD
 AIO        –                      –                     –                   –




 2020 Microchip Technology Inc.                      Data Sheet Complete                      DS40002061B-page 99
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P


14.4   Register Description

14.4.1 MCUCR – MCU Control Register
        Bit               7         6            5                 4                   3                  2             1      0
        0x35 (0x55)       –       BODS(1)     BODSE(1)         PUD                     –                  –      IVSEL       IVCE      MCUCR

        Read/Write        R        R/W          R/W            R/W                    R                   R         R/W       R/W
        Initial Value     0         0            0                 0                   0                  0             0      0

       Notes:      1. BODS and BODSE only available for picoPower devices ATmega48PA/88PA/168PA/328P

       • Bit 4 – PUD: Pull-up Disable
       When this bit is written to one, the pull-ups in the I/O ports are disabled even if the DDxn and PORTxn Registers
       are configured to enable the pull-ups ({DDxn, PORTxn} = 0b01). See ”Configuring the Pin” on page 85 for more
       details about this feature.

14.4.2 PORTB – The Port B Data Register
        Bit                   7           6              5                  4                    3                  2              1       0
        0x05 (0x25)     PORTB7     PORTB6       PORTB5              PORTB4                 PORTB3             PORTB2        PORTB1      PORTB0    PORTB
        Read/Write        R/W           R/W           R/W               R/W                  R/W                R/W           R/W         R/W
        Initial Value         0           0              0                  0                    0                  0              0       0


14.4.3 DDRB – The Port B Data Direction Register
        Bit               7         6           5              4                  3                   2             1         0
        0x04 (0x24)     DDB7      DDB6        DDB5           DDB4               DDB3             DDB2           DDB1         DDB0      DDRB
        Read/Write       R/W       R/W         R/W            R/W                R/W                 R/W         R/W         R/W
        Initial Value      0        0           0              0                  0                   0             0          0


14.4.4 PINB – The Port B Input Pins Address(1)
        Bit               7         6           5              4                  3                   2             1         0
        0x03 (0x23)     PINB7     PINB6       PINB5          PINB4              PINB3        PINB2              PINB1       PINB0      PINB
        Read/Write       R/W       R/W         R/W            R/W                R/W                 R/W         R/W         R/W
        Initial Value     N/A      N/A         N/A            N/A                N/A                 N/A         N/A          N/A


14.4.5 PORTC – The Port C Data Register
        Bit               7          6               5                  4                    3                  2             1           0
        0x08 (0x28)       –       PORTC6       PORTC5          PORTC4                  PORTC3                 PORTC2        PORTC1     PORTC0    PORTC
        Read/Write        R         R/W             R/W                R/W                  R/W                R/W           R/W         R/W
        Initial Value     0          0               0                  0                    0                  0             0           0


14.4.6 DDRC – The Port C Data Direction Register
        Bit               7         6           5              4                  3                   2             1         0
        0x07 (0x27)       –       DDC6        DDC5           DDC4               DDC3             DDC2           DDC1         DDC0      DDRC
        Read/Write        R        R/W         R/W            R/W                R/W                 R/W         R/W         R/W
        Initial Value      0        0           0              0                  0                   0             0          0




        2020 Microchip Technology Inc.                                         Data Sheet Complete                                      DS40002061B-page 100
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

14.4.7 PINC – The Port C Input Pins Address(1)
        Bit                 7          6           5            4            3           2            1     0
        0x06 (0x26)         –       PINC6        PINC5        PINC4        PINC3    PINC2        PINC1    PINC0    PINC
        Read/Write          R         R/W         R/W          R/W          R/W         R/W       R/W      R/W
        Initial Value       0         N/A         N/A          N/A          N/A         N/A       N/A      N/A


14.4.8 PORTD – The Port D Data Register
        Bit                  7              6            5             4            3             2         1         0
        0x0B (0x2B)      PORTD7      PORTD6        PORTD5           PORTD4        PORTD3      PORTD2      PORTD1   PORTD0      PORTD
        Read/Write          R/W            R/W          R/W           R/W          R/W           R/W       R/W       R/W
        Initial Value        0              0            0             0            0             0         0         0


14.4.9 DDRD – The Port D Data Direction Register
        Bit                 7          6           5            4            3           2            1     0
        0x0A (0x2A)       DDD7      DDD6         DDD5         DDD4         DDD3      DDD2        DDD1     DDD0     DDRD
        Read/Write         R/W        R/W         R/W          R/W          R/W         R/W       R/W      R/W
        Initial Value       0          0           0            0            0           0            0     0


14.4.10 PIND – The Port D Input Pins Address(1)
        Bit                 7          6           5            4            3           2            1     0
        0x09 (0x29)      PIND7      PIND6        PIND5        PIND4        PIND3    PIND2        PIND1    PIND0    PIND
        Read/Write         R/W        R/W         R/W          R/W          R/W         R/W       R/W      R/W
        Initial Value      N/A        N/A         N/A          N/A          N/A         N/A       N/A      N/A

       Note:       1.   Writing to the pin register provides toggle functionality for IO (see ”Toggling the Pin” on page 85)




        2020 Microchip Technology Inc.                                    Data Sheet Complete                       DS40002061B-page 101
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P


15.    8-bit Timer/Counter0 with PWM

15.1   Features
       •   Two Independent Output Compare Units
       •   Double Buffered Output Compare Registers
       •   Clear Timer on Compare Match (Auto Reload)
       •   Glitch Free, Phase Correct Pulse Width Modulator (PWM)
       •   Variable PWM Period
       •   Frequency Generator
       •   Three Independent Interrupt Sources (TOV0, OCF0A, and OCF0B)


15.2   Overview
       Timer/Counter0 is a general purpose 8-bit Timer/Counter module, with two independent Output Compare Units,
       and with PWM support. It allows accurate program execution timing (event management) and wave generation.
       A simplified block diagram of the 8-bit Timer/Counter is shown in Figure 15-1. For the actual placement of I/O
       pins, refer to ”Pinout ATmega48A/PA/88A/PA/168A/PA/328/P” on page 12. CPU accessible I/O Registers,
       including I/O bits and I/O pins, are shown in bold. The device-specific I/O Register and bit locations are listed in
       the ”Register Description” on page 113.
       The PRTIM0 bit in ”Minimizing Power Consumption” on page 51 must be written to zero to enable
       Timer/Counter0 module.

       Figure 15-1.         8-bit Timer/Counter Block Diagram
                                                        Count                                 TOVn
                                                        Clear                                 (Int.Req.)
                                                                   Control Logic
                                                       Direction                      clkTn    Clock Select

                                                                                                  Edge
                                                                                                                        Tn
                                                                                                 Detector

                                                                      TOP     BOTTOM

                                                                                                ( From Prescaler )
                                       Timer/Counter
                                          TCNTn
                                                                        =               =0
                                                                                              OCnA
                                                                                              (Int.Req.)

                                                                                                Waveform
                                            =                                                   Generation
                                                                                                                       OCnA



                                          OCRnA
                                                                              Fixed
                                                                                              OCnB
                                                                              TOP
                                                                                              (Int.Req.)
                                                                             Value
                      DATA BUS




                                                                                                Waveform
                                            =                                                   Generation
                                                                                                                       OCnB



                                          OCRnB




                                         TCCRnA                         TCCRnB




        2020 Microchip Technology Inc.                                 Data Sheet Complete                          DS40002061B-page 102
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

15.2.1 Definitions
       Many register and bit references in this section are written in general form. A lower case “n” replaces the
       Timer/Counter number, in this case 0. A lower case “x” replaces the Output Compare Unit, in this case Compare
       Unit A or Compare Unit B. However, when using the register or bit defines in a program, the precise form must
       be used, i.e., TCNT0 for accessing Timer/Counter0 counter value and so on.
       The definitions in Table 15-1 are also used extensively throughout the document.

       Table 15-1.    Definitions

        BOTTOM         The counter reaches the BOTTOM when it becomes 0x00.
        MAX            The counter reaches its MAXimum when it becomes 0xFF (decimal 255).
                       The counter reaches the TOP when it becomes equal to the highest value in the
                       count sequence. The TOP value can be assigned to be the fixed value 0xFF
        TOP
                       (MAX) or the value stored in the OCR0A Register. The assignment is
                       dependent on the mode of operation.


15.2.2 Registers
       The Timer/Counter (TCNT0) and Output Compare Registers (OCR0A and OCR0B) are 8-bit registers. Interrupt
       request (abbreviated to Int.Req. in the figure) signals are all visible in the Timer Interrupt Flag Register (TIFR0).
       All interrupts are individually masked with the Timer Interrupt Mask Register (TIMSK0). TIFR0 and TIMSK0 are
       not shown in the figure.
       The Timer/Counter can be clocked internally, via the prescaler, or by an external clock source on the T0 pin.
       The Clock Select logic block controls which clock source and edge the Timer/Counter uses to increment (or
       decrement) its value. The Timer/Counter is inactive when no clock source is selected. The output from the Clock
       Select logic is referred to as the timer clock (clkT0).
       The double buffered Output Compare Registers (OCR0A and OCR0B) are compared with the Timer/Counter
       value at all times. The result of the compare can be used by the Waveform Generator to generate a PWM or
       variable frequency output on the Output Compare pins (OC0A and OC0B). See ”Using the Output Compare
       Unit” on page 130 for details. The compare match event will also set the Compare Flag (OCF0A or OCF0B)
       which can be used to generate an Output Compare interrupt request.

15.3   Timer/Counter Clock Sources
       The Timer/Counter can be clocked by an internal or an external clock source. The clock source is selected by
       the Clock Select logic which is controlled by the Clock Select (CS02:0) bits located in the Timer/Counter Control
       Register (TCCR0B). For details on clock sources and prescaler, see ”Timer/Counter0 and Timer/Counter1
       Prescalers” on page 147.

15.4   Counter Unit
       The main part of the 8-bit Timer/Counter is the programmable bi-directional counter unit. Figure 15-2 shows a
       block diagram of the counter and its surroundings.




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 103
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 15-2.   Counter Unit Block Diagram
                                                                                   TOVn
                                DATA BUS                                           (Int.Req.)


                                                                                                Clock Select

                                                       count                                      Edge
                                                                                                                        Tn
                                                       clear                       clkTn         Detector
                                   TCNTn                          Control Logic
                                                      direction

                                                                                                 ( From Prescaler )

                                                            bottom           top



       Signal description (internal signals):
             count          Increment or decrement TCNT0 by 1.
             direction      Select between increment and decrement.
             clear          Clear TCNT0 (set all bits to zero).
             clkTn          Timer/Counter clock, referred to as clkT0 in the following.
             top            Signalize that TCNT0 has reached maximum value.
             bottom         Signalize that TCNT0 has reached minimum value (zero).
       Depending of the mode of operation used, the counter is cleared, incremented, or decremented at each timer
       clock (clkT0). clkT0 can be generated from an external or internal clock source, selected by the Clock Select bits
       (CS02:0). When no clock source is selected (CS02:0 = 0) the timer is stopped. However, the TCNT0 value can
       be accessed by the CPU, regardless of whether clkT0 is present or not. A CPU write overrides (has priority over)
       all counter clear or count operations.
       The counting sequence is determined by the setting of the WGM01 and WGM00 bits located in the
       Timer/Counter Control Register (TCCR0A) and the WGM02 bit located in the Timer/Counter Control Register B
       (TCCR0B). There are close connections between how the counter behaves (counts) and how waveforms are
       generated on the Output Compare outputs OC0A and OC0B. For more details about advanced counting
       sequences and waveform generation, see ”Modes of Operation” on page 107.
       The Timer/Counter Overflow Flag (TOV0) is set according to the mode of operation selected by the WGM02:0
       bits. TOV0 can be used for generating a CPU interrupt.

15.5   Output Compare Unit
       The 8-bit comparator continuously compares TCNT0 with the Output Compare Registers (OCR0A and
       OCR0B). Whenever TCNT0 equals OCR0A or OCR0B, the comparator signals a match. A match will set the
       Output Compare Flag (OCF0A or OCF0B) at the next timer clock cycle. If the corresponding interrupt is
       enabled, the Output Compare Flag generates an Output Compare interrupt. The Output Compare Flag is
       automatically cleared when the interrupt is executed. Alternatively, the flag can be cleared by software by writing
       a logical one to its I/O bit location. The Waveform Generator uses the match signal to generate an output
       according to operating mode set by the WGM02:0 bits and Compare Output mode (COM0x1:0) bits. The max
       and bottom signals are used by the Waveform Generator for handling the special cases of the extreme values in
       some modes of operation (”Modes of Operation” on page 107).
       Figure 15-3 shows a block diagram of the Output Compare unit.




        2020 Microchip Technology Inc.                           Data Sheet Complete                                 DS40002061B-page 104
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 15-3.    Output Compare Unit, Block Diagram
                                                        DATA BUS



                                           OCRnx                                 TCNTn




                                                      = (8-bit Comparator )

                                                                                   OCFnx (Int.Req.)


                                    top

                                  bottom
                                                    Waveform Generator                   OCnx
                                   FOCn




                                                     WGMn1:0       COMnx1:0


      The OCR0x Registers are double buffered when using any of the Pulse Width Modulation (PWM) modes. For
      the normal and Clear Timer on Compare (CTC) modes of operation, the double buffering is disabled. The
      double buffering synchronizes the update of the OCR0x Compare Registers to either top or bottom of the
      counting sequence. The synchronization prevents the occurrence of odd-length, non-symmetrical PWM pulses,
      thereby making the output glitch-free.
      The OCR0x Register access may seem complex, but this is not case. When the double buffering is enabled, the
      CPU has access to the OCR0x Buffer Register, and if double buffering is disabled the CPU will access the
      OCR0x directly.

15.5.1 Force Output Compare
      In non-PWM waveform generation modes, the match output of the comparator can be forced by writing a one to
      the Force Output Compare (FOC0x) bit. Forcing compare match will not set the OCF0x Flag or reload/clear the
      timer, but the OC0x pin will be updated as if a real compare match had occurred (the COM0x1:0 bits settings
      define whether the OC0x pin is set, cleared or toggled).

15.5.2 Compare Match Blocking by TCNT0 Write
      All CPU write operations to the TCNT0 Register will block any compare match that occur in the next timer clock
      cycle, even when the timer is stopped. This feature allows OCR0x to be initialized to the same value as TCNT0
      without triggering an interrupt when the Timer/Counter clock is enabled.

15.5.3 Using the Output Compare Unit
      Since writing TCNT0 in any mode of operation will block all compare matches for one timer clock cycle, there
      are risks involved when changing TCNT0 when using the Output Compare Unit, independently of whether the
      Timer/Counter is running or not. If the value written to TCNT0 equals the OCR0x value, the compare match will
      be missed, resulting in incorrect waveform generation. Similarly, do not write the TCNT0 value equal to
      BOTTOM when the counter is downcounting.
      The setup of the OC0x should be performed before setting the Data Direction Register for the port pin to output.
      The easiest way of setting the OC0x value is to use the Force Output Compare (FOC0x) strobe bits in Normal
      mode. The OC0x Registers keep their values even when changing between Waveform Generation modes.




        2020 Microchip Technology Inc.                    Data Sheet Complete                        DS40002061B-page 105
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       Be aware that the COM0x1:0 bits are not double buffered together with the compare value. Changing the
       COM0x1:0 bits will take effect immediately.

15.6   Compare Match Output Unit
       The Compare Output mode (COM0x1:0) bits have two functions. The Waveform Generator uses the COM0x1:0
       bits for defining the Output Compare (OC0x) state at the next compare match. Also, the COM0x1:0 bits control
       the OC0x pin output source. Figure 15-4 shows a simplified schematic of the logic affected by the COM0x1:0 bit
       setting. The I/O Registers, I/O bits, and I/O pins in the figure are shown in bold. Only the parts of the general I/O
       port control registers (DDR and PORT) that are affected by the COM0x1:0 bits are shown. When referring to the
       OC0x state, the reference is for the internal OC0x Register, not the OC0x pin. If a system reset occur, the OC0x
       Register is reset to “0”.

       Figure 15-4.   Compare Match Output Unit, Schematic


                               COMnx1
                               COMnx0       Waveform
                                                              D   Q
                               FOCn         Generator
                                                                                1
                                                                                                OCnx
                                                               OCnx                              Pin
                                                                                0

                                                              D   Q
                                                   DATA BUS




                                                              PORT

                                                              D   Q



                                                               DDR
                                clk I/O


       The general I/O port function is overridden by the Output Compare (OC0x) from the Waveform Generator if
       either of the COM0x1:0 bits are set. However, the OC0x pin direction (input or output) is still controlled by the
       Data Direction Register (DDR) for the port pin. The Data Direction Register bit for the OC0x pin (DDR_OC0x)
       must be set as output before the OC0x value is visible on the pin. The port override function is independent of
       the Waveform Generation mode.
       The design of the Output Compare pin logic allows initialization of the OC0x state before the output is enabled.
       Note that some COM0x1:0 bit settings are reserved for certain modes of operation. See ”Register Description”
       on page 113.

15.6.1 Compare Output Mode and Waveform Generation
       The Waveform Generator uses the COM0x1:0 bits differently in Normal, CTC, and PWM modes. For all modes,
       setting the COM0x1:0 = 0 tells the Waveform Generator that no action on the OC0x Register is to be performed
       on the next compare match. For compare output actions in the non-PWM modes refer to Table 15-2 on page
       113. For fast PWM mode, refer to Table 15-3 on page 113, and for phase correct PWM refer to Table 15-4 on
       page 114.
       A change of the COM0x1:0 bits state will have effect at the first compare match after the bits are written. For
       non-PWM modes, the action can be forced to have immediate effect by using the FOC0x strobe bits.




        2020 Microchip Technology Inc.                       Data Sheet Complete                      DS40002061B-page 106
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

15.7   Modes of Operation
       The mode of operation, i.e., the behavior of the Timer/Counter and the Output Compare pins, is defined by the
       combination of the Waveform Generation mode (WGM02:0) and Compare Output mode (COM0x1:0) bits. The
       Compare Output mode bits do not affect the counting sequence, while the Waveform Generation mode bits do.
       The COM0x1:0 bits control whether the PWM output generated should be inverted or not (inverted or non-
       inverted PWM). For non-PWM modes the COM0x1:0 bits control whether the output should be set, cleared, or
       toggled at a compare match (See ”Compare Match Output Unit” on page 106).
       For detailed timing information refer to ”Timer/Counter Timing Diagrams” on page 111.

15.7.1 Normal Mode
       The simplest mode of operation is the Normal mode (WGM02:0 = 0). In this mode the counting direction is
       always up (incrementing), and no counter clear is performed. The counter simply overruns when it passes its
       maximum 8-bit value (TOP = 0xFF) and then restarts from the bottom (0x00). In normal operation the
       Timer/Counter Overflow Flag (TOV0) will be set in the same timer clock cycle as the TCNT0 becomes zero. The
       TOV0 Flag in this case behaves like a ninth bit, except that it is only set, not cleared. However, combined with
       the timer overflow interrupt that automatically clears the TOV0 Flag, the timer resolution can be increased by
       software. There are no special cases to consider in the Normal mode, a new counter value can be written
       anytime.
       The Output Compare unit can be used to generate interrupts at some given time. Using the Output Compare to
       generate waveforms in Normal mode is not recommended, since this will occupy too much of the CPU time.

15.7.2 Clear Timer on Compare Match (CTC) Mode
       In Clear Timer on Compare or CTC mode (WGM02:0 = 2), the OCR0A Register is used to manipulate the
       counter resolution. In CTC mode the counter is cleared to zero when the counter value (TCNT0) matches the
       OCR0A. The OCR0A defines the top value for the counter, hence also its resolution. This mode allows greater
       control of the compare match output frequency. It also simplifies the operation of counting external events.
       The timing diagram for the CTC mode is shown in Figure 15-5. The counter value (TCNT0) increases until a
       compare match occurs between TCNT0 and OCR0A, and then counter (TCNT0) is cleared.

       Figure 15-5.   CTC Mode, Timing Diagram

                                                                                        OCnx Interrupt Flag Set




                      TCNTn


                      OCn
                                                                                        (COMnx1:0 = 1)
                      (Toggle)

                      Period              1        2       3        4



       An interrupt can be generated each time the counter value reaches the TOP value by using the OCF0A Flag. If
       the interrupt is enabled, the interrupt handler routine can be used for updating the TOP value. However,
       changing TOP to a value close to BOTTOM when the counter is running with none or a low prescaler value must
       be done with care since the CTC mode does not have the double buffering feature. If the new value written to
       OCR0A is lower than the current value of TCNT0, the counter will miss the compare match. The counter will
       then have to count to its maximum value (0xFF) and wrap around starting at 0x00 before the compare match
       can occur.




        2020 Microchip Technology Inc.                   Data Sheet Complete                            DS40002061B-page 107
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

      For generating a waveform output in CTC mode, the OC0A output can be set to toggle its logical level on each
      compare match by setting the Compare Output mode bits to toggle mode (COM0A1:0 = 1). The OC0A value will
      not be visible on the port pin unless the data direction for the pin is set to output. The waveform generated will
      have a maximum frequency of fOC0 = fclk_I/O/2 when OCR0A is set to zero (0x00). The waveform frequency is
      defined by the following equation:
                                                                           f clk_I/O
                                                 f OCnx = --------------------------------------------------
                                                           2  N   1 + OCRnx 

      The N variable represents the prescale factor (1, 8, 64, 256, or 1024).
      As for the Normal mode of operation, the TOV0 Flag is set in the same timer clock cycle that the counter counts
      from MAX to 0x00.

15.7.3 Fast PWM Mode
      The fast Pulse Width Modulation or fast PWM mode (WGM02:0 = 3 or 7) provides a high frequency PWM
      waveform generation option. The fast PWM differs from the other PWM option by its single-slope operation. The
      counter counts from BOTTOM to TOP then restarts from BOTTOM. TOP is defined as 0xFF when WGM2:0 = 3,
      and OCR0A when WGM2:0 = 7. In non-inverting Compare Output mode, the Output Compare (OC0x) is cleared
      on the compare match between TCNT0 and OCR0x, and set at BOTTOM. In inverting Compare Output mode,
      the output is set on compare match and cleared at BOTTOM. Due to the single-slope operation, the operating
      frequency of the fast PWM mode can be twice as high as the phase correct PWM mode that use dual-slope
      operation. This high frequency makes the fast PWM mode well suited for power regulation, rectification, and
      DAC applications. High frequency allows physically small sized external components (coils, capacitors), and
      therefore reduces total system cost.
      In fast PWM mode, the counter is incremented until the counter value matches the TOP value. The counter is
      then cleared at the following timer clock cycle. The timing diagram for the fast PWM mode is shown in Figure
      15-6. The TCNT0 value is in the timing diagram shown as a histogram for illustrating the single-slope operation.
      The diagram includes non-inverted and inverted PWM outputs. The small horizontal line marks on the TCNT0
      slopes represent compare matches between OCR0x and TCNT0.

      Figure 15-6.   Fast PWM Mode, Timing Diagram

                                                                                         OCRnx Interrupt Flag Set




                                                                                         OCRnx Update and
                                                                                         TOVn Interrupt Flag Set




                     TCNTn



                     OCnx                                                                (COMnx1:0 = 2)


                     OCnx                                                                (COMnx1:0 = 3)



                     Period         1    2      3       4        5       6        7



      The Timer/Counter Overflow Flag (TOV0) is set each time the counter reaches TOP. If the interrupt is enabled,
      the interrupt handler routine can be used for updating the compare value.
      In fast PWM mode, the compare unit allows generation of PWM waveforms on the OC0x pins. Setting the
      COM0x1:0 bits to two will produce a non-inverted PWM and an inverted PWM output can be generated by



       2020 Microchip Technology Inc.                      Data Sheet Complete                           DS40002061B-page 108
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

      setting the COM0x1:0 to three: Setting the COM0A1:0 bits to one allows the OC0A pin to toggle on Compare
      Matches if the WGM02 bit is set. This option is not available for the OC0B pin (see Table 15-6 on page 114).
      The actual OC0x value will only be visible on the port pin if the data direction for the port pin is set as output. The
      PWM waveform is generated by setting (or clearing) the OC0x Register at the compare match between OCR0x
      and TCNT0, and clearing (or setting) the OC0x Register at the timer clock cycle the counter is cleared (changes
      from TOP to BOTTOM).
      The PWM frequency for the output can be calculated by the following equation:
                                                                   f clk_I/O
                                                      f OCnxPWM = ------------------
                                                                  N  256
      The N variable represents the prescale factor (1, 8, 64, 256, or 1024).
      The extreme values for the OCR0A Register represents special cases when generating a PWM waveform
      output in the fast PWM mode. If the OCR0A is set equal to BOTTOM, the output will be a narrow spike for each
      MAX+1 timer clock cycle. Setting the OCR0A equal to MAX will result in a constantly high or low output
      (depending on the polarity of the output set by the COM0A1:0 bits.)
      A frequency (with 50% duty cycle) waveform output in fast PWM mode can be achieved by setting OC0x to
      toggle its logical level on each compare match (COM0x1:0 = 1). The waveform generated will have a maximum
      frequency of fOC0 = fclk_I/O/2 when OCR0A is set to zero. This feature is similar to the OC0A toggle in CTC mode,
      except the double buffer feature of the Output Compare unit is enabled in the fast PWM mode.

15.7.4 Phase Correct PWM Mode
      The phase correct PWM mode (WGM02:0 = 1 or 5) provides a high resolution phase correct PWM waveform
      generation option. The phase correct PWM mode is based on a dual-slope operation. The counter counts
      repeatedly from BOTTOM to TOP and then from TOP to BOTTOM. TOP is defined as 0xFF when WGM2:0 = 1,
      and OCR0A when WGM2:0 = 5. In non-inverting Compare Output mode, the Output Compare (OC0x) is cleared
      on the compare match between TCNT0 and OCR0x while upcounting, and set on the compare match while
      downcounting. In inverting Output Compare mode, the operation is inverted. The dual-slope operation has lower
      maximum operation frequency than single slope operation. However, due to the symmetric feature of the dual-
      slope PWM modes, these modes are preferred for motor control applications.
      In phase correct PWM mode the counter is incremented until the counter value matches TOP. When the
      counter reaches TOP, it changes the count direction. The TCNT0 value will be equal to TOP for one timer clock
      cycle. The timing diagram for the phase correct PWM mode is shown on Figure 15-7. The TCNT0 value is in the
      timing diagram shown as a histogram for illustrating the dual-slope operation. The diagram includes non-
      inverted and inverted PWM outputs. The small horizontal line marks on the TCNT0 slopes represent compare
      matches between OCR0x and TCNT0.




       2020 Microchip Technology Inc.                        Data Sheet Complete                       DS40002061B-page 109
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 15-7.    Phase Correct PWM Mode, Timing Diagram

                                                                                       OCnx Interrupt Flag Set




                                                                                       OCRnx Update




                                                                                       TOVn Interrupt Flag Set




               TCNTn



               OCnx                                                                    (COMnx1:0 = 2)


               OCnx                                                                    (COMnx1:0 = 3)



               Period                   1                 2                       3



The Timer/Counter Overflow Flag (TOV0) is set each time the counter reaches BOTTOM. The Interrupt Flag
can be used to generate an interrupt each time the counter reaches the BOTTOM value.
In phase correct PWM mode, the compare unit allows generation of PWM waveforms on the OC0x pins. Setting
the COM0x1:0 bits to two will produce a non-inverted PWM. An inverted PWM output can be generated by
setting the COM0x1:0 to three: Setting the COM0A0 bits to one allows the OC0A pin to toggle on Compare
Matches if the WGM02 bit is set. This option is not available for the OC0B pin (see Table 15-7 on page 115).
The actual OC0x value will only be visible on the port pin if the data direction for the port pin is set as output. The
PWM waveform is generated by clearing (or setting) the OC0x Register at the compare match between OCR0x
and TCNT0 when the counter increments, and setting (or clearing) the OC0x Register at compare match
between OCR0x and TCNT0 when the counter decrements. The PWM frequency for the output when using
phase correct PWM can be calculated by the following equation:
                                                              f clk_I/O
                                               f OCnxPCPWM = ------------------
                                                             N  510

The N variable represents the prescale factor (1, 8, 64, 256, or 1024).
The extreme values for the OCR0A Register represent special cases when generating a PWM waveform output
in the phase correct PWM mode. If the OCR0A is set equal to BOTTOM, the output will be continuously low and
if set equal to MAX the output will be continuously high for non-inverted PWM mode. For inverted PWM the
output will have the opposite logic values.
At the very start of period 2 in Figure 15-7 OCnx has a transition from high to low even though there is no
Compare Match. The point of this transition is to ensure symmetry around BOTTOM. There are two cases that
give a transition without Compare Match.
     OCRnx changes its value from MAX, like in Figure 15-7. When the OCR0A value is MAX the OCn pin
      value is the same as the result of a down-counting Compare Match. To ensure symmetry around
      BOTTOM the OCnx value at MAX must correspond to the result of an up-counting Compare Match.
     The timer starts counting from a value higher than the one in OCRnx, and for that reason misses the
      Compare Match and hence the OCnx change that would have happened on the way up.




 2020 Microchip Technology Inc.                         Data Sheet Complete                            DS40002061B-page 110
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

15.8   Timer/Counter Timing Diagrams
       The Timer/Counter is a synchronous design and the timer clock (clkT0) is therefore shown as a clock enable
       signal in the following figures. The figures include information on when interrupt flags are set. Figure 15-8
       contains timing data for basic Timer/Counter operation. The figure shows the count sequence close to the MAX
       value in all modes other than phase correct PWM mode.

       Figure 15-8.     Timer/Counter Timing Diagram, no Prescaling

                       clkI/O


                       clkTn
                      (clkI/O /1)


                      TCNTn                MAX - 1              MAX                  BOTTOM        BOTTOM + 1


                      TOVn




       Figure 15-9 shows the same timing data, but with the prescaler enabled.

       Figure 15-9.     Timer/Counter Timing Diagram, with Prescaler (fclk_I/O/8)

                       clkI/O


                       clkTn
                      (clkI/O /8)


                      TCNTn                MAX - 1              MAX                  BOTTOM        BOTTOM + 1


                      TOVn




       Figure 15-10 shows the setting of OCF0B in all modes and OCF0A in all modes except CTC mode and PWM
       mode, where OCR0A is TOP.

       Figure 15-10. Timer/Counter Timing Diagram, Setting of OCF0x, with Prescaler (fclk_I/O/8)

                       clkI/O


                       clkTn
                      (clkI/O /8)


                      TCNTn               OCRnx - 1             OCRnx                OCRnx + 1      OCRnx + 2


                      OCRnx                                           OCRnx Value


                      OCFnx




       Figure 15-11 shows the setting of OCF0A and the clearing of TCNT0 in CTC mode and fast PWM mode where
       OCR0A is TOP.




        2020 Microchip Technology Inc.                        Data Sheet Complete                      DS40002061B-page 111
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 15-11. Timer/Counter Timing Diagram, Clear Timer on Compare Match mode, with Prescaler (fclk_I/O/8)

               clkI/O


               clkTn
              (clkI/O /8)

              TCNTn
                                   TOP - 1           TOP                 BOTTOM       BOTTOM + 1
              (CTC)

               OCRnx                                        TOP


               OCFnx




 2020 Microchip Technology Inc.                   Data Sheet Complete                      DS40002061B-page 112
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P


15.9   Register Description

15.9.1 TCCR0A – Timer/Counter Control Register A
        Bit                    7           6         5           4          3          2         1          0
        0x24 (0x44)         COM0A1      COM0A0     COM0B1     COM0B0        –          –      WGM01     WGM00       TCCR0A

        Read/Write            R/W         R/W       R/W         R/W         R          R        R/W        R/W
        Initial Value          0           0         0           0          0          0         0          0


       • Bits 7:6 – COM0A1:0: Compare Match Output A Mode
       These bits control the Output Compare pin (OC0A) behavior. If one or both of the COM0A1:0 bits are set, the
       OC0A output overrides the normal port functionality of the I/O pin it is connected to. However, note that the Data
       Direction Register (DDR) bit corresponding to the OC0A pin must be set in order to enable the output driver.
       When OC0A is connected to the pin, the function of the COM0A1:0 bits depends on the WGM02:0 bit setting.
       Table 15-2 shows the COM0A1:0 bit functionality when the WGM02:0 bits are set to a normal or CTC mode
       (non-PWM).

       Table 15-2.        Compare Output Mode, non-PWM Mode
          COM0A1              COM0A0       Description
                0                   0      Normal port operation, OC0A disconnected.
                0                   1      Toggle OC0A on Compare Match
                1                   0      Clear OC0A on Compare Match
                1                   1      Set OC0A on Compare Match

       Table 15-3 shows the COM0A1:0 bit functionality when the WGM01:0 bits are set to fast PWM mode.

       Table 15-3.        Compare Output Mode, Fast PWM Mode(1)
          COM0A1              COM0A0       Description
                0                   0      Normal port operation, OC0A disconnected.
                                           WGM02 = 0: Normal Port Operation, OC0A Disconnected.
                0                   1
                                           WGM02 = 1: Toggle OC0A on Compare Match.
                                           Clear OC0A on Compare Match, set OC0A at BOTTOM,
                1                   0
                                           (non-inverting mode).
                                           Set OC0A on Compare Match, clear OC0A at BOTTOM,
                1                   1
                                           (inverting mode).
       Note:        1.   A special case occurs when OCR0A equals TOP and COM0A1 is set. In this case, the Compare Match is
                         ignored, but the set or clear is done at BOTTOM. See ”Fast PWM Mode” on page 108 for more details.
       Table 15-4 shows the COM0A1:0 bit functionality when the WGM02:0 bits are set to phase correct PWM mode.




        2020 Microchip Technology Inc.                          Data Sheet Complete                       DS40002061B-page 113
                                            ATmega48A/PA/88A/PA/168A/PA/328/P


Table 15-4.        Compare Output Mode, Phase Correct PWM Mode(1)
   COM0A1             COM0A0       Description
        0                 0        Normal port operation, OC0A disconnected.
                                   WGM02 = 0: Normal Port Operation, OC0A Disconnected.
        0                 1
                                   WGM02 = 1: Toggle OC0A on Compare Match.
                                   Clear OC0A on Compare Match when up-counting. Set OC0A on
        1                 0
                                   Compare Match when down-counting.
                                   Set OC0A on Compare Match when up-counting. Clear OC0A on
        1                 1
                                   Compare Match when down-counting.

Note:       1.   A special case occurs when OCR0A equals TOP and COM0A1 is set. In this case, the Compare Match is
                 ignored, but the set or clear is done at TOP. See ”Phase Correct PWM Mode” on page 134 for more details.

• Bits 5:4 – COM0B1:0: Compare Match Output B Mode
These bits control the Output Compare pin (OC0B) behavior. If one or both of the COM0B1:0 bits are set, the
OC0B output overrides the normal port functionality of the I/O pin it is connected to. However, note that the Data
Direction Register (DDR) bit corresponding to the OC0B pin must be set in order to enable the output driver.
When OC0B is connected to the pin, the function of the COM0B1:0 bits depends on the WGM02:0 bit setting.
Table 15-5 shows the COM0B1:0 bit functionality when the WGM02:0 bits are set to a normal or CTC mode
(non-PWM).

Table 15-5.        Compare Output Mode, non-PWM Mode
   COM0B1             COM0B0       Description
        0                 0        Normal port operation, OC0B disconnected.
        0                 1        Toggle OC0B on Compare Match
        1                 0        Clear OC0B on Compare Match
        1                 1        Set OC0B on Compare Match

Table 15-6 shows the COM0B1:0 bit functionality when the WGM02:0 bits are set to fast PWM mode.

Table 15-6.        Compare Output Mode, Fast PWM Mode(1)
   COM0B1             COM0B0        Description
        0                 0         Normal port operation, OC0B disconnected.
        0                 1         Reserved
                                    Clear OC0B on Compare Match, set OC0B at BOTTOM,
        1                 0
                                    (non-inverting mode)
                                    Set OC0B on Compare Match, clear OC0B at BOTTOM,
        1                 1
                                    (inverting mode).

Note:       1.   A special case occurs when OCR0B equals TOP and COM0B1 is set. In this case, the Compare Match is
                 ignored, but the set or clear is done at TOP. See ”Fast PWM Mode” on page 108 for more details.
Table 15-7 shows the COM0B1:0 bit functionality when the WGM02:0 bits are set to phase correct PWM mode.




 2020 Microchip Technology Inc.                           Data Sheet Complete                        DS40002061B-page 114
                                                ATmega48A/PA/88A/PA/168A/PA/328/P


Table 15-7.          Compare Output Mode, Phase Correct PWM Mode(1)
   COM0B1               COM0B0       Description
         0                  0        Normal port operation, OC0B disconnected.
         0                  1        Reserved
                                     Clear OC0B on Compare Match when up-counting. Set OC0B on
         1                  0
                                     Compare Match when down-counting.
                                     Set OC0B on Compare Match when up-counting. Clear OC0B on
         1                  1
                                     Compare Match when down-counting.

Note:        1.    A special case occurs when OCR0B equals TOP and COM0B1 is set. In this case, the Compare Match is
                   ignored, but the set or clear is done at TOP. See ”Phase Correct PWM Mode” on page 109 for more details.

• Bits 3, 2 – Reserved
These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

• Bits 1:0 – WGM01:0: Waveform Generation Mode
Combined with the WGM02 bit found in the TCCR0B Register, these bits control the counting sequence of the
counter, the source for maximum (TOP) counter value, and what type of waveform generation to be used, see
Table 15-8. Modes of operation supported by the Timer/Counter unit are: Normal mode (counter), Clear Timer
on Compare Match (CTC) mode, and two types of Pulse Width Modulation (PWM) modes (see ”Modes of
Operation” on page 107).


Table 15-8.          Waveform Generation Mode Bit Description
                                                    Timer/Counter
                                                    Mode of                        Update of   TOV Flag
 Mode             WGM02      WGM01       WGM00      Operation           TOP        OCRx at     Set on(1)(2)
    0               0           0           0       Normal              0xFF       Immediate      MAX
                                                    PWM, Phase
    1               0           0           1                           0xFF         TOP        BOTTOM
                                                    Correct
    2               0           1           0       CTC                OCRA        Immediate      MAX
    3               0           1           1       Fast PWM            0xFF       BOTTOM         MAX
    4               1           0           0       Reserved             –            –             –
                                                    PWM, Phase
    5               1           0           1                          OCRA          TOP        BOTTOM
                                                    Correct
    6               1           1           0       Reserved             –            –             –
    7               1           1           1       Fast PWM           OCRA        BOTTOM          TOP
Notes:       1.    MAX   = 0xFF
             2.    BOTTOM = 0x00




 2020 Microchip Technology Inc.                             Data Sheet Complete                         DS40002061B-page 115
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


15.9.2 TCCR0B – Timer/Counter Control Register B
        Bit                7              6   5        4           3             2    1        0
        0x25 (0x45)      FOC0A       FOC0B    –        –       WGM02       CS02      CS01     CS00       TCCR0B

        Read/Write         W              W   R        R          R/W        R/W     R/W      R/W
        Initial Value      0              0   0        0           0             0    0        0


       • Bit 7 – FOC0A: Force Output Compare A
       The FOC0A bit is only active when the WGM bits specify a non-PWM mode.
       However, for ensuring compatibility with future devices, this bit must be set to zero when TCCR0B is written
       when operating in PWM mode. When writing a logical one to the FOC0A bit, an immediate Compare Match is
       forced on the Waveform Generation unit. The OC0A output is changed according to its COM0A1:0 bits setting.
       Note that the FOC0A bit is implemented as a strobe. Therefore it is the value present in the COM0A1:0 bits that
       determines the effect of the forced compare.
       A FOC0A strobe will not generate any interrupt, nor will it clear the timer in CTC mode using OCR0A as TOP.
       The FOC0A bit is always read as zero.

       • Bit 6 – FOC0B: Force Output Compare B
       The FOC0B bit is only active when the WGM bits specify a non-PWM mode.
       However, for ensuring compatibility with future devices, this bit must be set to zero when TCCR0B is written
       when operating in PWM mode. When writing a logical one to the FOC0B bit, an immediate Compare Match is
       forced on the Waveform Generation unit. The OC0B output is changed according to its COM0B1:0 bits setting.
       Note that the FOC0B bit is implemented as a strobe. Therefore it is the value present in the COM0B1:0 bits that
       determines the effect of the forced compare.
       A FOC0B strobe will not generate any interrupt, nor will it clear the timer in CTC mode using OCR0B as TOP.
       The FOC0B bit is always read as zero.

       • Bits 5:4 – Reserved
       These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

       • Bit 3 – WGM02: Waveform Generation Mode
       See the description in the ”TCCR0A – Timer/Counter Control Register A” on page 113.
       • Bits 2:0 – CS02:0: Clock Select
       The three Clock Select bits select the clock source to be used by the Timer/Counter.




        2020 Microchip Technology Inc.                    Data Sheet Complete                       DS40002061B-page 116
                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 15-9.           Clock Select Bit Description
         CS02           CS01         CS00        Description
              0          0            0          No clock source (Timer/Counter stopped)
              0          0            1          clkI/O/(No prescaling)
              0          1            0          clkI/O/8 (From prescaler)
              0          1            1          clkI/O/64 (From prescaler)
              1          0            0          clkI/O/256 (From prescaler)
              1          0            1          clkI/O/1024 (From prescaler)
              1          1            0          External clock source on T0 pin. Clock on falling edge.
              1          1            1          External clock source on T0 pin. Clock on rising edge.
       If external pin modes are used for the Timer/Counter0, transitions on the T0 pin will clock the counter even if the
       pin is configured as an output. This feature allows software control of the counting.

15.9.3 TCNT0 – Timer/Counter Register
        Bit                     7            6           5          4           3         2          1      0
        0x26 (0x46)                                                 TCNT0[7:0]                                   TCNT0
        Read/Write             R/W          R/W         R/W       R/W          R/W       R/W        R/W    R/W
        Initial Value           0            0           0          0           0         0          0      0

       The Timer/Counter Register gives direct access, both for read and write operations, to the Timer/Counter unit 8-
       bit counter. Writing to the TCNT0 Register blocks (removes) the Compare Match on the following timer clock.
       Modifying the counter (TCNT0) while the counter is running, introduces a risk of missing a Compare Match
       between TCNT0 and the OCR0x Registers.

15.9.4 OCR0A – Output Compare Register A
        Bit                     7            6           5          4           3         2          1      0
        0x27 (0x47)                                                 OCR0A[7:0]                                   OCR0A
        Read/Write             R/W          R/W         R/W       R/W          R/W       R/W        R/W    R/W
        Initial Value           0            0           0          0           0         0          0      0

       The Output Compare Register A contains an 8-bit value that is continuously compared with the counter value
       (TCNT0). A match can be used to generate an Output Compare interrupt, or to generate a waveform output on
       the OC0A pin.

15.9.5 OCR0B – Output Compare Register B
        Bit                     7            6           5          4           3         2          1      0
        0x28 (0x48)                                                 OCR0B[7:0]                                   OCR0B
        Read/Write             R/W          R/W         R/W       R/W          R/W       R/W        R/W    R/W
        Initial Value           0            0           0          0           0         0          0      0

       The Output Compare Register B contains an 8-bit value that is continuously compared with the counter value
       (TCNT0). A match can be used to generate an Output Compare interrupt, or to generate a waveform output on
       the OC0B pin.




        2020 Microchip Technology Inc.                                       Data Sheet Complete                   DS40002061B-page 117
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P


15.9.6 TIMSK0 – Timer/Counter Interrupt Mask Register
        Bit                7              6       5       4          3           2             1           0
        (0x6E)             –             –        –       –          –         OCIE0B    OCIE0A          TOIE0      TIMSK0
        Read/Write         R             R        R       R          R          R/W           R/W         R/W
        Initial Value      0              0       0       0          0           0             0           0


       • Bits 7:3 – Reserved
       These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

       • Bit 2 – OCIE0B: Timer/Counter Output Compare Match B Interrupt Enable
       When the OCIE0B bit is written to one, and the I-bit in the Status Register is set, the Timer/Counter Compare
       Match B interrupt is enabled. The corresponding interrupt is executed if a Compare Match in Timer/Counter
       occurs, i.e., when the OCF0B bit is set in the Timer/Counter Interrupt Flag Register – TIFR0.

       • Bit 1 – OCIE0A: Timer/Counter0 Output Compare Match A Interrupt Enable
       When the OCIE0A bit is written to one, and the I-bit in the Status Register is set, the Timer/Counter0 Compare
       Match A interrupt is enabled. The corresponding interrupt is executed if a Compare Match in Timer/Counter0
       occurs, i.e., when the OCF0A bit is set in the Timer/Counter 0 Interrupt Flag Register – TIFR0.

       • Bit 0 – TOIE0: Timer/Counter0 Overflow Interrupt Enable
       When the TOIE0 bit is written to one, and the I-bit in the Status Register is set, the Timer/Counter0 Overflow
       interrupt is enabled. The corresponding interrupt is executed if an overflow in Timer/Counter0 occurs, i.e., when
       the TOV0 bit is set in the Timer/Counter 0 Interrupt Flag Register – TIFR0.

15.9.7 TIFR0 – Timer/Counter 0 Interrupt Flag Register
        Bit               7          6        5       4         3          2             1           0
        0x15 (0x35)       –          –        –       –         –        OCF0B        OCF0A         TOV0         TIFR0
        Read/Write        R          R        R       R         R         R/W           R/W         R/W
        Initial Value     0          0        0       0         0          0             0           0


       • Bits 7:3 – Reserved
       These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

       • Bit 2 – OCF0B: Timer/Counter 0 Output Compare B Match Flag
       The OCF0B bit is set when a Compare Match occurs between the Timer/Counter and the data in OCR0B –
       Output Compare Register0 B. OCF0B is cleared by hardware when executing the corresponding interrupt
       handling vector. Alternatively, OCF0B is cleared by writing a logic one to the flag. When the I-bit in SREG,
       OCIE0B (Timer/Counter Compare B Match Interrupt Enable), and OCF0B are set, the Timer/Counter Compare
       Match Interrupt is executed.

       • Bit 1 – OCF0A: Timer/Counter 0 Output Compare A Match Flag
       The OCF0A bit is set when a Compare Match occurs between the Timer/Counter0 and the data in OCR0A –
       Output Compare Register0. OCF0A is cleared by hardware when executing the corresponding interrupt
       handling vector. Alternatively, OCF0A is cleared by writing a logic one to the flag. When the I-bit in SREG,
       OCIE0A (Timer/Counter0 Compare Match Interrupt Enable), and OCF0A are set, the Timer/Counter0 Compare
       Match Interrupt is executed.




        2020 Microchip Technology Inc.                       Data Sheet Complete                               DS40002061B-page 118
                                     ATmega48A/PA/88A/PA/168A/PA/328/P

• Bit 0 – TOV0: Timer/Counter0 Overflow Flag
The bit TOV0 is set when an overflow occurs in Timer/Counter0. TOV0 is cleared by hardware when executing
the corresponding interrupt handling vector. Alternatively, TOV0 is cleared by writing a logic one to the flag.
When the SREG I-bit, TOIE0 (Timer/Counter0 Overflow Interrupt Enable), and TOV0 are set, the
Timer/Counter0 Overflow interrupt is executed.
The setting of this flag is dependent of the WGM02:0 bit setting. Refer to Table 15-8, ”Waveform Generation
Mode Bit Description” on page 115.




 2020 Microchip Technology Inc.                   Data Sheet Complete                     DS40002061B-page 119
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


16.    16-bit Timer/Counter1 with PWM

16.1   Features
       •   True 16-bit Design (i.e., Allows 16-bit PWM)
       •   Two independent Output Compare Units
       •   Double Buffered Output Compare Registers
       •   One Input Capture Unit
       •   Input Capture Noise Canceler
       •   Clear Timer on Compare Match (Auto Reload)
       •   Glitch-free, Phase Correct Pulse Width Modulator (PWM)
       •   Variable PWM Period
       •   Frequency Generator
       •   External Event Counter
       •   Four independent interrupt Sources (TOV1, OCF1A, OCF1B, and ICF1)


16.2   Overview
       The 16-bit Timer/Counter unit allows accurate program execution timing (event management), wave generation,
       and signal timing measurement.
       Most register and bit references in this section are written in general form. A lower case “n” replaces the
       Timer/Counter number, and a lower case “x” replaces the Output Compare unit channel. However, when using
       the register or bit defines in a program, the precise form must be used, i.e., TCNT1 for accessing
       Timer/Counter1 counter value and so on.
       A simplified block diagram of the 16-bit Timer/Counter is shown in Figure 16-1. For the actual placement of I/O
       pins, refer to ”Pinout ATmega48A/PA/88A/PA/168A/PA/328/P” on page 12. CPU accessible I/O Registers,
       including I/O bits and I/O pins, are shown in bold. The device-specific I/O Register and bit locations are listed in
       the ”Register Description” on page 140.
       The PRTIM1 bit in ”PRR – Power Reduction Register” on page 54 must be written to zero to enable
       Timer/Counter1 module.




        2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 120
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 16-1.     16-bit Timer/Counter Block Diagram(1)
                                                      Count                                        TOVn
                                                      Clear                                        (Int.Req.)
                                                                 Control Logic
                                                     Direction                      clkTn           Clock Select

                                                                                                       Edge
                                                                                                                                  Tn
                                                                                                      Detector

                                                                    TOP     BOTTOM

                                                                                                     ( From Prescaler )
                                     Timer/Counter
                                          TCNTn
                                                                      =               =0
                                                                                                   OCnA
                                                                                                   (Int.Req.)

                                                                                                     Waveform
                                            =                                                        Generation
                                                                                                                                 OCnA



                                          OCRnA

                                                                            Fixed                  OCnB
                                                                            TOP                    (Int.Req.)
                      DATA BUS




                                                                           Values
                                                                                                     Waveform
                                            =                                                        Generation
                                                                                                                                 OCnB



                                          OCRnB                                                                       ( From Analog
                                                                                                                    Comparator Ouput )
                                                                                 ICFn (Int.Req.)

                                                                                     Edge              Noise
                                           ICRn
                                                                                    Detector          Canceler
                                                                                                                                 ICPn


                                          TCCRnA                      TCCRnB




       Note:   1. Refer to Figure 1-1 on page 12, Table 14-3 on page 91 and Table 14-9 on page 97 for Timer/Counter1 pin
                  placement and description.

16.2.1 Registers
       The Timer/Counter (TCNT1), Output Compare Registers (OCR1A/B), and Input Capture Register (ICR1) are all
       16-bit registers. Special procedures must be followed when accessing the 16-bit registers. These procedures
       are described in the section ”Accessing 16-bit Registers” on page 122. The Timer/Counter Control Registers
       (TCCR1A/B) are 8-bit registers and have no CPU access restrictions. Interrupt requests (abbreviated to Int.Req.
       in the figure) signals are all visible in the Timer Interrupt Flag Register (TIFR1). All interrupts are individually
       masked with the Timer Interrupt Mask Register (TIMSK1). TIFR1 and TIMSK1 are not shown in the figure.
       The Timer/Counter can be clocked internally, via the prescaler, or by an external clock source on the T1 pin.
       The Clock Select logic block controls which clock source and edge the Timer/Counter uses to increment (or
       decrement) its value. The Timer/Counter is inactive when no clock source is selected. The output from the Clock
       Select logic is referred to as the timer clock (clkT1).
       The double buffered Output Compare Registers (OCR1A/B) are compared with the Timer/Counter value at all
       time. The result of the compare can be used by the Waveform Generator to generate a PWM or variable
       frequency output on the Output Compare pin (OC1A/B). See ”Output Compare Units” on page 128. The
       compare match event will also set the Compare Match Flag (OCF1A/B) which can be used to generate an
       Output Compare interrupt request.
       The Input Capture Register can capture the Timer/Counter value at a given external (edge triggered) event on
       either the Input Capture pin (ICP1) or on the Analog Comparator pins (See ”Analog Comparator” on page 243)



        2020 Microchip Technology Inc.                               Data Sheet Complete                                     DS40002061B-page 121
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       The Input Capture unit includes a digital filtering unit (Noise Canceler) for reducing the chance of capturing
       noise spikes.
       The TOP value, or maximum Timer/Counter value, can in some modes of operation be defined by either the
       OCR1A Register, the ICR1 Register, or by a set of fixed values. When using OCR1A as TOP value in a PWM
       mode, the OCR1A Register can not be used for generating a PWM output. However, the TOP value will in this
       case be double buffered allowing the TOP value to be changed in run time. If a fixed TOP value is required, the
       ICR1 Register can be used as an alternative, freeing the OCR1A to be used as PWM output.

16.2.2 Definitions
       The following definitions are used extensively throughout the section:
        BOTTOM        The counter reaches the BOTTOM when it becomes 0x0000.

        MAX           The counter reaches its MAXimum when it becomes 0xFFFF (decimal 65535).

                      The counter reaches the TOP when it becomes equal to the highest value in the count
                      sequence. The TOP value can be assigned to be one of the fixed values: 0x00FF, 0x01FF,
        TOP
                      or 0x03FF, or to the value stored in the OCR1A or ICR1 Register. The assignment is
                      dependent of the mode of operation.


16.3   Accessing 16-bit Registers
       The TCNT1, OCR1A/B, and ICR1 are 16-bit registers that can be accessed by the AVR CPU via the 8-bit data
       bus. The 16-bit register must be byte accessed using two read or write operations. Each 16-bit timer has a
       single 8-bit register for temporary storing of the high byte of the 16-bit access. The same temporary register is
       shared between all 16-bit registers within each 16-bit timer. Accessing the low byte triggers the 16-bit read or
       write operation. When the low byte of a 16-bit register is written by the CPU, the high byte stored in the
       temporary register, and the low byte written are both copied into the 16-bit register in the same clock cycle.
       When the low byte of a 16-bit register is read by the CPU, the high byte of the 16-bit register is copied into the
       temporary register in the same clock cycle as the low byte is read.
       Not all 16-bit accesses uses the temporary register for the high byte. Reading the OCR1A/B 16-bit registers
       does not involve using the temporary register.
       To do a 16-bit write, the high byte must be written before the low byte. For a 16-bit read, the low byte must be
       read before the high byte.
       The following code examples show how to access the 16-bit Timer Registers assuming that no interrupts
       updates the temporary register. The same principle can be used directly for accessing the OCR1A/B and ICR1
       Registers. Note that when using “C”, the compiler handles the 16-bit access.




        2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 122
                                        ATmega48A/PA/88A/PA/168A/PA/328/P


 Assembly Code Examples(1)
                    ...
                    ; Set TCNT1 to 0x01FF
                    ldi       r17,0x01
                    ldi       r16,0xFF
                    out       TCNT1H,r17
                    out       TCNT1L,r16
                    ; Read TCNT1 into r17:r16
                    in        r16,TCNT1L
                    in        r17,TCNT1H
                    ...
 C Code Examples(1)
                    unsigned int i;
                    ...
                    /* Set TCNT1 to 0x01FF */
                    TCNT1 = 0x1FF;
                    /* Read TCNT1 into i */
                    i = TCNT1;
                    ...

Note:   1. See ”About Code Examples” on page 17.
           For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
           be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
           “SBRS”, “SBRC”, “SBR”, and “CBR”.
The assembly code example returns the TCNT1 value in the r17:r16 register pair.
It is important to notice that accessing 16-bit registers are atomic operations. If an interrupt occurs between the
two instructions accessing the 16-bit register, and the interrupt code updates the temporary register by
accessing the same or any other of the 16-bit Timer Registers, then the result of the access outside the interrupt
will be corrupted. Therefore, when both the main code and the interrupt code update the temporary register, the
main code must disable the interrupts during the 16-bit access.
The following code examples show how to do an atomic read of the TCNT1 Register contents. Reading any of
the OCR1A/B or ICR1 Registers can be done by using the same principle.




 2020 Microchip Technology Inc.                       Data Sheet Complete                          DS40002061B-page 123
                                        ATmega48A/PA/88A/PA/168A/PA/328/P


 Assembly Code Example(1)
          TIM16_ReadTCNT1:
                ; Save global interrupt flag
                in         r18,SREG
                ; Disable interrupts
                cli
                ; Read TCNT1 into r17:r16
                in         r16,TCNT1L
                in         r17,TCNT1H
                ; Restore global interrupt flag
                out        SREG,r18
                ret
 C Code Example(1)
          unsigned int TIM16_ReadTCNT1( void )
          {
                unsigned char sreg;
                unsigned int i;
                /* Save global interrupt flag */
                sreg = SREG;
                /* Disable interrupts */
                _CLI();
                /* Read TCNT1 into i */
                i = TCNT1;
                /* Restore global interrupt flag */
                SREG = sreg;
                return i;
          }

Note:   1. See ”About Code Examples” on page 17.
           For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
           be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
           “SBRS”, “SBRC”, “SBR”, and “CBR”.
The assembly code example returns the TCNT1 value in the r17:r16 register pair.
The following code examples show how to do an atomic write of the TCNT1 Register contents. Writing any of
the OCR1A/B or ICR1 Registers can be done by using the same principle.




 2020 Microchip Technology Inc.                       Data Sheet Complete                          DS40002061B-page 124
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


        Assembly Code Example(1)
                 TIM16_WriteTCNT1:
                       ; Save global interrupt flag
                       in        r18,SREG
                       ; Disable interrupts
                       cli
                       ; Set TCNT1 to r17:r16
                       out       TCNT1H,r17
                       out       TCNT1L,r16
                       ; Restore global interrupt flag
                       out       SREG,r18
                       ret
        C Code Example(1)
                 void TIM16_WriteTCNT1( unsigned int i )
                 {
                       unsigned char sreg;
                       unsigned int i;
                       /* Save global interrupt flag */
                       sreg = SREG;
                       /* Disable interrupts */
                       _CLI();
                       /* Set TCNT1 to i */
                       TCNT1 = i;
                       /* Restore global interrupt flag */
                       SREG = sreg;
                 }

       Note:   1. See ”About Code Examples” on page 17.
                  For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
                  be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
                  “SBRS”, “SBRC”, “SBR”, and “CBR”.

       The assembly code example requires that the r17:r16 register pair contains the value to be written to TCNT1.

16.3.1 Reusing the Temporary High Byte Register
       If writing to more than one 16-bit register where the high byte is the same for all registers written, then the high
       byte only needs to be written once. However, note that the same rule of atomic operation described previously
       also applies in this case.

16.4   Timer/Counter Clock Sources
       The Timer/Counter can be clocked by an internal or an external clock source. The clock source is selected by
       the Clock Select logic which is controlled by the Clock Select (CS12:0) bits located in the Timer/Counter control
       Register B (TCCR1B). For details on clock sources and prescaler, see ”Timer/Counter0 and Timer/Counter1
       Prescalers” on page 147.

16.5   Counter Unit
       The main part of the 16-bit Timer/Counter is the programmable 16-bit bi-directional counter unit. Figure 16-2
       shows a block diagram of the counter and its surroundings.




        2020 Microchip Technology Inc.                       Data Sheet Complete                          DS40002061B-page 125
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 16-2.   Counter Unit Block Diagram
                                    DATA BUS       (8-bit)
                                                                                              TOVn
                                                                                              (Int.Req.)

                            TEMP (8-bit)
                                                                                                           Clock Select
                                                                   Count                                     Edge
                                                                                                                                    Tn
                           TCNTnH (8-bit)        TCNTnL (8-bit)    Clear                      clkTn         Detector
                                                                              Control Logic
                                                                  Direction
                                  TCNTn (16-bit Counter)
                                                                                                            ( From Prescaler )

                                                                                 TOP     BOTTOM



       Signal description (internal signals):
             Count          Increment or decrement TCNT1 by 1.
             Direction      Select between increment and decrement.
             Clear          Clear TCNT1 (set all bits to zero).
             clkT1          Timer/Counter clock.
             TOP            Signalize that TCNT1 has reached maximum value.
             BOTTOM         Signalize that TCNT1 has reached minimum value (zero).
       The 16-bit counter is mapped into two 8-bit I/O memory locations: Counter High (TCNT1H) containing the upper
       eight bits of the counter, and Counter Low (TCNT1L) containing the lower eight bits. The TCNT1H Register can
       only be indirectly accessed by the CPU. When the CPU does an access to the TCNT1H I/O location, the CPU
       accesses the high byte temporary register (TEMP). The temporary register is updated with the TCNT1H value
       when the TCNT1L is read, and TCNT1H is updated with the temporary register value when TCNT1L is written.
       This allows the CPU to read or write the entire 16-bit counter value within one clock cycle via the 8-bit data bus.
       It is important to notice that there are special cases of writing to the TCNT1 Register when the counter is
       counting that will give unpredictable results. The special cases are described in the sections where they are of
       importance.
       Depending on the mode of operation used, the counter is cleared, incremented, or decremented at each timer
       clock (clkT1). The clkT1 can be generated from an external or internal clock source, selected by the Clock Select
       bits (CS12:0). When no clock source is selected (CS12:0 = 0) the timer is stopped. However, the TCNT1 value
       can be accessed by the CPU, independent of whether clkT1 is present or not. A CPU write overrides (has priority
       over) all counter clear or count operations.
       The counting sequence is determined by the setting of the Waveform Generation mode bits (WGM13:0) located
       in the Timer/Counter Control Registers A and B (TCCR1A and TCCR1B). There are close connections between
       how the counter behaves (counts) and how waveforms are generated on the Output Compare outputs OC1x.
       For more details about advanced counting sequences and waveform generation, see ”Modes of Operation” on
       page 131.
       The Timer/Counter Overflow Flag (TOV1) is set according to the mode of operation selected by the WGM13:0
       bits. TOV1 can be used for generating a CPU interrupt.

16.6   Input Capture Unit
       The Timer/Counter incorporates an Input Capture unit that can capture external events and give them a time-
       stamp indicating time of occurrence. The external signal indicating an event, or multiple events, can be applied
       via the ICP1 pin or alternatively, via the analog-comparator unit. The time-stamps can then be used to calculate
       frequency, duty-cycle, and other features of the signal applied. Alternatively the time-stamps can be used for
       creating a log of the events.




        2020 Microchip Technology Inc.                                Data Sheet Complete                                       DS40002061B-page 126
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

       The Input Capture unit is illustrated by the block diagram shown in Figure 16-3. The elements of the block
       diagram that are not directly a part of the Input Capture unit are gray shaded. The small “n” in register and bit
       names indicates the Timer/Counter number.

       Figure 16-3.   Input Capture Unit Block Diagram
                                                                       DATA BUS           (8-bit)




                                     TEMP (8-bit)




                                     ICRnH (8-bit)           ICRnL (8-bit)                   TCNTnH (8-bit)        TCNTnL (8-bit)

                                 WRITE       ICRn (16-bit Register)                                 TCNTn (16-bit Counter)




                                                ACO*              ACIC*          ICNC                   ICES


                                           Analog
                                         Comparator                             Noise                   Edge
                                                                                                                             ICFn (Int.Req.)
                                                                               Canceler                Detector
                          ICPn



       When a change of the logic level (an event) occurs on the Input Capture pin (ICP1), alternatively on the Analog
       Comparator output (ACO), and this change confirms to the setting of the edge detector, a capture will be
       triggered. When a capture is triggered, the 16-bit value of the counter (TCNT1) is written to the Input Capture
       Register (ICR1). The Input Capture Flag (ICF1) is set at the same system clock as the TCNT1 value is copied
       into ICR1 Register. If enabled (ICIE1 = 1), the Input Capture Flag generates an Input Capture interrupt. The
       ICF1 Flag is automatically cleared when the interrupt is executed. Alternatively the ICF1 Flag can be cleared by
       software by writing a logical one to its I/O bit location.
       Reading the 16-bit value in the Input Capture Register (ICR1) is done by first reading the low byte (ICR1L) and
       then the high byte (ICR1H). When the low byte is read the high byte is copied into the high byte temporary
       register (TEMP). When the CPU reads the ICR1H I/O location it will access the TEMP Register.
       The ICR1 Register can only be written when using a Waveform Generation mode that utilizes the ICR1 Register
       for defining the counter’s TOP value. In these cases the Waveform Generation mode (WGM13:0) bits must be
       set before the TOP value can be written to the ICR1 Register. When writing the ICR1 Register the high byte
       must be written to the ICR1H I/O location before the low byte is written to ICR1L.
       For more information on how to access the 16-bit registers refer to ”Accessing 16-bit Registers” on page 122.

16.6.1 Input Capture Trigger Source
       The main trigger source for the Input Capture unit is the Input Capture pin (ICP1). Timer/Counter1 can
       alternatively use the Analog Comparator output as trigger source for the Input Capture unit. The Analog
       Comparator is selected as trigger source by setting the Analog Comparator Input Capture (ACIC) bit in the
       Analog Comparator Control and Status Register (ACSR). Be aware that changing trigger source can trigger a
       capture. The Input Capture Flag must therefore be cleared after the change.
       Both the Input Capture pin (ICP1) and the Analog Comparator output (ACO) inputs are sampled using the same
       technique as for the T1 pin (Figure 17-1 on page 147). The edge detector is also identical. However, when the
       noise canceler is enabled, additional logic is inserted before the edge detector, which increases the delay by



        2020 Microchip Technology Inc.                                      Data Sheet Complete                                       DS40002061B-page 127
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

       four system clock cycles. Note that the input of the noise canceler and edge detector is always enabled unless
       the Timer/Counter is set in a Waveform Generation mode that uses ICR1 to define TOP.
       An Input Capture can be triggered by software by controlling the port of the ICP1 pin.

16.6.2 Noise Canceler
       The noise canceler improves noise immunity by using a simple digital filtering scheme. The noise canceler input
       is monitored over four samples, and all four must be equal for changing the output that in turn is used by the
       edge detector.
       The noise canceler is enabled by setting the Input Capture Noise Canceler (ICNC1) bit in Timer/Counter Control
       Register B (TCCR1B). When enabled the noise canceler introduces additional four system clock cycles of delay
       from a change applied to the input, to the update of the ICR1 Register. The noise canceler uses the system
       clock and is therefore not affected by the prescaler.

16.6.3 Using the Input Capture Unit
       The main challenge when using the Input Capture unit is to assign enough processor capacity for handling the
       incoming events. The time between two events is critical. If the processor has not read the captured value in the
       ICR1 Register before the next event occurs, the ICR1 will be overwritten with a new value. In this case the result
       of the capture will be incorrect.
       When using the Input Capture interrupt, the ICR1 Register should be read as early in the interrupt handler
       routine as possible. Even though the Input Capture interrupt has relatively high priority, the maximum interrupt
       response time is dependent on the maximum number of clock cycles it takes to handle any of the other interrupt
       requests.
       Using the Input Capture unit in any mode of operation when the TOP value (resolution) is actively changed
       during operation, is not recommended.
       Measurement of an external signal’s duty cycle requires that the trigger edge is changed after each capture.
       Changing the edge sensing must be done as early as possible after the ICR1 Register has been read. After a
       change of the edge, the Input Capture Flag (ICF1) must be cleared by software (writing a logical one to the I/O
       bit location). For measuring frequency only, the clearing of the ICF1 Flag is not required (if an interrupt handler
       is used).

16.7   Output Compare Units
       The 16-bit comparator continuously compares TCNT1 with the Output Compare Register (OCR1x). If TCNT
       equals OCR1x the comparator signals a match. A match will set the Output Compare Flag (OCF1x) at the next
       timer clock cycle. If enabled (OCIE1x = 1), the Output Compare Flag generates an Output Compare interrupt.
       The OCF1x Flag is automatically cleared when the interrupt is executed. Alternatively the OCF1x Flag can be
       cleared by software by writing a logical one to its I/O bit location. The Waveform Generator uses the match
       signal to generate an output according to operating mode set by the Waveform Generation mode (WGM13:0)
       bits and Compare Output mode (COM1x1:0) bits. The TOP and BOTTOM signals are used by the Waveform
       Generator for handling the special cases of the extreme values in some modes of operation (see ”Modes of
       Operation” on page 131.)
       A special feature of Output Compare unit A allows it to define the Timer/Counter TOP value (i.e., counter
       resolution). In addition to the counter resolution, the TOP value defines the period time for waveforms generated
       by the Waveform Generator.
       Figure 16-4 shows a block diagram of the Output Compare unit. The small “n” in the register and bit names
       indicates the device number (n = 1 for Timer/Counter 1), and the “x” indicates Output Compare unit (A/B). The
       elements of the block diagram that are not directly a part of the Output Compare unit are gray shaded.




        2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 128
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 16-4.    Output Compare Unit, Block Diagram
                                                                      DATA BUS          (8-bit)




                                                 TEMP (8-bit)




                                          OCRnxH Buf. (8-bit)   OCRnxL Buf. (8-bit)               TCNTnH (8-bit)        TCNTnL (8-bit)

                                               OCRnx Buffer (16-bit Register)                            TCNTn (16-bit Counter)




                                            OCRnxH (8-bit)        OCRnxL (8-bit)

                                                   OCRnx (16-bit Register)


                                                                                = (16-bit Comparator )
                                                                                                   OCFnx (Int.Req.)

                                                 TOP
                                                                             Waveform Generator                                          OCnx
                                               BOTTOM


                                                                             WGMn3:0         COMnx1:0



      The OCR1x Register is double buffered when using any of the twelve Pulse Width Modulation (PWM) modes.
      For the Normal and Clear Timer on Compare (CTC) modes of operation, the double buffering is disabled. The
      double buffering synchronizes the update of the OCR1x Compare Register to either TOP or BOTTOM of the
      counting sequence. The synchronization prevents the occurrence of odd-length, non-symmetrical PWM pulses,
      thereby making the output glitch-free.
      The OCR1x Register access may seem complex, but this is not case. When the double buffering is enabled, the
      CPU has access to the OCR1x Buffer Register, and if double buffering is disabled the CPU will access the
      OCR1x directly. The content of the OCR1x (Buffer or Compare) Register is only changed by a write operation
      (the Timer/Counter does not update this register automatically as the TCNT1 and ICR1 Register). Therefore
      OCR1x is not read via the high byte temporary register (TEMP). However, it is a good practice to read the low
      byte first as when accessing other 16-bit registers. Writing the OCR1x Registers must be done via the TEMP
      Register since the compare of all 16 bits is done continuously. The high byte (OCR1xH) has to be written first.
      When the high byte I/O location is written by the CPU, the TEMP Register will be updated by the value written.
      Then when the low byte (OCR1xL) is written to the lower eight bits, the high byte will be copied into the upper 8-
      bits of either the OCR1x buffer or OCR1x Compare Register in the same system clock cycle.
      For more information of how to access the 16-bit registers refer to ”Accessing 16-bit Registers” on page 122.

16.7.1 Force Output Compare
      In non-PWM Waveform Generation modes, the match output of the comparator can be forced by writing a one
      to the Force Output Compare (FOC1x) bit. Forcing compare match will not set the OCF1x Flag or reload/clear
      the timer, but the OC1x pin will be updated as if a real compare match had occurred (the COM11:0 bits settings
      define whether the OC1x pin is set, cleared or toggled).

16.7.2 Compare Match Blocking by TCNT1 Write
      All CPU writes to the TCNT1 Register will block any compare match that occurs in the next timer clock cycle,
      even when the timer is stopped. This feature allows OCR1x to be initialized to the same value as TCNT1 without
      triggering an interrupt when the Timer/Counter clock is enabled.




        2020 Microchip Technology Inc.                              Data Sheet Complete                                           DS40002061B-page 129
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

16.7.3 Using the Output Compare Unit
       Since writing TCNT1 in any mode of operation will block all compare matches for one timer clock cycle, there
       are risks involved when changing TCNT1 when using any of the Output Compare channels, independent of
       whether the Timer/Counter is running or not. If the value written to TCNT1 equals the OCR1x value, the
       compare match will be missed, resulting in incorrect waveform generation. Do not write the TCNT1 equal to
       TOP in PWM modes with variable TOP values. The compare match for the TOP will be ignored and the counter
       will continue to 0xFFFF. Similarly, do not write the TCNT1 value equal to BOTTOM when the counter is
       downcounting.
       The setup of the OC1x should be performed before setting the Data Direction Register for the port pin to output.
       The easiest way of setting the OC1x value is to use the Force Output Compare (FOC1x) strobe bits in Normal
       mode. The OC1x Register keeps its value even when changing between Waveform Generation modes.
       Be aware that the COM1x1:0 bits are not double buffered together with the compare value. Changing the
       COM1x1:0 bits will take effect immediately.



16.8   Compare Match Output Unit
       The Compare Output mode (COM1x1:0) bits have two functions. The Waveform Generator uses the COM1x1:0
       bits for defining the Output Compare (OC1x) state at the next compare match. Secondly the COM1x1:0 bits
       control the OC1x pin output source. Figure 16-5 shows a simplified schematic of the logic affected by the
       COM1x1:0 bit setting. The I/O Registers, I/O bits, and I/O pins in the figure are shown in bold. Only the parts of
       the general I/O Port Control Registers (DDR and PORT) that are affected by the COM1x1:0 bits are shown.
       When referring to the OC1x state, the reference is for the internal OC1x Register, not the OC1x pin. If a system
       reset occur, the OC1x Register is reset to “0”.

       Figure 16-5.   Compare Match Output Unit, Schematic



                      COMnx1
                      COMnx0              Waveform
                                                            D   Q
                      FOCnx               Generator
                                                                                  1
                                                                                                     OCnx
                                                            OCnx                                     Pin
                                                                                  0

                                                            D   Q
                                                 DATA BUS




                                                            PORT

                                                            D   Q



                                                            DDR
                      clk I/O


       The general I/O port function is overridden by the Output Compare (OC1x) from the Waveform Generator if
       either of the COM1x1:0 bits are set. However, the OC1x pin direction (input or output) is still controlled by the
       Data Direction Register (DDR) for the port pin. The Data Direction Register bit for the OC1x pin (DDR_OC1x)




        2020 Microchip Technology Inc.                     Data Sheet Complete                      DS40002061B-page 130
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

       must be set as output before the OC1x value is visible on the pin. The port override function is generally
       independent of the Waveform Generation mode, but there are some exceptions. Refer to Table 16-1 on page
       140, Table 16-2 on page 140 and Table 16-3 on page 141 for details.
       The design of the Output Compare pin logic allows initialization of the OC1x state before the output is enabled.
       Note that some COM1x1:0 bit settings are reserved for certain modes of operation. See ”Register Description”
       on page 140.
       The COM1x1:0 bits have no effect on the Input Capture unit.

16.8.1 Compare Output Mode and Waveform Generation
       The Waveform Generator uses the COM1x1:0 bits differently in normal, CTC, and PWM modes. For all modes,
       setting the COM1x1:0 = 0 tells the Waveform Generator that no action on the OC1x Register is to be performed
       on the next compare match. For compare output actions in the non-PWM modes refer to Table 16-1 on page
       140. For fast PWM mode refer to Table 16-2 on page 140, and for phase correct and phase and frequency
       correct PWM refer to Table 16-3 on page 141.
       A change of the COM1x1:0 bits state will have effect at the first compare match after the bits are written. For
       non-PWM modes, the action can be forced to have immediate effect by using the FOC1x strobe bits.

16.9   Modes of Operation
       The mode of operation, i.e., the behavior of the Timer/Counter and the Output Compare pins, is defined by the
       combination of the Waveform Generation mode (WGM13:0) and Compare Output mode (COM1x1:0) bits. The
       Compare Output mode bits do not affect the counting sequence, while the Waveform Generation mode bits do.
       The COM1x1:0 bits control whether the PWM output generated should be inverted or not (inverted or non-
       inverted PWM). For non-PWM modes the COM1x1:0 bits control whether the output should be set, cleared or
       toggle at a compare match (See “Compare Match Output Unit” on page 130.)
       For detailed timing information refer to ”Timer/Counter Timing Diagrams” on page 138.

16.9.1 Normal Mode
       The simplest mode of operation is the Normal mode (WGM13:0 = 0). In this mode the counting direction is
       always up (incrementing), and no counter clear is performed. The counter simply overruns when it passes its
       maximum 16-bit value (MAX = 0xFFFF) and then restarts from the BOTTOM (0x0000). In normal operation the
       Timer/Counter Overflow Flag (TOV1) will be set in the same timer clock cycle as the TCNT1 becomes zero. The
       TOV1 Flag in this case behaves like a 17th bit, except that it is only set, not cleared. However, combined with
       the timer overflow interrupt that automatically clears the TOV1 Flag, the timer resolution can be increased by
       software. There are no special cases to consider in the Normal mode, a new counter value can be written
       anytime.
       The Input Capture unit is easy to use in Normal mode. However, observe that the maximum interval between
       the external events must not exceed the resolution of the counter. If the interval between events are too long,
       the timer overflow interrupt or the prescaler must be used to extend the resolution for the capture unit.
       The Output Compare units can be used to generate interrupts at some given time. Using the Output Compare to
       generate waveforms in Normal mode is not recommended, since this will occupy too much of the CPU time.

16.9.2 Clear Timer on Compare Match (CTC) Mode
       In Clear Timer on Compare or CTC mode (WGM13:0 = 4 or 12), the OCR1A or ICR1 Register are used to
       manipulate the counter resolution. In CTC mode the counter is cleared to zero when the counter value (TCNT1)
       matches either the OCR1A (WGM13:0 = 4) or the ICR1 (WGM13:0 = 12). The OCR1A or ICR1 define the top
       value for the counter, hence also its resolution. This mode allows greater control of the compare match output
       frequency. It also simplifies the operation of counting external events.




        2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 131
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

      The timing diagram for the CTC mode is shown in Figure 16-6. The counter value (TCNT1) increases until a
      compare match occurs with either OCR1A or ICR1, and then counter (TCNT1) is cleared.

      Figure 16-6.    CTC Mode, Timing Diagram

                                                                                                                OCnA Interrupt Flag Set
                                                                                                                or ICFn Interrupt Flag Set
                                                                                                                (Interrupt on TOP)




                     TCNTn


                     OCnA
                                                                                                                (COMnA1:0 = 1)
                     (Toggle)

                     Period              1           2                  3                 4


      An interrupt can be generated at each time the counter value reaches the TOP value by either using the OCF1A
      or ICF1 Flag according to the register used to define the TOP value. If the interrupt is enabled, the interrupt
      handler routine can be used for updating the TOP value. However, changing the TOP to a value close to
      BOTTOM when the counter is running with none or a low prescaler value must be done with care since the CTC
      mode does not have the double buffering feature. If the new value written to OCR1A or ICR1 is lower than the
      current value of TCNT1, the counter will miss the compare match. The counter will then have to count to its
      maximum value (0xFFFF) and wrap around starting at 0x0000 before the compare match can occur. In many
      cases this feature is not desirable. An alternative will then be to use the fast PWM mode using OCR1A for
      defining TOP (WGM13:0 = 15) since the OCR1A then will be double buffered.
      For generating a waveform output in CTC mode, the OC1A output can be set to toggle its logical level on each
      compare match by setting the Compare Output mode bits to toggle mode (COM1A1:0 = 1). The OC1A value will
      not be visible on the port pin unless the data direction for the pin is set to output (DDR_OC1A = 1). The
      waveform generated will have a maximum frequency of fOC1A = fclk_I/O/2 when OCR1A is set to zero (0x0000).
      The waveform frequency is defined by the following equation:
                                                                           f clk_I/O
                                                 f OCnA = ---------------------------------------------------
                                                          2  N   1 + OCRnA 

      The N variable represents the prescaler factor (1, 8, 64, 256, or 1024).
      As for the Normal mode of operation, the TOV1 Flag is set in the same timer clock cycle that the counter counts
      from MAX to 0x0000.

16.9.3 Fast PWM Mode
      The fast Pulse Width Modulation or fast PWM mode (WGM13:0 = 5, 6, 7, 14, or 15) provides a high frequency
      PWM waveform generation option. The fast PWM differs from the other PWM options by its single-slope
      operation. The counter counts from BOTTOM to TOP then restarts from BOTTOM. In non-inverting Compare
      Output mode, the Output Compare (OC1x) is cleared on the compare match between TCNT1 and OCR1x, and
      set at BOTTOM. In inverting Compare Output mode output is set on compare match and cleared at BOTTOM.
      Due to the single-slope operation, the operating frequency of the fast PWM mode can be twice as high as the
      phase correct and phase and frequency correct PWM modes that use dual-slope operation. This high frequency
      makes the fast PWM mode well suited for power regulation, rectification, and DAC applications. High frequency
      allows physically small sized external components (coils, capacitors), hence reduces total system cost.




       2020 Microchip Technology Inc.                                Data Sheet Complete                                        DS40002061B-page 132
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

The PWM resolution for fast PWM can be fixed to 8-, 9-, or 10-bit, or defined by either ICR1 or OCR1A. The
minimum resolution allowed is 2-bit (ICR1 or OCR1A set to 0x0003), and the maximum resolution is 16-bit
(ICR1 or OCR1A set to MAX). The PWM resolution in bits can be calculated by using the following equation:
                                                       log  TOP + 1 
                                              R FPWM = -----------------------------------
                                                                log  2 
In fast PWM mode the counter is incremented until the counter value matches either one of the fixed values
0x00FF, 0x01FF, or 0x03FF (WGM13:0 = 5, 6, or 7), the value in ICR1 (WGM13:0 = 14), or the value in OCR1A
(WGM13:0 = 15). The counter is then cleared at the following timer clock cycle. The timing diagram for the fast
PWM mode is shown in Figure 16-7. The figure shows fast PWM mode when OCR1A or ICR1 is used to define
TOP. The TCNT1 value is in the timing diagram shown as a histogram for illustrating the single-slope operation.
The diagram includes non-inverted and inverted PWM outputs. The small horizontal line marks on the TCNT1
slopes represent compare matches between OCR1x and TCNT1. The OC1x Interrupt Flag will be set when a
compare match occurs.

Figure 16-7.   Fast PWM Mode, Timing Diagram

                                                                                                 OCRnx/TOP Update and
                                                                                                 TOVn Interrupt Flag Set and
                                                                                                 OCnA Interrupt Flag Set
                                                                                                 or ICFn Interrupt Flag Set
                                                                                                 (Interrupt on TOP)




               TCNTn



               OCnx                                                                               (COMnx1:0 = 2)


               OCnx                                                                               (COMnx1:0 = 3)



               Period        1     2      3            4        5    6          7            8


The Timer/Counter Overflow Flag (TOV1) is set each time the counter reaches TOP. In addition the OC1A or
ICF1 Flag is set at the same timer clock cycle as TOV1 is set when either OCR1A or ICR1 is used for defining
the TOP value. If one of the interrupts are enabled, the interrupt handler routine can be used for updating the
TOP and compare values.
When changing the TOP value the program must ensure that the new TOP value is higher or equal to the value
of all of the Compare Registers. If the TOP value is lower than any of the Compare Registers, a compare match
will never occur between the TCNT1 and the OCR1x. Note that when using fixed TOP values the unused bits
are masked to zero when any of the OCR1x Registers are written.
The procedure for updating ICR1 differs from updating OCR1A when used for defining the TOP value. The ICR1
Register is not double buffered. This means that if ICR1 is changed to a low value when the counter is running
with none or a low prescaler value, there is a risk that the new ICR1 value written is lower than the current value
of TCNT1. The result will then be that the counter will miss the compare match at the TOP value. The counter
will then have to count to the MAX value (0xFFFF) and wrap around starting at 0x0000 before the compare
match can occur. The OCR1A Register however, is double buffered. This feature allows the OCR1A I/O location
to be written anytime. When the OCR1A I/O location is written the value written will be put into the OCR1A
Buffer Register. The OCR1A Compare Register will then be updated with the value in the Buffer Register at the
next timer clock cycle the TCNT1 matches TOP. The update is done at the same timer clock cycle as the
TCNT1 is cleared and the TOV1 Flag is set.
Using the ICR1 Register for defining TOP works well when using fixed TOP values. By using ICR1, the OCR1A
Register is free to be used for generating a PWM output on OC1A. However, if the base PWM frequency is



 2020 Microchip Technology Inc.                            Data Sheet Complete                                    DS40002061B-page 133
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

      actively changed (by changing the TOP value), using the OCR1A as TOP is clearly a better choice due to its
      double buffer feature.
      In fast PWM mode, the compare units allow generation of PWM waveforms on the OC1x pins. Setting the
      COM1x1:0 bits to three will produce a inverted PWM and an non-inverted PWM output can be generated by
      setting the COM1x1:0 to two (see Table 16-2 on page 140). The actual OC1x value will only be visible on the
      port pin if the data direction for the port pin is set as output (DDR_OC1x). The PWM waveform is generated by
      setting (or clearing) the OC1x Register at the compare match between OCR1x and TCNT1, and clearing (or
      setting) the OC1x Register at the timer clock cycle the counter is cleared (changes from TOP to BOTTOM).
      The PWM frequency for the output can be calculated by the following equation:
                                                                      f clk_I/O
                                                 f OCnxPWM = -----------------------------------
                                                             N   1 + TOP 

      The N variable represents the prescaler divider (1, 8, 64, 256, or 1024).
      The extreme values for the OCR1x Register represents special cases when generating a PWM waveform
      output in the fast PWM mode. If the OCR1x is set equal to BOTTOM (0x0000) the output will be a narrow spike
      for each TOP+1 timer clock cycle. Setting the OCR1x equal to TOP will result in a constant high or low output
      (depending on the polarity of the output set by the COM1x1:0 bits.)
      A frequency (with 50% duty cycle) waveform output in fast PWM mode can be achieved by setting OC1A to
      toggle its logical level on each compare match (COM1A1:0 = 1). This applies only if OCR1A is used to define
      the TOP value (WGM13:0 = 15). The waveform generated will have a maximum frequency of fOC1A = fclk_I/O/2
      when OCR1A is set to zero (0x0000). This feature is similar to the OC1A toggle in CTC mode, except the double
      buffer feature of the Output Compare unit is enabled in the fast PWM mode.

16.9.4 Phase Correct PWM Mode
      The phase correct Pulse Width Modulation or phase correct PWM mode (WGM13:0 = 1, 2, 3, 10, or 11)
      provides a high resolution phase correct PWM waveform generation option. The phase correct PWM mode is,
      like the phase and frequency correct PWM mode, based on a dual-slope operation. The counter counts
      repeatedly from BOTTOM (0x0000) to TOP and then from TOP to BOTTOM. In non-inverting Compare Output
      mode, the Output Compare (OC1x) is cleared on the compare match between TCNT1 and OCR1x while
      upcounting, and set on the compare match while downcounting. In inverting Output Compare mode, the
      operation is inverted. The dual-slope operation has lower maximum operation frequency than single slope
      operation. However, due to the symmetric feature of the dual-slope PWM modes, these modes are preferred for
      motor control applications.
      The PWM resolution for the phase correct PWM mode can be fixed to 8-, 9-, or 10-bit, or defined by either ICR1
      or OCR1A. The minimum resolution allowed is 2-bit (ICR1 or OCR1A set to 0x0003), and the maximum
      resolution is 16-bit (ICR1 or OCR1A set to MAX). The PWM resolution in bits can be calculated by using the
      following equation:

                                                            log  TOP + 1 
                                                  R PCPWM = -----------------------------------
                                                                     log  2 

      In phase correct PWM mode the counter is incremented until the counter value matches either one of the fixed
      values 0x00FF, 0x01FF, or 0x03FF (WGM13:0 = 1, 2, or 3), the value in ICR1 (WGM13:0 = 10), or the value in
      OCR1A (WGM13:0 = 11). The counter has then reached the TOP and changes the count direction. The TCNT1
      value will be equal to TOP for one timer clock cycle. The timing diagram for the phase correct PWM mode is
      shown on Figure 16-8 on page 135. The figure shows phase correct PWM mode when OCR1A or ICR1 is used
      to define TOP. The TCNT1 value is in the timing diagram shown as a histogram for illustrating the dual-slope
      operation. The diagram includes non-inverted and inverted PWM outputs. The small horizontal line marks on




       2020 Microchip Technology Inc.                           Data Sheet Complete               DS40002061B-page 134
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

the TCNT1 slopes represent compare matches between OCR1x and TCNT1. The OC1x Interrupt Flag will be
set when a compare match occurs.

Figure 16-8.    Phase Correct PWM Mode, Timing Diagram

                                                                                            OCRnx/TOP Update and
                                                                                            OCnA Interrupt Flag Set
                                                                                            or ICFn Interrupt Flag Set
                                                                                            (Interrupt on TOP)



                                                                                            TOVn Interrupt Flag Set
                                                                                            (Interrupt on Bottom)




               TCNTn



               OCnx                                                                                     (COMnx1:0 = 2)


               OCnx                                                                                     (COMnx1:0 = 3)



               Period                1               2                 3                4



The Timer/Counter Overflow Flag (TOV1) is set each time the counter reaches BOTTOM. When either OCR1A
or ICR1 is used for defining the TOP value, the OC1A or ICF1 Flag is set accordingly at the same timer clock
cycle as the OCR1x Registers are updated with the double buffer value (at TOP). The Interrupt Flags can be
used to generate an interrupt each time the counter reaches the TOP or BOTTOM value.
When changing the TOP value the program must ensure that the new TOP value is higher or equal to the value
of all of the Compare Registers. If the TOP value is lower than any of the Compare Registers, a compare match
will never occur between the TCNT1 and the OCR1x. Note that when using fixed TOP values, the unused bits
are masked to zero when any of the OCR1x Registers are written. As the third period shown in Figure 16-8 on
page 135 illustrates, changing the TOP actively while the Timer/Counter is running in the phase correct mode
can result in an unsymmetrical output. The reason for this can be found in the time of update of the OCR1x
Register. Since the OCR1x update occurs at TOP, the PWM period starts and ends at TOP. This implies that
the length of the falling slope is determined by the previous TOP value, while the length of the rising slope is
determined by the new TOP value. When these two values differ the two slopes of the period will differ in length.
The difference in length gives the unsymmetrical result on the output.
It is recommended to use the phase and frequency correct mode instead of the phase correct mode when
changing the TOP value while the Timer/Counter is running. When using a static TOP value there are practically
no differences between the two modes of operation.
In phase correct PWM mode, the compare units allow generation of PWM waveforms on the OC1x pins. Setting
the COM1x1:0 bits to two will produce a non-inverted PWM and an inverted PWM output can be generated by
setting the COM1x1:0 to three (See Table 16-3 on page 141). The actual OC1x value will only be visible on the
port pin if the data direction for the port pin is set as output (DDR_OC1x). The PWM waveform is generated by
setting (or clearing) the OC1x Register at the compare match between OCR1x and TCNT1 when the counter
increments, and clearing (or setting) the OC1x Register at compare match between OCR1x and TCNT1 when
the counter decrements. The PWM frequency for the output when using phase correct PWM can be calculated
by the following equation:
                                                               f clk_I/O
                                           f OCnxPCPWM = ----------------------------
                                                         2  N  TOP




 2020 Microchip Technology Inc.                         Data Sheet Complete                                 DS40002061B-page 135
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

      The N variable represents the prescaler divider (1, 8, 64, 256, or 1024).
      The extreme values for the OCR1x Register represent special cases when generating a PWM waveform output
      in the phase correct PWM mode. If the OCR1x is set equal to BOTTOM the output will be continuously low and
      if set equal to TOP the output will be continuously high for non-inverted PWM mode. For inverted PWM the
      output will have the opposite logic values. If OCR1A is used to define the TOP value (WGM13:0 = 11) and
      COM1A1:0 = 1, the OC1A output will toggle with a 50% duty cycle.

16.9.5 Phase and Frequency Correct PWM Mode
      The phase and frequency correct Pulse Width Modulation, or phase and frequency correct PWM mode
      (WGM13:0 = 8 or 9) provides a high resolution phase and frequency correct PWM waveform generation option.
      The phase and frequency correct PWM mode is, like the phase correct PWM mode, based on a dual-slope
      operation. The counter counts repeatedly from BOTTOM (0x0000) to TOP and then from TOP to BOTTOM. In
      non-inverting Compare Output mode, the Output Compare (OC1x) is cleared on the compare match between
      TCNT1 and OCR1x while upcounting, and set on the compare match while downcounting. In inverting Compare
      Output mode, the operation is inverted. The dual-slope operation gives a lower maximum operation frequency
      compared to the single-slope operation. However, due to the symmetric feature of the dual-slope PWM modes,
      these modes are preferred for motor control applications.
      The main difference between the phase correct, and the phase and frequency correct PWM mode is the time
      the OCR1x Register is updated by the OCR1x Buffer Register, (see Figure 16-8 on page 135 and Figure 16-9
      on page 137).
      The PWM resolution for the phase and frequency correct PWM mode can be defined by either ICR1 or OCR1A.
      The minimum resolution allowed is 2-bit (ICR1 or OCR1A set to 0x0003), and the maximum resolution is 16-bit
      (ICR1 or OCR1A set to MAX). The PWM resolution in bits can be calculated using the following equation:

                                                            log  TOP + 1 
                                                 R PFCPWM = -----------------------------------
                                                                     log  2 

      In phase and frequency correct PWM mode the counter is incremented until the counter value matches either
      the value in ICR1 (WGM13:0 = 8), or the value in OCR1A (WGM13:0 = 9). The counter has then reached the
      TOP and changes the count direction. The TCNT1 value will be equal to TOP for one timer clock cycle. The
      timing diagram for the phase correct and frequency correct PWM mode is shown on Figure 16-9 on page 137.
      The figure shows phase and frequency correct PWM mode when OCR1A or ICR1 is used to define TOP. The
      TCNT1 value is in the timing diagram shown as a histogram for illustrating the dual-slope operation. The
      diagram includes non-inverted and inverted PWM outputs. The small horizontal line marks on the TCNT1 slopes
      represent compare matches between OCR1x and TCNT1. The OC1x Interrupt Flag will be set when a compare
      match occurs.




       2020 Microchip Technology Inc.                          Data Sheet Complete               DS40002061B-page 136
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 16-9.   Phase and Frequency Correct PWM Mode, Timing Diagram

                                                                                       OCnA Interrupt Flag Set
                                                                                       or ICFn Interrupt Flag Set
                                                                                       (Interrupt on TOP)



                                                                                       OCRnx/TOP Updateand
                                                                                       TOVn Interrupt Flag Set
                                                                                       (Interrupt on Bottom)




               TCNTn



               OCnx                                                                    (COMnx1:0 = 2)


               OCnx                                                                    (COMnx1:0 = 3)



               Period              1           2               3                  4



The Timer/Counter Overflow Flag (TOV1) is set at the same timer clock cycle as the OCR1x Registers are
updated with the double buffer value (at BOTTOM). When either OCR1A or ICR1 is used for defining the TOP
value, the OC1A or ICF1 Flag set when TCNT1 has reached TOP. The Interrupt Flags can then be used to
generate an interrupt each time the counter reaches the TOP or BOTTOM value.
When changing the TOP value the program must ensure that the new TOP value is higher or equal to the value
of all of the Compare Registers. If the TOP value is lower than any of the Compare Registers, a compare match
will never occur between the TCNT1 and the OCR1x.
As Figure 16-9 on page 137 shows the output generated is, in contrast to the phase correct mode, symmetrical
in all periods. Since the OCR1x Registers are updated at BOTTOM, the length of the rising and the falling
slopes will always be equal. This gives symmetrical output pulses and is therefore frequency correct.
Using the ICR1 Register for defining TOP works well when using fixed TOP values. By using ICR1, the OCR1A
Register is free to be used for generating a PWM output on OC1A. However, if the base PWM frequency is
actively changed by changing the TOP value, using the OCR1A as TOP is clearly a better choice due to its
double buffer feature.
In phase and frequency correct PWM mode, the compare units allow generation of PWM waveforms on the
OC1x pins. Setting the COM1x1:0 bits to two will produce a non-inverted PWM and an inverted PWM output can
be generated by setting the COM1x1:0 to three (See Table 16-3 on page 141). The actual OC1x value will only
be visible on the port pin if the data direction for the port pin is set as output (DDR_OC1x). The PWM waveform
is generated by setting (or clearing) the OC1x Register at the compare match between OCR1x and TCNT1
when the counter increments, and clearing (or setting) the OC1x Register at compare match between OCR1x
and TCNT1 when the counter decrements. The PWM frequency for the output when using phase and frequency
correct PWM can be calculated by the following equation:

                                                              f clk_I/O
                                         f OCnxPFCPWM = ----------------------------
                                                        2  N  TOP

The N variable represents the prescaler divider (1, 8, 64, 256, or 1024).
The extreme values for the OCR1x Register represents special cases when generating a PWM waveform
output in the phase correct PWM mode. If the OCR1x is set equal to BOTTOM the output will be continuously
low and if set equal to TOP the output will be set to high for non-inverted PWM mode. For inverted PWM the




 2020 Microchip Technology Inc.                         Data Sheet Complete                            DS40002061B-page 137
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

     output will have the opposite logic values. If OCR1A is used to define the TOP value (WGM13:0 = 9) and
     COM1A1:0 = 1, the OC1A output will toggle with a 50% duty cycle.

16.10 Timer/Counter Timing Diagrams
     The Timer/Counter is a synchronous design and the timer clock (clkT1) is therefore shown as a clock enable
     signal in the following figures. The figures include information on when Interrupt Flags are set, and when the
     OCR1x Register is updated with the OCR1x buffer value (only for modes utilizing double buffering). Figure 16-
     10 shows a timing diagram for the setting of OCF1x.

     Figure 16-10. Timer/Counter Timing Diagram, Setting of OCF1x, no Prescaling


                        clkI/O


                        clkTn
                       (clkI/O /1)


                       TCNTn              OCRnx - 1      OCRnx             OCRnx + 1        OCRnx + 2


                       OCRnx                                OCRnx Value


                       OCFnx



     Figure 16-11 shows the same timing data, but with the prescaler enabled.

     Figure 16-11. Timer/Counter Timing Diagram, Setting of OCF1x, with Prescaler (fclk_I/O/8)


                        clkI/O


                         clkTn
                       (clkI/O /8)


                       TCNTn             OCRnx - 1      OCRnx             OCRnx + 1         OCRnx + 2


                       OCRnx                                OCRnx Value


                       OCFnx



     Figure 16-12 on page 139 shows the count sequence close to TOP in various modes. When using phase and
     frequency correct PWM mode the OCR1x Register is updated at BOTTOM. The timing diagrams will be the
     same, but TOP should be replaced by BOTTOM, TOP-1 by BOTTOM+1 and so on. The same renaming applies
     for modes that set the TOV1 Flag at BOTTOM.




       2020 Microchip Technology Inc.                    Data Sheet Complete                     DS40002061B-page 138
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 16-12. Timer/Counter Timing Diagram, no Prescaling.

                      clkI/O


                      clkTn
                     (clkI/O /1)


                     TCNTn
                                      TOP - 1               TOP            BOTTOM       BOTTOM + 1
                 (CTC and FPWM)

                     TCNTn
                                      TOP - 1               TOP            TOP - 1        TOP - 2
                (PC and PFC PWM)

                 TOVn (FPWM)
                and ICFn (if used
                     as TOP)

                     OCRnx
                                          Old OCRnx Value                     New OCRnx Value
                 (Update at TOP)



Figure 16-13 shows the same timing data, but with the prescaler enabled.

Figure 16-13. Timer/Counter Timing Diagram, with Prescaler (fclk_I/O/8)


                       clkI/O


                       clkTn
                     (clkI/O/8)


                     TCNTn
                                      TOP - 1              TOP             BOTTOM       BOTTOM + 1
                  (CTC and FPWM)

                     TCNTn            TOP - 1              TOP             TOP - 1        TOP - 2
                 (PC and PFC PWM)

                 TOVn (FPWM)
               and ICF n (if used
                     as TOP)

                     OCRnx
                                         Old OCRnx Value                       New OCRnx Value
                   (Update at TOP)




 2020 Microchip Technology Inc.                     Data Sheet Complete                         DS40002061B-page 139
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P


16.11 Register Description

16.11.1 TCCR1A – Timer/Counter1 Control Register A
        Bit                      7           6           5          4           3          2           1             0
        (0x80)                COM1A1     COM1A0       COM1B1    COM1B0          –          –       WGM11       WGM10     TCCR1A
        Read/Write              R/W         R/W        R/W         R/W          R          R          R/W        R/W
        Initial Value            0           0           0          0           0          0           0             0


       • Bit 7:6 – COM1A1:0: Compare Output Mode for Channel A

       • Bit 5:4 – COM1B1:0: Compare Output Mode for Channel B
       The COM1A1:0 and COM1B1:0 control the Output Compare pins (OC1A and OC1B respectively) behavior. If
       one or both of the COM1A1:0 bits are written to one, the OC1A output overrides the normal port functionality of
       the I/O pin it is connected to. If one or both of the COM1B1:0 bit are written to one, the OC1B output overrides
       the normal port functionality of the I/O pin it is connected to. However, note that the Data Direction Register
       (DDR) bit corresponding to the OC1A or OC1B pin must be set in order to enable the output driver.
       When the OC1A or OC1B is connected to the pin, the function of the COM1x1:0 bits is dependent of the
       WGM13:0 bits setting. Table 16-1 shows the COM1x1:0 bit functionality when the WGM13:0 bits are set to a
       Normal or a CTC mode (non-PWM).

       Table 16-1.           Compare Output Mode, non-PWM
         COM1A1/COM1B1                   COM1A0/COM1B0         Description
                        0                         0            Normal port operation, OC1A/OC1B disconnected.
                        0                         1            Toggle OC1A/OC1B on Compare Match.
                                                               Clear OC1A/OC1B on Compare Match (Set output to
                        1                         0
                                                               low level).
                                                               Set OC1A/OC1B on Compare Match (Set output to
                        1                         1
                                                               high level).

       Table 16-2 shows the COM1x1:0 bit functionality when the WGM13:0 bits are set to the fast PWM mode.

       Table 16-2.           Compare Output Mode, Fast PWM(1)
         COM1A1/COM1B1                   COM1A0/COM1B0         Description
                        0                         0            Normal port operation, OC1A/OC1B disconnected.
                                                               WGM13:0 = 14 or 15: Toggle OC1A on Compare
                                                               Match, OC1B disconnected (normal port operation).
                        0                         1
                                                               For all other WGM1 settings, normal port operation,
                                                               OC1A/OC1B disconnected.
                                                               Clear OC1A/OC1B on Compare Match, set
                        1                         0
                                                               OC1A/OC1B at BOTTOM (non-inverting mode)
                                                               Set OC1A/OC1B on Compare Match, clear
                        1                         1
                                                               OC1A/OC1B at BOTTOM (inverting mode)

       Note:       1.       A special case occurs when OCR1A/OCR1B equals TOP and COM1A1/COM1B1 is set. In this case the
                            compare match is ignored, but the set or clear is done at BOTTOM. See ”Fast PWM Mode” on page 132 for
                            more details.




        2020 Microchip Technology Inc.                             Data Sheet Complete                         DS40002061B-page 140
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

        Table 16-3 shows the COM1x1:0 bit functionality when the WGM13:0 bits are set to the phase correct or the
        phase and frequency correct, PWM mode.

        Table 16-3.           Compare Output Mode, Phase Correct and Phase and Frequency Correct PWM(1)
              COM1A1/COM1B1             COM1A0/COM1B0         Description
                         0                      0             Normal port operation, OC1A/OC1B disconnected.
                                                              WGM13:0 = 9 or 11: Toggle OC1A on Compare
                                                              Match, OC1B disconnected (normal port operation).
                         0                      1
                                                              For all other WGM1 settings, normal port operation,
                                                              OC1A/OC1B disconnected.
                                                              Clear OC1A/OC1B on Compare Match when up-
                         1                      0             counting. Set OC1A/OC1B on Compare Match when
                                                              downcounting.
                                                              Set OC1A/OC1B on Compare Match when up-
                         1                      1             counting. Clear OC1A/OC1B on Compare Match
                                                              when downcounting.
        Note:       1.       A special case occurs when OCR1A/OCR1B equals TOP and COM1A1/COM1B1 is set. See ”Phase Correct
                             PWM Mode” on page 134 for more details.

        • Bit 1:0 – WGM11:0: Waveform Generation Mode
        Combined with the WGM13:2 bits found in the TCCR1B Register, these bits control the counting sequence of
        the counter, the source for maximum (TOP) counter value, and what type of waveform generation to be used,
        see Table 16-4. Modes of operation supported by the Timer/Counter unit are: Normal mode (counter), Clear
        Timer on Compare match (CTC) mode, and three types of Pulse Width Modulation (PWM) modes. (See ”Modes
        of Operation” on page 131).

Table 16-4.     Waveform Generation Mode Bit Description(1)
                              WGM12       WGM11      WGM10     Timer/Counter Mode of                         Update of   TOV1 Flag
 Mode     WGM13               (CTC1)     (PWM11)    (PWM10)    Operation                        TOP          OCR1x at    Set on
   0            0                0          0          0       Normal                           0xFFFF       Immediate   MAX
   1            0                0          0          1       PWM, Phase Correct, 8-bit        0x00FF       TOP         BOTTOM
   2            0                0          1          0       PWM, Phase Correct, 9-bit        0x01FF       TOP         BOTTOM
   3            0                0          1          1       PWM, Phase Correct, 10-bit       0x03FF       TOP         BOTTOM
   4            0                1          0          0       CTC                              OCR1A        Immediate   MAX
   5            0                1          0          1       Fast PWM, 8-bit                  0x00FF       BOTTOM      TOP
   6            0                1          1          0       Fast PWM, 9-bit                  0x01FF       BOTTOM      TOP
   7            0                1          1          1       Fast PWM, 10-bit                 0x03FF       BOTTOM      TOP
                                                               PWM, Phase and Frequency
   8            1                0          0          0                                        ICR1         BOTTOM      BOTTOM
                                                               Correct
                                                               PWM, Phase and Frequency
   9            1                0          0          1                                        OCR1A        BOTTOM      BOTTOM
                                                               Correct
   10           1                0          1          0       PWM, Phase Correct               ICR1         TOP         BOTTOM
   11           1                0          1          1       PWM, Phase Correct               OCR1A        TOP         BOTTOM
   12           1                1          0          0       CTC                              ICR1         Immediate   MAX




          2020 Microchip Technology Inc.                          Data Sheet Complete                         DS40002061B-page 141
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Table 16-4.       Waveform Generation Mode Bit Description(1) (Continued)
                         WGM12        WGM11      WGM10     Timer/Counter Mode of                       Update of         TOV1 Flag
 Mode     WGM13          (CTC1)      (PWM11)    (PWM10)    Operation                         TOP       OCR1x at          Set on
   13          1            1               0         1    (Reserved)                        –         –                 –
   14          1            1               1         0    Fast PWM                          ICR1      BOTTOM            TOP
   15          1            1               1         1    Fast PWM                          OCR1A     BOTTOM            TOP
Note:   1. The CTC1 and PWM11:0 bit definition names are obsolete. Use the WGM12:0 definitions. However, the functionality
           and location of these bits are compatible with previous versions of the timer.

16.11.2 TCCR1B – Timer/Counter1 Control Register B
         Bit                    7           6     5         4             3             2         1        0
         (0x81)            ICNC1      ICES1       –       WGM13       WGM12        CS12      CS11      CS10          TCCR1B
         Read/Write         R/W         R/W       R        R/W           R/W           R/W       R/W   R/W
         Initial Value          0           0     0         0             0             0         0        0


        • Bit 7 – ICNC1: Input Capture Noise Canceler
        Setting this bit (to one) activates the Input Capture Noise Canceler. When the noise canceler is activated, the
        input from the Input Capture pin (ICP1) is filtered. The filter function requires four successive equal valued
        samples of the ICP1 pin for changing its output. The Input Capture is therefore delayed by four Oscillator cycles
        when the noise canceler is enabled.

        • Bit 6 – ICES1: Input Capture Edge Select
        This bit selects which edge on the Input Capture pin (ICP1) that is used to trigger a capture event. When the
        ICES1 bit is written to zero, a falling (negative) edge is used as trigger, and when the ICES1 bit is written to one,
        a rising (positive) edge will trigger the capture.
        When a capture is triggered according to the ICES1 setting, the counter value is copied into the Input Capture
        Register (ICR1). The event will also set the Input Capture Flag (ICF1), and this can be used to cause an Input
        Capture Interrupt, if this interrupt is enabled.
        When the ICR1 is used as TOP value (see description of the WGM13:0 bits located in the TCCR1A and the
        TCCR1B Register), the ICP1 is disconnected and consequently the Input Capture function is disabled.

        • Bit 5 – Reserved
        This bit is reserved for future use. For ensuring compatibility with future devices, this bit must be written to zero
        when TCCR1B is written.

        • Bit 4:3 – WGM13:2: Waveform Generation Mode
        See TCCR1A Register description.

        • Bit 2:0 – CS12:0: Clock Select
        The three Clock Select bits select the clock source to be used by the Timer/Counter, see Figure 16-10 on page
        138 and Figure 16-11 on page 138.




          2020 Microchip Technology Inc.                        Data Sheet Complete                           DS40002061B-page 142
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P


       Table 16-5.       Clock Select Bit Description
          CS12          CS11       CS10         Description
              0          0          0           No clock source (Timer/Counter stopped).
              0          0          1           clkI/O/1 (No prescaling)
              0          1          0           clkI/O/8 (From prescaler)
              0          1          1           clkI/O/64 (From prescaler)
              1          0          0           clkI/O/256 (From prescaler)
              1          0          1           clkI/O/1024 (From prescaler)
              1          1          0           External clock source on T1 pin. Clock on falling edge.
              1          1          1           External clock source on T1 pin. Clock on rising edge.

       If external pin modes are used for the Timer/Counter1, transitions on the T1 pin will clock the counter even if the
       pin is configured as an output. This feature allows software control of the counting.

16.11.3 TCCR1C – Timer/Counter1 Control Register C
        Bit                    7            6            5          4            3            2         1          0
        (0x82)           FOC1A      FOC1B                –          –            –         –            –          –       TCCR1C
        Read/Write           R/W        R/W              R          R            R         R            R          R
        Initial Value          0            0            0          0            0            0         0          0


       • Bit 7 – FOC1A: Force Output Compare for Channel A
       • Bit 6 – FOC1B: Force Output Compare for Channel B
       The FOC1A/FOC1B bits are only active when the WGM13:0 bits specifies a non-PWM mode. When writing a
       logical one to the FOC1A/FOC1B bit, an immediate compare match is forced on the Waveform Generation unit.
       The OC1A/OC1B output is changed according to its COM1x1:0 bits setting. Note that the FOC1A/FOC1B bits
       are implemented as strobes. Therefore it is the value present in the COM1x1:0 bits that determine the effect of
       the forced compare.
       A FOC1A/FOC1B strobe will not generate any interrupt nor will it clear the timer in Clear Timer on Compare
       match (CTC) mode using OCR1A as TOP. The FOC1A/FOC1B bits are always read as zero.

16.11.4 TCNT1H and TCNT1L – Timer/Counter1
        Bit                   7         6           5          4            3         2            1         0
        (0x85)                                                TCNT1[15:8]                                         TCNT1H
        (0x84)                                                TCNT1[7:0]                                          TCNT1L
        Read/Write           R/W     R/W           R/W        R/W          R/W       R/W          R/W       R/W
        Initial Value         0         0           0          0            0         0            0         0

       The two Timer/Counter I/O locations (TCNT1H and TCNT1L, combined TCNT1) give direct access, both for
       read and for write operations, to the Timer/Counter unit 16-bit counter. To ensure that both the high and low
       bytes are read and written simultaneously when the CPU accesses these registers, the access is performed
       using an 8-bit temporary High Byte Register (TEMP). This temporary register is shared by all the other 16-bit
       registers. See ”Accessing 16-bit Registers” on page 122.
       Modifying the counter (TCNT1) while the counter is running introduces a risk of missing a compare match
       between TCNT1 and one of the OCR1x Registers.
       Writing to the TCNT1 Register blocks (removes) the compare match on the following timer clock for all compare
       units.



        2020 Microchip Technology Inc.                                 Data Sheet Complete                            DS40002061B-page 143
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

16.11.5 OCR1AH and OCR1AL – Output Compare Register 1 A
        Bit                7             6         5           4               3              2              1               0
        (0x89)                                                OCR1A[15:8]                                                               OCR1AH
        (0x88)                                                 OCR1A[7:0]                                                               OCR1AL
        Read/Write        R/W        R/W       R/W            R/W             R/W            R/W            R/W             R/W
        Initial Value      0             0         0           0               0              0              0               0


16.11.6 OCR1BH and OCR1BL – Output Compare Register 1 B
        Bit                7             6         5           4               3              2              1               0
        (0x8B)                                                OCR1B[15:8]                                                               OCR1BH
        (0x8A)                                                 OCR1B[7:0]                                                               OCR1BL
        Read/Write        R/W        R/W       R/W            R/W             R/W            R/W            R/W             R/W
        Initial Value      0             0         0           0               0              0              0               0

       The Output Compare Registers contain a 16-bit value that is continuously compared with the counter value
       (TCNT1). A match can be used to generate an Output Compare interrupt, or to generate a waveform output on
       the OC1x pin.
       The Output Compare Registers are 16-bit in size. To ensure that both the high and low bytes are written
       simultaneously when the CPU writes to these registers, the access is performed using an 8-bit temporary High
       Byte Register (TEMP). This temporary register is shared by all the other 16-bit registers. See ”Accessing 16-bit
       Registers” on page 122.

16.11.7 ICR1H and ICR1L – Input Capture Register 1
        Bit               7          6         5          4              3              2              1               0
        (0x87)                                           ICR1[15:8]                                                              ICR1H
        (0x86)                                            ICR1[7:0]                                                              ICR1L
        Read/Write       R/W        R/W       R/W        R/W            R/W            R/W            R/W             R/W
        Initial Value     0          0         0          0              0              0              0               0

       The Input Capture is updated with the counter (TCNT1) value each time an event occurs on the ICP1 pin (or
       optionally on the Analog Comparator output for Timer/Counter1). The Input Capture can be used for defining the
       counter TOP value.
       The Input Capture Register is 16-bit in size. To ensure that both the high and low bytes are read simultaneously
       when the CPU accesses these registers, the access is performed using an 8-bit temporary High Byte Register
       (TEMP). This temporary register is shared by all the other 16-bit registers. See ”Accessing 16-bit Registers” on
       page 122.

16.11.8 TIMSK1 – Timer/Counter1 Interrupt Mask Register
        Bit                7              6         5              4               3              2               1               0
        (0x6F)             –             –     ICIE1            –                  –         OCIE1B         OCIE1A           TOIE1         TIMSK1
        Read/Write         R             R         R/W          R                  R          R/W                R/W             R/W
        Initial Value      0              0         0              0               0              0               0               0


       • Bit 7, 6 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 5 – ICIE1: Timer/Counter1, Input Capture Interrupt Enable
       When this bit is written to one, and the I-flag in the Status Register is set (interrupts globally enabled), the
       Timer/Counter1 Input Capture interrupt is enabled. The corresponding Interrupt Vector (see “Interrupts” on page
       66) is executed when the ICF1 Flag, located in TIFR1, is set.



        2020 Microchip Technology Inc.                                Data Sheet Complete                                             DS40002061B-page 144
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       • Bit 4, 3 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 2 – OCIE1B: Timer/Counter1, Output Compare B Match Interrupt Enable
       When this bit is written to one, and the I-flag in the Status Register is set (interrupts globally enabled), the
       Timer/Counter1 Output Compare B Match interrupt is enabled. The corresponding Interrupt Vector (see
       “Interrupts” on page 66) is executed when the OCF1B Flag, located in TIFR1, is set.

       • Bit 1 – OCIE1A: Timer/Counter1, Output Compare A Match Interrupt Enable
       When this bit is written to one, and the I-flag in the Status Register is set (interrupts globally enabled), the
       Timer/Counter1 Output Compare A Match interrupt is enabled. The corresponding Interrupt Vector (see
       “Interrupts” on page 66) is executed when the OCF1A Flag, located in TIFR1, is set.

       • Bit 0 – TOIE1: Timer/Counter1, Overflow Interrupt Enable
       When this bit is written to one, and the I-flag in the Status Register is set (interrupts globally enabled), the
       Timer/Counter1 Overflow interrupt is enabled. The corresponding Interrupt Vector (See ”Interrupts” on page 66)
       is executed when the TOV1 Flag, located in TIFR1, is set.

16.11.9 TIFR1 – Timer/Counter1 Interrupt Flag Register
        Bit                7              6    5          4          3          2         1          0
        0x16 (0x36)        –              –   ICF1        –          –       OCF1B     OCF1A      TOV1        TIFR1
        Read/Write         R              R   R/W         R          R         R/W       R/W       R/W
        Initial Value      0              0    0          0          0          0         0          0


       • Bit 7, 6 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 5 – ICF1: Timer/Counter1, Input Capture Flag
       This flag is set when a capture event occurs on the ICP1 pin. When the Input Capture Register (ICR1) is set by
       the WGM13:0 to be used as the TOP value, the ICF1 Flag is set when the counter reaches the TOP value.
       ICF1 is automatically cleared when the Input Capture Interrupt Vector is executed. Alternatively, ICF1 can be
       cleared by writing a logic one to its bit location.

       • Bit 4, 3 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 2 – OCF1B: Timer/Counter1, Output Compare B Match Flag
       This flag is set in the timer clock cycle after the counter (TCNT1) value matches the Output Compare Register B
       (OCR1B).
       Note that a Forced Output Compare (FOC1B) strobe will not set the OCF1B Flag.
       OCF1B is automatically cleared when the Output Compare Match B Interrupt Vector is executed. Alternatively,
       OCF1B can be cleared by writing a logic one to its bit location.

       • Bit 1 – OCF1A: Timer/Counter1, Output Compare A Match Flag
       This flag is set in the timer clock cycle after the counter (TCNT1) value matches the Output Compare Register A
       (OCR1A).
       Note that a Forced Output Compare (FOC1A) strobe will not set the OCF1A Flag.




        2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 145
                                     ATmega48A/PA/88A/PA/168A/PA/328/P

OCF1A is automatically cleared when the Output Compare Match A Interrupt Vector is executed. Alternatively,
OCF1A can be cleared by writing a logic one to its bit location.

• Bit 0 – TOV1: Timer/Counter1, Overflow Flag
The setting of this flag is dependent of the WGM13:0 bits setting. In Normal and CTC modes, the TOV1 Flag is
set when the timer overflows. Refer to Table 16-4 on page 141 for the TOV1 Flag behavior when using another
WGM13:0 bit setting.
TOV1 is automatically cleared when the Timer/Counter1 Overflow Interrupt Vector is executed. Alternatively,
TOV1 can be cleared by writing a logic one to its bit location.




 2020 Microchip Technology Inc.                  Data Sheet Complete                     DS40002061B-page 146
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P


17.    Timer/Counter0 and Timer/Counter1 Prescalers
       ”8-bit Timer/Counter0 with PWM” on page 102 and ”16-bit Timer/Counter1 with PWM” on page 120 share the
       same prescaler module, but the Timer/Counters can have different prescaler settings. The description below
       applies to both Timer/Counter1 and Timer/Counter0.

17.1   Internal Clock Source
       The Timer/Counter can be clocked directly by the system clock (by setting the CSn2:0 = 1). This provides the
       fastest operation, with a maximum Timer/Counter clock frequency equal to system clock frequency (fCLK_I/O).
       Alternatively, one of four taps from the prescaler can be used as a clock source. The prescaled clock has a
       frequency of either fCLK_I/O/8, fCLK_I/O/64, fCLK_I/O/256, or fCLK_I/O/1024.

17.2   Prescaler Reset
       The prescaler is free running, i.e., operates independently of the Clock Select logic of the Timer/Counter, and it
       is shared by Timer/Counter1 and Timer/Counter0. Since the prescaler is not affected by the Timer/Counter’s
       clock select, the state of the prescaler will have implications for situations where a prescaled clock is used. One
       example of prescaling artifacts occurs when the timer is enabled and clocked by the prescaler (6 > CSn2:0 > 1).
       The number of system clock cycles from when the timer is enabled to the first count occurs can be from 1 to
       N+1 system clock cycles, where N equals the prescaler divisor (8, 64, 256, or 1024).
       It is possible to use the prescaler reset for synchronizing the Timer/Counter to program execution. However,
       care must be taken if the other Timer/Counter that shares the same prescaler also uses prescaling. A prescaler
       reset will affect the prescaler period for all Timer/Counters it is connected to.

17.3   External Clock Source
       An external clock source applied to the T1/T0 pin can be used as Timer/Counter clock (clkT1/clkT0). The T1/T0
       pin is sampled once every system clock cycle by the pin synchronization logic. The synchronized (sampled)
       signal is then passed through the edge detector. Figure 17-1 shows a functional equivalent block diagram of the
       T1/T0 synchronization and edge detector logic. The registers are clocked at the positive edge of the internal
       system clock (clkI/O). The latch is transparent in the high period of the internal system clock.
       The edge detector generates one clkT1/clkT0 pulse for each positive (CSn2:0 = 7) or negative (CSn2:0 = 6) edge
       it detects.

       Figure 17-1.   T1/T0 Pin Sampling


                       Tn            D    Q       D     Q                         D   Q                   Tn_sync
                                                                                                          (To Clock
                                                                                                          Select Logic)
                                     LE

                         clk I/O

                                              Synchronization                             Edge Detector




       The synchronization and edge detector logic introduces a delay of 2.5 to 3.5 system clock cycles from an edge
       has been applied to the T1/T0 pin to the counter is updated.
       Enabling and disabling of the clock input must be done when T1/T0 has been stable for at least one system
       clock cycle, otherwise it is a risk that a false Timer/Counter clock pulse is generated.
       Each half period of the external clock applied must be longer than one system clock cycle to ensure correct
       sampling. The external clock must be ensured to have less than half the system clock frequency (fExtClk <



        2020 Microchip Technology Inc.                         Data Sheet Complete                       DS40002061B-page 147
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

fclk_I/O/2) given a 50/50% duty cycle. Since the edge detector uses sampling, the maximum frequency of an
external clock it can detect is half the sampling frequency (Nyquist sampling theorem). However, due to
variation of the system clock frequency and duty cycle caused by Oscillator source (crystal, resonator, and
capacitors) tolerances, it is recommended that maximum frequency of an external clock source is less than
fclk_I/O/2.5.
An external clock source can not be prescaled.

Figure 17-2.    Prescaler for Timer/Counter0 and Timer/Counter1(1)

                  clk I/O
                                                     Clear



               PSRSYNC




                   T0
                            Synchronization

                   T1
                            Synchronization




                                                    clkT1                                 clkT0



Note:   1. The synchronization logic on the input pins (T1/T0) is shown in Figure 17-1.




 2020 Microchip Technology Inc.                        Data Sheet Complete                       DS40002061B-page 148
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


17.4   Register Description

17.4.1 GTCCR – General Timer/Counter Control Register
        Bit              7         6      5      4        3         2            1       0
        0x23 (0x43)     TSM        –      –      –        –         –      PSRASY     PSRSYNC   GTCCR
        Read/Write      R/W        R      R      R        R         R           R/W     R/W
        Initial Value    0         0      0      0        0         0            0       0


       • Bit 7 – TSM: Timer/Counter Synchronization Mode
       Writing the TSM bit to one activates the Timer/Counter Synchronization mode. In this mode, the value that is
       written to the PSRASY and PSRSYNC bits is kept, hence keeping the corresponding prescaler reset signals
       asserted. This ensures that the corresponding Timer/Counters are halted and can be configured to the same
       value without the risk of one of them advancing during configuration. When the TSM bit is written to zero, the
       PSRASY and PSRSYNC bits are cleared by hardware, and the Timer/Counters start counting simultaneously.

       • Bit 0 – PSRSYNC: Prescaler Reset
       When this bit is one, Timer/Counter1 and Timer/Counter0 prescaler will be Reset. This bit is normally cleared
       immediately by hardware, except if the TSM bit is set. Note that Timer/Counter1 and Timer/Counter0 share the
       same prescaler and a reset of this prescaler will affect both timers.




        2020 Microchip Technology Inc.                   Data Sheet Complete                     DS40002061B-page 149
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P


18.    8-bit Timer/Counter2 with PWM and Asynchronous Operation

18.1   Features
       •   Single Channel Counter
       •   Clear Timer on Compare Match (Auto Reload)
       •   Glitch-free, Phase Correct Pulse Width Modulator (PWM)
       •   Frequency Generator
       •   10-bit Clock Prescaler
       •   Overflow and Compare Match Interrupt Sources (TOV2, OCF2A and OCF2B)
       •   Allows Clocking from External 32kHz Watch Crystal Independent of the I/O Clock


18.2   Overview
       Timer/Counter2 is a general purpose, single channel, 8-bit Timer/Counter module. A simplified block diagram of
       the 8-bit Timer/Counter is shown in Figure 18-1. For the actual placement of I/O pins, refer to ”Pinout
       ATmega48A/PA/88A/PA/168A/PA/328/P” on page 12. CPU accessible I/O Registers, including I/O bits and I/O
       pins, are shown in bold. The device-specific I/O Register and bit locations are listed in the ”Register Description”
       on page 162.
       The PRTIM2 bit in ”Minimizing Power Consumption” on page 51 must be written to zero to enable
       Timer/Counter2 module.

       Figure 18-1.    8-bit Timer/Counter Block Diagram
                                                           Count                                             TOVn
                                                           Clear                                             (Int.Req.)
                                                                      Control Logic
                                                          Direction                      clkTn                              Clock Select
                                                                                                                                                    TOSC1
                                                                                                                                T/C
                                                                                                                              Oscillator
                                                                                                 Prescaler                                          TOSC2
                                                                         TOP     BOTTOM

                                                                                                                                    clkI/O
                                          Timer/Counter
                                             TCNTn
                                                                           =               =0
                                                                                                             OCnA
                                                                                                             (Int.Req.)

                                                                                                               Waveform
                                               =                                                               Generation
                                                                                                                                             OCnA



                                            OCRnA
                                                                                 Fixed
                                                                                                             OCnB
                                                                                 TOP
                                                                                                             (Int.Req.)
                                                                                Value
                          DATA BUS




                                                                                                               Waveform
                                               =                                                               Generation
                                                                                                                                             OCnB



                                             OCRnB




                                            TCCRnA                         TCCRnB




18.2.1 Registers
       The Timer/Counter (TCNT2) and Output Compare Register (OCR2A and OCR2B) are 8-bit registers. Interrupt
       request (shorten as Int.Req.) signals are all visible in the Timer Interrupt Flag Register (TIFR2). All interrupts are



        2020 Microchip Technology Inc.                                         Data Sheet Complete                                                   DS40002061B-page 150
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

       individually masked with the Timer Interrupt Mask Register (TIMSK2). TIFR2 and TIMSK2 are not shown in the
       figure.
       The Timer/Counter can be clocked internally, via the prescaler, or asynchronously clocked from the TOSC1/2
       pins, as detailed later in this section. The asynchronous operation is controlled by the Asynchronous Status
       Register (ASSR). The Clock Select logic block controls which clock source he Timer/Counter uses to increment
       (or decrement) its value. The Timer/Counter is inactive when no clock source is selected. The output from the
       Clock Select logic is referred to as the timer clock (clkT2).
       The double buffered Output Compare Register (OCR2A and OCR2B) are compared with the Timer/Counter
       value at all times. The result of the compare can be used by the Waveform Generator to generate a PWM or
       variable frequency output on the Output Compare pins (OC2A and OC2B). See ”Output Compare Unit” on page
       152 for details. The compare match event will also set the Compare Flag (OCF2A or OCF2B) which can be
       used to generate an Output Compare interrupt request.

18.2.2 Definitions
       Many register and bit references in this document are written in general form. A lower case “n” replaces the
       Timer/Counter number, in this case 2. However, when using the register or bit defines in a program, the precise
       form must be used, i.e., TCNT2 for accessing Timer/Counter2 counter value and so on.
       The definitions in Table 18-1 are also used extensively throughout the section.

       Table 18-1.    Definitions

        BOTTOM         The counter reaches the BOTTOM when it becomes zero (0x00).
        MAX            The counter reaches its MAXimum when it becomes 0xFF (decimal 255).
                       The counter reaches the TOP when it becomes equal to the highest value in the
                       count sequence. The TOP value can be assigned to be the fixed value 0xFF
        TOP
                       (MAX) or the value stored in the OCR2A Register. The assignment is
                       dependent on the mode of operation.


18.3   Timer/Counter Clock Sources
       The Timer/Counter can be clocked by an internal synchronous or an external asynchronous clock source. The
       clock source clkT2 is by default equal to the MCU clock, clkI/O. When the AS2 bit in the ASSR Register is written
       to logic one, the clock source is taken from the Timer/Counter Oscillator connected to TOSC1 and TOSC2. For
       details on asynchronous operation, see ”ASSR – Asynchronous Status Register” on page 167. For details on
       clock sources and prescaler, see ”Timer/Counter Prescaler” on page 161.

18.4   Counter Unit
       The main part of the 8-bit Timer/Counter is the programmable bi-directional counter unit. Figure 18-2 on page
       151 shows a block diagram of the counter and its surrounding environment.

       Figure 18-2.   Counter Unit Block Diagram
                                                                                  TOVn
                               DATA BUS                                           (Int.Req.)




                                                                                                                                  TOSC1
                                                   count
                                                                                                              T/C
                                                   clear                             clk Tn
                                  TCNTn                     Control Logic                      Prescaler   Oscillator
                                                direction
                                                                                                                                  TOSC2




                                                      bottom                top                                         clkI/O




        2020 Microchip Technology Inc.                            Data Sheet Complete                                           DS40002061B-page 151
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       Signal description (internal signals):
             count          Increment or decrement TCNT2 by 1.
             direction      Selects between increment and decrement.
             clear          Clear TCNT2 (set all bits to zero).
             clkTn          Timer/Counter clock, referred to as clkT2 in the following.
             top            Signalizes that TCNT2 has reached maximum value.
             bottom         Signalizes that TCNT2 has reached minimum value (zero).
       Depending on the mode of operation used, the counter is cleared, incremented, or decremented at each timer
       clock (clkT2). clkT2 can be generated from an external or internal clock source, selected by the Clock Select bits
       (CS22:0). When no clock source is selected (CS22:0 = 0) the timer is stopped. However, the TCNT2 value can
       be accessed by the CPU, regardless of whether clkT2 is present or not. A CPU write overrides (has priority over)
       all counter clear or count operations.
       The counting sequence is determined by the setting of the WGM21 and WGM20 bits located in the
       Timer/Counter Control Register (TCCR2A) and the WGM22 located in the Timer/Counter Control Register B
       (TCCR2B). There are close connections between how the counter behaves (counts) and how waveforms are
       generated on the Output Compare outputs OC2A and OC2B. For more details about advanced counting
       sequences and waveform generation, see ”Modes of Operation” on page 155.
       The Timer/Counter Overflow Flag (TOV2) is set according to the mode of operation selected by the WGM22:0
       bits. TOV2 can be used for generating a CPU interrupt.

18.5   Output Compare Unit
       The 8-bit comparator continuously compares TCNT2 with the Output Compare Register (OCR2A and OCR2B).
       Whenever TCNT2 equals OCR2A or OCR2B, the comparator signals a match. A match will set the Output
       Compare Flag (OCF2A or OCF2B) at the next timer clock cycle. If the corresponding interrupt is enabled, the
       Output Compare Flag generates an Output Compare interrupt. The Output Compare Flag is automatically
       cleared when the interrupt is executed. Alternatively, the Output Compare Flag can be cleared by software by
       writing a logical one to its I/O bit location. The Waveform Generator uses the match signal to generate an output
       according to operating mode set by the WGM22:0 bits and Compare Output mode (COM2x1:0) bits. The max
       and bottom signals are used by the Waveform Generator for handling the special cases of the extreme values in
       some modes of operation (”Modes of Operation” on page 155).
       Figure 18-3 shows a block diagram of the Output Compare unit.




        2020 Microchip Technology Inc.                      Data Sheet Complete                     DS40002061B-page 152
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

        Figure 18-3.   Output Compare Unit, Block Diagram

                                                            DATA BUS



                                                 OCRnx                            TCNTn




                                                          = (8-bit Comparator )

                                                                                     OCFnx (Int.Req.)


                                           top

                                       bottom
                                                         Waveform Generator                OCnx
                                       FOCn




                                                         WGMn1:0       COMnX1:0



        The OCR2x Register is double buffered when using any of the Pulse Width Modulation (PWM) modes. For the
        Normal and Clear Timer on Compare (CTC) modes of operation, the double buffering is disabled. The double
        buffering synchronizes the update of the OCR2x Compare Register to either top or bottom of the counting
        sequence. The synchronization prevents the occurrence of odd-length, non-symmetrical PWM pulses, thereby
        making the output glitch-free.
        The OCR2x Register access may seem complex, but this is not case. When the double buffering is enabled, the
        CPU has access to the OCR2x Buffer Register, and if double buffering is disabled the CPU will access the
        OCR2x directly.

18.5.1 Force Output Compare
        In non-PWM waveform generation modes, the match output of the comparator can be forced by writing a one to
        the Force Output Compare (FOC2x) bit. Forcing compare match will not set the OCF2x Flag or reload/clear the
        timer, but the OC2x pin will be updated as if a real compare match had occurred (the COM2x1:0 bits settings
        define whether the OC2x pin is set, cleared or toggled).

18.5.2 Compare Match Blocking by TCNT2 Write
       All CPU write operations to the TCNT2 Register will block any compare match that occurs in the next timer clock
       cycle, even when the timer is stopped. This feature allows OCR2x to be initialized to the same value as TCNT2
       without triggering an interrupt when the Timer/Counter clock is enabled.

18.5.3 Using the Output Compare Unit
        Since writing TCNT2 in any mode of operation will block all compare matches for one timer clock cycle, there
        are risks involved when changing TCNT2 when using the Output Compare channel, independently of whether
        the Timer/Counter is running or not. If the value written to TCNT2 equals the OCR2x value, the compare match
        will be missed, resulting in incorrect waveform generation. Similarly, do not write the TCNT2 value equal to
        BOTTOM when the counter is downcounting.
        The setup of the OC2x should be performed before setting the Data Direction Register for the port pin to output.
        The easiest way of setting the OC2x value is to use the Force Output Compare (FOC2x) strobe bit in Normal
        mode. The OC2x Register keeps its value even when changing between Waveform Generation modes.
        Be aware that the COM2x1:0 bits are not double buffered together with the compare value. Changing the
        COM2x1:0 bits will take effect immediately.



         2020 Microchip Technology Inc.                    Data Sheet Complete                         DS40002061B-page 153
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

18.6   Compare Match Output Unit
       The Compare Output mode (COM2x1:0) bits have two functions. The Waveform Generator uses the COM2x1:0
       bits for defining the Output Compare (OC2x) state at the next compare match. Also, the COM2x1:0 bits control
       the OC2x pin output source. Figure 18-4 shows a simplified schematic of the logic affected by the COM2x1:0 bit
       setting. The I/O Registers, I/O bits, and I/O pins in the figure are shown in bold. Only the parts of the general I/O
       Port Control Registers (DDR and PORT) that are affected by the COM2x1:0 bits are shown. When referring to
       the OC2x state, the reference is for the internal OC2x Register, not the OC2x pin.

       Figure 18-4.   Compare Match Output Unit, Schematic



                       COMnx1
                       COMnx0             Waveform
                                                             D    Q
                       FOCnx              Generator
                                                                                   1
                                                                                                       OCnx
                                                              OCnx                                      Pin
                                                                                   0

                                                             D    Q
                                                 DATA BUS




                                                             PORT

                                                             D    Q



                                                             DDR
                        clk I/O


       The general I/O port function is overridden by the Output Compare (OC2x) from the Waveform Generator if
       either of the COM2x1:0 bits are set. However, the OC2x pin direction (input or output) is still controlled by the
       Data Direction Register (DDR) for the port pin. The Data Direction Register bit for the OC2x pin (DDR_OC2x)
       must be set as output before the OC2x value is visible on the pin. The port override function is independent of
       the Waveform Generation mode.
       The design of the Output Compare pin logic allows initialization of the OC2x state before the output is enabled.
       Note that some COM2x1:0 bit settings are reserved for certain modes of operation. See ”Register Description”
       on page 162.

18.6.1 Compare Output Mode and Waveform Generation
       The Waveform Generator uses the COM2x1:0 bits differently in normal, CTC, and PWM modes. For all modes,
       setting the COM2x1:0 = 0 tells the Waveform Generator that no action on the OC2x Register is to be performed
       on the next compare match. For compare output actions in the non-PWM modes refer to Table 18-5 on page
       163. For fast PWM mode, refer to Table 18-6 on page 163, and for phase correct PWM refer to Table 18-7 on
       page 164.
       A change of the COM2x1:0 bits state will have effect at the first compare match after the bits are written. For
       non-PWM modes, the action can be forced to have immediate effect by using the FOC2x strobe bits.




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 154
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

18.7   Modes of Operation
       The mode of operation, i.e., the behavior of the Timer/Counter and the Output Compare pins, is defined by the
       combination of the Waveform Generation mode (WGM22:0) and Compare Output mode (COM2x1:0) bits. The
       Compare Output mode bits do not affect the counting sequence, while the Waveform Generation mode bits do.
       The COM2x1:0 bits control whether the PWM output generated should be inverted or not (inverted or non-
       inverted PWM). For non-PWM modes the COM2x1:0 bits control whether the output should be set, cleared, or
       toggled at a compare match (See ”Compare Match Output Unit” on page 154).
       For detailed timing information refer to ”Timer/Counter Timing Diagrams” on page 159.

18.7.1 Normal Mode
       The simplest mode of operation is the Normal mode (WGM22:0 = 0). In this mode the counting direction is
       always up (incrementing), and no counter clear is performed. The counter simply overruns when it passes its
       maximum 8-bit value (TOP = 0xFF) and then restarts from the bottom (0x00). In normal operation the
       Timer/Counter Overflow Flag (TOV2) will be set in the same timer clock cycle as the TCNT2 becomes zero. The
       TOV2 Flag in this case behaves like a ninth bit, except that it is only set, not cleared. However, combined with
       the timer overflow interrupt that automatically clears the TOV2 Flag, the timer resolution can be increased by
       software. There are no special cases to consider in the Normal mode, a new counter value can be written
       anytime.
       The Output Compare unit can be used to generate interrupts at some given time. Using the Output Compare to
       generate waveforms in Normal mode is not recommended, since this will occupy too much of the CPU time.

18.7.2 Clear Timer on Compare Match (CTC) Mode
       In Clear Timer on Compare or CTC mode (WGM22:0 = 2), the OCR2A Register is used to manipulate the
       counter resolution. In CTC mode the counter is cleared to zero when the counter value (TCNT2) matches the
       OCR2A. The OCR2A defines the top value for the counter, hence also its resolution. This mode allows greater
       control of the compare match output frequency. It also simplifies the operation of counting external events.
       The timing diagram for the CTC mode is shown in Figure 18-5. The counter value (TCNT2) increases until a
       compare match occurs between TCNT2 and OCR2A, and then counter (TCNT2) is cleared.

       Figure 18-5.   CTC Mode, Timing Diagram

                                                                                        OCnx Interrupt Flag Set




                      TCNTn


                      OCnx
                                                                                        (COMnx1:0 = 1)
                      (Toggle)

                      Period              1        2       3        4



       An interrupt can be generated each time the counter value reaches the TOP value by using the OCF2A Flag. If
       the interrupt is enabled, the interrupt handler routine can be used for updating the TOP value. However,
       changing TOP to a value close to BOTTOM when the counter is running with none or a low prescaler value must
       be done with care since the CTC mode does not have the double buffering feature. If the new value written to
       OCR2A is lower than the current value of TCNT2, the counter will miss the compare match. The counter will
       then have to count to its maximum value (0xFF) and wrap around starting at 0x00 before the compare match
       can occur.




        2020 Microchip Technology Inc.                   Data Sheet Complete                            DS40002061B-page 155
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

      For generating a waveform output in CTC mode, the OC2A output can be set to toggle its logical level on each
      compare match by setting the Compare Output mode bits to toggle mode (COM2A1:0 = 1). The OC2A value will
      not be visible on the port pin unless the data direction for the pin is set to output. The waveform generated will
      have a maximum frequency of fOC2A = fclk_I/O/2 when OCR2A is set to zero (0x00). The waveform frequency is
      defined by the following equation:

                                                                          f clk_I/O
                                                f OCnx = --------------------------------------------------
                                                         2  N   1 + OCRnx 

      The N variable represents the prescale factor (1, 8, 32, 64, 128, 256, or 1024).
      As for the Normal mode of operation, the TOV2 Flag is set in the same timer clock cycle that the counter counts
      from MAX to 0x00.

18.7.3 Fast PWM Mode
      The fast Pulse Width Modulation or fast PWM mode (WGM22:0 = 3 or 7) provides a high frequency PWM
      waveform generation option. The fast PWM differs from the other PWM option by its single-slope operation. The
      counter counts from BOTTOM to TOP then restarts from BOTTOM. TOP is defined as 0xFF when WGM2:0 = 3,
      and OCR2A when MGM2:0 = 7. In non-inverting Compare Output mode, the Output Compare (OC2x) is cleared
      on the compare match between TCNT2 and OCR2x, and set at BOTTOM. In inverting Compare Output mode,
      the output is set on compare match and cleared at BOTTOM. Due to the single-slope operation, the operating
      frequency of the fast PWM mode can be twice as high as the phase correct PWM mode that uses dual-slope
      operation. This high frequency makes the fast PWM mode well suited for power regulation, rectification, and
      DAC applications. High frequency allows physically small sized external components (coils, capacitors), and
      therefore reduces total system cost.
      In fast PWM mode, the counter is incremented until the counter value matches the TOP value. The counter is
      then cleared at the following timer clock cycle. The timing diagram for the fast PWM mode is shown in Figure
      18-6. The TCNT2 value is in the timing diagram shown as a histogram for illustrating the single-slope operation.
      The diagram includes non-inverted and inverted PWM outputs. The small horizontal line marks on the TCNT2
      slopes represent compare matches between OCR2x and TCNT2.

      Figure 18-6.   Fast PWM Mode, Timing Diagram

                                                                                                                  OCRnx Interrupt Flag Set




                                                                                                                  OCRnx Update and
                                                                                                                  TOVn Interrupt Flag Set




                     TCNTn



                     OCnx                                                                                         (COMnx1:0 = 2)


                     OCnx                                                                                         (COMnx1:0 = 3)



                     Period         1    2      3              4               5              6               7



      The Timer/Counter Overflow Flag (TOV2) is set each time the counter reaches TOP. If the interrupt is enabled,
      the interrupt handler routine can be used for updating the compare value.




       2020 Microchip Technology Inc.                              Data Sheet Complete                                            DS40002061B-page 156
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

      In fast PWM mode, the compare unit allows generation of PWM waveforms on the OC2x pin. Setting the
      COM2x1:0 bits to two will produce a non-inverted PWM and an inverted PWM output can be generated by
      setting the COM2x1:0 to three. TOP is defined as 0xFF when WGM2:0 = 3, and OCR2A when MGM2:0 = 7.
      (See Table 18-3 on page 162). The actual OC2x value will only be visible on the port pin if the data direction for
      the port pin is set as output. The PWM waveform is generated by setting (or clearing) the OC2x Register at the
      compare match between OCR2x and TCNT2, and clearing (or setting) the OC2x Register at the timer clock
      cycle the counter is cleared (changes from TOP to BOTTOM).
      The PWM frequency for the output can be calculated by the following equation:

                                                                 f clk_I/O
                                                    f OCnxPWM = ------------------
                                                                N  256

      The N variable represents the prescale factor (1, 8, 32, 64, 128, 256, or 1024).
      The extreme values for the OCR2A Register represent special cases when generating a PWM waveform output
      in the fast PWM mode. If the OCR2A is set equal to BOTTOM, the output will be a narrow spike for each MAX+1
      timer clock cycle. Setting the OCR2A equal to MAX will result in a constantly high or low output (depending on
      the polarity of the output set by the COM2A1:0 bits.)
      A frequency (with 50% duty cycle) waveform output in fast PWM mode can be achieved by setting OC2x to
      toggle its logical level on each compare match (COM2x1:0 = 1). The waveform generated will have a maximum
      frequency of foc2 = fclk_I/O/2 when OCR2A is set to zero. This feature is similar to the OC2A toggle in CTC mode,
      except the double buffer feature of the Output Compare unit is enabled in the fast PWM mode.

18.7.4 Phase Correct PWM Mode
      The phase correct PWM mode (WGM22:0 = 1 or 5) provides a high resolution phase correct PWM waveform
      generation option. The phase correct PWM mode is based on a dual-slope operation. The counter counts
      repeatedly from BOTTOM to TOP and then from TOP to BOTTOM. TOP is defined as 0xFF when WGM2:0 = 3,
      and OCR2A when MGM2:0 = 7. In non-inverting Compare Output mode, the Output Compare (OC2x) is cleared
      on the compare match between TCNT2 and OCR2x while upcounting, and set on the compare match while
      downcounting. In inverting Output Compare mode, the operation is inverted. The dual-slope operation has lower
      maximum operation frequency than single slope operation. However, due to the symmetric feature of the dual-
      slope PWM modes, these modes are preferred for motor control applications.
      In phase correct PWM mode the counter is incremented until the counter value matches TOP. When the
      counter reaches TOP, it changes the count direction. The TCNT2 value will be equal to TOP for one timer clock
      cycle. The timing diagram for the phase correct PWM mode is shown on Figure 18-7. The TCNT2 value is in the
      timing diagram shown as a histogram for illustrating the dual-slope operation. The diagram includes non-
      inverted and inverted PWM outputs. The small horizontal line marks on the TCNT2 slopes represent compare
      matches between OCR2x and TCNT2.




       2020 Microchip Technology Inc.                      Data Sheet Complete                     DS40002061B-page 157
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 18-7.   Phase Correct PWM Mode, Timing Diagram

                                                                                    OCnx Interrupt Flag Set




                                                                                    OCRnx Update




                                                                                    TOVn Interrupt Flag Set




               TCNTn



               OCnx                                                                 (COMnx1:0 = 2)


               OCnx                                                                 (COMnx1:0 = 3)



               Period                 1                 2                       3



The Timer/Counter Overflow Flag (TOV2) is set each time the counter reaches BOTTOM. The Interrupt Flag
can be used to generate an interrupt each time the counter reaches the BOTTOM value.
In phase correct PWM mode, the compare unit allows generation of PWM waveforms on the OC2x pin. Setting
the COM2x1:0 bits to two will produce a non-inverted PWM. An inverted PWM output can be generated by
setting the COM2x1:0 to three. TOP is defined as 0xFF when WGM2:0 = 3, and OCR2A when MGM2:0 = 7
(See Table 18-4 on page 163). The actual OC2x value will only be visible on the port pin if the data direction for
the port pin is set as output. The PWM waveform is generated by clearing (or setting) the OC2x Register at the
compare match between OCR2x and TCNT2 when the counter increments, and setting (or clearing) the OC2x
Register at compare match between OCR2x and TCNT2 when the counter decrements. The PWM frequency
for the output when using phase correct PWM can be calculated by the following equation:
                                                            f clk_I/O
                                             f OCnxPCPWM = ------------------
                                                           N  510

The N variable represents the prescale factor (1, 8, 32, 64, 128, 256, or 1024).
The extreme values for the OCR2A Register represent special cases when generating a PWM waveform output
in the phase correct PWM mode. If the OCR2A is set equal to BOTTOM, the output will be continuously low and
if set equal to MAX the output will be continuously high for non-inverted PWM mode. For inverted PWM the
output will have the opposite logic values.
At the very start of period 2 in Figure 18-7 OCnx has a transition from high to low even though there is no
Compare Match. The point of this transition is to ensure symmetry around BOTTOM. There are two cases that
give a transition without Compare Match.
     OCR2A changes its value from MAX, like in Figure 18-7. When the OCR2A value is MAX the OCn pin
      value is the same as the result of a down-counting compare match. To ensure symmetry around BOTTOM
      the OCn value at MAX must correspond to the result of an up-counting Compare Match.
     The timer starts counting from a value higher than the one in OCR2A, and for that reason misses the
      Compare Match and hence the OCn change that would have happened on the way up.




 2020 Microchip Technology Inc.                       Data Sheet Complete                           DS40002061B-page 158
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

18.8   Timer/Counter Timing Diagrams
       The following figures show the Timer/Counter in synchronous mode, and the timer clock (clkT2) is therefore
       shown as a clock enable signal. In asynchronous mode, clkI/O should be replaced by the Timer/Counter
       Oscillator clock. The figures include information on when Interrupt Flags are set. Figure 18-8 contains timing
       data for basic Timer/Counter operation. The figure shows the count sequence close to the MAX value in all
       modes other than phase correct PWM mode.

       Figure 18-8.    Timer/Counter Timing Diagram, no Prescaling


                       clkI/O


                       clkTn
                      (clkI/O /1)


                      TCNTn               MAX - 1            MAX                BOTTOM        BOTTOM + 1


                      TOVn



       Figure 18-9 shows the same timing data, but with the prescaler enabled.

       Figure 18-9.    Timer/Counter Timing Diagram, with Prescaler (fclk_I/O/8)

                        clkI/O


                        clkTn
                      (clkI/O /8)


                      TCNTn               MAX - 1            MAX                BOTTOM        BOTTOM + 1


                       TOVn




       Figure 18-10 shows the setting of OCF2A in all modes except CTC mode.

       Figure 18-10. Timer/Counter Timing Diagram, Setting of OCF2A, with Prescaler (fclk_I/O/8)

                        clkI/O


                        clkTn
                      (clkI/O /8)


                      TCNTn               OCRnx - 1         OCRnx              OCRnx + 1       OCRnx + 2


                      OCRnx                                      OCRnx Value


                      OCFnx




       Figure 18-11 shows the setting of OCF2A and the clearing of TCNT2 in CTC mode.




        2020 Microchip Technology Inc.                       Data Sheet Complete                   DS40002061B-page 159
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 18-11. Timer/Counter Timing Diagram, Clear Timer on Compare Match mode, with Prescaler (fclk_I/O/8)

                      clkI/O


                       clkTn
                     (clkI/O /8)

                     TCNTn
                                          TOP - 1        TOP               BOTTOM         BOTTOM + 1
                     (CTC)

                      OCRnx                                     TOP


                      OCFnx




18.9   Asynchronous Operation of Timer/Counter2
       When Timer/Counter2 operates asynchronously, some considerations must be taken.
            Warning: When switching between asynchronous and synchronous clocking of Timer/Counter2, the Timer
             Registers TCNT2, OCR2x, and TCCR2x might be corrupted. A safe procedure for switching clock source
             is:
            a. Disable the Timer/Counter2 interrupts by clearing OCIE2x and TOIE2.
               1. Select clock source by setting AS2 as appropriate.
               2. Write new values to TCNT2, OCR2x, and TCCR2x.
               3. To switch to asynchronous operation: Wait for TCN2xUB, OCR2xUB, and TCR2xUB.
               4. Clear the Timer/Counter2 Interrupt Flags.
               5. Enable interrupts, if needed.
            The CPU main clock frequency must be more than four times the Oscillator frequency.
            When writing to one of the registers TCNT2, OCR2x, or TCCR2x, the value is transferred to a temporary
             register, and latched after two positive edges on TOSC1. The user should not write a new value before the
             contents of the temporary register have been transferred to its destination. Each of the five mentioned
             registers have their individual temporary register, which means that e.g. writing to TCNT2 does not disturb
             an OCR2x write in progress. To detect that a transfer to the destination register has taken place, the
             Asynchronous Status Register – ASSR has been implemented.
            When entering Power-save or ADC Noise Reduction mode after having written to TCNT2, OCR2x, or
             TCCR2x, the user must wait until the written register has been updated if Timer/Counter2 is used to wake
             up the device. Otherwise, the MCU will enter sleep mode before the changes are effective. This is
             particularly important if any of the Output Compare2 interrupt is used to wake up the device, since the
             Output Compare function is disabled during writing to OCR2x or TCNT2. If the write cycle is not finished,
             and the MCU enters sleep mode before the corresponding OCR2xUB bit returns to zero, the device will
             never receive a compare match interrupt, and the MCU will not wake up.
            If Timer/Counter2 is used to wake the device up from Power-save or ADC Noise Reduction mode,
             precautions must be taken if the user wants to re-enter one of these modes: If re-entering sleep mode
             within the TOSC1 cycle, the interrupt will immediately occur and the device wake up again. The result is
             multiple interrupts and wake-ups within one TOSC1 cycle from the first interrupt. If the user is in doubt
             whether the time before re-entering Power-save or ADC Noise Reduction mode is sufficient, the following
             algorithm can be used to ensure that one TOSC1 cycle has elapsed:
            a. Write a value to TCCR2x, TCNT2, or OCR2x.
               1. Wait until the corresponding Update Busy Flag in ASSR returns to zero.
               2. Enter Power-save or ADC Noise Reduction mode.
            When the asynchronous operation is selected, the 32.768kHz Oscillator for Timer/Counter2 is always
             running, except in Power-down and Standby modes. After a Power-up Reset or wake-up from Power-
             down or Standby mode, the user should be aware of the fact that this Oscillator might take as long as one



        2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 160
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

            second to stabilize. The user is advised to wait for at least one second before using Timer/Counter2 after
            power-up or wake-up from Power-down or Standby mode. The contents of all Timer/Counter2 Registers
            must be considered lost after a wake-up from Power-down or Standby mode due to unstable clock signal
            upon start-up, no matter whether the Oscillator is in use or a clock signal is applied to the TOSC1 pin.
           Description of wake up from Power-save or ADC Noise Reduction mode when the timer is clocked
            asynchronously: When the interrupt condition is met, the wake up process is started on the following cycle
            of the timer clock, that is, the timer is always advanced by at least one before the processor can read the
            counter value. After wake-up, the MCU is halted for four cycles, it executes the interrupt routine, and
            resumes execution from the instruction following SLEEP.
           Reading of the TCNT2 Register shortly after wake-up from Power-save may give an incorrect result.
            Since TCNT2 is clocked on the asynchronous TOSC clock, reading TCNT2 must be done through a
            register synchronized to the internal I/O clock domain. Synchronization takes place for every rising
            TOSC1 edge. When waking up from Power-save mode, and the I/O clock (clkI/O) again becomes active,
            TCNT2 will read as the previous value (before entering sleep) until the next rising TOSC1 edge. The
            phase of the TOSC clock after waking up from Power-save mode is essentially unpredictable, as it
            depends on the wake-up time. The recommended procedure for reading TCNT2 is thus as follows:
           a. Write any value to either of the registers OCR2x or TCCR2x.
              1. Wait for the corresponding Update Busy Flag to be cleared.
              2. Read TCNT2.
     During asynchronous operation, the synchronization of the Interrupt Flags for the asynchronous timer takes
     3 processor cycles plus one timer cycle. The timer is therefore advanced by at least one before the processor
     can read the timer value causing the setting of the Interrupt Flag. The Output Compare pin is changed on the
     timer clock and is not synchronized to the processor clock.

18.10 Timer/Counter Prescaler

     Figure 18-12. Prescaler for Timer/Counter2

                        clkI/O             clkT2S
                                                                             10-BIT T/C PRESCALER
                                                    Clear
                      TOSC1
                                                                  clkT2S/8




                                                                                    clkT2S/32

                                                                                                clkT2S/64

                                                                                                            clkT2S/128

                                                                                                                         clkT2S/256




                                                                                                                                        clkT2S/1024
                          AS2




                     PSRASY                                            0



                        CS20
                        CS21
                        CS22




                                                             TIMER/COUNTER2 CLOCK SOURCE
                                                                         clkT2


     The clock source for Timer/Counter2 is named clkT2S. clkT2S is by default connected to the main system I/O
     clock clkIO. By setting the AS2 bit in ASSR, Timer/Counter2 is asynchronously clocked from the TOSC1 pin.
     This enables use of Timer/Counter2 as a Real Time Counter (RTC). When AS2 is set, pins TOSC1 and TOSC2



       2020 Microchip Technology Inc.                      Data Sheet Complete                                                       DS40002061B-page 161
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

       are disconnected from Port B. A crystal can then be connected between the TOSC1 and TOSC2 pins to serve
       as an independent clock source for Timer/Counter2. The Oscillator is optimized for use with a 32.768kHz
       crystal.
       For Timer/Counter2, the possible prescaled selections are: clkT2S/8, clkT2S/32, clkT2S/64, clkT2S/128, clkT2S/256,
       and clkT2S/1024. Additionally, clkT2S as well as 0 (stop) may be selected. Setting the PSRASY bit in GTCCR
       resets the prescaler. This allows the user to operate with a predictable prescaler.

18.11 Register Description

18.11.1 TCCR2A – Timer/Counter Control Register A
        Bit                     7          6           5          4          3          2         1          0
        (0xB0)               COM2A1      COM2A0     COM2B1      COM2B0       –          –      WGM21     WGM20       TCCR2A

        Read/Write             R/W        R/W         R/W        R/W         R          R        R/W       R/W
        Initial Value           0          0           0          0          0          0         0          0


       • Bits 7:6 – COM2A1:0: Compare Match Output A Mode
       These bits control the Output Compare pin (OC2A) behavior. If one or both of the COM2A1:0 bits are set, the
       OC2A output overrides the normal port functionality of the I/O pin it is connected to. However, note that the Data
       Direction Register (DDR) bit corresponding to the OC2A pin must be set in order to enable the output driver.
       When OC2A is connected to the pin, the function of the COM2A1:0 bits depends on the WGM22:0 bit setting.
       Table 18-2 shows the COM2A1:0 bit functionality when the WGM22:0 bits are set to a normal or CTC mode
       (non-PWM).

       Table 18-2.         Compare Output Mode, non-PWM Mode
          COM2A1               COM2A0       Description
                 0                   0      Normal port operation, OC0A disconnected.
                 0                   1      Toggle OC2A on Compare Match
                 1                   0      Clear OC2A on Compare Match
                 1                   1      Set OC2A on Compare Match

       Table 18-3 shows the COM2A1:0 bit functionality when the WGM21:0 bits are set to fast PWM mode.

       Table 18-3.         Compare Output Mode, Fast PWM Mode(1)
          COM2A1               COM2A0       Description
                 0                   0      Normal port operation, OC2A disconnected.
                                            WGM22 = 0: Normal Port Operation, OC0A Disconnected.
                 0                   1
                                            WGM22 = 1: Toggle OC2A on Compare Match.
                                            Clear OC2A on Compare Match, set OC2A at BOTTOM,
                 1                   0
                                            (non-inverting mode).
                                            Set OC2A on Compare Match, clear OC2A at BOTTOM,
                 1                   1
                                            (inverting mode).
       Note:         1.   A special case occurs when OCR2A equals TOP and COM2A1 is set. In this case, the Compare Match is
                          ignored, but the set or clear is done at BOTTOM. See ”Fast PWM Mode” on page 156 for more details.




        2020 Microchip Technology Inc.                           Data Sheet Complete                       DS40002061B-page 162
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

Table 18-4 shows the COM2A1:0 bit functionality when the WGM22:0 bits are set to phase correct PWM mode.

Table 18-4.        Compare Output Mode, Phase Correct PWM Mode(1)
   COM2A1             COM2A0       Description
        0                 0        Normal port operation, OC2A disconnected.
                                   WGM22 = 0: Normal Port Operation, OC2A Disconnected.
        0                 1
                                   WGM22 = 1: Toggle OC2A on Compare Match.
                                   Clear OC2A on Compare Match when up-counting. Set OC2A on
        1                 0
                                   Compare Match when down-counting.
                                   Set OC2A on Compare Match when up-counting. Clear OC2A on
        1                 1
                                   Compare Match when down-counting.

Note:       1.   A special case occurs when OCR2A equals TOP and COM2A1 is set. In this case, the Compare Match is
                 ignored, but the set or clear is done at TOP. See ”Phase Correct PWM Mode” on page 157 for more details.

• Bits 5:4 – COM2B1:0: Compare Match Output B Mode
These bits control the Output Compare pin (OC2B) behavior. If one or both of the COM2B1:0 bits are set, the
OC2B output overrides the normal port functionality of the I/O pin it is connected to. However, note that the Data
Direction Register (DDR) bit corresponding to the OC2B pin must be set in order to enable the output driver.
When OC2B is connected to the pin, the function of the COM2B1:0 bits depends on the WGM22:0 bit setting.
Table 18-5 shows the COM2B1:0 bit functionality when the WGM22:0 bits are set to a normal or CTC mode
(non-PWM).


Table 18-5.        Compare Output Mode, non-PWM Mode
   COM2B1             COM2B0       Description
        0                 0        Normal port operation, OC2B disconnected.
        0                 1        Toggle OC2B on Compare Match
        1                 0        Clear OC2B on Compare Match
        1                 1        Set OC2B on Compare Match
Table 18-6 shows the COM2B1:0 bit functionality when the WGM22:0 bits are set to fast PWM mode.

Table 18-6.        Compare Output Mode, Fast PWM Mode(1)
   COM2B1             COM2B0        Description
        0                 0         Normal port operation, OC2B disconnected.
        0                 1         Reserved
                                    Clear OC2B on Compare Match, set OC2B at BOTTOM,
        1                 0
                                    (non-inverting mode).
                                    Set OC2B on Compare Match, clear OC2B at BOTTOM,
        1                 1
                                    (inverting mode).
Note:       1.   A special case occurs when OCR2B equals TOP and COM2B1 is set. In this case, the Compare Match is
                 ignored, but the set or clear is done at BOTTOM. See ”Phase Correct PWM Mode” on page 157 for more
                 details.




 2020 Microchip Technology Inc.                           Data Sheet Complete                        DS40002061B-page 163
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Table 18-7 shows the COM2B1:0 bit functionality when the WGM22:0 bits are set to phase correct PWM mode.

Table 18-7.          Compare Output Mode, Phase Correct PWM Mode(1)
   COM2B1               COM2B0       Description
         0                  0        Normal port operation, OC2B disconnected.
         0                  1        Reserved
                                     Clear OC2B on Compare Match when up-counting. Set OC2B on
         1                  0
                                     Compare Match when down-counting.
                                     Set OC2B on Compare Match when up-counting. Clear OC2B on
         1                  1
                                     Compare Match when down-counting.
Note:        1.    A special case occurs when OCR2B equals TOP and COM2B1 is set. In this case, the Compare Match is
                   ignored, but the set or clear is done at TOP. See ”Phase Correct PWM Mode” on page 157 for more details.

• Bits 3:2 – Reserved
These bits are reserved in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

• Bits 1:0 – WGM21:0: Waveform Generation Mode
Combined with the WGM22 bit found in the TCCR2B Register, these bits control the counting sequence of the
counter, the source for maximum (TOP) counter value, and what type of waveform generation to be used, see
Table 18-8. Modes of operation supported by the Timer/Counter unit are: Normal mode (counter), Clear Timer
on Compare Match (CTC) mode, and two types of Pulse Width Modulation (PWM) modes (see ”Modes of
Operation” on page 155).


Table 18-8.          Waveform Generation Mode Bit Description
                                                   Timer/Counter
                                                   Mode of                          Update of    TOV Flag
 Mode             WGM22     WGM21      WGM20       Operation              TOP       OCRx at      Set on(1)(2)
    0               0           0         0        Normal                 0xFF      Immediate       MAX
                                                   PWM, Phase
    1               0           0         1                               0xFF        TOP         BOTTOM
                                                   Correct
    2               0           1         0        CTC                   OCRA       Immediate       MAX
    3               0           1         1        Fast PWM               0xFF      BOTTOM          MAX
    4               1           0         0        Reserved                 –          –              –
                                                   PWM, Phase
    5               1           0         1                              OCRA         TOP         BOTTOM
                                                   Correct
    6               1           1         0        Reserved                 –          –              –
    7               1           1         1        Fast PWM              OCRA       BOTTOM          TOP
Notes:       1.    MAX= 0xFF
             2.    BOTTOM= 0x00




 2020 Microchip Technology Inc.                              Data Sheet Complete                         DS40002061B-page 164
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


18.11.2 TCCR2B – Timer/Counter Control Register B
        Bit                7              6          5        4           3           2      1       0
        (0xB1)           FOC2A      FOC2B            –        –        WGM22      CS22     CS21     CS20      TCCR2B

        Read/Write         W          W              R        R         R/W          R/W   R/W      R/W
        Initial Value      0              0          0        0           0           0      0       0


       • Bit 7 – FOC2A: Force Output Compare A
       The FOC2A bit is only active when the WGM bits specify a non-PWM mode.
       However, for ensuring compatibility with future devices, this bit must be set to zero when TCCR2B is written
       when operating in PWM mode. When writing a logical one to the FOC2A bit, an immediate Compare Match is
       forced on the Waveform Generation unit. The OC2A output is changed according to its COM2A1:0 bits setting.
       Note that the FOC2A bit is implemented as a strobe. Therefore it is the value present in the COM2A1:0 bits that
       determines the effect of the forced compare.
       A FOC2A strobe will not generate any interrupt, nor will it clear the timer in CTC mode using OCR2A as TOP.
       The FOC2A bit is always read as zero.

       • Bit 6 – FOC2B: Force Output Compare B
       The FOC2B bit is only active when the WGM bits specify a non-PWM mode.
       However, for ensuring compatibility with future devices, this bit must be set to zero when TCCR2B is written
       when operating in PWM mode. When writing a logical one to the FOC2B bit, an immediate Compare Match is
       forced on the Waveform Generation unit. The OC2B output is changed according to its COM2B1:0 bits setting.
       Note that the FOC2B bit is implemented as a strobe. Therefore it is the value present in the COM2B1:0 bits that
       determines the effect of the forced compare.
       A FOC2B strobe will not generate any interrupt, nor will it clear the timer in CTC mode using OCR2B as TOP.
       The FOC2B bit is always read as zero.

       • Bits 5:4 – Reserved
       These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

       • Bit 3 – WGM22: Waveform Generation Mode
       See the description in the ”TCCR2A – Timer/Counter Control Register A” on page 162.

       • Bit 2:0 – CS22:0: Clock Select
       The three Clock Select bits select the clock source to be used by the Timer/Counter, see Table 18-9 on page
       165.

       Table 18-9.      Clock Select Bit Description
              CS22          CS21              CS20       Description
                 0             0               0         No clock source (Timer/Counter stopped).
                 0             0               1         clkT2S/(No prescaling)
                 0             1               0         clkT2S/8 (From prescaler)
                 0             1               1         clkT2S/32 (From prescaler)
                 1             0               0         clkT2S/64 (From prescaler)




        2020 Microchip Technology Inc.                           Data Sheet Complete                      DS40002061B-page 165
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 18-9.      Clock Select Bit Description
              CS22             CS21            CS20      Description
                 1              0               1        clkT2S/128 (From prescaler)
                 1              1               0        clkT2S/256 (From prescaler)
                 1              1               1        clkT2S/1024 (From prescaler)
       If external pin modes are used for the Timer/Counter0, transitions on the T0 pin will clock the counter even if the
       pin is configured as an output. This feature allows software control of the counting.

18.11.3 TCNT2 – Timer/Counter Register
        Bit                7           6         5        4          3         2           1          0
        (0xB2)                                            TCNT2[7:0]                                      TCNT2
        Read/Write        R/W         R/W       R/W      R/W        R/W       R/W         R/W     R/W
        Initial Value      0           0         0        0          0         0           0          0

       The Timer/Counter Register gives direct access, both for read and write operations, to the Timer/Counter unit 8-
       bit counter. Writing to the TCNT2 Register blocks (removes) the Compare Match on the following timer clock.
       Modifying the counter (TCNT2) while the counter is running, introduces a risk of missing a Compare Match
       between TCNT2 and the OCR2x Registers.

18.11.4 OCR2A – Output Compare Register A
        Bit                7           6         5        4          3         2           1          0
        (0xB3)                                            OCR2A[7:0]                                      OCR2A
        Read/Write        R/W         R/W       R/W      R/W        R/W       R/W         R/W     R/W
        Initial Value      0           0         0        0          0         0           0          0

       The Output Compare Register A contains an 8-bit value that is continuously compared with the counter value
       (TCNT2). A match can be used to generate an Output Compare interrupt, or to generate a waveform output on
       the OC2A pin.

18.11.5 OCR2B – Output Compare Register B
        Bit                7           6         5        4          3         2           1          0
        (0xB4)                                            OCR2B[7:0]                                      OCR2B
        Read/Write        R/W         R/W       R/W      R/W        R/W       R/W         R/W     R/W
        Initial Value      0           0         0        0          0         0           0          0

       The Output Compare Register B contains an 8-bit value that is continuously compared with the counter value
       (TCNT2). A match can be used to generate an Output Compare interrupt, or to generate a waveform output on
       the OC2B pin.

18.11.6 TIMSK2 – Timer/Counter2 Interrupt Mask Register
        Bit                7               6         5         4          3          2            1         0
        (0x70)             –               –         –         –          –        OCIE2B       OCIE2A    TOIE2       TIMSK2
        Read/Write         R               R         R         R          R         R/W          R/W       R/W
        Initial Value      0               0         0         0          0          0            0         0


       • Bit 2 – OCIE2B: Timer/Counter2 Output Compare Match B Interrupt Enable
       When the OCIE2B bit is written to one and the I-bit in the Status Register is set (one), the Timer/Counter2
       Compare Match B interrupt is enabled. The corresponding interrupt is executed if a compare match in
       Timer/Counter2 occurs, i.e., when the OCF2B bit is set in the Timer/Counter 2 Interrupt Flag Register – TIFR2.




        2020 Microchip Technology Inc.                            Data Sheet Complete                          DS40002061B-page 166
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

       • Bit 1 – OCIE2A: Timer/Counter2 Output Compare Match A Interrupt Enable
       When the OCIE2A bit is written to one and the I-bit in the Status Register is set (one), the Timer/Counter2
       Compare Match A interrupt is enabled. The corresponding interrupt is executed if a compare match in
       Timer/Counter2 occurs, i.e., when the OCF2A bit is set in the Timer/Counter 2 Interrupt Flag Register – TIFR2.

       • Bit 0 – TOIE2: Timer/Counter2 Overflow Interrupt Enable
       When the TOIE2 bit is written to one and the I-bit in the Status Register is set (one), the Timer/Counter2
       Overflow interrupt is enabled. The corresponding interrupt is executed if an overflow in Timer/Counter2 occurs,
       i.e., when the TOV2 bit is set in the Timer/Counter2 Interrupt Flag Register – TIFR2.

18.11.7 TIFR2 – Timer/Counter2 Interrupt Flag Register
        Bit                 7              6         5        4           3          2          1              0
        0x17 (0x37)         –           –            –        –           –       OCF2B       OCF2A        TOV2           TIFR2
        Read/Write          R           R            R        R           R         R/W        R/W            R/W
        Initial Value       0              0         0        0           0          0          0              0


       • Bit 2 – OCF2B: Output Compare Flag 2 B
       The OCF2B bit is set (one) when a compare match occurs between the Timer/Counter2 and the data in OCR2B
       – Output Compare Register2. OCF2B is cleared by hardware when executing the corresponding interrupt
       handling vector. Alternatively, OCF2B is cleared by writing a logic one to the flag. When the I-bit in SREG,
       OCIE2B (Timer/Counter2 Compare match Interrupt Enable), and OCF2B are set (one), the Timer/Counter2
       Compare match Interrupt is executed.

       • Bit 1 – OCF2A: Output Compare Flag 2 A
       The OCF2A bit is set (one) when a compare match occurs between the Timer/Counter2 and the data in OCR2A
       – Output Compare Register2. OCF2A is cleared by hardware when executing the corresponding interrupt
       handling vector. Alternatively, OCF2A is cleared by writing a logic one to the flag. When the I-bit in SREG,
       OCIE2A (Timer/Counter2 Compare match Interrupt Enable), and OCF2A are set (one), the Timer/Counter2
       Compare match Interrupt is executed.

       • Bit 0 – TOV2: Timer/Counter2 Overflow Flag
       The TOV2 bit is set (one) when an overflow occurs in Timer/Counter2. TOV2 is cleared by hardware when
       executing the corresponding interrupt handling vector. Alternatively, TOV2 is cleared by writing a logic one to
       the flag. When the SREG I-bit, TOIE2A (Timer/Counter2 Overflow Interrupt Enable), and TOV2 are set (one),
       the Timer/Counter2 Overflow interrupt is executed. In PWM mode, this bit is set when Timer/Counter2 changes
       counting direction at 0x00.

18.11.8 ASSR – Asynchronous Status Register
        Bit             7         6            5     4         3              2           1            0
        (0xB6)          –       EXCLK      AS2     TCN2UB   OCR2AUB     OCR2BUB      TCR2AUB        TCR2BUB        ASSR
        Read/Write      R        R/W       R/W       R        R               R           R           R
        Initial Value   0         0            0     0         0              0           0            0


       • Bit 7 – Reserved
       This bit is reserved and will always read as zero.

       • Bit 6 – EXCLK: Enable External Clock Input
       When EXCLK is written to one, and asynchronous clock is selected, the external clock input buffer is enabled
       and an external clock can be input on Timer Oscillator 1 (TOSC1) pin instead of a 32kHz crystal. Writing to




         2020 Microchip Technology Inc.                           Data Sheet Complete                              DS40002061B-page 167
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       EXCLK should be done before asynchronous operation is selected. Note that the crystal Oscillator will only run
       when this bit is zero.

       • Bit 5 – AS2: Asynchronous Timer/Counter2
       When AS2 is written to zero, Timer/Counter2 is clocked from the I/O clock, clkI/O. When AS2 is written to one,
       Timer/Counter2 is clocked from a crystal Oscillator connected to the Timer Oscillator 1 (TOSC1) pin. When the
       value of AS2 is changed, the contents of TCNT2, OCR2A, OCR2B, TCCR2A and TCCR2B might be corrupted.

       • Bit 4 – TCN2UB: Timer/Counter2 Update Busy
       When Timer/Counter2 operates asynchronously and TCNT2 is written, this bit becomes set. When TCNT2 has
       been updated from the temporary storage register, this bit is cleared by hardware. A logical zero in this bit
       indicates that TCNT2 is ready to be updated with a new value.
       • Bit 3 – OCR2AUB: Output Compare Register2 Update Busy
       When Timer/Counter2 operates asynchronously and OCR2A is written, this bit becomes set. When OCR2A has
       been updated from the temporary storage register, this bit is cleared by hardware. A logical zero in this bit
       indicates that OCR2A is ready to be updated with a new value.

       • Bit 2 – OCR2BUB: Output Compare Register2 Update Busy
       When Timer/Counter2 operates asynchronously and OCR2B is written, this bit becomes set. When OCR2B has
       been updated from the temporary storage register, this bit is cleared by hardware. A logical zero in this bit
       indicates that OCR2B is ready to be updated with a new value.

       • Bit 1 – TCR2AUB: Timer/Counter Control Register2 Update Busy
       When Timer/Counter2 operates asynchronously and TCCR2A is written, this bit becomes set. When TCCR2A
       has been updated from the temporary storage register, this bit is cleared by hardware. A logical zero in this bit
       indicates that TCCR2A is ready to be updated with a new value.

       • Bit 0 – TCR2BUB: Timer/Counter Control Register2 Update Busy
       When Timer/Counter2 operates asynchronously and TCCR2B is written, this bit becomes set. When TCCR2B
       has been updated from the temporary storage register, this bit is cleared by hardware. A logical zero in this bit
       indicates that TCCR2B is ready to be updated with a new value.
       If a write is performed to any of the five Timer/Counter2 Registers while its update busy flag is set, the updated
       value might get corrupted and cause an unintentional interrupt to occur.
       The mechanisms for reading TCNT2, OCR2A, OCR2B, TCCR2A and TCCR2B are different. When reading
       TCNT2, the actual timer value is read. When reading OCR2A, OCR2B, TCCR2A and TCCR2B the value in the
       temporary storage register is read.

18.11.9 GTCCR – General Timer/Counter Control Register
       Bit               7          6      5          4        3         2         1         0
       0x23 (0x43)     TSM          –      –          –         –        –       PSRASY   PSRSYNC   GTCCR
       Read/Write      R/W          R      R         R         R         R        R/W       R/W
       Initial Value     0          0      0          0        0         0         0         0


       • Bit 1 – PSRASY: Prescaler Reset Timer/Counter2
       When this bit is one, the Timer/Counter2 prescaler will be reset. This bit is normally cleared immediately by
       hardware. If the bit is written when Timer/Counter2 is operating in asynchronous mode, the bit will remain one
       until the prescaler has been reset. The bit will not be cleared by hardware if the TSM bit is set. Refer to the
       description of the ”Bit 7 – TSM: Timer/Counter Synchronization Mode” on page 149 for a description of the
       Timer/Counter Synchronization mode.




        2020 Microchip Technology Inc.                    Data Sheet Complete                        DS40002061B-page 168
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P


19.    SPI – Serial Peripheral Interface

19.1   Features
       •   Full-duplex, Three-wire Synchronous Data Transfer
       •   Master or Slave Operation
       •   LSB First or MSB First Data Transfer
       •   Seven Programmable Bit Rates
       •   End of Transmission Interrupt Flag
       •   Write Collision Flag Protection
       •   Wake-up from Idle Mode
       •   Double Speed (CK/2) Master SPI Mode


19.2   Overview
       The Serial Peripheral Interface (SPI) allows high-speed synchronous data transfer between the
       ATmega48A/PA/88A/PA/168A/PA/328/P and peripheral devices or between several AVR devices.
       The USART can also be used in Master SPI mode, see “USART in SPI Mode” on page 205. The PRSPI bit in
       ”Minimizing Power Consumption” on page 51 must be written to zero to enable SPI module.

       Figure 19-1.    SPI Block Diagram(1)




                                 DIVIDER
                           /2/4/8/16/32/64/128
                             SPI2X




                                                 SPI2X




       Note:     1. Refer to Figure 1-1 on page 12, and Table 14-3 on page 91 for SPI pin placement.
       The interconnection between Master and Slave CPUs with SPI is shown in Figure 19-2 on page 170. The
       system consists of two shift Registers, and a Master clock generator. The SPI Master initiates the



        2020 Microchip Technology Inc.                        Data Sheet Complete                     DS40002061B-page 169
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

communication cycle when pulling low the Slave Select SS pin of the desired Slave. Master and Slave prepare
the data to be sent in their respective shift Registers, and the Master generates the required clock pulses on the
SCK line to interchange data. Data is always shifted from Master to Slave on the Master Out – Slave In, MOSI,
line, and from Slave to Master on the Master In – Slave Out, MISO, line. After each data packet, the Master will
synchronize the Slave by pulling high the Slave Select, SS, line.
When configured as a Master, the SPI interface has no automatic control of the SS line. This must be handled
by user software before communication can start. When this is done, writing a byte to the SPI Data Register
starts the SPI clock generator, and the hardware shifts the eight bits into the Slave. After shifting one byte, the
SPI clock generator stops, setting the end of Transmission Flag (SPIF). If the SPI Interrupt Enable bit (SPIE) in
the SPCR Register is set, an interrupt is requested. The Master may continue to shift the next byte by writing it
into SPDR, or signal the end of packet by pulling high the Slave Select, SS line. The last incoming byte will be
kept in the Buffer Register for later use.
When configured as a Slave, the SPI interface will remain sleeping with MISO tri-stated as long as the SS pin is
driven high. In this state, software may update the contents of the SPI Data Register, SPDR, but the data will not
be shifted out by incoming clock pulses on the SCK pin until the SS pin is driven low. As one byte has been
completely shifted, the end of Transmission Flag, SPIF is set. If the SPI Interrupt Enable bit, SPIE, in the SPCR
Register is set, an interrupt is requested. The Slave may continue to place new data to be sent into SPDR
before reading the incoming data. The last incoming byte will be kept in the Buffer Register for later use.

Figure 19-2.   SPI Master-slave Interconnection




                                                                                     SHIFT
                                                                                     ENABLE




The system is single buffered in the transmit direction and double buffered in the receive direction. This means
that bytes to be transmitted cannot be written to the SPI Data Register before the entire shift cycle is completed.
When receiving data, however, a received character must be read from the SPI Data Register before the next
character has been completely shifted in. Otherwise, the first byte is lost.
In SPI Slave mode, the control logic will sample the incoming signal of the SCK pin. To ensure correct sampling
of the clock signal, the minimum low and high periods should be:
Low periods: Longer than 2 CPU clock cycles.
High periods: Longer than 2 CPU clock cycles.
When the SPI is enabled, the data direction of the MOSI, MISO, SCK, and SS pins is overridden according to
Table 19-1 on page 171. For more details on automatic port overrides, refer to ”Alternate Port Functions” on
page 89.




 2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 170
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


Table 19-1.     SPI Pin Overrides(Note:)
        Pin       Direction, Master SPI                           Direction, Slave SPI
    MOSI          User Defined                                    Input
    MISO          Input                                           User Defined
        SCK       User Defined                                    Input
        SS        User Defined                                    Input

Note:     See ”Alternate Functions of Port B” on page 91 for a detailed description of how to define the direction of the user
          defined SPI pins.
The following code examples show how to initialize the SPI as a Master and how to perform a simple
transmission. DDR_SPI in the examples must be replaced by the actual Data Direction Register controlling the
SPI pins. DD_MOSI, DD_MISO and DD_SCK must be replaced by the actual data direction bits for these pins.
E.g. if MOSI is placed on pin PB5, replace DD_MOSI with DDB5 and DDR_SPI with DDRB.




 2020 Microchip Technology Inc.                           Data Sheet Complete                          DS40002061B-page 171
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

 Assembly Code Example(1)
          SPI_MasterInit:
                ; Set MOSI and SCK output, all others input
                ldi             r17,(1<<DD_MOSI)|(1<<DD_SCK)
                out             DDR_SPI,r17
                ; Enable SPI, Master, set clock rate fck/16
                ldi             r17,(1<<SPE)|(1<<MSTR)|(1<<SPR0)
                out             SPCR,r17
                ret

          SPI_MasterTransmit:
                ; Start transmission of data (r16)
                out             SPDR,r16
          Wait_Transmit:
                ; Wait for transmission complete
                in              r16, SPSR
                sbrs      r16, SPIF
                rjmp            Wait_Transmit
                ret
 C Code Example(1)
          void SPI_MasterInit(void)
          {
                /* Set MOSI and SCK output, all others input */
                DDR_SPI = (1<<DD_MOSI)|(1<<DD_SCK);
                /* Enable SPI, Master, set clock rate fck/16 */
                SPCR = (1<<SPE)|(1<<MSTR)|(1<<SPR0);
          }

          void SPI_MasterTransmit(char cData)
          {
                /* Start transmission */
                SPDR = cData;
                /* Wait for transmission complete */
                while(!(SPSR & (1<<SPIF)))
                   ;
          }
Note:   1.   See ”About Code Examples” on page 17.




 2020 Microchip Technology Inc.                     Data Sheet Complete   DS40002061B-page 172
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

The following code examples show how to initialize the SPI as a Slave and how to perform a simple reception.
 Assembly Code Example(1)
          SPI_SlaveInit:
                ; Set MISO output, all others input
                ldi             r17,(1<<DD_MISO)
                out             DDR_SPI,r17
                ; Enable SPI
                ldi             r17,(1<<SPE)
                out             SPCR,r17
                ret

          SPI_SlaveReceive:
                ; Wait for reception complete
                in r16, SPSR
                sbrs r16, SPIF
                rjmp            SPI_SlaveReceive
                ; Read received data and return
                in              r16,SPDR
                ret


 C Code Example(1)
          void SPI_SlaveInit(void)
          {
                /* Set MISO output, all others input */
                DDR_SPI = (1<<DD_MISO);
                /* Enable SPI */
                SPCR = (1<<SPE);
          }

          char SPI_SlaveReceive(void)
          {
                /* Wait for reception complete */
                while(!(SPSR & (1<<SPIF)))
                   ;
                /* Return Data Register */
                return SPDR;
          }

Note:   1.   See ”About Code Examples” on page 17.




 2020 Microchip Technology Inc.                     Data Sheet Complete                 DS40002061B-page 173
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


19.3   SS Pin Functionality

19.3.1 Slave Mode
       When the SPI is configured as a Slave, the Slave Select (SS) pin is always input. When SS is held low, the SPI
       is activated, and MISO becomes an output if configured so by the user. All other pins are inputs. When SS is
       driven high, all pins are inputs, and the SPI is passive, which means that it will not receive incoming data. Note
       that the SPI logic will be reset once the SS pin is driven high.
       The SS pin is useful for packet/byte synchronization to keep the slave bit counter synchronous with the master
       clock generator. When the SS pin is driven high, the SPI slave will immediately reset the send and receive logic,
       and drop any partially received data in the Shift Register.

19.3.2 Master Mode
       When the SPI is configured as a Master (MSTR in SPCR is set), the user can determine the direction of the SS
       pin.
       If SS is configured as an output, the pin is a general output pin which does not affect the SPI system. Typically,
       the pin will be driving the SS pin of the SPI Slave.
       If SS is configured as an input, it must be held high to ensure Master SPI operation. If the SS pin is driven low by
       peripheral circuitry when the SPI is configured as a Master with the SS pin defined as an input, the SPI system
       interprets this as another master selecting the SPI as a slave and starting to send data to it. To avoid bus
       contention, the SPI system takes the following actions:
       1. The MSTR bit in SPCR is cleared and the SPI system becomes a Slave. As a result of the SPI becoming
          a Slave, the MOSI and SCK pins become inputs.
        2.    The SPIF Flag in SPSR is set, and if the SPI interrupt is enabled, and the I-bit in SREG is set, the interrupt
              routine will be executed.
       Thus, when interrupt-driven SPI transmission is used in Master mode, and there exists a possibility that SS is
       driven low, the interrupt should always check that the MSTR bit is still set. If the MSTR bit has been cleared by
       a slave select, it must be set by the user to re-enable SPI Master mode.

19.4   Data Modes
       There are four combinations of SCK phase and polarity with respect to serial data, which are determined by
       control bits CPHA and CPOL. The SPI data transfer formats are shown in Figure 19-3 and Figure 19-4 on page
       175. Data bits are shifted out and latched in on opposite edges of the SCK signal, ensuring sufficient time for
       data signals to stabilize. This is clearly seen by summarizing Table 19-3 on page 176 and Table 19-4 on page
       176, as done in Table 19-2.

       Table 19-2.      SPI Modes
             SPI Mode               Conditions               Leading Edge               Trailing eDge
                0                CPOL=0, CPHA=0              Sample (Rising)            Setup (Falling)
                1                CPOL=0, CPHA=1               Setup (Rising)           Sample (Falling)
                2                CPOL=1, CPHA=0             Sample (Falling)            Setup (Rising)
                3                CPOL=1, CPHA=1              Setup (Falling)           Sample (Rising)




        2020 Microchip Technology Inc.                      Data Sheet Complete                          DS40002061B-page 174
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 19-3.   SPI Transfer Format with CPHA = 0

                    SCK (CPOL = 0)
                    mode 0
                    SCK (CPOL = 1)
                    mode 2

                    SAMPLE I
                    MOSI/MISO

                    CHANGE 0
                    MOSI PIN
                    CHANGE 0
                    MISO PIN


                    SS


                      MSB first (DORD = 0) MSB         Bit 6           Bit 5           Bit 4           Bit 3           Bit 2           Bit 1           LSB
                      LSB first (DORD = 1) LSB         Bit 1           Bit 2           Bit 3           Bit 4           Bit 5           Bit 6           MSB



Figure 19-4.   SPI Transfer Format with CPHA = 1

                    SCK (CPOL = 0)
                    mode 1
                    SCK (CPOL = 1)
                    mode 3

                    SAMPLE I
                    MOSI/MISO

                    CHANGE 0
                    MOSI PIN
                    CHANGE 0
                    MISO PIN


                    SS


                      MSB first (DORD = 0)       MSB           Bit 6           Bit 5           Bit 4           Bit 3           Bit 2           Bit 1         LSB
                      LSB first (DORD = 1)       LSB           Bit 1           Bit 2           Bit 3           Bit 4           Bit 5           Bit 6         MSB




 2020 Microchip Technology Inc.                                         Data Sheet Complete                                                                  DS40002061B-page 175
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P


19.5   Register Description

19.5.1 SPCR – SPI Control Register
        Bit                   7      6         5        4          3         2          1           0
        0x2C (0x4C)       SPIE     SPE    DORD        MSTR       CPOL     CPHA         SPR1       SPR0      SPCR
        Read/Write           R/W    R/W       R/W      R/W        R/W       R/W        R/W         R/W
        Initial Value         0      0         0        0          0         0          0           0


       • Bit 7 – SPIE: SPI Interrupt Enable
       This bit causes the SPI interrupt to be executed if SPIF bit in the SPSR Register is set and the if the Global
       Interrupt Enable bit in SREG is set.

       • Bit 6 – SPE: SPI Enable
       When the SPE bit is written to one, the SPI is enabled. This bit must be set to enable any SPI operations.

       • Bit 5 – DORD: Data Order
       When the DORD bit is written to one, the LSB of the data word is transmitted first.
       When the DORD bit is written to zero, the MSB of the data word is transmitted first.

       • Bit 4 – MSTR: Master/Slave Select
       This bit selects Master SPI mode when written to one, and Slave SPI mode when written logic zero. If SS is
       configured as an input and is driven low while MSTR is set, MSTR will be cleared, and SPIF in SPSR will
       become set. The user will then have to set MSTR to re-enable SPI Master mode.

       • Bit 3 – CPOL: Clock Polarity
       When this bit is written to one, SCK is high when idle. When CPOL is written to zero, SCK is low when idle.
       Refer to Figure 19-3 and Figure 19-4 for an example. The CPOL functionality is summarized below:

       Table 19-3.       CPOL Functionality
                        CPOL                        Leading Edge                         Trailing Edge
                         0                             Rising                                  Falling
                         1                             Falling                                 Rising

       • Bit 2 – CPHA: Clock Phase
       The settings of the Clock Phase bit (CPHA) determine if data is sampled on the leading (first) or trailing (last)
       edge of SCK. Refer to Figure 19-3 and Figure 19-4 for an example. The CPOL functionality is summarized
       below:

       Table 19-4.       CPHA Functionality
                        CPHA                        Leading Edge                            Trailing Edge
                         0                            Sample                                   Setup
                         1                             Setup                                  Sample

       • Bits 1, 0 – SPR1, SPR0: SPI Clock Rate Select 1 and 0
       These two bits control the SCK rate of the device configured as a Master. SPR1 and SPR0 have no effect on
       the Slave. The relationship between SCK and the Oscillator Clock frequency fosc is shown in the following table:




        2020 Microchip Technology Inc.                          Data Sheet Complete                          DS40002061B-page 176
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


       Table 19-5.      Relationship Between SCK and the Oscillator Frequency
                SPI2X               SPR1             SPR0          SCK Frequency
                    0                    0               0         fosc/4
                    0                    0               1         fosc/16
                    0                    1               0         fosc/64
                    0                    1               1         fosc/128
                    1                    0               0         fosc/2
                    1                    0               1         fosc/8
                    1                    1               0         fosc/32
                    1                    1               1         fosc/64

19.5.2 SPSR – SPI Status Register
        Bit                7         6       5       4         3         2         1      0
        0x2D (0x4D)      SPIF     WCOL       –       –         –         –         –   SPI2X     SPSR
        Read/Write         R         R       R       R         R         R         R    R/W
        Initial Value      0         0       0       0         0         0         0      0


       • Bit 7 – SPIF: SPI Interrupt Flag
       When a serial transfer is complete, the SPIF Flag is set. An interrupt is generated if SPIE in SPCR is set and
       global interrupts are enabled. If SS is an input and is driven low when the SPI is in Master mode, this will also
       set the SPIF Flag. SPIF is cleared by hardware when executing the corresponding interrupt handling vector.
       Alternatively, the SPIF bit is cleared by first reading the SPI Status Register with SPIF set, then accessing the
       SPI Data Register (SPDR).

       • Bit 6 – WCOL: Write COLlision Flag
       The WCOL bit is set if the SPI Data Register (SPDR) is written during a data transfer. The WCOL bit (and the
       SPIF bit) are cleared by first reading the SPI Status Register with WCOL set, and then accessing the SPI Data
       Register.

       • Bit [5:1] – Reserved
       These bits are reserved bits in the ATmega48A/PA/88A/PA/168A/PA/328/P and will always read as zero.

       • Bit 0 – SPI2X: Double SPI Speed Bit
       When this bit is written logic one the SPI speed (SCK Frequency) will be doubled when the SPI is in Master
       mode (see Table 19-5). This means that the minimum SCK period will be two CPU clock periods. When the SPI
       is configured as Slave, the SPI is only ensured to work at fosc/4 or lower.
       The SPI interface on the ATmega48A/PA/88A/PA/168A/PA/328/P is also used for program memory and
       EEPROM downloading or uploading. See page 303 for serial programming and verification.




        2020 Microchip Technology Inc.                      Data Sheet Complete                     DS40002061B-page 177
                                                ATmega48A/PA/88A/PA/168A/PA/328/P


19.5.3 SPDR – SPI Data Register
        Bit               7          6     5        4        3         2          1     0
        0x2E (0x4E)     MSB                                                            LSB      SPDR
        Read/Write       R/W       R/W    R/W      R/W      R/W      R/W         R/W   R/W
        Initial Value     X          X     X        X        X        X           X     X      Undefined

       The SPI Data Register is a read/write register used for data transfer between the Register File and the SPI Shift
       Register. Writing to the register initiates data transmission. Reading the register causes the Shift Register
       Receive buffer to be read.




        2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 178
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


20.    USART0

20.1   Features
       •   Full Duplex Operation (Independent Serial Receive and Transmit Registers)
       •   Asynchronous or Synchronous Operation
       •   Master or Slave Clocked Synchronous Operation
       •   High Resolution Baud Rate Generator
       •   Supports Serial Frames with 5, 6, 7, 8, or 9 Data Bits and 1 or 2 Stop Bits
       •   Odd or Even Parity Generation and Parity Check Supported by Hardware
       •   Data OverRun Detection
       •   Framing Error Detection
       •   Noise Filtering Includes False Start Bit Detection and Digital Low Pass Filter
       •   Three Separate Interrupts on TX Complete, TX Data Register Empty and RX Complete
       •   Multi-processor Communication Mode
       •   Double Speed Asynchronous Communication Mode


20.2   Overview
       The Universal Synchronous and Asynchronous serial Receiver and Transmitter (USART) is a highly flexible
       serial communication device.
       The USART0 can also be used in Master SPI mode, see “USART in SPI Mode” on page 205. The Power
       Reduction USART bit, PRUSART0, in ”Minimizing Power Consumption” on page 51 must be disabled by writing
       a logical zero to it.
       A simplified block diagram of the USART Transmitter is shown in Figure 20-1 on page 180. CPU accessible I/O
       Registers and I/O pins are shown in bold.
       The dashed boxes in the block diagram separate the three main parts of the USART (listed from the top): Clock
       Generator, Transmitter and Receiver. Control Registers are shared by all units. The Clock Generation logic
       consists of synchronization logic for external clock input used by synchronous slave operation, and the baud
       rate generator. The XCKn (Transfer Clock) pin is only used by synchronous transfer mode. The Transmitter
       consists of a single write buffer, a serial Shift Register, Parity Generator and Control logic for handling different
       serial frame formats. The write buffer allows a continuous transfer of data without any delay between frames.
       The Receiver is the most complex part of the USART module due to its clock and data recovery units. The
       recovery units are used for asynchronous data reception. In addition to the recovery units, the Receiver includes
       a Parity Checker, Control logic, a Shift Register and a two level receive buffer (UDRn). The Receiver supports
       the same frame formats as the Transmitter, and can detect Frame Error, Data OverRun and Parity Errors.




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 179
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 20-1.   USART Block Diagram(1)



                                                                                               Clock Generator

                                                         UBRRn [H:L]
                                                                                      OSC



                                                   BAUD RATE GENERATOR



                                                                                  SYNC LOGIC        PIN
                                                                                                                 XCKn
                                                                                                  CONTROL


                                                                                                   Transmitter
                                                                                                    TX
                                                       UDRn(Transmit)
                                                                                                  CONTROL
                                                                                    PARITY
                                                                                  GENERATOR
                           DATA BUS




                                                                                                    PIN
                                               TRANSMIT SHIFT REGISTER                                           TxDn
                                                                                                  CONTROL


                                                                                                     Receiver
                                                                                    CLOCK           RX
                                                                                  RECOVERY        CONTROL



                                                                                    DATA            PIN
                                                   RECEIVE SHIFT REGISTER                                        RxDn
                                                                                  RECOVERY        CONTROL



                                                                                    PARITY
                                                       UDRn (Receive)
                                                                                   CHECKER




                                          UCSRnA                             UCSRnB                    UCSRnC




       Note:   1. Refer to Figure 1-1 on page 12 and Table 14-9 on page 97 for USART0 pin placement.


20.3   Clock Generation
       The Clock Generation logic generates the base clock for the Transmitter and Receiver. The USART supports
       four modes of clock operation: Normal asynchronous, Double Speed asynchronous, Master synchronous and
       Slave synchronous mode. The UMSELn bit in USART Control and Status Register C (UCSRnC) selects
       between asynchronous and synchronous operation. Double Speed (asynchronous mode only) is controlled by
       the U2Xn found in the UCSRnA Register. When using synchronous mode (UMSELn = 1), the Data Direction
       Register for the XCKn pin (DDR_XCKn) controls whether the clock source is internal (Master mode) or external
       (Slave mode). The XCKn pin is only active when using synchronous mode.




        2020 Microchip Technology Inc.                                 Data Sheet Complete                        DS40002061B-page 180
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 20-2 shows a block diagram of the clock generation logic.

       Figure 20-2.   Clock Generation Logic, Block Diagram
                                                UBRRn
                                                                                                         U2Xn
                                                              foscn

                                             Prescaling      UBRRn+1
                                                                            /2        /4         /2
                                            Down-Counter                                                  0
                                                                                                          1
                                                                                                                 0
                                          OSC                                                                          txclk
                                                                                                                 1
                                                                                                      DDR_XCKn

                                                 Sync            Edge
                                   xcki         Register        Detector                                  0
                          XCKn                                                                                       UMSELn
                                   xcko                                                                   1
                           Pin



                        DDR_XCKn                                 UCPOLn                                          1
                                                                                                                       rxclk
                                                                                                                 0




       Signal description:
             txclk           Transmitter clock (Internal Signal).
             rxclk           Receiver base clock (Internal Signal).
             xcki            Input from XCK pin (internal Signal). Used for synchronous slave operation.
             xcko            Clock output to XCK pin (Internal Signal). Used for synchronous master
                             operation.
             fosc            System clock frequency.

20.3.1 Internal Clock Generation – The Baud Rate Generator
       Internal clock generation is used for the asynchronous and the synchronous master modes of operation. The
       description in this section refers to Figure 20-2.
       The USART Baud Rate Register (UBRRn) and the down-counter connected to it function as a programmable
       prescaler or baud rate generator. The down-counter, running at system clock (fosc), is loaded with the UBRRn
       value each time the counter has counted down to zero or when the UBRRnL Register is written. A clock is
       generated each time the counter reaches zero. This clock is the baud rate generator clock output (=
       fosc/(UBRRn+1)). The Transmitter divides the baud rate generator clock output by 2, 8 or 16 depending on
       mode. The baud rate generator output is used directly by the Receiver’s clock and data recovery units.
       However, the recovery units use a state machine that uses 2, 8 or 16 states depending on mode set by the state
       of the UMSELn, U2Xn and DDR_XCKn bits.




        2020 Microchip Technology Inc.                                    Data Sheet Complete                       DS40002061B-page 181
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 20-1 contains equations for calculating the baud rate (in bits per second) and for calculating the UBRRn
       value for each mode of operation using an internally generated clock source.

       Table 20-1.     Equations for Calculating Baud Rate Register Setting
                                             Equation for Calculating Baud                        Equation for Calculating
        Operating Mode                                   Rate(1)                                      UBRRn Value




        Asynchronous Normal mode                                    f OSC                                       f OSC
        (U2Xn = 0)                            BAUD = ------------------------------------------   UBRRn = ------------------------ – 1
                                                     16  UBRRn + 1                                      16BAUD




        Asynchronous Double Speed                                   f OSC                                      f OSC
        mode (U2Xn = 1)                        BAUD = ---------------------------------------     UBRRn = -------------------- – 1
                                                      8  UBRRn + 1                                      8BAUD




                                                                    f OSC                                      f OSC
        Synchronous Master mode                BAUD = ---------------------------------------     UBRRn = -------------------- – 1
                                                      2  UBRRn + 1                                      2BAUD




       Note:   1.    The baud rate is defined to be the transfer rate in bit per second (bps)
       BAUDBaud rate (in bits per second, bps)
       fOSCSystem Oscillator clock frequency
       UBRRnContents of the UBRRnH and UBRRnL Registers, (0-4095)
       Some examples of UBRRn values for some system clock frequencies are found in Table 20-4 (see page 196).

20.3.2 Double Speed Operation (U2Xn)
       The transfer rate can be doubled by setting the U2Xn bit in UCSRnA. Setting this bit only has effect for the
       asynchronous operation. Set this bit to zero when using synchronous operation.
       Setting this bit will reduce the divisor of the baud rate divider from 16 to 8, effectively doubling the transfer rate
       for asynchronous communication. Note however that the Receiver will in this case only use half the number of
       samples (reduced from 16 to 8) for data sampling and clock recovery, and therefore a more accurate baud rate
       setting and system clock are required when this mode is used. For the Transmitter, there are no downsides.

20.3.3 External Clock
       External clocking is used by the synchronous slave modes of operation. The description in this section refers to
       Figure 20-2 for details.




        2020 Microchip Technology Inc.                                     Data Sheet Complete                                      DS40002061B-page 182
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       External clock input from the XCKn pin is sampled by a synchronization register to minimize the chance of meta-
       stability. The output from the synchronization register must then pass through an edge detector before it can be
       used by the Transmitter and Receiver. This process introduces a two CPU clock period delay and therefore the
       maximum external XCKn clock frequency is limited by the following equation:
                                                                    f OSC
                                                            f XCK  -----------
                                                                        4

       Note that fosc depends on the stability of the system clock source. It is therefore recommended to add some
       margin to avoid possible loss of data due to frequency variations.

20.3.4 Synchronous Clock Operation
       When synchronous mode is used (UMSELn = 1), the XCKn pin will be used as either clock input (Slave) or clock
       output (Master). The dependency between the clock edges and data sampling or data change is the same. The
       basic principle is that data input (on RxDn) is sampled at the opposite XCKn clock edge of the edge the data
       output (TxDn) is changed.

       Figure 20-3.   Synchronous Mode XCKn Timing.


                           UCPOL = 1      XCK


                                       RxD / TxD

                                                                                    Sample

                           UCPOL = 0      XCK


                                       RxD / TxD

                                                                                    Sample


       The UCPOLn bit UCRSC selects which XCKn clock edge is used for data sampling and which is used for data
       change. As Figure 20-3 shows, when UCPOLn is zero the data will be changed at rising XCKn edge and
       sampled at falling XCKn edge. If UCPOLn is set, the data will be changed at falling XCKn edge and sampled at
       rising XCKn edge.

20.4   Frame Formats
       A serial frame is defined to be one character of data bits with synchronization bits (start and stop bits), and
       optionally a parity bit for error checking. The USART accepts all 30 combinations of the following as valid frame
       formats:
            1 start bit
            5, 6, 7, 8, or 9 data bits
            no, even or odd parity bit
            1 or 2 stop bits
       A frame starts with the start bit followed by the least significant data bit. Then the next data bits, up to a total of
       nine, are succeeding, ending with the most significant bit. If enabled, the parity bit is inserted after the data bits,
       before the stop bits. When a complete frame is transmitted, it can be directly followed by a new frame, or the
       communication line can be set to an idle (high) state. Figure 20-4 illustrates the possible combinations of the
       frame formats. Bits inside brackets are optional.




        2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 183
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 20-4.    Frame Formats
                                                                        FRAME




                              (IDLE)       St   0    1   2    3    4      [5]   [6]   [7]   [8]   [P]   Sp1 [Sp2]   (St / IDLE)



              St             Start bit, always low.
              (n)            Data bits (0 to 8).
              P              Parity bit. Can be odd or even.
              Sp             Stop bit, always high.
              IDLE           No transfers on the communication line (RxDn or TxDn). An IDLE line must be
                             high.
       The frame format used by the USART is set by the UCSZn2:0, UPMn1:0 and USBSn bits in UCSRnB and
       UCSRnC. The Receiver and Transmitter use the same setting. Note that changing the setting of any of these
       bits will corrupt all ongoing communication for both the Receiver and Transmitter.
       The USART Character SiZe (UCSZn2:0) bits select the number of data bits in the frame. The USART Parity
       mode (UPMn1:0) bits enable and set the type of parity bit. The selection between one or two stop bits is done by
       the USART Stop Bit Select (USBSn) bit. The Receiver ignores the second stop bit. An FE (Frame Error) will
       therefore only be detected in the cases where the first stop bit is zero.

20.4.1 Parity Bit Calculation
       The parity bit is calculated by doing an exclusive-or of all the data bits. If odd parity is used, the result of the
       exclusive or is inverted. The relation between the parity bit and data bits is as follows:

                                                P even = d n – 1    d 3  d 2  d 1  d 0  0
                                                 P odd = d n – 1    d 3  d 2  d 1  d 0  1

              Peven          Parity bit using even parity
              Podd           Parity bit using odd parity
              dn             Data bit n of the character
       If used, the parity bit is located between the last data bit and first stop bit of a serial frame.



20.5   USART Initialization
       The USART has to be initialized before any communication can take place. The initialization process normally
       consists of setting the baud rate, setting frame format and enabling the Transmitter or the Receiver depending
       on the usage. For interrupt driven USART operation, the Global Interrupt Flag should be cleared (and interrupts
       globally disabled) when doing the initialization.
       Before doing a re-initialization with changed baud rate or frame format, be sure that there are no ongoing
       transmissions during the period the registers are changed. The TXCn Flag can be used to check that the
       Transmitter has completed all transfers, and the RXC Flag can be used to check that there are no unread data
       in the receive buffer. Note that the TXCn Flag must be cleared before each transmission (before UDRn is
       written) if it is used for this purpose.
       The following simple USART initialization code examples show one assembly and one C function that are equal
       in functionality. The examples assume asynchronous operation using polling (no interrupts enabled) and a fixed




         2020 Microchip Technology Inc.                               Data Sheet Complete                                    DS40002061B-page 184
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       frame format. The baud rate is given as a function parameter. For the assembly code, the baud rate parameter
       is assumed to be stored in the r17:r16 Registers.


        Assembly Code Example(1)
                 USART_Init:
                       ; Set baud rate
                       out             UBRRnH, r17
                       out             UBRRnL, r16
                       ; Enable receiver and transmitter
                       ldi             r16, (1<<RXENn)|(1<<TXENn)
                       out             UCSRnB,r16
                       ; Set frame format: 8data, 2stop bit
                       ldi             r16, (1<<USBSn)|(3<<UCSZn0)
                       out             UCSRnC,r16
                       ret
        C Code Example(1)
                 #define FOSC 1843200 // Clock Speed
                 #define BAUD 9600
                 #define MYUBRR FOSC/16/BAUD-1
                 void main( void )
                 {
                 ...
                        USART_Init(MYUBRR)
                 ...
                 }
                 void USART_Init( unsigned int ubrr)
                 {
                        /*Set baud rate */
                        UBRR0H = (unsigned char)(ubrr>>8);
                        UBRR0L = (unsigned char)ubrr;
                        Enable receiver and transmitter */
                        UCSR0B = (1<<RXEN0)|(1<<TXEN0);
                        /* Set frame format: 8data, 2stop bit */
                        UCSR0C = (1<<USBS0)|(3<<UCSZ00);
                 }

       Note:   1. See ”About Code Examples” on page 17.
       More advanced initialization routines can be made that include frame format as parameters, disable interrupts
       and so on. However, many applications use a fixed setting of the baud and control registers, and for these types
       of applications the initialization code can be placed directly in the main routine, or be combined with initialization
       code for other I/O modules.

20.6   Data Transmission – The USART Transmitter
       The USART Transmitter is enabled by setting the Transmit Enable (TXEN) bit in the UCSRnB Register. When
       the Transmitter is enabled, the normal port operation of the TxDn pin is overridden by the USART and given the
       function as the Transmitter’s serial output. The baud rate, mode of operation and frame format must be set up
       once before doing any transmissions. If synchronous operation is used, the clock on the XCKn pin will be
       overridden and used as transmission clock.




        2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 185
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

20.6.1 Sending Frames with 5 to 8 Data Bit
       A data transmission is initiated by loading the transmit buffer with the data to be transmitted. The CPU can load
       the transmit buffer by writing to the UDRn I/O location. The buffered data in the transmit buffer will be moved to
       the Shift Register when the Shift Register is ready to send a new frame. The Shift Register is loaded with new
       data if it is in idle state (no ongoing transmission) or immediately after the last stop bit of the previous frame is
       transmitted. When the Shift Register is loaded with new data, it will transfer one complete frame at the rate
       given by the Baud Register, U2Xn bit or by XCKn depending on mode of operation.
       The following code examples show a simple USART transmit function based on polling of the Data Register
       Empty (UDREn) Flag. When using frames with less than eight bits, the most significant bits written to the UDRn
       are ignored. The USART has to be initialized before the function can be used. For the assembly code, the data
       to be sent is assumed to be stored in Register R16
        Assembly Code Example(1)
                 USART_Transmit:
                       ; Wait for empty transmit buffer
                       in r16, UCSRnA
                       sbrs r16, UDREn
                       rjmp            USART_Transmit
                       ; Put data (r16) into buffer, sends the data
                       out             UDRn,r16
                       ret
        C Code Example(1)
                 void USART_Transmit( unsigned char data )
                 {
                       /* Wait for empty transmit buffer */
                       while ( !( UCSRnA & (1<<UDREn)) )
                                        ;
                       /* Put data into buffer, sends the data */
                       UDRn = data;
                 }

       Note:   1. See ”About Code Examples” on page 17.
       The function simply waits for the transmit buffer to be empty by checking the UDREn Flag, before loading it with
       new data to be transmitted. If the Data Register Empty interrupt is utilized, the interrupt routine writes the data
       into the buffer.

20.6.2 Sending Frames with 9 Data Bit
       If 9-bit characters are used (UCSZn = 7), the ninth bit must be written to the TXB8 bit in UCSRnB before the low
       byte of the character is written to UDRn. The following code examples show a transmit function that handles 9-
       bit characters. For the assembly code, the data to be sent is assumed to be stored in registers R17:R16.




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 186
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


        Assembly Code Example(1)(2)
                 USART_Transmit:
                       ; Wait for empty transmit buffer
                       in r16, UCSRnA
                       sbrs r16, UDREn
                       rjmp            USART_Transmit
                       ; Copy 9th bit from r17 to TXB8
                       cbi             UCSRnB,TXB8
                       sbrc            r17,0
                       sbi             UCSRnB,TXB8
                       ; Put LSB data (r16) into buffer, sends the data
                       out             UDRn,r16
                       ret
        C Code Example(1)(2)
                 void USART_Transmit( unsigned int data )
                 {
                       /* Wait for empty transmit buffer */
                       while ( !( UCSRnA & (1<<UDREn))) )
                                        ;
                       /* Copy 9th bit to TXB8 */
                       UCSRnB &= ~(1<<TXB8);
                       if ( data & 0x0100 )
                          UCSRnB |= (1<<TXB8);
                       /* Put data into buffer, sends the data */
                       UDRn = data;
                 }

       Notes:   1.   These transmit functions are written to be general functions. They can be optimized if the contents of the
                     UCSRnB is static. For example, only the TXB8 bit of the UCSRnB Register is used after initialization.
                2.   See ”About Code Examples” on page 17.
       The ninth bit can be used for indicating an address frame when using multi processor communication mode or
       for other protocol handling as for example synchronization.

20.6.3 Transmitter Flags and Interrupts
       The USART Transmitter has two flags that indicate its state: USART Data Register Empty (UDREn) and
       Transmit Complete (TXCn). Both flags can be used for generating interrupts.
       The Data Register Empty (UDREn) Flag indicates whether the transmit buffer is ready to receive new data. This
       bit is set when the transmit buffer is empty, and cleared when the transmit buffer contains data to be transmitted
       that has not yet been moved into the Shift Register. For compatibility with future devices, always write this bit to
       zero when writing the UCSRnA Register.
       When the Data Register Empty Interrupt Enable (UDRIEn) bit in UCSRnB is written to one, the USART Data
       Register Empty Interrupt will be executed as long as UDREn is set (provided that global interrupts are enabled).
       UDREn is cleared by writing UDRn. When interrupt-driven data transmission is used, the Data Register Empty
       interrupt routine must either write new data to UDRn in order to clear UDREn or disable the Data Register
       Empty interrupt, otherwise a new interrupt will occur once the interrupt routine terminates.
       The Transmit Complete (TXCn) Flag bit is set one when the entire frame in the Transmit Shift Register has been
       shifted out and there are no new data currently present in the transmit buffer. The TXCn Flag bit is automatically
       cleared when a transmit complete interrupt is executed, or it can be cleared by writing a one to its bit location.
       The TXCn Flag is useful in half-duplex communication interfaces (like the RS-485 standard), where a




        2020 Microchip Technology Inc.                          Data Sheet Complete                          DS40002061B-page 187
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       transmitting application must enter receive mode and free the communication bus immediately after completing
       the transmission.
       When the Transmit Compete Interrupt Enable (TXCIEn) bit in UCSRnB is set, the USART Transmit Complete
       Interrupt will be executed when the TXCn Flag becomes set (provided that global interrupts are enabled). When
       the transmit complete interrupt is used, the interrupt handling routine does not have to clear the TXCn Flag, this
       is done automatically when the interrupt is executed.

20.6.4 Parity Generator
       The Parity Generator calculates the parity bit for the serial frame data. When parity bit is enabled (UPMn1 = 1),
       the transmitter control logic inserts the parity bit between the last data bit and the first stop bit of the frame that is
       sent.

20.6.5 Disabling the Transmitter
       The disabling of the Transmitter (setting the TXEN to zero) will not become effective until ongoing and pending
       transmissions are completed, i.e., when the Transmit Shift Register and Transmit Buffer Register do not contain
       data to be transmitted. When disabled, the Transmitter will no longer override the TxDn pin.

20.7   Data Reception – The USART Receiver
       The USART Receiver is enabled by writing the Receive Enable (RXENn) bit in the
       UCSRnB Register to one. When the Receiver is enabled, the normal pin operation of the RxDn pin is overridden
       by the USART and given the function as the Receiver’s serial input. The baud rate, mode of operation and
       frame format must be set up once before any serial reception can be done. If synchronous operation is used,
       the clock on the XCKn pin will be used as transfer clock.

20.7.1 Receiving Frames with 5 to 8 Data Bits
       The Receiver starts data reception when it detects a valid start bit. Each bit that follows the start bit will be
       sampled at the baud rate or XCKn clock, and shifted into the Receive Shift Register until the first stop bit of a
       frame is received. A second stop bit will be ignored by the Receiver. When the first stop bit is received, i.e., a
       complete serial frame is present in the Receive Shift Register, the contents of the Shift Register will be moved
       into the receive buffer. The receive buffer can then be read by reading the UDRn I/O location.
       The following code example shows a simple USART receive function based on polling of the Receive Complete
       (RXCn) Flag. When using frames with less than eight bits the most significant bits of the data read from the
       UDRn will be masked to zero. The USART has to be initialized before the function can be used.




        2020 Microchip Technology Inc.                        Data Sheet Complete                         DS40002061B-page 188
                                                ATmega48A/PA/88A/PA/168A/PA/328/P


        Assembly Code Example(1)
                 USART_Receive:
                       ; Wait for data to be received
                       in r16, UCSRnA
                       sbrs r16, UDREn
                       rjmp            USART_Receive
                       ; Get and return received data from buffer
                       in              r16, UDRn
                       ret
        C Code Example(1)
                 unsigned char USART_Receive( void )
                 {
                       /* Wait for data to be received */
                       while ( !(UCSRnA & (1<<RXCn)) )
                                        ;
                       /* Get and return received data from buffer */
                       return UDRn;
                 }

       Note:   1.   See ”About Code Examples” on page 17.
                    For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
                    be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
                    “SBRS”, “SBRC”, “SBR”, and “CBR”.

       The function simply waits for data to be present in the receive buffer by checking the RXCn Flag, before reading
       the buffer and returning the value.

20.7.2 Receiving Frames with 9 Data Bits
       If 9-bit characters are used (UCSZn=7) the ninth bit must be read from the RXB8n bit in UCSRnB before
       reading the low bits from the UDRn. This rule applies to the FEn, DORn and UPEn Status Flags as well. Read
       status from UCSRnA, then data from UDRn. Reading the UDRn I/O location will change the state of the receive
       buffer FIFO and consequently the TXB8n, FEn, DORn and UPEn bits, which all are stored in the FIFO, will
       change.
       The following code example shows a simple USART receive function that handles both nine bit characters and
       the status bits.




        2020 Microchip Technology Inc.                        Data Sheet Complete                          DS40002061B-page 189
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

        Assembly Code Example(1)
                 USART_Receive:
                       ; Wait for data to be received
                       in r16, UCSRnA
                       sbrs r16, RXCn
                       rjmp            USART_Receive
                       ; Get status and 9th bit, then data from buffer
                       in              r18, UCSRnA
                       in              r17, UCSRnB
                       in              r16, UDRn
                       ; If error, return -1
                       andi            r18,(1<<FEn)|(1<<DORn)|(1<<UPEn)
                       breq            USART_ReceiveNoError
                       ldi             r17, HIGH(-1)
                       ldi             r16, LOW(-1)
                 USART_ReceiveNoError:
                       ; Filter the 9th bit, then return
                       lsr             r17
                       andi            r17, 0x01
                       ret
        C Code Example(1)
                 unsigned int USART_Receive( void )
                 {
                       unsigned char status, resh, resl;
                       /* Wait for data to be received */
                       while ( !(UCSRnA & (1<<RXCn)) )
                                        ;
                       /* Get status and 9th bit, then data */
                       /* from buffer */
                       status = UCSRnA;
                       resh = UCSRnB;
                       resl = UDRn;
                       /* If error, return -1 */
                       if ( status & (1<<FEn)|(1<<DORn)|(1<<UPEn) )
                          return -1;
                       /* Filter the 9th bit, then return */
                       resh = (resh >> 1) & 0x01;
                       return ((resh << 8) | resl);
                 }
       Note:   1.   See ”About Code Examples” on page 17.
                    For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
                    be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
                    “SBRS”, “SBRC”, “SBR”, and “CBR”.
       The receive function example reads all the I/O Registers into the Register File before any computation is done.
       This gives an optimal receive buffer utilization since the buffer location read will be free to accept new data as
       early as possible.

20.7.3 Receive Compete Flag and Interrupt
       The USART Receiver has one flag that indicates the Receiver state.
       The Receive Complete (RXCn) Flag indicates if there are unread data present in the receive buffer. This flag is
       one when unread data exist in the receive buffer, and zero when the receive buffer is empty (i.e., does not




        2020 Microchip Technology Inc.                        Data Sheet Complete                          DS40002061B-page 190
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       contain any unread data). If the Receiver is disabled (RXENn = 0), the receive buffer will be flushed and
       consequently the RXCn bit will become zero.
       When the Receive Complete Interrupt Enable (RXCIEn) in UCSRnB is set, the USART Receive Complete
       interrupt will be executed as long as the RXCn Flag is set (provided that global interrupts are enabled). When
       interrupt-driven data reception is used, the receive complete routine must read the received data from UDRn in
       order to clear the RXCn Flag, otherwise a new interrupt will occur once the interrupt routine terminates.

20.7.4 Receiver Error Flags
       The USART Receiver has three Error Flags: Frame Error (FEn), Data OverRun (DORn) and Parity Error
       (UPEn). All can be accessed by reading UCSRnA. Common for the Error Flags is that they are located in the
       receive buffer together with the frame for which they indicate the error status. Due to the buffering of the Error
       Flags, the UCSRnA must be read before the receive buffer (UDRn), since reading the UDRn I/O location
       changes the buffer read location. Another equality for the Error Flags is that they can not be altered by software
       doing a write to the flag location. However, all flags must be set to zero when the UCSRnA is written for upward
       compatibility of future USART implementations. None of the Error Flags can generate interrupts.
       The Frame Error (FEn) Flag indicates the state of the first stop bit of the next readable frame stored in the
       receive buffer. The FEn Flag is zero when the stop bit was correctly read (as one), and the FEn Flag will be one
       when the stop bit was incorrect (zero). This flag can be used for detecting out-of-sync conditions, detecting
       break conditions and protocol handling. The FEn Flag is not affected by the setting of the USBSn bit in UCSRnC
       since the Receiver ignores all, except for the first, stop bits. For compatibility with future devices, always set this
       bit to zero when writing to UCSRnA.
       The Data OverRun (DORn) Flag indicates data loss due to a receiver buffer full condition. A Data OverRun
       occurs when the receive buffer is full (two characters), it is a new character waiting in the Receive Shift Register,
       and a new start bit is detected. If the DORn Flag is set there was one or more serial frame lost between the
       frame last read from UDRn, and the next frame read from UDRn. For compatibility with future devices, always
       write this bit to zero when writing to UCSRnA. The DORn Flag is cleared when the frame received was
       successfully moved from the Shift Register to the receive buffer.
       The Parity Error (UPEn) Flag indicates that the next frame in the receive buffer had a Parity Error when
       received. If Parity Check is not enabled the UPEn bit will always be read zero. For compatibility with future
       devices, always set this bit to zero when writing to UCSRnA. For more details see ”Parity Bit Calculation” on
       page 184 and ”Parity Checker” on page 191.

20.7.5 Parity Checker
       The Parity Checker is active when the high USART Parity mode (UPMn1) bit is set. Type of Parity Check to be
       performed (odd or even) is selected by the UPMn0 bit. When enabled, the Parity Checker calculates the parity
       of the data bits in incoming frames and compares the result with the parity bit from the serial frame. The result of
       the check is stored in the receive buffer together with the received data and stop bits. The Parity Error (UPEn)
       Flag can then be read by software to check if the frame had a Parity Error.
       The UPEn bit is set if the next character that can be read from the receive buffer had a Parity Error when
       received and the Parity Checking was enabled at that point (UPMn1 = 1). This bit is valid until the receive buffer
       (UDRn) is read.

20.7.6 Disabling the Receiver
       In contrast to the Transmitter, disabling of the Receiver will be immediate. Data from ongoing receptions will
       therefore be lost. When disabled (i.e., the RXENn is set to zero) the Receiver will no longer override the normal
       function of the RxDn port pin. The Receiver buffer FIFO will be flushed when the Receiver is disabled.
       Remaining data in the buffer will be lost




        2020 Microchip Technology Inc.                       Data Sheet Complete                        DS40002061B-page 191
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

20.7.7 Flushing the Receive Buffer
       The receiver buffer FIFO will be flushed when the Receiver is disabled, i.e., the buffer will be emptied of its
       contents. Unread data will be lost. If the buffer has to be flushed during normal operation, due to for instance an
       error condition, read the UDRn I/O location until the RXCn Flag is cleared. The following code example shows
       how to flush the receive buffer.
        Assembly Code Example(1)
                 USART_Flush:
                       in r16, UCSRnA
                       sbrs r16, RXCn
                       ret
                       in                            r16, UDRn
                       rjmp                          USART_Flush
        C Code Example(1)
                 void USART_Flush( void )
                 {
                       unsigned char dummy;
                       while ( UCSRnA & (1<<RXCn) ) dummy = UDRn;
                 }

       Note:   1.     See ”About Code Examples” on page 17.
                      For I/O Registers located in extended I/O map, “IN”, “OUT”, “SBIS”, “SBIC”, “CBI”, and “SBI” instructions must
                      be replaced with instructions that allow access to extended I/O. Typically “LDS” and “STS” combined with
                      “SBRS”, “SBRC”, “SBR”, and “CBR”.

20.8   Asynchronous Data Reception
       The USART includes a clock recovery and a data recovery unit for handling asynchronous data reception. The
       clock recovery logic is used for synchronizing the internally generated baud rate clock to the incoming
       asynchronous serial frames at the RxDn pin. The data recovery logic samples and low pass filters each
       incoming bit, thereby improving the noise immunity of the Receiver. The asynchronous reception operational
       range depends on the accuracy of the internal baud rate clock, the rate of the incoming frames, and the frame
       size in number of bits.

20.8.1 Asynchronous Clock Recovery
       The clock recovery logic synchronizes internal clock to the incoming serial frames. Figure 20-5 illustrates the
       sampling process of the start bit of an incoming frame. The sample rate is 16 times the baud rate for Normal
       mode, and eight times the baud rate for Double Speed mode. The horizontal arrows illustrate the
       synchronization variation due to the sampling process. Note the larger time variation when using the Double
       Speed mode (U2Xn = 1) of operation. Samples denoted zero are samples done when the RxDn line is idle (i.e.,
       no communication activity).

       Figure 20-5.     Start Bit Sampling

                           RxD       IDLE                                     START                                          BIT 0



                         Sample
                         (U2X = 0)   0   0   1   2   3   4   5   6    7   8     9     10   11   12   13   14   15   16   1   2     3

                         Sample
                         (U2X = 1)   0       1       2       3        4         5          6         7         8         1         2




        2020 Microchip Technology Inc.                              Data Sheet Complete                                         DS40002061B-page 192
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

      When the clock recovery logic detects a high (idle) to low (start) transition on the RxDn line, the start bit
      detection sequence is initiated. Let sample 1 denote the first zero-sample as shown in the figure. The clock
      recovery logic then uses samples 8, 9, and 10 for Normal mode, and samples 4, 5, and 6 for Double Speed
      mode (indicated with sample numbers inside boxes on the figure), to decide if a valid start bit is received. If two
      or more of these three samples have logical high levels (the majority wins), the start bit is rejected as a noise
      spike and the Receiver starts looking for the next high to low-transition. If however, a valid start bit is detected,
      the clock recovery logic is synchronized and the data recovery can begin. The synchronization process is
      repeated for each start bit.

20.8.2 Asynchronous Data Recovery
      When the receiver clock is synchronized to the start bit, the data recovery can begin. The data recovery unit
      uses a state machine that has 16 states for each bit in Normal mode and eight states for each bit in Double
      Speed mode. Figure 20-6 shows the sampling of the data bits and the parity bit. Each of the samples is given a
      number that is equal to the state of the recovery unit.

      Figure 20-6.    Sampling of Data and Parity Bit

                          RxD                                              BIT n



                        Sample
                        (U2X = 0)         1   2   3   4   5   6    7   8     9      10   11    12    13    14   15   16   1

                        Sample
                        (U2X = 1)         1       2       3        4         5           6           7          8         1




      The decision of the logic level of the received bit is taken by doing a majority voting of the logic value to the three
      samples in the center of the received bit. The center samples are emphasized on the figure by having the
      sample number inside boxes. The majority voting process is done as follows: If two or all three samples have
      high levels, the received bit is registered to be a logic 1. If two or all three samples have low levels, the received
      bit is registered to be a logic 0. This majority voting process acts as a low pass filter for the incoming signal on
      the RxDn pin. The recovery process is then repeated until a complete frame is received. Including the first stop
      bit. Note that the Receiver only uses the first stop bit of a frame.
      Figure 20-7 on page 193 shows the sampling of the stop bit and the earliest possible beginning of the start bit of
      the next frame.

      Figure 20-7.    Stop Bit Sampling and Next Start Bit Sampling

                          RxD                                              STOP 1        (A)         (B)                  (C)




                        Sample
                        (U2X = 0)         1   2   3   4   5   6    7   8     9      10   0/1   0/1   0/1

                        Sample
                        (U2X = 1)         1       2       3        4         5           6           0/1




      The same majority voting is done to the stop bit as done for the other bits in the frame. If the stop bit is
      registered to have a logic 0 value, the Frame Error (FEn) Flag will be set.
      A new high to low transition indicating the start bit of a new frame can come right after the last of the bits used
      for majority voting. For Normal Speed mode, the first low level sample can be at point marked (A) in Figure 20-
      7. For Double Speed mode the first low level must be delayed to (B). (C) marks a stop bit of full length. The early
      start bit detection influences the operational range of the Receiver.




        2020 Microchip Technology Inc.                           Data Sheet Complete                                           DS40002061B-page 193
                                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

20.8.3 Asynchronous Operational Range
      The operational range of the Receiver is dependent on the mismatch between the received bit rate and the
      internally generated baud rate. If the Transmitter is sending frames at too fast or too slow bit rates, or the
      internally generated baud rate of the Receiver does not have a similar (see Table 20-2 on page 194) base
      frequency, the Receiver will not be able to synchronize the frames to the start bit.
      The following equations can be used to calculate the ratio of the incoming data rate and internal receiver baud
      rate.

      Equation 1

                                        D + 1 S                                                                    D + 2 S
                    R slow = -------------------------------------------                            R fast = -----------------------------------
                             S – 1 + D  S + SF                                                               D + 1 S + S M

      D Sum of character size and parity size (D = 5 to 10 bit)
      S Samples per bit. S = 16 for Normal Speed mode and S = 8 for Double Speed mode.
      SF First sample number used for majority voting. SF = 8 for normal speed and
      SF = 4 for Double Speed mode.
      SM Middle sample number used for majority voting. SM = 9 for normal speed and
      SM = 5 for Double Speed mode.
      Rslow is the ratio of the slowest incoming data rate that can be accepted in relation to the receiver baud rate.
      Rfast is the ratio of the fastest incoming data rate that can be accepted in relation to the receiver baud rate.
      Table 20-2 on page 194 and Table 20-3 on page 194 list the maximum receiver baud rate error that can be
      tolerated. Note that Normal Speed mode has higher toleration of baud rate variations.


      Table 20-2.        Recommended Maximum Receiver Baud Rate Error for Normal Speed Mode (U2Xn = 0)
                 D                                                                                                           Recommended Max
         # (Data+Parity Bit)                  Rslow (%)                    Rfast (%)   Max Total Error (%)                   Receiver Error (%)
                    5                             93.20                     106.67          +6.67/-6.8                                      ± 3.0
                    6                             94.12                     105.79         +5.79/-5.88                                      ± 2.5
                    7                             94.81                     105.11          +5.11/-5.19                                     ± 2.0
                    8                             95.36                     104.58         +4.58/-4.54                                      ± 2.0
                    9                             95.81                     104.14         +4.14/-4.19                                      ± 1.5
                  10                              96.17                     103.78         +3.78/-3.83                                      ± 1.5


      Table 20-3.        Recommended Maximum Receiver Baud Rate Error for Double Speed Mode (U2Xn = 1)
                 D                                                                                                          Recommended Max
         # (Data+Parity Bit)                  Rslow (%)                    Rfast (%)   Max Total Error (%)                  Receiver Error (%)
                    5                             94.12                    105.66          +5.66/-5.88                                     ± 2.5
                    6                             94.92                    104.92          +4.92/-5.08                                     ± 2.0
                    7                             95.52                    104,35          +4.35/-4.48                                     ± 1.5
                    8                             96.00                    103.90          +3.90/-4.00                                     ± 1.5
                    9                             96.39                    103.53          +3.53/-3.61                                     ± 1.5
                  10                              96.70                    103.23          +3.23/-3.30                                     ± 1.0




        2020 Microchip Technology Inc.                                                  Data Sheet Complete                                        DS40002061B-page 194
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       The recommendations of the maximum receiver baud rate error was made under the assumption that the
       Receiver and Transmitter equally divides the maximum total error.
       There are two possible sources for the receivers baud rate error. The Receiver’s system clock (XTAL) will
       always have some minor instability over the supply voltage range and the temperature range. When using a
       crystal to generate the system clock, this is rarely a problem, but for a resonator the system clock may differ
       more than 2% depending of the resonators tolerance. The second source for the error is more controllable. The
       baud rate generator can not always do an exact division of the system frequency to get the baud rate wanted. In
       this case an UBRRn value that gives an acceptable low error can be used if possible.

20.9   Multi-processor Communication Mode
       Setting the Multi-processor Communication mode (MPCMn) bit in UCSRnA enables a filtering function of
       incoming frames received by the USART Receiver. Frames that do not contain address information will be
       ignored and not put into the receive buffer. This effectively reduces the number of incoming frames that has to
       be handled by the CPU, in a system with multiple MCUs that communicate via the same serial bus. The
       Transmitter is unaffected by the MPCMn setting, but has to be used differently when it is a part of a system
       utilizing the Multi-processor Communication mode.
       If the Receiver is set up to receive frames that contain 5 to 8 data bits, then the first stop bit indicates if the frame
       contains data or address information. If the Receiver is set up for frames with nine data bits, then the ninth bit
       (RXB8n) is used for identifying address and data frames. When the frame type bit (the first stop or the ninth bit)
       is one, the frame contains an address. When the frame type bit is zero the frame is a data frame.
       The Multi-processor Communication mode enables several slave MCUs to receive data from a master MCU.
       This is done by first decoding an address frame to find out which MCU has been addressed. If a particular slave
       MCU has been addressed, it will receive the following data frames as normal, while the other slave MCUs will
       ignore the received frames until another address frame is received.

20.9.1 Using MPCMn
       For an MCU to act as a master MCU, it can use a 9-bit character frame format (UCSZn = 7). The ninth bit
       (TXB8n) must be set when an address frame (TXB8n = 1) or cleared when a data frame (TXB = 0) is being
       transmitted. The slave MCUs must in this case be set to use a 9-bit character frame format.
       The following procedure should be used to exchange data in Multi-processor Communication mode:
       1. All Slave MCUs are in Multi-processor Communication mode (MPCMn in
          UCSRnA is set).
        2.   The Master MCU sends an address frame, and all slaves receive and read this frame. In the Slave MCUs,
             the RXCn Flag in UCSRnA will be set as normal.
        3.   Each Slave MCU reads the UDRn Register and determines if it has been selected. If so, it clears the
             MPCMn bit in UCSRnA, otherwise it waits for the next address byte and keeps the MPCMn setting.
        4.   The addressed MCU will receive all data frames until a new address frame is received. The other Slave
             MCUs, which still have the MPCMn bit set, will ignore the data frames.
        5.   When the last data frame is received by the addressed MCU, the addressed MCU sets the MPCMn bit
             and waits for a new address frame from master. The process then repeats from 2.
       Using any of the 5- to 8-bit character frame formats is possible, but impractical since the Receiver must change
       between using n and n+1 character frame formats. This makes full-duplex operation difficult since the
       Transmitter and Receiver uses the same character size setting. If 5- to 8-bit character frames are used, the
       Transmitter must be set to use two stop bit (USBSn = 1) since the first stop bit is used for indicating the frame
       type.




        2020 Microchip Technology Inc.                        Data Sheet Complete                        DS40002061B-page 195
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

              Do not use Read-Modify-Write instructions (SBI and CBI) to set or clear the MPCMn bit. The MPCMn bit shares
              the same I/O location as the TXCn Flag and this might accidentally be cleared when using SBI or CBI
              instructions.



20.10 Examples of Baud Rate Setting
              For standard crystal and resonator frequencies, the most commonly used baud rates for asynchronous
              operation can be generated by using the UBRRn settings in Table 20-4. UBRRn values which yield an actual
              baud rate differing less than 0.5% from the target baud rate, are bold in the table. Higher error ratings are
              acceptable, but the Receiver will have less noise resistance when the error ratings are high, especially for large
              serial frames (see ”Asynchronous Operational Range” on page 194). The error values are calculated using the
              following equation:



                                                                      BaudRate Closest Match
                                                        Error[%] =  -------------------------------------------------- – 1  100%
                                                                                    BaudRate




Table 20-4.         Examples of UBRRn Settings for Commonly Used Oscillator Frequencies
                            fosc = 1.0000MHz                                        fosc = 1.8432MHz                                              fosc = 2.0000MHz
 Baud
                     U2Xn = 0              U2Xn = 1                       U2Xn = 0                           U2Xn = 1                     U2Xn = 0               U2Xn = 1
 Rate
 (bps)          UBRRn       Error     UBRRn        Error          UBRRn              Error             UBRRn              Error         UBRRn      Error     UBRRn     Error
 2400              25        0.2%        51        0.2%                47              0.0%                 95             0.0%          51        0.2%        103      0.2%
 4800              12        0.2%        25        0.2%                23              0.0%                 47             0.0%          25        0.2%         51      0.2%
 9600               6       -7.0%        12        0.2%                11              0.0%                 23             0.0%          12        0.2%         25      0.2%
 14.4k              3        8.5%         8        -3.5%                7              0.0%                 15             0.0%           8        -3.5%        16      2.1%
 19.2k              2        8.5%         6        -7.0%                5              0.0%                 11             0.0%           6        -7.0%        12      0.2%
 28.8k              1        8.5%         3        8.5%                 3              0.0%                  7             0.0%           3        8.5%         8      -3.5%
 38.4k              1       -18.6%        2        8.5%                 2              0.0%                  5             0.0%           2        8.5%         6      -7.0%
 57.6k              0        8.5%         1        8.5%                 1              0.0%                  3             0.0%           1        8.5%         3       8.5%
 76.8k              –           –         1        -18.6%               1            -25.0%                  2             0.0%           1        -18.6%       2       8.5%
 115.2k             –           –         0        8.5%                 0              0.0%                  1             0.0%           0        8.5%         1       8.5%
 230.4k             –           –         –             –               –                  –                 0             0.0%           –             –       –           –
 250k               –           –         –             –               –                  –                 –                –           –             –       0       0.0%
        (1)
 Max.                62.5kbps                 125kbps                    115.2kbps                           230.4kbps                        125kbps            250kbps
Note:         1. UBRRn = 0, Error = 0.0%




               2020 Microchip Technology Inc.                                        Data Sheet Complete                                               DS40002061B-page 196
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Table 20-5.         Examples of UBRRn Settings for Commonly Used Oscillator Frequencies (Continued)
                fosc = 3.6864MHz                         fosc = 4.0000MHz                       fosc = 7.3728MHz
 Baud
                U2Xn = 0             U2Xn = 1            U2Xn = 0           U2Xn = 1            U2Xn = 0            U2Xn = 1
 Rate
 (bps)          UBRRn       Error    UBRRn       Error   UBRRn      Error   UBRRn      Error    UBRRn      Error    UBRRn      Error
 2400              95       0.0%       191       0.0%     103       0.2%      207      0.2%      191       0.0%       383      0.0%
 4800              47       0.0%        95       0.0%      51       0.2%      103      0.2%       95       0.0%       191      0.0%
 9600              23       0.0%        47       0.0%      25       0.2%       51      0.2%       47       0.0%        95      0.0%
 14.4k             15       0.0%        31       0.0%      16       2.1%       34      -0.8%      31       0.0%        63      0.0%
 19.2k             11       0.0%        23       0.0%      12       0.2%       25      0.2%       23       0.0%        47      0.0%
 28.8k              7       0.0%        15       0.0%       8       -3.5%      16      2.1%       15       0.0%        31      0.0%
 38.4k              5       0.0%        11       0.0%       6       -7.0%      12      0.2%       11       0.0%        23      0.0%
 57.6k              3       0.0%         7       0.0%       3       8.5%       8       -3.5%       7       0.0%        15      0.0%
 76.8k              2       0.0%         5       0.0%       2       8.5%       6       -7.0%       5       0.0%        11      0.0%
 115.2k             1       0.0%         3       0.0%       1       8.5%       3       8.5%        3       0.0%        7       0.0%
 230.4k             0       0.0%         1       0.0%       0       8.5%       1       8.5%        1       0.0%        3       0.0%
 250k               0       -7.8%        1       -7.8%      0       0.0%       1       0.0%        1       -7.8%       3       -7.8%
 0.5M               –         –          0       -7.8%      –         –        0       0.0%        0       -7.8%       1       -7.8%
 1M                 –         –          –         –        –         –        –            –      –         –         0       -7.8%
        (1)
 Max.               230.4kbps            460.8kbps          250kbps             0.5Mbps            460.8kbps           921.6kbps
1.UBRRn = 0, Error = 0.0%




               2020 Microchip Technology Inc.                        Data Sheet Complete                          DS40002061B-page 197
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Table 20-6.         Examples of UBRRn Settings for Commonly Used Oscillator Frequencies (Continued)
                          fosc = 8.0000MHz                       fosc = 11.0592MHz                       fosc = 14.7456MHz
 Baud
                    U2Xn = 0             U2Xn = 1          U2Xn = 0              U2Xn = 1          U2Xn = 0            U2Xn = 1
 Rate
 (bps)          UBRRn       Error    UBRRn       Error   UBRRn     Error     UBRRn      Error    UBRRn    Error    UBRRn     Error
 2400             207       0.2%       416       -0.1%    287      0.0%        575      0.0%      383      0.0%      767      0.0%
 4800             103       0.2%       207       0.2%     143      0.0%        287      0.0%      191      0.0%      383      0.0%
 9600              51       0.2%       103       0.2%     71       0.0%        143      0.0%      95       0.0%      191      0.0%
 14.4k             34       -0.8%       68       0.6%     47       0.0%         95      0.0%      63       0.0%      127      0.0%
 19.2k             25       0.2%        51       0.2%     35       0.0%         71      0.0%      47       0.0%       95      0.0%
 28.8k             16       2.1%        34       -0.8%    23       0.0%         47      0.0%      31       0.0%       63      0.0%
 38.4k             12       0.2%        25       0.2%     17       0.0%         35      0.0%      23       0.0%       47      0.0%
 57.6k              8       -3.5%       16       2.1%     11       0.0%         23      0.0%      15       0.0%       31      0.0%
 76.8k              6       -7.0%       12       0.2%      8       0.0%         17      0.0%      11       0.0%       23      0.0%
 115.2k             3       8.5%         8       -3.5%     5       0.0%         11      0.0%       7       0.0%       15      0.0%
 230.4k             1       8.5%         3       8.5%      2       0.0%         5       0.0%       3       0.0%       7       0.0%
 250k               1       0.0%         3       0.0%      2       -7.8%        5       -7.8%      3      -7.8%       6       5.3%
 0.5M               0       0.0%         1       0.0%      –          –         2       -7.8%      1      -7.8%       3      -7.8%
 1M                 –          –         0       0.0%      –          –         –            –     0      -7.8%       1      -7.8%
        (1)
 Max.               0.5Mbps                  1Mbps         691.2kbps           1.3824Mbps          921.6kbps         1.8432Mbps
1.            UBRRn = 0, Error = 0.0%




               2020 Microchip Technology Inc.                         Data Sheet Complete                        DS40002061B-page 198
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Table 20-7.         Examples of UBRRn Settings for Commonly Used Oscillator Frequencies (Continued)
                          fosc = 16.0000MHz                      fosc = 18.4320MHz                      fosc = 20.0000MHz
 Baud
                    U2Xn = 0             U2Xn = 1          U2Xn = 0             U2Xn = 1          U2Xn = 0            U2Xn = 1
 Rate
 (bps)          UBRRn       Error    UBRRn       Error   UBRRn    Error     UBRRn      Error    UBRRn    Error    UBRRn     Error
 2400             416       -0.1%      832       0.0%     479      0.0%       959      0.0%      520      0.0%      1041     0.0%
 4800             207       0.2%       416       -0.1%    239      0.0%       479      0.0%      259      0.2%      520      0.0%
 9600             103       0.2%       207       0.2%     119      0.0%       239      0.0%      129      0.2%      259      0.2%
 14.4k             68       0.6%       138       -0.1%    79       0.0%       159      0.0%      86      -0.2%      173     -0.2%
 19.2k             51       0.2%       103       0.2%     59       0.0%       119      0.0%      64       0.2%      129      0.2%
 28.8k             34       -0.8%       68       0.6%     39       0.0%        79      0.0%      42       0.9%       86     -0.2%
 38.4k             25       0.2%        51       0.2%     29       0.0%        59      0.0%      32      -1.4%       64      0.2%
 57.6k             16       2.1%        34       -0.8%    19       0.0%        39      0.0%      21      -1.4%       42      0.9%
 76.8k             12       0.2%        25       0.2%     14       0.0%        29      0.0%      15       1.7%       32     -1.4%
 115.2k             8       -3.5%       16       2.1%      9       0.0%        19      0.0%      10      -1.4%       21     -1.4%
 230.4k             3       8.5%         8       -3.5%     4       0.0%        9       0.0%       4       8.5%       10     -1.4%
 250k               3       0.0%         7       0.0%      4      -7.8%        8       2.4%       4       0.0%       9       0.0%
 0.5M               1       0.0%         3       0.0%      –          –        4       -7.8%      –          –       4       0.0%
 1M                 0       0.0%         1       0.0%      –          –        –            –     –          –       –           –
        (1)
 Max.                   1Mbps                2Mbps        1.152Mbps            2.304Mbps          1.25Mbps            2.5Mbps
1.            UBRRn = 0, Error = 0.0%




               2020 Microchip Technology Inc.                        Data Sheet Complete                        DS40002061B-page 199
                                                ATmega48A/PA/88A/PA/168A/PA/328/P


20.11 Register Description

20.11.1 UDRn – USART I/O Data Register n
        Bit                7          6         5       4              3       2        1         0
                                                            RXB[7:0]                                        UDRn (Read)
                                                            TXB[7:0]                                        UDRn (Write)
        Read/Write       R/W         R/W       R/W     R/W         R/W        R/W     R/W        R/W
        Initial Value      0          0         0       0              0       0        0         0

       The USART Transmit Data Buffer Register and USART Receive Data Buffer Registers share the same I/O
       address referred to as USART Data Register or UDRn. The Transmit Data Buffer Register (TXB) will be the
       destination for data written to the UDRn Register location. Reading the UDRn Register location will return the
       contents of the Receive Data Buffer Register (RXB).
       For 5-, 6-, or 7-bit characters the upper unused bits will be ignored by the Transmitter and set to zero by the
       Receiver.
       The transmit buffer can only be written when the UDREn Flag in the UCSRnA Register is set. Data written to
       UDRn when the UDREn Flag is not set, will be ignored by the USART Transmitter. When data is written to the
       transmit buffer, and the Transmitter is enabled, the Transmitter will load the data into the Transmit Shift Register
       when the Shift Register is empty. Then the data will be serially transmitted on the TxDn pin.
       The receive buffer consists of a two level FIFO. The FIFO will change its state whenever the receive buffer is
       accessed. Due to this behavior of the receive buffer, do not use Read-Modify-Write instructions (SBI and CBI)
       on this location. Be careful when using bit test instructions (SBIC and SBIS), since these also will change the
       state of the FIFO.

20.11.2 UCSRnA – USART Control and Status Register n A
        Bit                7              6     5        4             3        2           1         0
                        RXCn        TXCn      UDREn    FEn         DORn       UPEn    U2Xn      MPCMn        UCSRnA
        Read/Write         R          R/W       R        R             R        R      R/W        R/W
        Initial Value      0              0     1        0             0        0           0         0


       • Bit 7 – RXCn: USART Receive Complete
       This flag bit is set when there are unread data in the receive buffer and cleared when the receive buffer is empty
       (i.e., does not contain any unread data). If the Receiver is disabled, the receive buffer will be flushed and
       consequently the RXCn bit will become zero. The RXCn Flag can be used to generate a Receive Complete
       interrupt (see description of the RXCIEn bit).

       • Bit 6 – TXCn: USART Transmit Complete
       This flag bit is set when the entire frame in the Transmit Shift Register has been shifted out and there are no
       new data currently present in the transmit buffer (UDRn). The TXCn Flag bit is automatically cleared when a
       transmit complete interrupt is executed, or it can be cleared by writing a one to its bit location. The TXCn Flag
       can generate a Transmit Complete interrupt (see description of the TXCIEn bit).
       • Bit 5 – UDREn: USART Data Register Empty
       The UDREn Flag indicates if the transmit buffer (UDRn) is ready to receive new data. If UDREn is one, the
       buffer is empty, and therefore ready to be written. The UDREn Flag can generate a Data Register Empty
       interrupt (see description of the UDRIEn bit). UDREn is set after a reset to indicate that the Transmitter is ready.




        2020 Microchip Technology Inc.                       Data Sheet Complete                         DS40002061B-page 200
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       • Bit 4 – FEn: Frame Error
       This bit is set if the next character in the receive buffer had a Frame Error when received. I.e., when the first stop
       bit of the next character in the receive buffer is zero. This bit is valid until the receive buffer (UDRn) is read. The
       FEn bit is zero when the stop bit of received data is one. Always set this bit to zero when writing to UCSRnA.

       • Bit 3 – DORn: Data OverRun
       This bit is set if a Data OverRun condition is detected. A Data OverRun occurs when the receive buffer is full
       (two characters), it is a new character waiting in the Receive Shift Register, and a new start bit is detected. This
       bit is valid until the receive buffer (UDRn) is read. Always set this bit to zero when writing to UCSRnA.

       • Bit 2 – UPEn: USART Parity Error
       This bit is set if the next character in the receive buffer had a Parity Error when received and the Parity Checking
       was enabled at that point (UPMn1 = 1). This bit is valid until the receive buffer (UDRn) is read. Always set this
       bit to zero when writing to UCSRnA.

       • Bit 1 – U2Xn: Double the USART Transmission Speed
       This bit only has effect for the asynchronous operation. Write this bit to zero when using synchronous operation.
       Writing this bit to one will reduce the divisor of the baud rate divider from 16 to 8 effectively doubling the transfer
       rate for asynchronous communication.

       • Bit 0 – MPCMn: Multi-processor Communication Mode
       This bit enables the Multi-processor Communication mode. When the MPCMn bit is written to one, all the
       incoming frames received by the USART Receiver that do not contain address information will be ignored. The
       Transmitter is unaffected by the MPCMn setting. For more detailed information see ”Multi-processor
       Communication Mode” on page 195.

20.11.3 UCSRnB – USART Control and Status Register n B
        Bit               7               6      5          4             3            2       1         0
                        RXCIEn     TXCIEn     UDRIEn     RXENn        TXENn       UCSZn2    RXB8n     TXB8n      UCSRnB
        Read/Write       R/W          R/W      R/W         R/W          R/W           R/W     R         R/W
        Initial Value     0               0      0          0             0            0       0         0


       • Bit 7 – RXCIEn: RX Complete Interrupt Enable n
       Writing this bit to one enables interrupt on the RXCn Flag. A USART Receive Complete interrupt will be
       generated only if the RXCIEn bit is written to one, the Global Interrupt Flag in SREG is written to one and the
       RXCn bit in UCSRnA is set.

       • Bit 6 – TXCIEn: TX Complete Interrupt Enable n
       Writing this bit to one enables interrupt on the TXCn Flag. A USART Transmit Complete interrupt will be
       generated only if the TXCIEn bit is written to one, the Global Interrupt Flag in SREG is written to one and the
       TXCn bit in UCSRnA is set.




        2020 Microchip Technology Inc.                         Data Sheet Complete                      DS40002061B-page 201
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

       • Bit 5 – UDRIEn: USART Data Register Empty Interrupt Enable n
       Writing this bit to one enables interrupt on the UDREn Flag. A Data Register Empty interrupt will be generated
       only if the UDRIEn bit is written to one, the Global Interrupt Flag in SREG is written to one and the UDREn bit in
       UCSRnA is set.

       • Bit 4 – RXENn: Receiver Enable n
       Writing this bit to one enables the USART Receiver. The Receiver will override normal port operation for the
       RxDn pin when enabled. Disabling the Receiver will flush the receive buffer invalidating the FEn, DORn, and
       UPEn Flags.

       • Bit 3 – TXENn: Transmitter Enable n
       Writing this bit to one enables the USART Transmitter. The Transmitter will override normal port operation for
       the TxDn pin when enabled. The disabling of the Transmitter (writing TXENn to zero) will not become effective
       until ongoing and pending transmissions are completed, i.e., when the Transmit Shift Register and Transmit
       Buffer Register do not contain data to be transmitted. When disabled, the Transmitter will no longer override the
       TxDn port.

       • Bit 2 – UCSZn2: Character Size n
       The UCSZn2 bits combined with the UCSZn1:0 bit in UCSRnC sets the number of data bits (Character SiZe) in
       a frame the Receiver and Transmitter use.

       • Bit 1 – RXB8n: Receive Data Bit 8 n
       RXB8n is the ninth data bit of the received character when operating with serial frames with nine data bits. Must
       be read before reading the low bits from UDRn.

       • Bit 0 – TXB8n: Transmit Data Bit 8 n
       TXB8n is the ninth data bit in the character to be transmitted when operating with serial frames with nine data
       bits. Must be written before writing the low bits to UDRn.

20.11.4 UCSRnC – USART Control and Status Register n C
        Bit                      7           6           5           4           3             2     1        0
                            UMSELn1      UMSELn0      UPMn1     UPMn0         USBSn      UCSZn1    UCSZn0   UCPOLn      UCSRnC
        Read/Write             R/W          R/W         R/W       R/W           R/W        R/W      R/W      R/W
        Initial Value            0           0           0           0           0             1     1        0


       • Bits 7:6 – UMSELn1:0 USART Mode Select
       These bits select the mode of operation of the USARTn as shown in Table 20-8.

       Table 20-8.           UMSELn Bits Settings
               UMSELn1                     UMSELn0            Mode
                        0                         0           Asynchronous USART
                        0                         1           Synchronous USART
                        1                         0           (Reserved)
                        1                         1           Master SPI (MSPIM)(1)

       Note:       1.       See ”USART in SPI Mode” on page 205 for full description of the Master SPI Mode (MSPIM) operation




        2020 Microchip Technology Inc.                                  Data Sheet Complete                      DS40002061B-page 202
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

• Bits 5:4 – UPMn1:0: Parity Mode
These bits enable and set type of parity generation and check. If enabled, the Transmitter will automatically
generate and send the parity of the transmitted data bits within each frame. The Receiver will generate a parity
value for the incoming data and compare it to the UPMn setting. If a mismatch is detected, the UPEn Flag in
UCSRnA will be set.

Table 20-9.    UPMn Bits Settings
       UPMn1                   UPMn0        Parity Mode
          0                        0        Disabled
          0                        1        Reserved
          1                        0        Enabled, Even Parity
          1                        1        Enabled, Odd Parity

• Bit 3 – USBSn: Stop Bit Select
This bit selects the number of stop bits to be inserted by the Transmitter. The Receiver ignores this setting.

Table 20-10.   USBS Bit Settings
                   USBSn                    Stop Bit(s)
                       0                    1-bit
                       1                    2-bit

• Bit 2:1 – UCSZn1:0: Character Size
The UCSZn1:0 bits combined with the UCSZn2 bit in UCSRnB sets the number of data bits (Character SiZe) in
a frame the Receiver and Transmitter use.

Table 20-11.   UCSZn Bits Settings
       UCSZn2                  UCSZn1               UCSZn0           Character Size
          0                        0                   0             5-bit
          0                        0                   1             6-bit
          0                        1                   0             7-bit
          0                        1                   1             8-bit
          1                        0                   0             Reserved
          1                        0                   1             Reserved
          1                        1                   0             Reserved
          1                        1                   1             9-bit

• Bit 0 – UCPOLn: Clock Polarity
This bit is used for synchronous mode only. Write this bit to zero when asynchronous mode is used. The
UCPOLn bit sets the relationship between data output change and data input sample, and the synchronous
clock (XCKn).




 2020 Microchip Technology Inc.                       Data Sheet Complete                    DS40002061B-page 203
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


      Table 20-12.     UCPOLn Bit Settings
                       Transmitted Data Changed (Output of        Received Data Sampled (Input on RxDn
         UCPOLn        TxDn Pin)                                  Pin)
              0        Rising XCKn Edge                           Falling XCKn Edge
              1        Falling XCKn Edge                          Rising XCKn Edge


20.11.5 UBRRnL and UBRRnH – USART Baud Rate Registers
       Bit                15             14   13        12           11            10       9      8
                          –              –    –         –                          UBRRn[11:8]              UBRRnH
                                                        UBRRn[7:0]                                          UBRRnL
                          7              6     5        4            3             2        1      0
       Read/Write         R              R    R         R           R/W        R/W         R/W   R/W
                         R/W         R/W      R/W      R/W          R/W        R/W         R/W   R/W
       Initial Value      0              0     0        0            0             0        0      0
                          0              0     0        0            0             0        0      0


      • Bit 15:12 – Reserved
      These bits are reserved for future use. For compatibility with future devices, these bit must be written to zero
      when UBRRnH is written.

      • Bit 11:0 – UBRR[11:0]: USART Baud Rate Register
      This is a 12-bit register which contains the USART baud rate. The UBRRnH contains the four most significant
      bits, and the UBRRnL contains the eight least significant bits of the USART baud rate. Ongoing transmissions
      by the Transmitter and Receiver will be corrupted if the baud rate is changed. Writing UBRRnL will trigger an
      immediate update of the baud rate prescaler.




       2020 Microchip Technology Inc.                       Data Sheet Complete                       DS40002061B-page 204
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P


21.    USART in SPI Mode

21.1   Features
       •   Full Duplex, Three-wire Synchronous Data Transfer
       •   Master Operation
       •   Supports all four SPI Modes of Operation (Mode 0, 1, 2, and 3)
       •   LSB First or MSB First Data Transfer (Configurable Data Order)
       •   Queued Operation (Double Buffered)
       •   High Resolution Baud Rate Generator
       •   High Speed Operation (fXCKmax = fCK/2)
       •   Flexible Interrupt Generation


21.2   Overview
       The Universal Synchronous and Asynchronous serial Receiver and Transmitter (USART) can be set to a master
       SPI compliant mode of operation.
       Setting both UMSELn1:0 bits to one enables the USART in MSPIM logic. In this mode of operation the SPI
       master control logic takes direct control over the USART resources. These resources include the transmitter
       and receiver shift register and buffers, and the baud rate generator. The parity generator and checker, the data
       and clock recovery logic, and the RX and TX control logic is disabled. The USART RX and TX control logic is
       replaced by a common SPI transfer control logic. However, the pin control logic and interrupt generation logic is
       identical in both modes of operation.
       The I/O register locations are the same in both modes. However, some of the functionality of the control
       registers changes when using MSPIM.

21.3   Clock Generation
       The Clock Generation logic generates the base clock for the Transmitter and Receiver. For USART MSPIM
       mode of operation only internal clock generation (i.e. master operation) is supported. The Data Direction
       Register for the XCKn pin (DDR_XCKn) must therefore be set to one (i.e. as output) for the USART in MSPIM to
       operate correctly. Preferably the DDR_XCKn should be set up before the USART in MSPIM is enabled (i.e.
       TXENn and RXENn bit set to one).
       The internal clock generation used in MSPIM mode is identical to the USART synchronous master mode. The
       baud rate or UBRRn setting can therefore be calculated using the same equations, see Table 21-1:

       Table 21-1.      Equations for Calculating Baud Rate Register Setting
                                       Equation for Calculating Baud                          Equation for Calculating UBRRn
           Operating Mode                         Rate(1)                                                  Value




           Synchronous Master                                  f OSC                                           f OSC
           mode                           BAUD = ---------------------------------------          UBRRn = -------------------- – 1
                                                 2  UBRRn + 1                                           2BAUD




       Note:     1.   The baud rate is defined to be the transfer rate in bit per second (bps)




        2020 Microchip Technology Inc.                                           Data Sheet Complete                                DS40002061B-page 205
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

                 BAUD              Baud rate (in bits per second, bps)
                 fOSC              System Oscillator clock frequency
                 UBRRn             Contents of the UBRRnH and UBRRnL Registers, (0-4095)

21.4   SPI Data Modes and Timing
       There are four combinations of XCKn (SCK) phase and polarity with respect to serial data, which are
       determined by control bits UCPHAn and UCPOLn. The data transfer timing diagrams are shown in Figure 21-1.
       Data bits are shifted out and latched in on opposite edges of the XCKn signal, ensuring sufficient time for data
       signals to stabilize. The UCPOLn and UCPHAn functionality is summarized in Table 21-2. Note that changing
       the setting of any of these bits will corrupt all ongoing communication for both the Receiver and Transmitter.

       Table 21-2.           UCPOLn and UCPHAn Functionality
            UCPOLn                 UCPHAn         SPI Mode      Leading Edge                 Trailing Edge
                      0                0                0       Sample (Rising)              Setup (Falling)
                      0                1                1       Setup (Rising)               Sample (Falling)
                      1                0                2       Sample (Falling)             Setup (Rising)
                      1                1                3       Setup (Falling)              Sample (Rising)

       Figure 21-1.          UCPHAn and UCPOLn data transfer timing diagrams.
                                              UCPOL=0                                        UCPOL=1
            UCPHA=1




                          XCK                                            XCK

                          Data setup (TXD)                               Data setup (TXD)

                          Data sample (RXD)                              Data sample (RXD)
            UCPHA=0




                          XCK                                            XCK

                          Data setup (TXD)                               Data setup (TXD)

                          Data sample (RXD)                              Data sample (RXD)




21.5   Frame Formats
       A serial frame for the MSPIM is defined to be one character of 8 data bits. The USART in MSPIM mode has two
       valid frame formats:
                8-bit data with MSB first
                8-bit data with LSB first
       A frame starts with the least or most significant data bit. Then the next data bits, up to a total of eight, are
       succeeding, ending with the most or least significant bit accordingly. When a complete frame is transmitted, a
       new frame can directly follow it, or the communication line can be set to an idle (high) state.
       The UDORDn bit in UCSRnC sets the frame format used by the USART in MSPIM mode. The Receiver and
       Transmitter use the same setting. Note that changing the setting of any of these bits will corrupt all ongoing
       communication for both the Receiver and Transmitter.
       16-bit data transfer can be achieved by writing two data bytes to UDRn. A UART transmit complete interrupt will
       then signal that the 16-bit value has been shifted out.




        2020 Microchip Technology Inc.                            Data Sheet Complete                          DS40002061B-page 206
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

21.5.1 USART MSPIM Initialization
       The USART in MSPIM mode has to be initialized before any communication can take place. The initialization
       process normally consists of setting the baud rate, setting master mode of operation (by setting DDR_XCKn to
       one), setting frame format and enabling the Transmitter and the Receiver. Only the transmitter can operate
       independently. For interrupt driven USART operation, the Global Interrupt Flag should be cleared (and thus
       interrupts globally disabled) when doing the initialization.


       Note:   To ensure immediate initialization of the XCKn output the baud-rate register (UBRRn) must be zero at the time the
               transmitter is enabled. Contrary to the normal mode USART operation the UBRRn must then be written to the
               desired value after the transmitter is enabled, but before the first transmission is started. Setting UBRRn to zero
               before enabling the transmitter is not necessary if the initialization is done immediately after a reset since UBRRn is
               reset to zero.
       Before doing a re-initialization with changed baud rate, data mode, or frame format, be sure that there is no
       ongoing transmissions during the period the registers are changed. The TXCn Flag can be used to check that
       the Transmitter has completed all transfers, and the RXCn Flag can be used to check that there are no unread
       data in the receive buffer. Note that the TXCn Flag must be cleared before each transmission (before UDRn is
       written) if it is used for this purpose.
       The following simple USART initialization code examples show one assembly and one C function that are equal
       in functionality. The examples assume polling (no interrupts enabled). The baud rate is given as a function
       parameter. For the assembly code, the baud rate parameter is assumed to be stored in the r17:r16 registers.




        2020 Microchip Technology Inc.                          Data Sheet Complete                           DS40002061B-page 207
                                     ATmega48A/PA/88A/PA/168A/PA/328/P


 Assembly Code Example(1)
          USART_Init:
                clr r18
                out UBRRnH,r18
                out UBRRnL,r18
                ; Setting the XCKn port pin as output, enables master
          mode.
                sbi XCKn_DDR, XCKn
                ; Set MSPI mode of operation and SPI data mode 0.
                ldi r18,
          (1<<UMSELn1)|(1<<UMSELn0)|(0<<UCPHAn)|(0<<UCPOLn)
                out UCSRnC,r18
                ; Enable receiver and transmitter.
                ldi r18, (1<<RXENn)|(1<<TXENn)
                out UCSRnB,r18
                ; Set baud rate.
                ; IMPORTANT: The Baud Rate must be set after the
          transmitter is enabled!
                out UBRRnH, r17
                out UBRRnL, r18
                ret
 C Code Example(1)
          void USART_Init( unsigned int baud )
          {
                UBRRn = 0;
                /* Setting the XCKn port pin as output, enables master
          mode. */
                XCKn_DDR |= (1<<XCKn);
                /* Set MSPI mode of operation and SPI data mode 0. */
                UCSRnC =
          (1<<UMSELn1)|(1<<UMSELn0)|(0<<UCPHAn)|(0<<UCPOLn);
                /* Enable receiver and transmitter. */
                UCSRnB = (1<<RXENn)|(1<<TXENn);
                /* Set baud rate. */
                /* IMPORTANT: The Baud Rate must be set after the
          transmitter is enabled */
                UBRRn = baud;
          }

Note:   1. See ”About Code Examples” on page 17.




 2020 Microchip Technology Inc.                   Data Sheet Complete   DS40002061B-page 208
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P


21.6   Data Transfer
       Using the USART in MSPI mode requires the Transmitter to be enabled, i.e. the TXENn bit in the UCSRnB
       register is set to one. When the Transmitter is enabled, the normal port operation of the TxDn pin is overridden
       and given the function as the Transmitter's serial output. Enabling the receiver is optional and is done by setting
       the RXENn bit in the UCSRnB register to one. When the receiver is enabled, the normal pin operation of the
       RxDn pin is overridden and given the function as the Receiver's serial input. The XCKn will in both cases be
       used as the transfer clock.
       After initialization the USART is ready for doing data transfers. A data transfer is initiated by writing to the UDRn
       I/O location. This is the case for both sending and receiving data since the transmitter controls the transfer
       clock. The data written to UDRn is moved from the transmit buffer to the shift register when the shift register is
       ready to send a new frame.


       Note:   To keep the input buffer in sync with the number of data bytes transmitted, the UDRn register must be read once for
               each byte transmitted. The input buffer operation is identical to normal USART mode, i.e. if an overflow occurs the
               character last received will be lost, not the first data in the buffer. This means that if four bytes are transferred, byte
               1 first, then byte 2, 3, and 4, and the UDRn is not read before all transfers are completed, then byte 3 to be received
               will be lost, and not byte 1.


       The following code examples show a simple USART in MSPIM mode transfer function based on polling of the
       Data Register Empty (UDREn) Flag and the Receive Complete (RXCn) Flag. The USART has to be initialized
       before the function can be used. For the assembly code, the data to be sent is assumed to be stored in Register
       R16 and the data received will be available in the same register (R16) after the function returns.
       The function simply waits for the transmit buffer to be empty by checking the UDREn Flag, before loading it with
       new data to be transmitted. The function then waits for data to be present in the receive buffer by checking the
       RXCn Flag, before reading the buffer and returning the value.




        2020 Microchip Technology Inc.                           Data Sheet Complete                             DS40002061B-page 209
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

        Assembly Code Example(1)
                 USART_MSPIM_Transfer:
                       ; Wait for empty transmit buffer
                       in r16, UCSRnA
                       sbrs r16, UDREn
                       rjmp USART_MSPIM_Transfer
                       ; Put data (r16) into buffer, sends the data
                       out UDRn,r16
                       ; Wait for data to be received
                 USART_MSPIM_Wait_RXCn:
                       in r16, UCSRnA
                       sbrs r16, RXCn
                       rjmp USART_MSPIM_Wait_RXCn
                       ; Get and return received data from buffer
                       in r16, UDRn
                       ret
        C Code Example(1)
                 unsigned char USART_Receive( void )
                 {
                       /* Wait for empty transmit buffer */
                       while ( !( UCSRnA & (1<<UDREn)) );
                       /* Put data into buffer, sends the data */
                       UDRn = data;
                       /* Wait for data to be received */
                       while ( !(UCSRnA & (1<<RXCn)) );
                       /* Get and return received data from buffer */
                       return UDRn;
                 }
       Note:   1. See ”About Code Examples” on page 17.

21.6.1 Transmitter and Receiver Flags and Interrupts
       The RXCn, TXCn, and UDREn flags and corresponding interrupts in USART in MSPIM mode are identical in
       function to the normal USART operation. However, the receiver error status flags (FE, DOR, and PE) are not in
       use and is always read as zero.

21.6.2 Disabling the Transmitter or Receiver
       The disabling of the transmitter or receiver in USART in MSPIM mode is identical in function to the normal
       USART operation.




        2020 Microchip Technology Inc.                   Data Sheet Complete                     DS40002061B-page 210
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


21.7   AVR USART MSPIM vs. AVR SPI
       The USART in MSPIM mode is fully compatible with the AVR SPI regarding:
            Master mode timing diagram.
            The UCPOLn bit functionality is identical to the SPI CPOL bit.
            The UCPHAn bit functionality is identical to the SPI CPHA bit.
            The UDORDn bit functionality is identical to the SPI DORD bit.
       However, since the USART in MSPIM mode reuses the USART resources, the use of the USART in MSPIM
       mode is somewhat different compared to the SPI. In addition to differences of the control register bits, and that
       only master operation is supported by the USART in MSPIM mode, the following features differ between the two
       modules:
            The USART in MSPIM mode includes (double) buffering of the transmitter. The SPI has no buffer.
            The USART in MSPIM mode receiver includes an additional buffer level.
            The SPI WCOL (Write Collision) bit is not included in USART in MSPIM mode.
            The SPI double speed mode (SPI2X) bit is not included. However, the same effect is achieved by setting
             UBRRn accordingly.
            Interrupt timing is not compatible.
            Pin control differs due to the master only operation of the USART in MSPIM mode.
       A comparison of the USART in MSPIM mode and the SPI pins is shown in Table 21-3 on page 211.

       Table 21-3.    Comparison of USART in MSPIM mode and SPI pins
                USART_MSPIM                           SPI                   Comment
                      TxDn                           MOSI                   Master Out only
                      RxDn                           MISO                   Master In only
                     XCKn                             SCK                   (Functionally identical)
                                                                           Not supported by USART in
                      (N/A)                           SS
                                                                           MSPIM




        2020 Microchip Technology Inc.                     Data Sheet Complete                        DS40002061B-page 211
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P


21.8   Register Description
       The following section describes the registers used for SPI operation using the USART.

21.8.1 UDRn – USART MSPIM I/O Data Register
       The function and bit description of the USART data register (UDRn) in MSPI mode is identical to normal USART
       operation. See ”UDRn – USART I/O Data Register n” on page 200.

21.8.2 UCSRnA – USART MSPIM Control and Status Register n A
        Bit              7          6              5           4           3           2       1       0
                        RXCn       TXCn         UDREn          –           –           –       –       –            UCSRnA
        Read/Write       R         R/W            R            R           R           R       R       R
        Initial Value    0          0              0           0           0           1       1       0


       • Bit 7 – RXCn: USART Receive Complete
       This flag bit is set when there are unread data in the receive buffer and cleared when the receive buffer is empty
       (i.e., does not contain any unread data). If the Receiver is disabled, the receive buffer will be flushed and
       consequently the RXCn bit will become zero. The RXCn Flag can be used to generate a Receive Complete
       interrupt (see description of the RXCIEn bit).

       • Bit 6 – TXCn: USART Transmit Complete
       This flag bit is set when the entire frame in the Transmit Shift Register has been shifted out and there are no
       new data currently present in the transmit buffer (UDRn). The TXCn Flag bit is automatically cleared when a
       transmit complete interrupt is executed, or it can be cleared by writing a one to its bit location. The TXCn Flag
       can generate a Transmit Complete interrupt (see description of the TXCIEn bit).

       • Bit 5 – UDREn: USART Data Register Empty
       The UDREn Flag indicates if the transmit buffer (UDRn) is ready to receive new data. If UDREn is one, the
       buffer is empty, and therefore ready to be written. The UDREn Flag can generate a Data Register Empty
       interrupt (see description of the UDRIE bit). UDREn is set after a reset to indicate that the Transmitter is ready.

       • Bit 4:0 – Reserved Bits in MSPI mode
       When in MSPI mode, these bits are reserved for future use. For compatibility with future devices, these bits
       must be written to zero when UCSRnA is written.

21.8.3 UCSRnB – USART MSPIM Control and Status Register n B
        Bit                    7            6            5           4           3         2       1       0
                          RXCIEn          TXCIEn       UDRIE       RXENn       TXENn       –       -       -        UCSRnB
        Read/Write           R/W           R/W          R/W         R/W         R/W        R       R   R
        Initial Value          0            0            0           0           0         1       1       0


       • Bit 7 – RXCIEn: RX Complete Interrupt Enable
       Writing this bit to one enables interrupt on the RXCn Flag. A USART Receive Complete interrupt will be
       generated only if the RXCIEn bit is written to one, the Global Interrupt Flag in SREG is written to one and the
       RXCn bit in UCSRnA is set.




        2020 Microchip Technology Inc.                             Data Sheet Complete                        DS40002061B-page 212
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

      • Bit 6 – TXCIEn: TX Complete Interrupt Enable
      Writing this bit to one enables interrupt on the TXCn Flag. A USART Transmit Complete interrupt will be
      generated only if the TXCIEn bit is written to one, the Global Interrupt Flag in SREG is written to one and the
      TXCn bit in UCSRnA is set.

      • Bit 5 – UDRIE: USART Data Register Empty Interrupt Enable
      Writing this bit to one enables interrupt on the UDREn Flag. A Data Register Empty interrupt will be generated
      only if the UDRIE bit is written to one, the Global Interrupt Flag in SREG is written to one and the UDREn bit in
      UCSRnA is set.

      • Bit 4 – RXENn: Receiver Enable
      Writing this bit to one enables the USART Receiver in MSPIM mode. The Receiver will override normal port
      operation for the RxDn pin when enabled. Disabling the Receiver will flush the receive buffer. Only enabling the
      receiver in MSPI mode (i.e. setting RXENn=1 and TXENn=0) has no meaning since it is the transmitter that
      controls the transfer clock and since only master mode is supported.

      • Bit 3 – TXENn: Transmitter Enable
      Writing this bit to one enables the USART Transmitter. The Transmitter will override normal port operation for
      the TxDn pin when enabled. The disabling of the Transmitter (writing TXENn to zero) will not become effective
      until ongoing and pending transmissions are completed, i.e., when the Transmit Shift Register and Transmit
      Buffer Register do not contain data to be transmitted. When disabled, the Transmitter will no longer override the
      TxDn port.

      • Bit 2:0 – Reserved Bits in MSPI mode
      When in MSPI mode, these bits are reserved for future use. For compatibility with future devices, these bits
      must be written to zero when UCSRnB is written.

21.8.4 UCSRnC – USART MSPIM Control and Status Register n C
       Bit                  7              6         5    4         3          2          1         0
                       UMSELn1       UMSELn0         –    –         –      UDORDn       UCPHAn    UCPOLn     UCSRnC
       Read/Write          R/W            R/W        R    R         R         R/W        R/W       R/W
       Initial Value        0              0         0    0         0          1          1         0


      • Bit 7:6 – UMSELn1:0: USART Mode Select
      These bits select the mode of operation of the USART as shown in Table 21-4. See ”UCSRnC – USART Control
      and Status Register n C” on page 202 for full description of the normal USART operation. The MSPIM is
      enabled when both UMSELn bits are set to one. The UDORDn, UCPHAn, and UCPOLn can be set in the same
      write operation where the MSPIM is enabled.

      Table 21-4.      UMSELn Bits Settings
        UMSELn1                                 UMSELn0                      Mode
        0                                       0                            Asynchronous USART
        0                                       1                             Synchronous USART
        1                                       0                            Reserved
        1                                       1                            Master SPI (MSPIM)




        2020 Microchip Technology Inc.                       Data Sheet Complete                       DS40002061B-page 213
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

      • Bit 5:3 – Reserved Bits in MSPI mode
      When in MSPI mode, these bits are reserved for future use. For compatibility with future devices, these bits
      must be written to zero when UCSRnC is written.

      • Bit 2 – UDORDn: Data Order
      When set to one the LSB of the data word is transmitted first. When set to zero the MSB of the data word is
      transmitted first. Refer to the Frame Formats section page 4 for details.

      • Bit 1 – UCPHAn: Clock Phase
      The UCPHAn bit setting determine if data is sampled on the leasing edge (first) or tailing (last) edge of XCKn.
      Refer to the SPI Data Modes and Timing section page 4 for details.

      • Bit 0 – UCPOLn: Clock Polarity
      The UCPOLn bit sets the polarity of the XCKn clock. The combination of the UCPOLn and UCPHAn bit settings
      determine the timing of the data transfer. Refer to the SPI Data Modes and Timing section page 4 for details.

21.8.5 USART MSPIM Baud Rate Registers – UBRRnL and UBRRnH
      The function and bit description of the baud rate registers in MSPI mode is identical to normal USART operation.
      See “UBRRnL and UBRRnH – USART Baud Rate Registers” on page 204.




       2020 Microchip Technology Inc.                    Data Sheet Complete                     DS40002061B-page 214
                                              ATmega48A/PA/88A/PA/168A/PA/328/P


22.    2-wire Serial Interface

22.1   Features
       •   Simple Yet Powerful and Flexible Communication Interface, only two Bus Lines Needed
       •   Both Master and Slave Operation Supported
       •   Device can Operate as Transmitter or Receiver
       •   7-bit Address Space Allows up to 128 Different Slave Addresses
       •   Multi-master Arbitration Support
       •   Up to 400kHz Data Transfer Speed
       •   Slew-rate Limited Output Drivers
       •   Noise Suppression Circuitry Rejects Spikes on Bus Lines
       •   Fully Programmable Slave Address with General Call Support
       •   Address Recognition Causes Wake-up When AVR is in Sleep Mode
       •   Compatible with Philips’ I2C protocol


22.2   2-wire Serial Interface Bus Definition
       The 2-wire Serial Interface (TWI) is ideally suited for typical microcontroller applications. The TWI protocol
       allows the systems designer to interconnect up to 128 different devices using only two bi-directional bus lines,
       one for clock (SCL) and one for data (SDA). The only external hardware needed to implement the bus is a single
       pull-up resistor for each of the TWI bus lines. All devices connected to the bus have individual addresses, and
       mechanisms for resolving bus contention are inherent in the TWI protocol.

       Figure 22-1.    TWI Bus Interconnection

                                                                                   VCC




                                 Device 1   Device 2    Device 3   ........   Device n   R1        R2




                 SDA


                 SCL




        2020 Microchip Technology Inc.                    Data Sheet Complete                     DS40002061B-page 215
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

22.2.1 TWI Terminology
       The following definitions are frequently encountered in this section.

       Table 22-1.    TWI Terminology
        Term            Description
                        The device that initiates and terminates a transmission. The Master also generates the
        Master
                        SCL clock.
        Slave           The device addressed by a Master.
        Transmitter     The device placing data on the bus.
        Receiver        The device reading data from the bus.

       The PRTWI bit in ”Minimizing Power Consumption” on page 51 must be written to zero to enable the 2-wire
       Serial Interface.

22.2.2 Electrical Interconnection
       As depicted in Figure 22-1, both bus lines are connected to the positive supply voltage through pull-up resistors.
       The bus drivers of all TWI-compliant devices are open-drain or open-collector. This implements a wired-AND
       function which is essential to the operation of the interface. A low level on a TWI bus line is generated when one
       or more TWI devices output a zero. A high level is output when all TWI devices tri-state their outputs, allowing
       the pull-up resistors to pull the line high. Note that all AVR devices connected to the TWI bus must be powered
       in order to allow any bus operation.
       The number of devices that can be connected to the bus is only limited by the bus capacitance limit of 400 pF
       and the 7-bit slave address space. A detailed specification of the electrical characteristics of the TWI is given in
       ”Two-wire Serial Interface Characteristics” on page 317. Two different sets of specifications are presented
       there, one relevant for bus speeds below 100kHz, and one valid for bus speeds up to 400kHz.

22.3   Data Transfer and Frame Format

22.3.1 Transferring Bits
       Each data bit transferred on the TWI bus is accompanied by a pulse on the clock line. The level of the data line
       must be stable when the clock line is high. The only exception to this rule is for generating start and stop
       conditions.

       Figure 22-2.   Data Validity



                                SDA



                                SCL

                                                   Data Stable              Data Stable

                                                                 Data Change




        2020 Microchip Technology Inc.                         Data Sheet Complete                        DS40002061B-page 216
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

22.3.2 START and STOP Conditions
      The Master initiates and terminates a data transmission. The transmission is initiated when the Master issues a
      START condition on the bus, and it is terminated when the Master issues a STOP condition. Between a START
      and a STOP condition, the bus is considered busy, and no other master should try to seize control of the bus. A
      special case occurs when a new START condition is issued between a START and STOP condition. This is
      referred to as a REPEATED START condition, and is used when the Master wishes to initiate a new transfer
      without relinquishing control of the bus. After a REPEATED START, the bus is considered busy until the next
      STOP. This is identical to the START behavior, and therefore START is used to describe both START and
      REPEATED START for the remainder of this datasheet, unless otherwise noted. As depicted below, START
      and STOP conditions are signalled by changing the level of the SDA line when the SCL line is high.

      Figure 22-3.    START, REPEATED START and STOP conditions




                      SDA




                      SCL



                            START                     STOP     START              REPEATED START       STOP


22.3.3 Address Packet Format
      All address packets transmitted on the TWI bus are 9 bits long, consisting of 7 address bits, one READ/WRITE
      control bit and an acknowledge bit. If the READ/WRITE bit is set, a read operation is to be performed, otherwise
      a write operation should be performed. When a Slave recognizes that it is being addressed, it should
      acknowledge by pulling SDA low in the ninth SCL (ACK) cycle. If the addressed Slave is busy, or for some other
      reason can not service the Master’s request, the SDA line should be left high in the ACK clock cycle. The Master
      can then transmit a STOP condition, or a REPEATED START condition to initiate a new transmission. An
      address packet consisting of a slave address and a READ or a WRITE bit is called SLA+R or SLA+W,
      respectively.
      The MSB of the address byte is transmitted first. Slave addresses can freely be allocated by the designer, but
      the address 0000 000 is reserved for a general call.
      When a general call is issued, all slaves should respond by pulling the SDA line low in the ACK cycle. A general
      call is used when a Master wishes to transmit the same message to several slaves in the system. When the
      general call address followed by a Write bit is transmitted on the bus, all slaves set up to acknowledge the
      general call will pull the SDA line low in the ack cycle. The following data packets will then be received by all the
      slaves that acknowledged the general call. Note that transmitting the general call address followed by a Read bit
      is meaningless, as this would cause contention if several slaves started transmitting different data.
      All addresses of the format 1111 xxx should be reserved for future purposes.




        2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 217
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 22-4.   Address Packet Format

                                              Addr MSB                        Addr LSB       R/W   ACK

                       SDA



                       SCL
                                                   1       2                      7            8   9
                                    START


22.3.4 Data Packet Format
       All data packets transmitted on the TWI bus are nine bits long, consisting of one data byte and an acknowledge
       bit. During a data transfer, the Master generates the clock and the START and STOP conditions, while the
       Receiver is responsible for acknowledging the reception. An Acknowledge (ACK) is signalled by the Receiver
       pulling the SDA line low during the ninth SCL cycle. If the Receiver leaves the SDA line high, a NACK is
       signalled. When the Receiver has received the last byte, or for some reason cannot receive any more bytes, it
       should inform the Transmitter by sending a NACK after the final byte. The MSB of the data byte is transmitted
       first.

       Figure 22-5.   Data Packet Format
                                            Data MSB                          Data LSB   ACK
                      Aggregate
                        SDA

                      SDA from
                      Transmitter

                      SDA from
                       Receiver

                      SCL from
                       Master
                                               1       2             7           8       9
                                                                                                   STOP, REPEATED
                           SLA+R/W                                Data Byte                          START or Next
                                                                                                       Data Byte


22.3.5 Combining Address and Data Packets into a Transmission
       A transmission basically consists of a START condition, a SLA+R/W, one or more data packets and a STOP
       condition. An empty message, consisting of a START followed by a STOP condition, is illegal. Note that the
       Wired-ANDing of the SCL line can be used to implement handshaking between the Master and the Slave. The
       Slave can extend the SCL low period by pulling the SCL line low. This is useful if the clock speed set up by the
       Master is too fast for the Slave, or the Slave needs extra time for processing between the data transmissions.
       The Slave extending the SCL low period will not affect the SCL high period, which is determined by the Master.
       As a consequence, the Slave can reduce the TWI data transfer speed by prolonging the SCL duty cycle.
       Figure 22-6 shows a typical data transmission. Note that several data bytes can be transmitted between the
       SLA+R/W and the STOP condition, depending on the software protocol implemented by the application
       software.




        2020 Microchip Technology Inc.                        Data Sheet Complete                        DS40002061B-page 218
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 22-6.   Typical Data Transmission


                Addr MSB              Addr LSB   R/W   ACK           Data MSB                       Data LSB    ACK

SDA



SCL
                   1        2               7    8     9                1       2               7      8         9

      START                       SLA+R/W                                           Data Byte                                 STOP




22.4    Multi-master Bus Systems, Arbitration and Synchronization
        The TWI protocol allows bus systems with several masters. Special concerns have been taken in order to
        ensure that transmissions will proceed as normal, even if two or more masters initiate a transmission at the
        same time. Two problems arise in multi-master systems:
              An algorithm must be implemented allowing only one of the masters to complete the transmission. All
               other masters should cease transmission when they discover that they have lost the selection process.
               This selection process is called arbitration. When a contending master discovers that it has lost the
               arbitration process, it should immediately switch to Slave mode to check whether it is being addressed by
               the winning master. The fact that multiple masters have started transmission at the same time should not
               be detectable to the slaves, i.e. the data being transferred on the bus must not be corrupted.
              Different masters may use different SCL frequencies. A scheme must be devised to synchronize the serial
               clocks from all masters, in order to let the transmission proceed in a lockstep fashion. This will facilitate
               the arbitration process.
        The wired-ANDing of the bus lines is used to solve both these problems. The serial clocks from all masters will
        be wired-ANDed, yielding a combined clock with a high period equal to the one from the Master with the
        shortest high period. The low period of the combined clock is equal to the low period of the Master with the
        longest low period. Note that all masters listen to the SCL line, effectively starting to count their SCL high and
        low time-out periods when the combined SCL line goes high or low, respectively.




          2020 Microchip Technology Inc.                     Data Sheet Complete                              DS40002061B-page 219
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 22-7.    SCL Synchronization Between Multiple Masters
                                          TA low                             TA high


               SCL from
               Master A


               SCL from
               Master B


               SCL Bus
                 Line

                                                   TBlow                           TBhigh

                                             Masters Start                       Masters Start
                                           Counting Low Period                Counting High Period

Arbitration is carried out by all masters continuously monitoring the SDA line after outputting data. If the value
read from the SDA line does not match the value the Master had output, it has lost the arbitration. Note that a
Master can only lose arbitration when it outputs a high SDA value while another Master outputs a low value. The
losing Master should immediately go to Slave mode, checking if it is being addressed by the winning Master.
The SDA line should be left high, but losing masters are allowed to generate a clock signal until the end of the
current data or address packet. Arbitration will continue until only one Master remains, and this may take many
bits. If several masters are trying to address the same Slave, arbitration will continue into the data packet.

Figure 22-8.    Arbitration Between Two Masters
                               START                                       Master A Loses
                                                                       Arbitration, SDAA SDA
                   SDA from
                   Master A



                   SDA from
                   Master B



                   SDA Line



               Synchronized
                 SCL Line




Note that arbitration is not allowed between:
     A REPEATED START condition and a data bit.
     A STOP condition and a data bit.
     A REPEATED START and a STOP condition.



 2020 Microchip Technology Inc.                       Data Sheet Complete                     DS40002061B-page 220
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

       It is the user software’s responsibility to ensure that these illegal arbitration conditions never occur. This implies
       that in multi-master systems, all data transfers must use the same composition of SLA+R/W and data packets.
       In other words: All transmissions must contain the same number of data packets, otherwise the result of the
       arbitration is undefined.

22.5   Overview of the TWI Module
       The TWI module is comprised of several submodules, as shown in Figure 22-9. All registers drawn in a thick line
       are accessible through the AVR data bus.

       Figure 22-9.   Overview of the TWI Module

                                     SCL                                  SDA
                              Slew-rate    Spike                   Slew-rate     Spike
                               Control     Filter                   Control      Filter




                                               Bus Interface Unit                                     Bit Rate Generator
                                START / STOP
                                                         Spike Suppression                                      Prescaler
                                   Control



                                                         Address/Data Shift                                Bit Rate Register
                              Arbitration detection                             Ack
                                                          Register (TWDR)                                       (TWBR)




                              Address Match Unit                                             Control Unit




                                                                                                                               TWI Unit
                                   Address Register                            Status Register             Control Register
                                       (TWAR)                                     (TWSR)                      (TWCR)



                                                                                            State Machine and
                                  Address Comparator
                                                                                              Status control




22.5.1 SCL and SDA Pins
       These pins interface the AVR TWI with the rest of the MCU system. The output drivers contain a slew-rate
       limiter in order to conform to the TWI specification. The input stages contain a spike suppression unit removing
       spikes shorter than 50 ns. Note that the internal pull-ups in the AVR pads can be enabled by setting the PORT
       bits corresponding to the SCL and SDA pins, as explained in the I/O Port section. The internal pull-ups can in
       some systems eliminate the need for external ones.

22.5.2 Bit Rate Generator Unit
       This unit controls the period of SCL when operating in a Master mode. The SCL period is controlled by settings
       in the TWI Bit Rate Register (TWBR) and the Prescaler bits in the TWI Status Register (TWSR). Slave operation
       does not depend on Bit Rate or Prescaler settings, but the CPU clock frequency in the Slave must be at least 16




        2020 Microchip Technology Inc.                                Data Sheet Complete                                     DS40002061B-page 221
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

       times higher than the SCL frequency. Note that slaves may prolong the SCL low period, thereby reducing the
       average TWI bus clock period. The SCL frequency is generated according to the following equation:
                                                                            CPU Clock frequency
                                          SCL frequency = -----------------------------------------------------------------------------------------
                                                          16 + 2(TWBR)   PrescalerValue 

              TWBR = Value of the TWI Bit Rate Register.
              PrescalerValue = Value of the prescaler, see Table 22-7 on page 241.
       Note:     Pull-up resistor values should be selected according to the SCL frequency and the capacitive bus line load. See
                 Table 29-14 on page 317 for value of pull-up resistor.

22.5.3 Bus Interface Unit
       This unit contains the Data and Address Shift Register (TWDR), a START/STOP Controller and Arbitration
       detection hardware. The TWDR contains the address or data bytes to be transmitted, or the address or data
       bytes received. In addition to the 8-bit TWDR, the Bus Interface Unit also contains a register containing the
       (N)ACK bit to be transmitted or received. This (N)ACK Register is not directly accessible by the application
       software. However, when receiving, it can be set or cleared by manipulating the TWI Control Register (TWCR).
       When in Transmitter mode, the value of the received (N)ACK bit can be determined by the value in the TWSR.
       The START/STOP Controller is responsible for generation and detection of START, REPEATED START, and
       STOP conditions. The START/STOP controller is able to detect START and STOP conditions even when the
       AVR MCU is in one of the sleep modes, enabling the MCU to wake up if addressed by a Master.
       If the TWI has initiated a transmission as Master, the Arbitration Detection hardware continuously monitors the
       transmission trying to determine if arbitration is in process. If the TWI has lost an arbitration, the Control Unit is
       informed. Correct action can then be taken and appropriate status codes generated.

22.5.4 Address Match Unit
       The Address Match unit checks if received address bytes match the seven-bit address in the TWI Address
       Register (TWAR). If the TWI General Call Recognition Enable (TWGCE) bit in the TWAR is written to one, all
       incoming address bits will also be compared against the General Call address. Upon an address match, the
       Control Unit is informed, allowing correct action to be taken. The TWI may or may not acknowledge its address,
       depending on settings in the TWCR. The Address Match unit is able to compare addresses even when the AVR
       MCU is in sleep mode, enabling the MCU to wake up if addressed by a Master.

22.5.5 Control Unit
       The Control unit monitors the TWI bus and generates responses corresponding to settings in the TWI Control
       Register (TWCR). When an event requiring the attention of the application occurs on the TWI bus, the TWI
       Interrupt Flag (TWINT) is asserted. In the next clock cycle, the TWI Status Register (TWSR) is updated with a
       status code identifying the event. The TWSR only contains relevant status information when the TWI Interrupt
       Flag is asserted. At all other times, the TWSR contains a special status code indicating that no relevant status
       information is available. As long as the TWINT Flag is set, the SCL line is held low. This allows the application
       software to complete its tasks before allowing the TWI transmission to continue.
       The TWINT Flag is set in the following situations:
              After the TWI has transmitted a START/REPEATED START condition.
              After the TWI has transmitted SLA+R/W.
              After the TWI has transmitted an address byte.
              After the TWI has lost arbitration.
              After the TWI has been addressed by own slave address or general call.
              After the TWI has received a data byte.




        2020 Microchip Technology Inc.                                              Data Sheet Complete                                              DS40002061B-page 222
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

                       After a STOP or REPEATED START has been received while still addressed as a Slave.
                       When a bus error has occurred due to an illegal START or STOP condition.

22.6            Using the TWI
                The AVR TWI is byte-oriented and interrupt based. Interrupts are issued after all bus events, like reception of a
                byte or transmission of a START condition. Because the TWI is interrupt-based, the application software is free
                to carry on other operations during a TWI byte transfer. Note that the TWI Interrupt Enable (TWIE) bit in TWCR
                together with the Global Interrupt Enable bit in SREG allow the application to decide whether or not assertion of
                the TWINT Flag should generate an interrupt request. If the TWIE bit is cleared, the application must poll the
                TWINT Flag in order to detect actions on the TWI bus.
                When the TWINT Flag is asserted, the TWI has finished an operation and awaits application response. In this
                case, the TWI Status Register (TWSR) contains a value indicating the current state of the TWI bus. The
                application software can then decide how the TWI should behave in the next TWI bus cycle by manipulating the
                TWCR and TWDR Registers.
                Figure 22-10 is a simple example of how the application can interface to the TWI hardware. In this example, a
                Master wishes to transmit a single data byte to a Slave. This description is quite abstract, a more detailed
                explanation follows later in this section. A simple code example implementing the desired behavior is also
                presented.

Figure 22-10. Interfacing the Application to the TWI in a Typical Transmission
                                   3. Check TWSR to see if START was          5. Check TWSR to see if SLA+W was
                1. Application                                                                                              7. Check TWSR to see if data was sent
                                    sent. Application loads SLA+W into               sent and ACK received.
Application




              writes to TWCR to                                                                                                        and ACK received.
                                   TWDR, and loads appropriate control        Application loads data into TWDR, and
  Action




                    initiate                                                                                                 Application loads appropriate control
                                    signals into TWCR, makin sure that         loads appropriate control signals into
               transmission of                                                                                                 signals to send STOP into TWCR,
                                          TWINT is written to one,              TWCR, making sure that TWINT is
                    START                                                                                                   making sure that TWINT is written to one
                                       and TWSTA is written to zero.                       written to one




              TWI bus    START                     SLA+W                  A                       Data                  A            STOP




                                                                                                                                                    Indicates
                                                               4. TWINT set.
     Hardware




                      2. TWINT set.                                                                           6. TWINT set.                        TWINT set
      Action




                                                           Status code indicates
       TWI




                  Status code indicates                                                                   Status code indicates
                                                            SLA+W sent, ACK
                  START condition sent                                                                   data sent, ACK received
                                                                  received




                 1.     The first step in a TWI transmission is to transmit a START condition. This is done by writing a specific
                        value into TWCR, instructing the TWI hardware to transmit a START condition. Which value to write is
                        described later on. However, it is important that the TWINT bit is set in the value written. Writing a one to
                        TWINT clears the flag. The TWI will not start any operation as long as the TWINT bit in TWCR is set.
                        Immediately after the application has cleared TWINT, the TWI will initiate transmission of the START
                        condition.
                 2.     When the START condition has been transmitted, the TWINT Flag in TWCR is set, and TWSR is updated
                        with a status code indicating that the START condition has successfully been sent.
                 3.     The application software should now examine the value of TWSR, to make sure that the START condition
                        was successfully transmitted. If TWSR indicates otherwise, the application software might take some
                        special action, like calling an error routine. Assuming that the status code is as expected, the application




                 2020 Microchip Technology Inc.                                   Data Sheet Complete                                    DS40002061B-page 223
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

      must load SLA+W into TWDR. Remember that TWDR is used both for address and data. After TWDR has
      been loaded with the desired SLA+W, a specific value must be written to TWCR, instructing the TWI
      hardware to transmit the SLA+W present in TWDR. Which value to write is described later on. However, it
      is important that the TWINT bit is set in the value written. Writing a one to TWINT clears the flag. The TWI
      will not start any operation as long as the TWINT bit in TWCR is set. Immediately after the application has
      cleared TWINT, the TWI will initiate transmission of the address packet.
 4.   When the address packet has been transmitted, the TWINT Flag in TWCR is set, and TWSR is updated
      with a status code indicating that the address packet has successfully been sent. The status code will also
      reflect whether a Slave acknowledged the packet or not.
 5.   The application software should now examine the value of TWSR, to make sure that the address packet
      was successfully transmitted, and that the value of the ACK bit was as expected. If TWSR indicates
      otherwise, the application software might take some special action, like calling an error routine. Assuming
      that the status code is as expected, the application must load a data packet into TWDR. Subsequently, a
      specific value must be written to TWCR, instructing the TWI hardware to transmit the data packet present
      in TWDR. Which value to write is described later on. However, it is important that the TWINT bit is set in
      the value written. Writing a one to TWINT clears the flag. The TWI will not start any operation as long as
      the TWINT bit in TWCR is set. Immediately after the application has cleared TWINT, the TWI will initiate
      transmission of the data packet.
 6.   When the data packet has been transmitted, the TWINT Flag in TWCR is set, and TWSR is updated with
      a status code indicating that the data packet has successfully been sent. The status code will also reflect
      whether a Slave acknowledged the packet or not.
 7.   The application software should now examine the value of TWSR, to make sure that the data packet was
      successfully transmitted, and that the value of the ACK bit was as expected. If TWSR indicates otherwise,
      the application software might take some special action, like calling an error routine. Assuming that the
      status code is as expected, the application must write a specific value to TWCR, instructing the TWI
      hardware to transmit a STOP condition. Which value to write is described later on. However, it is important
      that the TWINT bit is set in the value written. Writing a one to TWINT clears the flag. The TWI will not start
      any operation as long as the TWINT bit in TWCR is set. Immediately after the application has cleared
      TWINT, the TWI will initiate transmission of the STOP condition. Note that TWINT is NOT set after a
      STOP condition has been sent.


Even though this example is simple, it shows the principles involved in all TWI transmissions. These can be
summarized as follows:
     When the TWI has finished an operation and expects application response, the TWINT Flag is set. The
      SCL line is pulled low until TWINT is cleared.
     When the TWINT Flag is set, the user must update all TWI Registers with the value relevant for the next
      TWI bus cycle. As an example, TWDR must be loaded with the value to be transmitted in the next bus
      cycle.
     After all TWI Register updates and other pending application software tasks have been completed, TWCR
      is written. When writing TWCR, the TWINT bit should be set. Writing a one to TWINT clears the flag. The
      TWI will then commence executing whatever operation was specified by the TWCR setting.


In the following an assembly and C implementation of the example is given. Note that the code below assumes
that several definitions have been made, for example by using include-files.




 2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 224
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


       Assembly Code Example                         C Example                      Comments
        ldi    r16,                                   TWCR =
        (1<<TWINT)|(1<<TWS)|                          (1<<TWINT)|(1<<TWST
 1                                                                                  Send START condition
               (1<<TWEN)                              A|
        out    TWCR, r16                              (1<<TWEN)
        wait1:                                        while (!(TWCR &
                                                                                    Wait for TWINT Flag set. This
        in     r16,TWCR                               (1<<TWINT)))
 2                                                                                  indicates that the START
        sbrs   r16,TWINT                                     ;
                                                                                    condition has been transmitted
        rjmp   wait1
        in          r16,TWSR                          if ((TWSR & 0xF8) !=          Check value of TWI Status
        andi        r16, 0xF8                         START)                        Register. Mask prescaler bits. If
        cpi         r16, START                               ERROR();               status different from START go to
        brne        ERROR                                                           ERROR
 3      ldi         r16, SLA_W                        TWDR = SLA_W;
                                                                                    Load SLA_W into TWDR
        out         TWDR, r16                         TWCR = (1<<TWINT) |
                                                                                    Register. Clear TWINT bit in
        ldi         r16, (1<<TWINT) |                 (1<<TWEN);
                                                                                    TWCR to start transmission of
        (1<<TWEN)                                                                   address
        out         TWCR, r16
        wait2:                                        while (!(TWCR &               Wait for TWINT Flag set. This
        in          r16,TWCR                          (1<<TWINT)))                  indicates that the SLA+W has
 4
        sbrs        r16,TWINT                                ;                      been transmitted, and
        rjmp        wait2                                                           ACK/NACK has been received.
        in          r16,TWSR                          if ((TWSR & 0xF8) !=          Check value of TWI Status
        andi        r16, 0xF8                         MT_SLA_ACK)                   Register. Mask prescaler bits. If
        cpi         r16, MT_SLA_ACK                          ERROR();               status different from
        brne        ERROR                                                           MT_SLA_ACK go to ERROR
 5      ldi         r16, DATA                         TWDR = DATA;
        out         TWDR, r16                         TWCR = (1<<TWINT) |           Load DATA into TWDR Register.
        ldi         r16, (1<<TWINT) |                 (1<<TWEN);                    Clear TWINT bit in TWCR to start
        (1<<TWEN)                                                                   transmission of data
        out         TWCR, r16
        wait3:                                        while (!(TWCR &               Wait for TWINT Flag set. This
        in          r16,TWCR                          (1<<TWINT)))                  indicates that the DATA has been
 6
        sbrs        r16,TWINT                                ;                      transmitted, and ACK/NACK has
        rjmp        wait3                                                           been received.
        in          r16,TWSR                          if ((TWSR & 0xF8) !=          Check value of TWI Status
        andi        r16, 0xF8                         MT_DATA_ACK)                  Register. Mask prescaler bits. If
        cpi         r16, MT_DATA_ACK                              ERROR();          status different from
        brne        ERROR                                                           MT_DATA_ACK go to ERROR
 7
        ldi         r16,                              TWCR =
        (1<<TWINT)|(1<<TWEN)|                         (1<<TWINT)|(1<<TWEN
                                                                                    Transmit STOP condition
                    (1<<TWSTO)                        |
        out         TWCR, r16                                (1<<TWSTO);

22.7   Transmission Modes
       The TWI can operate in one of four major modes. These are named Master Transmitter (MT), Master Receiver
       (MR), Slave Transmitter (ST) and Slave Receiver (SR). Several of these modes can be used in the same
       application. As an example, the TWI can use MT mode to write data into a TWI EEPROM, MR mode to read the
       data back from the EEPROM. If other masters are present in the system, some of these might transmit data to
       the TWI, and then SR mode would be used. It is the application software that decides which modes are legal.



        2020 Microchip Technology Inc.                 Data Sheet Complete                      DS40002061B-page 225
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P


       The following sections describe each of these modes. Possible status codes are described along with figures
       detailing data transmission in each of the modes. These figures contain the following abbreviations:
                S: START condition
                Rs: REPEATED START condition
                R: Read bit (high level at SDA)
                W: Write bit (low level at SDA)
                A: Acknowledge bit (low level at SDA)
                A: Not acknowledge bit (high level at SDA)
                Data: 8-bit data byte
                P: STOP condition
                SLA: Slave Address
       In Figure 22-12 to Figure 22-18, circles are used to indicate that the TWINT Flag is set. The numbers in the
       circles show the status code held in TWSR, with the prescaler bits masked to zero. At these points, actions must
       be taken by the application to continue or complete the TWI transfer. The TWI transfer is suspended until the
       TWINT Flag is cleared by software.
       When the TWINT Flag is set, the status code in TWSR is used to determine the appropriate software action. For
       each status code, the required software action and details of the following serial transfer are given in Table 22-2
       to Table 22-5. Note that the prescaler bits are masked to zero in these tables.

22.7.1 Master Transmitter Mode
       In the Master Transmitter mode, a number of data bytes are transmitted to a Slave Receiver (see Figure 22-11).
       In order to enter a Master mode, a START condition must be transmitted. The format of the following address
       packet determines whether Master Transmitter or Master Receiver mode is to be entered. If SLA+W is
       transmitted, MT mode is entered, if SLA+R is transmitted, MR mode is entered. All the status codes mentioned
       in this section assume that the prescaler bits are zero or are masked to zero.

       Figure 22-11. Data Transfer in Master Transmitter Mode
                                                                                                          VCC




                                            Device 1          Device 2
                                              MASTER           SLAVE         Device 3   ........   Device n     R1       R2
                                            TRANSMITTER       RECEIVER




                           SDA


                              SCL


       A START condition is sent by writing the following value to TWCR:
        TWCR           TWINT        TWEA            TWSTA            TWSTO         TWWC            TWEN              –        TWIE
        value             1             X                 1              0              X             1              0         X

       TWEN must be set to enable the 2-wire Serial Interface, TWSTA must be written to one to transmit a START
       condition and TWINT must be written to one to clear the TWINT Flag. The TWI will then test the 2-wire Serial
       Bus and generate a START condition as soon as the bus becomes free. After a START condition has been




        2020 Microchip Technology Inc.                                       Data Sheet Complete                                  DS40002061B-page 226
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

          transmitted, the TWINT Flag is set by hardware, and the status code in TWSR will be 0x08 (see Table 22-2). In
          order to enter MT mode, SLA+W must be transmitted. This is done by writing SLA+W to TWDR. Thereafter the
          TWINT bit should be cleared (by writing it to one) to continue the transfer. This is accomplished by writing the
          following value to TWCR:
            TWCR              TWINT          TWEA          TWSTA          TWSTO        TWWC            TWEN         –           TWIE
            value                 1              X             0             0              X           1            0             X

          When SLA+W have been transmitted and an acknowledgement bit has been received, TWINT is set again and
          a number of status codes in TWSR are possible. Possible status codes in Master mode are 0x18, 0x20, or 0x38.
          The appropriate action to be taken for each of these status codes is detailed in Table 22-2.
          When SLA+W has been successfully transmitted, a data packet should be transmitted. This is done by writing
          the data byte to TWDR. TWDR must only be written when TWINT is high. If not, the access will be discarded,
          and the Write Collision bit (TWWC) will be set in the TWCR Register. After updating TWDR, the TWINT bit
          should be cleared (by writing it to one) to continue the transfer. This is accomplished by writing the following
          value to TWCR:
            TWCR              TWINT          TWEA          TWSTA          TWSTO        TWWC            TWEN          –           TWIE
            value                 1              X             0             0              X           1            0              X

          This scheme is repeated until the last byte has been sent and the transfer is ended by generating a STOP
          condition or a repeated START condition. A STOP condition is generated by writing the following value to
          TWCR:
            TWCR              TWINT          TWEA          TWSTA          TWSTO        TWWC            TWEN          –           TWIE
            value                 1              X             0             1              X           1            0              X

          A REPEATED START condition is generated by writing the following value to TWCR:
            TWCR              TWINT          TWEA          TWSTA          TWSTO        TWWC            TWEN          –           TWIE
            value                 1              X             1             0              X           1            0              X

          After a repeated START condition (state 0x10) the 2-wire Serial Interface can access the same Slave again, or
          a new Slave without transmitting a STOP condition. Repeated START enables the Master to switch between
          Slaves, Master Transmitter mode and Master Receiver mode without losing control of the bus.


Table 22-2.         Status codes for Master Transmitter Mode
 Status Code                                                       Application Software Response
 (TWSR)             Status of the 2-wire Serial Bus   To/from TWDR                        To TWCR
 Prescaler Bits     and 2-wire Serial Interface
 are 0              Hardware                                                STA     STO         TWIN   TWE    Next Action Taken by TWI Hardware
                                                                                                 T      A
 0x08               A START condition has been        Load SLA+W             0        0          1      X     SLA+W will be transmitted;
                    transmitted                                                                               ACK or NOT ACK will be received
 0x10               A repeated START condition        Load SLA+W or          0        0          1      X     SLA+W will be transmitted;
                    has been transmitted                                                                      ACK or NOT ACK will be received
                                                      Load SLA+R             0        0          1      X     SLA+R will be transmitted;
                                                                                                              Logic will switch to Master Receiver mode
 0x18               SLA+W has been transmitted;       Load data byte or      0        0          1      X     Data byte will be transmitted and ACK or NOT ACK will
                    ACK has been received                                                                     be received
                                                      No TWDR action or      1        0          1      X     Repeated START will be transmitted
                                                      No TWDR action or      0        1          1      X     STOP condition will be transmitted and
                                                                                                              TWSTO Flag will be reset
                                                      No TWDR action         1        1          1      X     STOP condition followed by a START condition will be
                                                                                                              transmitted and TWSTO Flag will be reset
 0x20               SLA+W has been transmitted;       Load data byte or      0        0          1      X     Data byte will be transmitted and ACK or NOT ACK will
                    NOT ACK has been received                                                                 be received
                                                      No TWDR action or      1        0          1      X     Repeated START will be transmitted
                                                      No TWDR action or      0        1          1      X     STOP condition will be transmitted and
                                                                                                              TWSTO Flag will be reset
                                                      No TWDR action         1        1          1      X     STOP condition followed by a START condition will be
                                                                                                              transmitted and TWSTO Flag will be reset




            2020 Microchip Technology Inc.                                       Data Sheet Complete                                   DS40002061B-page 227
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Table 22-2.    Status codes for Master Transmitter Mode
 0x28          Data byte has been transmit-           Load data byte or              0         0             1           X        Data byte will be transmitted and ACK or NOT ACK will
               ted;                                                                                                               be received
               ACK has been received                  No TWDR action or              1         0             1           X        Repeated START will be transmitted
                                                      No TWDR action or              0         1             1           X        STOP condition will be transmitted and
                                                                                                                                  TWSTO Flag will be reset
                                                      No TWDR action                 1         1             1           X        STOP condition followed by a START condition will be
                                                                                                                                  transmitted and TWSTO Flag will be reset
 0x30          Data byte has been transmit-           Load data byte or              0         0             1           X        Data byte will be transmitted and ACK or NOT ACK will
               ted;                                                                                                               be received
               NOT ACK has been received              No TWDR action or              1         0             1           X        Repeated START will be transmitted
                                                      No TWDR action or              0         1             1           X        STOP condition will be transmitted and
                                                                                                                                  TWSTO Flag will be reset
                                                      No TWDR action                 1         1             1           X        STOP condition followed by a START condition will be
                                                                                                                                  transmitted and TWSTO Flag will be reset
 0x38          Arbitration lost in SLA+W or           No TWDR action or              0         0             1           X        2-wire Serial Bus will be released and not addressed
               data bytes                                                                                                         Slave mode entered
                                                      No TWDR action                 1         0             1           X        A START condition will be transmitted when the bus
                                                                                                                                  becomes free




        Figure 22-12. Formats and States in the Master Transmitter Mode
                                                                          MT




                       Successfull
                       transmission         S         SLA         W              A                   DATA                    A          P
                       to a slave
                       receiver

                                            $08                                 $18                                       $28


                       Next transfer
                       started with a                                                                                                   RS          SLA             W
                       repeated start
                       condition

                                                                                                                                      $10

                       Not acknowledge                                                                                                                              R
                       received after the                                        A             P
                       slave address


                                                                                $20
                                                                                                                                                                        MR
                       Not acknowledge
                       received after a data                                                                                 A          P
                       byte


                                                                                                                          $30

                       Arbitration lost in slave                                          Other master                               Other master
                       address or data byte                                    A or A      continues                     A or A       continues




                                                                                $38                                       $38

                       Arbitration lost and                                               Other master
                       addressed as slave                                        A         continues




                                                                                                                          To corresponding
                                                                                $68      $78       $B0                    states in slave mode




                                                                                                                 Any number of data bytes
                                        From master to slave                   DATA                      A       and their associated acknowledge bits


                                        From slave to master                                                     This number (contained in TWSR) corresponds
                                                                                           n                     to a defined state of the 2-Wire Serial Bus. The
                                                                                                                 prescaler bits are zero or masked to zero




          2020 Microchip Technology Inc.                                                Data Sheet Complete                                                   DS40002061B-page 228
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

22.7.2 Master Receiver Mode
      In the Master Receiver mode, a number of data bytes are received from a Slave Transmitter (Slave see Figure
      22-13). In order to enter a Master mode, a START condition must be transmitted. The format of the following
      address packet determines whether Master Transmitter or Master Receiver mode is to be entered. If SLA+W is
      transmitted, MT mode is entered, if SLA+R is transmitted, MR mode is entered. All the status codes mentioned
      in this section assume that the prescaler bits are zero or are masked to zero.

      Figure 22-13. Data Transfer in Master Receiver Mode
                                                                                                        VCC




                                          Device 1       Device 2
                                           MASTER           SLAVE          Device 3   ........   Device n     R1       R2
                                          RECEIVER       TRANSMITTER




                             SDA


                             SCL


      A START condition is sent by writing the following value to TWCR:
       TWCR           TWINT        TWEA          TWSTA           TWSTO           TWWC            TWEN          –            TWIE
       value             1           X               1                 0              X             1              0         X

      TWEN must be written to one to enable the 2-wire Serial Interface, TWSTA must be written to one to transmit a
      START condition and TWINT must be set to clear the TWINT Flag. The TWI will then test the 2-wire Serial Bus
      and generate a START condition as soon as the bus becomes free. After a START condition has been
      transmitted, the TWINT Flag is set by hardware, and the status code in TWSR will be 0x08 (See Table 22-2). In
      order to enter MR mode, SLA+R must be transmitted. This is done by writing SLA+R to TWDR. Thereafter the
      TWINT bit should be cleared (by writing it to one) to continue the transfer. This is accomplished by writing the
      following value to TWCR:
       TWCR           TWINT        TWEA          TWSTA           TWSTO           TWWC            TWEN          –            TWIE
       value             1           X               0                 0              X             1              0         X

      When SLA+R have been transmitted and an acknowledgement bit has been received, TWINT is set again and a
      number of status codes in TWSR are possible. Possible status codes in Master mode are 0x38, 0x40, or 0x48.
      The appropriate action to be taken for each of these status codes is detailed in Table 22-3. Received data can
      be read from the TWDR Register when the TWINT Flag is set high by hardware. This scheme is repeated until
      the last byte has been received. After the last byte has been received, the MR should inform the ST by sending
      a NACK after the last received data byte. The transfer is ended by generating a STOP condition or a repeated
      START condition. A STOP condition is generated by writing the following value to TWCR:
       TWCR           TWINT        TWEA          TWSTA           TWSTO           TWWC            TWEN          –            TWIE
       value             1           X               0                 1              X             1              0         X

      A REPEATED START condition is generated by writing the following value to TWCR:
       TWCR           TWINT        TWEA          TWSTA           TWSTO           TWWC            TWEN          –            TWIE
       value             1           X               1                 0              X             1              0         X

      After a repeated START condition (state 0x10) the 2-wire Serial Interface can access the same Slave again, or
      a new Slave without transmitting a STOP condition. Repeated START enables the Master to switch between
      Slaves, Master Transmitter mode and Master Receiver mode without losing control over the bus.



        2020 Microchip Technology Inc.                                     Data Sheet Complete                                  DS40002061B-page 229
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P


Table 22-3.       Status codes for Master Receiver Mode
 Status Code                                                     Application Software Response
 (TWSR)           Status of the 2-wire Serial Bus                                       To TWCR
 Prescaler Bits   and 2-wire Serial Interface       To/from TWDR
 are 0            Hardware                                                STA     STO       TWIN   TWE    Next Action Taken by TWI Hardware
                                                                                             T      A
 0x08             A START condition has been        Load SLA+R             0        0         1       X   SLA+R will be transmitted
                  transmitted                                                                             ACK or NOT ACK will be received
 0x10             A repeated START condition        Load SLA+R or          0        0         1       X   SLA+R will be transmitted
                  has been transmitted                                                                    ACK or NOT ACK will be received
                                                    Load SLA+W             0        0         1       X   SLA+W will be transmitted
                                                                                                          Logic will switch to Master Transmitter mode
 0x38             Arbitration lost in SLA+R or      No TWDR action or      0        0         1       X   2-wire Serial Bus will be released and not addressed
                  NOT ACK bit                                                                             Slave mode will be entered
                                                    No TWDR action         1        0         1       X   A START condition will be transmitted when the bus
                                                                                                          becomes free
 0x40             SLA+R has been transmitted;       No TWDR action or      0        0         1       0   Data byte will be received and NOT ACK will be
                  ACK has been received                                                                   returned
                                                    No TWDR action         0        0         1       1   Data byte will be received and ACK will be returned

 0x48             SLA+R has been transmitted;       No TWDR action or      1        0         1       X   Repeated START will be transmitted
                  NOT ACK has been received         No TWDR action or      0        1         1       X   STOP condition will be transmitted and TWSTO Flag
                                                                                                          will be reset
                                                    No TWDR action         1        1         1       X   STOP condition followed by a START condition will be
                                                                                                          transmitted and TWSTO Flag will be reset
 0x50             Data byte has been received;      Read data byte or      0        0         1       0   Data byte will be received and NOT ACK will be
                  ACK has been returned                                                                   returned
                                                    Read data byte         0        0         1       1   Data byte will be received and ACK will be returned
 0x58             Data byte has been received;      Read data byte or      1        0         1       X   Repeated START will be transmitted
                  NOT ACK has been returned         Read data byte or      0        1         1       X   STOP condition will be transmitted and TWSTO Flag
                                                                                                          will be reset
                                                    Read data byte         1        1         1       X   STOP condition followed by a START condition will be
                                                                                                          transmitted and TWSTO Flag will be reset




            2020 Microchip Technology Inc.                                     Data Sheet Complete                              DS40002061B-page 230
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 22-14. Formats and States in the Master Receiver Mode
                                                                 MR




                     Successfull
                     reception            S         SLA      R          A                  DATA              A         DATA           A          P
                     from a slave
                     receiver

                                       $08                             $40                                  $50                       $58


                     Next transfer
                     started with a                                                                                                              RS        SLA     R
                     repeated start
                     condition

                                                                                                                                                $10

                     Not acknowledge                                                                                                                               W
                     received after the                                 A            P
                     slave address


                                                                       $48
                                                                                                                                                                       MT
                     Arbitration lost in slave                                  Other master                           Other master
                     address or data byte                             A or A     continues                   A          continues




                                                                       $38                                  $38

                     Arbitration lost and                                       Other master
                     addressed as slave                                 A        continues




                                                                                                            To corresponding
                                                                       $68     $78       $B0                states in slave mode




                                                                                                   Any number of data bytes
                                      From master to slave            DATA                     A   and their associated acknowledge bits


                                      From slave to master                                         This number (contained in TWSR) corresponds
                                                                                 n                 to a defined state of the 2-Wire Serial Bus. The
                                                                                                   prescaler bits are zero or masked to zero




22.7.3 Slave Receiver Mode
      In the Slave Receiver mode, a number of data bytes are received from a Master Transmitter (see Figure 22-15).
      All the status codes mentioned in this section assume that the prescaler bits are zero or are masked to zero.

      Figure 22-15. Data transfer in Slave Receiver mode

                                                                                                                                          VCC




                                            Device 1         Device 2
                                               SLAVE           MASTER                    Device 3          ........          Device n                 R1          R2
                                              RECEIVER       TRANSMITTER




                  SDA


                  SCL




        2020 Microchip Technology Inc.                                                    Data Sheet Complete                                                   DS40002061B-page 231
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

To initiate the Slave Receiver mode, TWAR and TWCR must be initialized as follows:
 TWAR              TWA6        TWA5      TWA4        TWA3          TWA2       TWA1    TWA0      TWGCE
 value                                      Device’s Own Slave Address

The upper 7 bits are the address to which the 2-wire Serial Interface will respond when addressed by a Master.
If the LSB is set, the TWI will respond to the general call address (0x00), otherwise it will ignore the general call
address.
 TWCR              TWINT       TWEA     TWSTA       TWSTO         TWWC        TWEN      –        TWIE
 value                0            1        0           0            0            1     0          X

TWEN must be written to one to enable the TWI. The TWEA bit must be written to one to enable the
acknowledgement of the device’s own slave address or the general call address. TWSTA and TWSTO must be
written to zero.
When TWAR and TWCR have been initialized, the TWI waits until it is addressed by its own slave address (or
the general call address if enabled) followed by the data direction bit. If the direction bit is “0” (write), the TWI will
operate in SR mode, otherwise ST mode is entered. After its own slave address and the write bit have been
received, the TWINT Flag is set and a valid status code can be read from TWSR. The status code is used to
determine the appropriate software action. The appropriate action to be taken for each status code is detailed in
Table 22-4. The Slave Receiver mode may also be entered if arbitration is lost while the TWI is in the Master
mode (see states 0x68 and 0x78).
If the TWEA bit is reset during a transfer, the TWI will return a “Not Acknowledge” (“1”) to SDA after the next
received data byte. This can be used to indicate that the Slave is not able to receive any more bytes. While
TWEA is zero, the TWI does not acknowledge its own slave address. However, the 2-wire Serial Bus is still
monitored and address recognition may resume at any time by setting TWEA. This implies that the TWEA bit
may be used to temporarily isolate the TWI from the 2-wire Serial Bus.
In all sleep modes other than Idle mode, the clock system to the TWI is turned off. If the TWEA bit is set, the
interface can still acknowledge its own slave address or the general call address by using the 2-wire Serial Bus
clock as a clock source. The part will then wake up from sleep and the TWI will hold the SCL clock low during
the wake up and until the TWINT Flag is cleared (by writing it to one). Further data reception will be carried out
as normal, with the AVR clocks running as normal. Observe that if the AVR is set up with a long start-up time,
the SCL line may be held low for a long time, blocking other data transmissions.
Note that the 2-wire Serial Interface Data Register – TWDR does not reflect the last byte present on the bus
when waking up from these Sleep modes.




 2020 Microchip Technology Inc.                            Data Sheet Complete                     DS40002061B-page 232
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P


Table 22-4.       Status Codes for Slave Receiver Mode
 Status Code                                                      Application Software Response
 (TWSR)           Status of the 2-wire Serial Bus                                        To TWCR
 Prescaler Bits   and 2-wire Serial Interface Hard-   To/from TWDR
 are 0            ware                                                     STA      STO      TWIN     TWE   Next Action Taken by TWI Hardware
                                                                                              T        A
 0x60             Own SLA+W has been received;        No TWDR action or     X        0         1       0    Data byte will be received and NOT ACK will be
                  ACK has been returned                                                                     returned
                                                      No TWDR action        X        0         1       1    Data byte will be received and ACK will be returned
 0x68             Arbitration lost in SLA+R/W as      No TWDR action or     X        0         1       0    Data byte will be received and NOT ACK will be
                  Master; own SLA+W has been                                                                returned
                  received; ACK has been returned     No TWDR action        X        0         1       1    Data byte will be received and ACK will be returned
 0x70             General call address has been       No TWDR action or     X        0         1       0    Data byte will be received and NOT ACK will be
                  received; ACK has been returned                                                           returned
                                                      No TWDR action        X        0         1       1    Data byte will be received and ACK will be returned
 0x78             Arbitration lost in SLA+R/W as      No TWDR action or     X        0         1       0    Data byte will be received and NOT ACK will be
                  Master; General call address has                                                          returned
                  been received; ACK has been         No TWDR action        X        0         1       1    Data byte will be received and ACK will be returned
                  returned
 0x80             Previously addressed with own       Read data byte or     X        0         1       0    Data byte will be received and NOT ACK will be
                  SLA+W; data has been received;                                                            returned
                  ACK has been returned               Read data byte        X        0         1       1    Data byte will be received and ACK will be returned
 0x88             Previously addressed with own       Read data byte or     0        0         1       0    Switched to the not addressed Slave mode;
                  SLA+W; data has been received;                                                            no recognition of own SLA or GCA
                  NOT ACK has been returned           Read data byte or     0        0         1       1    Switched to the not addressed Slave mode;
                                                                                                            own SLA will be recognized;
                                                                                                            GCA will be recognized if TWGCE = “1”
                                                      Read data byte or     1        0         1       0    Switched to the not addressed Slave mode;
                                                                                                            no recognition of own SLA or GCA;
                                                                                                            a START condition will be transmitted when the bus
                                                                                                            becomes free
                                                      Read data byte        1        0         1       1    Switched to the not addressed Slave mode;
                                                                                                            own SLA will be recognized;
                                                                                                            GCA will be recognized if TWGCE = “1”;
                                                                                                            a START condition will be transmitted when the bus
                                                                                                            becomes free
 0x90             Previously addressed with           Read data byte or     X        0         1       0    Data byte will be received and NOT ACK will be
                  general call; data has been re-                                                           returned
                  ceived; ACK has been returned       Read data byte        X        0         1       1    Data byte will be received and ACK will be returned
 0x98             Previously addressed with           Read data byte or     0        0         1       0    Switched to the not addressed Slave mode;
                  general call; data has been                                                               no recognition of own SLA or GCA
                  received; NOT ACK has been          Read data byte or     0        0         1       1    Switched to the not addressed Slave mode;
                  returned                                                                                  own SLA will be recognized;
                                                                                                            GCA will be recognized if TWGCE = “1”
                                                      Read data byte or     1        0         1       0    Switched to the not addressed Slave mode;
                                                                                                            no recognition of own SLA or GCA;
                                                                                                            a START condition will be transmitted when the bus
                                                                                                            becomes free
                                                      Read data byte        1        0         1       1    Switched to the not addressed Slave mode;
                                                                                                            own SLA will be recognized;
                                                                                                            GCA will be recognized if TWGCE = “1”;
                                                                                                            a START condition will be transmitted when the bus
                                                                                                            becomes free
 0xA0             A STOP condition or repeated        No action             0        0         1       0    Switched to the not addressed Slave mode;
                  START condition has been                                                                  no recognition of own SLA or GCA
                  received while still addressed as                         0        0         1       1    Switched to the not addressed Slave mode;
                  Slave                                                                                     own SLA will be recognized;
                                                                                                            GCA will be recognized if TWGCE = “1”
                                                                            1        0         1       0    Switched to the not addressed Slave mode;
                                                                                                            no recognition of own SLA or GCA;
                                                                                                            a START condition will be transmitted when the bus
                                                                                                            becomes free
                                                                            1        0         1       1    Switched to the not addressed Slave mode;
                                                                                                            own SLA will be recognized;
                                                                                                            GCA will be recognized if TWGCE = “1”;
                                                                                                            a START condition will be transmitted when the bus
                                                                                                            becomes free




            2020 Microchip Technology Inc.                                     Data Sheet Complete                               DS40002061B-page 233
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 22-16. Formats and States in the Slave Receiver Mode
                      Reception of the own
                      slave address and one or        S      SLA        W          A           DATA                A         DATA          A        P or S
                      more data bytes. All are
                      acknowledged

                                                                                   $60                            $80                     $80        $A0

                      Last data byte received
                      is not acknowledged                                                                                                  A        P or S



                                                                                                                                          $88

                      Arbitration lost as master
                      and addressed as slave                                       A



                                                                                   $68


                      Reception of the general call
                      address and one or more data           General Call          A           DATA                A         DATA          A        P or S
                      bytes


                                                                                   $70                            $90                     $90        $A0


                      Last data byte received is
                      not acknowledged                                                                                                     A        P or S



                                                                                                                                          $98

                      Arbitration lost as master and
                      addressed as slave by general call                           A



                                                                                   $78




                                                                                                 Any number of data bytes
                                      From master to slave                  DATA           A     and their associated acknowledge bits


                                      From slave to master                                       This number (contained in TWSR) corresponds
                                                                                       n         to a defined state of the 2-Wire Serial Bus. The
                                                                                                 prescaler bits are zero or masked to zero




22.7.4 Slave Transmitter Mode
       In the Slave Transmitter mode, a number of data bytes are transmitted to a Master Receiver (see Figure 22-17).
       All the status codes mentioned in this section assume that the prescaler bits are zero or are masked to zero.

       Figure 22-17. Data Transfer in Slave Transmitter Mode
                                                                                                                        VCC




                                                Device 1      Device 2
                                               SLAVE           MASTER              Device 3    ........      Device n                 R1             R2
                                            TRANSMITTER       RECEIVER




                       SDA


                       SCL




        2020 Microchip Technology Inc.                                             Data Sheet Complete                                                 DS40002061B-page 234
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

To initiate the Slave Transmitter mode, TWAR and TWCR must be initialized as follows:
 TWAR              TWA6        TWA5      TWA4        TWA3          TWA2       TWA1    TWA0     TWGCE
 value                                      Device’s Own Slave Address

The upper seven bits are the address to which the 2-wire Serial Interface will respond when addressed by a
Master. If the LSB is set, the TWI will respond to the general call address (0x00), otherwise it will ignore the
general call address.
 TWCR              TWINT       TWEA     TWSTA       TWSTO         TWWC        TWEN     –        TWIE
 value                0            1       0            0            0            1    0          X

TWEN must be written to one to enable the TWI. The TWEA bit must be written to one to enable the
acknowledgement of the device’s own slave address or the general call address. TWSTA and TWSTO must be
written to zero.
When TWAR and TWCR have been initialized, the TWI waits until it is addressed by its own slave address (or
the general call address if enabled) followed by the data direction bit. If the direction bit is “1” (read), the TWI will
operate in ST mode, otherwise SR mode is entered. After its own slave address and the write bit have been
received, the TWINT Flag is set and a valid status code can be read from TWSR. The status code is used to
determine the appropriate software action. The appropriate action to be taken for each status code is detailed in
Table 22-5. The Slave Transmitter mode may also be entered if arbitration is lost while the TWI is in the Master
mode (see state 0xB0).
If the TWEA bit is written to zero during a transfer, the TWI will transmit the last byte of the transfer. State 0xC0
or state 0xC8 will be entered, depending on whether the Master Receiver transmits a NACK or ACK after the
final byte. The TWI is switched to the not addressed Slave mode, and will ignore the Master if it continues the
transfer. Thus the Master Receiver receives all “1” as serial data. State 0xC8 is entered if the Master demands
additional data bytes (by transmitting ACK), even though the Slave has transmitted the last byte (TWEA zero
and expecting NACK from the Master).
While TWEA is zero, the TWI does not respond to its own slave address. However, the 2-wire Serial Bus is still
monitored and address recognition may resume at any time by setting TWEA. This implies that the TWEA bit
may be used to temporarily isolate the TWI from the 2-wire Serial Bus.
In all sleep modes other than Idle mode, the clock system to the TWI is turned off. If the TWEA bit is set, the
interface can still acknowledge its own slave address or the general call address by using the 2-wire Serial Bus
clock as a clock source. The part will then wake up from sleep and the TWI will hold the SCL clock will low
during the wake up and until the TWINT Flag is cleared (by writing it to one). Further data transmission will be
carried out as normal, with the AVR clocks running as normal. Observe that if the AVR is set up with a long start-
up time, the SCL line may be held low for a long time, blocking other data transmissions.
Note that the 2-wire Serial Interface Data Register – TWDR does not reflect the last byte present on the bus
when waking up from these sleep modes.




 2020 Microchip Technology Inc.                            Data Sheet Complete                       DS40002061B-page 235
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P


Table 22-5.     Status Codes for Slave Transmitter Mode
 Status Code                                                             Application Software Response
 (TWSR)        Status of the 2-wire Serial Bus                                                          To TWCR
 Prescaler     and 2-wire Serial Interface Hard-            To/from TWDR
 Bits          ware                                                                 STA            STO      TWIN          TWE          Next Action Taken by TWI Hardware
 are 0                                                                                                       T             A
 0xA8          Own SLA+R has been received;                 Load data byte or          X            0            1           0         Last data byte will be transmitted and NOT ACK should
               ACK has been returned                                                                                                   be received
                                                            Load data byte             X            0            1           1         Data byte will be transmitted and ACK should be re-
                                                                                                                                       ceived
 0xB0          Arbitration lost in SLA+R/W as               Load data byte or          X            0            1           0         Last data byte will be transmitted and NOT ACK should
               Master; own SLA+R has been                                                                                              be received
               received; ACK has been returned              Load data byte             X            0            1           1         Data byte will be transmitted and ACK should be re-
                                                                                                                                       ceived
 0xB8          Data byte in TWDR has been                   Load data byte or          X            0            1           0         Last data byte will be transmitted and NOT ACK should
               transmitted; ACK has been                                                                                               be received
               received                                     Load data byte             X            0            1           1         Data byte will be transmitted and ACK should be re-
                                                                                                                                       ceived
 0xC0          Data byte in TWDR has been                   No TWDR action or          0            0            1           0         Switched to the not addressed Slave mode;
               transmitted; NOT ACK has been                                                                                           no recognition of own SLA or GCA
               received                                     No TWDR action or          0            0            1           1         Switched to the not addressed Slave mode;
                                                                                                                                       own SLA will be recognized;
                                                                                                                                       GCA will be recognized if TWGCE = “1”
                                                            No TWDR action or          1            0            1           0         Switched to the not addressed Slave mode;
                                                                                                                                       no recognition of own SLA or GCA;
                                                                                                                                       a START condition will be transmitted when the bus
                                                                                                                                       becomes free
                                                            No TWDR action             1            0            1           1         Switched to the not addressed Slave mode;
                                                                                                                                       own SLA will be recognized;
                                                                                                                                       GCA will be recognized if TWGCE = “1”;
                                                                                                                                       a START condition will be transmitted when the bus
                                                                                                                                       becomes free
 0xC8          Last data byte in TWDR has been              No TWDR action or          0            0            1           0         Switched to the not addressed Slave mode;
               transmitted (TWEA = “0”); ACK                                                                                           no recognition of own SLA or GCA
               has been received                            No TWDR action or          0            0            1           1         Switched to the not addressed Slave mode;
                                                                                                                                       own SLA will be recognized;
                                                                                                                                       GCA will be recognized if TWGCE = “1”
                                                            No TWDR action or          1            0            1           0         Switched to the not addressed Slave mode;
                                                                                                                                       no recognition of own SLA or GCA;
                                                                                                                                       a START condition will be transmitted when the bus
                                                                                                                                       becomes free
                                                            No TWDR action             1            0            1           1         Switched to the not addressed Slave mode;
                                                                                                                                       own SLA will be recognized;
                                                                                                                                       GCA will be recognized if TWGCE = “1”;
                                                                                                                                       a START condition will be transmitted when the bus
                                                                                                                                       becomes free




         Figure 22-18. Formats and States in the Slave Transmitter Mode
                         Reception of the own
                         slave address and one or       S         SLA           R          A              DATA                A         DATA          A        P or S
                         more data bytes


                                                                                       $A8                                   $B8                     $C0


                         Arbitration lost as master
                         and addressed as slave                                            A



                                                                                       $B0


                         Last data byte transmitted.
                         Switched to not addressed                                                                                                    A        All 1's     P or S
                         slave (TWEA = '0')


                                                                                                                                                     $C8




                                                                                                            Any number of data bytes
                                         From master to slave                   DATA                A       and their associated acknowledge bits


                                         From slave to master                                               This number (contained in TWSR) corresponds
                                                                                               n            to a defined state of the 2-Wire Serial Bus. The
                                                                                                            prescaler bits are zero or masked to zero




           2020 Microchip Technology Inc.                                                     Data Sheet Complete                                                       DS40002061B-page 236
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

22.7.5 Miscellaneous States
          There are two status codes that do not correspond to a defined TWI state, see Table 22-6.
          Status 0xF8 indicates that no relevant information is available because the TWINT Flag is not set. This occurs
          between other states, and when the TWI is not involved in a serial transfer.
          Status 0x00 indicates that a bus error has occurred during a 2-wire Serial Bus transfer. A bus error occurs when
          a START or STOP condition occurs at an illegal position in the format frame. Examples of such illegal positions
          are during the serial transfer of an address byte, a data byte, or an acknowledge bit. When a bus error occurs,
          TWINT is set. To recover from a bus error, the TWSTO Flag must set and TWINT must be cleared by writing a
          logic one to it. This causes the TWI to enter the not addressed Slave mode and to clear the TWSTO Flag (no
          other bits in TWCR are affected). The SDA and SCL lines are released, and no STOP condition is transmitted.

Table 22-6.       Miscellaneous States
 Status Code                                                   Application Software Response
 (TWSR)           Status of the 2-wire Serial Bus                                       To TWCR
 Prescaler Bits   and 2-wire Serial Interface       To/from TWDR
 are 0            Hardware                                               STA       STO      TWIN     TWE     Next Action Taken by TWI Hardware
                                                                                             T        A
 0xF8             No relevant state information     No TWDR action                 No TWCR action            Wait or proceed current transfer
                  available; TWINT = “0”
 0x00             Bus error due to an illegal       No TWDR action        0         1         1        X     Only the internal hardware is affected, no STOP condi-
                  START or STOP condition                                                                    tion is sent on the bus. In all cases, the bus is released
                                                                                                             and TWSTO is cleared.


22.7.6 Combining Several TWI Modes
          In some cases, several TWI modes must be combined in order to complete the desired action. Consider for
          example reading data from a serial EEPROM. Typically, such a transfer involves the following steps:
          1. The transfer must be initiated.
             2.   The EEPROM must be instructed what location should be read.
             3.   The reading must be performed.
             4.   The transfer must be finished.
          Note that data is transmitted both from Master to Slave and vice versa. The Master must instruct the Slave what
          location it wants to read, requiring the use of the MT mode. Subsequently, data must be read from the Slave,
          implying the use of the MR mode. Thus, the transfer direction must be changed. The Master must keep control
          of the bus during all these steps, and the steps should be carried out as an atomical operation. If this principle is
          violated in a multi master system, another Master can alter the data pointer in the EEPROM between steps 2
          and 3, and the Master will read the wrong data location. Such a change in transfer direction is accomplished by
          transmitting a REPEATED START between the transmission of the address byte and reception of the data.
          After a REPEATED START, the Master keeps ownership of the bus. The following figure shows the flow in this
          transfer.

          Figure 22-19. Combining Several TWI Modes to Access a Serial EEPROM
                                                          Master Transmitter                                      Master Receiver



                             S         SLA+W          A      ADDRESS           A    Rs         SLA+R         A          DATA            A    P


                              S = START                                            Rs = REPEATED START                            P = STOP

                                      Transmitted from master to slave               Transmitted from slave to master




            2020 Microchip Technology Inc.                                    Data Sheet Complete                                    DS40002061B-page 237
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

22.8   Multi-master Systems and Arbitration
       If multiple masters are connected to the same bus, transmissions may be initiated simultaneously by one or
       more of them. The TWI standard ensures that such situations are handled in such a way that one of the masters
       will be allowed to proceed with the transfer, and that no data will be lost in the process. An example of an
       arbitration situation is depicted below, where two masters are trying to transmit data to a Slave Receiver.

       Figure 22-20. An Arbitration Example
                                                                                                 VCC




                                          Device 1       Device 2     Device 3
                                            MASTER        MASTER       SLAVE     ........   Device n   R1   R2
                                          TRANSMITTER   TRANSMITTER   RECEIVER




                             SDA


                             SCL


       Several different scenarios may arise during arbitration, as described below:
            Two or more masters are performing identical communication with the same Slave. In this case, neither
             the Slave nor any of the masters will know about the bus contention.
            Two or more masters are accessing the same Slave with different data or direction bit. In this case,
             arbitration will occur, either in the READ/WRITE bit or in the data bits. The masters trying to output a one
             on SDA while another Master outputs a zero will lose the arbitration. Losing masters will switch to not
             addressed Slave mode or wait until the bus is free and transmit a new START condition, depending on
             application software action.
            Two or more masters are accessing different slaves. In this case, arbitration will occur in the SLA bits.
             Masters trying to output a one on SDA while another Master outputs a zero will lose the arbitration.
             Masters losing arbitration in SLA will switch to Slave mode to check if they are being addressed by the
             winning Master. If addressed, they will switch to SR or ST mode, depending on the value of the
             READ/WRITE bit. If they are not being addressed, they will switch to not addressed Slave mode or wait
             until the bus is free and transmit a new START condition, depending on application software action.
       This is summarized in Figure 22-21. Possible status values are given in circles.




        2020 Microchip Technology Inc.                               Data Sheet Complete                        DS40002061B-page 238
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 22-21. Possible Status Codes Caused by Arbitration

                        START                             SLA                                           Data                                         STOP



                                                    Arbitration lost in SLA            Arbitration lost in Data



                                              Own                   No            38       TWI bus will be released and not addressed slave mode will be entered
                                      Address / General Call
                                                                                           A START condition will be transmitted when the bus becomes free
                                            received



                                                   Yes


                                              Direction
                                                            Write                68/78     Data byte will be received and NOT ACK will be returned
                                                                                           Data byte will be received and ACK will be returned


                                                            Read                           Last data byte will be transmitted and NOT ACK should be received
                                                                                   B0      Data byte will be transmitted and ACK should be received




22.9   Register Description

22.9.1 TWBR – TWI Bit Rate Register

        Bit                7              6                     5          4               3                  2                  1                    0
        (0xB8)          TWBR7       TWBR6                 TWBR5          TWBR4         TWBR3            TWBR2               TWBR1              TWBR0               TWBR
        Read/Write        R/W         R/W                   R/W           R/W             R/W               R/W                R/W                   R/W
        Initial Value      0              0                     0          0               0                  0                  0                    0


       • Bits 7...0 – TWI Bit Rate Register
       TWBR selects the division factor for the bit rate generator. The bit rate generator is a frequency divider which
       generates the SCL clock frequency in the Master modes. See ”Bit Rate Generator Unit” on page 221 for
       calculating bit rates.

22.9.2 TWCR – TWI Control Register

        Bit                7              6                     5          4               3                  2                  1                    0
        (0xBC)          TWINT       TWEA                  TWSTA          TWSTO         TWWC              TWEN                    –              TWIE               TWCR
        Read/Write        R/W         R/W                   R/W           R/W              R                R/W                  R                   R/W
        Initial Value      0              0                     0          0               0                  0                  0                    0

       The TWCR is used to control the operation of the TWI. It is used to enable the TWI, to initiate a Master access
       by applying a START condition to the bus, to generate a Receiver acknowledge, to generate a stop condition,
       and to control halting of the bus while the data to be written to the bus are written to the TWDR. It also indicates
       a write collision if data is attempted written to TWDR while the register is inaccessible.

       • Bit 7 – TWINT: TWI Interrupt Flag
       This bit is set by hardware when the TWI has finished its current job and expects application software response.
       If the I-bit in SREG and TWIE in TWCR are set, the MCU will jump to the TWI Interrupt Vector. While the TWINT
       Flag is set, the SCL low period is stretched. The TWINT Flag must be cleared by software by writing a logic one
       to it. Note that this flag is not automatically cleared by hardware when executing the interrupt routine. Also note
       that clearing this flag starts the operation of the TWI, so all accesses to the TWI Address Register (TWAR), TWI
       Status Register (TWSR), and TWI Data Register (TWDR) must be complete before clearing this flag.




        2020 Microchip Technology Inc.                                         Data Sheet Complete                                                   DS40002061B-page 239
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

      • Bit 6 – TWEA: TWI Enable Acknowledge Bit
      The TWEA bit controls the generation of the acknowledge pulse. If the TWEA bit is written to one, the ACK
      pulse is generated on the TWI bus if the following conditions are met:
        1.      The device’s own slave address has been received.
        2.      A general call has been received, while the TWGCE bit in the TWAR is set.
        3.      A data byte has been received in Master Receiver or Slave Receiver mode.
      By writing the TWEA bit to zero, the device can be virtually disconnected from the 2-wire Serial Bus temporarily.
      Address recognition can then be resumed by writing the TWEA bit to one again.
      • Bit 5 – TWSTA: TWI START Condition Bit
      The application writes the TWSTA bit to one when it desires to become a Master on the 2-wire Serial Bus. The
      TWI hardware checks if the bus is available, and generates a START condition on the bus if it is free. However,
      if the bus is not free, the TWI waits until a STOP condition is detected, and then generates a new START
      condition to claim the bus Master status. TWSTA must be cleared by software when the START condition has
      been transmitted.

      • Bit 4 – TWSTO: TWI STOP Condition Bit
      Writing the TWSTO bit to one in Master mode will generate a STOP condition on the 2-wire Serial Bus. When
      the STOP condition is executed on the bus, the TWSTO bit is cleared automatically. In Slave mode, setting the
      TWSTO bit can be used to recover from an error condition. This will not generate a STOP condition, but the TWI
      returns to a well-defined unaddressed Slave mode and releases the SCL and SDA lines to a high impedance
      state.

      • Bit 3 – TWWC: TWI Write Collision Flag
      The TWWC bit is set when attempting to write to the TWI Data Register – TWDR when TWINT is low. This flag
      is cleared by writing the TWDR Register when TWINT is high.

      • Bit 2 – TWEN: TWI Enable Bit
      The TWEN bit enables TWI operation and activates the TWI interface. When TWEN is written to one, the TWI
      takes control over the I/O pins connected to the SCL and SDA pins, enabling the slew-rate limiters and spike
      filters. If this bit is written to zero, the TWI is switched off and all TWI transmissions are terminated, regardless of
      any ongoing operation.

      • Bit 1 – Reserved
      This bit is a reserved bit and will always read as zero.

      • Bit 0 – TWIE: TWI Interrupt Enable
      When this bit is written to one, and the I-bit in SREG is set, the TWI interrupt request will be activated for as long
      as the TWINT Flag is high.

22.9.3 TWSR – TWI Status Register

       Bit                 7              6    5          4           3             2       1          0
       (0xB9)            TWS7       TWS6      TWS5      TWS4        TWS3            –   TWPS1       TWPS0        TWSR
       Read/Write          R              R    R          R           R             R      R/W        R/W
       Initial Value       1              1    1          1           1             0       0          0


      • Bits 7:3 – TWS: TWI Status
      These 5 bits reflect the status of the TWI logic and the 2-wire Serial Bus. The different status codes are
      described later in this section. Note that the value read from TWSR contains both the 5-bit status value and the




        2020 Microchip Technology Inc.                       Data Sheet Complete                          DS40002061B-page 240
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

       2-bit prescaler value. The application designer should mask the prescaler bits to zero when checking the Status
       bits. This makes status checking independent of prescaler setting. This approach is used in this datasheet,
       unless otherwise noted.

       • Bit 2 – Reserved
       This bit is reserved and will always read as zero.

       • Bits 1:0 – TWPS: TWI Prescaler Bits
       These bits can be read and written, and control the bit rate prescaler.

       Table 22-7.      TWI Bit Rate Prescaler
        TWPS1                        TWPS0                           Prescaler Value
        0                            0                               1
        0                            1                               4
        1                            0                               16
        1                            1                               64

       To calculate bit rates, see ”Bit Rate Generator Unit” on page 221. The value of TWPS1...0 is used in the
       equation.

22.9.4 TWDR – TWI Data Register

        Bit                7         6         5          4              3          2           1         0
        (0xBB)          TWD7      TWD6        TWD5       TWD4        TWD3         TWD2     TWD1       TWD0     TWDR
        Read/Write        R/W       R/W       R/W        R/W          R/W          R/W         R/W     R/W
        Initial Value      1         1         1          1              1          1           1         1

       In Transmit mode, TWDR contains the next byte to be transmitted. In Receive mode, the TWDR contains the
       last byte received. It is writable while the TWI is not in the process of shifting a byte. This occurs when the TWI
       Interrupt Flag (TWINT) is set by hardware. Note that the Data Register cannot be initialized by the user before
       the first interrupt occurs. The data in TWDR remains stable as long as TWINT is set. While data is shifted out,
       data on the bus is simultaneously shifted in. TWDR always contains the last byte present on the bus, except
       after a wake up from a sleep mode by the TWI interrupt. In this case, the contents of TWDR is undefined. In the
       case of a lost bus arbitration, no data is lost in the transition from Master to Slave. Handling of the ACK bit is
       controlled automatically by the TWI logic, the CPU cannot access the ACK bit directly.

       • Bits 7:0 – TWD: TWI Data Register
       These eight bits constitute the next data byte to be transmitted, or the latest data byte received on the 2-wire
       Serial Bus.

22.9.5 TWAR – TWI (Slave) Address Register

        Bit                 7             6         5           4             3            2          1         0
        (0xBA)           TWA6       TWA5         TWA4         TWA3           TWA2        TWA1        TWA0     TWGCE       TWAR
        Read/Write        R/W         R/W          R/W         R/W           R/W         R/W         R/W       R/W
        Initial Value       1             1         1           1             1            1          1         0

       The TWAR should be loaded with the 7-bit Slave address (in the seven most significant bits of TWAR) to which
       the TWI will respond when programmed as a Slave Transmitter or Receiver, and not needed in the Master
       modes. In multi master systems, TWAR must be set in masters which can be addressed as Slaves by other
       Masters.




        2020 Microchip Technology Inc.                              Data Sheet Complete                             DS40002061B-page 241
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

      The LSB of TWAR is used to enable recognition of the general call address (0x00). There is an associated
      address comparator that looks for the slave address (or general call address if enabled) in the received serial
      address. If a match is found, an interrupt request is generated.

      • Bits 7:1 – TWA: TWI (Slave) Address Register
      These seven bits constitute the slave address of the TWI unit.

      • Bit 0 – TWGCE: TWI General Call Recognition Enable Bit
      If set, this bit enables the recognition of a General Call given over the 2-wire Serial Bus.

22.9.6 TWAMR – TWI (Slave) Address Mask Register

       Bit                7              6     5         4          3         2         1    0
       (0xBD)                                       TWAM[6:0]                                –   TWAMR
       Read/Write        R/W            R/W   R/W       R/W       R/W        R/W       R/W   R
       Initial Value      0              0     0         0          0         0         0    0


      • Bits 7:1 – TWAM: TWI Address Mask
      The TWAMR can be loaded with a 7-bit Salve Address mask. Each of the bits in TWAMR can mask (disable)
      the corresponding address bits in the TWI Address Register (TWAR). If the mask bit is set to one then the
      address match logic ignores the compare between the incoming address bit and the corresponding bit in TWAR.
      Figure 22-22 shown the address match logic in detail.

      Figure 22-22. TWI Address Match Logic, Block Diagram


                              TWAR0
                                                                                                 Address
                              Address                                                             Match
                               Bit 0


                           TWAMR0
                                                       Address Bit Comparator 0


                                               Address Bit Comparator 6..1


      • Bit 0 – Reserved
      This bit is an unused bit in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.




        2020 Microchip Technology Inc.                          Data Sheet Complete                 DS40002061B-page 242
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P


23.    Analog Comparator

23.1   Overview
       The Analog Comparator compares the input values on the positive pin AIN0 and negative pin AIN1. When the
       voltage on the positive pin AIN0 is higher than the voltage on the negative pin AIN1, the Analog Comparator
       output, ACO, is set. The comparator’s output can be set to trigger the Timer/Counter1 Input Capture function. In
       addition, the comparator can trigger a separate interrupt, exclusive to the Analog Comparator. The user can
       select Interrupt triggering on comparator output rise, fall or toggle. A block diagram of the comparator and its
       surrounding logic is shown in Figure 23-1.
       The Power Reduction ADC bit, PRADC, in ”Minimizing Power Consumption” on page 51 must be disabled by
       writing a logical zero to be able to use the ADC input MUX.

       Figure 23-1.       Analog Comparator Block Diagram(2)
                               BANDGAP
                              REFERENCE

                                          ACBG




                              ACME
                              ADEN


                           ADC MULTIPLEXER
                               OUTPUT (1)




       Notes:       1. See Table 23-1 on page 243.
                    2. Refer to Figure 1-1 on page 12 and Table 14-9 on page 97 for Analog Comparator pin placement.


23.2   Analog Comparator Multiplexed Input
       It is possible to select any of the ADC7...0 pins to replace the negative input to the Analog Comparator. The
       ADC multiplexer is used to select this input, and consequently, the ADC must be switched off to utilize this
       feature. If the Analog Comparator Multiplexer Enable bit (ACME in ADCSRB) is set and the ADC is switched off
       (ADEN in ADCSRA is zero), MUX2...0 in ADMUX select the input pin to replace the negative input to the Analog
       Comparator, as shown in Table 23-1. If ACME is cleared or ADEN is set, AIN1 is applied to the negative input to
       the Analog Comparator.

       Table 23-1.        Analog Comparator Multiplexed Input
          ACME              ADEN             MUX2...0    Analog Comparator Negative Input
                0              x                 xxx     AIN1
                1              1                 xxx     AIN1
                1              0                 000     ADC0
                1              0                 001     ADC1
                1              0                 010     ADC2
                1              0                 011     ADC3




        2020 Microchip Technology Inc.                          Data Sheet Complete                       DS40002061B-page 243
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 23-1.      Analog Comparator Multiplexed Input (Continued)
              ACME        ADEN            MUX2...0      Analog Comparator Negative Input
                 1             0            100         ADC4
                 1             0            101         ADC5
                 1             0            110         ADC6
                 1             0            111         ADC7


23.3   Register Description

23.3.1 ADCSRB – ADC Control and Status Register B
        Bit                7         6            5      4        3        2           1       0
        (0x7B)             –       ACME           –      –        –      ADTS2       ADTS1   ADTS0   ADCSRB
        Read/Write         R        R/W           R      R       R        R/W         R/W     R/W
        Initial Value      0         0            0      0        0        0           0       0


       • Bit 6 – ACME: Analog Comparator Multiplexer Enable
       When this bit is written logic one and the ADC is switched off (ADEN in ADCSRA is zero), the ADC multiplexer
       selects the negative input to the Analog Comparator. When this bit is written logic zero, AIN1 is applied to the
       negative input of the Analog Comparator. For a detailed description of this bit, see ”Analog Comparator
       Multiplexed Input” on page 243.

23.3.2 ACSR – Analog Comparator Control and Status Register
        Bit                7         6            5      4       3         2           1       0
        0x30 (0x50)      ACD       ACBG      ACO        ACI     ACIE     ACIC        ACIS1   ACIS0   ACSR
        Read/Write        R/W       R/W           R     R/W     R/W       R/W         R/W     R/W
        Initial Value      0         0        N/A        0       0         0           0       0


       • Bit 7 – ACD: Analog Comparator Disable
       When this bit is written logic one, the power to the Analog Comparator is switched off. This bit can be set at any
       time to turn off the Analog Comparator. This will reduce power consumption in Active and Idle mode. When
       changing the ACD bit, the Analog Comparator Interrupt must be disabled by clearing the ACIE bit in ACSR.
       Otherwise an interrupt can occur when the bit is changed.

       • Bit 6 – ACBG: Analog Comparator Bandgap Select
       When this bit is set, a fixed bandgap reference voltage replaces the positive input to the Analog Comparator.
       When this bit is cleared, AIN0 is applied to the positive input of the Analog Comparator. When the bandgap
       reference is used as input to the Analog Comparator, it will take a certain time for the voltage to stabilize. If not
       stabilized, the first conversion may give a wrong value. See ”Internal Voltage Reference” on page 59.

       • Bit 5 – ACO: Analog Comparator Output
       The output of the Analog Comparator is synchronized and then directly connected to ACO. The synchronization
       introduces a delay of 1 - 2 clock cycles.

       • Bit 4 – ACI: Analog Comparator Interrupt Flag
       This bit is set by hardware when a comparator output event triggers the interrupt mode defined by ACIS1 and
       ACIS0. The Analog Comparator interrupt routine is executed if the ACIE bit is set and the I-bit in SREG is set.
       ACI is cleared by hardware when executing the corresponding interrupt handling vector. Alternatively, ACI is
       cleared by writing a logic one to the flag.




        2020 Microchip Technology Inc.                        Data Sheet Complete                      DS40002061B-page 244
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

       • Bit 3 – ACIE: Analog Comparator Interrupt Enable
       When the ACIE bit is written logic one and the I-bit in the Status Register is set, the Analog Comparator interrupt
       is activated. When written logic zero, the interrupt is disabled.

       • Bit 2 – ACIC: Analog Comparator Input Capture Enable
       When written logic one, this bit enables the input capture function in Timer/Counter1 to be triggered by the
       Analog Comparator. The comparator output is in this case directly connected to the input capture front-end
       logic, making the comparator utilize the noise canceler and edge select features of the Timer/Counter1 Input
       Capture interrupt. When written logic zero, no connection between the Analog Comparator and the input
       capture function exists. To make the comparator trigger the Timer/Counter1 Input Capture interrupt, the ICIE1
       bit in the Timer Interrupt Mask Register (TIMSK1) must be set.

       • Bits 1, 0 – ACIS1, ACIS0: Analog Comparator Interrupt Mode Select
       These bits determine which comparator events that trigger the Analog Comparator interrupt. The different
       settings are shown in Table 23-2.

       Table 23-2.      ACIS1/ACIS0 Settings
              ACIS1        ACIS0          Interrupt Mode
                 0             0          Comparator Interrupt on Output Toggle.
                 0             1          Reserved
                 1             0          Comparator Interrupt on Falling Output Edge.
                 1             1          Comparator Interrupt on Rising Output Edge.

       When changing the ACIS1/ACIS0 bits, the Analog Comparator Interrupt must be disabled by clearing its
       Interrupt Enable bit in the ACSR Register. Otherwise an interrupt can occur when the bits are changed.

23.3.3 DIDR1 – Digital Input Disable Register 1
        Bit                7         6          5          4        3        2            1      0
        (0x7F)             –         –          –          –        –        –         AIN1D   AIN0D   DIDR1
        Read/Write         R         R          R          R        R        R           R/W    R/W
        Initial Value      0         0          0          0        0        0            0      0


       • Bit 7:2 – Reserved
       These bits are unused bits in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bit 1, 0 – AIN1D, AIN0D: AIN1, AIN0 Digital Input Disable
       When this bit is written logic one, the digital input buffer on the AIN1/0 pin is disabled. The corresponding PIN
       Register bit will always read as zero when this bit is set. When an analog signal is applied to the AIN1/0 pin and
       the digital input from this pin is not needed, this bit should be written logic one to reduce power consumption in
       the digital input buffer.




        2020 Microchip Technology Inc.                          Data Sheet Complete                      DS40002061B-page 245
                                             ATmega48A/PA/88A/PA/168A/PA/328/P


24.    Analog-to-Digital Converter

24.1   Features
       •   10-bit Resolution
       •   0.5 LSB Integral Non-linearity
       •   ± 2 LSB Absolute Accuracy
       •   13 - 260µs Conversion Time
       •   Up to 76.9kSPS (Up to 15kSPS at Maximum Resolution)
       •   6 Multiplexed Single Ended Input Channels
       •   2 Additional Multiplexed Single Ended Input Channels (TQFP and VQFN Package only)
       •   Temperature Sensor Input Channel
       •   Optional Left Adjustment for ADC Result Readout
       •   0 - VCC ADC Input Voltage Range
       •   Selectable 1.1V ADC Reference Voltage
       •   Free Running or Single Conversion Mode
       •   Interrupt on ADC Conversion Complete
       •   Sleep Mode Noise Canceler


24.2   Overview
       The ATmega48A/PA/88A/PA/168A/PA/328/P features a 10-bit successive approximation ADC. The ADC is
       connected to an 8-channel Analog Multiplexer which allows eight single-ended voltage inputs constructed from
       the pins of Port A. The single-ended voltage inputs refer to 0V (GND).
       The ADC contains a Sample and Hold circuit which ensures that the input voltage to the ADC is held at a
       constant level during conversion. A block diagram of the ADC is shown in Figure 24-1 on page 247.
       The ADC has a separate analog supply voltage pin, AVCC. AVCC must not differ more than ±0.3V from VCC. See
       the paragraph ”ADC Noise Canceler” on page 252 on how to connect this pin.
       Internal reference voltages of nominally 1.1V or AVCC are provided On-chip. The voltage reference may be
       externally decoupled at the AREF pin by a capacitor for better noise performance.
       The Power Reduction ADC bit, PRADC, in ”Minimizing Power Consumption” on page 51 must be disabled by
       writing a logical zero to enable the ADC.
       The ADC converts an analog input voltage to a 10-bit digital value through successive approximation. The
       minimum value represents GND and the maximum value represents the voltage on the AREF pin minus 1 LSB.
       Optionally, AVCC or an internal 1.1V reference voltage may be connected to the AREF pin by writing to the
       REFSn bits in the ADMUX Register. The internal voltage reference may thus be decoupled by an external
       capacitor at the AREF pin to improve noise immunity.




        2020 Microchip Technology Inc.                   Data Sheet Complete                   DS40002061B-page 246
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 24-1.    Analog to Digital Converter Block Schematic Operation
                                                                                                                                   ADC CONVERSION
                                                                                                                                    COMPLETE IRQ




                         8-BIT DATA BUS




                                                                                                                                                         ADIE
                                                                                                                                                  ADIF
                                                                                                                                                                                          15                       0
                                                     ADC MULTIPLEXER                                                          ADC CTRL. & STATUS                                               ADC DATA REGISTER
                                                      SELECT (ADMUX)                                                           REGISTER (ADCSRA)                                                  (ADCH/ADCL)




                                            REFS1




                                                            ADLAR




                                                                     MUX3

                                                                                                MUX2

                                                                                                       MUX1

                                                                                                              MUX0
                                                    REFS0




                                                                                                                                         ADATE




                                                                                                                                                                ADPS2

                                                                                                                                                                        ADPS1

                                                                                                                                                                                ADPS0
                                                                                                                           ADEN

                                                                                                                                  ADSC



                                                                                                                                                 ADIF




                                                                                                                                                                                                     ADC[9:0]
                                                                    MUX DECODER
                                                                                                                                                                PRESCALER




                                                                            CHANNEL SELECTION
                                                                                                                                                          CONVERSION LOGIC
               AVCC


                      INTERNAL 1.1V
                        REFERENCE                                                                                                                                                       SAMPLE & HOLD
                                                                                                                                                                                        COMPARATOR
               AREF
                                                                                                                         10-BIT DAC                                                         -
                                                                                                                                                                                            +


                      TEMPERATURE
                        SENSOR

               GND


                       BANDGAP
                      REFERENCE

               ADC7

                                          INPUT                                                                                                                                                    ADC MULTIPLEXER
               ADC6
                                           MUX                                                                                                                                                     OUTPUT

               ADC5

               ADC4

               ADC3

               ADC2

               ADC1

               ADC0




The analog input channel is selected by writing to the MUX bits in ADMUX. Any of the ADC input pins, as well as
GND and a fixed bandgap voltage reference, can be selected as single ended inputs to the ADC. The ADC is
enabled by setting the ADC Enable bit, ADEN in ADCSRA. Voltage reference and input channel selections will
not go into effect until ADEN is set. The ADC does not consume power when ADEN is cleared, so it is
recommended to switch off the ADC before entering power saving sleep modes.
The ADC generates a 10-bit result which is presented in the ADC Data Registers, ADCH and ADCL. By default,
the result is presented right adjusted, but can optionally be presented left adjusted by setting the ADLAR bit in
ADMUX.
If the result is left adjusted and no more than 8-bit precision is required, it is sufficient to read ADCH. Otherwise,
ADCL must be read first, then ADCH, to ensure that the content of the Data Registers belongs to the same
conversion. Once ADCL is read, ADC access to Data Registers is blocked. This means that if ADCL has been
read, and a conversion completes before ADCH is read, neither register is updated and the result from the
conversion is lost. When ADCH is read, ADC access to the ADCH and ADCL Registers is re-enabled.




 2020 Microchip Technology Inc.                                                                                     Data Sheet Complete                                                                        DS40002061B-page 247
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       The ADC has its own interrupt which can be triggered when a conversion completes. When ADC access to the
       Data Registers is prohibited between reading of ADCH and ADCL, the interrupt will trigger even if the result is
       lost.

24.3   Starting a Conversion
       A single conversion is started by disabling the Power Reduction ADC bit, PRADC, in ”Minimizing Power
       Consumption” on page 51 by writing a logical zero to it and writing a logical one to the ADC Start Conversion bit,
       ADSC. This bit stays high as long as the conversion is in progress and will be cleared by hardware when the
       conversion is completed. If a different data channel is selected while a conversion is in progress, the ADC will
       finish the current conversion before performing the channel change.
       Alternatively, a conversion can be triggered automatically by various sources. Auto Triggering is enabled by
       setting the ADC Auto Trigger Enable bit, ADATE in ADCSRA. The trigger source is selected by setting the ADC
       Trigger Select bits, ADTS in ADCSRB (See description of the ADTS bits for a list of the trigger sources). When
       a positive edge occurs on the selected trigger signal, the ADC prescaler is reset and a conversion is started.
       This provides a method of starting conversions at fixed intervals. If the trigger signal still is set when the
       conversion completes, a new conversion will not be started. If another positive edge occurs on the trigger signal
       during conversion, the edge will be ignored. Note that an Interrupt Flag will be set even if the specific interrupt is
       disabled or the Global Interrupt Enable bit in SREG is cleared. A conversion can thus be triggered without
       causing an interrupt. However, the Interrupt Flag must be cleared in order to trigger a new conversion at the
       next interrupt event.

       Figure 24-2.   ADC Auto Trigger Logic

                                          ADTS[2:0]
                                                                                               PRESCALER




                                                                                       START          CLKADC
                        ADIF                                      ADATE
                        SOURCE 1
                         .                                                                     CONVERSION
                         .                                                                       LOGIC
                         .
                         .                              EDGE
                        SOURCE n                      DETECTOR


                        ADSC


       Using the ADC Interrupt Flag as a trigger source makes the ADC start a new conversion as soon as the ongoing
       conversion has finished. The ADC then operates in Free Running mode, constantly sampling and updating the
       ADC Data Register. The first conversion must be started by writing a logical one to the ADSC bit in ADCSRA. In
       this mode the ADC will perform successive conversions independently of whether the ADC Interrupt Flag, ADIF
       is cleared or not.
       If Auto Triggering is enabled, single conversions can be started by writing ADSC in ADCSRA to one. ADSC can
       also be used to determine if a conversion is in progress. The ADSC bit will be read as one during a conversion,
       independently of how the conversion was started.




        2020 Microchip Technology Inc.                          Data Sheet Complete                    DS40002061B-page 248
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

24.4   Prescaling and Conversion Timing

       Figure 24-3.   ADC Prescaler

                                          ADEN
                                          START           Reset
                                                                      7-BIT ADC PRESCALER
                                                  CK




                                                                                                            CK/128
                                                                                                    CK/64
                                                                                            CK/32
                                                                                    CK/16
                                                               CK/2
                                                                      CK/4
                                                                             CK/8
                                             ADPS0
                                             ADPS1
                                             ADPS2




                                                                       ADC CLOCK SOURCE


       By default, the successive approximation circuitry requires an input clock frequency between 50kHz and
       200kHz to get maximum resolution. If a lower resolution than 10 bits is needed, the input clock frequency to the
       ADC can be higher than 200kHz to get a higher sample rate.
       The ADC module contains a prescaler, which generates an acceptable ADC clock frequency from any CPU
       frequency above 100kHz. The prescaling is set by the ADPS bits in ADCSRA. The prescaler starts counting
       from the moment the ADC is switched on by setting the ADEN bit in ADCSRA. The prescaler keeps running for
       as long as the ADEN bit is set, and is continuously reset when ADEN is low.
       When initiating a single ended conversion by setting the ADSC bit in ADCSRA, the conversion starts at the
       following rising edge of the ADC clock cycle.
       A normal conversion takes 13 ADC clock cycles. The first conversion after the ADC is switched on (ADEN in
       ADCSRA is set) takes 25 ADC clock cycles in order to initialize the analog circuitry.
       When the bandgap reference voltage is used as input to the ADC, it will take a certain time for the voltage to
       stabilize. If not stabilized, the first value read after the first conversion may be wrong.
       The actual sample-and-hold takes place 1.5 ADC clock cycles after the start of a normal conversion and 13.5
       ADC clock cycles after the start of an first conversion. When a conversion is complete, the result is written to the
       ADC Data Registers, and ADIF is set. In Single Conversion mode, ADSC is cleared simultaneously. The
       software may then set ADSC again, and a new conversion will be initiated on the first rising ADC clock edge.
       When Auto Triggering is used, the prescaler is reset when the trigger event occurs. This assures a fixed delay
       from the trigger event to the start of conversion. In this mode, the sample-and-hold takes place two ADC clock
       cycles after the rising edge on the trigger source signal. Three additional CPU clock cycles are used for
       synchronization logic.
       In Free Running mode, a new conversion will be started immediately after the conversion completes, while
       ADSC remains high. For a summary of conversion times, see Table 24-1 on page 251.




        2020 Microchip Technology Inc.                     Data Sheet Complete                                      DS40002061B-page 249
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 24-4.     ADC Timing Diagram, First Conversion (Single Conversion Mode)
                                                                                                                                                                                    Next
                                                                                                       First Conversion                                                             Conversion




                Cycle Number               1       2            12    13       14       15       16    17      18       19       20        21    22       23      24    25             1      2        3


                ADC Clock


                ADEN


                ADSC


                ADIF


                ADCH                                                                                                                                                           Sign and MSB of Result


                ADCL                                                                                                                                                                   LSB of Result


                                                       MUX and REFS                                                                                  Conversion                                   MUX and REFS
                                                       Update                                    Sample & Hold                                        Complete                                    Update




Figure 24-5.     ADC Timing Diagram, Single Conversion
                                                                                                            One Conversion                                                        Next Conversion


                Cycle Number                   1          2      3         4        5        6          7        8           9        10        11        12       13              1         2         3


                ADC Clock


                ADSC


                ADIF


                ADCH                                                                                                                                                         Sign and MSB of Result


                ADCL                                                                                                                                                             LSB of Result

                                                                      Sample & Hold
                                                                                                                                          Conversion                                          MUX and REFS
                                                             MUX and REFS                                                                  Complete                                           Update
                                                             Update



Figure 24-6.     ADC Timing Diagram, Auto Triggered Conversion
                                                                                                                     One Conversion                                                              Next Conversion


               Cycle Number                              1      2      3            4        5        6          7        8           9         10       11       12     13                          1     2


               ADC Clock

               Trigger
               Source


               ADATE

               ADIF


               ADCH                                                                                                                                                                Sign and MSB of Result


               ADCL                                                                                                                                                                        LSB of Result


                                                                               Sample &                                                         Conversion                                           Prescaler
                               Prescaler                                       Hold                                                                                                                  Reset
                                                                                                                                                 Complete
                               Reset
                                                   MUX and REFS
                                                   Update




 2020 Microchip Technology Inc.                                                                      Data Sheet Complete                                                                           DS40002061B-page 250
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 24-7.   ADC Timing Diagram, Free Running Conversion
                                                         One Conversion         Next Conversion


                                                           11    12        13   1     2     3      4
                                          Cycle Number

                                          ADC Clock


                                          ADSC


                                          ADIF


                                          ADCH                                  Sign and MSB of Result


                                          ADCL                                  LSB of Result


                                                   Conversion                                     Sample & Hold
                                                    Complete                           MUX and REFS
                                                                                       Update




       Table 24-1.    ADC Conversion Time
                                                 Sample & Hold                                           Conversion Time
        Condition                                (Cycles from Start of Conversion)                          (Cycles)
        First conversion                                              13.5                                        25
        Normal conversions, single ended                              1.5                                         13
        Auto Triggered conversions                                     2                                      13.5


24.5   Changing Channel or Reference Selection
       The MUXn and REFS1:0 bits in the ADMUX Register are single buffered through a temporary register to which
       the CPU has random access. This ensures that the channels and reference selection only takes place at a safe
       point during the conversion. The channel and reference selection is continuously updated until a conversion is
       started. Once the conversion starts, the channel and reference selection is locked to ensure a sufficient
       sampling time for the ADC. Continuous updating resumes in the last ADC clock cycle before the conversion
       completes (ADIF in ADCSRA is set). Note that the conversion starts on the following rising ADC clock edge after
       ADSC is written. The user is thus advised not to write new channel or reference selection values to ADMUX until
       one ADC clock cycle after ADSC is written.
       If Auto Triggering is used, the exact time of the triggering event can be indeterministic. Special care must be
       taken when updating the ADMUX Register, in order to control which conversion will be affected by the new
       settings.
       If both ADATE and ADEN is written to one, an interrupt event can occur at any time. If the ADMUX Register is
       changed in this period, the user cannot tell if the next conversion is based on the old or the new settings.
       ADMUX can be safely updated in the following ways:
        a.   When ADATE or ADEN is cleared.
        b.   During conversion, minimum one ADC clock cycle after the trigger event.
        c.   After a conversion, before the Interrupt Flag used as trigger source is cleared.
       When updating ADMUX in one of these conditions, the new settings will affect the next ADC conversion.




        2020 Microchip Technology Inc.                                Data Sheet Complete                                 DS40002061B-page 251
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

24.5.1 ADC Input Channels
       When changing channel selections, the user should observe the following guidelines to ensure that the correct
       channel is selected:
       In Single Conversion mode, always select the channel before starting the conversion. The channel selection
       may be changed one ADC clock cycle after writing one to ADSC. However, the simplest method is to wait for the
       conversion to complete before changing the channel selection.
       In Free Running mode, always select the channel before starting the first conversion. The channel selection
       may be changed one ADC clock cycle after writing one to ADSC. However, the simplest method is to wait for the
       first conversion to complete, and then change the channel selection. Since the next conversion has already
       started automatically, the next result will reflect the previous channel selection. Subsequent conversions will
       reflect the new channel selection.

24.5.2 ADC Voltage Reference
       The reference voltage for the ADC (VREF) indicates the conversion range for the ADC. Single ended channels
       that exceed VREF will result in codes close to 0x3FF. VREF can be selected as either AVCC, internal 1.1V
       reference, or external AREF pin.
       AVCC is connected to the ADC through a passive switch. The internal 1.1V reference is generated from the
       internal bandgap reference (VBG) through an internal amplifier. In either case, the external AREF pin is directly
       connected to the ADC, and the reference voltage can be made more immune to noise by connecting a capacitor
       between the AREF pin and ground. VREF can also be measured at the AREF pin with a high impedance
       voltmeter. Note that VREF is a high impedance source, and only a capacitive load should be connected in a
       system.
       If the user has a fixed voltage source connected to the AREF pin, the user may not use the other reference
       voltage options in the application, as they will be shorted to the external voltage. If no external voltage is applied
       to the AREF pin, the user may switch between AVCC and 1.1V as reference selection. The first ADC conversion
       result after switching reference voltage source may be inaccurate, and the user is advised to discard this result.

24.6   ADC Noise Canceler
       The ADC features a noise canceler that enables conversion during sleep mode to reduce noise induced from
       the CPU core and other I/O peripherals. The noise canceler can be used with ADC Noise Reduction and Idle
       mode. To make use of this feature, the following procedure should be used:
        a.   Make sure that the ADC is enabled and is not busy converting. Single Conversion mode must be selected
             and the ADC conversion complete interrupt must be enabled.
        b.   Enter ADC Noise Reduction mode (or Idle mode). The ADC will start a conversion once the CPU has
             been halted.
        c.   If no other interrupts occur before the ADC conversion completes, the ADC interrupt will wake up the CPU
             and execute the ADC Conversion Complete interrupt routine. If another interrupt wakes up the CPU
             before the ADC conversion is complete, that interrupt will be executed, and an ADC Conversion Complete
             interrupt request will be generated when the ADC conversion completes. The CPU will remain in active
             mode until a new sleep command is executed.
       Note that the ADC will not be automatically turned off when entering other sleep modes than Idle mode and
       ADC Noise Reduction mode. The user is advised to write zero to ADEN before entering such sleep modes to
       avoid excessive power consumption.

24.6.1 Analog Input Circuitry
       The analog input circuitry for single ended channels is illustrated in Figure 24-8. An analog source applied to
       ADCn is subjected to the pin capacitance and input leakage of that pin, regardless of whether that channel is




        2020 Microchip Technology Inc.                      Data Sheet Complete                        DS40002061B-page 252
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

      selected as input for the ADC. When the channel is selected, the source must drive the S/H capacitor through
      the series resistance (combined resistance in the input path).
      The ADC is optimized for analog signals with an output impedance of approximately 10 k or less. If such a
      source is used, the sampling time will be negligible. If a source with higher impedance is used, the sampling
      time will depend on how long time the source needs to charge the S/H capacitor, with can vary widely. The user
      is recommended to only use low impedance sources with slowly varying signals, since this minimizes the
      required charge transfer to the S/H capacitor.
      Signal components higher than the Nyquist frequency (fADC/2) should not be present for either kind of channels,
      to avoid distortion from unpredictable signal convolution. The user is advised to remove high frequency
      components with a low-pass filter before applying the signals as inputs to the ADC.

      Figure 24-8.    Analog Input Circuitry




                                               IIH

                             ADCn
                                                                1..100 kΩ
                                                                                    CS/H= 14 pF
                                                     IIL
                                                                                               VCC/2


24.6.2 Analog Noise Canceling Techniques
      Digital circuitry inside and outside the device generates EMI which might affect the accuracy of analog
      measurements. If conversion accuracy is critical, the noise level can be reduced by applying the following
      techniques:
        a.   Keep analog signal paths as short as possible. Make sure analog tracks run over the analog ground
             plane, and keep them well away from high-speed switching digital tracks.
        b.   The AVCC pin on the device should be connected to the digital VCC supply voltage via an LC network as
             shown in Figure 24-9.
        c.   Use the ADC noise canceler function to reduce induced noise from the CPU.
        d.   If any ADC [3:0] port pins are used as digital outputs, it is essential that these do not switch while a
             conversion is in progress. However, using the 2-wire Interface (ADC4 and ADC5) will only affect the
             conversion on ADC4 and ADC5 and not the other ADC channels.




        2020 Microchip Technology Inc.                     Data Sheet Complete                        DS40002061B-page 253
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 24-9.    ADC Power Connections




                                                                         PC4 (ADC4/SDA)
                                                        PC5 (ADC5/SCL)




                                                                                                                                           Analog Ground Plane
                                                                                           PC3 (ADC3)


                                                                                                        PC2 (ADC2)
                                      GND

                                             VCC
                                                                                                                        PC1 (ADC1)


                                                                                                                        PC0 (ADC0)


                                                                                                                        ADC7


                                                                                                                        GND




                                                                                                                                          10μH
                                                                                                                        AREF

                                                                                                                        ADC6




                                                                                                                                          100nF
                                                                                                                        AVCC



                                                                                                                        PB5




24.6.3 ADC Accuracy Definitions
      An n-bit single-ended ADC converts a voltage linearly between GND and VREF in 2n steps (LSBs). The lowest
      code is read as 0, and the highest code is read as 2n-1.
      Several parameters describe the deviation from the ideal behavior:
            Offset: The deviation of the first transition (0x000 to 0x001) compared to the ideal transition (at 0.5 LSB).
             Ideal value: 0 LSB.

      Figure 24-10. Offset Error
                                    Output Code




                                                                                                                                   Ideal ADC

                                                                                                                                   Actual ADC




                                                   Offset
                                                   Error
                                                                                                                     VREF Input Voltage




        2020 Microchip Technology Inc.                                                   Data Sheet Complete                                                    DS40002061B-page 254
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

     Gain error: After adjusting for offset, the gain error is found as the deviation of the last transition (0x3FE to
      0x3FF) compared to the ideal transition (at 1.5 LSB below maximum). Ideal value: 0 LSB

Figure 24-11. Gain Error
                             Output Code                           Gain
                                                                   Error




                                                                                         Ideal ADC
                                                                                         Actual ADC




                                                                           VREF Input Voltage


     Integral Non-linearity (INL): After adjusting for offset and gain error, the INL is the maximum deviation of
      an actual transition compared to an ideal transition for any code. Ideal value: 0 LSB.

Figure 24-12. Integral Non-linearity (INL)
                             Output Code
                                                           INL




                                                                                         Ideal ADC

                                                                                         Actual ADC




                                                                           VREF   Input Voltage


     Differential Non-linearity (DNL): The maximum deviation of the actual code width (the interval between
      two adjacent transitions) from the ideal code width (1 LSB). Ideal value: 0 LSB.




 2020 Microchip Technology Inc.                      Data Sheet Complete                             DS40002061B-page 255
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 24-13. Differential Non-linearity (DNL)
                                      Output Code
                                           0x3FF




                                                        1 LSB


                                                                 DNL
                                           0x000

                                                    0                                         VREF Input Voltage


            Quantization Error: Due to the quantization of the input voltage into a finite number of codes, a range of
             input voltages (1 LSB wide) will code to the same value. Always ±0.5 LSB.
            Absolute accuracy: The maximum deviation of an actual (unadjusted) transition compared to an ideal
             transition for any code. This is the compound effect of offset, gain error, differential error, non-linearity, and
             quantization error. Ideal value: ±0.5 LSB.

24.7   ADC Conversion Result
       After the conversion is complete (ADIF is high), the conversion result can be found in the ADC Result Registers
       (ADCL, ADCH).
       For single ended conversion, the result is

                                                                 V IN  1024
                                                           ADC = --------------------------
                                                                        V REF


       where VIN is the voltage on the selected input pin and VREF the selected voltage reference (see Table 24-3 on
       page 257 and Table 24-4 on page 258). 0x000 represents analog ground, and 0x3FF represents the selected
       reference voltage minus one LSB.

24.8   Temperature Measurement
       The temperature measurement is based on an on-chip temperature sensor that is coupled to a single ended
       ADC8 channel. Selecting the ADC8 channel by writing the MUX3...0 bits in ADMUX register to "1000" enables
       the temperature sensor. The internal 1.1V voltage reference must also be selected for the ADC voltage
       reference source in the temperature sensor measurement. When the temperature sensor is enabled, the ADC
       converter can be used in single conversion mode to measure the voltage over the temperature sensor.
       The measured voltage has a linear relationship to the temperature as described in Table 24-2. The voltage
       sensitivity is approximately 1 mV/°C and the accuracy of the temperature measurement is +/- 10°C.

       Table 24-2.     Temperature vs. Sensor Output Voltage (Typical Case)
        Temperature / C                    -45C                              +25C                        +85C
        Voltage / mV                       242mV                              314mV                         380mV

       The values described in Table 24-2 are typical values. However, due to the process variation the temperature
       sensor output voltage varies from one chip to another. To be capable of achieving more accurate results the
       temperature measurement can be calibrated in the application software. The software calibration requires that a



        2020 Microchip Technology Inc.                              Data Sheet Complete                            DS40002061B-page 256
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

       calibration value is measured and stored in a register or EEPROM for each chip, as a part of the production test.
       The software calibration can be done utilizing the formula:
       T = { [(ADCH << 8) | ADCL] - TOS} / k
       where ADCn are the ADC data registers, k is a fixed coefficient and TOS is the temperature sensor offset value
       determined and stored into EEPROM as a part of the production test.

24.9   Register Description

24.9.1 ADMUX – ADC Multiplexer Selection Register

           Bit                   7       6          5          4          3          2        1            0
           (0x7C)          REFS1      REFS0      ADLAR         –        MUX3      MUX2      MUX1      MUX0     ADMUX
           Read/Write        R/W        R/W        R/W         R         R/W        R/W      R/W       R/W
           Initial Value         0       0          0          0          0          0        0            0


       • Bit 7:6 – REFS[1:0]: Reference Selection Bits
       These bits select the voltage reference for the ADC, as shown in Table 24-3. If these bits are changed during a
       conversion, the change will not go in effect until this conversion is complete (ADIF in ADCSRA is set). The
       internal voltage reference options may not be used if an external reference voltage is being applied to the AREF
       pin.


       Table 24-3.          Voltage Reference Selections for ADC
            REFS1          REFS0     Voltage Reference Selection
                  0          0       AREF, Internal Vref turned off
                  0          1       AVCC with external capacitor at AREF pin
                  1          0       Reserved
                  1          1       Internal 1.1V Voltage Reference with external capacitor at AREF pin

       •         Bit 5 – ADLAR: ADC Left Adjust Result
       The ADLAR bit affects the presentation of the ADC conversion result in the ADC Data Register. Write one to
       ADLAR to left adjust the result. Otherwise, the result is right adjusted. Changing the ADLAR bit will affect the
       ADC Data Register immediately, regardless of any ongoing conversions. For a complete description of this bit,
       see ”ADCL and ADCH – The ADC Data Register” on page 259.

       • Bit 4 – Reserved
       This bit is an unused bit in the ATmega48A/PA/88A/PA/168A/PA/328/P, and will always read as zero.

       • Bits 3:0 – MUX[3:0]: Analog Channel Selection Bits
       The value of these bits selects which analog inputs are connected to the ADC. See Table 24-4 for details. If
       these bits are changed during a conversion, the change will not go in effect until this conversion is complete
       (ADIF in ADCSRA is set).




        2020 Microchip Technology Inc.                               Data Sheet Complete                      DS40002061B-page 257
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


      Table 24-4.       Input Channel Selections
        MUX3...0                           Single Ended Input
        0000                               ADC0
        0001                               ADC1
        0010                               ADC2
        0011                               ADC3
        0100                               ADC4
        0101                               ADC5
        0110                               ADC6
        0111                               ADC7
        1000                               ADC8(1)
        1001                               (reserved)
        1010                               (reserved)
        1011                               (reserved)
        1100                               (reserved)
        1101                               (reserved)
        1110                               1.1V (VBG)
        1111                               0V (GND)

      Note:       1. For Temperature Sensor.

24.9.2 ADCSRA – ADC Control and Status Register A
       Bit                 7         6          5        4       3         2           1       0
       (0x7A)            ADEN      ADSC    ADATE        ADIF    ADIE     ADPS2       ADPS1   ADPS0   ADCSRA
       Read/Write         R/W       R/W        R/W      R/W     R/W       R/W         R/W     R/W
       Initial Value       0         0          0        0       0         0           0       0


      • Bit 7 – ADEN: ADC Enable
      Writing this bit to one enables the ADC. By writing it to zero, the ADC is turned off. Turning the ADC off while a
      conversion is in progress, will terminate this conversion.

      • Bit 6 – ADSC: ADC Start Conversion
      In Single Conversion mode, write this bit to one to start each conversion. In Free Running mode, write this bit to
      one to start the first conversion. The first conversion after ADSC has been written after the ADC has been
      enabled, or if ADSC is written at the same time as the ADC is enabled, will take 25 ADC clock cycles instead of
      the normal 13. This first conversion performs initialization of the ADC.
      ADSC will read as one as long as a conversion is in progress. When the conversion is complete, it returns to
      zero. Writing zero to this bit has no effect.

      • Bit 5 – ADATE: ADC Auto Trigger Enable
      When this bit is written to one, Auto Triggering of the ADC is enabled. The ADC will start a conversion on a
      positive edge of the selected trigger signal. The trigger source is selected by setting the ADC Trigger Select bits,
      ADTS in ADCSRB.




        2020 Microchip Technology Inc.                        Data Sheet Complete                      DS40002061B-page 258
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       • Bit 4 – ADIF: ADC Interrupt Flag
       This bit is set when an ADC conversion completes and the Data Registers are updated. The ADC Conversion
       Complete Interrupt is executed if the ADIE bit and the I-bit in SREG are set. ADIF is cleared by hardware when
       executing the corresponding interrupt handling vector. Alternatively, ADIF is cleared by writing a logical one to
       the flag. Beware that if doing a Read-Modify-Write on ADCSRA, a pending interrupt can be disabled. This also
       applies if the SBI and CBI instructions are used.

       • Bit 3 – ADIE: ADC Interrupt Enable
       When this bit is written to one and the I-bit in SREG is set, the ADC Conversion Complete Interrupt is activated.

       • Bits 2:0 – ADPS[2:0]: ADC Prescaler Select Bits
       These bits determine the division factor between the system clock frequency and the input clock to the ADC.

       Table 24-5.      ADC Prescaler Selections
              ADPS2             ADPS1        ADPS0                         Division Factor
                 0                0                0                                2
                 0                0                1                                2
                 0                1                0                                4
                 0                1                1                                8
                 1                0                0                                16
                 1                0                1                                32
                 1                1                0                                64
                 1                1                1                                128


24.9.3 ADCL and ADCH – The ADC Data Register

24.9.3.1 ADLAR = 0
        Bit                15           14    13        12     11        10             9     8
        (0x79)             –            –     –         –       –         –         ADC9     ADC8   ADCH
        (0x78)           ADC7         ADC6   ADC5      ADC4   ADC3     ADC2         ADC1     ADC0   ADCL

                           7            6     5         4       3         2             1     0
        Read/Write         R            R     R         R       R         R             R     R
                           R            R     R         R       R         R             R     R
        Initial Value      0            0     0         0       0         0             0     0
                           0            0     0         0       0         0             0     0

24.9.3.2 ADLAR = 1

        Bit                15           14    13        12     11        10             9     8
        (0x79)           ADC9         ADC8   ADC7      ADC6   ADC5     ADC4         ADC3     ADC2   ADCH
        (0x78)           ADC1         ADC0    –         –       –         –             –     –     ADCL

                           7            6     5         4       3         2             1     0
        Read/Write         R            R     R         R       R         R             R     R
                           R            R     R         R       R         R             R     R
        Initial Value      0            0     0         0       0         0             0     0
                           0            0     0         0       0         0             0     0

       When an ADC conversion is complete, the result is found in these two registers.




         2020 Microchip Technology Inc.                      Data Sheet Complete                     DS40002061B-page 259
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       When ADCL is read, the ADC Data Register is not updated until ADCH is read. Consequently, if the result is left
       adjusted and no more than 8-bit precision is required, it is sufficient to read ADCH. Otherwise, ADCL must be
       read first, then ADCH.
       The ADLAR bit in ADMUX, and the MUXn bits in ADMUX affect the way the result is read from the registers. If
       ADLAR is set, the result is left adjusted. If ADLAR is cleared (default), the result is right adjusted.

       • ADC9:0: ADC Conversion Result
       These bits represent the result from the conversion, as detailed in ”ADC Conversion Result” on page 256.

24.9.4 ADCSRB – ADC Control and Status Register B
        Bit                 7        6       5        4           3           2             1            0
        (0x7B)              –      ACME      –        –           –         ADTS2         ADTS1        ADTS0     ADCSRB
        Read/Write          R       R/W      R        R           R          R/W           R/W          R/W
        Initial Value       0        0       0        0           0           0             0            0


       • Bit 7, 5:3 – Reserved
       These bits are reserved for future use. To ensure compatibility with future devices, these bits must be written to
       zero when ADCSRB is written.

       • Bit 2:0 – ADTS[2:0]: ADC Auto Trigger Source
       If ADATE in ADCSRA is written to one, the value of these bits selects which source will trigger an ADC
       conversion. If ADATE is cleared, the ADTS[2:0] settings will have no effect. A conversion will be triggered by the
       rising edge of the selected Interrupt Flag. Note that switching from a trigger source that is cleared to a trigger
       source that is set, will generate a positive edge on the trigger signal. If ADEN in ADCSRA is set, this will start a
       conversion. Switching to Free Running mode (ADTS[2:0]=0) will not cause a trigger event, even if the ADC
       Interrupt Flag is set.

       Table 24-6.       ADC Auto Trigger Source Selections
                 ADTS2             ADTS1             ADTS0             Trigger Source
                    0                 0                   0            Free Running mode
                    0                 0                   1            Analog Comparator
                    0                 1                   0            External Interrupt Request 0
                    0                 1                   1            Timer/Counter0 Compare Match A
                    1                 0                   0            Timer/Counter0 Overflow
                    1                 0                   1            Timer/Counter1 Compare Match B
                    1                 1                   0            Timer/Counter1 Overflow
                    1                 1                   1            Timer/Counter1 Capture Event


24.9.5 DIDR0 – Digital Input Disable Register 0
        Bit                 7            6       5         4           3             2             1             0
        (0x7E)              –            –   ADC5D    ADC4D        ADC3D          ADC2D          ADC1D         ADC0D      DIDR0
        Read/Write          R            R    R/W         R/W         R/W           R/W           R/W           R/W
        Initial Value       0            0       0         0           0             0             0             0


       • Bits 7:6 – Reserved
       These bits are reserved for future use. To ensure compatibility with future devices, these bits must be written to
       zero when DIDR0 is written.




        2020 Microchip Technology Inc.                         Data Sheet Complete                                    DS40002061B-page 260
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

• Bit 5:0 – ADC5D...ADC0D: ADC5...0 Digital Input Disable
When this bit is written logic one, the digital input buffer on the corresponding ADC pin is disabled. The
corresponding PIN Register bit will always read as zero when this bit is set. When an analog signal is applied to
the ADC5...0 pin and the digital input from this pin is not needed, this bit should be written logic one to reduce
power consumption in the digital input buffer.
Note that ADC pins ADC7 and ADC6 do not have digital input buffers, and therefore do not require Digital Input
Disable bits.




 2020 Microchip Technology Inc.                    Data Sheet Complete                       DS40002061B-page 261
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


25.    debugWIRE On-chip Debug System

25.1   Features
       •   Complete Program Flow Control
       •   Emulates All On-chip Functions, Both Digital and Analog, except RESET Pin
       •   Real-time Operation
       •   Symbolic Debugging Support (Both at C and Assembler Source Level, or for Other HLLs)
       •   Unlimited Number of Program Break Points (Using Software Break Points)
       •   Non-intrusive Operation
       •   Electrical Characteristics Identical to Real Device
       •   Automatic Configuration System
       •   High-Speed Operation
       •   Programming of Non-volatile Memories


25.2   Overview
       The debugWIRE On-chip debug system uses a One-wire, bi-directional interface to control the program flow,
       execute AVR instructions in the CPU and to program the different non-volatile memories.

25.3   Physical Interface
       When the debugWIRE Enable (DWEN) Fuse is programmed and Lock bits are unprogrammed, the debugWIRE
       system within the target device is activated. The RESET port pin is configured as a wire-AND (open-drain) bi-
       directional I/O pin with pull-up enabled and becomes the communication gateway between target and emulator.

       Figure 25-1.   The debugWIRE Setup

                                                                                 1.8 - 5.5V




                                                                         VCC




                                          dW          dW(RESET)



                                                      GND




       Figure 25-1 shows the schematic of a target MCU, with debugWIRE enabled, and the emulator connector. The
       system clock is not affected by debugWIRE and will always be the clock source selected by the CKSEL Fuses.
       When designing a system where debugWIRE will be used, the following observations must be made for correct
       operation:




        2020 Microchip Technology Inc.                    Data Sheet Complete                    DS40002061B-page 262
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

              Pull-up resistors on the dW/(RESET) line must not be smaller than 10k. The pull-up resistor is not
               required for debugWIRE functionality.
              Connecting the RESET pin directly to VCC will not work.
              Capacitors connected to the RESET pin must be disconnected when using debugWire.
              All external reset sources must be disconnected.

25.4   Software Break Points
       debugWIRE supports Program memory Break Points by the AVR Break instruction. Setting a Break Point in
       Atmel Studio will insert a BREAK instruction in the Program memory. The instruction replaced by the BREAK
       instruction will be stored. When program execution is continued, the stored instruction will be executed before
       continuing from the Program memory. A break can be inserted manually by putting the BREAK instruction in the
       program.
       The Flash must be re-programmed each time a Break Point is changed. This is automatically handled by Atmel
       Studio through the debugWIRE interface. The use of Break Points will therefore reduce the Flash Data
       retention. Devices used for debugging purposes should not be shipped to end customers.

25.5   Limitations of debugWIRE
       The debugWIRE communication pin (dW) is physically located on the same pin as External Reset (RESET). An
       External Reset source is therefore not supported when the debugWIRE is enabled.
       A programmed DWEN Fuse enables some parts of the clock system to be running in all sleep modes. This will
       increase the power consumption while in sleep. Thus, the DWEN Fuse should be disabled when debugWire is
       not used.

25.6   Register Description
       The following section describes the registers used with the debugWire.

25.6.1 DWDR – debugWire Data Register
        Bit               7          6      5        4        3           2        1     0
                                                     DWDR[7:0]                                  DWDR
        Read/Write       R/W        R/W    R/W      R/W      R/W         R/W      R/W   R/W
        Initial Value     0          0      0        0        0           0        0     0

       The DWDR Register provides a communication channel from the running program in the MCU to the debugger.
       This register is only accessible by the debugWIRE and can therefore not be used as a general purpose register
       in the normal operations.




        2020 Microchip Technology Inc.                     Data Sheet Complete                     DS40002061B-page 263
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P


26.    Self-Programming the Flash, ATmega 48A/48PA

26.1   Overview
       In ATmega 48A/48PA there is no Read-While-Write support, and no separate Boot Loader Section. The SPM
       instruction can be executed from the entire Flash.
       The device provides a Self-Programming mechanism for downloading and uploading program code by the MCU
       itself. The Self-Programming can use any available data interface and associated protocol to read code and
       write (program) that code into the Program memory.
       The Program memory is updated in a page by page fashion. Before programming a page with the data stored in
       the temporary page buffer, the page must be erased. The temporary page buffer is filled one word at a time
       using SPM and the buffer can be filled either before the Page Erase command or between a Page Erase and a
       Page Write operation:
       Alternative 1, fill the buffer before a Page Erase
              Fill temporary page buffer
              Perform a Page Erase
              Perform a Page Write
       Alternative 2, fill the buffer after Page Erase
              Perform a Page Erase
              Fill temporary page buffer
              Perform a Page Write
       If only a part of the page needs to be changed, the rest of the page must be stored (for example in the
       temporary page buffer) before the erase, and then be re-written. When using alternative 1, the Boot Loader
       provides an effective Read-Modify-Write feature which allows the user software to first read the page, do the
       necessary changes, and then write back the modified data. If alternative 2 is used, it is not possible to read the
       old data while loading since the page is already erased. The temporary page buffer can be accessed in a
       random sequence. It is essential that the page address used in both the Page Erase and Page Write operation
       is addressing the same page.

26.1.1 Performing Page Erase by SPM
       To execute Page Erase, set up the address in the Z-pointer, write “00000011” to SPMCSR and execute SPM
       within four clock cycles after writing SPMCSR. The data in R1 and R0 is ignored. The page address must be
       written to PCPAGE in the Z-register. Other bits in the Z-pointer will be ignored during this operation.
              The CPU is halted during the Page Erase operation.
       Note:     If an interrupt occurs in the time sequence the four cycle access cannot be ensured. In order to ensure atomic oper-
                 ation you should disable interrupts before writing to SPMCSR.

26.1.2 Filling the Temporary Buffer (Page Loading)
       To write an instruction word, set up the address in the Z-pointer and data in R1:R0, write “00000001” to
       SPMCSR and execute SPM within four clock cycles after writing SPMCSR. The content of PCWORD in the Z-
       register is used to address the data in the temporary buffer. The temporary buffer will auto-erase after a Page
       Write operation or by writing the RWWSRE bit in SPMCSR. It is also erased after a system reset. Note that it is
       not possible to write more than one time to each address without erasing the temporary buffer.
       If the EEPROM is written in the middle of an SPM Page Load operation, all data loaded will be lost.




        2020 Microchip Technology Inc.                          Data Sheet Complete                          DS40002061B-page 264
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

26.1.3 Performing a Page Write
       To execute Page Write, set up the address in the Z-pointer, write “00000101” to SPMCSR and execute SPM
       within four clock cycles after writing SPMCSR. The data in R1 and R0 is ignored. The page address must be
       written to PCPAGE. Other bits in the Z-pointer must be written to zero during this operation.
              The CPU is halted during the Page Write operation.

26.2   Addressing the Flash During Self-Programming
       The Z-pointer is used to address the SPM commands.
        Bit                15              14             13            12        11             10           9      8
        ZH (R31)          Z15              Z14           Z13            Z12      Z11             Z10       Z9        Z8
        ZL (R30)          Z7               Z6            Z5             Z4        Z3             Z2        Z1        Z0
                           7                 6            5              4        3               2           1      0

       Since the Flash is organized in pages (see Table 28-11 on page 294), the Program Counter can be treated as
       having two different sections. One section, consisting of the least significant bits, is addressing the words within
       a page, while the most significant bits are addressing the pages. This is shown in Figure 27-3 on page 277. Note
       that the Page Erase and Page Write operations are addressed independently. Therefore it is of major
       importance that the software addresses the same page in both the Page Erase and Page Write operation.
       The LPM instruction uses the Z-pointer to store the address. Since this instruction addresses the Flash byte-by-
       byte, also the LSB (bit Z0) of the Z-pointer is used.

       Figure 26-1.   Addressing the Flash During SPM(1)
                                BIT   15            ZPCMSB                    ZPAGEMSB     1 0
                       Z - REGISTER                                                          0


                                                     PCMSB                    PAGEMSB
                                      PROGRAM
                                                               PCPAGE           PCWORD
                                      COUNTER

                                                 PAGE ADDRESS                          WORD ADDRESS
                                                 WITHIN THE FLASH                      WITHIN A PAGE

                            PROGRAM MEMORY                                                             PAGE               PCWORD[PAGEMSB:0]:
                                      PAGE                                                                                00
                                                                                                  INSTRUCTION WORD

                                                                                                                          01

                                                                                                                          02




                                                                                                                          PAGEEND




       Note:    1. The different variables used in Figure 27-3 are listed in Table 28-11 on page 294.

26.2.1 EEPROM Write Prevents Writing to SPMCSR
       Note that an EEPROM write operation will block all software programming to Flash. Reading the Fuses and
       Lock bits from software will also be prevented during the EEPROM write operation. It is recommended that the
       user checks the status bit (EEPE) in the EECR Register and verifies that the bit is cleared before writing to the
       SPMCSR Register.



        2020 Microchip Technology Inc.                                        Data Sheet Complete                                  DS40002061B-page 265
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

26.2.2 Reading the Fuse and Lock Bits from Software
       It is possible to read both the Fuse and Lock bits from software. To read the Lock bits, load the Z-pointer with
       0x0001 and set the BLBSET and SPMEN bits in SPMCSR. When an LPM instruction is executed within three
       CPU cycles after the BLBSET and SPMEN bits are set in SPMCSR, the value of the Lock bits will be loaded in
       the destination register. The BLBSET and SPMEN bits will auto-clear upon completion of reading the Lock bits
       or if no LPM instruction is executed within three CPU cycles or no SPM instruction is executed within four CPU
       cycles. When BLBSET and SPMEN are cleared, LPM will work as described in the Instruction set Manual.
        Bit                7         6     5        4         3        2         1        0
        Rd                 –         –     –        –         –        –        LB2     LB1

       The algorithm for reading the Fuse Low byte is similar to the one described above for reading the Lock bits. To
       read the Fuse Low byte, load the Z-pointer with 0x0000 and set the BLBSET and SPMEN bits in SPMCSR.
       When an LPM instruction is executed within three cycles after the BLBSET and SPMEN bits are set in the
       SPMCSR, the value of the Fuse Low byte (FLB) will be loaded in the destination register as shown below.See
       Table 28-5 on page 291 for a detailed description and mapping of the Fuse Low byte.
        Bit                7         6     5        4         3        2         1        0
        Rd              FLB7       FLB6   FLB5    FLB4      FLB3     FLB2       FLB1   FLB0

       Similarly, when reading the Fuse High byte (FHB), load 0x0003 in the Z-pointer. When an LPM instruction is
       executed within three cycles after the BLBSET and SPMEN bits are set in the SPMCSR, the value of the Fuse
       High byte will be loaded in the destination register as shown below. See Table 28-5 on page 291 for detailed
       description and mapping of the Extended Fuse byte.
        Bit                7         6     5        4         3        2         1       0
        Rd              FHB7       FHB6   FHB5    FHB4     FHB3      FHB2       FHB1   FHB0

       Similarly, when reading the Extended Fuse byte (EFB), load 0x0002 in the Z-pointer. When an LPM instruction
       is executed within three cycles after the BLBSET and SPMEN bits are set in the SPMCSR, the value of the
       Extended Fuse byte will be loaded in the destination register as shown below. See Table 28-5 on page 291 for
       detailed description and mapping of the Extended Fuse byte.
        Bit                7         6     5        4         3        2         1        0
        Rd              FHB7       FHB6   FHB5    FHB4      FHB3     FHB2       FHB1   FHB0

       Fuse and Lock bits that are programmed, will be read as zero. Fuse and Lock bits that are unprogrammed, will
       be read as one.




        2020 Microchip Technology Inc.                   Data Sheet Complete                      DS40002061B-page 266
                                                ATmega48A/PA/88A/PA/168A/PA/328/P


26.2.3 Preventing Flash Corruption
       During periods of low VCC, the Flash program can be corrupted because the supply voltage is too low for the
       CPU and the Flash to operate properly. These issues are the same as for board level systems using the Flash,
       and the same design solutions should be applied.
       A Flash program corruption can be caused by two situations when the voltage is too low. First, a regular write
       sequence to the Flash requires a minimum voltage to operate correctly. Secondly, the CPU itself can execute
       instructions incorrectly, if the supply voltage for executing instructions is too low.
       Flash corruption can easily be avoided by following these design recommendations (one is sufficient):
        1.     Keep the AVR RESET active (low) during periods of insufficient power supply voltage. This can be done
               by enabling the internal Brown-out Detector (BOD) if the operating voltage matches the detection level. If
               not, an external low VCC reset protection circuit can be used. If a reset occurs while a write operation is in
               progress, the write operation will be completed provided that the power supply voltage is sufficient.
        2.     Keep the AVR core in Power-down sleep mode during periods of low VCC. This will prevent the CPU from
               attempting to decode and execute instructions, effectively protecting the SPMCSR Register and thus the
               Flash from unintentional writes.

26.2.4 Programming Time for Flash when Using SPM
       The calibrated RC Oscillator is used to time Flash accesses. Table 27-6 shows the typical programming time for
       Flash accesses from the CPU.

       Table 26-1.     SPM Programming Time(1)
                           Symbol                     Min. Programming Time         Max Programming Time
        Flash write (Page Erase, Page Write, and
                                                                3.7ms                       4.5ms
        write Lock bits by SPM)

       Note:     1.   Minimum and maximum programming time is per individual operation.




        2020 Microchip Technology Inc.                       Data Sheet Complete                       DS40002061B-page 267
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


26.2.5 Simple Assembly Code Example for a Boot Loader
      Note that the RWWSB bit will always be read as zero in ATmega 48A/48PA. Nevertheless, it is recommended to
      check this bit as shown in the code example, to ensure compatibility with devices supporting Read-While-Write.


                         ;-the routine writes one page of data from RAM to Flash
                         ; the first data location in RAM is pointed to by the Y pointer
                         ; the first data location in Flash is pointed to by the Z-pointer
                         ;-error handling is not included
                         ;-the routine must be placed inside the Boot space
                         ; (at least the Do_spm sub routine). Only code inside NRWW section can
                         ; be read during Self-Programming (Page Erase and Page Write).
                         ;-registers used: r0, r1, temp1 (r16), temp2 (r17), looplo (r24),
                         ; loophi (r25), spmcrval (r20)
                         ; storing and restoring of registers is not included in the routine
                         ; register usage can be optimized at the expense of code size
                         ;-It is assumed that either the interrupt table is moved to the Boot
                         ; loader section or that the interrupts are disabled.
               .equ                PAGESIZEB = PAGESIZE*2;PAGESIZEB is page size in BYTES, not
               words
               .org SMALLBOOTSTART
               Write_page:
                     ; Page Erase
                     ldi                   spmcrval, (1<<PGERS) | (1<<SPMEN)
                     rcall                 Do_spm

                         ; re-enable the RWW section
                         ldi             spmcrval, (1<<RWWSRE) | (1<<SPMEN)
                         rcall           Do_spm

                     ; transfer data from RAM to Flash page buffer
                     ldi             looplo, low(PAGESIZEB);init loop variable
                     ldi             loophi, high(PAGESIZEB);not required for
               PAGESIZEB<=256
               Wrloop:
                     ld              r0, Y+
                     ld              r1, Y+
                     ldi             spmcrval, (1<<SPMEN)
                     rcall           Do_spm
                     adiw            ZH:ZL, 2
                     sbiw            loophi:looplo, 2;use subi for PAGESIZEB<=256
                     brne            Wrloop

                         ; execute Page Write
                         subi            ZL, low(PAGESIZEB);restore pointer
                         sbci            ZH, high(PAGESIZEB);not required for PAGESIZEB<=256
                         ldi             spmcrval, (1<<PGWRT) | (1<<SPMEN)
                         rcall           Do_spm

                         ; re-enable the RWW section
                         ldi             spmcrval, (1<<RWWSRE) | (1<<SPMEN)
                         rcall           Do_spm




        2020 Microchip Technology Inc.                 Data Sheet Complete                     DS40002061B-page 268
                                   ATmega48A/PA/88A/PA/168A/PA/328/P

              ; read back and check, optional
              ldi             looplo, low(PAGESIZEB);init loop variable
              ldi             loophi, high(PAGESIZEB);not required for
        PAGESIZEB<=256
              subi            YL, low(PAGESIZEB);restore pointer
              sbci            YH, high(PAGESIZEB)
        Rdloop:
              lpm             r0, Z+
              ld              r1, Y+
              cpse            r0, r1
              rjmp            Error
              sbiw            loophi:looplo, 1;use subi for PAGESIZEB<=256
              brne            Rdloop

              ; return to RWW section
              ; verify that RWW section is safe to read
        Return:
              in              temp1, SPMCSR
              sbrs            temp1, RWWSB ; If RWWSB is set, the RWW section is not
        ready yet
              ret
              ; re-enable the RWW section
              ldi             spmcrval, (1<<RWWSRE) | (1<<SPMEN)
              rcall           Do_spm
              rjmp            Return

        Do_spm:
              ; check for previous SPM complete
        Wait_spm:
              in              temp1, SPMCSR
              sbrc            temp1, SPMEN
              rjmp            Wait_spm
              ; input: spmcrval determines SPM action
              ; disable interrupts if enabled, store status
              in              temp2, SREG
              cli
              ; check that no EEPROM write access is present
        Wait_ee:
              sbic            EECR, EEPE
              rjmp            Wait_ee
              ; SPM timed sequence
              out             SPMCSR, spmcrval
              spm
              ; restore SREG (to enable interrupts if originally enabled)
              out             SREG, temp2
              ret




 2020 Microchip Technology Inc.         Data Sheet Complete            DS40002061B-page 269
                                               ATmega48A/PA/88A/PA/168A/PA/328/P


26.3   Register Description

26.3.1 SPMCSR – Store Program Memory Control and Status Register
       The Store Program Memory Control and Status Register contains the control bits needed to control the Program
       memory operations.
        Bit               7               6     5        4             3            2      1         0
        0x37 (0x57)     SPMIE      RWWSB      SIGRD   RWWSRE       BLBSET      PGWRT     PGERS    SPMEN      SPMCSR
        Read/Write       R/W              R    R/W      R/W           R/W          R/W    R/W       R/W
        Initial Value     0               0     0        0             0            0      0         0


       • Bit 7 – SPMIE: SPM Interrupt Enable
       When the SPMIE bit is written to one, and the I-bit in the Status Register is set (one), the SPM ready interrupt
       will be enabled. The SPM ready Interrupt will be executed as long as the SPMEN bit in the SPMCSR Register is
       cleared. The interrupt will not be generated during EEPROM write or SPM.

       • Bit 6 – RWWSB: Read-While-Write Section Busy
       This bit is for compatibility with devices supporting Read-While-Write. It will always read as zero in ATmega
       48A/48PA.

       • Bit 5 – SIGRD: Signature Row Read
       If this bit is written to one at the same time as SPMEN, the next LPM instruction within three clock cycles will
       read a byte from the signature row into the destination register. see ”Reading the Signature Row from Software”
       on page 280 for details. An SPM instruction within four cycles after SIGRD and SPMEN are set will have no
       effect. This operation is reserved for future use and should not be used.

       • Bit 4 – RWWSRE: Read-While-Write Section Read Enable
       The functionality of this bit in ATmega 48A/48PA is a subset of the functionality in
       ATmega88A/88PA/168A/168PA/328/328P. If the RWWSRE bit is written while filling the temporary page buffer,
       the temporary page buffer will be cleared and the data will be lost.

       • Bit 3 – BLBSET: Boot Lock Bit Set
       The functionality of this bit in ATmega 48A/48PA is a subset of the functionality in
       ATmega88A/88PA/168A/168PA/328/328P. An LPM instruction within three cycles after BLBSET and SPMEN
       are set in the SPMCSR Register, will read either the Lock bits or the Fuse bits (depending on Z0 in the Z-
       pointer) into the destination register. See ”Reading the Fuse and Lock Bits from Software” on page 266 for
       details.

       • Bit 2 – PGWRT: Page Write
       If this bit is written to one at the same time as SPMEN, the next SPM instruction within four clock cycles
       executes Page Write, with the data stored in the temporary buffer. The page address is taken from the high part
       of the Z-pointer. The data in R1 and R0 are ignored. The PGWRT bit will auto-clear upon completion of a Page
       Write, or if no SPM instruction is executed within four clock cycles. The CPU is halted during the entire Page
       Write operation.

       • Bit 1 – PGERS: Page Erase
       If this bit is written to one at the same time as SPMEN, the next SPM instruction within four clock cycles
       executes Page Erase. The page address is taken from the high part of the Z-pointer. The data in R1 and R0 are




        2020 Microchip Technology Inc.                      Data Sheet Complete                    DS40002061B-page 270
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

ignored. The PGERS bit will auto-clear upon completion of a Page Erase, or if no SPM instruction is executed
within four clock cycles. The CPU is halted during the entire Page Write operation.

• Bit 0 – SPMEN: Store Program Memory
This bit enables the SPM instruction for the next four clock cycles. If written to one together with either
RWWSRE, BLBSET, PGWRT, or PGERS, the following SPM instruction will have a special meaning, see
description above. If only SPMEN is written, the following SPM instruction will store the value in R1:R0 in the
temporary page buffer addressed by the Z-pointer. The LSB of the Z-pointer is ignored. The SPMEN bit will
auto-clear upon completion of an SPM instruction, or if no SPM instruction is executed within four clock cycles.
During Page Erase and Page Write, the SPMEN bit remains high until the operation is completed.
Writing any other combination than “10001”, “01001”, “00101”, “00011” or “00001” in the lower five bits will have
no effect.




 2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 271
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


27.    Boot Loader Support – Read-While-Write Self-Programming
       The Boot Loader Support applies to ATmega88A/88PA/168A/168PA/328/328P

27.1   Features
       •   Read-While-Write Self-Programming
       •   Flexible Boot Memory Size
       •   High Security (Separate Boot Lock Bits for a Flexible Protection)
       •   Separate Fuse to Select Reset Vector
       •   Optimized Page(1) Size
       •   Code Efficient Algorithm
       •   Efficient Read-Modify-Write Support
       Note:     1. A page is a section in the Flash consisting of several bytes (see Table 28-11 on page 294) used during pro-
                    gramming. The page organization does not affect normal operation.


27.2   Overview
       In ATmega88A/88PA/168A/168PA/328/328P the Boot Loader Support provides a real Read-While-Write Self-
       Programming mechanism for downloading and uploading program code by the MCU itself. This feature allows
       flexible application software updates controlled by the MCU using a Flash-resident Boot Loader program. The
       Boot Loader program can use any available data interface and associated protocol to read code and write
       (program) that code into the Flash memory, or read the code from the program memory. The program code
       within the Boot Loader section has the capability to write into the entire Flash, including the Boot Loader
       memory. The Boot Loader can thus even modify itself, and it can also erase itself from the code if the feature is
       not needed anymore. The size of the Boot Loader memory is configurable with fuses and the Boot Loader has
       two separate sets of Boot Lock bits which can be set independently. This gives the user a unique flexibility to
       select different levels of protection.

27.3   Application and Boot Loader Flash Sections
       The Flash memory is organized in two main sections, the Application section and the Boot Loader section (see
       Figure 27-2). The size of the different sections is configured by the BOOTSZ Fuses as shown in Table 27-7 on
       page 284 and Figure 27-2. These two sections can have different level of protection since they have different
       sets of Lock bits.

27.3.1 Application Section
       The Application section is the section of the Flash that is used for storing the application code. The protection
       level for the Application section can be selected by the application Boot Lock bits (Boot Lock bits 0), see Table
       27-2 on page 276. The Application section can never store any Boot Loader code since the SPM instruction is
       disabled when executed from the Application section.

27.3.2 BLS – Boot Loader Section
       While the Application section is used for storing the application code, the The Boot Loader software must be
       located in the BLS since the SPM instruction can initiate a programming when executing from the BLS only. The
       SPM instruction can access the entire Flash, including the BLS itself. The protection level for the Boot Loader
       section can be selected by the Boot Loader Lock bits (Boot Lock bits 1), see Table 27-3 on page 276.




        2020 Microchip Technology Inc.                         Data Sheet Complete                         DS40002061B-page 272
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

27.4   Read-While-Write and No Read-While-Write Flash Sections
       Whether the CPU supports Read-While-Write or if the CPU is halted during a Boot Loader software update is
       dependent on which address that is being programmed. In addition to the two sections that are configurable by
       the BOOTSZ Fuses as described above, the Flash is also divided into two fixed sections, the Read-While-Write
       (RWW) section and the No Read-While-Write (NRWW) section. The limit between the RWW- and NRWW
       sections is given in Table 27-8 on page 284 and Figure 27-2 on page 275. The main difference between the two
       sections is:
            When erasing or writing a page located inside the RWW section, the NRWW section can be read during
             the operation.
            When erasing or writing a page located inside the NRWW section, the CPU is halted during the entire
             operation.
       Note that the user software can never read any code that is located inside the RWW section during a Boot
       Loader software operation. The syntax “Read-While-Write section” refers to which section that is being
       programmed (erased or written), not which section that actually is being read during a Boot Loader software
       update.

27.4.1 RWW – Read-While-Write Section
       If a Boot Loader software update is programming a page inside the RWW section, it is possible to read code
       from the Flash, but only code that is located in the NRWW section. During an on-going programming, the
       software must ensure that the RWW section never is being read. If the user software is trying to read code that
       is located inside the RWW section (i.e., by a call/jmp/lpm or an interrupt) during programming, the software
       might end up in an unknown state. To avoid this, the interrupts should either be disabled or moved to the Boot
       Loader section. The Boot Loader section is always located in the NRWW section. The RWW Section Busy bit
       (RWWSB) in the Store Program Memory Control and Status Register (SPMCSR) will be read as logical one as
       long as the RWW section is blocked for reading. After a programming is completed, the RWWSB must be
       cleared by software before reading code located in the RWW section. See Section “27.9.1” on page 287. for
       details on how to clear RWWSB.

27.4.2 NRWW – No Read-While-Write Section
       The code located in the NRWW section can be read when the Boot Loader software is updating a page in the
       RWW section. When the Boot Loader code updates the NRWW section, the CPU is halted during the entire
       Page Erase or Page Write operation.

       Table 27-1.    Read-While-Write Features
        Which Section does the Z-         Which Section can be
         pointer Address during               read during                            Read-While-Write
           the Programming?                 Programming?             CPU Halted?       Supported?
               RWW Section                   NRWW Section                  No              Yes
              NRWW Section                       None                     Yes               No




        2020 Microchip Technology Inc.                     Data Sheet Complete                   DS40002061B-page 273
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 27-1.   Read-While-Write vs. No Read-While-Write




                                              Read-While-Write
                                               (RWW) Section




                                                                           Z-pointer
                                                                           Addresses NRWW
                      Z-pointer                                            Section
                      Addresses RWW           No Read-While-Write
                      Section                   (NRWW) Section
                                                                           CPU is Halted
                                                                           During the Operation
                      Code Located in
                      NRWW Section
                      Can be Read During
                      the Operation




 2020 Microchip Technology Inc.                     Data Sheet Complete                      DS40002061B-page 274
                                                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 27-2.                                 Memory Sections
                                                              Program Memory                                                                   Program Memory
                                                               BOOTSZ = '11'                                                                    BOOTSZ = '10'
                                                                                        0x0000                                                                          0x0000




                      Read-While-Write Section




                                                                                                             Read-While-Write Section
                                                          Application Flash Section                                                         Application Flash Section
                      No Read-While-Write Section




                                                                                                             No Read-While-Write Section
                                                                                        End RWW                                                                         End RWW
                                                                                        Start NRWW                                                                      Start NRWW

                                                          Application Flash Section                                                         Application Flash Section

                                                                                                                                                                        End Application
                                                                                        End Application                                                                 Start Boot Loader
                                                                                        Start Boot Loader                                   Boot Loader Flash Section
                                                          Boot Loader Flash Section
                                                                                        Flashend                                                                        Flashend


                                                              Program Memory                                                                    Program Memory
                                                               BOOTSZ = '01'                                                                     BOOTSZ = '00'
                                                                                        0x0000                                                                          0x0000
                      Read-While-Write Section




                                                                                                              Read-While-Write Section

                                                           Application Flash Section                                                        Application Flash Section




                                                                                                                                                                        End RWW, End Application
                      No Read-While-Write Section




                                                                                                              No Read-While-Write Section




                                                                                        End RWW
                                                                                        Start NRWW                                                                      Start NRWW, Start Boot Loader
                                                           Application Flash Section

                                                                                        End Application
                                                                                                                                            Boot Loader Flash Section
                                                                                        Start Boot Loader
                                                          Boot Loader Flash Section

                                                                                        Flashend                                                                        Flashend




       Note:     1. The parameters in the figure above are given in Table 27-7 on page 284.


27.5   Boot Loader Lock Bits
       If no Boot Loader capability is needed, the entire Flash is available for application code. The Boot Loader has
       two separate sets of Boot Lock bits which can be set independently. This gives the user a unique flexibility to
       select different levels of protection.
       The user can select:
              To protect the entire Flash from a software update by the MCU.
              To protect only the Boot Loader Flash section from a software update by the MCU.
              To protect only the Application Flash section from a software update by the MCU.
              Allow software update in the entire Flash.
       See Table 27-2 and Table 27-3 for further details. The Boot Lock bits can be set in software and in Serial or
       Parallel Programming mode, but they can be cleared by a Chip Erase command only. The general Write Lock
       (Lock Bit mode 2) does not control the programming of the Flash memory by SPM instruction. Similarly, the
       general Read/Write Lock (Lock Bit mode 1) does not control reading nor writing by LPM/SPM, if it is attempted.




        2020 Microchip Technology Inc.                                                                     Data Sheet Complete                                                             DS40002061B-page 275
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 27-2.    Boot Lock Bit0 Protection Modes (Application Section)(1)
         BLB0 Mode        BLB02       BLB01    Protection
                                               No restrictions for SPM or LPM accessing the Application
               1             1            1
                                               section.
               2             1            0    SPM is not allowed to write to the Application section.
                                               SPM is not allowed to write to the Application section, and LPM
                                               executing from the Boot Loader section is not allowed to read
               3             0            0    from the Application section. If Interrupt Vectors are placed in
                                               the Boot Loader section, interrupts are disabled while executing
                                               from the Application section.
                                               LPM executing from the Boot Loader section is not allowed to
                                               read from the Application section. If Interrupt Vectors are placed
               4             0            1
                                               in the Boot Loader section, interrupts are disabled while
                                               executing from the Application section.
       Note:   1.    “1” means unprogrammed, “0” means programmed

       Table 27-3.    Boot Lock Bit1 Protection Modes (Boot Loader Section)(1)
         BLB1 Mode        BLB12       BLB11    Protection
                                               No restrictions for SPM or LPM accessing the Boot Loader
               1             1            1
                                               section.
               2             1            0    SPM is not allowed to write to the Boot Loader section.
                                               SPM is not allowed to write to the Boot Loader section, and LPM
                                               executing from the Application section is not allowed to read
               3             0            0    from the Boot Loader section. If Interrupt Vectors are placed in
                                               the Application section, interrupts are disabled while executing
                                               from the Boot Loader section.
                                               LPM executing from the Application section is not allowed to
                                               read from the Boot Loader section. If Interrupt Vectors are
               4             0            1
                                               placed in the Application section, interrupts are disabled while
                                               executing from the Boot Loader section.
       Note:   1.    “1” means unprogrammed, “0” means programmed

27.6   Entering the Boot Loader Program
       Entering the Boot Loader takes place by a jump or call from the application program. This may be initiated by a
       trigger such as a command received via USART, or SPI interface. Alternatively, the Boot Reset Fuse can be
       programmed so that the Reset Vector is pointing to the Boot Flash start address after a reset. In this case, the
       Boot Loader is started after a reset. After the application code is loaded, the program can start executing the
       application code. Note that the fuses cannot be changed by the MCU itself. This means that once the Boot
       Reset Fuse is programmed, the Reset Vector will always point to the Boot Loader Reset and the fuse can only
       be changed through the serial or parallel programming interface.

       Table 27-4.    Boot Reset Fuse(1)
          BOOTRST          Reset Address
               1           Reset Vector = Application Reset (address 0x0000)
               0           Reset Vector = Boot Loader Reset (see Table 27-7 on page 284)

       Note:   1.    “1” means unprogrammed, “0” means programmed




        2020 Microchip Technology Inc.                        Data Sheet Complete                            DS40002061B-page 276
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

27.7   Addressing the Flash During Self-Programming
       The Z-pointer is used to address the SPM commands.
        Bit                15              14             13            12        11             10           9      8
        ZH (R31)          Z15              Z14           Z13            Z12      Z11             Z10       Z9        Z8
        ZL (R30)          Z7               Z6            Z5             Z4        Z3             Z2        Z1        Z0
                           7                 6            5              4        3               2           1      0

       Since the Flash is organized in pages (see Table 28-11 on page 294), the Program Counter can be treated as
       having two different sections. One section, consisting of the least significant bits, is addressing the words within
       a page, while the most significant bits are addressing the pages. This is1 shown in Figure 27-3. Note that the
       Page Erase and Page Write operations are addressed independently. Therefore it is of major importance that
       the Boot Loader software addresses the same page in both the Page Erase and Page Write operation. Once a
       programming operation is initiated, the address is latched and the Z-pointer can be used for other operations.
       The only SPM operation that does not use the Z-pointer is Setting the Boot Loader Lock bits. The content of the
       Z-pointer is ignored and will have no effect on the operation. The LPM instruction does also use the Z-pointer to
       store the address. Since this instruction addresses the Flash byte-by-byte, also the LSB (bit Z0) of the Z-pointer
       is used.

       Figure 27-3.   Addressing the Flash During SPM(1)
                                BIT   15            ZPCMSB                    ZPAGEMSB     1 0
                       Z - REGISTER                                                          0


                                                     PCMSB                    PAGEMSB
                                      PROGRAM
                                                               PCPAGE           PCWORD
                                      COUNTER

                                                 PAGE ADDRESS                          WORD ADDRESS
                                                 WITHIN THE FLASH                      WITHIN A PAGE

                            PROGRAM MEMORY                                                             PAGE               PCWORD[PAGEMSB:0]:
                                      PAGE                                                                                00
                                                                                                  INSTRUCTION WORD

                                                                                                                          01

                                                                                                                          02




                                                                                                                          PAGEEND




       Note:   1. The different variables used in Figure 27-3 are listed in Table 27-9 on page 284.




        2020 Microchip Technology Inc.                                        Data Sheet Complete                                  DS40002061B-page 277
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

27.8   Self-Programming the Flash
       The program memory is updated in a page by page fashion. Before programming a page with the data stored in
       the temporary page buffer, the page must be erased. The temporary page buffer is filled one word at a time
       using SPM and the buffer can be filled either before the Page Erase command or between a Page Erase and a
       Page Write operation:
       Alternative 1, fill the buffer before a Page Erase
            Fill temporary page buffer
            Perform a Page Erase
            Perform a Page Write
       Alternative 2, fill the buffer after Page Erase
            Perform a Page Erase
            Fill temporary page buffer
            Perform a Page Write
       If only a part of the page needs to be changed, the rest of the page must be stored (for example in the
       temporary page buffer) before the erase, and then be rewritten. When using alternative 1, the Boot Loader
       provides an effective Read-Modify-Write feature which allows the user software to first read the page, do the
       necessary changes, and then write back the modified data. If alternative 2 is used, it is not possible to read the
       old data while loading since the page is already erased. The temporary page buffer can be accessed in a
       random sequence. It is essential that the page address used in both the Page Erase and Page Write operation
       is addressing the same page. See ”Simple Assembly Code Example for a Boot Loader” on page 281 for an
       assembly code example.

27.8.1 Performing Page Erase by SPM
       To execute Page Erase, set up the address in the Z-pointer, write “X0000011” to SPMCSR and execute SPM
       within four clock cycles after writing SPMCSR. The data in R1 and R0 is ignored. The page address must be
       written to PCPAGE in the Z-register. Other bits in the Z-pointer will be ignored during this operation.
            Page Erase to the RWW section: The NRWW section can be read during the Page Erase.
            Page Erase to the NRWW section: The CPU is halted during the operation.

27.8.2 Filling the Temporary Buffer (Page Loading)
       To write an instruction word, set up the address in the Z-pointer and data in R1:R0, write “00000001” to
       SPMCSR and execute SPM within four clock cycles after writing SPMCSR. The content of PCWORD in the Z-
       register is used to address the data in the temporary buffer. The temporary buffer will auto-erase after a Page
       Write operation or by writing the RWWSRE bit in SPMCSR. It is also erased after a system reset. Note that it is
       not possible to write more than one time to each address without erasing the temporary buffer.
       If the EEPROM is written in the middle of an SPM Page Load operation, all data loaded will be lost.

27.8.3 Performing a Page Write
       To execute Page Write, set up the address in the Z-pointer, write “X0000101” to SPMCSR and execute SPM
       within four clock cycles after writing SPMCSR. The data in R1 and R0 is ignored. The page address must be
       written to PCPAGE. Other bits in the Z-pointer must be written to zero during this operation.
            Page Write to the RWW section: The NRWW section can be read during the Page Write.
            Page Write to the NRWW section: The CPU is halted during the operation.




        2020 Microchip Technology Inc.                     Data Sheet Complete                      DS40002061B-page 278
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

27.8.4 Using the SPM Interrupt
       If the SPM interrupt is enabled, the SPM interrupt will generate a constant interrupt when the SPMEN bit in
       SPMCSR is cleared. This means that the interrupt can be used instead of polling the SPMCSR Register in
       software. When using the SPM interrupt, the Interrupt Vectors should be moved to the BLS section to avoid that
       an interrupt is accessing the RWW section when it is blocked for reading. How to move the interrupts is
       described in ”Interrupts” on page 66.

27.8.5 Consideration While Updating BLS
       Special care must be taken if the user allows the Boot Loader section to be updated by leaving Boot Lock bit11
       unprogrammed. An accidental write to the Boot Loader itself can corrupt the entire Boot Loader, and further
       software updates might be impossible. If it is not necessary to change the Boot Loader software itself, it is
       recommended to program the Boot Lock bit11 to protect the Boot Loader software from any internal software
       changes.

27.8.6 Prevent Reading the RWW Section During Self-Programming
       During Self-Programming (either Page Erase or Page Write), the RWW section is always blocked for reading.
       The user software itself must prevent that this section is addressed during the self programming operation. The
       RWWSB in the SPMCSR will be set as long as the RWW section is busy. During Self-Programming the Interrupt
       Vector table should be moved to the BLS as described in ”Watchdog Timer” on page 60, or the interrupts must
       be disabled. Before addressing the RWW section after the programming is completed, the user software must
       clear the RWWSB by writing the RWWSRE. See ”Simple Assembly Code Example for a Boot Loader” on page
       281 for an example.

27.8.7 Setting the Boot Loader Lock Bits by SPM
       To set the Boot Loader Lock bits and general Lock Bits, write the desired data to R0, write “X0001001” to
       SPMCSR and execute SPM within four clock cycles after writing SPMCSR.
        Bit                7         6       5        4         3         2         1        0
        R0                 1         1    BLB12    BLB11     BLB02     BLB01       LB2     LB1

       See Table 27-2 and Table 27-3 for how the different settings of the Boot Loader bits affect the Flash access.
       If bits 5...0 in R0 are cleared (zero), the corresponding Lock bit will be programmed if an SPM instruction is
       executed within four cycles after BLBSET and SPMEN are set in SPMCSR. The Z-pointer is don’t care during
       this operation, but for future compatibility it is recommended to load the Z-pointer with 0x0001 (same as used for
       reading the lOck bits). For future compatibility it is also recommended to set bits 7 and 6 in R0 to “1” when writing
       the Lock bits. When programming the Lock bits the entire Flash can be read during the operation.

27.8.8 EEPROM Write Prevents Writing to SPMCSR
       Note that an EEPROM write operation will block all software programming to Flash. Reading the Fuses and
       Lock bits from software will also be prevented during the EEPROM write operation. It is recommended that the
       user checks the status bit (EEPE) in the EECR Register and verifies that the bit is cleared before writing to the
       SPMCSR Register.

27.8.9 Reading the Fuse and Lock Bits from Software
       It is possible to read both the Fuse and Lock bits from software. To read the Lock bits, load the Z-pointer with
       0x0001 and set the BLBSET and SPMEN bits in SPMCSR. When an LPM instruction is executed within three
       CPU cycles after the BLBSET and SPMEN bits are set in SPMCSR, the value of the Lock bits will be loaded in
       the destination register. The BLBSET and SPMEN bits will auto-clear upon completion of reading the Lock bits




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 279
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

       or if no LPM instruction is executed within three CPU cycles or no SPM instruction is executed within four CPU
       cycles. When BLBSET and SPMEN are cleared, LPM will work as described in the Instruction set Manual.
        Bit                7         6        5         4            3         2         1      0
        Rd                 –         –     BLB12     BLB11        BLB02     BLB01       LB2    LB1

       The algorithm for reading the Fuse Low byte is similar to the one described above for reading the Lock bits. To
       read the Fuse Low byte, load the Z-pointer with 0x0000 and set the BLBSET and SPMEN bits in SPMCSR.
       When an LPM instruction is executed within three cycles after the BLBSET and SPMEN bits are set in the
       SPMCSR, the value of the Fuse Low byte (FLB) will be loaded in the destination register as shown below. Refer
       to Table 28-5 on page 291 for a detailed description and mapping of the Fuse Low byte.
        Bit                7         6        5         4            3         2         1      0
        Rd              FLB7       FLB6     FLB5      FLB4         FLB3      FLB2       FLB1   FLB0

       Similarly, when reading the Fuse High byte, load 0x0003 in the Z-pointer. When an LPM instruction is executed
       within three cycles after the BLBSET and SPMEN bits are set in the SPMCSR, the value of the Fuse High byte
       (FHB) will be loaded in the destination register as shown below. Refer to Table 28-7 on page 291 for detailed
       description and mapping of the Fuse High byte.
        Bit                7         6        5         4            3         2         1      0
        Rd              FHB7       FHB6    FHB5       FHB4         FHB3      FHB2       FHB1   FHB0

       When reading the Extended Fuse byte, load 0x0002 in the Z-pointer. When an LPM instruction is executed
       within three cycles after the BLBSET and SPMEN bits are set in the SPMCSR, the value of the Extended Fuse
       byte (EFB) will be loaded in the destination register as shown below. Refer to Table 28-5 on page 291 for
       detailed description and mapping of the Extended Fuse byte.
        Bit                7         6        5         4            3         2         1      0
        Rd                 –         –        –         –          EFB3      EFB2       EFB1   EFB0

       Fuse and Lock bits that are programmed, will be read as zero. Fuse and Lock bits that are unprogrammed, will
       be read as one.

27.8.10 Reading the Signature Row from Software
       To read the Signature Row from software, load the Z-pointer with the signature byte address given in Table 27-
       5 on page 280 and set the SIGRD and SPMEN bits in SPMCSR. When an LPM instruction is executed within
       three CPU cycles after the SIGRD and SPMEN bits are set in SPMCSR, the signature byte value will be loaded
       in the destination register. The SIGRD and SPMEN bits will auto-clear upon completion of reading the Signature
       Row Lock bits or if no LPM instruction is executed within three CPU cycles. When SIGRD and SPMEN are
       cleared, LPM will work as described in the Instruction set Manual.


       Table 27-5.    Signature Row Addressing
        Signature Byte                                       Z-Pointer Address
        Device Signature Byte 1                              0x0000
        Device Signature Byte 2                              0x0002
        Device Signature Byte 3                              0x0004
        RC Oscillator Calibration Byte                       0x0001

       Note:   All other addresses are reserved for future use.




        2020 Microchip Technology Inc.                           Data Sheet Complete                 DS40002061B-page 280
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

27.8.11 Preventing Flash Corruption
       During periods of low VCC, the Flash program can be corrupted because the supply voltage is too low for the
       CPU and the Flash to operate properly. These issues are the same as for board level systems using the Flash,
       and the same design solutions should be applied.
       A Flash program corruption can be caused by two situations when the voltage is too low. First, a regular write
       sequence to the Flash requires a minimum voltage to operate correctly. Secondly, the CPU itself can execute
       instructions incorrectly, if the supply voltage for executing instructions is too low.
       Flash corruption can easily be avoided by following these design recommendations (one is sufficient):
       1. If there is no need for a Boot Loader update in the system, program the Boot Loader Lock bits to prevent
          any Boot Loader software updates.
        2.     Keep the AVR RESET active (low) during periods of insufficient power supply voltage. This can be done
               by enabling the internal Brown-out Detector (BOD) if the operating voltage matches the detection level. If
               not, an external low VCC reset protection circuit can be used. If a reset occurs while a write operation is in
               progress, the write operation will be completed provided that the power supply voltage is sufficient.
        3.     Keep the AVR core in Power-down sleep mode during periods of low VCC. This will prevent the CPU from
               attempting to decode and execute instructions, effectively protecting the SPMCSR Register and thus the
               Flash from unintentional writes.

27.8.12 Programming Time for Flash when Using SPM
       The calibrated RC Oscillator is used to time Flash accesses. Table 27-6 shows the typical programming time for
       Flash accesses from the CPU.

       Table 27-6.     SPM Programming Time(1)
                          Symbol                     Min. Programming Time          Max Programming Time
        Flash write (Page Erase, Page Write, and
                                                              3.7ms                        4.5ms
        write Lock bits by SPM)

       Note:     1.   Minimum and maximum programming time is per individual operation.

27.8.13 Simple Assembly Code Example for a Boot Loader
                          ;-the routine writes one page of data from RAM to Flash
                          ; the first data location in RAM is pointed to by the Y pointer
                          ; the first data location in Flash is pointed to by the Z-pointer
                          ;-error handling is not included
                          ;-the routine must be placed inside the Boot space
                          ; (at least the Do_spm sub routine). Only code inside NRWW section can
                          ; be read during Self-Programming (Page Erase and Page Write).
                          ;-registers used: r0, r1, temp1 (r16), temp2 (r17), looplo (r24),
                          ; loophi (r25), spmcrval (r20)
                          ; storing and restoring of registers is not included in the routine
                          ; register usage can be optimized at the expense of code size
                          ;-It is assumed that either the interrupt table is moved to the Boot
                          ; loader section or that the interrupts are disabled.
                 .equ               PAGESIZEB = PAGESIZE*2;PAGESIZEB is page size in BYTES, not
                 words
                 .org SMALLBOOTSTART
                 Write_page:
                       ; Page Erase
                       ldi                      spmcrval, (1<<PGERS) | (1<<SPMEN)
                       call                     Do_spm




        2020 Microchip Technology Inc.                       Data Sheet Complete                       DS40002061B-page 281
                                   ATmega48A/PA/88A/PA/168A/PA/328/P

                  ; re-enable the RWW section
                  ldi             spmcrval, (1<<RWWSRE) | (1<<SPMEN)
                  call            Do_spm

              ; transfer data from RAM to Flash page buffer
              ldi             looplo, low(PAGESIZEB);init loop variable
              ldi             loophi, high(PAGESIZEB);not required for
        PAGESIZEB<=256
        Wrloop:
              ld              r0, Y+
              ld              r1, Y+
              ldi             spmcrval, (1<<SPMEN)
              call            Do_spm
              adiw            ZH:ZL, 2
              sbiw            loophi:looplo, 2;use subi for PAGESIZEB<=256
              brne            Wrloop

                  ; execute Page Write
                  subi            ZL, low(PAGESIZEB);restore pointer
                  sbci            ZH, high(PAGESIZEB);not required for PAGESIZEB<=256
                  ldi             spmcrval, (1<<PGWRT) | (1<<SPMEN)
                  call            Do_spm

                  ; re-enable the RWW section
                  ldi             spmcrval, (1<<RWWSRE) | (1<<SPMEN)
                  call            Do_spm

              ; read back and check, optional
              ldi             looplo, low(PAGESIZEB);init loop variable
              ldi             loophi, high(PAGESIZEB);not required for
        PAGESIZEB<=256
              subi            YL, low(PAGESIZEB);restore pointer
              sbci            YH, high(PAGESIZEB)
        Rdloop:
              lpm             r0, Z+
              ld              r1, Y+
              cpse            r0, r1
              jmp             Error
              sbiw            loophi:looplo, 1;use subi for PAGESIZEB<=256
              brne            Rdloop

              ; return to RWW section
              ; verify that RWW section is safe to read
        Return:
              in              temp1, SPMCSR
              sbrs            temp1, RWWSB ; If RWWSB is set, the RWW section is not
        ready yet
              ret
              ; re-enable the RWW section
              ldi             spmcrval, (1<<RWWSRE) | (1<<SPMEN)
              call            Do_spm
              rjmp            Return

        Do_spm:
              ; check for previous SPM complete




 2020 Microchip Technology Inc.            Data Sheet Complete            DS40002061B-page 282
                                   ATmega48A/PA/88A/PA/168A/PA/328/P

        Wait_spm:
              in              temp1, SPMCSR
              sbrc            temp1, SPMEN
              rjmp            Wait_spm
              ; input: spmcrval determines SPM action
              ; disable interrupts if enabled, store status
              in              temp2, SREG
              cli
              ; check that no EEPROM write access is present
        Wait_ee:
              sbic            EECR, EEPE
              rjmp            Wait_ee
              ; SPM timed sequence
              out             SPMCSR, spmcrval
              spm
              ; restore SREG (to enable interrupts if originally enabled)
              out             SREG, temp2
              ret




 2020 Microchip Technology Inc.         Data Sheet Complete           DS40002061B-page 283
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P


27.8.14 ATmega88A and ATmega88PA Boot Loader Parameters
In Table 27-7 through Table 27-9, the parameters used in the description of the self programming are given.

Table 27-7.         Boot Size Configuration, ATmega88A/88PA
                                                                        Boot
                                                        Application     Loader          End
                              Boot                      Flash           Flash           Application    Boot Reset Address (Start Boot Loader
 BOOTSZ1        BOOTSZ0       Size             Pages    Section         Section         Section        Section)

        1             1       128 words          4      0x000 - 0xF7F   0xF80 - 0xFFF   0xF7F          0xF80

        1             0       256 words          8      0x000 - 0xEFF   0xF00 - 0xFFF   0xEFF          0xF00

        0             1       512 words         16      0x000 - 0xDFF   0xE00 - 0xFFF   0xDFF          0xE00
        0             0       1024 words        32      0x000 - 0xBFF   0xC00 - 0xFFF   0xBFF          0xC00
            Note:     The different BOOTSZ Fuse configurations are shown in Figure 27-2 on page 275.

Table 27-8.         Read-While-Write Limit, ATmega88A/88PA
 Section                                                                   Pages        Address
 Read-While-Write section (RWW)                                              96         0x000 - 0xBFF
 No Read-While-Write section (NRWW)                                          32         0xC00 - 0xFFF
For details about these two section, see ”NRWW – No Read-While-Write Section” on page 273 and ”RWW – Read-
While-Write Section” on page 273

Table 27-9.         Explanation of Different Variables used in Figure 27-3 and the Mapping to the Z-pointer, ATmega88A/88PA
                                                     Corresponding
 Variable                                              Z-value(1)       Description
                                                                        Most significant bit in the Program Counter. (The Program Counter is
 PCMSB                            11
                                                                        12 bits PC[11:0])
                                                                        Most significant bit which is used to address the words within one
 PAGEMSB                             4
                                                                        page (32 words in a page requires 5 bits PC [4:0]).
                                                                        Bit in Z-register that is mapped to PCMSB. Because Z0 is not used,
 ZPCMSB                                                   Z12
                                                                        the ZPCMSB equals PCMSB + 1.
                                                                        Bit in Z-register that is mapped to PAGEMSB. Because Z0 is not
 ZPAGEMSB                                                 Z5
                                                                        used, the ZPAGEMSB equals PAGEMSB + 1.
                                                                        Program counter page address: Page select, for page erase and
 PCPAGE                        PC[11:5]                 Z12:Z6
                                                                        page write
                                                                        Program counter word address: Word select, for filling temporary
 PCWORD                        PC[4:0]                   Z5:Z1
                                                                        buffer (must be zero during page write operation)

Note:       1. Z15:Z13: always ignored
               Z0: should be zero for all SPM commands, byte select for the LPM instruction.
               See ”Addressing the Flash During Self-Programming” on page 277 for details about the use of Z-pointer during Self-
               Programming.




             2020 Microchip Technology Inc.                            Data Sheet Complete                          DS40002061B-page 284
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

27.8.15 ATmega168A and ATmega168PA Boot Loader Parameters
In Table 27-10 through Table 27-12, the parameters used in the description of the self programming are given.

Table 27-10.        Boot Size Configuration, ATmega168A/168PA
                                                                           Boot
                                                        Application        Loader               End
                              Boot                      Flash              Flash                Application   Boot Reset Address (Start Boot
 BOOTSZ1        BOOTSZ0       Size             Pages    Section            Section              Section       Loader Section)

        1             1       128 words          2      0x0000 - 0x1F7F    0x1F80 - 0x1FFF      0x1F7F        0x1F80

        1             0       256 words          4      0x0000 - 0x1EFF    0x1F00 - 0x1FFF      0x1EFF        0x1F00

        0             1       512 words          8      0x0000 - 0x1DFF    0x1E00 - 0x1FFF      0x1DFF        0x1E00
        0             0       1024 words        16      0x0000 - 0x1BFF    0x1C00 - 0x1FFF      0x1BFF        0x1C00
            Note:     The different BOOTSZ Fuse configurations are shown in Figure 27-2 on page 275.

Table 27-11.        Read-While-Write Limit, ATmega168A/168PA
 Section                                                                        Pages           Address
 Read-While-Write section (RWW)                                                   112           0x0000 - 0x1BFF
 No Read-While-Write section (NRWW)                                               16            0x1C00 - 0x1FFF
For details about these two section, see ”NRWW – No Read-While-Write Section” on page 273 and ”RWW – Read-
While-Write Section” on page 273


Table 27-12.        Explanation of Different Variables used in Figure 27-3 and the Mapping to the Z-pointer, ATmega168A/168PA
                                                       Corresponding
 Variable                                                Z-value(1)        Description
                                                                           Most significant bit in the Program Counter. (The Program Counter
 PCMSB                               12
                                                                           is 13 bits PC[12:0])
                                                                           Most significant bit which is used to address the words within
 PAGEMSB                             5
                                                                           one page (64 words in a page requires 6 bits PC [5:0])
                                                                           Bit in Z-register that is mapped to PCMSB. Because Z0 is not used,
 ZPCMSB                                                     Z13
                                                                           the ZPCMSB equals PCMSB + 1.
                                                                           Bit in Z-register that is mapped to PAGEMSB. Because Z0 is not
 ZPAGEMSB                                                   Z6
                                                                           used, the ZPAGEMSB equals PAGEMSB + 1.
                                                                           Program counter page address: Page select, for page erase and
 PCPAGE                         PC[12:6]                  Z13:Z7
                                                                           page write
                                                                           Program counter word address: Word select, for filling temporary
 PCWORD                         PC[5:0]                    Z6:Z1
                                                                           buffer (must be zero during page write operation)
Note:       1. Z15:Z14: always ignored
               Z0: should be zero for all SPM commands, byte select for the LPM instruction.
               See ”Addressing the Flash During Self-Programming” on page 277 for details about the use of Z-pointer during Self-
               Programming.




             2020 Microchip Technology Inc.                              Data Sheet Complete                          DS40002061B-page 285
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

27.8.16 ATmega328 and ATmega328P Boot Loader Parameters
In Table 27-13 through Table 27-15, the parameters used in the description of the self programming are given.

Table 27-13.        Boot Size Configuration, ATmega328/328P
                                                                           Boot
                                                        Application        Loader               End
                              Boot                      Flash              Flash                Application   Boot Reset Address (Start Boot
 BOOTSZ1        BOOTSZ0       Size             Pages    Section            Section              Section       Loader Section)

        1             1       256 words          4      0x0000 - 0x3EFF    0x3F00 - 0x3FFF      0x3EFF        0x3F00

        1             0       512 words          8      0x0000 - 0x3DFF    0x3E00 - 0x3FFF      0x3DFF        0x3E00

        0             1       1024 words        16      0x0000 - 0x3BFF    0x3C00 - 0x3FFF      0x3BFF        0x3C00
        0             0       2048 words        32      0x0000 - 0x37FF    0x3800 - 0x3FFF      0x37FF        0x3800
            Note:     The different BOOTSZ Fuse configurations are shown in Figure 27-2 on page 275.

Table 27-14.        Read-While-Write Limit, ATmega328/328P
 Section                                                                        Pages           Address
 Read-While-Write section (RWW)                                                  224            0x0000 - 0x37FF
 No Read-While-Write section (NRWW)                                               32            0x3800 - 0x3FFF
For details about these two section, see ”NRWW – No Read-While-Write Section” on page 273 and ”RWW – Read-
While-Write Section” on page 273.


Table 27-15.        Explanation of Different Variables used in Figure 27-3 and the Mapping to the Z-pointer, ATmega328/328P
                                                       Corresponding
 Variable                                                Z-value(1)        Description
                                                                           Most significant bit in the Program Counter. (The Program Counter
 PCMSB                               13
                                                                           is 14 bits PC[13:0])
                                                                           Most significant bit which is used to address the words within
 PAGEMSB                             5
                                                                           one page (64 words in a page requires 6 bits PC [5:0])
                                                                           Bit in Z-register that is mapped to PCMSB. Because Z0 is not used,
 ZPCMSB                                                     Z14
                                                                           the ZPCMSB equals PCMSB + 1.
                                                                           Bit in Z-register that is mapped to PAGEMSB. Because Z0 is not
 ZPAGEMSB                                                   Z6
                                                                           used, the ZPAGEMSB equals PAGEMSB + 1.
                                                                           Program counter page address: Page select, for page erase and
 PCPAGE                         PC[13:6]                  Z14:Z7
                                                                           page write
                                                                           Program counter word address: Word select, for filling temporary
 PCWORD                         PC[5:0]                    Z6:Z1
                                                                           buffer (must be zero during page write operation)
Note:       1. Z15: always ignored
               Z0: should be zero for all SPM commands, byte select for the LPM instruction.
               See ”Addressing the Flash During Self-Programming” on page 277 for details about the use of Z-pointer during Self-
               Programming.




             2020 Microchip Technology Inc.                              Data Sheet Complete                          DS40002061B-page 286
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

27.9   Register Description

27.9.1 SPMCSR – Store Program Memory Control and Status Register
       The Store Program Memory Control and Status Register contains the control bits needed to control the Boot
       Loader operations.
        Bit               7          6       5        4            3              2     1          0
        0x37 (0x57)     SPMIE   RWWSB     SIGRD    RWWSRE      BLBSET      PGWRT      PGERS     SPMEN       SPMCSR
        Read/Write       R/W        R     R/W        R/W          R/W        R/W       R/W        R/W
        Initial Value     0          0       0        0            0              0     0          0


       • Bit 7 – SPMIE: SPM Interrupt Enable
       When the SPMIE bit is written to one, and the I-bit in the Status Register is set (one), the SPM ready interrupt
       will be enabled. The SPM ready Interrupt will be executed as long as the SPMEN bit in the SPMCSR Register is
       cleared.

       • Bit 6 – RWWSB: Read-While-Write Section Busy
       When a Self-Programming (Page Erase or Page Write) operation to the RWW section is initiated, the RWWSB
       will be set (one) by hardware. When the RWWSB bit is set, the RWW section cannot be accessed. The
       RWWSB bit will be cleared if the RWWSRE bit is written to one after a Self-Programming operation is
       completed. Alternatively the RWWSB bit will automatically be cleared if a page load operation is initiated.

       • Bit 5 – SIGRD: Signature Row Read
       If this bit is written to one at the same time as SPMEN, the next LPM instruction within three clock cycles will
       read a byte from the signature row into the destination register. See ”Reading the Signature Row from Software”
       on page 280 for details. An SPM instruction within four cycles after SIGRD and SPMEN are set will have no
       effect. This operation is reserved for future use and should not be used.

       • Bit 4 – RWWSRE: Read-While-Write Section Read Enable
       When programming (Page Erase or Page Write) to the RWW section, the RWW section is blocked for reading
       (the RWWSB will be set by hardware). To re-enable the RWW section, the user software must wait until the
       programming is completed (SPMEN will be cleared). Then, if the RWWSRE bit is written to one at the same
       time as SPMEN, the next SPM instruction within four clock cycles re-enables the RWW section. The RWW
       section cannot be re-enabled while the Flash is busy with a Page Erase or a Page Write (SPMEN is set). If the
       RWWSRE bit is written while the Flash is being loaded, the Flash load operation will abort and the data loaded
       will be lost.

       • Bit 3 – BLBSET: Boot Lock Bit Set
       If this bit is written to one at the same time as SPMEN, the next SPM instruction within four clock cycles sets
       Boot Lock bits and Memory Lock bits, according to the data in R0. The data in R1 and the address in the Z-
       pointer are ignored. The BLBSET bit will automatically be cleared upon completion of the Lock bit set, or if no
       SPM instruction is executed within four clock cycles.
       An LPM instruction within three cycles after BLBSET and SPMEN are set in the SPMCSR Register, will read
       either the Lock bits or the Fuse bits (depending on Z0 in the Z-pointer) into the destination register. See
       ”Reading the Fuse and Lock Bits from Software” on page 279 for details.

       • Bit 2 – PGWRT: Page Write
       If this bit is written to one at the same time as SPMEN, the next SPM instruction within four clock cycles
       executes Page Write, with the data stored in the temporary buffer. The page address is taken from the high part
       of the Z-pointer. The data in R1 and R0 are ignored. The PGWRT bit will auto-clear upon completion of a Page




        2020 Microchip Technology Inc.                     Data Sheet Complete                     DS40002061B-page 287
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Write, or if no SPM instruction is executed within four clock cycles. The CPU is halted during the entire Page
Write operation if the NRWW section is addressed.

• Bit 1 – PGERS: Page Erase
If this bit is written to one at the same time as SPMEN, the next SPM instruction within four clock cycles
executes Page Erase. The page address is taken from the high part of the Z-pointer. The data in R1 and R0 are
ignored. The PGERS bit will auto-clear upon completion of a Page Erase, or if no SPM instruction is executed
within four clock cycles. The CPU is halted during the entire Page Write operation if the NRWW section is
addressed.

• Bit 0 – SPMEN: Store Program Memory
This bit enables the SPM instruction for the next four clock cycles. If written to one together with either
RWWSRE, BLBSET, PGWRT or PGERS, the following SPM instruction will have a special meaning, see
description above. If only SPMEN is written, the following SPM instruction will store the value in R1:R0 in the
temporary page buffer addressed by the Z-pointer. The LSB of the Z-pointer is ignored. The SPMEN bit will
auto-clear upon completion of an SPM instruction, or if no SPM instruction is executed within four clock cycles.
During Page Erase and Page Write, the SPMEN bit remains high until the operation is completed.
Writing any other combination than “10001”, “01001”, “00101”, “00011” or “00001” in the lower five bits will have
no effect.




 2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 288
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P


28.    Memory Programming

28.1   Program And Data Memory Lock Bits
       The ATmega 48A/48PA provides two Lock bits and the ATmega88A/88PA/168A/168PA/328/328Pprovides six
       Lock bits. These can be left unprogrammed (“1”) or can be programmed (“0”) to obtain the additional features
       listed in Table 28-2. The Lock bits can only be erased to “1” with the Chip Erase command.
       The ATmega 48A/48PA has no separate Boot Loader section, and the SPM instruction is enabled for the whole
       Flash if the SELFPRGEN fuse is programmed (“0”). Otherwise the SPM instruction is disabled.

       Table 28-1.        Lock Bit Byte(1)
                Lock Bit Byte                 Bit No        Description               Default Value
                                                   7        –                         1 (unprogrammed)
                                                   6        –                         1 (unprogrammed)
                (2)
        BLB12                                      5        Boot Lock bit             1 (unprogrammed)
                (2)
        BLB11                                      4        Boot Lock bit             1 (unprogrammed)
        BLB02(2)                                   3        Boot Lock bit             1 (unprogrammed)
                (2)
        BLB01                                      2        Boot Lock bit             1 (unprogrammed)
        LB2                                        1        Lock bit                  1 (unprogrammed)
        LB1                                        0        Lock bit                  1 (unprogrammed)

       Notes:    1.     “1” means unprogrammed, “0” means programmed.
                 2.     Only on ATmega88A/88PA/168A/168PA/328/328P.

       Table 28-2.        Lock Bit Protection Modes(1)(2)
                      Memory Lock Bits                 Protection Type
          LB Mode              LB2           LB1
                1               1             1        No memory lock features enabled.
                                                       Further programming of the Flash and EEPROM is disabled in
                2               1             0        Parallel and Serial Programming mode. The Fuse bits are
                                                       locked in both Serial and Parallel Programming mode.(1)
                                                       Further programming and verification of the Flash and EEPROM
                                                       is disabled in Parallel and Serial Programming mode. The Boot
                3               0             0
                                                       Lock bits and Fuse bits are locked in both Serial and Parallel
                                                       Programming mode.(1)
       Notes:    1.     Program the Fuse bits and Boot Lock bits before programming the LB1 and LB2.
                 2.     “1” means unprogrammed, “0” means programmed




        2020 Microchip Technology Inc.                                Data Sheet Complete                        DS40002061B-page 289
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 28-3.    Lock Bit Protection Modes(1)(2). Only ATmega88A/88PA/168A/168PA/328/328P.
         BLB0 Mode        BLB02       BLB01
                                               No restrictions for SPM or LPM accessing the Application
                1            1            1
                                               section.
                2            1            0    SPM is not allowed to write to the Application section.
                                               SPM is not allowed to write to the Application section, and LPM
                                               executing from the Boot Loader section is not allowed to read
                3            0            0    from the Application section. If Interrupt Vectors are placed in
                                               the Boot Loader section, interrupts are disabled while executing
                                               from the Application section.
                                               LPM executing from the Boot Loader section is not allowed to
                                               read from the Application section. If Interrupt Vectors are placed
                4            0            1
                                               in the Boot Loader section, interrupts are disabled while
                                               executing from the Application section.
         BLB1 Mode        BLB12       BLB11
                                               No restrictions for SPM or LPM accessing the Boot Loader
                1            1            1
                                               section.
                2            1            0    SPM is not allowed to write to the Boot Loader section.
                                               SPM is not allowed to write to the Boot Loader section, and LPM
                                               executing from the Application section is not allowed to read
                3            0            0    from the Boot Loader section. If Interrupt Vectors are placed in
                                               the Application section, interrupts are disabled while executing
                                               from the Boot Loader section.
                                               LPM executing from the Application section is not allowed to
                                               read from the Boot Loader section. If Interrupt Vectors are
                4            0            1
                                               placed in the Application section, interrupts are disabled while
                                               executing from the Boot Loader section.
       Notes:   1.   Program the Fuse bits and Boot Lock bits before programming the LB1 and LB2.
                2.   “1” means unprogrammed, “0” means programmed


28.2   Fuse Bits
       The ATmega48A/PA/88A/PA/168A/PA/328/P has three Fuse bytes. Table 28-4 - Table 28-9 on page 292
       describe briefly the functionality of all the fuses and how they are mapped into the Fuse bytes. Note that the
       fuses are read as logical zero, “0”, if they are programmed.

       Table 28-4.    Extended Fuse Byte for ATmega 48A/48PA
        Extended Fuse Byte            Bit No    Description                       Default Value
        –                                 7     –                                 1
        –                                 6     –                                 1
        –                                 5     –                                 1
        –                                 4     –                                 1
        –                                 3     –                                 1
        –                                 2     –                                 1
        –                                 1     –                                 1
        SELFPRGEN                         0     Self Programming Enable           1 (unprogrammed)




        2020 Microchip Technology Inc.                        Data Sheet Complete                            DS40002061B-page 290
                                           ATmega48A/PA/88A/PA/168A/PA/328/P


Table 28-5.          Extended Fuse Byte for ATmega88A/88PA/168A/168PA
 Extended Fuse Byte              Bit No    Description                        Default Value
 –                                 7       –                                  1
 –                                 6       –                                  1
 –                                 5       –                                  1
 –                                 4       –                                  1
 –                                 3       –                                  1
                                           Select Boot Size
                                           (see
 BOOTSZ1                           2       Table 27-7 on page 284 and         0 (programmed)(1)
                                           Table 27-10 on page 285
                                           for details)
                                           Select Boot Size
                                           (see
 BOOTSZ0                           1       Table 27-7 on page 284 and         0 (programmed)(1)
                                           Table 27-10 on page 285
                                           for details)
 BOOTRST                           0       Select Reset Vector                1 (unprogrammed)

Note:   1.     The default value of BOOTSZ[1:0] results in maximum Boot Size. See ”Pin Name Mapping” on page 295.



Table 28-6.          Extended Fuse Byte for ATmega328/328P
 Extended Fuse Byte              Bit No    Description                            Default Value
 –                                 7       –                                      1
 –                                 6       –                                      1
 –                                 5       –                                      1
 –                                 4       –                                      1
 –                                 3       –                                      1
                    (1)
 BODLEVEL2                         2       Brown-out Detector trigger level       1 (unprogrammed)
 BODLEVEL1(1)                      1       Brown-out Detector trigger level       1 (unprogrammed)
                    (1)
 BODLEVEL0                         0       Brown-out Detector trigger level       1 (unprogrammed)
Note:   1.     See Table 29-12 on page 314 for BODLEVEL Fuse decoding.



Table 28-7.          Fuse High Byte for ATmega48A/48PA/88A/88PA/168A/168PA
 High Fuse Byte                  Bit No    Description                            Default Value
              (1)
 RSTDISBL                          7       External Reset Disable                 1 (unprogrammed)
 DWEN                              6       debugWIRE Enable                       1 (unprogrammed)
                                           Enable Serial Program and Data         0 (programmed, SPI
 SPIEN(2)                          5
                                           Downloading                            programming enabled)
 WDTON(3)                          4       Watchdog Timer Always On               1 (unprogrammed)
                                           EEPROM memory is preserved             1 (unprogrammed),
 EESAVE                            3
                                           through the Chip Erase                 EEPROM not reserved




 2020 Microchip Technology Inc.                         Data Sheet Complete                             DS40002061B-page 291
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Table 28-7.           Fuse High Byte for ATmega48A/48PA/88A/88PA/168A/168PA (Continued)
 High Fuse Byte                    Bit No    Description                           Default Value
 BODLEVEL2(4)                         2      Brown-out Detector trigger level      1 (unprogrammed)
                     (4)
 BODLEVEL1                            1      Brown-out Detector trigger level      1 (unprogrammed)
                     (4)
 BODLEVEL0                            0      Brown-out Detector trigger level      1 (unprogrammed)
Notes:   1.     See ”Alternate Functions of Port C” on page 94 for description of RSTDISBL Fuse.
         2.     The SPIEN Fuse is not accessible in serial programming mode.
         3.     See ”WDTCSR – Watchdog Timer Control Register” on page 63 for details.
         4.     See Table 29-12 on page 314 for BODLEVEL Fuse decoding.



Table 28-8.           Fuse High Byte for ATmega328/328P
 High Fuse Byte                    Bit No    Description                        Default Value
               (1)
 RSTDISBL                             7      External Reset Disable             1 (unprogrammed)
 DWEN                                 6      debugWIRE Enable                   1 (unprogrammed)
                                             Enable Serial Program and          0 (programmed, SPI
 SPIEN(2)                             5
                                             Data Downloading                   programming enabled)
 WDTON(3)                             4      Watchdog Timer Always On           1 (unprogrammed)
                                             EEPROM memory is
                                                                                1 (unprogrammed), EEPROM
 EESAVE                               3      preserved through the Chip
                                                                                not reserved
                                             Erase
                                             Select Boot Size
                                             (see
                                             Table 27-7 on page 284,
 BOOTSZ1                              2      Table 27-10 on page 285 and        0 (programmed)(4)

                                             Table 27-13 on page 286
                                             for details)
                                             Select Boot Size
                                             (see
                                             Table 27-7 on page 284,
 BOOTSZ0                              1      Table 27-10 on page 285 and        0 (programmed)(4)

                                             Table 27-13 on page 286
                                             for details)
 BOOTRST                              0      Select Reset Vector                1 (unprogrammed)

Notes:   1.     See ”Alternate Functions of Port C” on page 94 for description of RSTDISBL Fuse.
         2.     The SPIEN Fuse is not accessible in serial programming mode.
         3.     See ”WDTCSR – Watchdog Timer Control Register” on page 63 for details.
         4.     The default value of BOOTSZ[1:0] results in maximum Boot Size. See ”Pin Name Mapping” on page 295.



Table 28-9.           Fuse Low Byte
 Low Fuse Byte                     Bit No    Description                        Default Value
         (4)
 CKDIV8                               7      Divide clock by 8                  0 (programmed)
         (3)
 CKOUT                                6      Clock output                       1 (unprogrammed)
 SUT1                                 5      Select start-up time               1 (unprogrammed)(1)
 SUT0                                 4      Select start-up time               0 (programmed)(1)




 2020 Microchip Technology Inc.                            Data Sheet Complete                        DS40002061B-page 292
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 28-9.      Fuse Low Byte (Continued)
        Low Fuse Byte                  Bit No     Description                      Default Value
        CKSEL3                            3       Select Clock source              0 (programmed)(2)
        CKSEL2                            2       Select Clock source              0 (programmed)(2)
        CKSEL1                            1       Select Clock source              1 (unprogrammed)(2)
        CKSEL0                            0       Select Clock source              0 (programmed)(2)
       Note:   1.     The default value of SUT1...0 results in maximum start-up time for the default clock source. See Table 9-12 on
                      page 43 for details.
               2.     The default setting of CKSEL3...0 results in internal RC Oscillator @ 8MHz. See Table 9-11 on page 43 for
                      details.
               3.     The CKOUT Fuse allows the system clock to be output on PORTB0. See ”Clock Output Buffer” on page 45 for
                      details.
               4.     See ”System Clock Prescaler” on page 45 for details.
       The status of the Fuse bits is not affected by Chip Erase. Note that the Fuse bits are locked if Lock bit1 (LB1) is
       programmed. Program the Fuse bits before programming the Lock bits.

28.2.1 Latching of Fuses
       The fuse values are latched when the device enters programming mode and changes of the fuse values will
       have no effect until the part leaves Programming mode. This does not apply to the EESAVE Fuse which will
       take effect once it is programmed. The fuses are also latched on Power-up in Normal mode.

28.3   Signature Bytes
       All AVR microcontrollers have a three-byte signature code which identifies the device. This code can be read in
       both serial and parallel mode, also when the device is locked. The three bytes reside in a separate address
       space. For the ATmega48A/PA/88A/PA/168A/PA/328/P the signature bytes are given in Table 28-10.

       Table 28-10.     Device ID
                                                Signature Bytes Address
        Part                                    0x000                   0x001                 0x002
        ATmega48A                               0x1E                    0x92                  0x05
        ATmega48PA                              0x1E                    0x92                  0x0A
        ATmega88A                               0x1E                    0x93                  0x0A
        ATmega88PA                              0x1E                    0x93                  0x0F
        ATmega168A                              0x1E                    0x94                  0x06
        ATmega168PA                             0x1E                    0x94                  0x0B
        ATmega328                               0x1E                    0x95                  0x14
        ATmega328P                              0x1E                    0x95                  0x0F


28.4   Calibration Byte
       The ATmega48A/PA/88A/PA/168A/PA/328/P has a byte calibration value for the Internal RC Oscillator. This
       byte resides in the high byte of address 0x000 in the signature address space. During reset, this byte is
       automatically written into the OSCCAL Register to ensure correct frequency of the calibrated RC Oscillator.




        2020 Microchip Technology Inc.                          Data Sheet Complete                          DS40002061B-page 293
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

28.5   Page Size


       Table 28-11.   No. of Words in a Page and No. of Pages in the Flash
                                                                       No. of
        Device                Flash Size   Page Size    PCWORD         Pages      PCPAGE     PCMSB
                              2K words
        ATmega48A                          32 words       PC[4:0]        64       PC[10:5]     10
                              (4Kbytes)
                              2K words
        ATmega48PA                         32 words       PC[4:0]        64       PC[10:5]     10
                              (4Kbytes)
                              4K words
        ATmega88A                          32 words       PC[4:0]       128       PC[11:5]     11
                              (8Kbytes)
                              4K words
        ATmega88PA                         32 words       PC[4:0]       128       PC[11:5]     11
                              (8Kbytes)
                              8K words
        ATmega168A                         64 words       PC[5:0]       128       PC[12:6]     12
                              (16Kbytes)

                              8K words
        ATmega168PA                        64 words       PC[5:0]       128       PC[12:6]     12
                              (16Kbytes)

                              16K words
        ATmega328                          64 words       PC[5:0]       256       PC[13:6]     13
                              (32Kbytes)
                              16K words
        ATmega328P                         64 words       PC[5:0]       256       PC[13:6]     13
                              (32Kbytes)



       Table 28-12.   No. of Words in a Page and No. of Pages in the EEPROM
                               EEPROM       Page                     No. of
        Device                   Size       Size       PCWORD        Pages       PCPAGE      EEAMSB
        ATmega48A               256bytes   4bytes      EEA[1:0]        64        EEA[7:2]      7
        ATmega48PA              256bytes   4bytes      EEA[1:0]        64        EEA[7:2]      7
        ATmega88A               512bytes   4bytes      EEA[1:0]       128        EEA[8:2]      8
        ATmega88PA              512bytes   4bytes      EEA[1:0]       128        EEA[8:2]      8
        ATmega168A              512bytes   4bytes      EEA[1:0]       128        EEA[8:2]      8
        ATmega168PA             512bytes   4bytes      EEA[1:0]       128        EEA[8:2]      8
        ATmega328               1Kbytes    4bytes      EEA[1:0]       256        EEA[9:2]      9
        ATmega328P              1Kbytes    4bytes      EEA[1:0]       256        EEA[9:2]      9


28.6   Parallel Programming Parameters, Pin Mapping, and Commands
       This section describes how to parallel program and verify Flash Program memory, EEPROM Data memory,
       Memory Lock bits, and Fuse bits in the ATmega48A/PA/88A/PA/168A/PA/328/P. Pulses are assumed to be at
       least 250 ns unless otherwise noted.

28.6.1 Signal Names
       In this section, some pins of the ATmega48A/PA/88A/PA/168A/PA/328/P are referenced by signal names
       describing their functionality during parallel programming, see Figure 28-1 and Table 28-13. Pins not described
       in the following table are referenced by pin names.




        2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 294
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

The XA1/XA0 pins determine the action executed when the XTAL1 pin is given a positive pulse. The bit coding
is shown in Table 28-15.
When pulsing WR or OE, the command loaded determines the action executed. The different Commands are
shown in Table 28-16.

Figure 28-1.     Parallel Programming
                                                                                    +4.5 - 5.5V
                                       RDY/BSY           PD1
                                                                              VCC
                                             OE          PD2                        +4.5 - 5.5V

                                            WR           PD3                AVCC

                                            BS1          PD4     PC[1:0]:PB[5:0]                  DATA
                                            XA0          PD5

                                            XA1          PD6

                                         PAGEL           PD7

                                           +12 V         RESET

                                            BS2          PC2

                                                         XTAL1

                                                         GND




Note:    VCC - 0.3V < AVCC < VCC + 0.3V, however, AVCC should always be within 4.5 - 5.5V


Table 28-13.     Pin Name Mapping
 Signal Name in
 Programming Mode                  Pin Name         I/O        Function
                                                               0: Device is busy programming, 1: Device is
 RDY/BSY                             PD1            O
                                                               ready for new command
 OE                                  PD2             I         Output Enable (Active low)
 WR                                  PD3             I         Write Pulse (Active low)
                                                               Byte Select 1 (“0” selects Low byte, “1” selects
 BS1                                 PD4             I
                                                               High byte)
 XA0                                 PD5             I         XTAL Action Bit 0
 XA1                                 PD6             I         XTAL Action Bit 1
                                                               Program memory and EEPROM Data Page
 PAGEL                               PD7             I
                                                               Load
                                                               Byte Select 2 (“0” selects Low byte, “1” selects
 BS2                                 PC2             I
                                                               2’nd High byte)
 DATA                         {PC[1:0]: PB[5:0]}    I/O        Bi-directional Data bus (Output when OE is low)


Table 28-14.     Pin Values Used to Enter Programming Mode
           Pin                        Symbol                                               Value
         PAGEL                     Prog_enable[3]                                             0
           XA1                     Prog_enable[2]                                             0
           XA0                     Prog_enable[1]                                             0
           BS1                     Prog_enable[0]                                             0




 2020 Microchip Technology Inc.                               Data Sheet Complete                          DS40002061B-page 295
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 28-15.     XA1 and XA0 Coding
          XA1           XA0      Action when XTAL1 is Pulsed
             0           0       Load Flash or EEPROM Address (High or low address byte determined by BS1).
             0           1       Load Data (High or Low data byte for Flash determined by BS1).
             1           0       Load Command
             1           1       No Action, Idle


       Table 28-16.     Command Byte Bit Coding
          Command Byte           Command Executed
             1000 0000           Chip Erase
             0100 0000           Write Fuse bits
             0010 0000           Write Lock bits
             0001 0000           Write Flash
             0001 0001           Write EEPROM
             0000 1000           Read Signature Bytes and Calibration byte
             0000 0100           Read Fuse and Lock bits
             0000 0010           Read Flash
             0000 0011           Read EEPROM


28.7   Parallel Programming

28.7.1 Enter Programming Mode
       The following algorithm puts the device in Parallel (High-voltage) Programming mode:
        1.       Set Prog_enable pins listed in Table 28-14 on page 295 to “0000”, RESET pin to 0V and VCC to 0V.
        2.       Apply 4.5 - 5.5V between VCC and GND.
       Ensure that VCC reaches at least 1.8V within the next 20 µs.
        1.       Wait 20 - 60 µs, and apply 11.5 - 12.5V to RESET.
        2.       Keep the Prog_enable pins unchanged for at least 10µs after the High-voltage has been applied to ensure
                 the Prog_enable Signature has been latched.
        3.       Wait at least 300 µs before giving any parallel programming commands.
        4.       Exit Programming mode by power the device down or by bringing RESET pin to 0V.
       If the rise time of the VCC is unable to fulfill the requirements listed above, the following alternative algorithm can
       be used.
        1.       Set Prog_enable pins listed in Table 28-14 on page 295 to “0000”, RESET pin to 0V and VCC to 0V.
        2.       Apply 4.5 - 5.5V between VCC and GND.
        3.       Monitor VCC, and as soon as VCC reaches 0.9 - 1.1V, apply 11.5 - 12.5V to RESET.
        4.       Keep the Prog_enable pins unchanged for at least 10µs after the High-voltage has been applied to ensure
                 the Prog_enable Signature has been latched.
        5.       Wait until VCC actually reaches 4.5 -5.5V before giving any parallel programming commands.
        6.       Exit Programming mode by power the device down or by bringing RESET pin to 0V.




        2020 Microchip Technology Inc.                        Data Sheet Complete                       DS40002061B-page 296
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

28.7.2 Considerations for Efficient Programming
       The loaded command and address are retained in the device during programming. For efficient programming,
       the following should be considered.
              The command needs only be loaded once when writing or reading multiple memory locations.
              Skip writing the data value 0xFF, that is the contents of the entire EEPROM (unless the EESAVE Fuse is
               programmed) and Flash after a Chip Erase.
              Address high byte needs only be loaded before programming or reading a new 256 word window in Flash
               or 256 byte EEPROM. This consideration also applies to Signature bytes reading.

28.7.3 Chip Erase
       The Chip Erase will erase the Flash and EEPROM(1) memories plus Lock bits. The Lock bits are not reset until
       the program memory has been completely erased. The Fuse bits are not changed. A Chip Erase must be
       performed before the Flash and/or EEPROM are reprogrammed.
       Note:     1. The EEPRPOM memory is preserved during Chip Erase if the EESAVE Fuse is programmed.
       Load Command “Chip Erase”
        1.     Set XA1, XA0 to “10”. This enables command loading.
        2.     Set BS1 to “0”.
        3.     Set DATA to “1000 0000”. This is the command for Chip Erase.
        4.     Give XTAL1 a positive pulse. This loads the command.
        5.     Give WR a negative pulse. This starts the Chip Erase. RDY/BSY goes low.
        6.     Wait until RDY/BSY goes high before loading a new command.

28.7.4 Programming the Flash
       The Flash is organized in pages, see Table 28-11 on page 294. When programming the Flash, the program
       data is latched into a page buffer. This allows one page of program data to be programmed simultaneously. The
       following procedure describes how to program the entire Flash memory:
       A. Load Command “Write Flash”
        1.     Set XA1, XA0 to “10”. This enables command loading.
        2.     Set BS1 to “0”.
        3.     Set DATA to “0001 0000”. This is the command for Write Flash.
        4.     Give XTAL1 a positive pulse. This loads the command.
       B. Load Address Low byte
        1.     Set XA1, XA0 to “00”. This enables address loading.
        2.     Set BS1 to “0”. This selects low address.
        3.     Set DATA = Address low byte (0x00 - 0xFF).
        4.     Give XTAL1 a positive pulse. This loads the address low byte.
       C. Load Data Low Byte
        1.     Set XA1, XA0 to “01”. This enables data loading.
        2.     Set DATA = Data low byte (0x00 - 0xFF).
        3.     Give XTAL1 a positive pulse. This loads the data byte.
       D. Load Data High Byte
        1.     Set BS1 to “1”. This selects high data byte.
        2.     Set XA1, XA0 to “01”. This enables data loading.
        3.     Set DATA = Data high byte (0x00 - 0xFF).



        2020 Microchip Technology Inc.                       Data Sheet Complete                  DS40002061B-page 297
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

 4.     Give XTAL1 a positive pulse. This loads the data byte.
E. Latch Data
 1.     Set BS1 to “1”. This selects high data byte.
 2.     Give PAGEL a positive pulse. This latches the data bytes. (See Figure 28-3 for signal waveforms)
F. Repeat B through E until the entire buffer is filled or until all data within the page is loaded.
While the lower bits in the address are mapped to words within the page, the higher bits address the pages
within the FLASH. This is illustrated in Figure 28-2 on page 298. Note that if less than eight bits are required to
address words in the page (pagesize < 256), the most significant bit(s) in the address low byte are used to
address the page when performing a Page Write.
G. Load Address High byte
 1.     Set XA1, XA0 to “00”. This enables address loading.
 2.     Set BS1 to “1”. This selects high address.
 3.     Set DATA = Address high byte (0x00 - 0xFF).
 4.     Give XTAL1 a positive pulse. This loads the address high byte.
H. Program Page
 1.     Give WR a negative pulse. This starts programming of the entire page of data. RDY/BSY goes low.
 2.     Wait until RDY/BSY goes high (See Figure 28-3 for signal waveforms).
I. Repeat B through H until the entire Flash is programmed or until all data has been programmed.
J. End Page Programming
 1.     Set XA1, XA0 to “10”. This enables command loading.
 2.     Set DATA to “0000 0000”. This is the command for No Operation.
 3.     Give XTAL1 a positive pulse. This loads the command, and the internal write signals are reset.

Figure 28-2.    Addressing the Flash Which is Organized in Pages(1)
                                       PCMSB            PAGEMSB
                           PROGRAM
                                               PCPAGE    PCWORD
                           COUNTER

                                   PAGE ADDRESS               WORD ADDRESS
                                   WITHIN THE FLASH           WITHIN A PAGE

                     PROGRAM MEMORY                                           PAGE       PCWORD[PAGEMSB:0]:
                           PAGE                                                          00
                                                                      INSTRUCTION WORD

                                                                                         01

                                                                                         02




                                                                                         PAGEEND




Note:     1. PCPAGE and PCWORD are listed in Table 28-11 on page 294.




 2020 Microchip Technology Inc.                         Data Sheet Complete                       DS40002061B-page 298
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 28-3.     Programming the Flash Waveforms(1)
                                                                                                        F



                                   A        B          C           D        E      B           C               D         E      G         H
                                  0x10   ADDR. LOW   DATA LOW   DATA HIGH   XX   ADDR. LOW   DATA LOW       DATA HIGH   XX   ADDR. HIGH       XX
                          DATA


                            XA1


                            XA0


                            BS1


                          XTAL1


                            WR


                        RDY/BSY


                     RESET +12V


                            OE


                         PAGEL


                            BS2




      Note:     1. “XX” is don’t care. The letters refer to the programming description above.

28.7.5 Programming the EEPROM
      The EEPROM is organized in pages, see Table 28-12 on page 294. When programming the EEPROM, the
      program data is latched into a page buffer. This allows one page of data to be programmed simultaneously. The
      programming algorithm for the EEPROM data memory is as follows (refer to ”Programming the Flash” on page
      297 for details on Command, Address and Data loading):
       1.     A: Load Command “0001 0001”.
       2.     G: Load Address High Byte (0x00 - 0xFF).
       3.     B: Load Address Low Byte (0x00 - 0xFF).
       4.     C: Load Data (0x00 - 0xFF).
       5.     E: Latch data (give PAGEL a positive pulse).
      K: Repeat 3 through 5 until the entire buffer is filled.
      L: Program EEPROM page
       1.     Set BS1 to “0”.
       2.     Give WR a negative pulse. This starts programming of the EEPROM page. RDY/BSY goes low.
       3.     Wait until to RDY/BSY goes high before programming the next page (See Figure 28-4 for signal
              waveforms).




       2020 Microchip Technology Inc.                                           Data Sheet Complete                                               DS40002061B-page 299
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 28-4.     Programming the EEPROM Waveforms
                                                                                              K


                                     A        G            B         C       E     B         C       E   L
                                    0x11   ADDR. HIGH   ADDR. LOW   DATA    XX   ADDR. LOW   DATA   XX
                           DATA


                             XA1


                             XA0


                             BS1


                           XTAL1


                             WR


                         RDY/BSY


                      RESET +12V


                             OE


                          PAGEL


                             BS2




28.7.6 Reading the Flash
       The algorithm for reading the Flash memory is as follows (refer to ”Programming the Flash” on page 297 for
       details on Command and Address loading):
        1.   A: Load Command “0000 0010”.
        2.   G: Load Address High Byte (0x00 - 0xFF).
        3.   B: Load Address Low Byte (0x00 - 0xFF).
        4.   Set OE to “0”, and BS1 to “0”. The Flash word low byte can now be read at DATA.
        5.   Set BS1 to “1”. The Flash word high byte can now be read at DATA.
        6.   Set OE to “1”.

28.7.7 Reading the EEPROM
       The algorithm for reading the EEPROM memory is as follows (refer to ”Programming the Flash” on page 297 for
       details on Command and Address loading):
        1.   A: Load Command “0000 0011”.
        2.   G: Load Address High Byte (0x00 - 0xFF).
        3.   B: Load Address Low Byte (0x00 - 0xFF).
        4.   Set OE to “0”, and BS1 to “0”. The EEPROM Data byte can now be read at DATA.
        5.   Set OE to “1”.




        2020 Microchip Technology Inc.                                    Data Sheet Complete               DS40002061B-page 300
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

28.7.8 Programming the Fuse Low Bits
       The algorithm for programming the Fuse Low bits is as follows (refer to ”Programming the Flash” on page 297
       for details on Command and Data loading):
        1.   A: Load Command “0100 0000”.
        2.   C: Load Data Low Byte. Bit n = “0” programs and bit n = “1” erases the Fuse bit.
        3.   Give WR a negative pulse and wait for RDY/BSY to go high.

28.7.9 Programming the Fuse High Bits
       The algorithm for programming the Fuse High bits is as follows (refer to ”Programming the Flash” on page 297
       for details on Command and Data loading):
        1.   A: Load Command “0100 0000”.
        2.   C: Load Data Low Byte. Bit n = “0” programs and bit n = “1” erases the Fuse bit.
        3.   Set BS1 to “1” and BS2 to “0”. This selects high data byte.
        4.   Give WR a negative pulse and wait for RDY/BSY to go high.
        5.   Set BS1 to “0”. This selects low data byte.

28.7.10 Programming the Extended Fuse Bits
       The algorithm for programming the Extended Fuse bits is as follows (refer to ”Programming the Flash” on page
       297 for details on Command and Data loading):
        1.   A: Load Command “0100 0000”.
        2.   C: Load Data Low Byte. Bit n = “0” programs and bit n = “1” erases the Fuse bit.
        3.   Set BS1 to “0” and BS2 to “1”. This selects extended data byte.
        4.   Give WR a negative pulse and wait for RDY/BSY to go high.
        5.   Set BS2 to “0”. This selects low data byte.

       Figure 28-5.    Programming the FUSES Waveforms
                                                 Write Fuse Low byte                 Write Fuse high byte                 Write Extended Fuse byte

                                    A      C                           A       C                            A       C
                                   0x40   DATA     XX                  0x40   DATA     XX                   0x40   DATA     XX
                           DATA


                             XA1


                             XA0


                             BS1


                             BS2


                           XTAL1


                             WR


                         RDY/BSY


                      RESET +12V


                             OE


                          PAGEL




        2020 Microchip Technology Inc.                                    Data Sheet Complete                                        DS40002061B-page 301
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

28.7.11 Programming the Lock Bits
       The algorithm for programming the Lock bits is as follows (refer to ”Programming the Flash” on page 297 for
       details on Command and Data loading):
        1.   A: Load Command “0010 0000”.
        2.   C: Load Data Low Byte. Bit n = “0” programs the Lock bit. If LB mode 3 is programmed (LB1 and LB2 is
             programmed), it is not possible to program the Boot Lock bits by any External Programming mode.
        3.   Give WR a negative pulse and wait for RDY/BSY to go high.
       The Lock bits can only be cleared by executing Chip Erase.

28.7.12 Reading the Fuse and Lock Bits
       The algorithm for reading the Fuse and Lock bits is as follows (refer to ”Programming the Flash” on page 297 for
       details on Command loading):
        1.   A: Load Command “0000 0100”.
        2.   Set OE to “0”, BS2 to “0” and BS1 to “0”. The status of the Fuse Low bits can now be read at DATA (“0”
             means programmed).
        3.   Set OE to “0”, BS2 to “1” and BS1 to “1”. The status of the Fuse High bits can now be read at DATA (“0”
             means programmed).
        4.   Set OE to “0”, BS2 to “1”, and BS1 to “0”. The status of the Extended Fuse bits can now be read at DATA
             (“0” means programmed).
        5.   Set OE to “0”, BS2 to “0” and BS1 to “1”. The status of the Lock bits can now be read at DATA (“0” means
             programmed).
        6.   Set OE to “1”.

       Figure 28-6.   Mapping Between BS1, BS2 and the Fuse and Lock Bits During Read

                                 Fuse Low Byte               0



                                                                                   0
                                 Extended Fuse Byte          1
                                                                                         DATA
                                                       BS2


                                          Lock Bits          0
                                                                                   1



                                                                             BS1
                                    Fuse High Byte           1

                                                       BS2



28.7.13 Reading the Signature Bytes
       The algorithm for reading the Signature bytes is as follows (refer to ”Programming the Flash” on page 297 for
       details on Command and Address loading):
        1.   A: Load Command “0000 1000”.
        2.   B: Load Address Low Byte (0x00 - 0x02).
        3.   Set OE to “0”, and BS1 to “0”. The selected Signature byte can now be read at DATA.
        4.   Set OE to “1”.




        2020 Microchip Technology Inc.                      Data Sheet Complete                   DS40002061B-page 302
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

28.7.14 Reading the Calibration Byte
       The algorithm for reading the Calibration byte is as follows (refer to ”Programming the Flash” on page 297 for
       details on Command and Address loading):
         1.     A: Load Command “0000 1000”.
         2.     B: Load Address Low Byte, 0x00.
         3.     Set OE to “0”, and BS1 to “1”. The Calibration byte can now be read at DATA.
         4.     Set OE to “1”.

28.7.15 Parallel Programming Characteristics
       For characteristics of the Parallel Programming, see ”Parallel Programming Characteristics” on page 320.

28.8   Serial Downloading
       Both the Flash and EEPROM memory arrays can be programmed using the serial SPI bus while RESET is
       pulled to GND. The serial interface consists of pins SCK, MOSI (input) and MISO (output). After RESET is set
       low, the Programming Enable instruction needs to be executed first before program/erase operations can be
       executed. NOTE, in Table 28-17 on page 304, the pin mapping for SPI programming is listed. Not all parts use
       the SPI pins dedicated for the internal SPI interface.

       Figure 28-7.     Serial Programming and Verify(1)
                                                                                      +1.8 - 5.5V

                                                                                VCC

                                                                                      +1.8 - 5.5V(2)
                                                   MOSI
                                                                               AVCC
                                                   MISO

                                                    SCK

                                                                XTAL1




                                                                RESET



                                                                GND




       Notes:     1. If the device is clocked by the internal Oscillator, it is no need to connect a clock source to the XTAL1 pin.
                  2. VCC - 0.3V < AVCC < VCC + 0.3V, however, AVCC should always be within 1.8 - 5.5V
       When programming the EEPROM, an auto-erase cycle is built into the self-timed programming operation (in the
       Serial mode ONLY) and there is no need to first execute the Chip Erase instruction. The Chip Erase operation
       turns the content of every memory location in both the Program and EEPROM arrays into 0xFF.
       Depending on CKSEL Fuses, a valid clock must be present. The minimum low and high periods for the serial
       clock (SCK) input are defined as follows:
       Low:> 2 CPU clock cycles for fck < 12MHz, 3 CPU clock cycles for fck  12MHz
       High:> 2 CPU clock cycles for fck < 12MHz, 3 CPU clock cycles for fck  12MHz




        2020 Microchip Technology Inc.                            Data Sheet Complete                            DS40002061B-page 303
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

28.8.1 Serial Programming Pin Mapping

Table 28-17.   Pin Mapping Serial Programming
       Symbol                   Pins                   I/O                     Description
        MOSI                    PB3                     I                     Serial Data in
        MISO                    PB4                    O                     Serial Data out
        SCK                     PB5                     I                      Serial Clock


28.8.2 Serial Programming Algorithm
        When writing serial data to the ATmega48A/PA/88A/PA/168A/PA/328/P, data is clocked on the rising edge of
        SCK.
        When reading data from the ATmega48A/PA/88A/PA/168A/PA/328/P, data is clocked on the falling edge of
        SCK. See Figure 28-9 for timing details.
        To program and verify the ATmega48A/PA/88A/PA/168A/PA/328/P in the serial programming mode, the
        following sequence is recommended (See Serial Programming Instruction set in Table 28-19 on page 305):
          1.    Power-up sequence:
                Apply power between VCC and GND while RESET and SCK are set to “0”. In some systems, the
                programmer can not ensure that SCK is held low during power-up. In this case, RESET must be given a
                positive pulse of at least two CPU clock cycles duration after SCK has been set to “0”.
          2.    Wait for at least 20ms and enable serial programming by sending the Programming Enable serial
                instruction to pin MOSI.
          3.    The serial programming instructions will not work if the communication is out of synchronization. When in
                sync. the second byte (0x53), will echo back when issuing the third byte of the Programming Enable
                instruction. Whether the echo is correct or not, all four bytes of the instruction must be transmitted. If the
                0x53 did not echo back, give RESET a positive pulse and issue a new Programming Enable command.
          4.    The Flash is programmed one page at a time. The memory page is loaded one byte at a time by supplying
                the 6 LSB of the address and data together with the Load Program Memory Page instruction. To ensure
                correct loading of the page, the data low byte must be loaded before data high byte is applied for a given
                address. The Program Memory Page is stored by loading the Write Program Memory Page instruction
                with the 7 MSB of the address. If polling (RDY/BSY) is not used, the user must wait at least tWD_FLASH
                before issuing the next page (See Table 28-18). Accessing the serial programming interface before the
                Flash write operation completes can result in incorrect programming.
          5.    A: The EEPROM array is programmed one byte at a time by supplying the address and data together with
                the appropriate Write instruction. An EEPROM memory location is first automatically erased before new
                data is written. If polling (RDY/BSY) is not used, the user must wait at least tWD_EEPROM before issuing the
                next byte (See Table 28-18). In a chip erased device, no 0xFFs in the data file(s) need to be programmed.
                B: The EEPROM array is programmed one page at a time. The Memory page is loaded one byte at a time
                by supplying the 6 LSB of the address and data together with the Load EEPROM Memory Page
                instruction. The EEPROM Memory Page is stored by loading the Write EEPROM Memory Page
                Instruction with the 7 MSB of the address. When using EEPROM page access only byte locations loaded
                with the Load EEPROM Memory Page instruction is altered. The remaining locations remain unchanged.
                If polling (RDY/BSY) is not used, the used must wait at least tWD_EEPROM before issuing the next byte (See
                Table 28-18). In a chip erased device, no 0xFF in the data file(s) need to be programmed.
          6.    Any memory location can be verified by using the Read instruction which returns the content at the
                selected address at serial output MISO.
          7.    At the end of the programming session, RESET can be set high to commence normal operation.




         2020 Microchip Technology Inc.                       Data Sheet Complete                       DS40002061B-page 304
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

          8.    Power-off sequence (if needed):
                Set RESET to “1”.
                Turn VCC power off.


        Table 28-18.     Typical Wait Delay Before Writing the Next Flash or EEPROM Location
          Symbol                                                           Minimum Wait Delay
          tWD_FLASH                                                                  4.5ms
          tWD_EEPROM                                                                 3.6ms
          tWD_ERASE                                                                  9.0ms
          tWD_FUSE                                                                   4.5ms


28.8.3 Serial Programming Instruction set
        Table 28-19 on page 305 and Figure 28-8 on page 306 describes the Instruction set.

Table 28-19.   Serial Programming Instruction Set (Hexadecimal values)
                                                                               Instruction Format
 Instruction/Operation                               Byte 1               Byte 2               Byte 3                 Byte4
 Programming Enable                                   $AC                   $53                  $00                   $00
 Chip Erase (Program Memory/EEPROM)                   $AC                   $80                  $00                   $00
 Poll RDY/BSY                                         $F0                   $00                  $00               data byte out
 Load Instructions
 Load Extended Address byte(1)                        $4D                   $00              Extended adr              $00
 Load Program Memory Page, High byte                  $48                   $00                adr LSB           high data byte in
 Load Program Memory Page, Low byte                   $40                   $00                adr LSB           low data byte in
 Load EEPROM Memory Page (page access)                $C1                   $00              0000 000aa            data byte in
 Read Instructions
 Read Program Memory, High byte                       $28                adr MSB               adr LSB          high data byte out
 Read Program Memory, Low byte                        $20                adr MSB               adr LSB           low data byte out
 Read EEPROM Memory                                   $A0                0000 00aa            aaaa aaaa            data byte out
 Read Lock bits                                       $58                   $00                  $00               data byte out
 Read Signature Byte                                  $30                   $00              0000 000aa            data byte out
 Read Fuse bits                                       $50                   $00                  $00               data byte out
 Read Fuse High bits                                  $58                   $08                  $00               data byte out
 Read Extended Fuse Bits                              $50                   $08                  $00               data byte out
 Read Calibration Byte                                $38                   $00                  $00               data byte out
 Write Instructions(6)
 Write Program Memory Page                            $4C                adr MSB(8)           adr LSB(8)               $00
 Write EEPROM Memory                                  $C0                0000 00aa            aaaa aaaa            data byte in
 Write EEPROM Memory Page (page access)               $C2                0000 00aa            aaaa aa00                $00
 Write Lock bits                                      $AC                   $E0                  $00               data byte in




          2020 Microchip Technology Inc.                      Data Sheet Complete                          DS40002061B-page 305
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

Table 28-19.      Serial Programming Instruction Set (Hexadecimal values) (Continued)
                                                                                                       Instruction Format
 Instruction/Operation                                                Byte 1                    Byte 2                        Byte 3                    Byte4
 Write Fuse bits                                                          $AC                     $A0                           $00                  data byte in
 Write Fuse High bits                                                     $AC                     $A8                           $00                  data byte in
 Write Extended Fuse Bits                                                 $AC                     $A4                           $00                  data byte in
Notes:   1.    Not all instructions are applicable for all parts.
         2.    a = address.
         3.    Bits are programmed ‘0’, unprogrammed ‘1’.
         4.    To ensure future compatibility, unused Fuses and Lock bits should be unprogrammed (‘1’) .
         5.    Refer to the corresponding section for Fuse and Lock bits, Calibration and Signature bytes and Page size.
         6.    Instructions accessing program memory use a word address. This address may be random within the page range.
         7.    See http://www.microchip.com for Application Notes regarding programming and programmers.
         8.    WORDS

         If the LSB in RDY/BSY data byte out is ‘1’, a programming operation is still pending. Wait until this bit returns ‘0’
         before the next instruction is carried out.
         Within the same page, the low data byte must be loaded prior to the high data byte.
         After data is loaded to the page buffer, program the EEPROM page, see Figure 28-8 on page 306.

Figure 28-8.      Serial Programming Instruction example
                                                                  Serial Programming Instruction
                       Load Program Memory Page (High/Low Byte)/                                                   Write Program Memory Page/
                       Load EEPROM Memory Page (page access)                                                       Write EEPROM Memory Page


              Byte 1              Byte 2         Byte 3              Byte 4                   Byte 1               Byte 2           Byte 3           Byte 4
                                   Adr
                                   Adrr M
                                        MSB
                                        MSSB      Adr LSB                                                          Adr MSB          Adr
                                                                                                                                    Adr LS
                                                                                                                                        LSB
                                                                                                                                         SB
                       Bit 15 B                               0                                         Bit 15 B                                0



                                                                                Page Buffer
                                                            Page Offset




                                                                                  Page 0


                                                                                  Page 1


                                                                                  Page 2
                                                                                                       Page Number




                                                                                 Page N-1


                                                                          Program Memory/
                                                                          EEPROM Memory




          2020 Microchip Technology Inc.                                         Data Sheet Complete                                         DS40002061B-page 306
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

28.8.4 SPI Serial Programming Characteristics

       Figure 28-9.   Serial Programming Waveforms
                        SERIAL DATA INPUT   MSB                                              LSB
                                   (MOSI)


                      SERIAL DATA OUTPUT    MSB                                              LSB
                                   (MISO)


                      SERIAL CLOCK INPUT
                                    (SCK)


                                  SAMPLE



       For characteristics of the SPI module see “SPI Timing Characteristics” on page 315.




        2020 Microchip Technology Inc.                  Data Sheet Complete                   DS40002061B-page 307
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P


29.       Electrical Characteristics – (TA = -40°C to 85°C)

29.1      Absolute Maximum Ratings*
 Operating Temperature . . . . . . . . . . . -55C to +125C                      *NOTICE:     Stresses beyond those listed under “Absolute
                                                                                               Maximum Ratings” may cause permanent dam-
 Storage Temperature. . . . . . . . . . . . . -65°C to +150°C                                  age to the device. This is a stress rating only and
                                                                                               functional operation of the device at these or
 Voltage on any Pin except RESET                                                               other conditions beyond those indicated in the
 with respect to Ground . . . . . . . . . .-0.5V to VCC+0.5V                                   operational sections of this specification is not
                                                                                               implied. Exposure to absolute maximum rating
 Voltage on RESET with respect to Ground-0.5V to +13.0V                                        conditions for extended periods may affect
                                                                                               device reliability.
 Maximum Operating Voltage . . . . . . . . . . . . . . . . .6.0V

 DC Current per I/O Pin . . . . . . . . . . . . . . . . . . 40.0mA

 DC Current VCC and GND Pins. . . . . . . . . . . 200.0mA


29.2      DC Characteristics

29.2.1 ATmega48A DC Characteristics

Table 29-1.       ATmega48A DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol        Parameter                             Condition                                   Min.        Typ.(2)        Max.         Units
                                                     Active 1MHz, VCC = 2V                                     0.2           0.55          mA
                                                     Active 4MHz, VCC = 3V                                     1.2           3.5           mA
                                                     Active 8MHz, VCC = 5V                                     4.0            12           mA
               Power Supply Current(1)
                                                     Idle 1MHz, VCC = 2V                                      0.03           0.5           mA
                                                     Idle 4MHz, VCC = 3V                                      0.21           1.5           mA
 ICC
                                                     Idle 8MHz, VCC = 5V                                       0.9           5.5           mA
                                                     32kHz TOSC enabled, VCC = 1.8V                           0.75                         µA
               Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                              0.9                         µA
                                                     WDT enabled, VCC = 3V                                     3.9            15           µA
               Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                    0.1            2            µA
Notes:    1.   Values with “Minimizing Power Consumption” enabled (0xFF).
          2.   Typical values at 25C.
          3.   The current consumption values include input leakage current.




           2020 Microchip Technology Inc.                                     Data Sheet Complete                          DS40002061B-page 308
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

29.2.2 ATmega48PA DC Characteristics – Current Consumption

Table 29-2.       ATmega48PA DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)     Max.      Units
                                                     Active 1MHz, VCC = 2V                                   0.2       0.5
                                                     Active 4MHz, VCC = 3V                                   1.2       2.5
                                                     Active 8MHz, VCC = 5V                                   4.0        9
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.03       0.15
                                                     Idle 4MHz, VCC = 3V                                    0.21       0.7
 ICC
                                                     Idle 8MHz, VCC = 5V                                     0.9       2.7
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.75
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                            0.9
                                                                                                                                   µA
                                                     WDT enabled, VCC = 3V                                   3.9        8
                                       (3)
              Power-down mode
                                                     WDT disabled, VCC = 3V                                  0.1        2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.


29.2.3 ATmega88A DC Characteristics

Table 29-3.      ATmega88A DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                  0.2        0.55
                                                     Active 4MHz, VCC = 3V                                  1.2        3.5
                                                     Active 8MHz, VCC = 5V                                  4.1        12
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.03       0.5
                                                     Idle 4MHz, VCC = 3V                                    0.18       1.5
 ICC
                                                     Idle 8MHz, VCC = 5V                                    0.8        5.5
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.9
                                                                                                                                   µA
                                                     WDT enabled, VCC = 3V                                  3.9        15
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                 0.1         2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




          2020 Microchip Technology Inc.                                         Data Sheet Complete                DS40002061B-page 309
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

29.2.4 ATmega88PA DC Characteristics

Table 29-4.      ATmega88PA DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                     Min.    Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                  0.2        0.5
                                                     Active 4MHz, VCC = 3V                                  1.2        2.5
                                                     Active 8MHz, VCC = 5V                                  4.1         9
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.03      0.15
                                                     Idle 4MHz, VCC = 3V                                    0.18       0.7
 ICC
                                                     Idle 8MHz, VCC = 5V                                    0.8        2.7
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.9
                                                                                                                                   µA
                                                     WDT enabled, VCC = 3V                                  3.9         8
                                       (3)
              Power-down mode
                                                     WDT disabled, VCC = 3V                                 0.1         2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.



29.2.5 ATmega168A DC Characteristics

Table 29-5.      ATmega168A DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                   0.2      0.55
                                                     Active 4MHz, VCC = 3V                                   1.2       3.5
                                                     Active 8MHz, VCC = 5V                                   4.2       12
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.03       0.5
                                                     Idle 4MHz, VCC = 3V                                     0.2       1.5
 ICC
                                                     Idle 8MHz, VCC = 5V                                     0.9       5.5
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.75
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.83
                                                                                                                                  µA
                                                     WDT enabled, VCC = 3V                                   4.1       15
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                  0.1        2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




          2020 Microchip Technology Inc.                                         Data Sheet Complete                DS40002061B-page 310
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

29.2.6 ATmega168PA DC Characteristics

Table 29-6.      ATmega168PA DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                  0.2        0.5
                                                     Active 4MHz, VCC = 3V                                  1.2        2.5
                                                     Active 8MHz, VCC = 5V                                  4.2        9
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.03      0.15
                                                     Idle 4MHz, VCC = 3V                                    0.2        0.7
 ICC
                                                     Idle 8MHz, VCC = 5V                                    0.9        2.7
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.75
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.83
                                                                                                                                  µA
                                                     WDT enabled, VCC = 3V                                  4.1        8
                                       (3)
              Power-down mode
                                                     WDT disabled, VCC = 3V                                 0.1        2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.



29.2.7 ATmega328 DC Characteristics

Table 29-7.      ATmega328 DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                  0.3       0.55
                                                     Active 4MHz, VCC = 3V                                  1.7        3.5
                                                     Active 8MHz, VCC = 5V                                  5.2        12
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.04       0.5
                                                     Idle 4MHz, VCC = 3V                                    0.3        1.5
 ICC
                                                     Idle 8MHz, VCC = 5V                                    1.2        5.5
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.9
                                                                                                                                  µA
                                                     WDT enabled, VCC = 3V                                  4.2        15
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                 0.1        2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




          2020 Microchip Technology Inc.                                         Data Sheet Complete                DS40002061B-page 311
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

29.2.8 ATmega328P DC Characteristics

Table 29-8.      ATmega328P DC characteristics - TA = -40C to 85C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.       Typ.(2)      Max.       Units
                                                     Active 1MHz, VCC = 2V                                      0.3             0.5
                                                     Active 4MHz, VCC = 3V                                      1.7             2.5
                                                     Active 8MHz, VCC = 5V                                      5.2             9
              Power Supply Current(1)                                                                                                   mA
                                                     Idle 1MHz, VCC = 2V                                        0.04        0.15
                                                     Idle 4MHz, VCC = 3V                                        0.3             0.7
 ICC
                                                     Idle 8MHz, VCC = 5V                                        1.2             2.7
                                                     32kHz TOSC enabled, VCC = 1.8V                             0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                               0.9
                                                                                                                                        µA
                                                     WDT enabled, VCC = 3V                                      4.2             8
                                       (3)
              Power-down mode
                                                     WDT disabled, VCC = 3V                                     0.1             2
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




29.3     Speed Grades
         Maximum frequency is dependent on VCC. As shown in Figure 29-1, the Maximum Frequency vs. VCC curve is
         linear between 1.8V < VCC < 2.7V and between 2.7V < VCC < 4.5V.

         Figure 29-1.        Maximum Frequency vs. VCC



                           20 MHz




                            10 MHz
                                                                                      Safe Operating Area


                             4 MHz



                                             1.8V                  2.7V                                 4.5V             5.5V




          2020 Microchip Technology Inc.                                         Data Sheet Complete                      DS40002061B-page 312
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P


29.4       Clock Characteristics

29.4.1 Calibrated Internal RC Oscillator Accuracy

Table 29-9.      Calibration Accuracy of Internal RC Oscillator
                                     Frequency                       VCC                    Temperature           Calibration Accuracy
 Factory
                                       8.0MHz                         3V                         25C                        ±10%
 Calibration
 User
                                    7.3 - 8.1MHz               1.8V - 5.5V                  -40C - 85C                     ±1%
 Calibration


29.4.2 External Clock Drive Waveforms

           Figure 29-2.   External Clock Drive Waveforms



                                            V IH1

                                    V IL1




29.4.3 External Clock Drive

Table 29-10.     External Clock Drive
                                                    VCC= 1.8 - 5.5V            VCC= 2.7 - 5.5V             VCC= 4.5 - 5.5V
 Symbol           Parameter                         Min.       Max.           Min.          Max.           Min.       Max.          Units
 1/tCLCL          Oscillator Frequency               0           4              0            10             0          20           MHz
 tCLCL            Clock Period                      250                       100                          50                        ns
 tCHCX            High Time                         100                        40                          20                        ns
 tCLCX            Low Time                          100                        40                          20                        ns
 tCLCH            Rise Time                                     2.0                          1.6                       0.5           s
 tCHCL            Fall Time                                     2.0                          1.6                       0.5           s
                  Change in period from
 tCLCL           one clock cycle to the                         2                           2                         2             %
                  next




            2020 Microchip Technology Inc.                           Data Sheet Complete                           DS40002061B-page 313
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

29.5           System and Reset Characteristics
Table 29-11.           Reset, Brown-out and Internal Voltage Characteristics(1)
   Symbol              Parameter                                                                                          Min.             Typ           Max           Units
                       Power-on Reset Threshold Voltage (rising)                                                           1.1             1.4            1.6             V
     VPOT
                                                                               (2)
                       Power-on Reset Threshold Voltage (falling)                                                          0.6             1.3            1.6             V
    SRON               Power-on Slope Rate                                                                                 0.01                           10           V/ms
     VRST               RESET Pin Threshold Voltage                                                                     0.2 VCC                        0.9 VCC            V
     tRST              Minimum pulse width on RESET Pin                                                                                                   2.5             µs
    VHYST              Brown-out Detector Hysteresis                                                                                        50                            mV
     tBOD              Min. Pulse Width on Brown-out Reset                                                                                  2                             µs
                                                                                                   VCC=2.7
     VBG               Bandgap reference voltage                                                                           1.0             1.1            1.2             V
                                                                                                   TA=25°C
                                                                                                   VCC=2.7
         tBG           Bandgap reference start-up time                                                                                      40            70              µs
                                                                                                   TA=25°C
                                                                                                   VCC=2.7
         IBG           Bandgap reference current consumption                                                                                10                            µA
                                                                                                   TA=25°C
Notes:         1.   Values are guidelines only.
               2.   The Power-on Reset will not work unless the supply voltage has been below VPOT (falling)




Table 29-12.           BODLEVEL Fuse Coding(1)(2)
                    BODLEVEL 2:0 Fuses                                      Min. VBOT                     Typ VBOT                     Max VBOT                    Units
                                 111                                                                             BOD Disabled
                                 110                                             1.7                          1.8                           2.0
                                 101                                             2.5                          2.7                           2.9                       V
                                 100                                             4.1                          4.3                           4.5
                                 011
                                 010
                                                                                                                    Reserved
                                 001
                                 000
Notes:         1.   VBOT may be below nominal minimum operating voltage for some devices. For devices where this is the case, the device is tested down to VCC = VBOT
                    during the production test. This ensures that a Brown-Out Reset will occur before VCC drops to a voltage where correct operation of the microcontroller is no
                    longer ensured. The test is performed using BODLEVEL = 110, 101 and 100.
               2.   VBOT tested at 25C and 85C in production




                2020 Microchip Technology Inc.                                           Data Sheet Complete                                       DS40002061B-page 314
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

29.6   SPI Timing Characteristics
       See Figure 29-3 and Figure 29-4 for details.

       Table 29-13.     SPI Timing Parameters
               Description                Mode              Min.                          Typ              Max
        1      SCK period                 Master                                          See Table 19-5
        2      SCK high/low               Master                                          50% duty cycle
        3      Rise/Fall time             Master                                          3.6
        4      Setup                      Master                                          10
        5      Hold                       Master                                          10
        6      Out to SCK                 Master                                          0.5 • tsck
        7      SCK to out                 Master                                          10
        8      SCK to out high            Master                                          10
        9      SS low to out              Slave                                           15
                                                                                                                                   ns
        10     SCK period                 Slave             4 • tck
        11     SCK high/low(1)            Slave             2 • tck
        12     Rise/Fall time             Slave                                                            1600
        13     Setup                      Slave             10
        14     Hold                       Slave             tck
        15     SCK to out                 Slave                                           15
        16     SCK to SS high             Slave             20
        17     SS high to tri-state       Slave                                           10
        18     SS low to SCK              Slave             20
       Note:   1.     In SPI Programming mode the minimum SCK high/low period is:
                      - 2 tCLCL for fCK < 12MHz
                      - 3 tCLCL for fCK > 12MHz

       Figure 29-3.     SPI Interface Timing Requirements (Master Mode)

                                 SS
                                            6                                                               1

                              SCK
                         (CPOL = 0)
                                                                                                       2               2

                              SCK
                         (CPOL = 1)
                                            4         5                                                                    3

                              MISO
                                                MSB                           ...                          LSB
                        (Data Input)
                                                                      7                                                        8

                              MOSI
                                                      MSB                           ...                          LSB
                       (Data Output)




        2020 Microchip Technology Inc.                                   Data Sheet Complete                                      DS40002061B-page 315
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 29-4.    SPI Interface Timing Requirements (Slave Mode)

                         SS
                                                                                   10               16
                                   9

                      SCK
                 (CPOL = 0)
                                                                              11          11

                      SCK
                 (CPOL = 1)
                                       13     14                                               12

                      MOSI
                                            MSB                ...                  LSB
                (Data Input)
                                                   15                                                    17

                      MISO
                                             MSB              ...                       LSB              X
               (Data Output)




 2020 Microchip Technology Inc.                        Data Sheet Complete                              DS40002061B-page 316
                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


29.7              Two-wire Serial Interface Characteristics
Table 29-14 describes the requirements for devices connected to the 2-wire Serial Bus. The
ATmega48A/PA/88A/PA/168A/PA/328/P 2-wire Serial Interface meets or exceeds these requirements under the noted
conditions.
Timing symbols refer to Figure 29-5.

Table 29-14.              Two-wire Serial Bus Requirements
 Symbol                Parameter                                                                 Condition                           Min.                          Max              Units

 VIL                   Input Low-voltage                                                                                             -0.5                       0.3 VCC              V
 VIH                   Input High-voltage                                                                                        0.7 VCC                       VCC + 0.5             V
            (1)                                                                                                                                    (2)
 Vhys                  Hysteresis of Schmitt Trigger Inputs                                                                  0.05 VCC                                  –             V
 VOL(1)                Output Low-voltage                                                    3mA sink current                            0                          0.4              V
      (1)                                                                                                                                          (3)(2)
 tr                    Rise Time for both SDA and SCL                                                                       20 + 0.1Cb                              300              ns
 tof(1)                Output Fall Time from VIHmin to VILmax                           10pF < Cb < 400pF       (3)
                                                                                                                            20 + 0.1Cb             (3)(2)
                                                                                                                                                                    250              ns
 tSP(1)                Spikes Suppressed by Input Filter                                                                                 0                         50    (2)
                                                                                                                                                                                     ns
 Ii                    Input Current each I/O Pin                                       0.1VCC < Vi < 0.9VCC                          -10                            10              µA
 Ci(1)                 Capacitance for each I/O Pin                                                                                      –                           10              pF
                                                                                      (4)                             (5)
 fSCL                  SCL Clock Frequency                                      fCK         > max(16fSCL, 250kHz)                        0                          400             kHz
                                                                                              fSCL  100kHz                  V CC – 0.4V                        1000ns
                                                                                                                             ---------------------------
                                                                                                                                                       -        -----------------    
                                                                                                                                     3mA                             Cb
 Rp                    Value of Pull-up resistor
                                                                                              fSCL > 100kHz                  V CC – 0.4V                          300ns
                                                                                                                             ---------------------------
                                                                                                                                                       -          --------------     
                                                                                                                                     3mA                              Cb

                                                                                              fSCL  100kHz                           4.0                              –             µs
 tHD;STA               Hold Time (repeated) START Condition
                                                                                              fSCL > 100kHz                           0.6                              –             µs
                                                                                              fSCL  100kHz                           4.7                              –             µs
 tLOW                  Low Period of the SCL Clock
                                                                                              fSCL > 100kHz                           1.3                              –             µs
                                                                                              fSCL  100kHz                           4.0                              –             µs
 tHIGH                 High period of the SCL clock
                                                                                              fSCL > 100kHz                           0.6                              –             µs
                                                                                              fSCL  100kHz                           4.7                              –             µs
 tSU;STA               Set-up time for a repeated START condition
                                                                                              fSCL > 100kHz                           0.6                              –             µs
                                                                                              fSCL  100kHz                              0                         3.45              µs
 tHD;DAT               Data hold time
                                                                                              fSCL > 100kHz                              0                          0.9              µs
                                                                                              fSCL  100kHz                           250                              –             ns
 tSU;DAT               Data setup time
                                                                                              fSCL > 100kHz                           100                              –             ns
                                                                                              fSCL  100kHz                           4.0                              –             µs
 tSU;STO               Setup time for STOP condition
                                                                                              fSCL > 100kHz                           0.6                              –             µs

                       Bus free time between a STOP and START                                 fSCL  100kHz                           4.7                              –             µs
 tBUF
                       condition                                                              fSCL > 100kHz                           1.3                              –             µs
Notes:            1.   In ATmega48A/PA/88A/PA/168A/PA/328/P, this parameter is characterized and not 100% tested.
                  2.   Required only for fSCL > 100kHz.




                   2020 Microchip Technology Inc.                                          Data Sheet Complete                                             DS40002061B-page 317
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

3.   Cb = capacitance of one bus line in pF.
4.   fCK = CPU clock frequency
5.   This requirement applies to all ATmega48A/PA/88A/PA/168A/PA/328/P 2-wire Serial Interface operation. Other devices connected to the 2-wire Serial Bus
     need only obey the general fSCL requirement.


Figure 29-5.        Two-wire Serial Bus Timing
                                                   tof          tHIGH                                                  tr

                                                    tLOW                      tLOW

                 SCL
                         tSU;STA               tHD;STA            tHD;DAT               tSU;DAT
                                                                                                                  tSU;STO
                 SDA



                                                                                                                                   tBUF




 2020 Microchip Technology Inc.                                        Data Sheet Complete                                    DS40002061B-page 318
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

29.8      ADC Characteristics
Table 29-15.     ADC Characteristics
 Symbol        Parameter                               Condition                Min.      Typ      Max        Units
               Resolution                                                                 10                   Bits
                                               VREF = 4V, VCC = 4V,
                                                                                           2                   LSB
                                               ADC clock = 200kHz
                                               VREF = 4V, VCC = 4V,
                                                                                          4.5                  LSB
                                               ADC clock = 1MHz
               Absolute accuracy (Including
                                               VREF = 4V, VCC = 4V,
               INL, DNL, quantization error,
                                               ADC clock = 200kHz                          2                   LSB
               gain and offset error)
                                               Noise Reduction Mode
                                               VREF = 4V, VCC = 4V,
                                               ADC clock = 1MHz                           4.5                  LSB
                                               Noise Reduction Mode
                                               VREF = 4V, VCC = 4V,
               Integral Non-Linearity (INL)                                               0.5                  LSB
                                               ADC clock = 200kHz
               Differential Non-Linearity      VREF = 4V, VCC = 4V,
                                                                                          0.25                 LSB
               (DNL)                           ADC clock = 200kHz
                                               VREF = 4V, VCC = 4V,
               Gain Error                                                                  2                   LSB
                                               ADC clock = 200kHz
                                               VREF = 4V, VCC = 4V,
               Offset Error                                                                2                   LSB
                                               ADC clock = 200kHz
               Conversion Time                 Free Running Conversion           13                260          µs
               Clock Frequency                                                   50                1000        kHz
  AVCC(1)      Analog Supply Voltage                                          VCC - 0.3          VCC + 0.3      V
   VREF        Reference Voltage                                                 1.0              AVCC          V
    VIN        Input Voltage                                                    GND                VREF         V
               Input Bandwidth                                                            38.5                 kHz
   VINT        Internal Voltage Reference                                        1.0      1.1       1.2         V
   RREF        Reference Input Resistance                                                 32                    k
   RAIN        Analog Input Resistance                                                    100                  M
Note:     1. AVCC absolute min./max: 1.8V/5.5V




           2020 Microchip Technology Inc.                       Data Sheet Complete               DS40002061B-page 319
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


29.9   Parallel Programming Characteristics


       Table 29-16.    Parallel Programming Characteristics, VCC = 5V ± 10%
        Symbol         Parameter                                       Min.          Typ     Max       Units
        VPP            Programming Enable Voltage                      11.5                  12.5         V
        IPP            Programming Enable Current                                            250         A
        tDVXH          Data and Control Valid before XTAL1 High         67                               ns
        tXLXH          XTAL1 Low to XTAL1 High                          200                              ns
        tXHXL          XTAL1 Pulse Width High                           150                              ns
        tXLDX          Data and Control Hold after XTAL1 Low            67                               ns
        tXLWL          XTAL1 Low to WR Low                               0                               ns
        tXLPH          XTAL1 Low to PAGEL high                           0                               ns
        tPLXH          PAGEL low to XTAL1 high                          150                              ns
        tBVPH          BS1 Valid before PAGEL High                      67                               ns
        tPHPL          PAGEL Pulse Width High                           150                              ns
        tPLBX          BS1 Hold after PAGEL Low                         67                               ns
        tWLBX          BS2/1 Hold after WR Low                          67                               ns
        tPLWL          PAGEL Low to WR Low                              67                               ns
        tBVWL          BS1 Valid to WR Low                              67                               ns
        tWLWH          WR Pulse Width Low                               150                              ns
        tWLRL          WR Low to RDY/BSY Low                             0                     1         s
                                                 (1)
        tWLRH          WR Low to RDY/BSY High                           3.7                   4.5        ms
        tWLRH_CE       WR Low to RDY/BSY High for Chip Erase(2)         7.5                    9         ms
        tXLOL          XTAL1 Low to OE Low                               0                               ns
        tBVDV          BS1 Valid to DATA valid                           0                   250         ns
        tOLDV          OE Low to DATA Valid                                                  250         ns
        tOHDZ          OE High to DATA Tri-stated                                            250         ns

       Notes:   1.    tWLRH is valid for the Write Flash, Write EEPROM, Write Fuse bits and Write Lock bits commands.
                2.    tWLRH_CE is valid for the Chip Erase command.




        2020 Microchip Technology Inc.                        Data Sheet Complete                         DS40002061B-page 320
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 29-6.    Parallel Programming Timing, Including some General Timing Requirements
                                                                           tXLWL
                                                              tXHXL
                                XTAL1
                                                    tDVXH                  tXLDX
                          Data & Contol
                (DATA, XA0/1, BS1, BS2)
                                                    tBVPH                  tPLBX t BVWL
                                                                                                                  tWLBX
                                PAGEL                         tPHPL
                                                                                                 tWLWH
                                    WR                                     tPLWL
                                                                                                   WLRL

                              RDY/BSY
                                                                                                                                      tWLRH



Figure 29-7.    Parallel Programming Timing, Loading Sequence with Timing Requirements(1)
                                 LOAD ADDRESS               LOAD DATA                   LOAD DATA LOAD DATA            LOAD ADDRESS
                                   (LOW BYTE)               (LOW BYTE)                 (HIGH BYTE)                       (LOW BYTE)


                                                                           t XLXH                tXLPH
                                                                                                               tPLXH
                  XTAL1



                    BS1


                  PAGEL


                   DATA          ADDR0 (Low Byte)            DATA (Low Byte)                DATA (High Byte)              ADDR1 (Low Byte)



                    XA0

                    XA1




Note:   1. The timing requirements shown in Figure 29-6 (i.e., tDVXH, tXHXL, and tXLDX) also apply to loading operation.

Figure 29-8.    Parallel Programming Timing, Reading Sequence (within the Same Page) with Timing
                Requirements(1)
                              LOAD ADDRESS                       READ DATA                      READ DATA              LOAD ADDRESS
                                (LOW BYTE)                       (LOW BYTE)                    (HIGH BYTE)               (LOW BYTE)

                                           tXLOL

               XTAL1
                                                                                    tBVDV


                BS1
                                                tOLDV

                 OE
                                                                                                               tOHDZ


               DATA           ADDR0 (Low Byte)                 DATA (Low Byte)                DATA (High Byte)            ADDR1 (Low Byte)



                XA0


                XA1


Note:   1. The timing requirements shown in Figure 29-6 (i.e., tDVXH, tXHXL, and tXLDX) also apply to reading operation.




 2020 Microchip Technology Inc.                                     Data Sheet Complete                                              DS40002061B-page 321
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

30.      Electrical Characteristics (TA = -40°C to 105°C)

30.1     Absolute Maximum Ratings*
 Operating Temperature. . . . . . . . . . . -55°C to +125°C                 *NOTICE:      Stresses beyond those listed under “Absolute
                                                                                          Maximum Ratings” may cause permanent dam-
                                                                                          age to the device. This is a stress rating only
 Storage Temperature . . . . . . . . . . . . -65°C to +150°C                              and functional operation of the device at these
                                                                                          or other conditions beyond those indicated in
                                                                                          the operational sections of this specification is
 Voltage on any Pin except RESET
                                                                                          not implied. Exposure to absolute maximum rat-
 with respect to Ground . . . . . . . . . . -0.5V to VCC+0.5V
                                                                                          ing conditions for extended periods may affect
                                                                                          device reliability.
 Voltage on RESET with respect to Ground-0.5V to +13.0V


 Maximum Operating Voltage . . . . . . . . . . . . . . . . 6.0V


 DC Current per I/O Pin . . . . . . . . . . . . . . . . . . 40.0mA

 DC Current VCC and GND Pins . . . . . . . . . . 200.0mA



30.2     DC Characteristics


Table 30-1.       Common DC characteristics TA = -40C to 105C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                           Condition                                    Min.        Typ.          Max.         Units
              Input Low Voltage, except           VCC = 1.8V - 2.4V                            -0.5                    0.2VCC(1)
 VIL                                                                                                                                    V
              XTAL1 and RESET pin                 VCC = 2.4V - 5.5V                            -0.5                    0.3VCC(1)
              Input High Voltage, except          VCC = 1.8V - 2.4V                       0.7VCC(2)                    VCC + 0.5
 VIH                                                                                                                                    V
              XTAL1 and RESET pins                VCC = 2.4V - 5.5V                       0.6VCC(2)                    VCC + 0.5
              Input Low Voltage,
 VIL1                                             VCC = 1.8V - 5.5V                            -0.5                    0.1VCC(1)        V
              XTAL1 pin
              Input High Voltage,                 VCC = 1.8V - 2.4V                       0.8VCC(2)                    VCC + 0.5
 VIH1                                                                                                                                   V
              XTAL1 pin                           VCC = 2.4V - 5.5V                       0.7VCC(2)                    VCC + 0.5
              Input Low Voltage,
 VIL2                                             VCC = 1.8V - 5.5V                            -0.5                    0.1VCC(1)        V
              RESET pin
              Input High Voltage,
 VIH2                                             VCC = 1.8V - 5.5V                       0.9VCC(2)                    VCC + 0.5        V
              RESET pin
              Input Low Voltage,                  VCC = 1.8V - 2.4V                            -0.5                    0.2VCC(1)
 VIL3                                                                                                                                   V
              RESET pin as I/O                    VCC = 2.4V - 5.5V                            -0.5                    0.3VCC(1)
              Input High Voltage,                 VCC = 1.8V - 2.4V                       0.7VCC(2)                    VCC + 0.5
 VIH3                                                                                                                                   V
              RESET pin as I/O                    VCC = 2.4V - 5.5V                       0.6VCC(2)                    VCC + 0.5
                                                                           TA=85C                                        0.9
                                                  IOL = 20mA, VCC = 5V
              Output Low Voltage(4)                                        TA=105C                                       1.0
 VOL
              except RESET pin                                             TA=85C                                        0.6
                                                  IOL = 10mA, VCC = 3V
                                                                           TA=105C                                       0.7           V




           2020 Microchip Technology Inc.                               Data Sheet Complete                          DS40002061B-page 322
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Table 30-1.       Common DC characteristics TA = -40C to 105C, VCC = 1.8V to 5.5V (unless otherwise noted) (Continued)
 Symbol       Parameter                               Condition                                              Min.               Typ.              Max.             Units

                                                      IOH = -20mA, VCC =              TA=85C                 4.2
                                                      5V                              TA=105C                4.1
              Output High Voltage(3)
 VOH
              except Reset pin                                                        TA=85C                 2.3
                                                      IOH = -10mA, VCC =
                                                      3V                              TA=105C                2.1                                                    V
              Input Leakage                           VCC = 5.5V, pin low
 IIL                                                                                                                                                 1              µA
              Current I/O Pin                         (absolute value)
              Input Leakage                           VCC = 5.5V, pin high
 IIH                                                                                                                                                 1              µA
              Current I/O Pin                         (absolute value)
 RRST         Reset Pull-up Resistor                                                                           30                                   60              k
 RPU          I/O Pin Pull-up Resistor                                                                         20                                   50              k
              Analog Comparator                       VCC = 5V
 VACIO                                                                                                                          <10                 40              mV
              Input Offset Voltage                    Vin = VCC/2
              Analog Comparator                       VCC < 3.6V
 VACIO                                                                                                                          <15                60(5)            mV
              Input Offset Voltage                    Vin < 0.5V
              Analog Comparator                       VCC > 3.6V
 VACIO                                                                                                                          <15               500(5)            mV
              Input Offset Voltage                    Vin < 0.5V
              Analog Comparator                       VCC = 5V
 IACLK                                                                                                        -50                                   50               nA
              Input Leakage Current                   Vin = VCC/2
              Analog Comparator                       VCC = 2.7V                                                                750
 tACID                                                                                                                                                               ns
              Propagation Delay                       VCC = 4.0V                                                                500
Notes:   1.   “Max” means the highest value where the pin is ensured to be read as low
         2.   “Min.” means the lowest value where the pin is ensured to be read as high
         3.   Although each I/O port can source more than the test conditions (20mA at VCC = 5V, 10mA at VCC = 3V) under steady state conditions (non-transient), the
              following must be observed:
              ATmega48A/PA/88A/PA/168A/PA/328/P:
              1] The sum of all IOH, for ports C0 - C5, D0- D4, ADC7, RESET should not exceed 150mA.
              2] The sum of all IOH, for ports B0 - B5, D5 - D7, ADC6, XTAL1, XTAL2 should not exceed 150mA.
              If IIOH exceeds the test condition, VOH may exceed the related specification. Pins are not ensured to source current greater than the listed test condition.
         4.   Although each I/O port can sink more than the test conditions (20mA at VCC = 5V, 10mA at VCC = 3V) under steady state conditions (non-transient), the
              following must be observed:
              ATmega48A/PA/88A/PA/168A/PA/328/P:
              1] The sum of all IOL, for ports C0 - C5, ADC7, ADC6 should not exceed 100mA.
              2] The sum of all IOL, for ports B0 - B5, D5 - D7, XTAL1, XTAL2 should not exceed 100mA.
              3] The sum of all IOL, for ports D0 - D4, RESET should not exceed 100mA.
              If IOL exceeds the test condition, VOL may exceed the related specification. Pins are not ensured to sink current greater than the listed test condition.
         5.   These values are based on characterization. The max. limit is not tested in production and can therefore not be assured.




          2020 Microchip Technology Inc.                                          Data Sheet Complete                                        DS40002061B-page 323
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

30.2.1 ATmega48PA DC Characteristics – Current Consumption


Table 30-2.      ATmega48PA DC characteristics - TA = -40C to 105C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                     Min.    Typ.(2)    Max.        Units
                                                     Active 1MHz, VCC = 2V                                  0.22       0.55
                                                     Active 4MHz, VCC = 3V                                  1.15       2.65
                                                     Active 8MHz, VCC = 5V                                  4.1        9.5
              Power Supply Current(1)                                                                                              mA
                                                     Idle 1MHz, VCC = 2V                                   0.024       0.16
                                                     Idle 4MHz, VCC = 3V                                    0.2        0.75
 ICC
                                                     Idle 8MHz, VCC = 5V                                    0.78       2.8
                                                     32kHz TOSC enabled, VCC= 1.8V                          0.75
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.9
                                                                                                                                   µA
                                                     WDT enabled, VCC = 3V                                  3.9         10
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                 0.1         5
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




30.2.2 ATmega88PA DC Characteristics – Current Consumption


Table 30-3.      ATmega88PA DC characteristics - TA = -40C to 105C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                   0.2       0.6
                                                     Active 4MHz, VCC = 3V                                   1.2      2.75
                                                     Active 8MHz, VCC = 5V                                   4.1       10
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.03      0.17
                                                     Idle 4MHz, VCC = 3V                                    0.18       0.8
 ICC
                                                     Idle 8MHz, VCC = 5V                                     0.8        3
                                                     32kHz TOSC enabled, VCC= 1.8V                           0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                            0.9
                                                                                                                                  µA
                                                     WDT enabled, VCC = 3V                                   3.9       10
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                  0.1        5
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




          2020 Microchip Technology Inc.                                         Data Sheet Complete                DS40002061B-page 324
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

30.2.3 ATmega168PA DC Characteristics – Current Consumption


Table 30-4.      ATmega168PA DC characteristics - TA = -40C to 105C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                  0.3        0.6
                                                     Active 4MHz, VCC = 3V                                  1.8       2.75
                                                     Active 8MHz, VCC = 5V                                  6.7        10
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.06       0.2
                                                     Idle 4MHz, VCC = 3V                                    0.4        0.8
 ICC
                                                     Idle 8MHz, VCC = 5V                                    1.7         3
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.9
                                                                                                                                  µA
                                                     WDT enabled, VCC = 3V                                  4.6        10
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                 0.1         5
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.


30.2.4 ATmega328P DC Characteristics – Current Consumption


Table 30-5.      ATmega328P DC characteristics - TA = -40C to 105C, VCC = 1.8V to 5.5V (unless otherwise noted)
 Symbol       Parameter                              Condition                                      Min.   Typ.(2)    Max.       Units
                                                     Active 1MHz, VCC = 2V                                  0.3        0.5
                                                     Active 4MHz, VCC = 3V                                  1.7        2.5
                                                     Active 8MHz, VCC = 5V                                  5.2        9.0
              Power Supply Current(1)                                                                                             mA
                                                     Idle 1MHz, VCC = 2V                                    0.04      0.15
                                                     Idle 4MHz, VCC = 3V                                    0.3        0.7
 ICC
                                                     Idle 8MHz, VCC = 5V                                    1.2        2.7
                                                     32kHz TOSC enabled, VCC = 1.8V                         0.8
              Power-save mode(3)
                                                     32kHz TOSC enabled, VCC = 3V                           0.9
                                                                                                                                  µA
                                                     WDT enabled, VCC = 3V                                  4.2        10
              Power-down mode(3)
                                                     WDT disabled, VCC = 3V                                 0.1         5
Notes:   1.   Values with “Minimizing Power Consumption” enabled (0xFF).
         2.   Typical values at 25C. Maximum values are test limits in production.
         3.   The current consumption values include input leakage current.




          2020 Microchip Technology Inc.                                         Data Sheet Complete                DS40002061B-page 325
                                            ATmega48A/PA/88A/PA/168A/PA/328/P


31.   Typical Characteristics – (TA = -40°C to 85°C)
      The following charts show typical behavior. These figures are not tested during manufacturing. All current
      consumption measurements are performed with all I/O pins configured as inputs and with internal pull-ups
      enabled. A square wave generator with rail-to-rail output is used as clock source.
      All Active- and Idle current consumption measurements are done with all bits in the PRR register set and thus,
      the corresponding I/O modules are turned off. Also the Analog Comparator is disabled during these
      measurements. The ”ATmega88PA: Supply Current of IO Modules” on page 407 and page 457 shows the
      additional current consumption compared to ICC Active and ICC Idle for every I/O module controlled by the Power
      Reduction Register. See ”Power Reduction Register” on page 51 for details.
      The power consumption in Power-down mode is independent of clock selection.
      The current consumption is a function of several factors such as: operating voltage, operating frequency,
      loading of I/O pins, switching rate of I/O pins, code executed and ambient temperature. The dominating factors
      are operating voltage and frequency.
      The current drawn from capacitive loaded pins may be estimated (for one pin) as CL*VCC*f where CL = load
      capacitance, VCC = operating voltage and f = average switching frequency of I/O pin.
      The parts are characterized at frequencies higher than test limits. Parts are not ensured to function properly at
      frequencies higher than the ordering code indicates.
      The difference between current consumption in Power-down mode with Watchdog Timer enabled and Power-
      down mode with Watchdog Timer disabled represents the differential current drawn by the Watchdog Timer.




       2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 326
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

31.1   ATmega48A Typical Characteristics

31.1.1 Active Supply Current

       Figure 31-1.   ATmega48A: Active Supply Current vs. Low Frequency (0.1-1.0MHz)
                                      1
                                                                                                                                5.5 V

                                     0.8
                                                                                                                                5.0 V

                                                                                                                                4.5 V
                                     0.6
                        ICC (mA)




                                                                                                                                4.0 V

                                     0.4                                                                                        3.3 V
                                                                                                                                2.7 V
                                     0.2                                                                                        1.8 V


                                      0
                                           0   0.1   0.2         0.3   0.4        0.5     0.6      0.7      0.8      0.9   1
                                                                         Frequency (MHz)




       Figure 31-2.   ATmega48A: Active Supply Current vs. Frequency (1-20MHz)

                                     12

                                                                                                                                5.5V
                                     10
                                                                                                                                5.0V
                                      8
                                                                                                                                4.5V
                          ICC (mA)




                                      6
                                                                                                                  4.0V
                                      4
                                                                                                3.3V

                                      2
                                                                             2.7V
                                                          1.8V
                                      0
                                           0    2     4           6     8           10    12           14   16       18    20
                                                                            Frequency (MHz)




        2020 Microchip Technology Inc.                                       Data Sheet Complete                               DS40002061B-page 327
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-3.   ATmega48A: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)
                              0.14

                                                                                              85 °C
                              0.12                                                           -40 °C
                                                                                              25 °C
                               0.1


                              0.08
                 ICC (mA)



                              0.06


                              0.04


                              0.02


                                0
                                     1.5   2   2.5   3       3.5       4       4.5   5     5.5
                                                           VCC (V)


Figure 31-4.   ATmega48A: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                              1.2
                                                                                              85 °C
                                                                                              25 °C
                                1                                                            -40 °C

                              0.8
                   ICC (mA)




                              0.6


                              0.4


                              0.2


                                0
                                    1.5    2   2.5   3      3.5       4        4.5   5     5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                         Data Sheet Complete                     DS40002061B-page 328
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-5.   ATmega48A: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)
                                         5                                                                                            85 °C
                                                                                                                                      25 °C
                                                                                                                                     -40 °C
                                         4



                              ICC (mA)   3



                                         2



                                         1



                                         0
                                             1.5     2         2.5         3           3.5         4         4.5         5         5.5
                                                                                      VCC (V)




31.1.2 Idle Supply Current

       Figure 31-6.   ATmega48A: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)
                                   0.16
                                                                                                                                         5.5 V
                                   0.14

                                   0.12                                                                                                  5.0 V

                                         0.1                                                                                             4.5 V
                       ICC (mA)




                                   0.08                                                                                                  4.0 V

                                   0.06                                                                                                  3.3 V

                                   0.04                                                                                                  2.7 V
                                                                                                                                         1.8 V
                                   0.02

                                          0
                                               0   0.1   0.2         0.3       0.4      0.5     0.6    0.7         0.8       0.9    1
                                                                                 Frequency (MHz)




        2020 Microchip Technology Inc.                                              Data Sheet Complete                                 DS40002061B-page 329
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-7.   ATmega48A: Idle Supply Current vs. Frequency (1-20MHz)
                                3


                               2.5
                                                                                                                                5.5 V

                                                                                                                                5.0 V
                                2
                    ICC (mA)                                                                                                    4.5 V

                               1.5

                                                                                                                  4.0 V
                                1

                                                                                              3.3 V
                               0.5
                                                                                 2.7 V
                                0
                                                       1.8 V
                                     0     2       4           6       8       10        12       14         16       18   20
                                                                       Frequency (MHz)


Figure 31-8.   ATmega48A: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                           0.042
                                                                                                                                 85 °C

                           0.035


                           0.028
                                                                                                                                 25 °C
                                                                                                                                -40 °C
                ICC (mA)




                           0.021


                           0.014


                           0.007


                                 0
                                     1.5       2         2.5       3           3.5            4        4.5           5     5.5
                                                                             VCC (V)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                  DS40002061B-page 330
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-9.   ATmega48A: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)
                               0.35


                                0.3
                                                                                                 85 °C
                                                                                                 25 °C
                                                                                                -40 °C
                               0.25


                                0.2
                ICC (mA)



                               0.15


                                0.1


                               0.05


                                 0
                                      1.5   2   2.5   3       3.5       4       4.5   5   5.5
                                                            VCC (V)


Figure 31-10. ATmega48A: Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)
                                1.2                                                          85 °C
                                                                                             25 °C
                                                                                            -40 °C
                                 1


                                0.8
                    ICC (mA)




                                0.6


                                0.4


                                0.2


                                 0
                                      1.5   2   2.5   3       3.5      4        4.5   5   5.5
                                                            VCC (V)




 2020 Microchip Technology Inc.                          Data Sheet Complete                   DS40002061B-page 331
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.1.3 ATmega48A: Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-1.      ATmega48PA: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz         VCC = 5V, F = 8MHz
         PRUSART0            2.9uA                        20.7µA                     97.4µA
         PRTWI               6.0µA                        44.8µA                     219.7µA
         PRTIM2              5.0µA                        34.5µA                     141.3µAµA
         PRTIM1              3.6µA                        24.4µA                     107.7µA
         PRTIM0               1.4µA                       9.5µA                      38.4µA
         PRSPI                5.0µA                       38.0µA                     190.4µA
         PRADC                6.1µA                       47.4µA                     244.7µA

       Table 31-2.      ATmega48PA: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption               Additional Current consumption
                             compared to Active with external             compared to Idle with external
                             clock (see Figure 31-48 on page              clock (see Figure 31-53 on page
                             352 and Figure 31-49 on page                 354 and Figure 31-54 on page
         PRR bit             352)                                         355)
         PRUSART0            1.8%                                         11.4%
         PRTWI               3.9%                                         20.6%
         PRTIM2              2.9%                                         15.7%
         PRTIM1              2.1%                                         11.2%
         PRTIM0              0.8%                                         4.2%
         PRSPI               3.3%                                         17.6%
         PRADC               4.2%                                         22.1%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-2 on page 332
       for other VCC and frequency settings than listed in Table 31-1 on page 332.
31.1.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-4 on page 357, third column, we see that we need to add 11.2% for the TIMER1,
       22.1% for the ADC, and 17.6% for the SPI module. Reading from Figure 31-53 on page 354, we find that the
       idle current consumption is ~0.028 mA at VCC = 2.0V and F = 1MHz. The total current consumption in idle mode
       with TIMER1, ADC, and SPI enabled, gives:
         I CC total  0.028 mA  (1 + 0.112 + 0.221 + 0.176)  0.042 mA




         2020 Microchip Technology Inc.                              Data Sheet Complete                   DS40002061B-page 332
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.4 Power-down Supply Current

      Figure 31-11. ATmega48A: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)
                                      1.2

                                                                                                        85 °C
                                       1


                                      0.8
                        ICC (uA)




                                      0.6


                                      0.4
                                                                                                       -40 °C
                                      0.2                                                               25 °C


                                       0
                                            1.5   2   2.5   3       3.5      4         4.5   5    5.5
                                                                  VCC (V)


      Figure 31-12. ATmega48A: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)
                                      8
                                                                                                   -40 °C
                                                                                                    85 °C
                                                                                                    25 °C
                                      6
                           ICC (uA)




                                      4




                                      2




                                      0
                                          1.5     2   2.5   3     3.5       4         4.5    5   5.5
                                                                 VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete                     DS40002061B-page 333
                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.5 Power-save Supply Current

      Figure 31-13. ATmega48A: Power-Save Supply Current vs. VCC
                    (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)
                                               2                                                                             85 °C


                                           1.6



                                           1.2                                                                               25 °C
                                ICC (uA)




                                                                                                                             -40 °C

                                           0.8



                                           0.4



                                               0
                                                   1.5       2     2.5       3       3.5         4       4.5       5     5.5
                                                                                   VCC (V)




31.1.6 Standby Supply Current

      Figure 31-14. ATmega48A: Standby Supply Current vs. Vcc (Watchdog Timer Disabled
                                0.16
                                                                                                                         6MHz_xtal
                                0.14                                                                                     6MHz_res

                                0.12
                                                                                                                         4MHz_res
                                    0.1                                                                                  4MHz_xtal
                     ICC (mA)




                                0.08
                                                                                                                         2MHz_res
                                                                                                                         2MHz_xtal
                                0.06
                                                                                                                         450kHz_res
                                0.04

                                0.02

                                           0
                                               1.5       2       2.5     3         3.5       4         4.5     5       5.5
                                                                                 VCC (V)




        2020 Microchip Technology Inc.                                          Data Sheet Complete                           DS40002061B-page 334
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.7 Pin Pull-Up

       Figure 31-15. ATmega48A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8 V)
                                    50



                                    40



                                    30
                        IOP (uA)




                                    20



                                    10
                                                                                                                        25 °C
                                                                                                                        85 °C
                                    0                                                                                  -40 °C
                                         0   0.2         0.4     0.6   0.8             1   1.2   1.4         1.6   1.8
                                                                         VOP (V)




       Figure 31-16. ATmega48A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7 V)

                                    70


                                    60


                                    50


                                    40
                         IOP (uA)




                                    30


                                    20

                                                                                                                      25 °C
                                    10
                                                                                                                      85 °C
                                                                                                                     -40 °C
                                     0
                                         0         0.5            1            1.5         2           2.5         3
                                                                             VOP (V)




        2020 Microchip Technology Inc.                                Data Sheet Complete                               DS40002061B-page 335
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-17. ATmega48A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)
                                 140


                                 120


                                 100


                                 80
                 IOP (uA)



                                 60


                                 40

                                                                                                                        25 °C
                                 20
                                                                                                                        85 °C
                                                                                                                       -40 °C
                                  0
                                       0         1             2                       3               4          5
                                                                         VOP (V)


Figure 31-18. ATmega48A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)

                                 35


                                 30


                                 25
                   IRESET (uA)




                                 20


                                 15


                                 10
                                                                                                                       25 °C
                                  5                                                                                   -40 °C
                                                                                                                       85 °C
                                  0
                                       0   0.2   0.4     0.6       0.8             1       1.2   1.4       1.6   1.8
                                                                    VRESET (V)




 2020 Microchip Technology Inc.                                    Data Sheet Complete                                DS40002061B-page 336
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-19. ATmega48A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7 V)
                                60


                                50


                                40
                  IRESET (uA)

                                30


                                20


                                10                                                                                   25 °C
                                                                                                                    -40 °C
                                 0                                                                                   85 °C
                                      0         0.5          1          1.5           2             2.5         3
                                                                     VRESET (V)


Figure 31-20. ATmega48A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)
                                120


                                100


                                80
                 IRESET (uA)




                                60


                                40


                                20                                                                                   25 °C
                                                                                                                    -40 °C
                                 0                                                                                   85 °C
                                      0   0.5         1    1.5   2       2.5      3       3.5   4         4.5   5
                                                                     VRESET (V)




 2020 Microchip Technology Inc.                                     Data Sheet Complete                             DS40002061B-page 337
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.8 Pin Driver Strength

       Figure 31-21. ATmega48A: I/O Pin Output Voltage vs. Sink Current (VCC = 3 V)
                                   1

                                                                                            85 °C
                                  0.8

                                                                                            25 °C
                                  0.6
                                                                                        -40 °C
                        VOL (V)




                                  0.4



                                  0.2



                                   0
                                        0   4          8               12         16   20
                                                            IOL (mA)


       Figure 31-22. ATmega48A: I/O Pin Output Voltage vs. Sink Current (VCC = 5 V)

                                  0.6
                                                                                            85 °C

                                  0.5                                                       25 °C

                                  0.4                                                   -40 °C
                        VOL (V)




                                  0.3


                                  0.2


                                  0.1


                                   0
                                        0   4          8               12         16   20
                                                            IOL (mA)




        2020 Microchip Technology Inc.                    Data Sheet Complete              DS40002061B-page 338
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-23. ATmega48A: I/O Pin Output Voltage vs. Source Current (Vcc = 3 V)
                           3.5


                            3


                           2.5
                                                                                  -40 °C
                                                                                   25 °C
                            2                                                      85 °C
                 VOH (V)



                           1.5


                            1


                           0.5


                            0
                                 0   4          8               12        16     20
                                                     IOH (mA)


Figure 31-24. ATmega48A: I/O Pin Output Voltage vs. Source Current (VCC = 5 V)
                            5

                           4.9

                           4.8

                           4.7
                 VOH (V)




                           4.6
                                                                                  -40 °C
                           4.5
                                                                                      25 °C
                           4.4
                                                                                      85 °C
                           4.3

                           4.2
                                 0   4          8               12        16     20
                                                     IOH (mA)




 2020 Microchip Technology Inc.                    Data Sheet Complete               DS40002061B-page 339
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.9 Pin Threshold and Hysteresis

       Figure 31-25. ATmega48A: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                         3
                                                                                                       -40 °C
                                                                                                        25 °C
                                        2.5                                                             85 °C

                                         2
                        Threshold (V)




                                        1.5


                                         1


                                        0.5


                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5      5.5
                                                                   VCC (V)




       Figure 31-26. ATmega48A: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                        2.5                                                             85 °C
                                                                                                        25 °C
                                                                                                       -40 °C
                                         2
                        Threshold (V)




                                        1.5



                                         1



                                        0.5



                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5      5.5
                                                                   VCC (V)




        2020 Microchip Technology Inc.                           Data Sheet Complete                      DS40002061B-page 340
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-27. ATmega48A: I/O Pin Input Hysteresis vs. VCC

                                        0.6
                                                                                                     25 °C
                                                                                                     85 °C
                                        0.5                                                         -40 °C

                 Input Hysteresis (V)   0.4


                                        0.3


                                        0.2


                                        0.1


                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)


Figure 31-28. ATmega48A: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1)’
                                        2.5                                                         -40 °C
                                                                                                     25 °C
                                                                                                     85 °C
                                          2
                   Threshold (V)




                                        1.5



                                          1



                                        0.5



                                          0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)




 2020 Microchip Technology Inc.                                  Data Sheet Complete                   DS40002061B-page 341
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-29. )ATmega48A: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                        2.5
                                                                                                     85 °C
                                                                                                     25 °C
                                                                                                    -40 °C
                                          2



                   Threshold (V)        1.5



                                          1



                                        0.5



                                          0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)


Figure 31-30. ATmega48A: Reset Pin Input Hysteresis vs. VCC


                                        0.7


                                        0.6


                                        0.5
                 Input Hysteresis (V)




                                        0.4


                                        0.3


                                        0.2


                                        0.1                                                          85 °C
                                                                                                     25 °C
                                                                                                    -40 °C
                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)




 2020 Microchip Technology Inc.                                  Data Sheet Complete                   DS40002061B-page 342
                                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.10 BOD Threshold

      Figure 31-31. ATmega48A: BOD Thresholds vs. Temperature (BODLEVEL is 1.8 V)
                                                       1.85
                                                                                                                   Rising Vcc
                                                       1.84


                                                       1.83
                                       Threshold (V)



                                                       1.82

                                                                                                                   Falling Vcc
                                                       1.81


                                                        1.8


                                                       1.79
                                                              -50     -40     -30     -20     -10       0        10     20     30     40    50    60    70    80    90
                                                                                                                 Temperature (°C)




      Figure 31-32. ATmega48A: BOD Thresholds vs. Temperature (BODLEVEL is 2.7 V)
                                       2.76
                                                                                                                 Rising Vcc
                                       2.74


                                       2.72
                       Threshold (V)




                                        2.7


                                       2.68
                                                                                                                 Falling Vcc
                                       2.66


                                       2.64


                                       2.62
                                                       -50      -40     -30     -20     -10         0       10     20    30      40    50    60    70    80    90
                                                                                                        Temperature (°C)




        2020 Microchip Technology Inc.                                                                      Data Sheet Complete                                    DS40002061B-page 343
                                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-33. ATmega48A: BOD Thresholds vs. Temperature (BODLEVEL is 4.3 V)
                                                      4.36

                                                                                                      Rising Vcc
                                                      4.34


                                                      4.32

                                      Threshold (V)
                                                       4.3


                                                      4.28

                                                                                                      Falling Vcc
                                                      4.26


                                                      4.24
                                                             -50   -40   -30   -20   -10       0    10      20   30    40    50   60       70   80     90
                                                                                                    Temperature (°C)


Figure 31-34. ATmega48A: Bandgap Voltage vs. VCC

                                    1.104

                                    1.102

                                      1.1
                                                                                                                                                       85 °C
              Bandgap Voltage (V)




                                                                                                                                                       25 °C
                                    1.098

                                    1.096
                                                                                                                                                     -40 °C
                                    1.094


                                    1.092


                                     1.09
                                                      1.5           2          2.5         3          3.5         4         4.5        5         5.5
                                                                                                    VCC (V)




 2020 Microchip Technology Inc.                                                                   Data Sheet Complete                                 DS40002061B-page 344
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.11 Internal Oscillator Speed

       Figure 31-35. ATmega48A: Watchdog Oscillator Frequency vs. Temperature

                                       116


                                       114


                                       112
                           FRC (kHz)




                                       110
                                                                                                                                           2.7 V
                                                                                                                                           3.3 V
                                       108
                                                                                                                                           4.0 V
                                                                                                                                           5.5 V
                                       106


                                       104
                                             -40   -30       -20   -10    0   10      20         30   40   50     60   70       80   90
                                                                                   Temperature (°C)


       Figure 31-36. ATmega48A: Watchdog Oscillator Frequency vs. VCC


                                       118


                                       116


                                       114                                                                                             -40 °C
                         FRC (kHz)




                                       112                                                                                                 25 °C

                                       110


                                       108

                                                                                                                                           85 °C
                                       106
                                             1.5         2          2.5       3            3.5        4         4.5         5        5.5
                                                                                       VCC (V)




         2020 Microchip Technology Inc.                                            Data Sheet Complete                                    DS40002061B-page 345
                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-37. ATmega48A: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                                8.2
                                                                                                                                       85 °C
                                8.1


                                 8
                                                                                                                                       25 °C
                 FRC (MHz)


                                7.9


                                7.8


                                7.7                                                                                                -40 °C


                                7.6
                                      1.5         2           2.5         3          3.5          4         4.5         5        5.5
                                                                                   VCC (V)


Figure 31-38. ATmega48A: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                                8.2
                                                                                                                                   3.3 V
                                8.1
                                                                                                                                   5.5 V
                                                                                                                                   1.8 V

                                  8
                    FRC (MHz)




                                7.9


                                7.8


                                7.7


                                7.6
                                      -50   -40       -30   -20     -10   0   10     20      30       40   50     60   70   80   90
                                                                              Temperature (°C)




 2020 Microchip Technology Inc.                                               Data Sheet Complete                                     DS40002061B-page 346
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-39. ATmega48A: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                                       16
                                                                                                                         85 °C
                                       14                                                                                25 °C
                                                                                                                        -40 °C
                                       12

                           FRC (MHz)   10

                                        8

                                        6

                                        4

                                        2

                                        0
                                             0     16   32   48   64    80   96   112 128 144 160 176 192 208 224 240 256
                                                                                  OSCCAL (X1)




31.1.12 Current Consumption of Peripheral Units

       Figure 31-40. ATmega48A: ADC Current vs. VCC (AREF = AVCC)
                                       350

                                                                                                                        -40 °C
                                       300                                                                               25 °C
                                                                                                                         85 °C
                                       250


                                       200
                        ICC (uA)




                                       150


                                       100


                                       50


                                        0
                                             1.5        2         2.5        3        3.5       4        4.5   5      5.5
                                                                                     VCC (V)




        2020 Microchip Technology Inc.                                            Data Sheet Complete                      DS40002061B-page 347
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-41. ATmega48A: Analog Comparator Current vs. VCC

                              90
                                                                                          -40 °C
                              80                                                           25 °C
                                                                                           85 °C
                              70

                   ICC (uA)   60

                              50

                              40

                              30

                              20

                              10

                               0
                                   1.5    2   2.5   3      3.5       4        4.5   5   5.5
                                                         VCC (V)


Figure 31-42. ATmega48A: AREF External Reference Current vs. VCC


                              160
                                                                                               85 °C
                              140                                                              25 °C
                                                                                              -40 °C
                              120

                              100
                 ICC (uA)




                              80

                              60

                              40

                              20

                               0
                                    1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                   DS40002061B-page 348
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-43. ATmega48A Brownout Detector Current vs. VCC

                              40



                              32


                                                                                          85 °C
                              24
                                                                                          25 °C
                 ICC (uA)


                                                                                         -40 °C

                              16



                              8



                              0
                                   1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                        VCC (V)




Figure 31-44. ATmega48A: Programming Current vs. VCC

                              6

                                                                                         -40 °C
                              5
                                                                                             25 °C
                              4
                   ICC (mA)




                              3
                                                                                             85 °C

                              2


                              1


                              0
                                  1.5    2   2.5   3     3.5        4        4.5   5   5.5
                                                        VCC (V)




 2020 Microchip Technology Inc.                       Data Sheet Complete                    DS40002061B-page 349
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

31.1.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-45. ATmega48A: Reset Supply Current vs. Low Frequency (0.1 - 1.0MHz)
                                     0.14


                                     0.12                                                                                          5.5 V

                                      0.1                                                                                          5.0 V

                                     0.08                                                                                          4.5 V
                        ICC (mA)




                                                                                                                                   4.0 V
                                     0.06
                                                                                                                                   3.3 V
                                     0.04                                                                                          2.7 V

                                     0.02                                                                                          1.8 V

                                       0
                                            0   0.1   0.2         0.3   0.4       0.5          0.6      0.7   0.8       0.9    1
                                                                            Frequency (MHz)


       Figure 31-46. ATmega48A: Reset Supply Current vs. Frequency (1 - 20MHz)

                                     2.5
                                                                                                                                   5.5 V

                                       2                                                                                           5.0 V

                                                                                                                                   4.5 V
                                     1.5
                          ICC (mA)




                                                                                                                    4.0 V
                                       1

                                                                                                    3.3 V
                                     0.5
                                                                                       2.7 V

                                                          1.8 V
                                       0
                                            0   2     4           6     8         10           12       14    16        18    20
                                                                            Frequency (MHz)




        2020 Microchip Technology Inc.                                       Data Sheet Complete                                  DS40002061B-page 350
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-47. ATmega48A: Minimum Reset Pulse width vs. VCC

                                  1600

                                  1400

                                  1200
                Pulsewidth (ns)
                                  1000

                                  800

                                  600

                                  400
                                                                                                85 °C
                                                                                                25 °C
                                  200                                                          -40 °C

                                    0
                                         1.5   2   2.5   3       3.5       4       4.5   5   5.5
                                                               VCC (V)




 2020 Microchip Technology Inc.                             Data Sheet Complete                   DS40002061B-page 351
                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.2   ATmega48PA Typical Characteristics

31.2.1 Active Supply Current

       Figure 31-48. ATmega48PA: Active Supply Current vs. Low Frequency (0.1-1.0MHz)
                                       1
                                                                                                                                   5.5 V

                                 0.8
                                                                                                                                   5.0 V

                                                                                                                                   4.5 V
                                 0.6
                     ICC (mA)




                                                                                                                                   4.0 V

                                 0.4                                                                                               3.3 V
                                                                                                                                   2.7 V
                                 0.2                                                                                               1.8 V


                                       0
                                           0        0.1       0.2      0.3     0.4     0.5       0.6     0.7    0.8     0.9    1
                                                                                 Frequency (MHz)


       Figure 31-49. ATmega48PA: Active Supply Current vs. Frequency (1-20MHz)

                                           11
                                                                                                                                   5.5V
                                           10
                                            9                                                                                      5.0V
                                            8
                                                                                                                                   4.5V
                                            7
                                ICC (mA)




                                            6
                                                                                                                      4.0V
                                            5
                                            4
                                                                                                       3.3V
                                            3
                                            2                                                 2.7V
                                            1
                                                                    1.8V
                                            0
                                                0         2     4          6     8       10      12        14   16      18    20
                                                                                 Frequency (MHz)




        2020 Microchip Technology Inc.                                              Data Sheet Complete                           DS40002061B-page 352
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-50. ATmega48PA: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                                     0.05
                                                                                                 105°C
                             0.045

                                     0.04                                                             85°C

                             0.035
               ICC (mA)


                                     0.03
                                                                                                      25°C
                             0.025                                                                -40°C

                                     0.02

                             0.015

                                     0.01

                             0.005
                                            1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                 VCC (V)



Figure 31-51. ATmega48PA: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                                      1.2                                                         105°C
                                                                                                   85°C
                                      1.1                                                          25°C
                                       1
                                                                                                  -40°C

                                      0.9

                                      0.8
                          ICC (mA)




                                      0.7

                                      0.6

                                      0.5

                                      0.4

                                      0.3

                                      0.2
                                            1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                 VCC (V)




 2020 Microchip Technology Inc.                                Data Sheet Complete                   DS40002061B-page 353
                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-52. ATmega48PA: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                                       5.5
                                                                                                                                       105°C
                                         5                                                                                              85°C
                                                                                                                                        25°C
                                       4.5
                                                                                                                                       -40°C
                                         4

                                       3.5
                            ICC (mA)


                                         3

                                       2.5

                                         2

                                       1.5

                                         1

                                       0.5
                                             1.5         2         2.5         3         3.5           4         4.5         5     5.5
                                                                                       VCC (V)



31.2.2 Idle Supply Current

       Figure 31-53. ATmega48PA: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)

                                  0.16

                                  0.14                                                                                                 5.5V

                                  0.12                                                                                                 5.0V
                                       0.1
                                                                                                                                       4.5V
                       ICC (mA)




                                  0.08                                                                                                 4.0V

                                  0.06
                                                                                                                                       3.3V
                                  0.04                                                                                                 2.7V

                                  0.02
                                                                                                                                       1.8V

                                        0
                                             0     0.1       0.2         0.3   0.4       0.5     0.6       0.7         0.8   0.9   1
                                                                                   Frequency (MHz)




        2020 Microchip Technology Inc.                                               Data Sheet Complete                                DS40002061B-page 354
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-54. ATmega48PA: Idle Supply Current vs. Frequency (1-20MHz)

                                2.6
                                                                                                                      5.5V
                                2.4
                                2.2                                                                                   5.0V
                                 2
                                1.8                                                                                   4.5V
                                1.6
                     ICC (mA)



                                1.4
                                                                                                          4.0V
                                1.2
                                 1
                                0.8
                                                                                         3.3V
                                0.6
                                0.4                                          2.7V
                                0.2
                                                      1.8V
                                 0
                                      0   2       4           6   8     10          12         14   16      18       20
                                                                  Frequency (MHz)



Figure 31-55. ATmega48PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                       0.05
                                                                                                                             105°C
                     0.045

                       0.04                                                                                                     85°C

                     0.035
          ICC (mA)




                       0.03
                                                                                                                              25°C
                     0.025                                                                                                   -40°C

                       0.02

                     0.015

                       0.01

                     0.005
                                  1.5         2         2.5       3          3.5           4        4.5          5        5.5
                                                                        VCC (V)




 2020 Microchip Technology Inc.                                       Data Sheet Complete                                DS40002061B-page 355
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-56. ATmega48PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                    0.33
                                                                                                       105°C
                                                                                                        85°C
                                                                                                        25°C
                    0.28
                                                                                                       -40°C


                    0.23
         ICC (mA)




                    0.18



                    0.13



                    0.08
                            1.5        2       2.5     3         3.5       4         4.5     5       5.5
                                                               VCC (V)


Figure 31-57. ATmega48PA: Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)

                           1.3
                                                                                                           105°C
                           1.2                                                                              85°C
                                                                                                            25°C
                           1.1                                                                             -40°C
                            1
                           0.9
                ICC (mA)




                           0.8
                           0.7
                           0.6
                           0.5
                           0.4
                           0.3
                           0.2
                                 1.5       2    2.5        3      3.5          4       4.5       5     5.5
                                                                VCC (V)




 2020 Microchip Technology Inc.                               Data Sheet Complete                     DS40002061B-page 356
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.2.3 ATmega48PA: Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-3.      ATmega48PA: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz         VCC = 5V, F = 8MHz
         PRUSART0            2.9µA                        20.7µA                     97.4µA
         PRTWI               6.0µA                        44.8µA                     219.7µA
         PRTIM2              5.0µA                        34.5µA                     141.3µA
         PRTIM1              3.6µA                        24.4µA                     107.7µA
         PRTIM0               1.4µA                       9.5µA                      38.4µA
         PRSPI                5.0µA                       38.0µA                     190.4µA
         PRADC                6.1µA                       47.4µA                     244.7µA

       Table 31-4.      ATmega48PA: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption               Additional Current consumption
                             compared to Active with external             compared to Idle with external
                             clock (see Figure 31-48 on page              clock (see Figure 31-53 on page
                             352 and Figure 31-49 on page                 354 and Figure 31-54 on page
         PRR bit             352)                                         355)
         PRUSART0            1.8%                                         11.4%
         PRTWI               3.9%                                         20.6%
         PRTIM2              2.9%                                         15.7%
         PRTIM1              2.1%                                         11.2%
         PRTIM0              0.8%                                         4.2%
         PRSPI               3.3%                                         17.6%
         PRADC               4.2%                                         22.1%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-4 on page 357
       for other VCC and frequency settings than listed in Table 31-3 on page 357.
31.2.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-4 on page 357, third column, we see that we need to add 11.2% for the TIMER1,
       22.1% for the ADC, and 17.6% for the SPI module. Reading from Figure 31-53 on page 354, we find that the
       idle current consumption is ~0.028 mA at VCC = 2.0V and F = 1MHz. The total current consumption in idle mode
       with TIMER1, ADC, and SPI enabled, gives:
         I CC total  0.028 mA  (1 + 0.112 + 0.221 + 0.176)  0.042 mA




         2020 Microchip Technology Inc.                              Data Sheet Complete                   DS40002061B-page 357
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.4 Power-down Supply Current

      Figure 31-58. ATmega48PA: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                              2.7                                                               105°C
                              2.4

                              2.1

                              1.8
                   ICC (μA)




                              1.5

                              1.2

                              0.9                                                                85°C
                                                                                                -40°C
                              0.6

                              0.3
                                                                                                    25°C
                               0
                                    1.5   2   2.5   3      3.5        4       4.5   5         5.5
                                                         VCC (V)

      Figure 31-59. ATmega48PA: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                               9
                                                                                                105°C
                              8.5
                               8
                              7.5                                                               -40°C
                                                                                                 85°C
                               7
                                                                                                 25°C
                              6.5
                   ICC (μA)




                               6
                              5.5
                               5
                              4.5
                               4
                              3.5
                               3
                              2.5
                                    1.5   2   2.5   3      3.5        4       4.5   5         5.5
                                                         VCC (V)




        2020 Microchip Technology Inc.                 Data Sheet Complete                   DS40002061B-page 358
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.5 Power-save Supply Current

      Figure 31-60. ATmega48PA: Power-Save Supply Current vs. VCC
                    (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)

                                          2.5

                                         2.25                                                                               105°C
                                           2

                                         1.75
                   Icc [µA]




                                          1.5

                                         1.25                                                                                   85°C
                                           1

                                         0.75                                                                                   25°C
                                          0.5                                                                                   -40°C
                                         0.25

                                           0
                                                1.5    2    2.5        3             3.5       4         4.5    5         5.5
                                                                             Vcc [V]



31.2.6 Standby Supply Current

      Figure 31-61. ATmega48PA: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)

                                           150                                                                       6MHz_xtal
                                                                                                                     6MHz_res
                                           135

                                           120

                                           105
                                                                                                                     4MHz_res
                                                                                                                     4MHz_xtal
                                            90
                              ICC (μA)




                                            75                                                                       2MHz_res
                                                                                                                     2MHz_xtal
                                            60
                                                                                                                  1MHz_res
                                            45                                                                   450kHz_res
                                            30

                                            15

                                           0.0
                                                 1.5   2   2.5     3         3.5           4       4.5    5    5.5
                                                                           VCC (V)




        2020 Microchip Technology Inc.                                       Data Sheet Complete                           DS40002061B-page 359
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.7 Pin Pull-Up

       Figure 31-62. ATmega48PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)

                               45

                               40

                               35

                               30
                    IOP (μA)




                               25

                               20

                               15

                               10
                                                                                                    105°C
                                5                                                                   -40°C
                                                                                                     25°C
                                0                                                                    85°C
                                    0   0.2   0.4    0.6   0.8         1    1.2   1.4      1.6     1.8
                                                             VOP (V)


       Figure 31-63. ATmega48PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)

                               70


                               60


                               50


                               40
                    IOP (μA)




                               30


                               20


                               10                                                                     25°C
                                                                                                      85°C
                                                                                                     -40°C
                                0                                                                    105°C
                                    0   0.3   0.6    0.9   1.2     1.5      1.8   2.1      2.4     2.7
                                                             VOP (V)




        2020 Microchip Technology Inc.                     Data Sheet Complete                    DS40002061B-page 360
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-64. ATmega48PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)



                         120

                         105

                               90

                               75
           IOP (μA)




                               60

                               45

                               30
                                                                                                                    25°C
                               15                                                                                   85°C
                                                                                                                   105°C
                                0                                                                                  -40°C
                                    0   0.5   1     1.5     2         2.5       3         3.5         4    4.5    5
                                                                  VOP (V)


Figure 31-65. ATmega48PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)

                               35


                               30


                               25
                 IRESET (μA)




                               20


                               15


                               10

                                                                                                                    25°C
                                5
                                                                                                                   -40°C
                                                                                                                   105°C
                                0
                                                                                                                    85°C
                                    0   0.2   0.4     0.6       0.8         1       1.2         1.4       1.6    1.8
                                                                 VRESET (V)




 2020 Microchip Technology Inc.                                 Data Sheet Complete                             DS40002061B-page 361
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-66. ATmega48PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7V)

                               52
                               48
                               44
                               40
                               36
                               32
                IRESET (μA)




                               28
                               24
                               20
                               16
                               12
                                8                                                                            25°C
                                4
                                                                                                            -40°C
                                                                                                             85°C
                                0                                                                           105°C
                                    0   0.3   0.6     0.9       1.2         1.5       1.8     2.1   2.4   2.7
                                                                 VRESET (V)


Figure 31-67. ATmega48PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                              110
                              100
                               90
                               80
                               70
           IRESET (μA)




                               60
                               50
                               40
                               30
                               20                                                                           85°C
                                                                                                            25°C
                               10                                                                          -40°C
                                0                                                                          105°C
                                    0   0.5   1     1.5     2         2.5         3     3.5     4   4.5    5
                                                                 VRESET (V)




 2020 Microchip Technology Inc.                                 Data Sheet Complete                      DS40002061B-page 362
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.8 Pin Driver Strength

       Figure 31-68. ATmega48PA: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                                 1
                                                                                                 105°C
                               0.9                                                                85°C
                               0.8

                               0.7                                                                   25°C
                               0.6
                                                                                                  -40°C
                     VOL (V)




                               0.5

                               0.4

                               0.3

                               0.2

                               0.1

                                 0
                                      0   2   4    6   8      10       12        14   16   18   20
                                                           IOL (mA)


       Figure 31-69. ATmega48PA: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                               0.65
                                0.6                                                              105°C
                                                                                                  85°C
                               0.55
                                0.5
                                                                                                     25°C
                               0.45
                                0.4                                                                  -40°C
                   VOL (V)




                               0.35
                                0.3
                               0.25
                                0.2
                               0.15
                                0.1
                               0.05
                                 0
                                      0   2   4    6   8      10       12        14   16   18   20
                                                            IOL (mA)




        2020 Microchip Technology Inc.                    Data Sheet Complete                  DS40002061B-page 363
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-70. ATmega48PA: I/O Pin Output Voltage vs. Source Current (Vcc = 3V)

                       3

                      2.9

                      2.8

                      2.7

                      2.6
            VOH (V)




                      2.5

                      2.4

                      2.3                                                               -40°C

                      2.2
                                                                                            25°C
                      2.1

                       2
                                                                                         85°C
                      1.9                                                               105°C
                            0   2   4    6    8      10       12        14   16   18   20
                                                   IOH (mA)


Figure 31-71. ATmega48PA: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                       5


                      4.9


                      4.8


                      4.7
            VOH (V)




                      4.6

                                                                                         -40°C
                      4.5
                                                                                            25°C
                      4.4
                                                                                         85°C
                                                                                        105°C
                      4.3
                            0   2   4    6    8      10       12        14   16   18   20
                                                   IOH (mA)




 2020 Microchip Technology Inc.                  Data Sheet Complete                  DS40002061B-page 364
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.9 Pin Threshold and Hysteresis

       Figure 31-72. ATmega48PA: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                                                                                        105°C
                                   2.9                                                                   85°C
                                                                                                        -40°C
                                                                                                         25°C
                                   2.6


                                   2.3
                   Threshold (V)




                                    2


                                   1.7


                                   1.4


                                   1.1


                                   0.8
                                         1.5   2   2.5   3      3.5        4       4.5       5        5.5
                                                              VCC (V)


       Figure 31-73. ATmega48PA: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                                                                                        105°C
                                   2.4                                                                  -40°C
                                                                                                         85°C
                                   2.1
                                                                                                         25°C

                                   1.8
                   Threshold (V)




                                   1.5


                                   1.2


                                   0.9


                                   0.6


                                   0.3
                                         1.5   2   2.5   3      3.5        4       4.5       5        5.5
                                                              VCC (V)




        2020 Microchip Technology Inc.                      Data Sheet Complete                      DS40002061B-page 365
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-74. ATmega48PA: I/O Pin Input Hysteresis vs. VCC

                                    0.6
                                            -40 °C
                                                                                                             25°C
                                   0.55                                                                      85°C
                                                                                                            105°C
                                    0.5                                                                     -40°C
           Input Hysteresis (mV)




                                   0.45
                                                25 °C
                                    0.4


                                   0.35
                                                85 °C

                                    0.3
                                           105 °C
                                   0.25
                                          1.5           2       2.5    3      3.5        4       4.5   5   5.5
                                                                            VCC (V)

Figure 31-75. ATmega48PA: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                                                                                            105°C
                                   2.45                                                                      85°C
                                                                                                            -40°C
                                                                                                             25°C
                                    2.2


                                   1.95
           Threshold (V)




                                    1.7


                                   1.45
                                           -40°C

                                    1.2     25°C
                                            85°C
                                                            105°C
                                   0.95
                                          1.5           2       2.5    3      3.5        4       4.5   5   5.5
                                                                            VCC (V)




 2020 Microchip Technology Inc.                                           Data Sheet Complete             DS40002061B-page 366
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-76. ATmega48PA: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                                                                                       -40°C
                                   2.4                                                                 105°C
                                                                                                        85°C
                                   2.2                                                                  25°C
                                     2

                                   1.8
                Threshold (V)




                                   1.6

                                   1.4

                                   1.2

                                     1

                                   0.8

                                   0.6
                                          1.5          2   2.5   3      3.5        4       4.5   5   5.5
                                                                      VCC (V)

Figure 31-77. ATmega48PA: Reset Pin Input Hysteresis vs. VCC

                                   0.65
                                            -40°C
                                    0.6
                                   0.55
                                    0.5
                                   0.45
           Input Hysteresis (mV)




                                                25°C
                                    0.4
                                   0.35
                                    0.3
                                   0.25         85°C
                                    0.2
                                   0.15    105°C
                                    0.1                                                                 85°C
                                                                                                       105°C
                                   0.05                                                                 25°C
                                     0                                                                 -40°C
                                          1.5          2   2.5   3      3.5        4       4.5   5   5.5
                                                                      VCC (V)




 2020 Microchip Technology Inc.                                     Data Sheet Complete             DS40002061B-page 367
                                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.10 BOD Threshold

      Figure 31-78. ATmega48PA: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                       1.825
                                        1.82
                                                                                                   Rising Vcc
                                       1.815
                                        1.81
                                       1.805
                Threshold (V)




                                         1.8
                                       1.795
                                        1.79
                                       1.785
                                                                                         Falling Vcc
                                        1.78
                                       1.775
                                        1.77
                                       1.765
                                               -40   -30   -20   -10   0   10   20     30    40     50   60     70   80   90   100 110
                                                                                 Temperature (°C)


      Figure 31-79. ATmega48PA: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                        2.76
                                        2.75
                                                                                            Rising Vcc
                                        2.74
                                        2.73
                                        2.72
                       Threshold (V)




                                        2.71
                                         2.7
                                        2.69
                                        2.68
                                                                                     Falling Vcc
                                        2.67
                                        2.66
                                        2.65
                                        2.64
                                               -40   -30   -20   -10   0   10   20     30    40     50   60     70   80   90   100 110
                                                                                 Temperature (°C)




        2020 Microchip Technology Inc.                                               Data Sheet Complete                          DS40002061B-page 368
                                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-80. ATmega48PA: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                      4.34


                                      4.32
                                                                                                              Rising Vcc
                                       4.3
           Threshold (V)




                                      4.28


                                      4.26
                                                                                              Falling Vcc
                                      4.24


                                      4.22


                                       4.2
                                             -40     -30   -20   -10    0    10   20     30         40   50    60   70     80   90   100   110
                                                                                      Temperature (°C)


Figure 31-81. ATmega48PA: Bandgap Voltage vs. VCC

                                      1.1325

                                        1.13

                                      1.1275
                                                                                                                                           105°C
                                       1.125                                                                                                85°C
                Bandgap Voltage [V]




                                                                                                                                             25°C
                                      1.1225

                                        1.12

                                      1.1175

                                       1.115
                                                                                                                                             -40°C
                                      1.1125

                                        1.11
                                               1.5          2          2.5        3           3.5         4         4.5         5      5.5
                                                                                           Vcc [V]




 2020 Microchip Technology Inc.                                                        Data Sheet Complete                                DS40002061B-page 369
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.11 Internal Oscillator Speed

       Figure 31-82. ATmega48PA: Watchdog Oscillator Frequency vs. Temperature

                                  116


                                  114


                                  112
                      FRC (kHz)




                                  110


                                  108

                                                                                                                                        2.7V
                                  106                                                                                                   3.3V
                                                                                                                                        4.0V
                                  104                                                                                                   5.5V
                                        -40   -30   -20   -10     0   10       20    30     40   50       60   70     80   90   100   110
                                                                                    Temperature (°C)


       Figure 31-83. ATmega48PA: Watchdog Oscillator Frequency vs. VCC

                                  116


                                  114                                                                                                   -40°C

                                  112                                                                                                       25°C
                   FRC (kHz)




                                  110


                                  108

                                                                                                                                            85°C
                                  106


                                  104
                                                                                                                                        105°C
                                        1.5         2           2.5        3              3.5         4         4.5         5         5.5
                                                                                      VCC (V)




         2020 Microchip Technology Inc.                                             Data Sheet Complete                              DS40002061B-page 370
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-84. ATmega48PA: Calibrated 8MHz RC Oscillator Frequency vs. VCC
                       8.25
                        8.2
                                                                                                                                  105°C
                       8.15                                                                                                           85°C
                        8.1
                       8.05
                          8
           FRC (MHz)




                       7.95                                                                                                           25°C
                        7.9
                       7.85
                        7.8
                       7.75
                        7.7                                                                                                       -40°C
                       7.65
                              1.5         2           2.5        3              3.5             4         4.5         5         5.5
                                                                            VCC (V)


Figure 31-85. ATmega48PA: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                        8.2
                                                                                                                                  4.0V
                                                                                                                                  3.0V
                       8.15
                                                                                                                                  5.5V
                                                                                                                                  1.8V
                        8.1

                       8.05

                         8
           FRC (MHz)




                       7.95

                        7.9

                       7.85

                        7.8

                       7.75

                        7.7

                       7.65
                              -40   -30   -20   -10     0   10       20    30         40   50       60   70     80   90   100   110
                                                                          Temperature (°C)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                  DS40002061B-page 371
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-86. ATmega48PA: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                                    15                                                                               85°C
                                                                                                                     25°C
                                    14                                                                              105°C
                                    13
                                                                                                                    -40°C

                                    12

                                    11
                       FRC (MHz)



                                    10

                                     9

                                     8

                                     7

                                     6

                                     5

                                     4
                                         0     16   32   48   64    80   96   112 128 144 160 176 192 208 224 240 256
                                                                              OSCCAL (X1)




31.2.12 Current Consumption of Peripheral Units

       Figure 31-87. ATmega48PA: ADC Current vs. VCC (AREF = AVCC)

                                   310                                                                              -40°C
                                                                                                                     25°C
                                   290
                                                                                                                     85°C
                                   270
                                                                                                                    105°C

                                   250
                   ICC (μA)




                                   230

                                   210

                                   190

                                   170

                                   150

                                   130
                                         1.5        2         2.5        3        3.5        4       4.5   5      5.5
                                                                                VCC (V)




        2020 Microchip Technology Inc.                                        Data Sheet Complete                DS40002061B-page 372
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-88. ATmega48PA: Analog Comparator Current vs. VCC

                            90
                                                                                       -40°C
                            85

                            80
                                                                                        25°C
                            75                                                          85°C
                                                                                       105°C
                            70
                ICC (μA)




                            65

                            60

                            55

                            50

                            45
                               105°C
                            40  85°C
                                25°C
                            35 -40°C
                                 1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                      VCC (V)


Figure 31-89. ATmega48PA: AREF External Reference Current vs. VCC
                                                                                       105°C
                           150                                                          85°C
                                                                                        25°C
                           140
                                                                                       -40°C
                           130

                           120

                           110
            ICC (μA)




                           100

                            90

                            80

                            70

                            60

                            50

                            40
                                 1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                      VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete             DS40002061B-page 373
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-90. ATmega48PA: Brownout Detector Current vs. VCC

                         26
                         25
                                                                                     105°C
                         24                                                           85°C
                         23
                                                                                      25°C
                         22                                                          -40°C
              ICC (μA)



                         21
                         20
                         19
                         18
                         17
                         16
                         15
                               1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                    VCC (V)

Figure 31-91. ATmega48PA: Programming Current vs. VCC

                         5.5                                                         -40°C
                          5

                         4.5                                                             25°C
                          4
            ICC (mA)




                         3.5

                          3
                                                                                      85°C
                         2.5                                                         105°C
                          2

                         1.5

                          1
                               1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                    VCC (V)




 2020 Microchip Technology Inc.                   Data Sheet Complete             DS40002061B-page 374
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

31.2.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-92. ATmega48PA: Reset Supply Current vs. Low Frequency (0.1MHz- 1.0MHz)

                                 0.13                                                                                   5.5V
                                 0.12
                                 0.11
                                  0.1
                                                                                                                        5.0V
                                 0.09
                                                                                                                        4.5V
                                 0.08
                  ICC (mA)




                                 0.07                                                                                   4.0V
                                 0.06
                                 0.05                                                                                   3.3V
                                 0.04                                                                                   2.7V
                                 0.03
                                 0.02                                                                                   1.8V
                                 0.01
                                   0
                                        0   0.1   0.2        0.3   0.4      0.5      0.6       0.7   0.8      0.9   1
                                                                    Frequency (MHz)


       Figure 31-93. ATmega48PA: Reset Supply Current vs. Frequency (1MHz- 20MHz)

                                  2.4
                                                                                                                         5.5V
                                  2.2
                                   2                                                                                     5.0V
                                  1.8
                                                                                                                         4.5V
                                  1.6
                                  1.4
                      ICC (mA)




                                  1.2                                                                      4.0V
                                   1
                                  0.8
                                                                                           3.3V
                                  0.6
                                  0.4
                                                                              2.7V
                                  0.2
                                                      1.8V
                                   0
                                        0   2     4          6     8        10       12        14    16       18    20
                                                                     Frequency (MHz)




        2020 Microchip Technology Inc.                                  Data Sheet Complete                        DS40002061B-page 375
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-94. ATmega48PA: Minimum Reset Pulse width vs. VCC

                             1600
                             1500
                             1400
                             1300
                             1200
                             1100
           Pulsewidth (ns)




                             1000
                              900
                              800
                              700
                              600
                              500
                              400
                                                                                          105°C
                              300                                                          85°C
                              200
                                                                                           25°C
                                                                                          -40°C
                                    1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete             DS40002061B-page 376
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

31.3   ATmega88A Typical Characteristics

31.3.1 Active Supply Current

       Figure 31-95. ATmega88A: Active Supply Current vs. Low Frequency (0.1-1.0MHz)

                                      1
                                                                                                                                   5.5 V

                                     0.8                                                                                           5.0 V

                                                                                                                                   4.5 V
                                     0.6
                        ICC (mA)




                                                                                                                                   4.0 V

                                     0.4                                                                                           3.3 V
                                                                                                                                   2.7 V
                                     0.2                                                                                           1.8 V


                                      0
                                           0   0.1   0.2         0.3   0.4       0.5          0.6       0.7   0.8       0.9   1
                                                                           Frequency (MHz)




       Figure 31-96. ATmega88A: Active Supply Current vs. Frequency (1 - 20MHz)
                                     12

                                                                                                                                   5.5 V
                                     10
                                                                                                                                   5.0 V
                                      8
                                                                                                                                   4.5 V
                          ICC (mA)




                                      6
                                                                                                                    4.0 V
                                      4
                                                                                                    3.3 V
                                                                                      2.7 V
                                      2

                                                         1.8 V
                                      0
                                           0   2     4           6     8         10           12        14    16        18    20
                                                                        Frequency (MHz)




        2020 Microchip Technology Inc.                                      Data Sheet Complete                                   DS40002061B-page 377
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-97. ATmega88A: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)
                             0.12                                                               -40 °C
                                                                                                 25 °C
                                                                                                 85 °C
                             0.09

                ICC (mA)

                             0.06




                             0.03




                               0
                                    1.5   2   2.5   3       3.5       4       4.5   5     5.5
                                                          VCC (V)




Figure 31-98. ATmega88A: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)
                             1.2                                                                85 °C
                                                                                                25 °C
                               1                                                            -40 °C


                             0.8
                  ICC (mA)




                             0.6


                             0.4


                             0.2


                               0
                                   1.5    2   2.5   3      3.5       4        4.5   5     5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                     DS40002061B-page 378
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-99. ATmega88A: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)
                                        5                                                                                                  85 °C
                                                                                                                                           25 °C
                                                                                                                                         -40 °C
                                        4



                            ICC (mA)    3



                                        2



                                        1



                                        0
                                            1.5      2          2.5         3             3.5            4         4.5         5     5.5
                                                                                         VCC (V)



31.3.2 Idle Supply Current

       Figure 31-100. ATmega88A: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)
                                       0.15


                                                                                                                                            5.5 V
                                       0.12

                                                                                                                                            5.0 V
                                       0.09                                                                                                 4.5 V
                        I CC (mA)




                                                                                                                                            4.0 V
                                       0.06
                                                                                                                                            3.3 V
                                                                                                                                            2.7 V
                                       0.03
                                                                                                                                            1.8 V

                                            0
                                                0   0.1   0.2         0.3       0.4        0.5     0.6       0.7         0.8   0.9   1
                                                                                      Frequency (MHz)




        2020 Microchip Technology Inc.                                                Data Sheet Complete                                  DS40002061B-page 379
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-101. ATmega88A: Idle Supply Current vs. Frequency (1-20MHz)
                               2.5

                                                                                                                                 5.5 V
                                 2
                                                                                                                                 5.0 V

                                                                                                                                 4.5 V
                   I CC (mA)   1.5

                                                                                                                    4.0 V
                                 1

                                                                                                3.3 V
                               0.5
                                                                                   2.7 V

                                                        1.8 V
                                 0
                                      0     2       4           6   8         10           12       14         16      18   20
                                                                        Frequency (MHz)




Figure 31-102. ATmega88A: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)
                               0.04


                                                                                                                                   85 °C
                               0.03

                                                                                                                                  25 °C
                 ICC (mA)




                                                                                                                                 -40 °C
                               0.02




                               0.01




                                 0
                                      1.5       2         2.5       3          3.5              4        4.5           5     5.5
                                                                             VCC (V)




 2020 Microchip Technology Inc.                                          Data Sheet Complete                                      DS40002061B-page 380
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-103. ATmega88A: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)
                             0.35
                                                                                           85 °C
                              0.3                                                          25 °C
                                                                                          -40 °C
                             0.25


                              0.2
                 ICC (mA)



                             0.15


                              0.1


                             0.05


                               0
                                    1.5   2   2.5   3       3.5       4       4.5   5   5.5
                                                          VCC (V)


Figure 31-104. ATmega88A: Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)
                             1.2

                                                                                           85 °C
                                                                                           25 °C
                             0.9                                                          -40 °C
                  ICC (mA)




                             0.6




                             0.3




                               0
                                   1.5    2   2.5   3       3.5      4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                   DS40002061B-page 381
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.3.3 ATmega88A: Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-5.      ATmega88A: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz         VCC = 5V, F = 8MHz
         PRUSART0            3.0µA                        21.3µA                     97.9µA
         PRTWI               6.1µA                        45.4µA                     219.0µA
         PRTIM2              5.2µA                        35.2µA                     149.5µA
         PRTIM1              3.8µA                        25.6µA                     110.0µA
         PRTIM0               1.5µA                       9.8µA                      39.6µA
         PRSPI                5.2µA                       40.0µA                     199.6µA
         PRADC                6.3µA                       48.7µA                     247.0µA

       Table 31-6.      ATmega88A: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption               Additional Current consumption
                             compared to Active with external             compared to Idle with external
                             clock (see Figure 31-142 on page             clock (see Figure 31-147 on page
                             401 and Figure 31-143 on page                404 and Figure 31-148 on page
         PRR bit             402)                                         404)
         PRUSART0            1.8%                                         11.4%
         PRTWI               3.9%                                         24.4%
         PRTIM2              2.9%                                         18.6%
         PRTIM1              2.1%                                         13.6%
         PRTIM0              0.8%                                         5.2%
         PRSPI               3.5%                                         21.5%
         PRADC               4.2%                                         26.3%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-8 on page 407
       for other VCC and frequency settings than listed in Table 31-7 on page 407.
31.3.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-8 on page 407, third column, we see that we need to add 13.6% for the TIMER1,
       26.3% for the ADC, and 21.5% for the SPI module. Reading from Figure 31-147 on page 404, we find that the
       idle current consumption is ~0.027 mA at VCC = 2.0V and F = 1MHz. The total current consumption in idle mode
       with TIMER1, ADC, and SPI enabled, gives:
         I CC total  0.027 mA  (1 + 0.136 + 0.263 + 0.215)  0.043 mA




         2020 Microchip Technology Inc.                              Data Sheet Complete                    DS40002061B-page 382
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.4 Power-down Supply Current

      Figure 31-105. ATmega88A: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)
                                      1.6
                                                                                                            85 °C
                                      1.4

                                      1.2

                                       1
                        ICC (uA)




                                      0.8

                                      0.6

                                      0.4
                                                                                                            25 °C
                                      0.2

                                       0                                                                   -40 °C
                                            1.5   2   2.5   3       3.5      4         4.5       5    5.5
                                                                 VCC (V)




      Figure 31-106. ATmega88A: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)
                                       8                                                                85 °C
                                                                                                       -40 °C
                                                                                                           25 °C
                                       6
                           ICC (uA)




                                       4




                                       2




                                       0
                                           1.5    2   2.5   3     3.5       4         4.5    5       5.5
                                                                 VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete                         DS40002061B-page 383
                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.5 Power-save Supply Current

      Figure 31-107. ATmega88A: Power-Save Supply Current vs. VCC
                     (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)
                                   3



                             2.5
                                                                                                                             85 °C


                                   2                                                                                         -40 °C
                  ICC (uA)




                             1.5
                                                                                                                             25 °C

                                   1



                             0.5



                                   0
                                        1.5          2       2.5      3      3.5         4            4.5       5          5.5
                                                                          VCC (V)




31.3.6 Standby Supply Current

      Figure 31-108. ATmega88A: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)
                                        0.18

                                        0.16                                                                          6MHz_res
                                                                                                                      6MHz_xtal
                                        0.14

                                        0.12                                                                          4MHz_res
                                                                                                                      4MHz_xtal
                             ICC (mA)




                                         0.1

                                        0.08                                                                          2MHz_res
                                                                                                                      2MHz_xtal
                                        0.06                                                                          450kHz_res

                                        0.04

                                        0.02

                                          0
                                               1.5       2    2.5     3     3.5      4          4.5         5       5.5
                                                                          VCC (V)




        2020 Microchip Technology Inc.                                   Data Sheet Complete                             DS40002061B-page 384
                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.7 Pin Pull-Up

       Figure 31-109. ATmega88A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8 V)
                                   50



                                   40



                                   30
                        IOP (uA)




                                   20



                                   10
                                                                                                                   25 °C
                                                                                                                  -40 °C
                                    0                                                                              85 °C
                                        0   0.2         0.4     0.6   0.8         1   1.2   1.4         1.6   1.8
                                                                        VOP (V)




       Figure 31-110. ATmega88A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7 V)
                                   80

                                   70

                                   60

                                   50
                        IOP (uA)




                                   40

                                   30

                                   20
                                                                                                                    25 °C
                                   10                                                                             -40 °C
                                                                                                                    85 °C
                                   0
                                        0         0.5           1           1.5       2           2.5         3
                                                                        VOP (V)




        2020 Microchip Technology Inc.                               Data Sheet Complete                           DS40002061B-page 385
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-111. ATmega88A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5 V)
                                140


                                120


                                100


                                80
                 IOP (uA)



                                60


                                40
                                                                                                                       25 °C
                                20
                                                                                                                       85 °C
                                                                                                                      -40 °C
                                 0
                                      0         1             2                       3               4          5
                                                                        VOP (V)




Figure 31-112. ATmega88A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8 V)
                                40

                                35

                                30

                                25
                  IRESET (uA)




                                20

                                15

                                10                                                                                    25 °C

                                 5                                                                                -40 °C
                                                                                                                      85 °C
                                 0
                                      0   0.2   0.4     0.6       0.8             1       1.2   1.4       1.6   1.8
                                                                   VRESET (V)




 2020 Microchip Technology Inc.                                   Data Sheet Complete                                 DS40002061B-page 386
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-113. ATmega88A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7 V)
                                60


                                50


                                40
                  IRESET (uA)

                                30


                                20

                                                                                                                          25 °C
                                10
                                                                                                                         -40 °C
                                                                                                                          85 °C
                                 0
                                      0         0.5              1          1.5            2             2.5         3
                                                                         VRESET (V)


Figure 31-114. ATmega88A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5 V)
                                120


                                100


                                80
                 IRESET (uA)




                                60


                                40


                                20
                                                                                                                          25 °C
                                                                                                                         -40 °C
                                 0
                                                                                                                          85 °C
                                      0   0.5         1    1.5       2       2.5       3       3.5   4         4.5   5
                                                                          VRESET (V)




 2020 Microchip Technology Inc.                                         Data Sheet Complete                              DS40002061B-page 387
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.8 Pin Driver Strength

       Figure 31-115. ATmega88A: I/O Pin Output Voltage vs. Sink Current (VCC = 3 V)
                                    1

                                                                                             85 °C
                                   0.8

                                                                                             25 °C
                                   0.6
                        VOL (V)




                                                                                             -40 °C

                                   0.4



                                   0.2



                                    0
                                         0   4          8                12        16   20
                                                             IOL (mA)


       Figure 31-116. ATmega88A: I/O Pin Output Voltage vs. Sink Current (VCC = 5 V)
                                   0.6
                                                                                             85 °C
                                   0.5
                                                                                             25 °C

                                   0.4                                                       -40 °C
                        V OL (V)




                                   0.3


                                   0.2


                                   0.1


                                     0
                                         0   4          8                12        16   20
                                                             I OL (mA)




        2020 Microchip Technology Inc.                     Data Sheet Complete               DS40002061B-page 388
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-117. ATmega88A: I/O Pin Output Voltage vs. Source Current (Vcc = 3 V)
                           3.5


                            3


                           2.5
                                                                                    -40 °C
                                                                                     25 °C
                            2                                                        85 °C
                 VOH (V)



                           1.5


                            1


                           0.5


                            0
                                 0   4           8               12         16     20
                                                      IOH (mA)


Figure 31-118. )ATmega88A: I/O Pin Output Voltage vs. Source Current (VCC = 5 V)
                            5

                           4.9

                           4.8

                           4.7
                 VOH (V)




                           4.6
                                                                                    -40 °C
                           4.5
                                                                                        25 °C
                           4.4                                                          85 °C

                           4.3

                           4.2
                                 0   4           8               12         16     20
                                                      IOH (mA)




 2020 Microchip Technology Inc.                     Data Sheet Complete                DS40002061B-page 389
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.9 Pin Threshold and Hysteresis

       Figure 31-119. ATmega88A: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                         3                                                               85 °C
                                                                                                        -40 °C
                                        2.5                                                              25 °C


                                         2
                        Threshold (V)




                                        1.5


                                         1


                                        0.5


                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5       5.5
                                                                   VCC (V)




       Figure 31-120. ATmega88A: I/O Pin Input Threshold, Voltage vs. VCC (VIL, I/O Pin read as ‘0’

                                        2.5                                                             -40 °C
                                                                                                         85 °C
                                                                                                         25 °C
                                         2
                        Threshold (V)




                                        1.5



                                         1



                                        0.5



                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5       5.5
                                                                   VCC (V)




        2020 Microchip Technology Inc.                           Data Sheet Complete                       DS40002061B-page 390
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-121. ATmega88A: I/O Pin Input Hysteresis vs. VCC

                                        0.6
                                                                                                              25 °C
                                                                                                              85 °C
                                        0.5
                                                                                                             -40 °C

                                        0.4
                 Input Hysteresis (V)


                                        0.3


                                        0.2


                                        0.1


                                         0
                                              1.5   2   2.5   3      3.5          4      4.5       5    5.5
                                                                   VCC (V)




Figure 31-122. ATmega88A: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                        1.5
                                                                                                             -40 °C
                                                                                                              25 °C
                                                                                                              85 °C
                                        1.2



                                        0.9
                  Threshold (V)




                                        0.6



                                        0.3



                                          0
                                              1.5   2   2.5   3     3.5       4         4.5    5       5.5
                                                                   V CC (V)




 2020 Microchip Technology Inc.                                  Data Sheet Complete                         DS40002061B-page 391
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-123. ATmega88A: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                        2.5                                                              85 °C
                                                                                                         25 °C
                                                                                                        -40 °C
                                          2



                  Threshold (V)         1.5



                                          1



                                        0.5



                                          0
                                              1.5   2   2.5   3     3.5       4         4.5   5   5.5
                                                                   V CC (V)


Figure 31-124. ATmega88A: Reset Pin Input Hysteresis vs. VCC

                                        0.6


                                        0.5


                                        0.4
                 Input Hysteresis (V)




                                        0.3


                                        0.2
                                                                                                         85 °C
                                        0.1
                                                                                                         25 °C
                                                                                                        -40 °C

                                          0
                                              1.5   2   2.5   3     3.5       4         4.5   5   5.5
                                                                   V CC (V)




 2020 Microchip Technology Inc.                                  Data Sheet Complete                    DS40002061B-page 392
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.10 BOD Threshold

      Figure 31-125. ATmega88A: BOD Thresholds vs. Temperature (BODLEVEL is 1.8 V)
                                       1.83

                                                                                  Rising Vcc
                                       1.82


                                       1.81
                       Threshold (V)




                                        1.8


                                       1.79
                                                                                 Falling Vcc
                                       1.78


                                       1.77
                                              -50   -40   -30   -20   -10   0   10    20    30     40   50   60   70   80   90
                                                                                Temperature (°C)




      Figure 31-126. ATmega88A: BOD Thresholds vs. Temperature (BODLEVEL is 2.7 V)

                                       2.76
                                                                                 Rising Vcc
                                       2.74


                                       2.72
                       Threshold (V)




                                        2.7

                                                                                 Falling Vcc
                                       2.68


                                       2.66


                                       2.64
                                              -50   -40   -30   -20   -10   0   10    20    30     40   50   60   70   80   90
                                                                                Temperature (°C)




        2020 Microchip Technology Inc.                                           Data Sheet Complete                            DS40002061B-page 393
                                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-127. ATmega88A: BOD Thresholds vs. Temperature (BODLEVEL is 4.3 V)

                                                    4.34
                                                                                                    Rising Vcc

                                                    4.32



                                    Threshold (V)    4.3


                                                    4.28

                                                                                                    Falling Vcc
                                                    4.26


                                                    4.24


                                                    4.22
                                                           -50   -40   -30   -20     -10   0       10     20      30       40   50     60   70   80   90
                                                                                                   Temperature (°C)




Figure 31-128. ATmega88A: Bandgap Voltage vs. VCC

                                           1.103

                                           1.102


                                           1.101
              Bandgap Voltage (V)




                                                    1.1
                                                                                                                                                            25 °C
                                           1.099


                                           1.098

                                                                                                                                                        -40 °C
                                           1.097
                                                                                                                                                         85 °C
                                           1.096
                                                          1.5          2       2.5             3          3.5          4         4.5         5        5.5
                                                                                                        VCC (V)




 2020 Microchip Technology Inc.                                                                     Data Sheet Complete                                    DS40002061B-page 394
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.11 Internal Oscillator Speed

       Figure 31-129. ATmega88A: Watchdog Oscillator Frequency vs. Temperature
                                       114

                                       113

                                       112

                                       111
                           FRC (kHz)




                                       110

                                       109

                                       108
                                                                                                                     2.7 V
                                       107                                                                           3.3 V
                                                                                                                     4.0 V
                                       106
                                                                                                                     5.5 V
                                       105
                                             -40       -20         0       20             40       60     80   100
                                                                           Temperature (°C)




       Figure 31-130. ATmega88A: Watchdog Oscillator Frequency vs. VCC

                                       116


                                       114

                                                                                                                 -40 °C
                                       112
                         FRC (kHz)




                                                                                                                     25 °C
                                       110


                                       108


                                       106                                                                           85 °C

                                       104
                                             1.5   2         2.5       3         3.5           4    4.5    5   5.5
                                                                                VCC (V)




         2020 Microchip Technology Inc.                                    Data Sheet Complete                      DS40002061B-page 395
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-131. ATmega88A: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                                8.3
                                                                                                              85 °C
                                8.2


                                8.1
                                                                                                              25 °C
                 FRC (MHz)
                                 8


                                7.9
                                                                                                          -40 °C
                                7.8


                                7.7


                                7.6
                                      1.5   2     2.5       3          3.5          4        4.5    5   5.5
                                                                     VCC (V)




Figure 31-132. ATmega88A: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                                8.3

                                                                                                              5.5 V
                                8.2                                                                           4.0 V
                                                                                                              3.0 V
                                8.1
                   F RC (MHz)




                                  8



                                7.9



                                7.8
                                      -40   -20         0       20             40       60         80   100
                                                                Temperature (°C)




 2020 Microchip Technology Inc.                                 Data Sheet Complete                          DS40002061B-page 396
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-133. ATmega88A: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                                      14
                                                                                                                        85 °C
                                      12                                                                                25 °C
                                                                                                                       -40 °C
                                      10
                          FRC (MHz)
                                       8


                                       6


                                       4


                                       2


                                       0
                                            0     16   32   48   64    80   96   112 128 144 160 176 192 208 224 240 256
                                                                                 OSCCAL (X1)




31.3.12 Current Consumption of Peripheral Units

       Figure 31-134. ATmega88A: ADC Current vs. VCC (AREF = AVCC)

                                      300                                                                              -40 °C
                                                                                                                        25 °C
                                                                                                                        85 °C
                                      250


                                      200
                        ICC (uA)




                                      150


                                      100


                                      50


                                       0
                                            1.5        2         2.5        3        3.5       4        4.5   5      5.5
                                                                                    VCC (V)




        2020 Microchip Technology Inc.                                           Data Sheet Complete                      DS40002061B-page 397
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-135. ATmega88A: Analog Comparator Current vs. VCC
                              90
                                                                                          -40 °C
                              80                                                           25 °C
                                                                                           85 °C
                              70

                              60
                   ICC (uA)
                              50

                              40

                              30

                              20

                              10

                               0
                                   1.5    2   2.5   3      3.5       4        4.5   5   5.5
                                                         VCC (V)




Figure 31-136. ATmega88A: AREF External Reference Current vs. VCC

                              160                                                              85 °C
                                                                                               25 °C
                              140                                                             -40 °C
                              120

                              100
                 ICC (uA)




                              80

                              60

                              40

                              20

                               0
                                    1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 398
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-137. ATmega88A: Brownout Detector Current vs. VCC

                               50



                               40



                               30
                  I CC (uA)

                                                                                                   85 °C
                                                                                                   25 °C
                               20
                                                                                                  -40 °C


                               10



                                0
                                    1.5   2   2.5   3     3.5       4         4.5   5       5.5
                                                         V CC (V)




Figure 31-138. ATmega88A: Programming Current vs. VCC

                               8
                                                                                                  -40 °C
                               7                                                                   25 °C

                               6
                                                                                                  85 °C
                               5
                    ICC (mA)




                               4

                               3

                               2

                               1

                               0
                                   1.5    2   2.5   3     3.5        4        4.5       5    5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                         DS40002061B-page 399
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

31.3.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-139. ATmega88A: Reset Supply Current vs. Low Frequency (0.1 - 1.0MHz)

                                      0.12

                                                                                                                                  5.5 V
                                       0.1

                                                                                                                                  5.0 V
                                      0.08
                                                                                                                                  4.5 V
                        ICC (mA)




                                      0.06                                                                                        4.0 V

                                                                                                                                  3.3 V
                                      0.04
                                                                                                                                  2.7 V
                                                                                                                                  1.8 V
                                      0.02


                                        0
                                             0   0.1   0.2         0.3   0.4       0.5       0.6       0.7   0.8       0.9   1
                                                                             Frequency (MHz)




       Figure 31-140. ATmega88A: Reset Supply Current vs. Frequency (1 - 20MHz)
                                        2                                                                                        5.5 V

                                                                                                                                 5.0 V
                                      1.6
                                                                                                                                 4.5 V
                                      1.2
                           ICC (mA)




                                                                                                                   4.0 V

                                      0.8
                                                                                                   3.3 V

                                      0.4
                                                                                     2.7 V

                                                           1.8 V
                                        0
                                             0   2     4           6     8         10        12        14    16        18    20
                                                                          Frequency (MHz)




        2020 Microchip Technology Inc.                                        Data Sheet Complete                                DS40002061B-page 400
                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-141. ATmega88A: Minimum Reset Pulse width vs. VCC
                                                1600

                                                1400

                                                1200

                              Pulsewidth (ns)   1000

                                                800

                                                600

                                                400                                                                                85 °C
                                                                                                                                   25 °C
                                                200                                                                               -40 °C
                                                  0
                                                       1.5     2     2.5    3          3.5        4       4.5         5         5.5
                                                                                     VCC (V)




31.4   ATmega88PA Typical Characteristics

31.4.1 Active Supply Current

       Figure 31-142. ATmega88PA: Active Supply Current vs. Low Frequency (0.1-1.0MHz)

                           0.14


                           0.12
                                                                                                                                            5.5V

                            0.1                                                                                                             5.0V

                                                                                                                                            4.5V
                           0.08
                ICC (mA)




                                                                                                                                            4.0V
                           0.06
                                                                                                                                            3.3V
                           0.04                                                                                                             2.7V
                                                                                                                                            1.8V
                           0.02


                             0
                                            0            0.1   0.2    0.3   0.4       0.5      0.6      0.7     0.8       0.9           1
                                                                                Frequency (MHz)




        2020 Microchip Technology Inc.                                           Data Sheet Complete                                 DS40002061B-page 401
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-143. ATmega88PA: Active Supply Current vs. Frequency (1 - 20MHz)

                          12


                          10
                                                                                                                                     5.5V

                                                                                                                                     5.0V
                           8
                                                                                                                                     4.5V
               ICC (mA)




                           6
                                                                                                                   4.0V
                           4
                                                                                                3.3V
                                                                                2.7V
                           2

                                                  1.8V
                           0
                                0     2       4          6       8         10          12          14         16         18     20
                                                                     Frequency (MHz)



Figure 31-144. ATmega88PA: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                     0.14
                                                                                                                                     105°C
                     0.12
                                                                                                                                     -40°C
                                                                                                                                      25°C
                          0.1
                                                                                                                                     85°C
                     0.08
         ICC (mA)




                     0.06


                     0.04


                     0.02


                           0
                                1.5       2        2.5       3             3.5              4           4.5          5         5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                       Data Sheet Complete                                    DS40002061B-page 402
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-145. ATmega88PA: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                       1.4

                                                                                             105°C
                       1.2
                                                                                              85°C
                            1
                                                                                              25°C
                                                                                             -40°C
                       0.8
           ICC (mA)




                       0.6


                       0.4


                       0.2


                            0
                                1.5   2   2.5      3      3.5         4      4.5    5      5.5
                                                        VCC (V)




Figure 31-146. ATmega88PA: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                            6

                                                                                             105°C
                            5                                                                 85°C
                                                                                              25°C
                                                                                             -40°C
                            4
                 ICC (mA)




                            3


                            2


                            1


                            0
                                1.5   2   2.5      3      3.5        4       4.5    5      5.5
                                                        VCC (V)




 2020 Microchip Technology Inc.                       Data Sheet Complete                DS40002061B-page 403
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.2 Idle Supply Current

       Figure 31-147. ATmega88PA: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)
                                   0.15


                                                                                                                             5.5 V
                                   0.12

                                                                                                                             5.0 V
                                   0.09                                                                                      4.5 V
                        ICC (mA)




                                                                                                                             4.0 V
                                   0.06
                                                                                                                             3.3 V
                                                                                                                             2.7 V
                                   0.03
                                                                                                                             1.8 V

                                     0
                                          0   0.1   0.2         0.3   0.4       0.5      0.6      0.7   0.8       0.9    1
                                                                          Frequency (MHz)




       Figure 31-148. ATmega88PA: Idle Supply Current vs. Frequency (1 - 20MHz)
                                   2.5

                                                                                                                             5.5 V
                                    2
                                                                                                                             5.0 V

                                                                                                                             4.5 V
                                   1.5
                        ICC (mA)




                                                                                                              4.0 V
                                    1

                                                                                              3.3 V
                                   0.5
                                                                                 2.7 V

                                                        1.8 V
                                    0
                                          0   2     4           6     8        10        12       14    16        18    20
                                                                       Frequency (MHz)




        2020 Microchip Technology Inc.                                     Data Sheet Complete                              DS40002061B-page 404
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-149. ATmega88PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                        0.05

                       0.045

                        0.04
                                                                                               105°C

                       0.035
                                                                                                   85°C
                        0.03
        ICC (mA)




                       0.025                                                                        25°C
                                                                                                   -40°C
                        0.02

                       0.015

                        0.01

                       0.005

                          0
                               1.5   2   2.5      3      3.5         4      4.5         5    5.5
                                                       VCC (V)



Figure 31-150. ATmega88PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                         0.4

                        0.35
                                                                                               105°C
                                                                                                   85°C
                         0.3
                                                                                                   25°C
                        0.25                                                                       -40°C
            ICC (mA)




                         0.2

                        0.15

                         0.1

                        0.05

                          0
                               1.5   2   2.5      3      3.5         4      4.5         5    5.5
                                                       VCC (V)




 2020 Microchip Technology Inc.                      Data Sheet Complete                   DS40002061B-page 405
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-151. ATmega88PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                     1.2
                                                                                               105°C
                                                                                                85°C
                      1
                                                                                                25°C
                                                                                                -40°C
                     0.8
          ICC (mA)




                     0.6


                     0.4


                     0.2


                      0
                           1.5   2   2.5      3        3.5        4       4.5           5    5.5
                                                     VCC (V)




 2020 Microchip Technology Inc.                    Data Sheet Complete                     DS40002061B-page 406
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.4.3 ATmega88PA: Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-7.      ATmega88PA: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz         VCC = 5V, F = 8MHz
         PRUSART0            3.0µA                        21.3µA                     97.9µA
         PRTWI               6.1µA                        45.4µA                     219.0µA
         PRTIM2              5.2µA                        35.2µA                     149.5µA
         PRTIM1              3.8µA                        25.6µA                     110.0µA
         PRTIM0               1.5µA                       9.8µA                      39.6µA
         PRSPI                5.2µA                       40.0µA                     199.6µA
         PRADC                6.3µA                       48.7µA                     247.0µA

       Table 31-8.      ATmega88PA: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption               Additional Current consumption
                             compared to Active with external             compared to Idle with external
                             clock (see Figure 31-142 on page             clock (see Figure 31-147 on page
                             401 and Figure 31-143 on page                404 and Figure 31-148 on page
         PRR bit             402)                                         404)
         PRUSART0            1.8%                                         11.4%
         PRTWI               3.9%                                         24.4%
         PRTIM2              2.9%                                         18.6%
         PRTIM1              2.1%                                         13.6%
         PRTIM0              0.8%                                         5.2%
         PRSPI               3.5%                                         21.5%
         PRADC               4.2%                                         26.3%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-8 for other VCC
       and frequency settings than listed in Table 31-7.
31.4.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-8, third column, we see that we need to add 13.6% for the TIMER1, 26.3% for the
       ADC, and 21.5% for the SPI module. Reading from Figure 31-147 on page 404, we find that the idle current
       consumption is ~0.027 mA at VCC = 2.0V and F = 1MHz. The total current consumption in idle mode with
       TIMER1, ADC, and SPI enabled, gives:
         I CC total  0.027 mA  (1 + 0.136 + 0.263 + 0.215)  0.043 mA




         2020 Microchip Technology Inc.                              Data Sheet Complete                    DS40002061B-page 407
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.4 Power-down Supply Current

      Figure 31-152. ATmega88PA: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                                 5


                                                                                                                 105°C
                                 4



                                 3
                      ICC (μA)




                                 2

                                                                                                                     85°C
                                 1

                                                                                                                      25°C
                                 0                                                                                   -40°C
                                     1.5   2      2.5      3      3.5        4       4.5            5          5.5
                                                                VCC (V)



      Figure 31-153. ATmega88PA: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                             12


                             10
                                                                                           105°C
                                 8
                                                                                            -40°C
                  ICC (μA)




                                 6
                                                                                                        25°C
                                 4

                                               85°C
                                 2


                                 0
                                     1.5   2      2.5      3      3.5         4      4.5            5          5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                        Data Sheet Complete                         DS40002061B-page 408
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.5 Power-save Supply Current

      Figure 31-154. ATmega88PA: Power-Save Supply Current vs. VCC (Watchdog Timer Disabled and 32kHz Crystal
                     Oscillator Running)

                                6




                                                                                                                         105°C
                                4
                    ICC (μA)




                                                                                                                             85°C
                                2

                                                                                                                           25°C
                                                                                                                          -40°C

                                0
                                    1.5          2       2.5      3       3.5         4           4.5       5          5.5
                                                                        VCC (V)



31.4.6 Standby Supply Current

      Figure 31-155. ATmega88PA: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)
                                    0.18

                                    0.16                                                                          6MHz_res
                                                                                                                  6MHz_xtal
                                    0.14

                                    0.12                                                                          4MHz_res
                                                                                                                  4MHz_xtal
                         ICC (mA)




                                     0.1

                                    0.08                                                                          2MHz_res
                                                                                                                  2MHz_xtal
                                    0.06                                                                          450kHz_res

                                    0.04

                                    0.02

                                      0
                                           1.5       2   2.5      3     3.5       4         4.5         5       5.5
                                                                      VCC (V)




        2020 Microchip Technology Inc.                               Data Sheet Complete                             DS40002061B-page 409
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.7 Pin Pull-Up

       Figure 31-156. ATmega88PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)

                              60


                              50


                              40
                   IOP (μA)




                              30


                              20
                                                                                                                              25°C

                              10
                                                                                                                             -40°C
                                                                                                                              85°C
                               0                                                                                             105°C
                                   0   0.2         0.4   0.6       0.8       1       1.2       1.4   1.6         1.8     2
                                                                          VOP (V)



       Figure 31-157. ATmega88PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)

                              80

                              70

                              60

                              50
                  IOP (μA)




                              40

                              30

                              20                                                                                             25°C
                                                                                                                             -40°C
                              10
                                                                                                                              85°C
                               0
                                                                                                                             105°C
                                   0         0.5               1            1.5            2               2.5           3
                                                                          VOP (V)




        2020 Microchip Technology Inc.                                  Data Sheet Complete                           DS40002061B-page 410
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-158. ATmega88PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)

                           160

                           140

                           120

                           100
          IOP (μA)




                            80

                            60

                                                                                                                         25°C
                            40
                                                                                                                        -40°C
                            20                                                                                           85°C
                                                                                                                        105°C
                             0
                                 0         1               2             3              4               5           6
                                                                      VOP (V)



Figure 31-159. ATmega88PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)

                           40

                           35

                           30

                           25
             IRESET (μA)




                           20

                           15

                           10                                                                                            25°C
                                                                                                                        -40°C
                            5                                                                                            85°C
                                                                                                                        105°C
                            0
                                 0   0.2       0.4   0.6       0.8       1        1.2       1.4   1.6       1.8     2
                                                                     VRESET (V)




 2020 Microchip Technology Inc.                                     Data Sheet Complete                          DS40002061B-page 411
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-160. ATmega88PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7V)

                              60


                              50


                              40
                IRESET (μA)




                              30


                              20
                                                                                                      25°C
                              10                                                                     -40°C
                                                                                                      85°C
                                                                                                     105°C
                               0
                                   0   0.5    1        1.5           2          2.5              3
                                                    VRESET (V)



Figure 31-161. ATmega88PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                          120


                          100


                              80
          IRESET (μA)




                              60


                              40
                                                                                                      25°C
                              20                                                                     -40°C
                                                                                                      85°C
                                                                                                     105°C
                               0
                                   0   1      2         3            4           5               6
                                                    VRESET (V)




 2020 Microchip Technology Inc.                   Data Sheet Complete                         DS40002061B-page 412
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.8 Pin Driver Strength

       Figure 31-162. ATmega88PA: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                            1.2


                             1
                                                                                        105°C
                                                                                         85°C
                            0.8

                                                                                            25°C
                  VOL (V)




                            0.6
                                                                                            -40°C
                            0.4


                            0.2


                             0
                                  0       5           10               15              20             25
                                                            IOL (mA)



       Figure 31-163. ATmega88PA: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                            0.7


                            0.6
                                                                            105°C           85°C
                            0.5
                                                                                            25°C
                            0.4
                  VOL (V)




                                                                                        -40°C
                            0.3


                            0.2


                            0.1


                             0
                                  0       5           10               15              20            25
                                                            IOL (mA)




        2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 413
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-164. ATmega88PA: I/O Pin Output Voltage vs. Source Current (Vcc = 3V)

                     3.5




                      3
           VOH (V)




                     2.5
                                                                                  -40°C
                                                                                   25°C
                      2                                                            85°C
                                                                                  105°C


                     1.5
                           0       5          10               15            20             25
                                                    IOH (mA)



Figure 31-165. ATmega88PA: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                     5.2



                      5



                     4.8
          VOH (V)




                     4.6
                                                                                  -40°C
                                                                                   25°C
                     4.4
                                                                                   85°C
                                                                                  105°C

                     4.2
                           0       5          10               15            20            25
                                                    IOH (mA)




 2020 Microchip Technology Inc.                   Data Sheet Complete                    DS40002061B-page 414
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.9 Pin Threshold and Hysteresis

       Figure 31-166. ATmega88PA: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                  3.5
                                                                                                          105°C
                                   3                                                                       85°C
                                                                                                           25°C
                                  2.5
                                                                                                          -40°C
                  Threshold (V)




                                   2


                                  1.5


                                   1


                                  0.5


                                   0
                                        1.5   2   2.5      3      3.5        4       4.5      5         5.5
                                                                VCC (V)



       Figure 31-167. ATmega88PA: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                  2.5
                                                                                                          105°C
                                                                                                           85°C
                                                                                                           25°C
                                   2                                                                      -40°C
                  Threshold (V)




                                  1.5



                                   1



                                  0.5



                                   0
                                        1.5   2   2.5      3      3.5         4      4.5       5        5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                        Data Sheet Complete                     DS40002061B-page 415
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-168. ATmega88PA: I/O Pin Input Hysteresis vs. VCC

                                   0.7


                                   0.6
                                           -40°C
                                   0.5
           Input Hysteresis (mV)


                                           25°C
                                   0.4
                                           85°C
                                   0.3
                                           105°C
                                   0.2


                                   0.1


                                    0
                                         1.5       2   2.5      3      3.5        4       4.5   5    5.5
                                                                     VCC (V)



Figure 31-169. ATmega88PA: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                   2.5



                                    2
            Threshold (V)




                                   1.5
                                           -40°C
                                           25°C
                                    1      85°C
                                           105°C

                                   0.5



                                    0
                                         1.5       2   2.5      3      3.5        4       4.5   5    5.5
                                                                     VCC (V)




 2020 Microchip Technology Inc.                                    Data Sheet Complete             DS40002061B-page 416
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-170. ATmega88PA: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                    2.5
                                                                                                           105°C
                                                                                                            85°C
                                                                                                            25°C
           Threshold (V)             2                                                                     -40°C


                                    1.5



                                     1



                                    0.5



                                     0
                                          1.5          2   2.5      3      3.5        4       4.5   5    5.5
                                                                         VCC (V)



Figure 31-171. ATmega88PA: Reset Pin Input Hysteresis vs. VCC

                                    0.7


                                    0.6
                                            -40°C
                                    0.5
            Input Hysteresis (mV)




                                    0.4
                                                25°C


                                    0.3
                                                85°C
                                    0.2
                                           105°C
                                    0.1


                                     0
                                          1.5          2   2.5      3      3.5        4       4.5   5    5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                        Data Sheet Complete             DS40002061B-page 417
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.10 BOD Threshold

      Figure 31-172. ATmega88PA: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                 1.84

                                 1.83
                                                                          Rising Vcc
                                 1.82

                                 1.81
                 Threshold (V)




                                  1.8

                                 1.79

                                 1.78
                                                                          Falling Vcc
                                 1.77

                                 1.76
                                        -60   -40   -20    0         20        40       60   80   100    120
                                                                   Temperature (°C)



      Figure 31-173. ATmega88PA: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                  2.8
                                                               Rising Vcc
                                 2.78

                                 2.76

                                 2.74
                Threshold (V)




                                 2.72

                                  2.7

                                 2.68
                                                               Falling Vcc
                                 2.66

                                 2.64

                                 2.62

                                  2.6
                                        -60   -40   -20    0         20        40       60   80   100    120
                                                                   Temperature (°C)




        2020 Microchip Technology Inc.                               Data Sheet Complete               DS40002061B-page 418
                                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-174. ATmega88PA: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                           4.5

                          4.45

                           4.4
                                                                                                      Rising Vcc
                          4.35
          Threshold (V)



                           4.3

                          4.25
                                                                                                      Falling Vcc
                           4.2

                          4.15

                           4.1

                          4.05

                                           4
                                                 -60            -40         -20        0         20          40         60        80        100    120
                                                                                                Temperature (°C)



Figure 31-175. ATmega88PA: Calibrated Bandgap Voltage vs. Temperature

                                                   1.09
                                                                                                                                                   1.8V
                                                  1.085                                                                                            2.7V
                                                                                                                                                   3.3V
                                                   1.08                                                                                            4.0V
                                                                                                                                                   4.5V
                           Bandgap Voltage [V]




                                                  1.075                                                                                            5.5V
                                                   1.07

                                                  1.065

                                                   1.06

                                                  1.055

                                                   1.05

                                                  1.045
                                                          -40   -30   -20    -10   0       10   20     30   40     50   60   70   80   90    100 110
                                                                                                 Temperature [V]




 2020 Microchip Technology Inc.                                                                     Data Sheet Complete                          DS40002061B-page 419
                                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-176. ATmega88PA: Bandgap Voltage vs. VCC

                                                      1.09

                                                     1.085                                                                            105°C
                                                                                                                                       85°C
                                                      1.08

                                                     1.075
                              Bandgap Voltage [V]


                                                                                                                                          25°C
                                                      1.07

                                                     1.065

                                                      1.06

                                                     1.055
                                                                                                                                          -40°C
                                                      1.05

                                                     1.045
                                                             1.5         2       2.5        3         3.5          4   4.5   5      5.5

                                                                                                   Vcc [V]


31.4.11 Internal Oscillator Speed

       Figure 31-177. ATmega88PA: Watchdog Oscillator Frequency vs. Temperature

                              116


                              114


                              112
                  FRC (kHz)




                              110


                              108


                              106
                                                                                                                                   2.7V
                                                                                                                                   3.3V
                                                                                                                                   4.0V
                              104
                                                                                                                                   5.5V
                              102
                                                    -40            -20       0         20           40         60       80   100          120
                                                                                                Temperature (°C)




         2020 Microchip Technology Inc.                                                        Data Sheet Complete                  DS40002061B-page 420
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-178. ATmega88PA: Watchdog Oscillator Frequency vs. VCC


                      116


                      114

                                                                                           -40°C
                      112

                                                                                           25°C
          FRC (kHz)




                      110


                      108


                      106
                                                                                           85°C

                      104                                                              105°C

                      102
                             1.5   2   2.5      3      3.5        4       4.5   5    5.5
                                                     VCC (V)



Figure 31-179. ATmega88PA: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                       8.5



                                                                                       105°C
                      8.25                                                              85°C

                                                                                           25°C
         FRC (MHz)




                        8


                                                                                           -40°C
                      7.75




                       7.5
                             1.5   2   2.5      3      3.5         4      4.5   5    5.5
                                                     VCC (V)




 2020 Microchip Technology Inc.                    Data Sheet Complete             DS40002061B-page 421
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-180. ATmega88PA: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                        8.4

                        8.3
                                                                                                                            5.5V
                                                                                                                            4.0V
                        8.2                                                                                                 3.0V

                                                                                                                            1.8V
                        8.1
           FRC (MHz)




                         8

                        7.9

                        7.8

                        7.7

                        7.6
                              -60        -40        -20         0         20         40          60       80          100          120
                                                                          Temperature (°C)



Figure 31-181. ATmega88PA: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                        14
                                                                                                                                     105°C
                        12                                                                                                            85°C
                                                                                                                                      25°C
                        10                                                                                                           -40°C
            FRC (MHz)




                         8


                         6


                         4


                         2


                         0
                              0     16    32   48     64   80       96   112   128   144   160    176   192    208   224    240    256

                                                                         OSCCAL (X1)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                    DS40002061B-page 422
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

31.4.12 Current Consumption of Peripheral Units

       Figure 31-182. ATmega88PA: ADC Current vs. VCC (AREF = AVCC)

                               350
                                                                                                       -40°C
                               300
                                                                                                    25°C
                                                                                                    85°C
                               250
                                                                                                   105°C
                               200
                 ICC (μA)




                               150


                               100


                                50


                                 0
                                     1.5       2   2.5      3      3.5         4      4.5   5    5.5
                                                                 VCC (V)



       Figure 31-183. ATmega88PA: Analog Comparator Current vs. VCC

                               90

                               80

                               70

                               60
                                           105°C
                    ICC (μA)




                               50

                               40
                                      85°C
                                      25°C
                               30      -40°C

                               20

                               10

                                0
                                     1.5       2   2.5      3      3.5        4       4.5   5    5.5
                                                                 VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete             DS40002061B-page 423
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-184. ATmega88PA: AREF External Reference Current vs. VCC

                         160
                                                                                             105°C
                                                                                              85°C
                         140
                                                                                              25°C
                                                                                             -40°C
                         120

                         100
          ICC (μA)




                          80

                          60

                          40

                          20

                           0
                               1.5       2   2.5      3      3.5         4      4.5   5    5.5
                                                           VCC (V)



Figure 31-185. ATmega88PA: Brownout Detector Current vs. VCC

                         30


                         25


                                 105°C
                         20
                                 85°C
              ICC (μA)




                                 25°C
                         15
                                 -40°C

                         10


                          5


                          0
                               1.5       2   2.5      3      3.5         4      4.5   5    5.5
                                                           VCC (V)




 2020 Microchip Technology Inc.                          Data Sheet Complete             DS40002061B-page 424
                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-186. ATmega88PA: Programming Current vs. VCC

                                10

                                 9

                                 8
                                                       -40°C
                                 7

                                 6
                     ICC (mA)




                                 5
                                                                                     25°C
                                 4

                                 3
                                                                 85°C
                                                      105°C
                                 2

                                 1

                                 0
                                      1.5         2            2.5         3             3.5            4         4.5         5       5.5
                                                                                       VCC (V)




31.4.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-187. ATmega88PA: Reset Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                            0.12
                                                                                                                                          5.5V
                                0.1
                                                                                                                                          5.0V
                            0.08
                                                                                                                                          4.5V
                 ICC (mA)




                            0.06                                                                                                          4.0V

                                                                                                                                          3.3V
                            0.04


                            0.02                                                                                                          1.8V


                                 0
                                       0    0.1          0.2         0.3       0.4       0.5      0.6       0.7         0.8   0.9     1
                                                                                 Frequency (MHz)




        2020 Microchip Technology Inc.                                               Data Sheet Complete                           DS40002061B-page 425
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-188. ATmega88PA: Reset Supply Current vs. Frequency (1MHz - 20MHz)

                                 2.5



                                   2                                                                                              5.5V

                                                                                                                                  5.0V
                                 1.5
                                                                                                                                  4.5V
                      ICC (mA)




                                                                                                                    4.0V
                                   1


                                                                                                3.3V
                                 0.5
                                                                                    2.7V

                                   0
                                                         1.8V
                                        0    2       4          6       8         10       12       14         16      18    20
                                                                            Frequency (MHz)



Figure 31-189. ATmega88PA: Minimum Reset Pulse width vs. VCC

                           1800

                           1600

                           1400

                           1200
         Pulsewidth (ns)




                           1000

                                 800

                                 600

                                 400
                                                                                                                                  105°C
                                                                                                                                   85°C
                                 200                                                                                               25°C
                                                                                                                                  -40°C
                                   0
                                       1.5       2        2.5       3             3.5           4        4.5          5      5.5
                                                                                VCC (V)




 2020 Microchip Technology Inc.                                              Data Sheet Complete                           DS40002061B-page 426
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

31.5   ATmega168A Typical Characteristics

31.5.1 Active Supply Current

       Figure 31-190. ATmega168A: Active Supply Current vs. Low Frequency (0.1-1.0MHz)

                                      1
                                                                                                                               5.5 V

                                     0.8                                                                                       5.0 V

                                                                                                                               4.5 V
                                     0.6
                        ICC (mA)




                                                                                                                               4.0 V

                                     0.4                                                                                       3.3 V
                                                                                                                               2.7 V
                                     0.2                                                                                       1.8 V


                                      0
                                           0   0.1   0.2         0.3   0.4       0.5       0.6       0.7   0.8      0.9   1
                                                                         Frequency (MHz)




       Figure 31-191. ATmega168A: Active Supply Current vs. Frequency (1-20MHz)

                                     12

                                                                                                                               5.5 V
                                     10
                                                                                                                               5.0 V
                                      8
                                                                                                                               4.5 V
                          ICC (mA)




                                      6
                                                                                                                 4.0 V
                                      4
                                                                                                 3.3 V

                                      2
                                                                                   2.7 V

                                                         1.8 V
                                      0
                                           0   2     4           6     8         10        12        14    16        18   20
                                                                           Frequency (MHz)




        2020 Microchip Technology Inc.                                      Data Sheet Complete                               DS40002061B-page 427
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-192. ATmega168A: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                             0.15
                                                                                              -40 °C
                                                                                               85 °C
                             0.12                                                              25 °C


                             0.09
                 ICC (mA)




                             0.06



                             0.03



                               0
                                    1.5   2   2.5   3       3.5       4       4.5   5       5.5
                                                          VCC (V)


Figure 31-193. ATmega168A: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                             1.2
                                                                                               85 °C
                                                                                               25 °C
                               1
                                                                                              -40 °C

                             0.8
                  ICC (mA)




                             0.6


                             0.4


                             0.2


                               0
                                   1.5    2   2.5   3      3.5       4        4.5   5       5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                       DS40002061B-page 428
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-194. ATmega168A: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                                         5                                                                                            85 °C
                                                                                                                                      25 °C
                                                                                                                                     -40 °C
                                         4


                              ICC (mA)
                                         3



                                         2



                                         1



                                         0
                                             1.5     2         2.5         3           3.5         4         4.5         5         5.5
                                                                                      VCC (V)



31.5.2 Idle Supply Current

       Figure 31-195. ATmega168A: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)

                                  0.15

                                                                                                                                         5.5 V
                                  0.12
                                                                                                                                         5.0 V

                                  0.09                                                                                                   4.5 V
                       ICC (mA)




                                                                                                                                         4.0 V
                                  0.06
                                                                                                                                         3.3 V
                                                                                                                                         2.7 V
                                  0.03
                                                                                                                                         1.8 V

                                         0
                                              0    0.1   0.2         0.3       0.4      0.5     0.6    0.7         0.8       0.9    1
                                                                                 Frequency (MHz)




        2020 Microchip Technology Inc.                                              Data Sheet Complete                                 DS40002061B-page 429
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-196. ATmega168A: Idle Supply Current vs. Frequency (1-20MHz)

                                 3


                                2.5                                                                                                5.5 V

                                                                                                                                   5.0 V
                                 2
                                                                                                                                   4.5 V
                    ICC (mA)


                                1.5
                                                                                                                     4.0 V

                                 1
                                                                                                 3.3 V
                                0.5
                                                                                    2.7 V

                                 0
                                                         1.8 V
                                      0      2       4           6   8         10           12       14         16       18   20
                                                                         Frequency (MHz)




Figure 31-197. ATmega168A: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                                0.04
                                                                                                                                    85 °C
                               0.035

                                0.03
                                                                                                                                    25 °C
                               0.025                                                                                               -40 °C
                ICC (mA)




                                0.02

                               0.015

                                0.01

                               0.005

                                  0
                                       1.5       2         2.5       3          3.5              4        4.5           5     5.5
                                                                              VCC (V)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                     DS40002061B-page 430
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-198. ATmega168A: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                               0.3
                                                                                            85 °C
                                                                                            25 °C
                              0.25                                                         -40 °C

                 ICC (mA)      0.2


                              0.15


                               0.1


                              0.05


                                0
                                     1.5   2   2.5   3       3.5       4       4.5   5   5.5
                                                           VCC (V)


Figure 31-199. ATmega168A: Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)

                              1.2                                                           85 °C
                                                                                            25 °C
                                                                                           -40 °C
                              0.9
                   ICC (mA)




                              0.6




                              0.3




                                0
                                    1.5    2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                         Data Sheet Complete                   DS40002061B-page 431
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.5.3 ATmega168A Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-9.      ATmega168A: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz         VCC = 5V, F = 8MHz
         PRUSART0            2.86µA                       20.3µA                     52.2µA
         PRTWI               6.00µA                       44.1µA                     122.0µA
         PRTIM2              4.97µA                       33.2µA                     79.8µA
         PRTIM1              3.50µA                       23.0µA                     55.3µA
         PRTIM0               1.43µA                      9.2µA                      21.4µA
         PRSPI                5.01µA                      38.6µA                     111.4µA
         PRADC                6.34µA                      45.7µA                     123.6µA

       Table 31-10.     ATmega168A: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption               Additional Current consumption
                             compared to Active with external             compared to Idle with external
                             clock (see Figure 31-237 on page             clock (see Figure 31-242 on page
                             451 and Figure 31-238 on page                454 and Figure 31-243 on page
         PRR bit             452)                                         454)
         PRUSART0            1.5%                                         8.9%
         PRTWI               3.2%                                         19.5%
         PRTIM2              2.4%                                         14.8%
         PRTIM1              1.7%                                         10.3%
         PRTIM0              0.7%                                         4.1%
         PRSPI               2.9%                                         17.1%
         PRADC               3.4%                                         20.3%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-12 on page 457
       for other VCC and frequency settings than listed in Table 31-11 on page 457.
31.5.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-12 on page 457, third column, we see that we need to add 10.3% for the
       TIMER1, 20.3% for the ADC, and 17.1% for the SPI module. Reading from Figure 31-242 on page 454, we find
       that the idle current consumption is ~0.027 mA at VCC = 2.0V and F = 1MHz. The total current consumption in
       idle mode with TIMER1, ADC, and SPI enabled, gives:
         I CC total  0.027 mA  (1 + 0.103 + 0.203 + 0.171)  0.040 mA




         2020 Microchip Technology Inc.                              Data Sheet Complete                    DS40002061B-page 432
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.4 Power-down Supply Current

      Figure 31-200. ATmega168A: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                                      1

                                                                                                     85 °C
                                     0.8



                                     0.6
                        ICC (uA)




                                     0.4



                                     0.2
                                                                                                     25 °C
                                                                                                     -40 °C
                                      0
                                           1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                VCC (V)


      Figure 31-201. ATmega168A: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)
                                     8
                                                                                                 -40 °C
                                                                                                  85 °C
                                                                                                  25 °C
                                     6
                          ICC (uA)




                                     4




                                     2




                                     0
                                         1.5     2   2.5   3     3.5        4        4.5   5   5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 433
                                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.5 Power-save Supply Current

      Figure 31-202. ATmega168A: Power-Save Supply Current vs. VCC (Watchdog Timer Disabled and 32kHz Crystal
                     Oscillator Running)
                                              2.5

                                                                                                                                   85 °C
                                               2



                                              1.5
                               ICC (uA)




                                                                                                                                   -40 °C
                                               1
                                                                                                                                    25 °C

                                              0.5



                                               0
                                                    1.5       2         2.5       3            3.5       4     4.5       5     5.5
                                                                                          VCC (V)



31.5.6 Standby Supply Current

      Figure 31-203. ATmega168A: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)

                               0.14                                                                                            6MHz_xtal
                                                                                                                               6MHz_res
                               0.12
                                                                                                                               4MHz_res
                                0.1                                                                                            4MHz_xtal

                               0.08
                     ICC(mA)




                                                                                                                               2MHz_res
                                                                                                                               2MHz_xtal
                               0.06                                                                                            450kHz_res
                                                                                                                               1MHz_res
                               0.04


                               0.02


                                          0
                                              1.5         2       2.5         3          3.5         4       4.5     5       5.5
                                                                                      VCC (MHz)




        2020 Microchip Technology Inc.                                                Data Sheet Complete                           DS40002061B-page 434
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.7 Pin Pull-Up

       Figure 31-204. ATmega168A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8 V)
                                    50



                                    40



                                    30
                        IOP (uA)




                                    20



                                    10                                                                                        25 °C
                                                                                                                             -40 °C
                                    0                                                                                         85 °C
                                         0   0.2     0.4    0.6       0.8       1      1.2       1.4   1.6         1.8   2
                                                                             VOP (V)


       Figure 31-205. ATmega168A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7 V)
                                    80

                                    70

                                    60

                                    50
                         IOP (uA)




                                    40

                                    30

                                    20                                                                                       25 °C
                                    10                                                                                       -40 °C
                                                                                                                             85 °C
                                     0
                                         0         0.5            1            1.5           2               2.5         3
                                                                             VOP (V)




        2020 Microchip Technology Inc.                                     Data Sheet Complete                               DS40002061B-page 435
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-206. ATmega168A: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5 V)
                                 160

                                 140

                                 120

                                 100
                 IOP (uA)

                                 80

                                 60

                                 40                                                                                25 °C
                                 20                                                                            -40 °C
                                                                                                                   85 °C
                                  0
                                       0         1            2            3            4          5          6
                                                                         VOP (V)


Figure 31-207. ATmega168A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8 V)
                                 40

                                 35

                                 30

                                 25
                   IRESET (uA)




                                 20

                                 15

                                 10
                                                                                                                   25 °C
                                  5                                                                            -40 °C

                                  0
                                                                                                                   85 °C
                                       0   0.2       0.4     0.6   0.8             1   1.2   1.4       1.6   1.8
                                                                    VRESET (V)




 2020 Microchip Technology Inc.                                   Data Sheet Complete                             DS40002061B-page 436
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-208. ATmega168A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7 V)
                                  60


                                  50


                                  40
                    IRESET (uA)

                                  30


                                  20

                                                                                                     25 °C
                                  10
                                                                                                    -40 °C
                                                                                                     85 °C
                                   0
                                        0   0.5         1          1.5            2       2.5   3
                                                                VRESET (V)


Figure 31-209. ATmega168A: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)
                                  120


                                  100


                                  80
                 IRESET (uA)




                                  60


                                  40


                                  20                                                                 25 °C
                                                                                                    -40 °C
                                   0
                                                                                                     85 °C
                                        0         1         2                 3       4         5
                                                                 VRESET (V)




 2020 Microchip Technology Inc.                                Data Sheet Complete                  DS40002061B-page 437
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.8 Pin Driver Strength

       Figure 31-210. ATmega168A: I/O Pin Output Voltage vs. Sink Current (VCC = 3 V)
                                    1


                                                                                             85 °C
                                  0.8

                                                                                             25 °C
                                  0.6
                        VOL (V)



                                                                                         -40 °C

                                  0.4



                                  0.2



                                    0
                                        0   4           8               12         16   20
                                                             IOL (mA)


       Figure 31-211. ATmega168A: I/O Pin Output Voltage vs. Sink Current (VCC = 5 V)
                                  0.6
                                                                                             85 °C
                                  0.5
                                                                                             25 °C
                                  0.4                                                    -40 °C
                        VOL (V)




                                  0.3


                                  0.2


                                  0.1


                                   0
                                        0   4           8               12         16   20
                                                             IOL (mA)




        2020 Microchip Technology Inc.                     Data Sheet Complete              DS40002061B-page 438
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-212. ATmega168A: I/O Pin Output Voltage vs. Source Current (Vcc = 3 V)

                           3.5


                            3


                           2.5
                                                                                    -40 °C
                                                                                     25 °C
                            2                                                        85 °C
                 VOH (V)



                           1.5


                            1


                           0.5


                            0
                                 0   4          8               12         16      20
                                                     IOH (mA)


Figure 31-213. ATmega168A: I/O Pin Output Voltage vs. Source Current (VCC = 5 V)
                             5



                           4.8



                           4.6
                                                                                    -40 °C
                 VOH (V)




                                                                                     25 °C
                           4.4                                                       85 °C


                           4.2



                             4
                                 0   4          8               12         16      20
                                                     IOH (mA)




 2020 Microchip Technology Inc.                    Data Sheet Complete                 DS40002061B-page 439
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.9 Pin Threshold and Hysteresis

       Figure 31-214. ATmega168A: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                           3                                                            85 °C
                                                                                                        25 °C
                                          2.5                                                          -40 °C


                                           2
                        Threshold (V)




                                          1.5


                                           1


                                          0.5


                                           0
                                                1.5   2   2.5   3       3.5      4        4.5   5   5.5
                                                                     VCC (V)


       Figure 31-215. ATmega168A: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                          2.5                                                           85 °C
                                                                                                        25 °C
                                                                                                       -40 °C
                                           2
                          Threshold (V)




                                          1.5



                                           1



                                          0.5



                                           0
                                                1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                      VCC (V)




        2020 Microchip Technology Inc.                             Data Sheet Complete                   DS40002061B-page 440
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-216. ATmega168A: I/O Pin Input Hysteresis vs. VCC


                                        0.6                                                          85 °C
                                                                                                     25 °C
                                                                                                    -40 °C
                                        0.5


                 Input Hysteresis (V)   0.4


                                        0.3


                                        0.2


                                        0.1


                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)


Figure 31-217. ATmega168A: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                        1.5                                                          85 °C
                                                                                                    -40 °C
                                                                                                     25 °C
                                        1.2
                 Threshold (V)




                                        0.9



                                        0.6



                                        0.3



                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)




 2020 Microchip Technology Inc.                                  Data Sheet Complete                   DS40002061B-page 441
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-218. ATmega168A: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                        2.5                                                         -40 °C
                                                                                                     85 °C
                                                                                                     25 °C
                                         2



                 Threshold (V)          1.5



                                         1



                                        0.5



                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)


Figure 31-219. ATmega168A: Reset Pin Input Hysteresis vs. VCC


                                        0.7


                                        0.6


                                        0.5
                 Input Hysteresis (V)




                                        0.4


                                        0.3


                                        0.2
                                                                                                        85 °C
                                        0.1                                                             25 °C
                                                                                                    -40 °C
                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                   VCC (V)




 2020 Microchip Technology Inc.                                  Data Sheet Complete                   DS40002061B-page 442
                                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.10 BOD Threshold

      Figure 31-220. ATmega168A: BOD Thresholds vs. Temperature (BODLEVEL is 1.8 V)
                                                       1.86


                                                       1.84
                                                                                                                       Rising Vcc
                                       Threshold (V)   1.82


                                                        1.8
                                                                                                                       Falling Vcc
                                                       1.78


                                                       1.76


                                                       1.74


                                                       1.72
                                                              -50     -40     -30     -20     -10       0         10      20     30    40    50    60    70    80    90
                                                                                                                 Temperature (°C)


      Figure 31-221. ATmega168A: BOD Thresholds vs. Temperature (BODLEVEL is 2.7 V)
                                       2.76

                                                                                                                 Rising Vcc
                                       2.74


                                       2.72
                       Threshold (V)




                                         2.7


                                       2.68
                                                                                                                 Falling Vcc
                                       2.66


                                       2.64


                                       2.62
                                                       -50      -40     -30     -20     -10         0       10      20      30    40    50    60    70    80    90
                                                                                                            Temperature (°C)




        2020 Microchip Technology Inc.                                                                       Data Sheet Complete                                    DS40002061B-page 443
                                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-222. ATmega168A: BOD Thresholds vs. Temperature (BODLEVEL is 4.3 V)
                                                    4.34


                                                    4.32
                                                                                                        Rising Vcc
                                                     4.3

                                    Threshold (V)
                                                    4.28


                                                    4.26

                                                                                                        Falling Vcc
                                                    4.24


                                                    4.22


                                                     4.2
                                                           -50   -40   -30   -20     -10   0       10      20     30       40   50     60   70   80   90
                                                                                                   Temperature (°C)




Figure 31-223. ATmega168A: Bandgap Voltage vs. VCC

                                          1.135

                                          1.133

                                          1.131
              Bandgap Voltage (V)




                                          1.129

                                          1.127                                                                                                             85 °C
                                                                                                                                                            25 °C
                                          1.125

                                          1.123

                                          1.121

                                          1.119

                                          1.117                                                                                                         -40 °C
                                          1.115
                                                       1.5             2       2.5             3          3.5          4         4.5         5        5.5
                                                                                                        Vcc (V)




 2020 Microchip Technology Inc.                                                                     Data Sheet Complete                                    DS40002061B-page 444
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.11 Internal Oscillator Speed

       Figure 31-224. ATmega168A: Watchdog Oscillator Frequency vs. Temperature

                                       121



                                       119



                                       117
                           FRC (kHz)




                                       115

                                                                                                                                           2.7 V
                                       113                                                                                                 3.3 V

                                                                                                                                           5.5 V
                                       111
                                             -40   -30       -20   -10    0   10      20         30   40   50     60   70       80   90
                                                                                   Temperature (°C)


       Figure 31-225. ATmega168A: Watchdog Oscillator Frequency vs. VCC
                                       122


                                       120

                                                                                                                                       -40 °C
                                       118
                         FRC (kHz)




                                       116                                                                                                 25 °C


                                       114


                                       112
                                                                                                                                           85 °C

                                       110
                                             1.5         2          2.5       3            3.5        4         4.5         5        5.5
                                                                                       VCC (V)




         2020 Microchip Technology Inc.                                            Data Sheet Complete                                    DS40002061B-page 445
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-226. ATmega168A: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                               8,4


                                                                                                                                  85 °C
                               8.2


                                                                                                                                  25 °C
                                8
                 FRC (MHz)




                               7.8
                                                                                                                                  -40 °C

                               7.6



                               7.4
                                     1.5         2           2.5         3          3.5          4         4.5         5        5.5
                                                                                  VCC (V)


Figure 31-227. ATmega168A: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                               8.3
                                                                                                                                  5.5 V
                               8.2                                                                                                5.0 V
                                                                                                                                  2.7 V
                               8.1
                                                                                                                                  1.8 V
                                 8
                   FRC (MHz)




                               7.9

                               7.8

                               7.7

                               7.6

                               7.5
                                     -50   -40       -30   -20     -10   0   10     20      30       40   50     60   70   80   90
                                                                             Temperature (°C)




 2020 Microchip Technology Inc.                                              Data Sheet Complete                                     DS40002061B-page 446
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-228. ATmega168A: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                                       16
                                                                                                                        85 °C
                                       14                                                                               25 °C
                                                                                                                       -40 °C
                                       12


                           FRC (MHz)   10

                                        8

                                        6

                                        4

                                        2

                                        0
                                             0     16   32   48   64    80   96   112 128 144 160 176 192 208 224 240 256
                                                                                  OSCCAL (X1)


31.5.12 Current Consumption of Peripheral Units

       Figure 31-229. ATmega168A: ADC Current vs. VCC (AREF = AVCC)
                                       350


                                                                                                                        -40 °C
                                       300                                                                               25 °C
                                                                                                                         85 °C

                                       250
                        ICC (uA)




                                       200



                                       150



                                       100
                                             1.5        2         2.5        3        3.5        4       4.5   5      5.5
                                                                                     VCC (V)




        2020 Microchip Technology Inc.                                            Data Sheet Complete                      DS40002061B-page 447
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-230. ATmega168A: Analog Comparator Current vs. VCC


                              90
                                                                                          -40 °C
                              80                                                              25 °C
                                                                                              85 °C
                   ICC (uA)   70


                              60


                              50


                              40


                              30
                                   1.5    2   2.5   3      3.5       4        4.5   5   5.5
                                                         VCC (V)


Figure 31-231. ATmega168A: AREF External Reference Current vs. VCC

                              180                                                             25 °C
                              160                                                             85 °C
                                                                                              -40 °C
                              140

                              120
                 ICC (uA)




                              100

                              80

                              60

                              40

                              20

                               0
                                    1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 448
                                            ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-232. ATmega168A: Brownout Detector Current vs. VCC

                             26

                                                                                        85 °C
                             24
                                                                                        25 °C
                             22
                                                                                        -40 °C

                             20
                  ICC (uA)




                             18


                             16


                             14


                             12
                                  1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                       VCC (V)


Figure 31-233. ATmega168A: Programming Current vs. VCC

                             10


                                                                                        -40 °C
                             8                                                           25 °C


                             6                                                          85 °C
                  ICC (mA)




                             4



                             2



                             0
                                  1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                       VCC (V)




 2020 Microchip Technology Inc.                      Data Sheet Complete                   DS40002061B-page 449
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

31.5.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-234. ATmega168A: Reset Supply Current vs. Low Frequency (0.1 - 1.0MHz)
                                   0.12

                                                                                                                            5.5 V
                                    0.1

                                                                                                                            5.0 V
                                   0.08
                                                                                                                            4.5 V
                        ICC (mA)




                                   0.06                                                                                     4.0 V

                                                                                                                            3.3 V
                                   0.04
                                                                                                                            2.7 V
                                   0.02                                                                                     1.8 V


                                     0
                                          0   0.1   0.2         0.3   0.4       0.5      0.6      0.7   0.8      0.9    1
                                                                          Frequency (MHz)


       Figure 31-235. ATmega168A: Reset Supply Current vs. Frequency (1 - 20MHz)
                                   2.5


                                                                                                                            5.5 V
                                    2
                                                                                                                            5.0 V
                                   1.5                                                                                      4.5 V
                        ICC (mA)




                                                                                                             4.0 V
                                    1


                                                                                              3.3 V
                                   0.5
                                                                                 2.7 V

                                    0
                                                        1.8 V
                                          0   2     4           6     8         10       12       14    16       18    20
                                                                       Frequency (MHz)




        2020 Microchip Technology Inc.                                     Data Sheet Complete                             DS40002061B-page 450
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-236. ATmega168A: Minimum Reset Pulse width vs. VCC

                                         1750


                                         1500


                                         1250
                       Pulsewidth (ns)

                                         1000


                                         750


                                         500
                                                                                                                                            85 °C
                                         250                                                                                                25 °C
                                                                                                                                           -40 °C
                                           0
                                                1.5         2         2.5         3          3.5           4         4.5         5     5.5
                                                                                           VCC (V)




31.6   ATmega168PA Typical Characteristics

31.6.1 Active Supply Current

       Figure 31-237. ATmega168PA: Active Supply Current vs. Low Frequency (0.1-1.0MHz)

                                           1
                                                                                                                                             5.5V
                                         0.9

                                         0.8                                                                                                 5.0V
                                         0.7
                                                                                                                                             4.5V
                                         0.6
                                                                                                                                             4.0V
                       ICC (mA)




                                         0.5

                                         0.4
                                                                                                                                             3.3V

                                         0.3                                                                                                 2.7V
                                         0.2                                                                                                 1.8V
                                         0.1

                                           0
                                                0     0.1       0.2         0.3   0.4       0.5      0.6       0.7         0.8   0.9   1
                                                                                      Frequency (MHz)




        2020 Microchip Technology Inc.                                                 Data Sheet Complete                                  DS40002061B-page 451
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-238. ATmega168PA: Active Supply Current vs. Frequency (1-20MHz)

                                12

                                                                                                                             5.5V
                                10
                                                                                                                             5.0V
                     ICC (mA)    8                                                                                           4.5V

                                 6
                                                                                                            4.0V
                                 4
                                                                                                 3.6V


                                 2
                                                                               2.7V

                                                    1.8V
                                 0
                                      0     2       4         6       8      10       12    14         16         18   20
                                                                      Frequency (MHz)


Figure 31-239. ATmega168PA: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                          0.14
                                                                                                                         105°C
                                                                                                                         -40°C
                          0.12                                                                                            85°C
                                                                                                                          25°C
                                0.1
               ICC (mA)




                          0.08


                          0.06


                          0.04


                          0.02
                                      1.5       2       2.5       3          3.5        4        4.5          5        5.5
                                                                           VCC (V)




 2020 Microchip Technology Inc.                                          Data Sheet Complete                                DS40002061B-page 452
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-240. ATmega168PA: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                           1.2
                                                                                             105°C
                           1.1                                                                85°C
                            1                                                                 25°C
                                                                                             -40°C
                           0.9

                           0.8
                ICC (mA)


                           0.7

                           0.6

                           0.5

                           0.4

                           0.3

                           0.2
                                 1.5   2   2.5   3      3.5       4        4.5   5         5.5
                                                      VCC (V)


Figure 31-241. ATmega168PA: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                           5.5
                                                                                             105°C
                            5                                                                 85°C
                                                                                              25°C
                           4.5
                                                                                             -40°C
                            4

                           3.5
                ICC (mA)




                            3

                           2.5

                            2

                           1.5

                            1

                           0.5
                                 1.5   2   2.5   3      3.5       4        4.5   5         5.5
                                                      VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete                         DS40002061B-page 453
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.2 Idle Supply Current

       Figure 31-242. ATmega168PA: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)

                                 0.16
                                                                                                                         5.5V
                                 0.14

                                 0.12
                                                                                                                         5.0V

                                       0.1                                                                               4.5V
                      ICC (mA)




                                 0.08                                                                                    4.0V
                                                                                                                         3.6V
                                 0.06
                                                                                                                         2.7V
                                 0.04
                                                                                                                         1.8V
                                 0.02

                                        0
                                             0   0.1   0.2      0.3   0.4      0.5    0.6     0.7      0.8     0.9   1
                                                                       Frequency (MHz)


       Figure 31-243. ATmega168PA: Idle Supply Current vs. Frequency (1-20MHz)

                                       12

                                                                                                                          5.5V
                                       10
                                                                                                                          5.0V
                                        8                                                                                 4.5V
                            ICC (mA)




                                        6
                                                                                                             4.0V
                                        4
                                                                                                    3.6V


                                        2
                                                                                 2.7V

                                                         1.8V
                                        0
                                             0   2     4         6     8       10       12    14       16       18   20
                                                                       Frequency (MHz)




        2020 Microchip Technology Inc.                                     Data Sheet Complete                           DS40002061B-page 454
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-244. ATmega168PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                            0.045                                                            105°C
                             0.04
                                                                                                 85°C
                            0.035

                             0.03
                                                                                                  25°C
              ICC (mA)



                            0.025                                                                -40°C
                             0.02

                            0.015

                             0.01

                            0.005
                                    1.5   2   2.5   3      3.5       4        4.5   5      5.5
                                                         VCC (V)


Figure 31-245. ATmega168PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                              0.3                                                            105°C
                                                                                              85°C
                             0.27
                                                                                              25°C
                                                                                             -40°C
                             0.24

                             0.21
                 ICC (mA)




                             0.18

                             0.15

                             0.12

                             0.09

                             0.06
                                    1.5   2   2.5   3      3.5       4        4.5   5      5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                      DS40002061B-page 455
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-246. ATmega168PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                           1.3
                                                                                           105°C
                                                                                            85°C
                           1.1                                                              25°C
                                                                                           -40°C
                ICC (mA)   0.9


                           0.7


                           0.5


                           0.3


                           0.1
                                 1.5   2   2.5   3      3.5       4        4.5   5       5.5
                                                      VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 456
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P


31.6.3 ATmega168PA Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-11.    ATmega168PA: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz            VCC = 5V, F = 8MHz
         PRUSART0            2.86µA                       20.3µA                        52.2µA
         PRTWI               6.00µA                       44.1µA                        122.0µA
         PRTIM2              4.97µA                       33.2µA                        79.8µA
         PRTIM1              3.50µA                       23.0µA                        55.3µA
         PRTIM0               1.43µA                      9.2µA                         21.4µA
         PRSPI                5.01µA                      38.6µA                        111.4µA
         PRADC                6.34µA                      45.7µA                        123.6µA

       Table 31-12.    ATmega168PA: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption                Additional Current consumption
                             compared to Active with external              compared to Idle with external
                             clock (see Figure 31-237 on page              clock (see Figure 31-242 on page
                             451 and Figure 31-238 on page                 454 and Figure 31-243 on page
         PRR bit             452)                                          454)
         PRUSART0            1.5%                                          8.9%
         PRTWI               3.2%                                          19.5%
         PRTIM2              2.4%                                          14.8%
         PRTIM1              1.7%                                          10.3%
         PRTIM0              0.7%                                          4.1%
         PRSPI               2.9%                                          17.1%
         PRADC               3.4%                                          20.3%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-12 on page 457
       for other VCC and frequency settings than listed in Table 31-11 on page 457.
31.6.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-12 on page 457, third column, we see that we need to add 10.3% for the
       TIMER1, 20.3% for the ADC, and 17.1% for the SPI module. Reading from Figure 31-242 on page 454, we find
       that the idle current consumption is ~0.027 mA at VCC = 2.0V and F = 1MHz. The total current consumption in
       idle mode with TIMER1, ADC, and SPI enabled, gives:
          I CC total  0.02 mA  (1 + 0.103 + 0.203 + 0.171)  0.04 mA




         2020 Microchip Technology Inc.                                 Data Sheet Complete                   DS40002061B-page 457
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.4 Power-down Supply Current

      Figure 31-247. ATmega168PA: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                                     2.4                                                         105°C
                                     2.1

                                     1.8

                                     1.5
                       ICC (μA)




                                     1.2

                                     0.9                                                             85°C
                                     0.6

                                     0.3
                                                                                                      25°C
                                      0                                                              -40°C
                                           1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                VCC (V)


      Figure 31-248. ATmega168PA: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                                      9
                                                                                                 105°C

                                      8
                                                                                                     -40°C
                                                                                                      85°C
                                      7                                                               25°C
                          ICC (μA)




                                      6


                                      5


                                      4


                                      3
                                          1.5    2   2.5   3      3.5       4        4.5   5   5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                        Data Sheet Complete                   DS40002061B-page 458
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.5 Power-save Supply Current

      Figure 31-249. ATmega168PA: Power-Save Supply Current vs. VCC
                     (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)

                                              4
                                                                                                                               105°C
                                          3.5


                                              3


                                          2.5
                               ICC (μA)




                                                                                                                                   85°C
                                              2


                                          1.5

                                                                                                                                   -40°C
                                              1                                                                                     25°C

                                          0.5
                                                  1.5       2     2.5       3        3.5         4       4.5       5         5.5
                                                                                   VCC (V)




31.6.6 Standby Supply Current

      Figure 31-250. ATmega168PA: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)

                                0.14                                                                                     6MHz_xtal
                                                                                                                         6MHz_res
                                0.12
                                                                                                                         4MHz_res
                                    0.1                                                                                  4MHz_xtal

                                0.08
                     ICC(mA)




                                                                                                                         2MHz_res
                                                                                                                         2MHz_xtal
                                0.06                                                                                     450kHz_res
                                                                                                                         1MHz_res
                                0.04


                                0.02


                                          0
                                              1.5       2       2.5     3          3.5       4         4.5     5       5.5
                                                                                VCC (MHz)




        2020 Microchip Technology Inc.                                          Data Sheet Complete                               DS40002061B-page 459
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.7 Pin Pull-Up

       Figure 31-251. ATmega168PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)

                                   50

                                   45

                                   40

                                   35

                                   30
                        IOP (μA)




                                   25

                                   20

                                   15

                                   10                                                                          25°C
                                                                                                              -40°C
                                    5                                                                          85°C
                                                                                                              105°C
                                    0
                                        0   0.2         0.4   0.6   0.8         1   1.2   1.4         1.6   1.8
                                                                      VOP (V)



       Figure 31-252. ATmega168PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)
                                   80

                                   70

                                   60

                                   50
                        IOP (μA)




                                   40

                                   30

                                   20                                                                              25°C
                                                                                                                   85°C
                                   10                                                                             -40°C
                                                                                                                  105°C
                                    0
                                        0         0.5          1          1.5        2          2.5          3
                                                                      VOP (V)




        2020 Microchip Technology Inc.                             Data Sheet Complete                           DS40002061B-page 460
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-253. ATmega168PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)

                                 140


                                 120


                                 100


                                  80
                IOP (μA)




                                  60


                                  40
                                                                                                                25°C
                                  20                                                                            85°C
                                                                                                               -40°C
                                   0                                                                           105°C
                                       0         1           2                 3               4          5
                                                                   VOP (V)


Figure 31-254. ATmega168PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage
               (VCC = 1.8V)
                                 40

                                 35

                                 30

                                 25
                   IRESET (μA)




                                 20

                                 15

                                 10                                                                         25°C
                                                                                                           -40°C
                                  5
                                                                                                            85°C
                                  0
                                                                                                           105°C
                                       0   0.2   0.4   0.6       0.8       1       1.2   1.4       1.6   1.8
                                                                  VRESET (V)




 2020 Microchip Technology Inc.                                 Data Sheet Complete                           DS40002061B-page 461
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-255. ATmega168PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage
               (VCC = 2.7V)

                                    60


                                    50


                                    40
                      IRESET (μA)



                                    30


                                    20
                                                                                                                     25°C
                                    10                                                                              -40°C
                                                                                                                     85°C
                                     0
                                                                                                                    105 C
                                         0    0.3   0.6     0.9       1.2         1.5       1.8     2.1   2.4   2.7
                                                                       VRESET (V)


Figure 31-256. ATmega168PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                                120


                                100


                                    80
                IRESET (μA)




                                    60


                                    40
                                                                                                                       25°C
                                    20                                                                                -40°C
                                                                                                                       85°C
                                     0
                                                                                                                      105°C
                                         0   0.5    1     1.5     2         2.5         3     3.5     4   4.5   5
                                                                      VRESET (V)




 2020 Microchip Technology Inc.                                      Data Sheet Complete                             DS40002061B-page 462
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.8 Pin Driver Strength

       Figure 31-257. ATmega168PA: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                                          1
                                                                                                                               105°C
                                      0.9
                                                                                                                                85°C
                                      0.8

                                      0.7
                                                                                                                                 25°C
                                      0.6
                            VOL (V)




                                                                                                                                -40°C
                                      0.5

                                      0.4

                                      0.3

                                      0.2

                                      0.1

                                          0
                                              0       2       4        6       8        10       12      14    16    18    20
                                                                                     IOL (mA)



       Figure 31-258. ATmega168PA: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                                 0.6                                                                                       105°C
                                                                                                                            85°C
                                 0.5
                                                                                                                               25°C
                                 0.4                                                                                           -40°C
                       VOL (V)




                                 0.3


                                 0.2


                                 0.1


                                      0
                                          0       2       4        6       8          10        12    14      16    18    20
                                                                                    IOL (mA)




        2020 Microchip Technology Inc.                                            Data Sheet Complete                         DS40002061B-page 463
                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-259. ATmega168PA: I/O Pin Output Voltage vs. Source Current (VCC = 3V)

                            3.1


                            2.9

                            2.7


                            2.5
                 VOH (V)



                            2.3
                                                                                        -40°C

                                                                                         25°C
                            2.1
                                                                                     85°C
                            1.9                                                     105°C

                            1.7
                                  0   5               10                 15        20
                                                    IOH (mA)


Figure 31-260. ATmega168PA: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                              5


                            4.9


                            4.8


                            4.7
                  VOH (V)




                            4.6
                                                                                         -40°C
                            4.5
                                                                                          25°C
                            4.4                                                           85°C
                                                                                         105°C
                            4.3
                                  0   5                10                15         20
                                                     IOH (mA)




 2020 Microchip Technology Inc.                   Data Sheet Complete                  DS40002061B-page 464
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.9 Pin Threshold and Hysteresis

       Figure 31-261. ATmega168PA: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                         3
                                                                                                         105°C
                                        2.8                                                               85°C
                                        2.6                                                               25°C
                                        2.4
                                                                                                         -40°C
                        Threshold (V)



                                        2.2

                                         2

                                        1.8

                                        1.6

                                        1.4

                                        1.2

                                         1
                                              1.5   2   2.5   3      3.5       4        4.5   5    5.5
                                                                   VCC (V)



       Figure 31-262. ATmega168PA: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                        2.5                                                             105°C
                                                                                                         85°C
                                                                                                         25°C
                                         2                                                              -40°C
                        Threshold (V)




                                        1.5



                                         1



                                        0.5



                                         0
                                              1.5   2   2.5   3      3.5       4        4.5   5    5.5
                                                                   VCC (V)




        2020 Microchip Technology Inc.                           Data Sheet Complete                    DS40002061B-page 465
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-263. ATmega168PA: I/O Pin Input Hysteresis vs. VCC

                                          0.6                                                                  85°C
                                                      -40°C                                                   105°C
                                         0.55


                                          0.5
                Input Hysteresis (V)
                                                      25°C
                                         0.45


                                          0.4


                                         0.35


                                          0.3


                                         0.25
                                                1.5           2   2.5   3      3.5       4        4.5   5   5.5
                                                                             VCC (V)



Figure 31-264. ATmega168PA: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                         1.5
                                                                                                              -40°C
                                         1.4                                                                   25°C
                                                                                                               85°C
                                         1.3                                                                  105°C
                                         1.2
                         Threshold (V)




                                         1.1

                                           1

                                         0.9

                                         0.8

                                         0.7

                                         0.6
                                               1.5            2   2.5   3      3.5       4        4.5   5   5.5
                                                                             VCC (V)




 2020 Microchip Technology Inc.                                            Data Sheet Complete                   DS40002061B-page 466
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-265. ATmega168PA: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                         2.5                                                                          105°C
                                                                                                                       85°C
                                         2.3                                                                           25°C
                                         2.1
                                                                                                                      -40°C

                                         1.9
                 Threshold (V)
                                         1.7

                                         1.5

                                         1.3

                                         1.1

                                         0.9

                                         0.7

                                         0.5
                                               1.5       2       2.5   3      3.5        4        4.5       5    5.5
                                                                             VCC (V)


Figure 31-266. ATmega168PA: Reset Pin Input Hysteresis vs. VCC

                                         0.7
                                                     -40°C
                                         0.6


                                         0.5
                  Input Hysteresis (V)




                                                     25°C
                                         0.4


                                         0.3
                                                     85°C
                                         0.2
                                                     105°C
                                         0.1


                                           0
                                               1.5           2   2.5   3      3.5       4        4.5    5       5.5
                                                                            VCC (V)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                         DS40002061B-page 467
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.10 BOD Threshold

      Figure 31-267. ATmega168PA: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                       1.83


                                       1.82
                                                                               Rising Vcc
                                       1.81
                       Threshold (V)




                                        1.8


                                       1.79
                                                                               Falling Vcc
                                       1.78


                                       1.77


                                       1.76
                                              -40   -30   -20   -10   0   10   20    30   40   50   60    70   80   90   100 110
                                                                                Temperature (°C)



      Figure 31-268. ATmega168PA: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                       2.76


                                       2.74

                                                                                Rising Vcc
                                       2.72
                       Threshold (V)




                                        2.7


                                       2.68
                                                                               Falling Vcc
                                       2.66


                                       2.64


                                       2.62
                                              -40   -30   -20   -10   0   10   20    30   40   50   60    70   80   90   100 110
                                                                                Temperature (°C)




        2020 Microchip Technology Inc.                                             Data Sheet Complete                            DS40002061B-page 468
                                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-269. ATmega168PA: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                                4.32


                                                 4.3
                                                                                                Rising Vcc


                                Threshold (V)   4.28


                                                4.26


                                                4.24

                                                                                                    Falling Vcc
                                                4.22


                                                 4.2
                                                       -40   -30    -20   -10         0   10        20    30     40   50    60   70   80   90   100 110
                                                                                                     Temperature (°C)




Figure 31-270. ATmega168PA: Calibrated Bandgap Voltage vs. Temperature

                                        1.136
                                                                                                                                                     1.8V
                                        1.134                                                                                                        2.7V
                                        1.132
                                                                                                                                                     3.3V
                                                                                                                                                     4.0V
                                                                                                                                                     4.5V
              Bandgap Voltage (V)




                                                1.13

                                        1.128

                                        1.126                                                                                                        5.5V
                                        1.124

                                        1.122

                                                1.12

                                        1.118

                                        1.116
                                                       -50         -30          -10            10           30         50        70        90      110
                                                                                                    Temperature (°C)




 2020 Microchip Technology Inc.                                                                         Data Sheet Complete                             DS40002061B-page 469
                                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-271. ATmega168PA: Calibrated Bandgap Voltage vs. Vcc

                                             1.136

                                             1.134

                                             1.132
                       Bandgap Voltage (V)     1.13

                                             1.128                                                                                                   85°C
                                             1.126
                                                                                                                                                    105°C
                                                                                                                                                     25°C
                                             1.124

                                             1.122

                                               1.12

                                             1.118
                                                                                                                                                      -40°C
                                             1.116
                                                      1.5         2           2.5        3           3.5        4         4.5        5          5.5
                                                                                                   Vcc (V)



31.6.11 Internal Oscillator Speed

       Figure 31-272. ATmega168PA: Watchdog Oscillator Frequency vs. Temperature

                                               122


                                               120

                                               118
                                   FRC (kHz)




                                               116


                                               114

                                                                                                                                                    2.7V
                                               112                                                                                                  3.3V
                                                                                                                                                    4.0V
                                               110                                                                                                  4.5V
                                                                                                                                                    5.5V
                                                                                                                                                    5.0V
                                               108
                                                     -40    -30   -20   -10     0   10       20     30     40   50   60    70   80       90   100
                                                                                              Temperature (°C)




         2020 Microchip Technology Inc.                                                          Data Sheet Complete                                 DS40002061B-page 470
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-273. ATmega168PA: Watchdog Oscillator Frequency vs. VCC

                              122


                              120

                                                                                       -40°C
                              118

                                                                                           25°C
                FRC (kHz)

                              116


                              114


                              112
                                                                                           85°C
                              110
                                                                                       105°C
                              108
                                    2   2.5    3   3.5             4       4.5   5   5.5
                                                         VCC (V)




Figure 31-274. ATmega168PA: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                              8.5

                              8.4

                              8.3                                                      105°C
                              8.2
                                                                                        85°C

                              8.1
                  FRC (MHz)




                                                                                           25°C
                                8

                              7.9

                              7.8
                                                                                           -40°C
                              7.7

                              7.6

                              7.5
                                    2   2.5    3   3.5             4       4.5   5   5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete                   DS40002061B-page 471
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-275. ATmega168PA: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                              8.4
                                                                                                                          5.5V
                              8.3                                                                                         4.5V
                                                                                                                          4.0V
                              8.2                                                                                         3.3V
                                                                                                                          1.8V
                 FRC (MHz)    8.1

                               8

                              7.9

                              7.8

                              7.7

                              7.6

                              7.5
                                    -40   -30   -20   -10    0    10    20     30   40   50     60   70   80   90   100 110
                                                                             Temperature (°C)




Figure 31-276. ATmega168PA: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                              14
                                                                                                                          105°C
                                                                                                                           85°C
                              12                                                                                           25°C
                                                                                                                          -40°C
                              10
                  FRC (MHz)




                               8


                               6


                               4


                               2
                                    0     16    32    48    64   80    96 112 128 144 160 176 192 208 224 240 256
                                                                             OSCCAL (X1)




 2020 Microchip Technology Inc.                                              Data Sheet Complete                             DS40002061B-page 472
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

31.6.12 Current Consumption of Peripheral Units

       Figure 31-277. ATmega168PA: ADC Current vs. VCC (AREF = AVCC)

                                  325
                                                                                                      -40°C
                                  300                                                                  25°C
                                                                                                       85°C
                                  275
                                                                                                      105°C
                                  250
                       ICC (μA)




                                  225

                                  200

                                  175

                                  150

                                  125

                                  100
                                           1.5   2   2.5   3     3.5       4         4.5    5       5.5
                                                               VCC (V)



       Figure 31-278. ATmega168PA: Analog Comparator Current vs. VCC

                                      90
                                                                                                          -40°C
                                      80                                                                  105°C
                                                                                                           25°C
                                                                                                           85°C
                                      70
                           ICC (μA)




                                      60


                                      50


                                      40


                                      30
                                           1.5   2   2.5   3      3.5          4      4.5       5     5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                        Data Sheet Complete                          DS40002061B-page 473
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-279. ATmega168PA: AREF External Reference Current vs. VCC

                           180
                                                                                           25°C
                           160                                                             85°C
                                                                                          105°C
                           140
                                                                                          -40°C

                           120
                ICC (μA)




                           100


                               80


                               60


                               40
                                    1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                         VCC (V)



Figure 31-280. ATmega168PA: Brownout Detector Current vs. VCC

                               28


                               26                                                             105°C

                               24                                                              85°C
                                                                                               25°C
                               22
                    ICC (μA)




                                                                                              -40°C
                               20


                               18


                               16


                               14
                                    1.5   2   2.5   3       3.5       4       4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                   DS40002061B-page 474
                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-281. ATmega168PA: Programming Current vs. VCC

                                            9

                                            8
                                                                                                                             -40°C
                                                                                                                              25°C
                                            7
                                                                                                                             105°C
                                 ICC (mA)   6                                                                                 85°C

                                            5

                                            4

                                            3

                                            2

                                            1
                                                1.5     2     2.5         3           3.5         4         4.5    5     5.5
                                                                                  VCC (V)



31.6.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-282. ATmega168PA: Reset Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                  0.12
                                                                                                                             5.5V
                                       0.1


                                  0.08
                                                                                                                             4.5V
                      ICC (mA)




                                  0.06                                                                                       4.0V

                                  0.04
                                                                                                                             3.3V
                                                                                                                             2.7V
                                  0.02                                                                                       1.8V

                                            0
                                                0.1   0.2   0.3     0.4         0.5         0.6       0.7    0.8   0.9   1
                                                                              Frequency (MHz)




        2020 Microchip Technology Inc.                                         Data Sheet Complete                            DS40002061B-page 475
                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-283. ATmega168PA: Reset Supply Current vs. Frequency (1MHz - 20MHz)

                                     2.4

                                     2.1
                                                                                                                                       5.5V

                                     1.8                                                                                               5.0V
                          ICC (mA)
                                     1.5
                                                                                                                                       4.5V

                                     1.2
                                                                                                                      4.0V
                                     0.9
                                                                                                           3.6V
                                     0.6
                                                                                      2.7V
                                     0.3

                                       0
                                                             1.8V
                                           0     2       4          6       8      10        12       14         16         18   20
                                                                            Frequency (MHz)




Figure 31-284. ATmega168PA: Minimum Reset Pulse Width vs. Vcc

                                 1800

                                 1600

                                 1400

                                 1200
               Pulsewidth (ns)




                                 1000

                                     800

                                     600
                                                                                                                                   105°C
                                     400
                                                                                                                                    85°C
                                     200                                                                                            25°C
                                                                                                                                   -40°C
                                      0
                                           1.5       2       2.5        3          3.5            4        4.5          5        5.5
                                                                                 VCC (V)




 2020 Microchip Technology Inc.                                                Data Sheet Complete                                    DS40002061B-page 476
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

31.7   ATmega328 Typical Characteristics

31.7.1 Active Supply Current

       Figure 31-285. ATmega328: Active Supply Current vs. Low Frequency (0.1-1.0MHz)

                              1.2

                                                                                                                          5.5 V
                               1
                                                                                                                          5.0 V
                              0.8                                                                                         4.5 V
                  ICC (mA)




                                                                                                                          4.0 V
                              0.6
                                                                                                                          3.3 V
                              0.4                                                                                         2.7 V

                                                                                                                          1.8 V
                              0.2


                               0
                                    0   0.1   0.2         0.3   0.4      0.5        0.6       0.7   0.8       0.9     1
                                                                    Frequency (MHz)



       Figure 31-286. ATmega328: Active Supply Current vs. Frequency (1-20MHz)


                              14
                                                                                                                          5.5V
                              12                                                                                          5.0V

                              10                                                                                          4.5V
                   ICC (mA)




                               8

                                                                                                          4.0 V
                               6
                                                                                          3.3 V
                               4
                                                                            2.7 V
                               2
                                                  1.8 V
                               0
                                    0   2     4           6     8         10        12        14    16        18     20
                                                                    Frequency (MHz)




        2020 Microchip Technology Inc.                               Data Sheet Complete                           DS40002061B-page 477
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-287. ATmega328: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)
                        0.16
                                                                                               85 °C
                                                                                               25 °C
          ICC (mA)
                        0.12                                                                  -40 °C




                        0.08




                        0.04




                          0
                               1.5   2   2.5      3      3.5         4      4.5      5      5.5
                                                       VCC (V)



Figure 31-288. ATmega328: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)
                         1.4
                                                                                                  85 °C
                         1.2                                                                      25 °C
                                                                                                  -40 °C
                          1


                         0.8
             ICC (mA)




                         0.6


                         0.4


                         0.2


                          0
                               1.5   2   2.5      3      3.5         4      4.5      5      5.5
                                                       VCC (V)




 2020 Microchip Technology Inc.                      Data Sheet Complete                  DS40002061B-page 478
                                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-289. ATmega328: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)
                                       8

                                       7
                                                                                                                                                85 °C
                                       6                                                                                                        25 °C
                                                                                                                                                -40 °C
                                       5
                            ICC (mA)




                                       4

                                       3

                                       2

                                       1

                                       0
                                           1.5         2         2.5         3            3.5            4         4.5         5          5.5
                                                                                        VCC (V)




31.7.2 Idle Supply Current

       Figure 31-290. ATmega328: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)
                                  0.2

                                                                                                                                                5.5 V
                              0.16
                                                                                                                                                5.0 V

                                                                                                                                                4.5 V
                              0.12
                 ICC (mA)




                                                                                                                                                4.0 V

                              0.08                                                                                                              3.3 V
                                                                                                                                                2.7 V

                              0.04                                                                                                              1.8 V


                                       0
                                           0     0.1       0.2         0.3       0.4      0.5      0.6       0.7         0.8       0.9     1
                                                                                   Frequency (MHz)




        2020 Microchip Technology Inc.                                                Data Sheet Complete                               DS40002061B-page 479
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-291. ATmega328: Idle Supply Current vs. Frequency (1-20MHz)
               4

                          3.5
                                                                                                                                     5.5 V
                           3
                                                                                                                                     5.0 V
                          2.5                                                                                                        4.5 V
              I CC (mA)




                           2

                                                                                                                  4.0 V
                          1.5

                                                                                              3.3 V
                           1
                                                                                 2.7 V
                          0.5

                                                  1.8 V
                           0
                                 0    2       4           6       8         10           12       14         16          18    20
                                                                      Frequency (MHz)



Figure 31-292. ATmega328: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)
                      0.06


                      0.05


                      0.04                                                                                                           85 °C
          ICC (mA)




                                                                                                                                  25 °C
                      0.03
                                                                                                                                 -40 °C

                      0.02


                      0.01


                           0
                                1.5       2        2.5        3            3.5                4        4.5           5         5.5
                                                                          VCC (V)




 2020 Microchip Technology Inc.                                        Data Sheet Complete                                   DS40002061B-page 480
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-293. ATmega328: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)
                         0.4

                     0.35                                                                         85 °C
                                                                                                  25 °C
                         0.3
                                                                                                  -40 °C
                     0.25
         ICC (mA)




                         0.2

                     0.15

                         0.1

                     0.05

                          0
                               1.5   2   2.5      3      3.5        4       4.5        5    5.5
                                                       VCC (V)



Figure 31-294. ATmega328: Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)

                          2


                                                                                                  85 °C
                         1.6
                                                                                                  25 °C
                                                                                              -40 °C
                         1.2
              ICC (mA)




                         0.8



                         0.4



                          0
                               1.5   2   2.5      3      3.5         4      4.5        5    5.5
                                                       VCC (V)




 2020 Microchip Technology Inc.                      Data Sheet Complete                  DS40002061B-page 481
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.3 ATmega328 Supply Current of IO Modules
       The tables and formulas below can be used to calculate the additional current consumption for the different I/O
       modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
       Reduction Register. See ”Power Reduction Register” on page 51 for details.

       Table 31-13.     ATmega328: Additional Current Consumption for the different I/O modules (absolute values)
         PRR bit             Typical numbers
                               VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz           VCC = 5V, F = 8MHz
         PRUSART0                     3.20 µA                     22.17 µA                    100.25 µA
         PRTWI                        7.34 µA                     46.55 µA                    199.25 µA
         PRTIM2                       7.34 µA                     50.79 µA                    224.25 µA
         PRTIM1                       6.19 µA                     41.25 µA                    176.25 µA
         PRTIM0                       1.89 µA                     14.28 µA                    61.13 µA
         PRSPI                        6.94 µA                     43.84 µA                    186.50 µA
         PRADC                        8.66 µA                     61.80 µA                    295.38 µA

       Table 31-14.     ATmega328: Additional Current Consumption (percentage) in Active and Idle mode
                             Additional Current consumption               Additional Current consumption
                             compared to Active with external             compared to Idle with external
                             clock (see Figure 31-332 on page             clock (see Figure 31-337 on page
                             501 and Figure 31-333 on page                504 and Figure 31-338 on page
         PRR bit             502)                                         504)
         PRUSART0                               1.4%                                      7.8%
         PRTWI                                  3.0%                                     16.6%
         PRTIM2                                 3.3%                                     17.8%
         PRTIM1                                 2.7%                                     14.5%
         PRTIM0                                 0.9%                                      4.8%
         PRSPI                                  2.9%                                     15.7%
         PRADC                                  4.1%                                     22.1%

       It is possible to calculate the typical current consumption based on the numbers from Table 31-13 for other VCC
       and frequency settings than listed in Table 31-14.
31.7.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-14, third column, we see that we need to add 14.5% for the TIMER1, 22.1% for
       the ADC, and 15.7% for the SPI module. Reading from Figure 31-338 on page 504, we find that the idle current
       consumption is ~0.055 mA at VCC = 2.0V and F = 1MHz. The total current consumption in idle mode with
       TIMER1, ADC, and SPI enabled, gives:
       I CC total  0.045 mA  (1 + 0.145 + 0.221 + 0.157)  0.069 mA




         2020 Microchip Technology Inc.                                Data Sheet Complete                   DS40002061B-page 482
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.4 Power-down Supply Current

      Figure 31-295. ATmega328: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                               1.2

                                                                                                     85 °C
                                1


                               0.8
                  ICC (uA)




                               0.6


                               0.4


                               0.2
                                                                                                      25 °C
                                0                                                                    -40 °C
                                    1.5   2   2.5      3      3.5         4      4.5   5       5.5
                                                            VCC (V)



      Figure 31-296. ATmega328: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)
                               10

                                9
                                                                                                 -40 °C
                                8                                                                 85 °C
                                                                                                  25 °C
                                7

                                6
                    ICC (uA)




                                5

                                4

                                3

                                2

                                1

                                0
                                    1.5   2   2.5      3      3.5         4      4.5   5       5.5
                                                            VCC (V)




        2020 Microchip Technology Inc.                    Data Sheet Complete                DS40002061B-page 483
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.5 Power-save Supply Current

      Figure 31-297. ATmega328: Power-Save Supply Current vs. VCC (Watchdog Timer Disabled and 32kHz Crystal
                     Oscillator Running)
                                   2

                                  1.8

                                  1.6

                                  1.4                                                                  25 °C
                                  1.2
                      ICC (uA)




                                   1

                                  0.8

                                  0.6

                                  0.4

                                  0.2

                                   0
                                        1.5   2    2.5      3      3.5        4       4.5   5    5.5
                                                                 VCC (V)




31.7.6 Standby Supply Current

      Figure 31-298. ATmega328: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)
                          0.16
                                                                                                   6MHz_res
                          0.14
                                                                                                   6MHz_xtal
                          0.12                                                                     4MHz_res
                                                                                                   4MHz_xtal
                                 0.1
                                                                                                   2MHz_res
               ICC (mA)




                          0.08                                                                     2MHz_xtal

                          0.06                                                                     1MHz_res

                          0.04

                          0.02

                                  0
                                       1.5    2   2.5      3      3.5         4       4.5   5   5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete             DS40002061B-page 484
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.7 Pin Pull-Up

       Figure 31-299. ATmega328: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8 V)
                     60


                             50


                             40
                  IOP (uA)




                             30


                             20


                             10                                                                                              25 °C
                                                                                                                             85 °C
                             0                                                                                              -40 °C
                                  0   0.2         0.4   0.6       0.8       1       1.2       1.4   1.6         1.8     2
                                                                         VOP (V)



       Figure 31-300. ATmega328: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7 V)
                             90

                             80

                             70

                             60

                             50
                  IOP (uA)




                             40

                             30

                             20                                                                                             25 °C

                             10                                                                                             85 °C
                                                                                                                            -40 °C
                             0
                                  0         0.5               1            1.5            2               2.5           3
                                                                         VOP (V)




        2020 Microchip Technology Inc.                                 Data Sheet Complete                           DS40002061B-page 485
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-301. ATmega328: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5 V)
                        160

                        140

                        120

                        100
          IOP (uA)




                            80

                            60

                            40
                                                                                                                       25 °C
                            20                                                                                         85 °C
                                                                                                                       -40 °C
                            0
                                 0         1               2             3             4               5           6
                                                                      VOP (V)



Figure 31-302. ATmega328: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8 V)
                            40

                            35

                            30

                            25
              IRESET (uA)




                            20

                            15

                            10
                                                                                                                        25 °C
                             5                                                                                          85 °C
                                                                                                                       -40 °C
                             0
                                 0   0.2       0.4   0.6       0.8       1       1.2       1.4   1.6       1.8     2
                                                                     VRESET(V)




 2020 Microchip Technology Inc.                                     Data Sheet Complete                         DS40002061B-page 486
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-303. ATmega328: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7 V)
                              70


                              60


                              50
                IRESET (uA)



                              40


                              30


                              20
                                                                                                      25 °C
                              10                                                                      85 °C
                                                                                                     -40 °C
                               0
                                   0   0.5    1        1.5            2           2.5            3
                                                    VRESET(V)



Figure 31-304. ATmega328: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5 V)

                          120


                          100


                              80
          IRESET(uA)




                              60


                              40
                                                                                                       25 °C
                              20
                                                                                                       85 °C
                                                                                                      -40 °C
                               0
                                   0   1       2        3                 4        5              6
                                                     VRESET(V)




 2020 Microchip Technology Inc.                    Data Sheet Complete                        DS40002061B-page 487
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.8 Pin Driver Strength

       Figure 31-305. ATmega328: I/O Pin Output Voltage vs. Sink Current (VCC = 3 V)
                              1

                                                                                            85 °C
                             0.8

                                                                                            25 °C
                             0.6
                  V OL (V)




                                                                                        -40 °C

                             0.4



                             0.2



                              0
                                   0      5           10               15              20            25
                                                            IOL (mA)



       Figure 31-306. ATmega328: I/O Pin Output Voltage vs. Sink Current (VCC = 5 V)

                             0.6
                                                                                            85 °C
                             0.5
                                                                                            25 °C

                             0.4
                                                                                        -40 °C
                 V OL (V)




                             0.3


                             0.2


                             0.1


                              0
                                   0      5           10               15              20            25
                                                            IOL (mA)




        2020 Microchip Technology Inc.                    Data Sheet Complete                      DS40002061B-page 488
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-307. ATmega328: I/O Pin Output Voltage vs. Source Current (Vcc = 3 V)
                      3.5


                       3


                      2.5
                                                                                   -40 °C
                                                                                    25 °C
                       2
           V OH (V)




                                                                                    85 °C
                      1.5


                       1


                      0.5


                       0
                            0        5           10               15          20             25
                                                       IOH (mA)



Figure 31-308. ATmega328: I/O Pin Output Voltage vs. Source Current (VCC = 5 V)

                                   I/O PIN OUTPUT VOLTAGE vs. SOURCE CURRENT
                                                      VCC = 5V
                      5.1

                       5

                      4.9

                      4.8
           V OH (V)




                      4.7

                      4.6
                                                                                  -40 °C
                      4.5
                                                                                   25 °C
                      4.4
                                                                                   85 °C
                      4.3
                            0        5           10               15          20             25
                                                       IOH (mA)




 2020 Microchip Technology Inc.                      Data Sheet Complete                   DS40002061B-page 489
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.9 Pin Threshold and Hysteresis

       Figure 31-309. ATmega328: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                    4

                                   3.5

                                                                                                         -40 °C
                                    3
                                                                                                          25 °C
                                                                                                          85 °C
                                   2.5
                   Threshold (V)




                                    2

                                   1.5

                                    1

                                   0.5

                                    0
                                         1.5   2   2.5      3      3.5         4      4.5      5       5.5
                                                                 VCC (V)



       Figure 31-310. ATmega328: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                   2.5                                                                       85 °C
                                                                                                             25 °C
                                    2                                                                    -40 °C
                  Threshold (V)




                                   1.5



                                    1



                                   0.5



                                    0
                                        1.5    2   2.5      3      3.5         4      4.5      5       5.5
                                                                 VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete                   DS40002061B-page 490
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-311. ATmega328: I/O Pin Input Hysteresis vs. VCC

                                  0.7
                                                                                                  -40 °C
                                  0.6                                                              25 °C
                                                                                                   85 °C
                                  0.5
           Input Hysteresis (V)




                                  0.4


                                  0.3


                                  0.2


                                  0.1


                                   0
                                        1.5   2   2.5      3      3.5         4      4.5   5    5.5
                                                                VCC (V)



Figure 31-312. ATmega328: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                  2.5
                                                                                                   -40 °C
                                                                                                      25 °C
                                   2                                                                  85 °C
             Threshold (V)




                                  1.5



                                   1



                                  0.5



                                   0
                                        1.5   2   2.5      3      3.5        4       4.5   5    5.5
                                                                VCC (V)




 2020 Microchip Technology Inc.                               Data Sheet Complete             DS40002061B-page 491
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-313. ATmega328: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                  2.5                                                                 85 °C
                                                                                                      25 °C
                                   2                                                               -40 °C
           Threshold (V)



                                  1.5



                                   1



                                  0.5



                                   0
                                        1.5   2   2.5      3      3.5        4       4.5   5    5.5
                                                                VCC (V)



Figure 31-314. ATmega328: Reset Pin Input Hysteresis vs. VCC
                                  0.7


                                  0.6


                                  0.5
           Input Hysteresis (V)




                                  0.4


                                  0.3


                                  0.2
                                                                                                      -40 °C
                                  0.1                                                                 25 °C
                                                                                                      85 °C
                                   0
                                        1.5   2   2.5      3      3.5        4       4.5   5    5.5
                                                                VCC (V)




 2020 Microchip Technology Inc.                               Data Sheet Complete             DS40002061B-page 492
                                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.10 BOD Threshold

      Figure 31-315. ATmega328: BOD Thresholds vs. Temperature (BODLEVEL is 1.8 V)
                                 1.85



                                 1.83
                                                                                                                                           1
                 Threshold (V)




                                 1.81



                                 1.79                                                                                                      0


                                 1.77



                                 1.75
                                                  -60         -40         -20         0          20          40        60        80                100
                                                                                          Temperature (°C)



      Figure 31-316. ATmega328: BOD Thresholds vs. Temperature (BODLEVEL is 2.7 V)

                                                 2.78


                                                 2.76
                                                                                                                                               1
                                                 2.74
                                 Threshold (V)




                                                 2.72


                                                  2.7


                                                 2.68
                                                                                                                                               0

                                                 2.66
                                                        -60         -40         -20       0           20          40        60        80             100
                                                                                              Temperature (°C)




        2020 Microchip Technology Inc.                                                       Data Sheet Complete                              DS40002061B-page 493
                                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-317. ATmega328: BOD Thresholds vs. Temperature (BODLEVEL is 4.3 V)

                                              4.4




                                    4.35
            Threshold (V)



                                                                                                                                  1


                                              4.3




                                                                                                                                  0
                                    4.25
                                                    -60         -40   -20       0            20        40         60       80         100
                                                                                    Temperature (°C)




Figure 31-318. ATmega328: Bandgap Voltage vs. VCC

                                              1.138

                                              1.136


                                              1.134                                                                               25 °C
                        Bandgap Voltage (V)




                                              1.132

                                               1.13


                                              1.128

                                                                                                                                 85 °C
                                              1.126
                                                                                                                                -40 °C
                                              1.124
                                                          1.5     2   2.5   3          3.5        4         4.5        5    5.5
                                                                                     Vcc (V)




 2020 Microchip Technology Inc.                                                    Data Sheet Complete                           DS40002061B-page 494
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.11 Internal Oscillator Speed

       Figure 31-319. ATmega328: Watchdog Oscillator Frequency vs. Temperature

                                 119

                                 118

                                 117

                                 116

                                 115
                    F RC (kHz)




                                 114

                                 113

                                 112                                                                     2.7 V
                                 111                                                                     3.3 V
                                 110                                                                     4.0 V
                                                                                                         5.5 V
                                 109
                                       -60   -40   -20      0       20         40      60    80    100
                                                                Temperature (°C)



       Figure 31-320. ATmega328: Watchdog Oscillator Frequency vs. VCC

                                 120


                                 118
                                                                                                     -40 °C
                                 116
                  F RC (kHz)




                                 114                                                                     25 °C


                                 112


                                 110
                                                                                                         85 °C

                                 108
                                       1.5   2     2.5      3       3.5            4   4.5   5     5.5
                                                                  VCC (V)




         2020 Microchip Technology Inc.                        Data Sheet Complete               DS40002061B-page 495
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-321. ATmega328: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                         8.4
                                                                                                                                       85 °C

                         8.2
                                                                                                                                       25 °C

                          8
            F RC (MHz)




                         7.8                                                                                                       -40 °C


                         7.6



                         7.4
                               1.5         2           2.5        3              3.5             4         4.5         5         5.5
                                                                             VCC (V)




Figure 31-322. ATmega328: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                         8.4

                         8.3                                                                                                       5.0 V

                         8.2                                                                                                       3.0 V

                         8.1
           F RC (MHz)




                          8

                         7.9

                         7.8

                         7.7

                         7.6
                              -50    -40   -30   -20    -10   0       10    20         30   40       50   60     70   80   90    100
                                                                           Temperature (°C)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                  DS40002061B-page 496
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-323. ATmega328: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value
                                 16

                                 14                                                                                  85 °C
                                                                                                                     25 °C
                                 12
                                                                                                                 -40 °C
                                 10
                    F RC (MHz)




                                  8

                                  6

                                  4

                                  2

                                  0
                                       0    16   32   48   64    80   96   112 128 144 160 176 192 208 224 240 256
                                                                           OSCCAL (X1)




31.7.12 Current Consumption of Peripheral Units

       Figure 31-324. ATmega328: ADC Current vs. VCC (AREF = AVCC)
                                 350                                                                             -40 °C
                                                                                                                  25 °C
                                 300                                                                              85 °C

                                 250


                                 200
                 ICC (uA)




                                 150


                                 100


                                 50


                                  0
                                      1.5        2         2.5        3        3.5         4      4.5   5      5.5
                                                                             VCC (V)




        2020 Microchip Technology Inc.                                     Data Sheet Complete               DS40002061B-page 497
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-325. ATmega328: Analog Comparator Current vs. VCC

                     120


                     100
                                                                                     -40 °C
                     80                                                                  25 °C
                                                                                         85 °C
          ICC (uA)




                     60


                     40


                     20


                      0
                          1.5   2   2.5      3       3.5         4      4.5   5    5.5
                                                   VCC (V)



Figure 31-326. ATmega328: AREF External Reference Current vs. VCC
                     180
                                                                                      85 °C
                     160
                                                                                      25 °C
                     140                                                             -40 °C

                     120

                     100
          ICC (uA)




                     80

                     60

                     40

                     20

                      0
                          1.5   2   2.5      3       3.5         4      4.5   5    5.5
                                                   VCC (V)




 2020 Microchip Technology Inc.                  Data Sheet Complete             DS40002061B-page 498
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-327. ATmega328: Brownout Detector Current vs. VCC

                      30


                      25                                                              85 °C
                                                                                      25 °C
                                                                                     -40 °C
                      20
           ICC (uA)




                      15


                      10


                      5


                      0
                           1.5   2   2.5      3      3.5        4       4.5   5    5.5
                                                   VCC (V)



Figure 31-328. ATmega328: Programming Current vs. VCC

                      10

                       9
                                                                                          25 °C
                       8                                                                  85 °C
                                                                                         -40 °C
                       7

                       6
           ICC (mA)




                       5

                       4

                       3

                       2

                       1

                       0
                           1.5   2   2.5      3      3.5         4      4.5   5    5.5
                                                   VCC (V)




 2020 Microchip Technology Inc.                  Data Sheet Complete             DS40002061B-page 499
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

31.7.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-329. ATmega328: Reset Supply Current vs. Low Frequency (0.1 - 1.0MHz)
                            0.15
                                                                                                                              5.5 V

                                                                                                                              5.0 V

                                0.1                                                                                           4.5 V

                                                                                                                              4.0 V
                ICC (mA)




                                                                                                                              3.3 V
                            0.05                                                                                              2.7 V

                                                                                                                              1.8 V



                                 0
                                      0   0.1   0.2         0.3   0.4       0.5       0.6         0.7   0.8       0.9     1
                                                                      Frequency (MHz)



       Figure 31-330. ATmega328: Reset Supply Current vs. Frequency (1 - 20MHz)
                                 3
                                                                                                                              5.5 V

                                2.5                                                                                           5.0 V

                                                                                                                              4.5 V
                                 2
                     ICC (mA)




                                                                                                              4.0 V
                                1.5


                                 1
                                                                                               3.3 V

                                0.5
                                                                                  2.7 V

                                                    1.8 V
                                 0
                                      0   2     4           6     8         10            12       14   16        18     20
                                                                      Frequency (MHz)




        2020 Microchip Technology Inc.                                 Data Sheet Complete                             DS40002061B-page 500
                                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-331. ATmega328: Minimum Reset Pulse width vs. VCC
                                  1800

                                  1600

                                  1400

                                  1200
                Pulsewidth (ns)




                                  1000

                                  800

                                  600

                                  400
                                                                                                                                      85 °C
                                  200                                                                                                 25 °C
                                                                                                                                     -40 °C
                                    0
                                        1.5                 2         2.5       3           3.5         4     4.5         5        5.5
                                                                                        VCC (V)




31.8   ATmega328P Typical Characteristics

31.8.1 Active Supply Current

       Figure 31-332. ATmega328P: Active Supply Current vs. Low Frequency (0.1-1.0MHz)

                                                1.2

                                                                                                                                  5.5V
                                                 1
                                                                                                                                  5.0V
                                                0.8                                                                               4.5V
                                     ICC (mA)




                                                                                                                                  4.0V
                                                0.6
                                                                                                                                  3.6V

                                                0.4                                                                               2.7V

                                                                                                                                  1.8V
                                                0.2


                                                 0
                                                      0.1       0.2   0.3     0.4     0.5         0.6   0.7   0.8   0.9       1
                                                                                    Frequency (MHz)




        2020 Microchip Technology Inc.                                               Data Sheet Complete                         DS40002061B-page 501
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-333. ATmega328P: Active Supply Current vs. Frequency (1-20MHz)

                           14
                                                                                                                                         5.5 V
                           12                                                                                                            5.0 V
              ICC (mA)     10                                                                                                            4.5 V

                            8

                                                                                                                     4.0 V
                            6
                                                                                                  3.3 V
                            4
                                                                                     2.7 V
                            2
                                                      1.8 V
                            0
                                0         2       4           6       8         10           12       14        16       18         20
                                                                          Frequency (MHz)


Figure 31-334. ATmega328P: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                           0.16
                                                                                                                                    105°C
                                                                                                                                     85°C
                           0.14
                                                                                                                                    -40°C
                                                                                                                                     25°C
                           0.12

                            0.1
                ICC (mA)




                           0.08

                           0.06

                           0.04

                           0.02

                                0
                                    1.5       2         2.5       3            3.5            4           4.5        5        5.5
                                                                             VCC (V)




 2020 Microchip Technology Inc.                                            Data Sheet Complete                                     DS40002061B-page 502
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-335. ATmega328P: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                            1.4
                                                                                                              105°C
                                                                                                               85°C
                            1.2                                                                                25°C
                                                                                                              -40°C

                ICC (mA)          1


                            0.8


                            0.6


                            0.4


                            0.2
                                      1.5       2       2.5    3         3.5        4        4.5    5       5.5
                                                                       VCC (V)




Figure 31-336. ATmega328P: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                                      7                                                                           105°C
                                                                                                                   85°C
                                      6                                                                            25°C
                                                                                                                  -40°C
                                      5
                           ICC (mA)




                                      4


                                      3


                                      2


                                      1
                                          1.5       2    2.5       3       3.5          4     4.5       5     5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                       Data Sheet Complete                        DS40002061B-page 503
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

31.8.2 Idle Supply Current

       Figure 31-337. ATmega328P: Idle Supply Current vs. Low Frequency (0.1-1.0MHz)

                                       0.2

                                  0.18                                                                                    5.5V
                                  0.16
                                                                                                                          5.0V
                                  0.14
                                                                                                                          4.5V
                                  0.12
                      ICC (mA)




                                                                                                                          4.0V
                                       0.1
                                                                                                                          3.6V
                                  0.08

                                  0.06                                                                                    2.7V
                                  0.04                                                                                    1.8V
                                  0.02

                                        0
                                             0       0.2             0.4             0.6                0.8           1
                                                                      Frequency (MHz)



       Figure 31-338. ATmega328P: Idle Supply Current vs. Frequency (1-20MHz)

                                       3.5                                                                                 5.5V

                                         3                                                                                 5.0V

                                       2.5                                                                                 4.5V

                                         2
                            ICC (mA)




                                                                                                              4.0V
                                       1.5
                                                                                                      3.6V
                                         1
                                                                                 2.7V
                                       0.5

                                                          1.8V
                                         0
                                             0   2    4          6    8        10       12       14      16      18   20
                                                                      Frequency (MHz)




        2020 Microchip Technology Inc.                                    Data Sheet Complete                             DS40002061B-page 504
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-339. ATmega328P: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                             0.05
                                                                                                            105°C
                            0.045
                                                                                                                85°C
                             0.04

                            0.035
                                                                                                                 25°C
              ICC (mA)


                             0.03                                                                               -40°C
                            0.025

                             0.02

                            0.015

                             0.01

                            0.005
                                    1.5   2    2.5       3      3.5         4         4.5       5         5.5
                                                              VCC (V)



Figure 31-340. ATmega328P: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                             0.4
                                                                                                            105°C
                                                                                                             85°C
                            0.35
                                                                                                             25°C
                                                                                                            -40°C
                             0.3
                 ICC (mA)




                            0.25


                             0.2


                            0.15


                             0.1
                                   1.5    2   2.5    3       3.5        4       4.5         5       5.5
                                                              VCC (V)




 2020 Microchip Technology Inc.                             Data Sheet Complete                                DS40002061B-page 505
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 31-341. ATmega328P Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)
                                  1.8
                                                                                                                  105°C
                                                                                                                   85°C
                                  1.6
                                                                                                                   25°C
                                  1.4
                                                                                                                  -40°C

                       ICC (mA)   1.2

                                   1

                                  0.8

                                  0.6

                                  0.4

                                  0.2
                                        1.5      2         2.5    3      3.5        4     4.5       5       5.5
                                                                          VCC (V)




31.8.3 ATmega328P Supply Current of IO Modules
      The tables and formulas below can be used to calculate the additional current consumption for the different I/O
      modules in Active and Idle mode. The enabling or disabling of the I/O modules are controlled by the Power
      Reduction Register. See ”Power Reduction Register” on page 51 for details.

      Table 31-15.    ATmega328P: Additional Current Consumption for the different I/O modules (absolute values)
        PRR bit                   Typical numbers
                                    VCC = 2V, F = 1MHz           VCC = 3V, F = 4MHz      VCC = 5V, F = 8MHz
        PRUSART0                              3.20 µA                 22.17 µA                  100.25 µA
        PRTWI                                 7.34 µA                 46.55 µA                  199.25 µA
        PRTIM2                                7.34 µA                 50.79 µA                  224.25 µA
        PRTIM1                                6.19 µA                 41.25 µA                  176.25 µA
        PRTIM0                                1.89 µA                 14.28 µA                  61.13 µA
        PRSPI                                 6.94 µA                 43.84 µA                  186.50 µA
        PRADC                                 8.66 µA                 61.80 µA                  295.38 µA

      Table 31-16.    ATmega328P: Additional Current Consumption (percentage) in Active and Idle mode
                                  Additional Current consumption           Additional Current consumption
                                  compared to Active with external         compared to Idle with external
                                  clock (see Figure 31-332 on page         clock (see Figure 31-337 on page
                                  501 and Figure 31-333 on page            504 and Figure 31-338 on page
        PRR bit                   502)                                     504)
        PRUSART0                                        1.4%                              7.8%
        PRTWI                                           3.0%                             16.6%
        PRTIM2                                          3.3%                             17.8%
        PRTIM1                                          2.7%                             14.5%




        2020 Microchip Technology Inc.                                 Data Sheet Complete                       DS40002061B-page 506
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

       Table 31-16.     ATmega328P: Additional Current Consumption (percentage) in Active and Idle mode (Continued)
                                    Additional Current consumption        Additional Current consumption
                                    compared to Active with external      compared to Idle with external
                                    clock (see Figure 31-332 on page      clock (see Figure 31-337 on page
                                    501 and Figure 31-333 on page         504 and Figure 31-338 on page
         PRR bit                    502)                                  504)
         PRTIM0                                     0.9%                                  4.8%
         PRSPI                                      2.9%                                 15.7%
         PRADC                                      4.1%                                 22.1%
       It is possible to calculate the typical current consumption based on the numbers from Table 31-15 for other VCC
       and frequency settings than listed in Table 31-16.
31.8.3.1 Example
       Calculate the expected current consumption in idle mode with TIMER1, ADC, and SPI enabled at VCC = 2.0V
       and F = 1MHz. From Table 31-16, third column, we see that we need to add 14.5% for the TIMER1, 22.1% for
       the ADC, and 15.7% for the SPI module. Reading from Figure 31-338 on page 504, we find that the idle current
       consumption is ~0.055 mA at VCC = 2.0V and F = 1MHz. The total current consumption in idle mode with
       TIMER1, ADC, and SPI enabled, gives:
       I CC total  0.045 mA  (1 + 0.145 + 0.221 + 0.157)  0.069 mA

31.8.4 Power-down Supply Current

       Figure 31-342. ATmega328P: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)
                                     3

                                                                                                                   105°C
                                    2.5


                                     2
                         ICC (μA)




                                    1.5


                                     1                                                                             85°C


                                    0.5

                                                                                                                    25°C
                                     0                                                                             -40°C
                                          1.5   2          2.5   3         3.5       4        4.5   5        5.5
                                                                         VCC (V)




         2020 Microchip Technology Inc.                                Data Sheet Complete                        DS40002061B-page 507
                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 31-343. ATmega328P: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                                          10
                                                                                                                      105°C
                                           9
                                                                                                                      -40°C
                                           8                                                                           85°C
                                                                                                                       25°C
                                           7
                               ICC (μA)


                                           6

                                           5

                                           4

                                           3

                                           2
                                               1.5       2     2.5    3      3.5       4        4.5         5       5.5
                                                                           VCC (V)




31.8.5 Power-save Supply Current

      Figure 31-344. ATmega328P: Power-Save Supply Current vs. VCC (Watchdog Timer Disabled and 32kHz Crystal
                     Oscillator Running)

                              4

                             3.5
                                                                                                                             105°C
                              3

                             2.5
                  ICC (μA)




                              2

                             1.5                                                                                                 85°C

                              1
                                                                                                                                  25°C
                             0.5                                                                                                 -40°C

                              0
                                   1.5               2       2.5      3      3.5           4          4.5       5          5.5
                                                                           VCC (V)




        2020 Microchip Technology Inc.                                   Data Sheet Complete                             DS40002061B-page 508
                                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

31.8.6 Standby Supply Current

       Figure 31-345. ATmega328P: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)
                             0.16
                                                                                                                                   6MHz_res
                             0.14
                                                                                                                                   6MHz_xtal
                             0.12                                                                                                  4MHz_res
                                                                                                                                   4MHz_xtal
                              0.1
                                                                                                                                   2MHz_res
                  ICC (mA)




                             0.08                                                                                                  2MHz_xtal

                             0.06                                                                                                  1MHz_res

                             0.04

                             0.02

                                 0
                                        1.5       2         2.5          3           3.5         4         4.5         5         5.5
                                                                                   VCC (V)




31.8.7 Pin Pull-Up

       Figure 31-346. ATmega328P: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)
                                         50
                                         45
                                         40
                                         35
                                         30
                              IOP(µA)




                                         25
                                         20
                                         15
                                                                                                                                  25°C
                                         10
                                                                                                                                 -40°C
                                          5                                                                                       85°C
                                          0                                                                                      105°C
                                              0       0.2   0.4    0.6       0.8       1       1.2   1.4         1.6   1.8   2
                                                                                     VOP (V)




        2020 Microchip Technology Inc.                                            Data Sheet Complete                            DS40002061B-page 509
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-347. ATmega328P: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)

                             80

                             70

                             60

                             50
                  IOP (μA)


                             40

                             30

                             20                                                                   25°C
                                                                                                  85°C
                             10
                                                                                                 -40°C
                              0                                                                  105°C
                                   0   0.5         1          1.5           2        2.5     3
                                                            VOP (V)


Figure 31-348. ATmega328P: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)

                             160

                             140

                             120

                             100
                IOP (μA)




                              80

                              60

                              40                                                                  25°C
                                                                                                  85°C
                              20                                                                 105°C
                                                                                                 -40°C
                               0
                                   0         1         2              3          4           5
                                                            VOP (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                   DS40002061B-page 510
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-349. ATmega328P: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)
                                 40

                                 35

                                 30

                 IRESET (μA)     25

                                 20

                                 15

                                 10                                                              25°C
                                                                                                -40°C
                                 5                                                               85°C
                                                                                                105°C
                                 0
                                      0   0.2   0.4   0.6   0.8       1    1.2    1.4   1.6   1.8
                                                             VRESET (V)


Figure 31-350. ATmega328P: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7V)

                                 60


                                 50


                                 40
                   IRESET (μA)




                                 30


                                 20

                                                                                                 25°C
                                 10                                                             -40°C
                                                                                                 85°C
                                                                                                105°C
                                  0
                                      0   0.3   0.6   0.9   1.2      1.5    1.8   2.1   2.4   2.7
                                                             VRESET (V)




 2020 Microchip Technology Inc.                            Data Sheet Complete                     DS40002061B-page 511
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-351. ATmega328P: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                                     120


                                     100


                       IRESET (μA)    80


                                      60


                                      40

                                                                                                                   25°C
                                      20                                                                          -40°C
                                                                                                                   85°C
                                                                                                                  105°C
                                       0
                                           0   0.5   1       1.5   2      2.5       3    3.5        4   4.5   5
                                                                       VRESET (V)




31.8.8 Pin Driver Strength

       Figure 31-352. ATmega328P: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                                       1
                                                                                                               105°C
                                     0.9
                                                                                                                85°C
                                     0.8

                                     0.7                                                                           25°C
                                     0.6
                           VOL (V)




                                                                                                                  -40°C
                                     0.5

                                     0.4

                                     0.3

                                     0.2

                                     0.1

                                       0
                                           0             5                 10                  15             20
                                                                        IOL (mA)




        2020 Microchip Technology Inc.                                Data Sheet Complete                         DS40002061B-page 512
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-353. ATmega328P: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                          0.7


                          0.6                                                          105°C
                                                                                        85°C
                          0.5
                                                                                        25°C
                          0.4                                                          -40°C
                VOL (V)



                          0.3


                          0.2


                          0.1


                               0
                                   0       5           10                15       20
                                                    IOL (mA)


Figure 31-354. ATmega328P: I/O Pin Output Voltage vs. Source Current (Vcc = 3V)

                               3.1


                               2.9


                               2.7
                     VOH (V)




                               2.5

                                                                                        -40°C
                               2.3

                                                                                        25°C
                               2.1

                                                                                        85°C
                               1.9                                                     105°C
                                       0       5        10                15       20
                                                      IOH (mA)




 2020 Microchip Technology Inc.                   Data Sheet Complete                 DS40002061B-page 513
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-355. ATmega328P: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                                          5.1

                                           5

                                          4.9

                                          4.8
                       VOH (V)


                                          4.7

                                          4.6
                                                                                                       -40°C
                                          4.5
                                                                                                          25°C
                                          4.4                                                           85°C
                                                                                                       105°C
                                          4.3
                                                0         5            10                 15        20
                                                                    IOH (mA)



31.8.9 Pin Threshold and Hysteresis

       Figure 31-356. ATmega328P: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                          3.1
                                                                                                          105°C
                                                                                                           85°C
                                          2.8
                                                                                                           25°C
                                          2.5
                                                                                                          -40°C
                          Threshold (V)




                                          2.2


                                          1.9


                                          1.6


                                          1.3


                                            1
                                                1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                     VCC (V)




        2020 Microchip Technology Inc.                             Data Sheet Complete                   DS40002061B-page 514
                                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-357. ATmega328P: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’

                                 2.6
                                                                                                                                        105°C
                                 2.3                                                                                                     85°C
                                                    2                                                                                    25°C
                                                                                                                                         -40°C
                Threshold (V)    1.7

                                 1.4

                                 1.1

                                 0.8

                                 0.5

                                 0.2
                                                        1.5         2         2.5         3         3.5         4     4.5     5    5.5
                                                                                                VCC (V)



Figure 31-358. ATmega328P: I/O Pin Input Hysteresis vs. VCC

                                                        0.8


                                                        0.7
                                                                                                                                           -40°C
                                                                                                                                            25°C
                                Input Hysteresis (mV)




                                                        0.6
                                                                                                                                            85°C
                                                                                                                                           105°C
                                                        0.5


                                                        0.4


                                                        0.3


                                                        0.2
                                                              1.8       2.3         2.8       3.3         3.8       4.3     4.8   5.3
                                                                                                     VCC (V)




 2020 Microchip Technology Inc.                                                              Data Sheet Complete                        DS40002061B-page 515
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-359. ATmega328P: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                 2.6
                                                                                                    -40°C
                                 2.4                                                                25°C
                                 2.2                                                                85°C
                                  2                                                             105°C
                 Threshold (V)
                                 1.8

                                 1.6

                                 1.4

                                 1.2

                                  1

                                 0.8
                                       1.5   2   2.5   3      3.5        4       4.5   5      5.5
                                                             VCC (V)



Figure 31-360. ATmega328P: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                 2.5                                                                105°C
                                 2.3                                                                 85°C
                                 2.1                                                                 25°C
                                 1.9
                                                                                                    -40°C
                 Threshold (V)




                                 1.7

                                 1.5

                                 1.3

                                 1.1

                                 0.9

                                 0.7

                                 0.5
                                       1.5   2   2.5   3      3.5       4        4.5   5      5.5
                                                            VCC (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                      DS40002061B-page 516
                                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 31-361. ATmega328P: Reset Pin Input Hysteresis vs. VCC

                                                       0.7
                                                                   -40°C
                                                       0.6


                                                       0.5
                                Input Hysteresis (V)               25°C
                                                       0.4


                                                       0.3
                                                                   85°C
                                                       0.2
                                                                   105°C
                                                       0.1


                                                         0
                                                             1.5           2   2.5       3          3.5         4          4.5        5     5.5
                                                                                                 VCC (V)




31.8.10 BOD Threshold

      Figure 31-362. ATmega328P: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                                  1.84

                                                                                                Rising Vcc
                                                  1.83


                                                  1.82
                       Threshold (V)




                                                  1.81


                                                       1.8

                                                                                                Falling Vcc
                                                  1.79


                                                  1.78
                                                             -50 -40 -30 -20 -10     0   10    20    30    40    50   60    70   80   90 100 110
                                                                                              Temperature (°C)




        2020 Microchip Technology Inc.                                                         Data Sheet Complete                               DS40002061B-page 517
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-363. ATmega328P: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                2.78
                                2.77
                                                                         Rising Vcc
                                2.76
                                2.75
                Threshold (V)   2.74
                                2.73
                                2.72
                                2.71
                                 2.7
                                                                             Falling Vcc
                                2.69
                                2.68
                                2.67
                                2.66
                                       -40   -30   -20   -10   0   10   20     30   40     50   60   70   80   90   100 110
                                                                         Temperature (°C)


Figure 31-364. ATmega328P: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                4.38


                                4.36
                                                                              Rising Vcc
                                4.34
                Threshold (V)




                                4.32


                                 4.3


                                4.28


                                4.26
                                                                         Falling Vcc

                                4.24
                                       -40   -30   -20   -10   0   10   20     30   40     50   60   70   80   90   100 110
                                                                         Temperature (°C)




 2020 Microchip Technology Inc.                                             Data Sheet Complete                          DS40002061B-page 518
                                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-365. ATmega328P: Calibrated Bandgap Voltage vs. Vcc

                                            1.139


                                            1.136

                      Bandgap Voltage (V)                                                                                                                   25°C
                                            1.133


                                                  1.13


                                            1.127
                                                                                                                                                         85°C
                                                                                                                                                        -40°C
                                            1.124
                                                                                                                                                        105°C
                                            1.121
                                                         1.5         2           2.5        3            3.5             4        4.5        5        5.5
                                                                                                       Vcc (V)




31.8.11 Internal Oscillator Speed

       Figure 31-366. ATmega328P: Watchdog Oscillator Frequency vs. Temperature

                                                  120


                                                  118


                                                  116
                                      FRC (kHz)




                                                  114


                                                  112


                                                  110                                                                                                   2.7V
                                                                                                                                                        3.6V
                                                  108                                                                                                   4.0V
                                                                                                                                                        5.5V
                                                  106
                                                         -40   -30   -20   -10     0   10       20     30      40   50       60   70    80   90   100 110
                                                                                                     Temperature (°C)




         2020 Microchip Technology Inc.                                                             Data Sheet Complete                                    DS40002061B-page 519
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-367. ATmega328P: Watchdog Oscillator Frequency vs. VCC

                              120


                              118
                                                                                       -40°C
                              116

                                                                                           25°C
               FRC (kHz)

                              114


                              112


                              110
                                                                                           85°C
                              108
                                                                                      105°C
                              106
                                    2   2.5    3   3.5             4       4.5   5   5.5
                                                         VCC (V)



Figure 31-368. ATmega328P: Calibrated 8 MHz RC Oscillator Frequency vs. VCC

                              8.6


                              8.4                                                      105°C
                                                                                        85°C
                              8.2
                                                                                           25°C
                  FRC (MHz)




                                8


                              7.8                                                      -40°C

                              7.6


                              7.4
                                    2   2.5    3   3.5             4       4.5   5   5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete                   DS40002061B-page 520
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-369. ATmega328P: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                             8.4                                                                                         5.5V
                                                                                                                         5.0V
                             8.3                                                                                         4.5V
                                                                                                                         4.0V
                             8.2
                                                                                                                         3.6V
                                                                                                                         2.7V
                             8.1
                                                                                                                         1.8V
                FRC (MHz)

                              8

                             7.9

                             7.8

                             7.7

                             7.6

                             7.5
                                   -40   -30   -20   -10    0    10    20     30   40   50     60   70   80   90   100 110
                                                                            Temperature (°C)




Figure 31-370. ATmega328P: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                             14
                                                                                                                        105°C
                             13                                                                                          85°C
                                                                                                                         25°C
                             12
                                                                                                                        -40°C
                             11

                             10
                 FRC (MHz)




                              9

                              8

                              7

                              6

                              5

                              4
                                   0     16    32    48    64   80    96 112 128 144 160 176 192 208 224 240
                                                                         OSCCAL (X1)




 2020 Microchip Technology Inc.                                            Data Sheet Complete                              DS40002061B-page 521
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

31.8.12 Current Consumption of Peripheral Units

       Figure 31-371. ATmega328P: ADC Current vs. VCC (AREF = AVCC)

                                    160
                                                                                                 85°C
                                                                                                105°C
                                    140                                                          25°C
                                                                                                -40°C
                                    120
                       ICC (μA)




                                    100


                                     80


                                     60


                                     40
                                          1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                               VCC (V)


       Figure 31-372. ATmega328P: Analog Comparator Current vs. VCC

                                    100


                                     90                                                         -40°C

                                     80                                                         25°C
                                                                                                85°C
                                     70
                                                                                               105°C
                         ICC (μA)




                                     60


                                     50


                                     40


                                     30
                                          1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                               VCC (V)




        2020 Microchip Technology Inc.                       Data Sheet Complete                   DS40002061B-page 522
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-373. ATmega328P: AREF External Reference Current vs. VCC
                               180
                                                                                           85°C
                                                                                          105°C
                               160
                                                                                           25°C
                                                                                          -40°C
                               140


                               120
                ICC (μA)



                               100


                                80


                                60


                                40
                                     1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)


Figure 31-374. ATmega328P: Brownout Detector Current vs. VCC

                                30



                                                                                           105°C
                                25                                                          85°C
                                                                                            25°C
                                                                                           -40°C
                    ICC (μA)




                                20




                                15




                                10
                                     1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                         Data Sheet Complete                   DS40002061B-page 523
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 31-375. ATmega328P: Programming Current vs. VCC

                                      10

                                       9
                                                                                                                            25°C
                                       8
                                                                                                                            85°C
                                                                                                                           105°C
                                                                                                                           -40°C
                                       7
                           ICC (mA)
                                       6

                                       5

                                       4

                                       3

                                       2

                                       1
                                           1.5     2     2.5         3           3.5         4         4.5     5     5.5
                                                                             VCC (V)




31.8.13 Current Consumption in Reset and Reset Pulsewidth

       Figure 31-376. ATmega328P: Reset Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                  0.16
                                                                                                                           5.5V
                                  0.14

                                  0.12                                                                                     5.0V

                                      0.1
                                                                                                                           4.5V
                       ICC (mA)




                                                                                                                           4.0V
                                  0.08
                                                                                                                           3.6V
                                  0.06
                                                                                                                           2.7V
                                  0.04
                                                                                                                           1.8V
                                  0.02

                                       0
                                            0.1   0.2   0.3    0.4         0.5         0.6       0.7     0.8   0.9    1
                                                                         Frequency (MHz)




        2020 Microchip Technology Inc.                                    Data Sheet Complete                             DS40002061B-page 524
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 31-377. ATmega328P Reset Supply Current vs. Frequency (1MHz - 20MHz)

                                        3
                                                                                                                                     5.5V

                                      2.5                                                                                            5.0V

                                                                                                                                     4.5V
                           ICC (mA)     2


                                      1.5
                                                                                                                  4.0V


                                        1
                                                                                                  3.6V


                                      0.5                                             2.7V

                                                              1.8V
                                        0
                                            0     2       4          6       8      10       12       14         16       18   20
                                                                             Frequency (MHz)


Figure 31-378. ATmega328P: Minimum Reset Pulse Width vs. Vcc

                                 1800

                                 1600

                                 1400

                                 1200
               Pulsewidth (ns)




                                 1000

                                      800

                                      600
                                                                                                                                    105°C
                                      400
                                                                                                                                     85°C
                                      200                                                                                            25°C
                                                                                                                                    -40°C
                                       0
                                            1.5       2        2.5       3          3.5           4        4.5        5        5.5
                                                                                  VCC (V)




 2020 Microchip Technology Inc.                                                 Data Sheet Complete                                 DS40002061B-page 525
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P


32.    ATmega48PA Typical Characteristics – (TA = -40°C to 105°C)
       The following charts show typical behavior. These figures are not tested during manufacturing. All current
       consumption measurements are performed with all I/O pins configured as inputs and with internal pull-ups enabled. A
       square wave generator with rail-to-rail output is used as clock source.
       All Active- and Idle current consumption measurements are done with all bits in the PRR register set and thus, the
       corresponding I/O modules are turned off. Also the Analog Comparator is disabled during these measurements.
       The power consumption in Power-down mode is independent of clock selection.
       The current consumption is a function of several factors such as: operating voltage, operating frequency, loading of
       I/O pins, switching rate of I/O pins, code executed and ambient temperature. The dominating factors are operating
       voltage and frequency.
       The current drawn from capacitive loaded pins may be estimated (for one pin) as CL*VCC*f where CL = load
       capacitance, VCC = operating voltage and f = average switching frequency of I/O pin.
       The parts are characterized at frequencies higher than test limits. Parts are not ensured to function properly at
       frequencies higher than the ordering code indicates.
       The difference between current consumption in Power-down mode with Watchdog Timer enabled and Power-
       down mode with Watchdog Timer disabled represents the differential current drawn by the Watchdog Timer.

32.1   Active Supply Current

       Figure 32-1. ATmega48PA: Active Supply Current vs. Low Frequency (0.1MHz -1.0MHz)

                               1
                                                                                                              5.5V
                              0.9

                              0.8                                                                             5.0V
                              0.7
                                                                                                              4.5V
                              0.6
                   ICC (mA)




                                                                                                              4.0V
                              0.5
                                                                                                              3.6V
                              0.4                                                                             3.3V

                              0.3                                                                             2.7V
                              0.2                                                                             1.8V
                              0.1

                               0
                                    0.1   0.2   0.3    0.4    0.5      0.6      0.7     0.8     0.9       1
                                                             Frequency (MHz)




        2020 Microchip Technology Inc.                        Data Sheet Complete                       DS40002061B-page 526
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-2. ATmega48PA: Active Supply Current vs. Frequency (1MHz - 20MHz)

                               11
                                                                                                                       5.5V
                               10
                                9                                                                                      5.0V
                                8
                                                                                                                       4.5V
                                7
                    ICC (mA)




                                6
                                                                                                          4.0V
                                5
                                4
                                                                                          3.3V
                                3
                                2                                                2.7V
                                1
                                                      1.8V
                                0
                                    0      2      4          6     8        10      12        14     16     18    20
                                                                   Frequency (MHz)

Figure 32-3. ATmega48PA: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                                                                                                                   105°C
                       0.126                                                                                        85°C
                                                                                                                   -40°C
                    0.1158                                                                                          25°C
                    0.1056

                    0.0954

                    0.0852
         ICC (mA)




                       0.075

                    0.0648

                    0.0546

                    0.0444

                    0.0342

                       0.024
                                    1.8   2.17   2.54    2.91    3.28     3.65     4.02    4.39    4.76   5.13   5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                        Data Sheet Complete                      DS40002061B-page 527
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-4. ATmega48PA: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                      1.2                                                                              105°C
                                                                                                        85°C
                      1.1                                                                               25°C
                          1
                                                                                                       -40°C

                      0.9

                      0.8
           ICC (mA)




                      0.7

                      0.6

                      0.5

                      0.4

                      0.3

                      0.2
                              1.5       2       2.5     3         3.5       4         4.5    5       5.5
                                                                VCC (V)


Figure 32-5. ATmega48PA: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                          5.5
                                                                                                           105°C
                              5                                                                             85°C
                                                                                                            25°C
                          4.5
                                                                                                           -40°C
                              4

                          3.5
               ICC (mA)




                              3

                          2.5

                              2

                          1.5

                              1

                          0.5
                                  1.5       2    2.5        3      3.5          4      4.5       5    5.5
                                                                 VCC (V)




 2020 Microchip Technology Inc.                                Data Sheet Complete                   DS40002061B-page 528
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

32.2   Idle Supply Current

       Figure 32-6. ATmega48PA: Idle Supply Current vs. Low Frequency (0.1MHz -1.0MHz)

                             0.16

                             0.14                                                                                         5.5V

                             0.12                                                                                         5.0V
                              0.1
                                                                                                                          4.5V
                  ICC (mA)




                             0.08                                                                                         4.0V

                             0.06
                                                                                                                          3.3V
                             0.04                                                                                         2.7V

                             0.02
                                                                                                                          1.8V

                                   0
                                       0   0.1   0.2        0.3   0.4       0.5        0.6      0.7   0.8      0.9    1
                                                                      Frequency (MHz)


       Figure 32-7. ATmega48PA: Idle Supply Current vs. Frequency (1MHz - 20MHz)

                             2.6
                                                                                                                      5.5V
                             2.4
                             2.2                                                                                      5.0V
                              2
                             1.8                                                                                      4.5V
                             1.6
                  ICC (mA)




                             1.4
                                                                                                            4.0V
                             1.2
                              1
                             0.8
                                                                                             3.3V
                             0.6
                             0.4                                                2.7V
                             0.2
                                                     1.8V
                              0
                                   0       2     4          6     8        10          12       14    16      18     20
                                                                  Frequency (MHz)




        2020 Microchip Technology Inc.                                  Data Sheet Complete                          DS40002061B-page 529
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-8. ATmega48PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                      0.05
                                                                                                      105°C
                     0.045

                      0.04                                                                             85°C

                     0.035
          ICC (mA)




                      0.03
                                                                                                       25°C
                     0.025                                                                            -40°C

                      0.02

                     0.015

                      0.01

                     0.005
                             1.5       2    2.5        3      3.5          4      4.5       5    5.5
                                                            VCC (V)


Figure 32-9. ATmega48PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                     0.33
                                                                                                  105°C
                                                                                                   85°C
                                                                                                   25°C
                     0.28
                                                                                                  -40°C


                     0.23
         ICC (mA)




                     0.18



                     0.13



                     0.08
                            1.5    2       2.5     3         3.5       4         4.5    5       5.5
                                                           VCC (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                    DS40002061B-page 530
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 32-10.ATmega48PA: Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)

                                1.3
                                                                                                   105°C
                                1.2                                                                 85°C
                                                                                                    25°C
                                1.1                                                                -40°C
                                 1
                                0.9
                   ICC (mA)




                                0.8
                                0.7
                                0.6
                                0.5
                                0.4
                                0.3
                                0.2
                                      1.5   2   2.5   3      3.5        4       4.5          5   5.5
                                                           VCC (V)




32.3   Power-down Supply Current

       Figure 32-11.ATmega48PA: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                                2.7                                                                105°C
                                2.4

                                2.1

                                1.8
                     ICC (μA)




                                1.5

                                1.2

                                0.9                                                                 85°C
                                                                                                   -40°C
                                0.6

                                0.3
                                                                                                       25°C
                                  0
                                      1.5   2   2.5   3      3.5        4       4.5          5   5.5
                                                           VCC (V)




        2020 Microchip Technology Inc.                   Data Sheet Complete                    DS40002061B-page 531
                                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 32-12.ATmega48PA: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                                         9
                                                                                                                                   105°C
                                8.5
                                         8
                                7.5                                                                                                   -40°C
                                                                                                                                       85°C
                                         7
                                                                                                                                       25°C
                                6.5
                   ICC (μA)




                                         6
                                5.5
                                         5
                                4.5
                                         4
                                3.5
                                         3
                                2.5
                                             1.5          2       2.5         3           3.5       4         4.5     5          5.5
                                                                                      VCC (V)




32.4   Standby Supply Current

       Figure 32-13.ATmega48PA: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)


                                             150                                                                          6MHz_xtal
                                                                                                                          6MHz_res
                                             135

                                             120

                                             105
                                                                                                                          4MHz_res
                                                                                                                          4MHz_xtal
                                              90
                              ICC (μA)




                                              75                                                                          2MHz_res
                                                                                                                          2MHz_xtal
                                              60
                                                                                                                       1MHz_res
                                              45                                                                      450kHz_res
                                              30

                                              15

                                              0.0
                                                    1.5       2   2.5     3         3.5         4       4.5    5    5.5
                                                                                  VCC (V)




        2020 Microchip Technology Inc.                                              Data Sheet Complete                         DS40002061B-page 532
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

32.5   Pin Pull-Up

       Figure 32-14.ATmega48PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)

                               45

                               40

                               35

                               30
                    IOP (μA)




                               25

                               20

                               15

                               10
                                                                                                   105°C
                                5                                                                  -40°C
                                                                                                    25°C
                                0                                                                   85°C
                                    0   0.2   0.4    0.6   0.8         1    1.2    1.4     1.6    1.8
                                                             VOP (V)


       Figure 32-15.ATmega48PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)

                               70


                               60


                               50


                               40
                    IOP (μA)




                               30


                               20


                               10                                                                    25°C
                                                                                                     85°C
                                                                                                    -40°C
                                0                                                                   105°C
                                    0   0.3   0.6    0.9   1.2     1.5      1.8    2.1     2.4    2.7
                                                             VOP (V)




        2020 Microchip Technology Inc.                     Data Sheet Complete                   DS40002061B-page 533
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-16.ATmega48PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)



                         120

                         105

                               90

                               75
           IOP (μA)




                               60

                               45

                               30
                                                                                                                    25°C
                               15                                                                                   85°C
                                                                                                                   105°C
                                0                                                                                  -40°C
                                    0   0.5   1     1.5     2         2.5       3         3.5         4    4.5    5
                                                                  VOP (V)


Figure 32-17.ATmega48PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)

                               35


                               30


                               25
                 IRESET (μA)




                               20


                               15


                               10

                                                                                                                    25°C
                                5
                                                                                                                   -40°C
                                                                                                                   105°C
                                0
                                                                                                                    85°C
                                    0   0.2   0.4     0.6       0.8         1       1.2         1.4       1.6    1.8
                                                                 VRESET (V)




 2020 Microchip Technology Inc.                                 Data Sheet Complete                             DS40002061B-page 534
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-18.ATmega48PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7V)

                               52
                               48
                               44
                               40
                               36
                               32
                IRESET (μA)




                               28
                               24
                               20
                               16
                               12
                                8                                                                            25°C
                                4
                                                                                                            -40°C
                                                                                                             85°C
                                0                                                                           105°C
                                    0   0.3   0.6     0.9       1.2         1.5       1.8     2.1   2.4   2.7
                                                                 VRESET (V)


Figure 32-19.ATmega48PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                              110
                              100
                               90
                               80
                               70
           IRESET (μA)




                               60
                               50
                               40
                               30
                               20                                                                           85°C
                                                                                                            25°C
                               10                                                                          -40°C
                                0                                                                          105°C
                                    0   0.5   1     1.5     2         2.5         3     3.5     4   4.5    5
                                                                 VRESET (V)




 2020 Microchip Technology Inc.                                 Data Sheet Complete                      DS40002061B-page 535
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

32.6   Pin Driver Strength

       Figure 32-20.ATmega48PA: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                                 1
                                                                                                 105°C
                               0.9                                                                85°C
                               0.8

                               0.7                                                                   25°C
                               0.6
                                                                                                  -40°C
                     VOL (V)




                               0.5

                               0.4

                               0.3

                               0.2

                               0.1

                                 0
                                      0   2   4    6   8      10       12        14   16   18   20
                                                           IOL (mA)


       Figure 32-21.ATmega48PA: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                               0.65
                                0.6                                                              105°C
                                                                                                  85°C
                               0.55
                                0.5
                                                                                                     25°C
                               0.45
                                0.4                                                                  -40°C
                   VOL (V)




                               0.35
                                0.3
                               0.25
                                0.2
                               0.15
                                0.1
                               0.05
                                 0
                                      0   2   4    6   8      10       12        14   16   18   20
                                                            IOL (mA)




        2020 Microchip Technology Inc.                    Data Sheet Complete                  DS40002061B-page 536
                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-22.ATmega48PA: I/O Pin Output Voltage vs. Source Current (Vcc = 3V)

                       3

                      2.9

                      2.8

                      2.7

                      2.6
            VOH (V)




                      2.5

                      2.4

                      2.3                                                                -40°C

                      2.2
                                                                                             25°C
                      2.1

                       2
                                                                                          85°C
                      1.9                                                                105°C
                            0   2   4    6     8      10      12         14   16   18   20
                                                   IOH (mA)


Figure 32-23.ATmega48PA: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                       5


                      4.9


                      4.8


                      4.7
            VOH (V)




                      4.6

                                                                                          -40°C
                      4.5
                                                                                             25°C
                      4.4
                                                                                          85°C
                                                                                         105°C
                      4.3
                            0   2   4    6     8      10      12         14   16   18   20
                                                   IOH (mA)




 2020 Microchip Technology Inc.                   Data Sheet Complete                  DS40002061B-page 537
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

32.7   Pin Threshold and Hysteresis

       Figure 32-24.ATmega48PA: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                                                                                       105°C
                                   2.9                                                                  85°C
                                                                                                       -40°C
                                                                                                        25°C
                                   2.6


                                   2.3
                   Threshold (V)




                                    2


                                   1.7


                                   1.4


                                   1.1


                                   0.8
                                         1.5   2   2.5   3      3.5        4       4.5        5      5.5
                                                              VCC (V)


       Figure 32-25.ATmega48PA: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)
                                                                                                       105°C
                                   2.4                                                                 -40°C
                                                                                                        85°C
                                   2.1
                                                                                                        25°C

                                   1.8
                   Threshold (V)




                                   1.5


                                   1.2


                                   0.9


                                   0.6


                                   0.3
                                         1.5   2   2.5   3      3.5        4       4.5       5       5.5
                                                              VCC (V)




        2020 Microchip Technology Inc.                      Data Sheet Complete                     DS40002061B-page 538
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-26.ATmega48PA: I/O Pin Input Hysteresis vs. VCC

                                    0.6
                                            -40 °C
                                                                                                             25°C
                                   0.55                                                                      85°C
                                                                                                            105°C
                                    0.5                                                                     -40°C
           Input Hysteresis (mV)




                                   0.45
                                                25 °C
                                    0.4


                                   0.35
                                                85 °C

                                    0.3
                                           105 °C
                                   0.25
                                          1.5           2       2.5    3      3.5        4       4.5   5   5.5
                                                                            VCC (V)

Figure 32-27.ATmega48PA: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                                                                                            105°C
                                   2.45                                                                      85°C
                                                                                                            -40°C
                                                                                                             25°C
                                    2.2


                                   1.95
           Threshold (V)




                                    1.7


                                   1.45
                                           -40°C

                                    1.2     25°C
                                            85°C
                                                            105°C
                                   0.95
                                          1.5           2       2.5    3      3.5        4       4.5   5   5.5
                                                                            VCC (V)




 2020 Microchip Technology Inc.                                           Data Sheet Complete             DS40002061B-page 539
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-28.ATmega48PA: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                                                                                       -40°C
                                   2.4                                                                 105°C
                                                                                                        85°C
                                   2.2                                                                  25°C
                                     2

                                   1.8
                Threshold (V)




                                   1.6

                                   1.4

                                   1.2

                                     1

                                   0.8

                                   0.6
                                          1.5          2   2.5   3      3.5        4       4.5   5   5.5
                                                                      VCC (V)

Figure 32-29.ATmega48PA: Reset Pin Input Hysteresis vs. VCC

                                   0.65
                                            -40°C
                                    0.6
                                   0.55
                                    0.5
                                   0.45
           Input Hysteresis (mV)




                                                25°C
                                    0.4
                                   0.35
                                    0.3
                                   0.25         85°C
                                    0.2
                                   0.15    105°C
                                    0.1                                                                 85°C
                                                                                                       105°C
                                   0.05                                                                 25°C
                                     0                                                                 -40°C
                                          1.5          2   2.5   3      3.5        4       4.5   5   5.5
                                                                      VCC (V)




 2020 Microchip Technology Inc.                                     Data Sheet Complete             DS40002061B-page 540
                                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

32.8   BOD Threshold

       Figure 32-30.ATmega48PA: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                       1.825
                                        1.82
                                                                                                   Rising Vcc
                                       1.815
                                        1.81
                                       1.805
                Threshold (V)




                                         1.8
                                       1.795
                                        1.79
                                       1.785
                                                                                         Falling Vcc
                                        1.78
                                       1.775
                                        1.77
                                       1.765
                                               -40   -30   -20   -10   0   10   20     30    40     50   60     70   80   90   100 110
                                                                                 Temperature (°C)


       Figure 32-31.ATmega48PA: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                        2.76
                                        2.75
                                                                                            Rising Vcc
                                        2.74
                                        2.73
                                        2.72
                       Threshold (V)




                                        2.71
                                         2.7
                                        2.69
                                        2.68
                                                                                     Falling Vcc
                                        2.67
                                        2.66
                                        2.65
                                        2.64
                                               -40   -30   -20   -10   0   10   20     30    40     50   60     70   80   90   100 110
                                                                                 Temperature (°C)




        2020 Microchip Technology Inc.                                               Data Sheet Complete                          DS40002061B-page 541
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 32-32.ATmega48PA: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                  4.34


                                  4.32
                                                                                                    Rising Vcc
                                   4.3
                  Threshold (V)




                                  4.28


                                  4.26
                                                                                      Falling Vcc
                                  4.24


                                  4.22


                                   4.2
                                         -40   -30   -20   -10   0   10   20     30     40   50      60   70     80   90   100   110
                                                                           Temperature (°C)




32.9   Internal Oscillator Speed

       Figure 32-33.ATmega48PA: Watchdog Oscillator Frequency vs. Temperature

                                  116


                                  114


                                  112
                    FRC (kHz)




                                  110


                                  108

                                                                                                                                   2.7V
                                  106                                                                                              3.3V
                                                                                                                                   4.0V
                                  104                                                                                              5.5V
                                         -40   -30   -20   -10   0   10   20    30      40   50      60   70     80   90   100   110
                                                                               Temperature (°C)




        2020 Microchip Technology Inc.                                         Data Sheet Complete                              DS40002061B-page 542
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-34.ATmega48PA: Watchdog Oscillator Frequency vs. VCC

                        116


                        114                                                              -40°C

                        112                                                              25°C
           FRC (kHz)




                        110


                        108

                                                                                         85°C
                        106


                        104
                                                                                     105°C
                              1.5    2   2.5   3      3.5        4       4.5   5   5.5
                                                    VCC (V)


Figure 32-35.ATmega48PA: Calibrated 8MHz RC Oscillator Frequency vs. VCC
                        8.25
                         8.2
                                                                                     105°C
                        8.15                                                             85°C
                         8.1
                        8.05
                          8
            FRC (MHz)




                        7.95                                                             25°C
                         7.9
                        7.85
                         7.8
                        7.75
                         7.7                                                         -40°C
                        7.65
                               1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                    VCC (V)




 2020 Microchip Technology Inc.                   Data Sheet Complete             DS40002061B-page 543
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-36.ATmega48PA: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                              8.2
                                                                                                                            4.0V
                                                                                                                            3.0V
                        8.15
                                                                                                                            5.5V
                                                                                                                            1.8V
                              8.1

                        8.05

                               8
           FRC (MHz)




                        7.95

                              7.9

                        7.85

                              7.8

                        7.75

                              7.7

                        7.65
                                    -40   -30   -20   -10    0    10    20     30   40     50   60   70   80   90   100   110
                                                                             Temperature (°C)


Figure 32-37.ATmega48PA: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                              15                                                                                            85°C
                                                                                                                            25°C
                              14                                                                                           105°C
                              13
                                                                                                                           -40°C

                              12

                              11
                  FRC (MHz)




                              10

                               9

                               8

                               7

                               6

                               5

                               4
                                    0     16    32    48    64   80    96    112 128 144 160 176 192 208 224 240 256
                                                                             OSCCAL (X1)




 2020 Microchip Technology Inc.                                              Data Sheet Complete                         DS40002061B-page 544
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

32.10 Current Consumption of Peripheral Units

      Figure 32-38.ATmega48PA: ADC Current vs. VCC (AREF = AVCC)

                                 310                                                         -40°C
                                                                                              25°C
                                 290
                                                                                              85°C
                                 270
                                                                                             105°C

                                 250
                  ICC (μA)




                                 230

                                 210

                                 190

                                 170

                                 150

                                 130
                                       1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                            VCC (V)


      Figure 32-39.ATmega48PA: Analog Comparator Current vs. VCC

                                  90
                                                                                             -40°C
                                  85

                                  80
                                                                                              25°C
                                  75                                                          85°C
                                                                                             105°C
                                  70
                      ICC (μA)




                                  65

                                  60

                                  55

                                  50

                                  45
                                     105°C
                                  40  85°C
                                      25°C
                                  35 -40°C
                                       1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                            VCC (V)




       2020 Microchip Technology Inc.                     Data Sheet Complete             DS40002061B-page 545
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-40.ATmega48PA: AREF External Reference Current vs. VCC
                                                                                    105°C
                        150                                                          85°C
                                                                                     25°C
                        140
                                                                                    -40°C
                        130

                        120

                        110
            ICC (μA)




                        100

                         90

                         80

                         70

                         60

                         50

                         40
                              1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                   VCC (V)


Figure 32-41.ATmega48PA: Brownout Detector Current vs. VCC

                        26
                        25
                                                                                    105°C
                        24                                                           85°C
                        23
                                                                                         25°C
                        22                                                              -40°C
             ICC (μA)




                        21
                        20
                        19
                        18
                        17
                        16
                        15
                              1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                   VCC (V)




 2020 Microchip Technology Inc.                  Data Sheet Complete             DS40002061B-page 546
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

     Figure 32-42.ATmega48PA: Programming Current vs. VCC

                             5.5                                                                                               -40°C
                               5

                             4.5                                                                                                 25°C
                               4
                  ICC (mA)




                             3.5

                               3
                                                                                                                                85°C
                             2.5                                                                                               105°C
                               2

                             1.5

                               1
                                    1.5         2         2.5         3         3.5           4          4.5         5     5.5
                                                                              VCC (V)




32.11 Current Consumption in Reset and Reset Pulsewidth

     Figure 32-43.ATmega48PA: Reset Supply Current vs. Low Frequency (0.1MHz- 1.0MHz)

                             0.13                                                                                              5.5V
                             0.12
                             0.11
                              0.1
                                                                                                                               5.0V
                             0.09
                                                                                                                               4.5V
                             0.08
                 ICC (mA)




                             0.07                                                                                              4.0V
                             0.06
                             0.05                                                                                              3.3V
                             0.04                                                                                              2.7V
                             0.03
                             0.02                                                                                              1.8V
                             0.01
                               0
                                    0     0.1       0.2         0.3   0.4       0.5     0.6        0.7         0.8   0.9   1
                                                                          Frequency (MHz)




       2020 Microchip Technology Inc.                                       Data Sheet Complete                           DS40002061B-page 547
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 32-44.ATmega48PA: Reset Supply Current vs. Frequency (1MHz- 20MHz)

                                 2.4
                                                                                                                                   5.5V
                                 2.2
                                   2                                                                                               5.0V
                                 1.8
                                                                                                                                   4.5V
                                 1.6
                                 1.4
                      ICC (mA)




                                 1.2                                                                              4.0V
                                   1
                                 0.8
                                                                                             3.3V
                                 0.6
                                 0.4
                                                                                 2.7V
                                 0.2
                                                         1.8V
                                   0
                                       0     2       4          6       8      10       12        14         16         18   20
                                                                        Frequency (MHz)


Figure 32-45.ATmega48PA: Minimum Reset Pulse width vs. VCC

                             1600
                             1500
                             1400
                             1300
                             1200
                             1100
           Pulsewidth (ns)




                             1000
                                 900
                                 800
                                 700
                                 600
                                 500
                                 400
                                                                                                                               105°C
                                 300                                                                                            85°C
                                 200
                                                                                                                                25°C
                                                                                                                               -40°C
                                       1.5       2        2.5       3          3.5           4         4.5          5        5.5
                                                                             VCC (V)




 2020 Microchip Technology Inc.                                            Data Sheet Complete                              DS40002061B-page 548
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P


33.    ATmega88PA Typical Characteristics – (TA = -40°C to 105°C)
       The following charts show typical behavior. These figures are not tested during manufacturing. All current
       consumption measurements are performed with all I/O pins configured as inputs and with internal pull-ups enabled. A
       square wave generator with rail-to-rail output is used as clock source.
       All Active- and Idle current consumption measurements are done with all bits in the PRR register set and thus, the
       corresponding I/O modules are turned off. Also the Analog Comparator is disabled during these measurements.
       The power consumption in Power-down mode is independent of clock selection.
       The current consumption is a function of several factors such as: operating voltage, operating frequency, loading of
       I/O pins, switching rate of I/O pins, code executed and ambient temperature. The dominating factors are operating
       voltage and frequency.
       The current drawn from capacitive loaded pins may be estimated (for one pin) as CL*VCC*f where CL = load
       capacitance, VCC = operating voltage and f = average switching frequency of I/O pin.
       The parts are characterized at frequencies higher than test limits. Parts are not ensured to function properly at
       frequencies higher than the ordering code indicates.
       The difference between current consumption in Power-down mode with Watchdog Timer enabled and Power-
       down mode with Watchdog Timer disabled represents the differential current drawn by the Watchdog Timer.




33.1   Active Supply Current

       Figure 33-1. ATmega88PA: Active Supply Current vs. Low Frequency (0.1MHz -1.0MHz)

                              1

                             0.9                                                                                5.5V

                             0.8                                                                                5.0V
                             0.7
                                                                                                                4.5V
                             0.6
                  ICC (mA)




                                                                                                                4.0V
                             0.5

                             0.4                                                                                3.3V
                             0.3                                                                                2.7V
                             0.2                                                                                1.8V
                             0.1

                              0
                                   0   0.1   0.2   0.3   0.4      0.5      0.6       0.7   0.8     0.9      1
                                                           Frequency (MHz)




        2020 Microchip Technology Inc.                        Data Sheet Complete                       DS40002061B-page 549
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-2. ATmega88PA: Active Supply Current vs. Frequency (1MHz - 20MHz)

                          12


                          10
                                                                                                                                     5.5V

                                                                                                                                     5.0V
                           8
                                                                                                                                     4.5V
               ICC (mA)




                           6
                                                                                                                   4.0V
                           4
                                                                                                3.3V
                                                                                2.7V
                           2

                                                  1.8V
                           0
                                0     2       4          6       8         10          12          14         16         18     20
                                                                     Frequency (MHz)



Figure 33-3. ATmega88PA: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                     0.14
                                                                                                                                     105°C
                     0.12
                                                                                                                                     -40°C
                                                                                                                                      25°C
                          0.1
                                                                                                                                     85°C
                     0.08
         ICC (mA)




                     0.06


                     0.04


                     0.02


                           0
                                1.5       2        2.5       3             3.5              4           4.5          5         5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                       Data Sheet Complete                                    DS40002061B-page 550
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-4. ATmega88PA: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                       1.4

                                                                                           105°C
                       1.2
                                                                                            85°C
                            1
                                                                                            25°C
                                                                                           -40°C
                       0.8
           ICC (mA)




                       0.6


                       0.4


                       0.2


                            0
                                1.5   2   2.5      3      3.5         4      4.5    5    5.5
                                                        VCC (V)




Figure 33-5. ATmega88PA: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                            6

                                                                                           105°C
                            5                                                               85°C
                                                                                            25°C
                                                                                           -40°C
                            4
                 ICC (mA)




                            3


                            2


                            1


                            0
                                1.5   2   2.5      3      3.5        4       4.5    5    5.5
                                                        VCC (V)




 2020 Microchip Technology Inc.                       Data Sheet Complete              DS40002061B-page 551
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

33.2   Idle Supply Current

       Figure 33-6. ATmega88PA: Idle Supply Current vs. Low Frequency (0.1MHz -1.0MHz)


                              0.14


                              0.12
                                                                                                                       5.5V

                               0.1                                                                                     5.0V

                                                                                                                       4.5V
                              0.08
                ICC (mA)




                                                                                                                       4.0V
                              0.06
                                                                                                                       3.3V
                              0.04                                                                                     2.7V
                                                                                                                       1.8V
                              0.02


                                0
                                     0   0.1   0.2        0.3   0.4       0.5      0.6      0.7   0.8      0.9     1
                                                                    Frequency (MHz)



       Figure 33-7. ATmega88PA: Idle Supply Current vs. Frequency (1MHz - 20MHz)

                              2.5


                                                                                                                       5.5V
                                2
                                                                                                                       5.0V

                              1.5                                                                                      4.5V
                   ICC (mA)




                                                                                                        4.0V
                                1


                                                                                         3.3V
                              0.5
                                                                            2.7V

                                                   1.8V
                                0
                                     0   2     4          6     8         10       12       14    16       18     20
                                                                    Frequency (MHz)




        2020 Microchip Technology Inc.                               Data Sheet Complete                        DS40002061B-page 552
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-8. ATmega88PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                        0.05

                       0.045

                        0.04
                                                                                               105°C

                       0.035
                                                                                                   85°C
                        0.03
        ICC (mA)




                       0.025                                                                        25°C
                                                                                                   -40°C
                        0.02

                       0.015

                        0.01

                       0.005

                          0
                               1.5   2   2.5      3      3.5         4      4.5         5    5.5
                                                       VCC (V)



Figure 33-9. ATmega88PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                         0.4

                        0.35
                                                                                               105°C
                                                                                                   85°C
                         0.3
                                                                                                   25°C
                        0.25                                                                       -40°C
            ICC (mA)




                         0.2

                        0.15

                         0.1

                        0.05

                          0
                               1.5   2   2.5      3      3.5         4      4.5         5    5.5
                                                       VCC (V)




 2020 Microchip Technology Inc.                      Data Sheet Complete                   DS40002061B-page 553
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 33-10.ATmega88PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                             1.2
                                                                                                    105°C
                                                                                                     85°C
                                   1
                                                                                                     25°C
                                                                                                        -40°C
                             0.8
                 ICC (mA)




                             0.6


                             0.4


                             0.2


                                   0
                                       1.5   2   2.5      3      3.5        4       4.5      5    5.5
                                                               VCC (V)




33.3   Power-down Supply Current

       Figure 33-11.ATmega88PA: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                                   5


                                                                                                    105°C
                                   4



                                   3
                        ICC (μA)




                                   2

                                                                                                        85°C
                                   1

                                                                                                         25°C
                                   0                                                                    -40°C
                                       1.5   2   2.5      3      3.5        4       4.5      5    5.5
                                                               VCC (V)




        2020 Microchip Technology Inc.                       Data Sheet Complete                DS40002061B-page 554
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 33-12.ATmega88PA: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                              12


                              10
                                                                                            105°C
                                  8
                                                                                             -40°C
                  ICC (μA)




                                  6
                                                                                                         25°C
                                  4

                                                85°C
                                  2


                                  0
                                      1.5   2      2.5      3      3.5         4      4.5            5          5.5
                                                                 VCC (V)




33.4   Power-save Supply Current

       Figure 33-13.ATmega88PA: Power-Save Supply Current vs. VCC
                   (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)

                                  6




                                                                                                                  105°C
                                  4
                       ICC (μA)




                                                                                                                      85°C
                                  2

                                                                                                                   25°C
                                                                                                                  -40°C

                                  0
                                      1.5   2      2.5      3      3.5         4      4.5            5          5.5
                                                                 VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete                         DS40002061B-page 555
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

33.5   Pin Pull-Up

       Figure 33-14.ATmega88PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)

                              60


                              50


                              40
                   IOP (μA)




                              30


                              20
                                                                                                                              25°C

                              10
                                                                                                                             -40°C
                                                                                                                              85°C
                               0                                                                                             105°C
                                   0   0.2         0.4   0.6       0.8       1       1.2       1.4   1.6         1.8     2
                                                                          VOP (V)



       Figure 33-15.ATmega88PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)

                              80

                              70

                              60

                              50
                  IOP (μA)




                              40

                              30

                              20                                                                                             25°C
                                                                                                                             -40°C
                              10
                                                                                                                              85°C
                               0
                                                                                                                             105°C
                                   0         0.5               1            1.5            2               2.5           3
                                                                          VOP (V)




        2020 Microchip Technology Inc.                                  Data Sheet Complete                           DS40002061B-page 556
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-16.ATmega88PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)

                           160

                           140

                           120

                           100
          IOP (μA)




                            80

                            60

                                                                                                                         25°C
                            40
                                                                                                                        -40°C
                            20                                                                                           85°C
                                                                                                                        105°C
                             0
                                 0         1               2             3              4               5           6
                                                                      VOP (V)



Figure 33-17.ATmega88PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)

                           40

                           35

                           30

                           25
             IRESET (μA)




                           20

                           15

                           10                                                                                            25°C
                                                                                                                        -40°C
                            5                                                                                            85°C
                                                                                                                        105°C
                            0
                                 0   0.2       0.4   0.6       0.8       1        1.2       1.4   1.6       1.8     2
                                                                     VRESET (V)




 2020 Microchip Technology Inc.                                     Data Sheet Complete                          DS40002061B-page 557
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-18.ATmega88PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7V)

                              60


                              50


                              40
                IRESET (μA)




                              30


                              20
                                                                                                    25°C
                              10                                                                   -40°C
                                                                                                    85°C
                                                                                                   105°C
                               0
                                   0   0.5    1       1.5            2          2.5            3
                                                   VRESET (V)



Figure 33-19.ATmega88PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                          120


                          100


                              80
          IRESET (μA)




                              60


                              40
                                                                                                    25°C
                              20                                                                   -40°C
                                                                                                    85°C
                                                                                                   105°C
                               0
                                   0   1      2        3             4           5             6
                                                   VRESET (V)




 2020 Microchip Technology Inc.                   Data Sheet Complete                       DS40002061B-page 558
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

33.6   Pin Driver Strength

       Figure 33-20.ATmega88PA: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                            1.2


                             1
                                                                                      105°C
                                                                                       85°C
                            0.8

                                                                                          25°C
                  VOL (V)




                            0.6
                                                                                          -40°C
                            0.4


                            0.2


                             0
                                  0       5           10               15            20             25
                                                            IOL (mA)



       Figure 33-21.ATmega88PA: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                            0.7


                            0.6
                                                                            105°C         85°C
                            0.5
                                                                                          25°C
                            0.4
                  VOL (V)




                                                                                      -40°C
                            0.3


                            0.2


                            0.1


                             0
                                  0       5          10                15            20            25
                                                            IOL (mA)




        2020 Microchip Technology Inc.                    Data Sheet Complete                    DS40002061B-page 559
                                       ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-22.ATmega88PA: I/O Pin Output Voltage vs. Source Current (Vcc = 3V)

                     3.5




                      3
           VOH (V)




                     2.5
                                                                                 -40°C
                                                                                  25°C
                      2                                                           85°C
                                                                                 105°C


                     1.5
                           0       5          10               15               20         25
                                                    IOH (mA)



Figure 33-23.ATmega88PA: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                     5.2



                      5



                     4.8
          VOH (V)




                     4.6
                                                                                 -40°C
                                                                                  25°C
                     4.4
                                                                                  85°C
                                                                                 105°C

                     4.2
                           0       5          10               15               20        25
                                                    IOH (mA)




 2020 Microchip Technology Inc.                   Data Sheet Complete                   DS40002061B-page 560
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

33.7   Pin Threshold and Hysteresis

       Figure 33-24.ATmega88PA: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                  3.5
                                                                                                        105°C
                                   3                                                                     85°C
                                                                                                         25°C
                                  2.5
                                                                                                        -40°C
                  Threshold (V)




                                   2


                                  1.5


                                   1


                                  0.5


                                   0
                                        1.5   2   2.5      3      3.5        4       4.5      5       5.5
                                                                VCC (V)



       Figure 33-25.ATmega88PA: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                  2.5
                                                                                                        105°C
                                                                                                         85°C
                                                                                                         25°C
                                   2                                                                    -40°C
                  Threshold (V)




                                  1.5



                                   1



                                  0.5



                                   0
                                        1.5   2   2.5      3      3.5         4      4.5      5       5.5
                                                                VCC (V)




        2020 Microchip Technology Inc.                        Data Sheet Complete                   DS40002061B-page 561
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-26.ATmega88PA: I/O Pin Input Hysteresis vs. VCC

                                   0.7


                                   0.6
                                           -40°C
                                   0.5
           Input Hysteresis (mV)


                                           25°C
                                   0.4
                                           85°C
                                   0.3
                                           105°C
                                   0.2


                                   0.1


                                    0
                                         1.5       2   2.5      3      3.5        4       4.5   5    5.5
                                                                     VCC (V)



Figure 33-27.ATmega88PA: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                   2.5



                                    2
            Threshold (V)




                                   1.5
                                           -40°C
                                           25°C
                                    1      85°C
                                           105°C

                                   0.5



                                    0
                                         1.5       2   2.5      3      3.5        4       4.5   5    5.5
                                                                     VCC (V)




 2020 Microchip Technology Inc.                                    Data Sheet Complete             DS40002061B-page 562
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-28.ATmega88PA: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                    2.5
                                                                                                           105°C
                                                                                                            85°C
                                                                                                            25°C
           Threshold (V)             2                                                                     -40°C


                                    1.5



                                     1



                                    0.5



                                     0
                                          1.5          2   2.5      3      3.5        4       4.5   5    5.5
                                                                         VCC (V)



Figure 33-29.ATmega88PA: Reset Pin Input Hysteresis vs. VCC

                                    0.7


                                    0.6
                                            -40°C
                                    0.5
            Input Hysteresis (mV)




                                    0.4
                                                25°C


                                    0.3
                                                85°C
                                    0.2
                                           105°C
                                    0.1


                                     0
                                          1.5          2   2.5      3      3.5        4       4.5   5    5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                        Data Sheet Complete             DS40002061B-page 563
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

33.8   BOD Threshold

       Figure 33-30.ATmega88PA: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                 1.84

                                 1.83
                                                                          Rising Vcc
                                 1.82

                                 1.81
                 Threshold (V)




                                  1.8

                                 1.79

                                 1.78
                                                                          Falling Vcc
                                 1.77

                                 1.76
                                        -60   -40   -20    0         20        40       60   80   100    120
                                                                   Temperature (°C)



       Figure 33-31.ATmega88PA: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                  2.8
                                                               Rising Vcc
                                 2.78

                                 2.76

                                 2.74
                Threshold (V)




                                 2.72

                                  2.7

                                 2.68
                                                               Falling Vcc
                                 2.66

                                 2.64

                                 2.62

                                  2.6
                                        -60   -40   -20    0         20        40       60   80   100    120
                                                                   Temperature (°C)




        2020 Microchip Technology Inc.                               Data Sheet Complete               DS40002061B-page 564
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 33-32.ATmega88PA: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                  4.5

                                 4.45

                                  4.4
                                                                               Rising Vcc
                                 4.35
                 Threshold (V)



                                  4.3

                                 4.25
                                                                               Falling Vcc
                                  4.2

                                 4.15

                                  4.1

                                 4.05

                                   4
                                        -60   -40    -20        0         20          40          60    80   100      120
                                                                         Temperature (°C)




33.9   Internal Oscillator Speed

       Figure 33-33.ATmega88PA: Watchdog Oscillator Frequency vs. Temperature

                                 116


                                 114


                                 112
                   FRC (kHz)




                                 110


                                 108


                                 106
                                                                                                                   2.7V
                                                                                                                   3.3V
                                                                                                                   4.0V
                                 104
                                                                                                                   5.5V
                                 102
                                        -40    -20         0        20           40          60        80    100      120
                                                                          Temperature (°C)




        2020 Microchip Technology Inc.                                    Data Sheet Complete                       DS40002061B-page 565
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-34.ATmega88PA: Watchdog Oscillator Frequency vs. VCC

                      116


                      114

                                                                                           -40°C
                      112

                                                                                           25°C
          FRC (kHz)




                      110


                      108


                      106
                                                                                           85°C

                      104                                                              105°C

                      102
                             1.5   2   2.5      3      3.5        4       4.5   5    5.5
                                                     VCC (V)



Figure 33-35.ATmega88PA: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                       8.5



                                                                                       105°C
                      8.25                                                              85°C

                                                                                           25°C
         FRC (MHz)




                        8


                                                                                           -40°C
                      7.75




                       7.5
                             1.5   2   2.5      3      3.5         4      4.5   5    5.5
                                                     VCC (V)




 2020 Microchip Technology Inc.                    Data Sheet Complete             DS40002061B-page 566
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-36.ATmega88PA: Calibrated 8MHz RC Oscillator Frequency vs. Temperature


                        8.4

                        8.3
                                                                                                                            5.5V
                                                                                                                            4.0V
                        8.2                                                                                                 3.0V

                                                                                                                            1.8V
                        8.1
           FRC (MHz)




                         8

                        7.9

                        7.8

                        7.7

                        7.6
                              -60        -40        -20         0         20         40          60       80          100          120
                                                                          Temperature (°C)



Figure 33-37.ATmega88PA: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value


                        14
                                                                                                                                     105°C
                        12                                                                                                            85°C
                                                                                                                                      25°C
                        10                                                                                                           -40°C
            FRC (MHz)




                         8


                         6


                         4


                         2


                         0
                              0     16    32   48     64   80       96   112   128   144   160    176   192    208   224    240    256

                                                                         OSCCAL (X1)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                    DS40002061B-page 567
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

33.10 Current Consumption of Peripheral Units

      Figure 33-38.ATmega88PA: ADC Current vs. VCC (AREF = AVCC)

                              350
                                                                                                      -40°C
                              300
                                                                                                   25°C
                                                                                                   85°C
                              250
                                                                                                  105°C
                              200
                ICC (μA)




                              150


                              100


                               50


                                0
                                    1.5       2   2.5      3      3.5         4      4.5   5    5.5
                                                                VCC (V)



      Figure 33-39.ATmega88PA: Analog Comparator Current vs. VCC

                              90

                              80

                              70

                              60
                                          105°C
                   ICC (μA)




                              50

                              40
                                     85°C
                                     25°C
                              30      -40°C

                              20

                              10

                               0
                                    1.5       2   2.5      3      3.5        4       4.5   5    5.5
                                                                VCC (V)




       2020 Microchip Technology Inc.                         Data Sheet Complete             DS40002061B-page 568
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-40.ATmega88PA: AREF External Reference Current vs. VCC

                         160
                                                                                             105°C
                                                                                              85°C
                         140
                                                                                              25°C
                                                                                             -40°C
                         120

                         100
          ICC (μA)




                          80

                          60

                          40

                          20

                           0
                               1.5       2   2.5      3      3.5         4      4.5   5    5.5
                                                           VCC (V)



Figure 33-41.ATmega88PA: Brownout Detector Current vs. VCC

                         30


                         25


                                 105°C
                         20
                                 85°C
              ICC (μA)




                                 25°C
                         15
                                 -40°C

                         10


                          5


                          0
                               1.5       2   2.5      3      3.5         4      4.5   5    5.5
                                                           VCC (V)




 2020 Microchip Technology Inc.                          Data Sheet Complete             DS40002061B-page 569
                                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

     Figure 33-42.ATmega88PA: Programming Current vs. VCC

                               10

                                9

                                8
                                                      -40°C
                                7

                                6
                    ICC (mA)




                                5
                                                                                    25°C
                                4

                                3
                                                                85°C
                                                     105°C
                                2

                                1

                                0
                                     1.5         2            2.5         3             3.5            4         4.5         5       5.5
                                                                                      VCC (V)




33.11 Current Consumption in Reset and Reset Pulsewidth

     Figure 33-43.ATmega88PA: Reset Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                           0.12
                                                                                                                                         5.5V
                               0.1
                                                                                                                                         5.0V
                           0.08
                                                                                                                                         4.5V
                ICC (mA)




                           0.06                                                                                                          4.0V

                                                                                                                                         3.3V
                           0.04


                           0.02                                                                                                          1.8V


                                0
                                      0    0.1          0.2         0.3       0.4       0.5      0.6       0.7         0.8   0.9     1
                                                                                Frequency (MHz)




       2020 Microchip Technology Inc.                                               Data Sheet Complete                           DS40002061B-page 570
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 33-44.ATmega88PA: Reset Supply Current vs. Frequency (1MHz - 20MHz)

                                 2.5



                                   2                                                                                              5.5V

                                                                                                                                  5.0V
                                 1.5
                                                                                                                                  4.5V
                      ICC (mA)




                                                                                                                    4.0V
                                   1


                                                                                                3.3V
                                 0.5
                                                                                    2.7V

                                   0
                                                         1.8V
                                        0    2       4          6       8         10       12       14         16      18    20
                                                                            Frequency (MHz)



Figure 33-45.ATmega88PA: Minimum Reset Pulse width vs. VCC

                           1800

                           1600

                           1400

                           1200
         Pulsewidth (ns)




                           1000

                                 800

                                 600

                                 400
                                                                                                                                  105°C
                                                                                                                                   85°C
                                 200                                                                                               25°C
                                                                                                                                  -40°C
                                   0
                                       1.5       2        2.5       3             3.5           4        4.5          5      5.5
                                                                                VCC (V)




 2020 Microchip Technology Inc.                                              Data Sheet Complete                           DS40002061B-page 571
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P


34.    ATmega168PA Typical Characteristics – (TA = -40°C to 105°C)
       The following charts show typical behavior. These figures are not tested during manufacturing. All current con-
       sumption measurements are performed with all I/O pins configured as inputs and with internal pull-ups enabled.
       A sine wave generator with rail-to-rail output is used as clock source.
       The power consumption in Power-down mode is independent of clock selection.
       The current consumption is a function of several factors such as: operating voltage, operating frequency, load-
       ing of I/O pins, switching rate of I/O pins, code executed and ambient temperature. The dominating factors are
       operating voltage and frequency.
       The current drawn from capacitive loaded pins may be estimated (for one pin) as CL*VCC*f where CL = load
       capacitance, VCC = operating voltage and f = average switching frequency of I/O pin.
       The parts are characterized at frequencies higher than test limits. Parts are not ensured to function properly at
       frequencies higher than the ordering code indicates.
       The difference between current consumption in Power-down mode with Watchdog Timer enabled and Power-
       down mode with Watchdog Timer disabled represents the differential current drawn by the Watchdog Timer.

34.1   Active Supply Current

       Figure 34-1. ATmega168PA: Active Supply Current vs. Low Frequency (0.1MHz -1.0MHz)

                                   1
                                                                                                             5.5V
                                  0.9

                                  0.8                                                                        5.0V
                                  0.7
                                                                                                             4.5V
                                  0.6
                                                                                                             4.0V
                       ICC (mA)




                                  0.5

                                  0.4
                                                                                                             3.3V

                                  0.3                                                                        2.7V
                                  0.2                                                                        1.8V
                                  0.1

                                   0
                                        0   0.1   0.2    0.3   0.4      0.5     0.6    0.7   0.8   0.9   1
                                                                Frequency (MHz)




        2020 Microchip Technology Inc.                              Data Sheet Complete                     DS40002061B-page 572
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-2. ATmega168PA: Active Supply Current vs. Frequency (1MHz - 20MHz)

                                12

                                                                                                                             5.5V
                                10
                                                                                                                             5.0V
                                 8                                                                                           4.5V
                     ICC (mA)

                                 6
                                                                                                            4.0V
                                 4
                                                                                                 3.6V


                                 2
                                                                               2.7V

                                                    1.8V
                                 0
                                      0     2       4         6       8      10       12    14         16         18   20
                                                                      Frequency (MHz)



Figure 34-3. ATmega168PA: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                          0.14
                                                                                                                         105°C
                                                                                                                         -40°C
                          0.12                                                                                            85°C
                                                                                                                          25°C
                                0.1
               ICC (mA)




                          0.08


                          0.06


                          0.04


                          0.02
                                      1.5       2       2.5       3          3.5        4        4.5          5        5.5
                                                                           VCC (V)




 2020 Microchip Technology Inc.                                          Data Sheet Complete                                DS40002061B-page 573
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-4. ATmega168PA: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                           1.2
                                                                                           105°C
                           1.1                                                              85°C
                            1                                                               25°C
                                                                                           -40°C
                           0.9

                           0.8
                ICC (mA)


                           0.7

                           0.6

                           0.5

                           0.4

                           0.3

                           0.2
                                 1.5   2   2.5   3      3.5       4        4.5   5       5.5
                                                      VCC (V)


Figure 34-5. ATmega168PA: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                           5.5
                                                                                           105°C
                            5                                                               85°C
                                                                                            25°C
                           4.5
                                                                                           -40°C
                            4

                           3.5
                ICC (mA)




                            3

                           2.5

                            2

                           1.5

                            1

                           0.5
                                 1.5   2   2.5   3      3.5       4        4.5   5       5.5
                                                      VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete                       DS40002061B-page 574
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

34.2   Idle Supply Current

       Figure 34-6. ATmega168PA: Idle Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                  0.16
                                                                                                                             5.5V
                                  0.14

                                  0.12
                                                                                                                             5.0V

                                      0.1                                                                                    4.5V
                      ICC (mA)




                                  0.08                                                                                       4.0V
                                                                                                                             3.6V
                                  0.06
                                                                                                                             2.7V
                                  0.04
                                                                                                                             1.8V
                                  0.02

                                       0
                                            0   0.1   0.2         0.3   0.4      0.5    0.6     0.7        0.8     0.9   1
                                                                         Frequency (MHz)


       Figure 34-7. ATmega168PA: Idle Supply Current vs. Frequency (1MHz - 20MHz)

                                      2.7                                                                                     5.5V
                                      2.4
                                                                                                                              5.0V
                                      2.1
                                                                                                                              4.5V
                                      1.8
                           ICC (mA)




                                      1.5
                                                                                                                 4.0V
                                      1.2

                                      0.9
                                                                                                         3.6V

                                      0.6
                                                                                    2.7V
                                      0.3
                                                           1.8V
                                       0
                                            0    2     4           6     8       10        12       14      16      18   20
                                                                         Frequency (MHz)




        2020 Microchip Technology Inc.                                       Data Sheet Complete                             DS40002061B-page 575
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-8. ATmega168PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                            0.045                                                          105°C
                             0.04
                                                                                               85°C
                            0.035

                             0.03
                                                                                                25°C
              ICC (mA)



                            0.025                                                              -40°C
                             0.02

                            0.015

                             0.01

                            0.005
                                    1.5   2   2.5   3      3.5       4        4.5   5    5.5
                                                         VCC (V)


Figure 34-9. ATmega168PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                              0.3                                                          105°C
                                                                                            85°C
                             0.27
                                                                                            25°C
                                                                                           -40°C
                             0.24

                             0.21
                 ICC (mA)




                             0.18

                             0.15

                             0.12

                             0.09

                             0.06
                                    1.5   2   2.5   3      3.5       4        4.5   5    5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                        Data Sheet Complete                    DS40002061B-page 576
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 34-10.ATmega168PA: Idle Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                                  1.3
                                                                                                105°C
                                                                                                 85°C
                                  1.1                                                            25°C
                                                                                                -40°C
                       ICC (mA)   0.9


                                  0.7


                                  0.5


                                  0.3


                                  0.1
                                        1.5   2   2.5   3      3.5       4        4.5   5     5.5
                                                             VCC (V)




34.3   Power-down Supply Current

       Figure 34-11.ATmega168PA: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)

                                  2.4                                                           105°C
                                  2.1

                                  1.8

                                  1.5
                       ICC (μA)




                                  1.2

                                  0.9                                                               85°C
                                  0.6

                                  0.3
                                                                                                     25°C
                                   0                                                                -40°C
                                        1.5   2   2.5   3      3.5       4        4.5   5     5.5
                                                             VCC (V)




        2020 Microchip Technology Inc.                     Data Sheet Complete                     DS40002061B-page 577
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 34-12.ATmega168PA: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                                       9
                                                                                                  105°C

                                       8
                                                                                                      -40°C
                                                                                                       85°C
                                       7                                                               25°C
                           ICC (μA)

                                       6


                                       5


                                       4


                                       3
                                           1.5    2   2.5   3      3.5       4        4.5   5   5.5
                                                                 VCC (V)




34.4   Power-save Supply Current

       Figure 34-13.ATmega168PA: Power-Save Supply Current vs. VCC
                   (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)

                                       4
                                                                                                  105°C
                                      3.5


                                       3


                                      2.5
                       ICC (μA)




                                                                                                      85°C
                                       2


                                      1.5

                                                                                                      -40°C
                                       1                                                               25°C

                                      0.5
                                            1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                                 VCC (V)




        2020 Microchip Technology Inc.                         Data Sheet Complete                   DS40002061B-page 578
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

34.5   Standby Supply Current

       Figure 34-14.ATmega168PA: Standby Supply Current vs. VCC
                   (Watchdog Timer Disabled).

                                        0.15
                                                                                                                          6 MHz_res
                                        0.14                                                                              6 MHz_xtal
                                        0.13
                                        0.12
                                                                                                                          4 MHz_res
                                        0.11                                                                              4 MHz_xtal
                                         0.1
                      ICC (mA)




                                        0.09
                                                                                                                          2 MHz_res
                                        0.08                                                                              2 MHz_xtal
                                        0.07
                                        0.06                                                                              1 MHz_res
                                        0.05
                                        0.04
                                        0.03
                                        0.02
                                               2     2.5         3         3.5              4     4.5         5         5.5

                                                                                 VCC (V)



34.6   Pin Pull-Up

       Figure 34-15.ATmega168PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)

                                         50

                                         45

                                         40

                                         35

                                         30
                             IOP (μA)




                                         25

                                         20

                                         15

                                         10                                                                                      25°C
                                                                                                                                -40°C
                                          5                                                                                      85°C
                                                                                                                                105°C
                                          0
                                               0   0.2     0.4       0.6     0.8            1   1.2     1.4       1.6         1.8
                                                                                  VOP (V)




        2020 Microchip Technology Inc.                                          Data Sheet Complete                                DS40002061B-page 579
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-16.ATmega168PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)
                                80

                                70

                                60

                    IOP (μA)    50

                                40

                                30

                                20                                                                25°C
                                                                                                  85°C
                                10                                                               -40°C
                                                                                                 105°C
                                 0
                                     0   0.5         1          1.5           2        2.5   3
                                                              VOP (V)




Figure 34-17.ATmega168PA: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)

                               140


                               120


                               100


                                80
                IOP (μA)




                                60


                                40
                                                                                                  25°C
                                20                                                                85°C
                                                                                                 -40°C
                                 0                                                               105°C
                                     0         1         2               3         4         5
                                                               VOP (V)




 2020 Microchip Technology Inc.                             Data Sheet Complete                 DS40002061B-page 580
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-18.ATmega168PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage
            (VCC = 1.8V)

                                40

                                35

                                30

                                25
                 IRESET (μA)



                                20

                                15

                                10                                                              25°C
                                                                                               -40°C
                                5
                                                                                                85°C
                                0
                                                                                               105°C
                                     0   0.2   0.4   0.6   0.8       1     1.2   1.4   1.6   1.8
                                                            VRESET (V)


Figure 34-19.ATmega168PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage
            (VCC = 2.7V)

                                60


                                50


                                40
                  IRESET (μA)




                                30


                                20
                                                                                                25°C
                                10                                                             -40°C
                                                                                                85°C
                                 0
                                                                                               105 C
                                     0   0.3   0.6   0.9   1.2      1.5    1.8   2.1   2.4   2.7
                                                            VRESET (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                     DS40002061B-page 581
                                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 34-20.ATmega168PA: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                                        120


                                        100


                       IRESET (μA)             80


                                               60


                                               40
                                                                                                                                            25°C
                                               20                                                                                          -40°C
                                                                                                                                            85°C
                                                0
                                                                                                                                           105°C
                                                    0       0.5   1        1.5   2          2.5       3        3.5    4        4.5    5
                                                                                         VRESET (V)




34.7   Pin Driver Strength

       Figure 34-21.ATmega168PA: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                                                    1
                                                                                                                                           105°C
                                               0.9
                                                                                                                                            85°C
                                               0.8

                                               0.7
                                                                                                                                               25°C
                                               0.6
                                     VOL (V)




                                                                                                                                               -40°C
                                               0.5

                                               0.4

                                               0.3

                                               0.2

                                               0.1

                                                    0
                                                        0     2       4      6       8        10          12     14       16     18       20
                                                                                           IOL (mA)




        2020 Microchip Technology Inc.                                                  Data Sheet Complete                               DS40002061B-page 582
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-22.ATmega168PA: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                           0.6                                                                  105°C
                                                                                                 85°C
                           0.5
                                                                                                    25°C
                VOL (V)    0.4                                                                      -40°C

                           0.3


                           0.2


                           0.1


                            0
                                 0   2   4       6   8      10       12    14        16   18   20
                                                          IOL (mA)



Figure 34-23.ATmega168PA: I/O Pin Output Voltage vs. Source Current (VCC = 3V)

                           3.1

                           2.9


                           2.7


                           2.5
                 VOH (V)




                           2.3
                                                                                                    -40°C

                                                                                                    25°C
                           2.1
                                                                                                 85°C
                           1.9                                                                  105°C

                           1.7
                                 0           5              10                  15             20
                                                          IOH (mA)




 2020 Microchip Technology Inc.                         Data Sheet Complete                        DS40002061B-page 583
                                                        ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 34-24.ATmega168PA: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                                          5


                                        4.9


                                        4.8


                                        4.7
                           VOH (V)



                                        4.6
                                                                                                             -40°C
                                        4.5
                                                                                                             25°C
                                        4.4                                                                  85°C
                                                                                                            105°C
                                        4.3
                                               0         5            10                 15            20
                                                                    IOH (mA)




34.8   Pin Threshold and Hysteresis

       Figure 34-25.ATmega168PA: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                         3
                                                                                                            105°C
                                        2.8                                                                  85°C
                                        2.6                                                                  25°C
                                        2.4
                                                                                                            -40°C
                        Threshold (V)




                                        2.2

                                         2

                                        1.8

                                        1.6

                                        1.4

                                        1.2

                                         1
                                              1.5   2   2.5   3      3.5       4        4.5   5       5.5
                                                                   VCC (V)




        2020 Microchip Technology Inc.                           Data Sheet Complete                       DS40002061B-page 584
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-26.ATmega168PA: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                       2.5                                                                      105°C
                                                                                                                 85°C
                                                                                                                 25°C
                                         2                                                                      -40°C

                       Threshold (V)
                                       1.5



                                         1



                                       0.5



                                         0
                                             1.5            2   2.5   3      3.5       4        4.5   5   5.5
                                                                           VCC (V)

Figure 34-27.ATmega168PA: I/O Pin Input Hysteresis vs. VCC

                                        0.6                                                                  85°C
                                                    -40°C                                                   105°C
                                       0.55


                                        0.5
                Input Hysteresis (V)




                                                    25°C
                                       0.45


                                        0.4


                                       0.35


                                        0.3


                                       0.25
                                              1.5           2   2.5   3      3.5       4        4.5   5   5.5
                                                                           VCC (V)




 2020 Microchip Technology Inc.                                          Data Sheet Complete                   DS40002061B-page 585
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-28.ATmega168PA: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)
                                 1.5
                                                                                              -40°C
                                 1.4                                                           25°C
                                                                                               85°C
                                 1.3                                                          105°C
                                 1.2
                 Threshold (V)
                                 1.1

                                  1

                                 0.9

                                 0.8

                                 0.7

                                 0.6
                                       1.5   2   2.5   3      3.5       4        4.5   5     5.5
                                                            VCC (V)




Figure 34-29.ATmega168PA: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                 2.5                                                           105°C
                                                                                                85°C
                                 2.3                                                            25°C
                                 2.1
                                                                                               -40°C

                                 1.9
                 Threshold (V)




                                 1.7

                                 1.5

                                 1.3

                                 1.1

                                 0.9

                                 0.7

                                 0.5
                                       1.5   2   2.5   3      3.5        4       4.5   5     5.5
                                                             VCC (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                     DS40002061B-page 586
                                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 34-30.ATmega168PA: Reset Pin Input Hysteresis vs. VCC

                                                      0.7
                                                                  -40°C
                                                      0.6


                                                      0.5
                               Input Hysteresis (V)
                                                                  25°C
                                                      0.4


                                                      0.3
                                                                  85°C
                                                      0.2
                                                                  105°C
                                                      0.1


                                                       0
                                                            1.5           2          2.5        3           3.5         4        4.5        5       5.5
                                                                                                          VCC (V)




34.9   BOD Threshold

       Figure 34-31.ATmega168PA: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                                 1.83


                                                 1.82
                                                                                                    Rising Vcc
                                                 1.81
                       Threshold (V)




                                                      1.8


                                                 1.79
                                                                                                    Falling Vcc
                                                 1.78


                                                 1.77


                                                 1.76
                                                            -40    -30   -20   -10     0   10       20    30      40   50   60   70    80   90   100 110
                                                                                                     Temperature (°C)




        2020 Microchip Technology Inc.                                                                  Data Sheet Complete                              DS40002061B-page 587
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-32.ATmega168PA: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                2.76


                                2.74

                                                                         Rising Vcc
                Threshold (V)   2.72


                                 2.7


                                2.68
                                                                         Falling Vcc
                                2.66


                                2.64


                                2.62
                                       -40   -30   -20   -10   0   10   20    30   40   50   60    70   80   90   100 110
                                                                         Temperature (°C)



Figure 34-33.ATmega168PA: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                4.32


                                 4.3
                                                                        Rising Vcc


                                4.28
                Threshold (V)




                                4.26


                                4.24

                                                                        Falling Vcc
                                4.22


                                 4.2
                                       -40   -30   -20   -10   0   10   20    30   40   50   60    70   80   90   100 110
                                                                         Temperature (°C)




 2020 Microchip Technology Inc.                                             Data Sheet Complete                            DS40002061B-page 588
                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-34.ATmega168PA: Calibrated Bandgap Voltage vs. Vcc

                                          1.136

                                          1.134

                                          1.132

                    Bandgap Voltage (V)    1.13

                                          1.128                                                                 85°C
                                          1.126
                                                                                                               105°C
                                                                                                                25°C
                                          1.124

                                          1.122

                                           1.12

                                          1.118
                                                                                                                   -40°C
                                          1.116
                                                  1.5    2    2.5   3          3.5          4     4.5   5    5.5
                                                                             Vcc (V)



Figure 34-35.ATmega168PA: Calibrated Bandgap Voltage vs. Temperature

                                          1.136
                                                                                                               1.8V
                                          1.134                                                                2.7V
                                          1.132
                                                                                                               3.3V
                                                                                                               4.0V
                                                                                                               4.5V
              Bandgap Voltage (V)




                                           1.13

                                          1.128

                                          1.126                                                                5.5V
                                          1.124

                                          1.122

                                           1.12

                                          1.118

                                          1.116
                                                  -50   -30   -10   10         30           50    70    90   110
                                                                         Temperature (°C)




 2020 Microchip Technology Inc.                                            Data Sheet Complete                    DS40002061B-page 589
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

34.10 Internal Oscillator Speed

      Figure 34-36.ATmega168PA: Watchdog Oscillator Frequency vs. Temperature

                                  122


                                  120

                                  118
                      FRC (kHz)




                                  116


                                  114

                                                                                                                                    2.7V
                                  112                                                                                               3.3V
                                                                                                                                    4.0V
                                  110                                                                                               4.5V
                                                                                                                                    5.5V
                                                                                                                                    5.0V
                                  108
                                        -40   -30   -20   -10   0    10   20     30   40      50   60      70   80       90   100
                                                                           Temperature (°C)




      Figure 34-37.ATmega168PA: Watchdog Oscillator Frequency vs. VCC

                                  122


                                  120

                                                                                                                                    -40°C
                                  118

                                                                                                                                      25°C
                      FRC (kHz)




                                  116


                                  114


                                  112
                                                                                                                                      85°C
                                  110
                                                                                                                                    105°C
                                  108
                                        2           2.5          3        3.5             4          4.5             5          5.5
                                                                                VCC (V)




       2020 Microchip Technology Inc.                                         Data Sheet Complete                                    DS40002061B-page 590
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-38.ATmega168PA: Calibrated 8MHz RC Oscillator Frequency vs. VCC

                             8.5

                             8.4

                             8.3                                                                                             105°C
                             8.2
                                                                                                                              85°C

                             8.1
                FRC (MHz)

                                                                                                                                 25°C
                              8

                             7.9

                             7.8
                                                                                                                                 -40°C
                             7.7

                             7.6

                             7.5
                                   2           2.5             3         3.5             4             4.5        5        5.5
                                                                               VCC (V)




Figure 34-39.ATmega168PA: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                             8.4
                                                                                                                             5.5V
                             8.3                                                                                             4.5V
                                                                                                                             4.0V
                             8.2                                                                                             3.3V
                                                                                                                             1.8V
                             8.1
                 FRC (MHz)




                              8

                             7.9

                             7.8

                             7.7

                             7.6

                             7.5
                                   -40   -30   -20   -10   0       10   20     30   40       50   60    70   80   90   100 110
                                                                             Temperature (°C)




 2020 Microchip Technology Inc.                                             Data Sheet Complete                                 DS40002061B-page 591
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 34-40.ATmega168PA: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                                     14
                                                                                                                      105°C
                                                                                                                       85°C
                                     12                                                                                25°C
                                                                                                                      -40°C

                         FRC (MHz)   10


                                      8


                                      6


                                      4


                                      2
                                           0     16   32   48   64    80   96 112 128 144 160 176 192 208 224 240 256
                                                                               OSCCAL (X1)




34.11 Current Consumption of Peripheral Units

      Figure 34-41.ATmega168PA: ADC Current vs. VCC (AREF = AVCC)

                                     325
                                                                                                                  -40°C
                                     300                                                                           25°C
                                                                                                                   85°C
                                     275
                                                                                                                  105°C
                                     250
                      ICC (μA)




                                     225

                                     200

                                     175

                                     150

                                     125

                                     100
                                           1.5        2         2.5        3      3.5        4        4.5   5   5.5
                                                                                VCC (V)




       2020 Microchip Technology Inc.                                          Data Sheet Complete                     DS40002061B-page 592
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-42.ATmega168PA: Analog Comparator Current vs. VCC

                                90
                                                                                           -40°C
                                80                                                         105°C
                                                                                            25°C
                                                                                            85°C
                    ICC (μA)    70


                                60


                                50


                                40


                                30
                                     1.5   2   2.5   3      3.5        4       4.5   5   5.5
                                                          VCC (V)


Figure 34-43.ATmega168PA: AREF External Reference Current vs. VCC

                               180
                                                                                            25°C
                               160                                                          85°C
                                                                                           105°C
                               140
                                                                                           -40°C

                               120
                ICC (μA)




                               100


                                80


                                60


                                40
                                     1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                         Data Sheet Complete                   DS40002061B-page 593
                                             ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-44.ATmega168PA: Brownout Detector Current vs. VCC

                              28


                              26                                                             105°C

                              24                                                              85°C
                                                                                              25°C
                              22
                 ICC (μA)

                                                                                             -40°C
                              20


                              18


                              16


                              14
                                   1.5   2   2.5   3       3.5       4       4.5   5   5.5
                                                         VCC (V)



Figure 34-45.ATmega168PA: Programming Current vs. VCC

                              9

                              8
                                                                                         -40°C
                                                                                          25°C
                              7
                                                                                        105°C
                              6                                                          85°C
                   ICC (mA)




                              5

                              4

                              3

                              2

                              1
                                  1.5    2   2.5   3      3.5        4       4.5   5   5.5
                                                        VCC (V)




 2020 Microchip Technology Inc.                       Data Sheet Complete                   DS40002061B-page 594
                                                            ATmega48A/PA/88A/PA/168A/PA/328/P

34.12 Current Consumption in Reset and Reset Pulsewidth

     Figure 34-46.ATmega168PA: Reset Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                    0.12
                                                                                                                                       5.5V
                                     0.1


                                    0.08
                                                                                                                                       4.5V
                     ICC (mA)




                                    0.06                                                                                               4.0V

                                    0.04
                                                                                                                                       3.3V
                                                                                                                                       2.7V
                                    0.02                                                                                               1.8V

                                      0
                                           0.1   0.2   0.3            0.4       0.5        0.6        0.7          0.8      0.9   1
                                                                            Frequency (MHz)



     Figure 34-47.ATmega168PA: Reset Supply Current vs. Frequency (1MHz - 20MHz)

                                     2.4

                                     2.1
                                                                                                                                       5.5V

                                     1.8                                                                                               5.0V

                                     1.5
                                                                                                                                       4.5V
                         ICC (mA)




                                     1.2
                                                                                                                          4.0V
                                     0.9
                                                                                                                 3.6V
                                     0.6
                                                                                       2.7V
                                     0.3

                                      0
                                                           1.8V
                                           0     2     4          6         8         10         12         14       16      18   20
                                                                            Frequency (MHz)




       2020 Microchip Technology Inc.                                          Data Sheet Complete                                    DS40002061B-page 595
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 34-48.ATmega168PA: Minimum Reset Pulse Width vs. Vcc

                                 1800

                                 1600

                                 1400

                                 1200
               Pulsewidth (ns)


                                 1000

                                 800

                                 600
                                                                                              105°C
                                 400
                                                                                               85°C
                                 200                                                           25°C
                                                                                              -40°C
                                   0
                                        1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                             VCC (V)




 2020 Microchip Technology Inc.                            Data Sheet Complete                   DS40002061B-page 596
                                                      ATmega48A/PA/88A/PA/168A/PA/328/P


35.    ATmega328P Typical Characteristics – (TA = -40°C to 105°C)
       The following charts show typical behavior. These figures are not tested during manufacturing. All current con-
       sumption measurements are performed with all I/O pins configured as inputs and with internal pull-ups enabled.
       A sine wave generator with rail-to-rail output is used as clock source.
       The power consumption in Power-down mode is independent of clock selection.
       The current consumption is a function of several factors such as: operating voltage, operating frequency, load-
       ing of I/O pins, switching rate of I/O pins, code executed and ambient temperature. The dominating factors are
       operating voltage and frequency.
       The current drawn from capacitive loaded pins may be estimated (for one pin) as CL*VCC*f where CL = load
       capacitance, VCC = operating voltage and f = average switching frequency of I/O pin.
       The parts are characterized at frequencies higher than test limits. Parts are not ensured to function properly at
       frequencies higher than the ordering code indicates.
       The difference between current consumption in Power-down mode with Watchdog Timer enabled and Power-
       down mode with Watchdog Timer disabled represents the differential current drawn by the Watchdog Timer.

35.1   ATmega328P Active Supply Current

       Figure 35-1. ATmega328P: Active Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                  1.2

                                                                                                        5.5V
                                   1
                                                                                                        5.0V
                                  0.8                                                                   4.5V
                       ICC (mA)




                                                                                                        4.0V
                                  0.6
                                                                                                        3.6V

                                  0.4                                                                   2.7V

                                                                                                        1.8V
                                  0.2


                                   0
                                        0.1   0.2   0.3   0.4     0.5     0.6     0.7   0.8   0.9   1
                                                                Frequency (MHz)




        2020 Microchip Technology Inc.                           Data Sheet Complete                   DS40002061B-page 597
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-2. ATmega328P: Active Supply Current vs. Frequency (1MHz - 20MHz)

                                14
                                                                                                                              5.5V

                                12                                                                                            5.0V

                                10                                                                                            4.5V

                                 8
                     ICC (mA)


                                                                                                             4.0V
                                 6
                                                                                                  3.6V
                                 4
                                                                                2.7V
                                 2
                                                        1.8V
                                 0
                                       0    2       4          6       8      10       12    14         16         18   20
                                                                       Frequency (MHz)


Figure 35-3. ATmega328P: Active Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                          0.16
                                                                                                                              105°C
                                                                                                                               85°C
                          0.14
                                                                                                                              -40°C
                                                                                                                               25°C
                          0.12

                                0.1
               ICC (mA)




                          0.08

                          0.06

                          0.04

                          0.02

                                 0
                                      1.5       2        2.5       3          3.5        4        4.5          5        5.5
                                                                            VCC (V)




 2020 Microchip Technology Inc.                                           Data Sheet Complete                                DS40002061B-page 598
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-4. ATmega328P: Active Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                            1.4
                                                                                                              105°C
                                                                                                               85°C
                            1.2                                                                                25°C
                                                                                                              -40°C

                ICC (mA)          1


                            0.8


                            0.6


                            0.4


                            0.2
                                      1.5       2       2.5    3         3.5        4        4.5    5       5.5
                                                                       VCC (V)




Figure 35-5. ATmega328P: Active Supply Current vs. VCC (Internal RC Oscillator, 8MHz)

                                      7                                                                           105°C
                                                                                                                   85°C
                                      6                                                                            25°C
                                                                                                                  -40°C
                                      5
                           ICC (mA)




                                      4


                                      3


                                      2


                                      1
                                          1.5       2    2.5       3       3.5          4     4.5       5     5.5
                                                                         VCC (V)




 2020 Microchip Technology Inc.                                       Data Sheet Complete                        DS40002061B-page 599
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

35.2   Idle Supply Current

       Figure 35-6. ATmega328P: Idle Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                       0.2

                                  0.18                                                                                    5.5V
                                  0.16
                                                                                                                          5.0V
                                  0.14
                                                                                                                          4.5V
                                  0.12
                      ICC (mA)




                                                                                                                          4.0V
                                       0.1
                                                                                                                          3.6V
                                  0.08

                                  0.06                                                                                    2.7V
                                  0.04                                                                                    1.8V
                                  0.02

                                        0
                                             0       0.2             0.4             0.6                0.8           1
                                                                      Frequency (MHz)




       Figure 35-7. ATmega328P: Idle Supply Current vs. Frequency (1MHz - 20MHz)

                                       3.5                                                                                 5.5V

                                         3                                                                                 5.0V

                                       2.5                                                                                 4.5V

                                         2
                            ICC (mA)




                                                                                                              4.0V
                                       1.5
                                                                                                      3.6V
                                         1
                                                                                 2.7V
                                       0.5

                                                          1.8V
                                         0
                                             0   2    4          6    8        10       12       14      16      18   20
                                                                      Frequency (MHz)




        2020 Microchip Technology Inc.                                    Data Sheet Complete                             DS40002061B-page 600
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-8. ATmega328P: Idle Supply Current vs. VCC (Internal RC Oscillator, 128kHz)

                             0.05
                                                                                                            105°C
                            0.045
                                                                                                                85°C
                             0.04

                            0.035
                                                                                                                 25°C
              ICC (mA)


                             0.03                                                                               -40°C
                            0.025

                             0.02

                            0.015

                             0.01

                            0.005
                                    1.5   2    2.5       3      3.5         4         4.5       5         5.5
                                                              VCC (V)



Figure 35-9. ATmega328P: Idle Supply Current vs. VCC (Internal RC Oscillator, 1MHz)

                             0.4
                                                                                                            105°C
                                                                                                             85°C
                            0.35
                                                                                                             25°C
                                                                                                            -40°C
                             0.3
                 ICC (mA)




                            0.25


                             0.2


                            0.15


                             0.1
                                   1.5    2   2.5    3       3.5        4       4.5         5       5.5
                                                              VCC (V)




 2020 Microchip Technology Inc.                             Data Sheet Complete                                DS40002061B-page 601
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 35-10.ATmega328P Idle Supply Current vs. Vcc (Internal RC Oscillator, 8MHz)
                                   1.8
                                                                                                                  105°C
                                                                                                                   85°C
                                   1.6
                                                                                                                   25°C
                                   1.4
                                                                                                                  -40°C

                       ICC (mA)    1.2

                                    1

                                   0.8

                                   0.6

                                   0.4

                                   0.2
                                         1.5   2   2.5    3       3.5         4       4.5         5       5.5
                                                                   VCC (V)




35.3   Power-down Supply Current

       Figure 35-11.ATmega328P: Power-Down Supply Current vs. VCC (Watchdog Timer Disabled)
                                     3

                                                                                                                      105°C
                                   2.5


                                     2
                        ICC (μA)




                                   1.5


                                     1                                                                                85°C


                                   0.5

                                                                                                                       25°C
                                     0                                                                                -40°C
                                         1.5   2    2.5       3         3.5       4         4.5       5         5.5
                                                                   VCC (V)




        2020 Microchip Technology Inc.                           Data Sheet Complete                                 DS40002061B-page 602
                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 35-12.ATmega328P: Power-Down Supply Current vs. VCC (Watchdog Timer Enabled)

                                          10
                                                                                                                      105°C
                                           9
                                                                                                                      -40°C
                                           8                                                                           85°C
                                                                                                                       25°C
                                           7
                               ICC (μA)


                                           6

                                           5

                                           4

                                           3

                                           2
                                               1.5       2     2.5    3      3.5       4        4.5         5       5.5
                                                                           VCC (V)




35.4   Power-save Supply Current

       Figure 35-13.ATmega328P: Power-Save Supply Current vs. VCC
                   (Watchdog Timer Disabled and 32kHz Crystal Oscillator Running)

                              4

                             3.5
                                                                                                                             105°C
                              3

                             2.5
                  ICC (μA)




                              2

                             1.5                                                                                                 85°C

                              1
                                                                                                                                  25°C
                             0.5                                                                                                 -40°C

                              0
                                   1.5               2       2.5      3      3.5           4          4.5       5          5.5
                                                                           VCC (V)




        2020 Microchip Technology Inc.                                   Data Sheet Complete                             DS40002061B-page 603
                                                             ATmega48A/PA/88A/PA/168A/PA/328/P

35.5   Standby Supply Current

       Figure 35-14.ATmega328P: Standby Supply Current vs. Vcc (Watchdog Timer Disabled)

                              0.15
                                                                                                                          6 MHz_res
                              0.14                                                                                        6 MHz_xtal
                              0.13
                              0.12
                                                                                                                          4 MHz_res
                              0.11                                                                                        4 MHz_xtal
                                  0.1
                   ICC (mA)




                              0.09
                                                                                                                          2 MHz_res
                              0.08                                                                                        2 MHz_xtal
                              0.07
                              0.06                                                                                        1 MHz_res
                              0.05
                              0.04
                              0.03
                              0.02
                                         2       2.5         3         3.5             4         4.5          5         5.5

                                                                             VCC (V)




35.6   Pin Pull-Up

       Figure 35-15.ATmega328P: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 1.8V)
                                        50
                                        45
                                        40
                                        35
                                        30
                              IOP(µA)




                                        25
                                        20
                                        15
                                                                                                                                   25°C
                                        10
                                                                                                                                  -40°C
                                        5                                                                                          85°C
                                        0                                                                                         105°C
                                             0   0.2   0.4       0.6   0.8        1        1.2    1.4   1.6       1.8         2
                                                                                VOP (V)




        2020 Microchip Technology Inc.                                      Data Sheet Complete                                   DS40002061B-page 604
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-16.ATmega328P: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 2.7V)

                             80

                             70

                             60

                             50
                  IOP (μA)


                             40

                             30

                             20                                                                 25°C
                                                                                                85°C
                             10
                                                                                               -40°C
                              0                                                                105°C
                                   0   0.5         1          1.5           2        2.5   3
                                                            VOP (V)


Figure 35-17.ATmega328P: I/O Pin Pull-up Resistor Current vs. Input Voltage (VCC = 5V)

                             160

                             140

                             120

                             100
                IOP (μA)




                              80

                              60

                              40                                                                25°C
                                                                                                85°C
                              20                                                               105°C
                                                                                               -40°C
                               0
                                   0         1         2              3          4         5
                                                            VOP (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                 DS40002061B-page 605
                                                  ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-18.ATmega328P: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 1.8V)
                                 40

                                 35

                                 30

                 IRESET (μA)     25

                                 20

                                 15

                                 10                                                              25°C
                                                                                                -40°C
                                 5                                                               85°C
                                                                                                105°C
                                 0
                                      0   0.2   0.4   0.6   0.8       1    1.2    1.4   1.6   1.8
                                                             VRESET (V)


Figure 35-19.ATmega328P: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 2.7V)

                                 60


                                 50


                                 40
                   IRESET (μA)




                                 30


                                 20

                                                                                                 25°C
                                 10                                                             -40°C
                                                                                                 85°C
                                                                                                105°C
                                  0
                                      0   0.3   0.6   0.9   1.2      1.5    1.8   2.1   2.4   2.7
                                                             VRESET (V)




 2020 Microchip Technology Inc.                            Data Sheet Complete                     DS40002061B-page 606
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 35-20.ATmega328P: Reset Pull-up Resistor Current vs. Reset Pin Voltage (VCC = 5V)

                                     120


                                     100


                       IRESET (μA)    80


                                      60


                                      40

                                                                                                                   25°C
                                      20                                                                          -40°C
                                                                                                                   85°C
                                                                                                                  105°C
                                       0
                                           0   0.5   1       1.5   2      2.5       3    3.5        4   4.5   5
                                                                       VRESET (V)




35.7   Pin Driver Strength

       Figure 35-21.ATmega328P: I/O Pin Output Voltage vs. Sink Current (VCC = 3V)

                                       1
                                                                                                               105°C
                                     0.9
                                                                                                                85°C
                                     0.8

                                     0.7                                                                           25°C
                                     0.6
                           VOL (V)




                                                                                                                  -40°C
                                     0.5

                                     0.4

                                     0.3

                                     0.2

                                     0.1

                                       0
                                           0             5                 10                  15             20
                                                                        IOL (mA)




        2020 Microchip Technology Inc.                                Data Sheet Complete                         DS40002061B-page 607
                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-22.ATmega328P: I/O Pin Output Voltage vs. Sink Current (VCC = 5V)

                          0.7


                          0.6                                                        105°C
                                                                                      85°C
                          0.5
                                                                                      25°C
                          0.4                                                        -40°C
                VOL (V)



                          0.3


                          0.2


                          0.1


                               0
                                   0       5          10                 15     20
                                                    IOL (mA)


Figure 35-23.ATmega328P: I/O Pin Output Voltage vs. Source Current (Vcc = 3V)

                               3.1


                               2.9


                               2.7
                     VOH (V)




                               2.5

                                                                                      -40°C
                               2.3

                                                                                      25°C
                               2.1

                                                                                      85°C
                               1.9                                                   105°C
                                       0       5        10                15     20
                                                     IOH (mA)




 2020 Microchip Technology Inc.                   Data Sheet Complete               DS40002061B-page 608
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 35-24.ATmega328P: I/O Pin Output Voltage vs. Source Current (VCC = 5V)

                                          5.1

                                           5

                                          4.9

                                          4.8
                       VOH (V)


                                          4.7

                                          4.6
                                                                                                       -40°C
                                          4.5
                                                                                                           25°C
                                          4.4                                                          85°C
                                                                                                      105°C
                                          4.3
                                                0         5            10                 15         20
                                                                    IOH (mA)




35.8   Pin Threshold and Hysteresis

       Figure 35-25.ATmega328P: I/O Pin Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                          3.1
                                                                                                           105°C
                                                                                                            85°C
                                          2.8
                                                                                                            25°C
                                          2.5
                                                                                                           -40°C
                          Threshold (V)




                                          2.2


                                          1.9


                                          1.6


                                          1.3


                                            1
                                                1.5   2   2.5   3      3.5       4        4.5   5    5.5
                                                                     VCC (V)




        2020 Microchip Technology Inc.                             Data Sheet Complete                    DS40002061B-page 609
                                                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-26.ATmega328P: I/O Pin Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’

                                 2.6
                                                                                                                                        105°C
                                 2.3                                                                                                     85°C
                                                    2                                                                                    25°C
                                                                                                                                         -40°C
                Threshold (V)    1.7

                                 1.4

                                 1.1

                                 0.8

                                 0.5

                                 0.2
                                                        1.5         2         2.5         3         3.5         4     4.5     5    5.5
                                                                                                VCC (V)



Figure 35-27.ATmega328P: I/O Pin Input Hysteresis vs. VCC

                                                        0.8


                                                        0.7
                                                                                                                                           -40°C
                                                                                                                                            25°C
                                Input Hysteresis (mV)




                                                        0.6
                                                                                                                                            85°C
                                                                                                                                           105°C
                                                        0.5


                                                        0.4


                                                        0.3


                                                        0.2
                                                              1.8       2.3         2.8       3.3         3.8       4.3     4.8   5.3
                                                                                                     VCC (V)




 2020 Microchip Technology Inc.                                                              Data Sheet Complete                        DS40002061B-page 610
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-28.ATmega328P: Reset Input Threshold Voltage vs. VCC (VIH, I/O Pin read as ‘1’)

                                 2.6
                                                                                                  -40°C
                                 2.4                                                              25°C
                                 2.2                                                              85°C
                                  2                                                           105°C
                 Threshold (V)
                                 1.8

                                 1.6

                                 1.4

                                 1.2

                                  1

                                 0.8
                                       1.5   2   2.5   3      3.5        4       4.5   5    5.5
                                                             VCC (V)



Figure 35-29.ATmega328P: Reset Input Threshold Voltage vs. VCC (VIL, I/O Pin read as ‘0’)

                                 2.5                                                              105°C
                                 2.3                                                               85°C
                                 2.1                                                               25°C
                                 1.9
                                                                                                  -40°C
                 Threshold (V)




                                 1.7

                                 1.5

                                 1.3

                                 1.1

                                 0.9

                                 0.7

                                 0.5
                                       1.5   2   2.5   3      3.5       4        4.5   5    5.5
                                                            VCC (V)




 2020 Microchip Technology Inc.                           Data Sheet Complete                    DS40002061B-page 611
                                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

       Figure 35-30.ATmega328P: Reset Pin Input Hysteresis vs. VCC

                                                       0.7
                                                                   -40°C
                                                       0.6


                                                       0.5
                                Input Hysteresis (V)               25°C
                                                       0.4


                                                       0.3
                                                                   85°C
                                                       0.2
                                                                   105°C
                                                       0.1


                                                         0
                                                             1.5           2   2.5       3          3.5         4          4.5        5     5.5
                                                                                                 VCC (V)




35.9   BOD Threshold

       Figure 35-31.ATmega328P: BOD Thresholds vs. Temperature (BODLEVEL is 1.8V)

                                                  1.84

                                                                                                Rising Vcc
                                                  1.83


                                                  1.82
                       Threshold (V)




                                                  1.81


                                                       1.8

                                                                                                Falling Vcc
                                                  1.79


                                                  1.78
                                                             -50 -40 -30 -20 -10     0   10    20    30    40    50   60    70   80   90 100 110
                                                                                              Temperature (°C)




        2020 Microchip Technology Inc.                                                         Data Sheet Complete                               DS40002061B-page 612
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-32.ATmega328P: BOD Thresholds vs. Temperature (BODLEVEL is 2.7V)

                                2.78
                                2.77
                                                                         Rising Vcc
                                2.76
                                2.75
                Threshold (V)   2.74
                                2.73
                                2.72
                                2.71
                                 2.7
                                                                             Falling Vcc
                                2.69
                                2.68
                                2.67
                                2.66
                                       -40   -30   -20   -10   0   10   20     30   40     50   60   70   80   90   100 110
                                                                         Temperature (°C)


Figure 35-33.ATmega328P: BOD Thresholds vs. Temperature (BODLEVEL is 4.3V)

                                4.38


                                4.36
                                                                              Rising Vcc
                                4.34
                Threshold (V)




                                4.32


                                 4.3


                                4.28


                                4.26
                                                                         Falling Vcc

                                4.24
                                       -40   -30   -20   -10   0   10   20     30   40     50   60   70   80   90   100 110
                                                                         Temperature (°C)




 2020 Microchip Technology Inc.                                             Data Sheet Complete                          DS40002061B-page 613
                                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

      Figure 35-34.ATmega328P: Calibrated Bandgap Voltage vs. Vcc

                                          1.139


                                          1.136

                    Bandgap Voltage (V)                                                                                                                   25°C
                                          1.133


                                                1.13


                                          1.127
                                                                                                                                                       85°C
                                                                                                                                                      -40°C
                                          1.124
                                                                                                                                                      105°C
                                          1.121
                                                       1.5         2           2.5        3            3.5             4        4.5        5        5.5
                                                                                                     Vcc (V)




35.10 Internal Oscillator Speed

      Figure 35-35.ATmega328P: Watchdog Oscillator Frequency vs. Temperature

                                                120


                                                118


                                                116
                                    FRC (kHz)




                                                114


                                                112


                                                110                                                                                                   2.7V
                                                                                                                                                      3.6V
                                                108                                                                                                   4.0V
                                                                                                                                                      5.5V
                                                106
                                                       -40   -30   -20   -10     0   10       20     30      40   50       60   70    80   90   100 110
                                                                                                   Temperature (°C)




       2020 Microchip Technology Inc.                                                             Data Sheet Complete                                    DS40002061B-page 614
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-36.ATmega328P: Watchdog Oscillator Frequency vs. VCC

                              120


                              118
                                                                                       -40°C
                              116

                                                                                           25°C
               FRC (kHz)

                              114


                              112


                              110
                                                                                           85°C
                              108
                                                                                      105°C
                              106
                                    2   2.5    3   3.5             4       4.5   5   5.5
                                                         VCC (V)



Figure 35-37.ATmega328P: Calibrated 8 MHz RC Oscillator Frequency vs. VCC

                              8.6


                              8.4                                                      105°C
                                                                                        85°C
                              8.2
                                                                                           25°C
                  FRC (MHz)




                                8


                              7.8                                                      -40°C

                              7.6


                              7.4
                                    2   2.5    3   3.5             4       4.5   5   5.5
                                                         VCC (V)




 2020 Microchip Technology Inc.                     Data Sheet Complete                   DS40002061B-page 615
                                                           ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-38.ATmega328P: Calibrated 8MHz RC Oscillator Frequency vs. Temperature

                             8.4                                                                                         5.5V
                                                                                                                         5.0V
                             8.3                                                                                         4.5V
                                                                                                                         4.0V
                             8.2
                                                                                                                         3.6V
                                                                                                                         2.7V
                             8.1
                                                                                                                         1.8V
                FRC (MHz)

                              8

                             7.9

                             7.8

                             7.7

                             7.6

                             7.5
                                   -40   -30   -20   -10    0    10    20     30   40   50     60   70   80   90   100 110
                                                                            Temperature (°C)




Figure 35-39.ATmega328P: Calibrated 8MHz RC Oscillator Frequency vs. OSCCAL Value

                             14
                                                                                                                        105°C
                             13                                                                                          85°C
                                                                                                                         25°C
                             12
                                                                                                                        -40°C
                             11

                             10
                 FRC (MHz)




                              9

                              8

                              7

                              6

                              5

                              4
                                   0     16    32    48    64   80    96 112 128 144 160 176 192 208 224 240
                                                                         OSCCAL (X1)




 2020 Microchip Technology Inc.                                            Data Sheet Complete                              DS40002061B-page 616
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

35.11 Current Consumption of Peripheral Units

      Figure 35-40.ATmega328P: ADC Current vs. VCC (AREF = AVCC)

                                   160
                                                                                                85°C
                                                                                               105°C
                                   140                                                          25°C
                                                                                               -40°C
                                   120
                      ICC (μA)




                                   100


                                    80


                                    60


                                    40
                                         1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                              VCC (V)


      Figure 35-41.ATmega328P: Analog Comparator Current vs. VCC

                                   100


                                    90                                                         -40°C

                                    80                                                         25°C
                                                                                               85°C
                                    70
                                                                                              105°C
                        ICC (μA)




                                    60


                                    50


                                    40


                                    30
                                         1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                              VCC (V)




       2020 Microchip Technology Inc.                       Data Sheet Complete                   DS40002061B-page 617
                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-42.ATmega328P: AREF External Reference Current vs. VCC
                               180
                                                                                           85°C
                                                                                          105°C
                               160
                                                                                           25°C
                                                                                          -40°C
                               140


                               120
                ICC (μA)



                               100


                                80


                                60


                                40
                                     1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)


Figure 35-43.ATmega328P: Brownout Detector Current vs. VCC

                                30



                                                                                           105°C
                                25                                                          85°C
                                                                                            25°C
                                                                                           -40°C
                    ICC (μA)




                                20




                                15




                                10
                                     1.5   2   2.5   3      3.5       4        4.5   5   5.5
                                                          VCC (V)




 2020 Microchip Technology Inc.                         Data Sheet Complete                   DS40002061B-page 618
                                                         ATmega48A/PA/88A/PA/168A/PA/328/P

     Figure 35-44.ATmega328P: Programming Current vs. VCC

                                     10

                                      9
                                                                                                                           25°C
                                      8
                                                                                                                           85°C
                                                                                                                          105°C
                                                                                                                          -40°C
                                      7
                          ICC (mA)
                                      6

                                      5

                                      4

                                      3

                                      2

                                      1
                                          1.5     2     2.5         3           3.5         4         4.5     5     5.5
                                                                            VCC (V)




35.12 Current Consumption in Reset and Reset Pulsewidth

     Figure 35-45.ATmega328P: Reset Supply Current vs. Low Frequency (0.1MHz - 1.0MHz)

                                 0.16
                                                                                                                          5.5V
                                 0.14

                                 0.12                                                                                     5.0V

                                     0.1
                                                                                                                          4.5V
                      ICC (mA)




                                                                                                                          4.0V
                                 0.08
                                                                                                                          3.6V
                                 0.06
                                                                                                                          2.7V
                                 0.04
                                                                                                                          1.8V
                                 0.02

                                      0
                                           0.1   0.2   0.3    0.4         0.5         0.6       0.7     0.8   0.9    1
                                                                        Frequency (MHz)




       2020 Microchip Technology Inc.                                    Data Sheet Complete                             DS40002061B-page 619
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

Figure 35-46.ATmega328P Reset Supply Current vs. Frequency (1MHz - 20MHz)

                                        3
                                                                                                                                     5.5V

                                      2.5                                                                                            5.0V

                                                                                                                                     4.5V
                           ICC (mA)     2


                                      1.5
                                                                                                                  4.0V


                                        1
                                                                                                  3.6V


                                      0.5                                             2.7V

                                                              1.8V
                                        0
                                            0     2       4          6       8      10       12       14         16       18   20
                                                                             Frequency (MHz)


Figure 35-47.ATmega328P: Minimum Reset Pulse Width vs. Vcc

                                 1800

                                 1600

                                 1400

                                 1200
               Pulsewidth (ns)




                                 1000

                                      800

                                      600
                                                                                                                                    105°C
                                      400
                                                                                                                                     85°C
                                      200                                                                                            25°C
                                                                                                                                    -40°C
                                       0
                                            1.5       2        2.5       3          3.5           4        4.5        5        5.5
                                                                                  VCC (V)




 2020 Microchip Technology Inc.                                                 Data Sheet Complete                                 DS40002061B-page 620
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

36.        Register Summary
 Address          Name        Bit 7       Bit 6    Bit 5      Bit 4           Bit 3           Bit 2            Bit 1          Bit 0        Page
  (0xFF)         Reserved       –             –      –           –               –               –                –             –
  (0xFE)         Reserved       –             –      –           –               –               –                –             –
  (0xFD)         Reserved       –             –      –           –               –               –                –             –
  (0xFC)         Reserved       –             –      –           –               –               –                –             –
  (0xFB)         Reserved       –             –      –           –               –               –                –             –
  (0xFA)         Reserved       –             –      –           –               –               –                –             –
  (0xF9)         Reserved       –             –      –           –               –               –                –             –
  (0xF8)         Reserved       –             –      –           –               –               –                –             –
  (0xF7)         Reserved       –             –      –           –               –               –                –             –
  (0xF6)         Reserved       –             –      –           –               –               –                –             –
  (0xF5)         Reserved       –             –      –           –               –               –                –             –
  (0xF4)         Reserved       –             –      –           –               –               –                –             –
  (0xF3)         Reserved       –             –      –           –               –               –                –             –
  (0xF2)         Reserved       –             –      –           –               –               –                –             –
  (0xF1)         Reserved       –             –      –           –               –               –                –             –
  (0xF0)         Reserved       –             –      –           –               –               –                –             –
  (0xEF)         Reserved       –             –      –           –               –               –                –             –
  (0xEE)         Reserved       –             –      –           –               –               –                –             –
  (0xED)         Reserved       –             –      –           –               –               –                –             –
  (0xEC)         Reserved       –             –      –           –               –               –                –             –
  (0xEB)         Reserved       –             –      –           –               –               –                –             –
  (0xEA)         Reserved       –             –      –           –               –               –                –             –
  (0xE9)         Reserved       –             –      –           –               –               –                –             –
  (0xE8)         Reserved       –             –      –           –               –               –                –             –
  (0xE7)         Reserved       –             –      –           –               –               –                –             –
  (0xE6)         Reserved       –             –      –           –               –               –                –             –
  (0xE5)         Reserved       –             –      –           –               –               –                –             –
  (0xE4)         Reserved       –             –      –           –               –               –                –             –
  (0xE3)         Reserved       –             –      –           –               –               –                –             –
  (0xE2)         Reserved       –             –      –           –               –               –                –             –
  (0xE1)         Reserved       –             –      –           –               –               –                –             –
  (0xE0)         Reserved       –             –      –           –               –               –                –             –
  (0xDF)         Reserved       –             –      –           –               –               –                –             –
  (0xDE)         Reserved       –             –      –           –               –               –                –             –
  (0xDD)         Reserved       –             –      –           –               –               –                –             –
  (0xDC)         Reserved       –             –      –           –               –               –                –             –
  (0xDB)         Reserved       –             –      –           –               –               –                –             –
  (0xDA)         Reserved       –             –      –           –               –               –                –             –
  (0xD9)         Reserved       –             –      –           –               –               –                –             –
  (0xD8)         Reserved       –             –      –           –               –               –                –             –
  (0xD7)         Reserved       –             –      –           –               –               –                –             –
  (0xD6)         Reserved       –             –      –           –               –               –                –             –
  (0xD5)         Reserved       –             –      –           –               –               –                –             –
  (0xD4)         Reserved       –             –      –           –               –               –                –             –
  (0xD3)         Reserved       –             –      –           –               –               –                –             –
  (0xD2)         Reserved       –             –      –           –               –               –                –             –
  (0xD1)         Reserved       –             –      –           –               –               –                –             –
  (0xD0)         Reserved       –             –      –           –               –               –                –             –
  (0xCF)         Reserved       –             –      –           –               –               –                –             –
  (0xCE)         Reserved       –             –      –           –               –               –                –             –
  (0xCD)         Reserved       –             –      –           –               –               –                –             –
  (0xCC)         Reserved       –             –      –           –               –               –                –             –
  (0xCB)         Reserved       –             –      –           –               –               –                –             –
  (0xCA)         Reserved       –             –      –           –               –               –                –             –
  (0xC9)         Reserved       –             –      –           –               –               –                –             –
  (0xC8)         Reserved       –             –      –           –               –               –                –             –
  (0xC7)         Reserved       –             –      –           –               –               –                –             –
  (0xC6)           UDR0                                        USART I/O Data Register                                                      200
  (0xC5)         UBRR0H                                                                    USART Baud Rate Register High                    204
  (0xC4)          UBRR0L                                    USART Baud Rate Register Low                                                    204
  (0xC3)         Reserved       –             –      –           –               –               –                –             –
  (0xC2)         UCSR0C      UMSEL01     UMSEL00   UPM01      UPM00           USBS0        UCSZ01 /UDORD0   UCSZ00 / UCPHA0   UCPOL0      202/213
  (0xC1)          UCSR0B      RXCIE0      TXCIE0   UDRIE0     RXEN0           TXEN0          UCSZ02            RXB80          TXB80         201
  (0xC0)          UCSR0A       RXC0       TXC0     UDRE0       FE0            DOR0            UPE0              U2X0          MPCM0         200
  (0xBF)         Reserved       –             –      –           –               –               –                –             –
  (0xBE)         Reserved       –             –      –           –               –               –                –             –




            2020 Microchip Technology Inc.                      Data Sheet Complete                                          DS40002061B-page 621
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

Address          Name        Bit 7       Bit 6   Bit 5              Bit 4             Bit 3               Bit 2     Bit 1     Bit 0        Page
 (0xBD)          TWAMR       TWAM6       TWAM5   TWAM4             TWAM3             TWAM2               TWAM1     TWAM0        –           242
 (0xBC)          TWCR        TWINT       TWEA    TWSTA             TWSTO              TWWC                TWEN        –       TWIE          239
 (0xBB)          TWDR                                          2-wire Serial Interface Data Register                                        241
 (0xBA)          TWAR        TWA6        TWA5    TWA4               TWA3              TWA2                TWA1      TWA0     TWGCE          241
 (0xB9)          TWSR        TWS7        TWS6    TWS5               TWS4              TWS3                  –      TWPS1     TWPS0          240
 (0xB8)          TWBR                                        2-wire Serial Interface Bit Rate Register                                      239
 (0xB7)         Reserved       –                   –                  –                  –                  –         –         –
 (0xB6)           ASSR         –         EXCLK    AS2             TCN2UB            OCR2AUB              OCR2BUB   TCR2AUB   TCR2BUB        167
 (0xB5)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xB4)          OCR2B                                     Timer/Counter2 Output Compare Register B                                         166
 (0xB3)          OCR2A                                     Timer/Counter2 Output Compare Register A                                         166
 (0xB2)          TCNT2                                                Timer/Counter2 (8-bit)                                                166
 (0xB1)          TCCR2B      FOC2A       FOC2B     –                  –              WGM22                CS22      CS21      CS20          165
 (0xB0)          TCCR2A     COM2A1      COM2A0   COM2B1           COM2B0                 –                  –      WGM21     WGM20          162
 (0xAF)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xAE)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xAD)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xAC)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xAB)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xAA)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA9)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA8)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA7)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA6)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA5)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA4)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA3)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA2)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA1)         Reserved       –             –     –                  –                  –                  –         –         –
 (0xA0)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x9F)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x9E)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x9D)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x9C)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x9B)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x9A)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x99)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x98)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x97)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x96)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x95)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x94)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x93)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x92)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x91)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x90)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x8F)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x8E)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x8D)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x8C)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x8B)         OCR1BH                             Timer/Counter1 - Output Compare Register B High Byte                                     144
 (0x8A)          OCR1BL                             Timer/Counter1 - Output Compare Register B Low Byte                                     144
 (0x89)         OCR1AH                             Timer/Counter1 - Output Compare Register A High Byte                                     144
 (0x88)          OCR1AL                             Timer/Counter1 - Output Compare Register A Low Byte                                     144
 (0x87)          ICR1H                                  Timer/Counter1 - Input Capture Register High Byte                                   144
 (0x86)           ICR1L                                 Timer/Counter1 - Input Capture Register Low Byte                                    144
 (0x85)          TCNT1H                                   Timer/Counter1 - Counter Register High Byte                                       143
 (0x84)          TCNT1L                                   Timer/Counter1 - Counter Register Low Byte                                        143
 (0x83)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x82)          TCCR1C      FOC1A       FOC1B     –                  –                  –                  –         –         –           143
 (0x81)          TCCR1B      ICNC1       ICES1     –               WGM13             WGM12                CS12      CS11      CS10          142
 (0x80)          TCCR1A     COM1A1      COM1A0   COM1B1           COM1B0                 –                  –      WGM11     WGM10          140
 (0x7F)          DIDR1         –             –     –                  –                  –                  –       AIN1D     AIN0D         245
 (0x7E)          DIDR0         –             –   ADC5D             ADC4D              ADC3D               ADC2D    ADC1D     ADC0D          260
 (0x7D)         Reserved       –             –     –                  –                  –                  –         –         –
 (0x7C)          ADMUX       REFS1       REFS0   ADLAR                –               MUX3                MUX2      MUX1      MUX0          257
 (0x7B)         ADCSRB         –         ACME      –                  –                  –                ADTS2     ADTS1     ADTS0         260
 (0x7A)         ADCSRA       ADEN        ADSC    ADATE              ADIF               ADIE               ADPS2     ADPS1     ADPS0         258




           2020 Microchip Technology Inc.                             Data Sheet Complete                                    DS40002061B-page 622
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

Address           Name        Bit 7       Bit 6      Bit 5             Bit 4              Bit 3           Bit 2      Bit 1      Bit 0        Page
  (0x79)           ADCH                                              ADC Data Register High byte                                              259
  (0x78)           ADCL                                              ADC Data Register Low byte                                               259
  (0x77)         Reserved       –              –       –                 –                  –               –          –          –
  (0x76)         Reserved       –              –       –                 –                  –               –          –          –
  (0x75)         Reserved       –              –       –                 –                  –               –          –          –
  (0x74)         Reserved       –              –       –                 –                  –               –          –          –
  (0x73)         Reserved       –              –       –                 –                  –               –          –          –
  (0x72)         Reserved       –              –       –                 –                  –               –          –          –
  (0x71)         Reserved       –              –       –                 –                  –               –          –          –
  (0x70)          TIMSK2        –              –       –                 –                  –           OCIE2B       OCIE2A     TOIE2         166
  (0x6F)          TIMSK1        –              –     ICIE1               –                  –           OCIE1B       OCIE1A     TOIE1         144
  (0x6E)          TIMSK0        –              –       –                 –                  –           OCIE0B       OCIE0A     TOIE0         118
  (0x6D)          PCMSK2     PCINT23     PCINT22    PCINT21          PCINT20            PCINT19         PCINT18     PCINT17    PCINT16         83
  (0x6C)         PCMSK1         –        PCINT14    PCINT13          PCINT12            PCINT11         PCINT10      PCINT9    PCINT8          83
  (0x6B)         PCMSK0       PCINT7      PCINT6    PCINT5            PCINT4             PCINT3         PCINT2       PCINT1    PCINT0          83
  (0x6A)         Reserved       –              –       –                 –                  –               –          –          –
  (0x69)          EICRA         –              –       –                 –                ISC11           ISC10      ISC01      ISC00          80
  (0x68)          PCICR         –              –       –                 –                  –             PCIE2      PCIE1      PCIE0          82
  (0x67)         Reserved       –              –       –                 –                  –               –          –          –
  (0x66)         OSCCAL                                              Oscillator Calibration Register                                           46
  (0x65)         Reserved       –              –       –                 –                  –               –          –          –
  (0x64)           PRR        PRTWI       PRTIM2    PRTIM0               –               PRTIM1          PRSPI      PRUSART0   PRADC           51
  (0x63)         Reserved       –              –       –                 –                  –               –          –          –
  (0x62)         Reserved       –              –       –                 –                  –               –          –          –
  (0x61)          CLKPR      CLKPCE            –       –                 –               CLKPS3         CLKPS2       CLKPS1    CLKPS0          46
  (0x60)         WDTCSR        WDIF        WDIE      WDP3             WDCE                WDE             WDP2       WDP1       WDP0           63
0x3F (0x5F)        SREG         I              T       H                 S                  V              N           Z         C             19
0x3E (0x5E)        SPH          –              –       –                 –                  –           (SP10) 5.     SP9        SP8           22
0x3D (0x5D)        SPL         SP7            SP6     SP5               SP4                SP3            SP2         SP1        SP0           22
0x3C (0x5C)      Reserved       –              –       –                 –                  –               –          –          –
0x3B (0x5B)      Reserved       –              –       –                 –                  –               –          –          –
0x3A (0x5A)      Reserved       –              –       –                 –                  –               –          –          –
0x39 (0x59)      Reserved       –              –       –                 –                  –               –          –          –
0x38 (0x58)      Reserved       –              –       –                 –                  –               –          –          –
0x37 (0x57)      SPMCSR       SPMIE     (RWWSB)5.    SIGRD         (RWWSRE)5.            BLBSET         PGWRT        PGERS     SPMEN          287
0x36 (0x56)      Reserved       –              –       –                 –                  –               –          –          –
0x35 (0x55)       MCUCR         –         BODS(6)   BODSE(6)            PUD                 –               –        IVSEL      IVCE        54/77/100
0x34 (0x54)       MCUSR         –              –       –                 –               WDRF             BORF       EXTRF      PORF           63
0x33 (0x53)       SMCR          –              –       –                 –                SM2             SM1         SM0        SE            53
0x32 (0x52)      Reserved       –              –       –                 –                  –               –          –          –
0x31 (0x51)      Reserved       –              –       –                 –                  –               –          –          –
0x30 (0x50)        ACSR        ACD        ACBG        ACO               ACI               ACIE            ACIC       ACIS1      ACIS0         244
0x2F (0x4F)      Reserved       –              –       –                 –                  –               –          –          –
0x2E (0x4E)        SPDR                                                      SPI Data Register                                                178
0x2D (0x4D)        SPSR        SPIF       WCOL         –                 –                  –               –          –        SPI2X         177
0x2C (0x4C)        SPCR        SPIE           SPE    DORD              MSTR               CPOL            CPHA        SPR1      SPR0          176
0x2B (0x4B)       GPIOR2                                            General Purpose I/O Register 2                                             35
0x2A (0x4A)       GPIOR1                                            General Purpose I/O Register 1                                             35
0x29 (0x49)      Reserved       –              –       –                 –                  –               –          –          –
0x28 (0x48)       OCR0B                                        Timer/Counter0 Output Compare Register B
0x27 (0x47)       OCR0A                                        Timer/Counter0 Output Compare Register A
0x26 (0x46)       TCNT0                                                  Timer/Counter0 (8-bit)
0x25 (0x45)       TCCR0B      FOC0A       FOC0B        –                 –               WGM02            CS02        CS01      CS00
0x24 (0x44)       TCCR0A     COM0A1      COM0A0     COM0B1           COM0B0                 –               –        WGM01     WGM00
0x23 (0x43)       GTCCR        TSM             –       –                 –                  –               –       PSRASY     PSRSYNC      149/168
0x22 (0x42)       EEARH                                        (EEPROM Address Register High Byte) 5.                                          31
0x21 (0x41)       EEARL                                          EEPROM Address Register Low Byte                                              31
0x20 (0x40)        EEDR                                                EEPROM Data Register                                                    31
0x1F (0x3F)        EECR         –              –    EEPM1             EEPM0              EERIE          EEMPE        EEPE       EERE           31
0x1E (0x3E)       GPIOR0                                            General Purpose I/O Register 0                                             35
0x1D (0x3D)       EIMSK         –              –       –                 –                  –               –         INT1      INT0           81
0x1C (0x3C)        EIFR         –              –       –                 –                  –               –        INTF1      INTF0          81
0x1B (0x3B)       PCIFR         –              –       –                 –                  –             PCIF2      PCIF1      PCIF0
0x1A (0x3A)      Reserved       –              –       –                 –                  –               –          –          –
0x19 (0x39)      Reserved       –              –       –                 –                  –               –          –          –
0x18 (0x38)      Reserved       –              –       –                 –                  –               –          –          –
0x17 (0x37)        TIFR2        –              –       –                 –                  –           OCF2B        OCF2A      TOV2          167
0x16 (0x36)        TIFR1        –              –      ICF1               –                  –           OCF1B        OCF1A      TOV1          145




            2020 Microchip Technology Inc.                               Data Sheet Complete                                   DS40002061B-page 623
                                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

  Address            Name            Bit 7          Bit 6          Bit 5           Bit 4           Bit 3           Bit 2          Bit 1           Bit 0              Page
  0x15 (0x35)         TIFR0            –              –              –                –               –           OCF0B           OCF0A           TOV0
  0x14 (0x34)       Reserved           –              –              –                –               –              –              –               –
  0x13 (0x33)       Reserved           –              –              –                –               –              –              –               –
  0x12 (0x32)       Reserved           –              –              –                –               –              –              –               –
  0x11 (0x31)       Reserved           –              –              –                –               –              –              –               –
  0x10 (0x30)       Reserved           –              –              –                –               –              –              –               –
  0x0F (0x2F)       Reserved           –              –              –                –               –              –              –               –
  0x0E (0x2E)       Reserved           –              –              –                –               –              –              –               –
  0x0D (0x2D)       Reserved           –              –              –                –               –              –              –               –
  0x0C (0x2C)       Reserved           –              –              –                –               –              –              –               –
  0x0B (0x2B)        PORTD         PORTD7         PORTD6          PORTD5          PORTD4          PORTD3         PORTD2          PORTD1          PORTD0               101
  0x0A (0x2A)        DDRD            DDD7           DDD6           DDD5            DDD4            DDD3            DDD2           DDD1            DDD0                101
  0x09 (0x29)         PIND          PIND7           PIND6          PIND5           PIND4           PIND3          PIND2           PIND1           PIND0               101
  0x08 (0x28)        PORTC             –          PORTC6          PORTC5          PORTC4          PORTC3         PORTC2          PORTC1          PORTC0               100
  0x07 (0x27)        DDRC              –            DDC6           DDC5            DDC4            DDC3            DDC2           DDC1            DDC0                100
  0x06 (0x26)         PINC             –            PINC6          PINC5           PINC4           PINC3          PINC2           PINC1           PINC0               101
  0x05 (0x25)        PORTB         PORTB7         PORTB6          PORTB5          PORTB4          PORTB3         PORTB2          PORTB1          PORTB0               100
  0x04 (0x24)         DDRB           DDB7           DDB6           DDB5            DDB4            DDB3            DDB2           DDB1            DDB0                100
  0x03 (0x23)         PINB           PINB7          PINB6          PINB5           PINB4           PINB3           PINB2          PINB1           PINB0               100
  0x02 (0x22)       Reserved           –              –              –                –               –              –              –               –
  0x01 (0x21)       Reserved           –              –              –                –               –              –              –               –
  0x0 (0x20)        Reserved           –              –              –                –               –              –              –               –

Note:     1. For compatibility with future devices, reserved bits should be written to zero if accessed. Reserved I/O memory
             addresses should never be written.
          2.    I/O Registers within the address range 0x00 - 0x1F are directly bit-accessible using the SBI and CBI instructions. In these registers, the value of single bits
                can be checked by using the SBIS and SBIC instructions.
          3.    Some of the Status Flags are cleared by writing a logical one to them. Note that, unlike most other AVRs, the CBI and SBI instructions will only operate on
                the specified bit, and can therefore be used on registers containing such Status Flags. The CBI and SBI instructions work with registers 0x00 to 0x1F only.
          4.    When using the I/O specific commands IN and OUT, the I/O addresses 0x00 - 0x3F must be used. When addressing I/O Registers as data space using LD
                and ST instructions, 0x20 must be added to these addresses. The ATmega48A/PA/88A/PA/168A/PA/328/P is a complex microcontroller with more
                peripheral units than can be supported within the 64 location reserved in Opcode for the IN and OUT instructions. For the Extended I/O space from 0x60 -
                0xFF in SRAM, only the ST/STS/STD and LD/LDS/LDD instructions can be used.
          5.    Only valid for ATmega88A/88PA/168A/168PA/328/328P.
          6.    BODS and BODSE only available for picoPower devices ATmega48PA/88PA/168PA/328P




            2020 Microchip Technology Inc.                                           Data Sheet Complete                                         DS40002061B-page 624
                                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

37.       Instruction Set Summary
 Mnemonics            Operands                                 Description                                   Operation                 Flags   #Clocks
ARITHMETIC AND LOGIC INSTRUCTIONS
ADD              Rd, Rr             Add two Registers                                      Rd  Rd + Rr                          Z,C,N,V,H        1
ADC              Rd, Rr             Add with Carry two Registers                           Rd  Rd + Rr + C                      Z,C,N,V,H        1
ADIW             Rdl,K              Add Immediate to Word                                  Rdh:Rdl  Rdh:Rdl + K                 Z,C,N,V,S        2
SUB              Rd, Rr             Subtract two Registers                                 Rd  Rd - Rr                          Z,C,N,V,H        1
SUBI             Rd, K              Subtract Constant from Register                        Rd  Rd - K                           Z,C,N,V,H        1
SBC              Rd, Rr             Subtract with Carry two Registers                      Rd  Rd - Rr - C                      Z,C,N,V,H        1
SBCI             Rd, K              Subtract with Carry Constant from Reg.                 Rd  Rd - K - C                       Z,C,N,V,H        1
SBIW             Rdl,K              Subtract Immediate from Word                           Rdh:Rdl  Rdh:Rdl - K                 Z,C,N,V,S        2
AND              Rd, Rr             Logical AND Registers                                  Rd Rd  Rr                          Z,N,V            1
ANDI             Rd, K              Logical AND Register and Constant                      Rd  Rd K                           Z,N,V            1
OR               Rd, Rr             Logical OR Registers                                   Rd  Rd v Rr                          Z,N,V            1
ORI              Rd, K              Logical OR Register and Constant                       Rd Rd v K                           Z,N,V            1
EOR              Rd, Rr             Exclusive OR Registers                                 Rd  Rd  Rr                          Z,N,V            1
COM              Rd                 One’s Complement                                       Rd  0xFF  Rd                        Z,C,N,V          1
NEG              Rd                 Two’s Complement                                       Rd  0x00  Rd                        Z,C,N,V,H        1
SBR              Rd,K               Set Bit(s) in Register                                 Rd  Rd v K                           Z,N,V            1
CBR              Rd,K               Clear Bit(s) in Register                               Rd  Rd  (0xFF - K)                  Z,N,V            1
INC              Rd                 Increment                                              Rd  Rd + 1                           Z,N,V            1
DEC              Rd                 Decrement                                              Rd  Rd  1                           Z,N,V            1
TST              Rd                 Test for Zero or Minus                                 Rd  Rd  Rd                          Z,N,V            1
CLR              Rd                 Clear Register                                         Rd  Rd  Rd                          Z,N,V            1
SER              Rd                 Set Register                                           Rd  0xFF                             None             1
MUL              Rd, Rr             Multiply Unsigned                                      R1:R0  Rd x Rr                       Z,C              2
MULS             Rd, Rr             Multiply Signed                                        R1:R0  Rd x Rr                       Z,C              2
MULSU            Rd, Rr             Multiply Signed with Unsigned                          R1:R0  Rd x Rr                       Z,C              2
FMUL             Rd, Rr             Fractional Multiply Unsigned                           R1:R0  (Rd x Rr) << 1                Z,C              2
FMULS            Rd, Rr             Fractional Multiply Signed                             R1:R0  (Rd x Rr) << 1                Z,C              2
FMULSU           Rd, Rr             Fractional Multiply Signed with Unsigned               R1:R0  (Rd x Rr) << 1                Z,C              2
BRANCH INSTRUCTIONS
RJMP             k                  Relative Jump                                          PC PC + k + 1                       None             2
IJMP                                Indirect Jump to (Z)                                   PC  Z                                None             2
JMP(1)           k                  Direct Jump                                            PC k                                None             3
RCALL            k                  Relative Subroutine Call                               PC  PC + k + 1                       None             3
ICALL                               Indirect Call to (Z)                                   PC  Z                                None             3
CALL(1)          k                  Direct Subroutine Call                                 PC  k                                None             4
RET                                 Subroutine Return                                      PC  STACK                            None             4
RETI                                Interrupt Return                                       PC  STACK                            I                4
CPSE             Rd,Rr              Compare, Skip if Equal                                 if (Rd = Rr) PC PC + 2 or 3         None           1/2/3
CP               Rd,Rr              Compare                                                Rd  Rr                               Z, N,V,C,H       1
CPC              Rd,Rr              Compare with Carry                                     Rd  Rr  C                           Z, N,V,C,H       1
CPI              Rd,K               Compare Register with Immediate                        Rd  K                                Z, N,V,C,H       1
SBRC             Rr, b              Skip if Bit in Register Cleared                        if (Rr(b)=0) PC  PC + 2 or 3         None           1/2/3
SBRS             Rr, b              Skip if Bit in Register is Set                         if (Rr(b)=1) PC  PC + 2 or 3         None           1/2/3
SBIC             P, b               Skip if Bit in I/O Register Cleared                    if (P(b)=0) PC  PC + 2 or 3          None           1/2/3
SBIS             P, b               Skip if Bit in I/O Register is Set                     if (P(b)=1) PC  PC + 2 or 3          None           1/2/3
BRBS             s, k               Branch if Status Flag Set                              if (SREG(s) = 1) then PCPC+k + 1     None            1/2
BRBC             s, k               Branch if Status Flag Cleared                          if (SREG(s) = 0) then PCPC+k + 1     None            1/2
BREQ              k                 Branch if Equal                                        if (Z = 1) then PC  PC + k + 1       None            1/2
BRNE              k                 Branch if Not Equal                                    if (Z = 0) then PC  PC + k + 1       None            1/2
BRCS              k                 Branch if Carry Set                                    if (C = 1) then PC  PC + k + 1       None            1/2
BRCC              k                 Branch if Carry Cleared                                if (C = 0) then PC  PC + k + 1       None            1/2
BRSH              k                 Branch if Same or Higher                               if (C = 0) then PC  PC + k + 1       None            1/2
BRLO              k                 Branch if Lower                                        if (C = 1) then PC  PC + k + 1       None            1/2
BRMI              k                 Branch if Minus                                        if (N = 1) then PC  PC + k + 1       None            1/2
BRPL              k                 Branch if Plus                                         if (N = 0) then PC  PC + k + 1       None            1/2
BRGE              k                 Branch if Greater or Equal, Signed                     if (N  V= 0) then PC  PC + k + 1    None            1/2
BRLT              k                 Branch if Less Than Zero, Signed                       if (N  V= 1) then PC  PC + k + 1    None            1/2
BRHS              k                 Branch if Half Carry Flag Set                          if (H = 1) then PC  PC + k + 1       None            1/2
BRHC              k                 Branch if Half Carry Flag Cleared                      if (H = 0) then PC  PC + k + 1       None            1/2
BRTS              k                 Branch if T Flag Set                                   if (T = 1) then PC  PC + k + 1       None            1/2
BRTC              k                 Branch if T Flag Cleared                               if (T = 0) then PC  PC + k + 1       None            1/2
BRVS              k                 Branch if Overflow Flag is Set                         if (V = 1) then PC  PC + k + 1       None            1/2
BRVC              k                 Branch if Overflow Flag is Cleared                     if (V = 0) then PC  PC + k + 1       None            1/2
BRIE              k                 Branch if Interrupt Enabled                            if ( I = 1) then PC  PC + k + 1      None            1/2
BRID              k                 Branch if Interrupt Disabled                           if ( I = 0) then PC  PC + k + 1      None            1/2




           2020 Microchip Technology Inc.                                     Data Sheet Complete                              DS40002061B-page 625
                                                                ATmega48A/PA/88A/PA/168A/PA/328/P

 Mnemonics            Operands                               Description                                Operation                      Flags    #Clocks
BIT AND BIT-TEST INSTRUCTIONS
SBI               P,b            Set Bit in I/O Register                               I/O(P,b)  1                                None            2
CBI               P,b            Clear Bit in I/O Register                             I/O(P,b)  0                                None            2
LSL               Rd             Logical Shift Left                                    Rd(n+1)  Rd(n), Rd(0)  0                  Z,C,N,V         1
LSR               Rd             Logical Shift Right                                   Rd(n)  Rd(n+1), Rd(7)  0                  Z,C,N,V         1
ROL               Rd             Rotate Left Through Carry                             Rd(0)C,Rd(n+1) Rd(n),CRd(7)              Z,C,N,V         1
ROR               Rd             Rotate Right Through Carry                            Rd(7)C,Rd(n) Rd(n+1),CRd(0)              Z,C,N,V         1
ASR               Rd             Arithmetic Shift Right                                Rd(n)  Rd(n+1), n=0...6                    Z,C,N,V         1
SWAP              Rd             Swap Nibbles                                          Rd(3...0)Rd(7...4),Rd(7...4)Rd(3...0)     None            1
BSET              s              Flag Set                                              SREG(s)  1                                 SREG(s)         1
BCLR              s              Flag Clear                                            SREG(s)  0                                 SREG(s)         1
BST               Rr, b          Bit Store from Register to T                          T  Rr(b)                                   T               1
BLD               Rd, b          Bit load from T to Register                           Rd(b)  T                                   None            1
SEC                              Set Carry                                             C1                                         C               1
CLC                              Clear Carry                                           C0                                         C               1
SEN                              Set Negative Flag                                     N1                                         N               1
CLN                              Clear Negative Flag                                   N0                                         N               1
SEZ                              Set Zero Flag                                         Z1                                         Z               1
CLZ                              Clear Zero Flag                                       Z0                                         Z               1
SEI                              Global Interrupt Enable                               I1                                         I               1
CLI                              Global Interrupt Disable                              I 0                                       I               1
SES                              Set Signed Test Flag                                  S1                                         S               1
CLS                              Clear Signed Test Flag                                S0                                         S               1
SEV                              Set Twos Complement Overflow.                         V1                                         V               1
CLV                              Clear Twos Complement Overflow                        V0                                         V               1
SET                              Set T in SREG                                         T1                                         T               1
CLT                              Clear T in SREG                                       T0                                         T               1
SEH                              Set Half Carry Flag in SREG                           H1                                         H               1
CLH                              Clear Half Carry Flag in SREG                         H0                                         H               1
DATA TRANSFER INSTRUCTIONS
MOV               Rd, Rr         Move Between Registers                                Rd  Rr                                     None            1
MOVW              Rd, Rr         Copy Register Word                                    Rd+1:Rd  Rr+1:Rr                           None            1
LDI               Rd, K          Load Immediate                                        Rd  K                                      None            1
LD                Rd, X          Load Indirect                                         Rd  (X)                                    None            2
LD                Rd, X+         Load Indirect and Post-Inc.                           Rd  (X), X  X + 1                         None            2
LD                Rd, - X        Load Indirect and Pre-Dec.                            X  X - 1, Rd  (X)                         None            2
LD                Rd, Y          Load Indirect                                         Rd  (Y)                                    None            2
LD                Rd, Y+         Load Indirect and Post-Inc.                           Rd  (Y), Y  Y + 1                         None            2
LD                Rd, - Y        Load Indirect and Pre-Dec.                            Y  Y - 1, Rd  (Y)                         None            2
LDD               Rd,Y+q         Load Indirect with Displacement                       Rd  (Y + q)                                None            2
LD                Rd, Z          Load Indirect                                         Rd  (Z)                                    None            2
LD                Rd, Z+         Load Indirect and Post-Inc.                           Rd  (Z), Z  Z+1                           None            2
LD                Rd, -Z         Load Indirect and Pre-Dec.                            Z  Z - 1, Rd  (Z)                         None            2
LDD               Rd, Z+q        Load Indirect with Displacement                       Rd  (Z + q)                                None            2
LDS               Rd, k          Load Direct from SRAM                                 Rd  (k)                                    None            2
ST                X, Rr          Store Indirect                                        (X) Rr                                    None            2
ST                X+, Rr         Store Indirect and Post-Inc.                          (X) Rr, X  X + 1                         None            2
ST                - X, Rr        Store Indirect and Pre-Dec.                           X  X - 1, (X)  Rr                         None            2
ST                Y, Rr          Store Indirect                                        (Y)  Rr                                    None            2
ST                Y+, Rr         Store Indirect and Post-Inc.                          (Y)  Rr, Y  Y + 1                         None            2
ST                - Y, Rr        Store Indirect and Pre-Dec.                           Y  Y - 1, (Y)  Rr                         None            2
STD               Y+q,Rr         Store Indirect with Displacement                      (Y + q)  Rr                                None            2
ST                Z, Rr          Store Indirect                                        (Z)  Rr                                    None            2
ST                Z+, Rr         Store Indirect and Post-Inc.                          (Z)  Rr, Z  Z + 1                         None            2
ST                -Z, Rr         Store Indirect and Pre-Dec.                           Z  Z - 1, (Z)  Rr                         None            2
STD               Z+q,Rr         Store Indirect with Displacement                      (Z + q)  Rr                                None            2
STS               k, Rr          Store Direct to SRAM                                  (k)  Rr                                    None            2
LPM                              Load Program Memory                                   R0  (Z)                                    None            3
LPM               Rd, Z          Load Program Memory                                   Rd  (Z)                                    None            3
LPM               Rd, Z+         Load Program Memory and Post-Inc                      Rd  (Z), Z  Z+1                           None            3
SPM                              Store Program Memory                                  (Z)  R1:R0                                 None            -
IN                Rd, P          In Port                                               Rd  P                                      None            1
OUT               P, Rr          Out Port                                              P  Rr                                      None            1
PUSH              Rr             Push Register on Stack                                STACK  Rr                                  None            2
POP               Rd             Pop Register from Stack                               Rd  STACK                                  None            2
MCU CONTROL INSTRUCTIONS
NOP                              No Operation                                                                                      None            1
SLEEP                            Sleep                                                 (see specific descr. for Sleep function)    None            1




          2020 Microchip Technology Inc.                                  Data Sheet Complete                                    DS40002061B-page 626
                                                   ATmega48A/PA/88A/PA/168A/PA/328/P

  Mnemonics       Operands                       Description                               Operation                 Flags     #Clocks
 WDR                            Watchdog Reset                             (see specific descr. for WDR/timer)    None            1
 BREAK                          Break                                      For On-chip Debug Only                 None           N/A

Note:    1. These instructions are only available in ATmega168PA and ATmega328P.




          2020 Microchip Technology Inc.                      Data Sheet Complete                               DS40002061B-page 627
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P


38.        Ordering Information

38.1       ATmega48A
        Speed (MHz)               Power Supply (V)               Ordering Code(2)                           Package(1)                       Operational Range(6)
                                                                 ATmega48A-AU                               32A
                                                                 ATmega48A-AUR(5)                           32A
                                                                 ATmega48A-MMH(4)                           28M1
                                                                                                                                                    Industrial
           20(3)                         1.8 - 5.5               ATmega48A-MMHR(4)(5)                       28M1
                                                                                                                                                 (-40C to 85C)
                                                                 ATmega48A-MU                               32M1-A
                                                                 ATmega48A-MUR(5)                           32M1-A
                                                                 ATmega48A-PU                               28P3
Note:      1.   This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
           2.   Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive). Also Halide free and fully Green.
           3.   See ”Speed Grades” on page 312.
           4.   NiPdAu Lead Finish.
           5.   Tape & Reel.
           6.   Use ”ATmega48PA” on page 629, industrial (-40C to 105C) as the ATmega48A (-40C to 105C) is not presently offered.




                                                                             Package Type
 32A                  32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1                 28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A               32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3                 28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




            2020 Microchip Technology Inc.                                          Data Sheet Complete                                      DS40002061B-page 628
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

38.2    ATmega48PA
   Speed (MHz)(3)               Power Supply (V)               Ordering Code(2)                            Package(1)                        Operational Range
                                                               ATmega48PA-AU                               32A
                                                               ATmega48PA-AUR(5)                           32A
                                                               ATmega48PA-MMH(4)                           28M1
                                                                                                                                                   Industrial
                                                               ATmega48PA-MMHR(4)(5)                       28M1
                                                                                                                                                (-40C to 85C)
                                                               ATmega48PA-MU                               32M1-A
                                                               ATmega48PA-MUR(5)                           32M1-A
                                                               ATmega48PA-PU                               28P3
             20                        1.8 - 5.5
                                                               ATmega48PA-AN                               32A
                                                               ATmega48PA-ANR(5)                           32A
                                                               ATmega48PA-MMN(4)                           28M1
                                                                                                                                                   Industrial
                                                               ATmega48PA-MMNR(4)(5)                       28M1
                                                                                                                                               (-40C to 105C)
                                                               ATmega48PA-MN                               32M1-A
                                                               ATmega48PA-MNR(5)                           32M1-A
                                                               ATmega48PA-PN                               28P3
Note:   1.    This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
        2.    Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive). Also Halide free and fully Green.
        3.    See ”Speed Grades” on page 312.
        4.    NiPdAu Lead Finish.
        5.    Tape & Reel.




                                                                            Package Type
 32A                32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1               28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A             32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3               28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




           2020 Microchip Technology Inc.                                         Data Sheet Complete                                       DS40002061B-page 629
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

38.3       ATmega88A
        Speed (MHz)               Power Supply (V)               Ordering Code(2)                            Package(1)                      Operational Range(6)
                                                                 ATmega88A-AU                                32A
                                                                 ATmega88A-AUR(5)                            32A
                                                                 ATmega88A-MMH(4)                            28M1
                                                                                                                                                     Industrial
           20(3)                         1.8 - 5.5               ATmega88A-MMHR(4)(5)                        28M1
                                                                                                                                                  (-40C to 85C)
                                                                 ATmega88A-MU                                32M1-A
                                                                 ATmega88A-MUR(5)                            32M1-A
                                                                 ATmega88A-PU                                28P3
Note:      1.   This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
           2.   Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive).Also Halide free and fully Green.
           3.   See ”Speed Grades” on page 312.
           4.   NiPdAu Lead Finish.
           5.   Tape & Reel.
           6.   Use ”ATmega88PA” on page 631, industrial (-40C to 105C) as the ATmega48A (-40C to 105C) is not presently offered.




                                                                              Package Type
 32A                  32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1                 28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A               32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3                 28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




            2020 Microchip Technology Inc.                                          Data Sheet Complete                                       DS40002061B-page 630
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

38.4    ATmega88PA
    Speed (MHz)(3)              Power Supply (V)               Ordering Code(2)                            Package(1)                        Operational Range
                                                               ATmega88PA-AU                               32A
                                                               ATmega88PA-AUR(5)                           32A
                                                               ATmega88PA-MMH(4)                           28M1
                                                                                                                                                   Industrial
                                                               ATmega88PA-MMHR(4)(5)                       28M1
                                                                                                                                                (-40C to 85C)
                                                               ATmega88PA-MU                               32M1-A
                                                               ATmega88PA-MUR(5)                           32M1-A
                                                               ATmega88PA-PU                               28P3
             20                        1.8 - 5.5
                                                               ATmega88PA-AN                               32A
                                                               ATmega88PA-ANR(5)                           32A
                                                               ATmega88PA-MMN(4)                           28M1
                                                                                                                                                   Industrial
                                                               ATmega88PA-MMNR(4)(5)                       28M1
                                                                                                                                               (-40C to 105C)
                                                               ATmega88PA-MN                               32M1-A
                                                               ATmega88PA-MNR(5)                           32M1-A
                                                               ATmega88PA-PN                               28P3
Note:   1.    This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
        2.    Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive).Also Halide free and fully Green.
        3.    See ”Speed Grades” on page 312.
        4.    NiPdAu Lead Finish.
        5.    Tape & Reel.




                                                                            Package Type
 32A                32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1               28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A             32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3               28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




           2020 Microchip Technology Inc.                                         Data Sheet Complete                                       DS40002061B-page 631
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

38.5    ATmega168A
    Speed (MHz)(3)              Power Supply (V)               Ordering Code(2)                            Package(1)                      Operational Range(6)
                                                               ATmega168A-AU                               32A
                                                               ATmega168A-AUR(5)                           32A
                                                               ATmega168A-MMH(4)                           28M1
                                                                                                                                                   Industrial
             20                        1.8 - 5.5               ATmega168A-MMHR(4)(5)                       28M1
                                                                                                                                                (-40C to 85C)
                                                               ATmega168A-MU                               32M1-A
                                                               ATmega168A-MUR(5)                           32M1-A
                                                               ATmega168A-PU                               28P3
Note:   1.    This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
        2.    Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive).Also Halide free and fully Green.
        3.    See ”Speed Grades” on page 312
        4.    NiPdAu Lead Finish.
        5.    Tape & Reel.
        6.    Use ”ATmega168PA” on page 633, industrial (-40C to 105C) as the ATmega48A (-40C to 105C) is not presently offered.




                                                                            Package Type
 32A                32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1               28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A             32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3               28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




           2020 Microchip Technology Inc.                                         Data Sheet Complete                                       DS40002061B-page 632
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

38.6    ATmega168PA
    Speed (MHz)(3)              Power Supply (V)               Ordering Code(2)                            Package(1)                        Operational Range
                                                               ATmega168PA-AU                              32A
                                                               ATmega168PA-AUR(5)                          32A
                                                               ATmega168PA-MMH(4)                          28M1
                                                                                                                                                   Industrial
             20                        1.8 - 5.5               ATmega168PA-MMHR(4)(5)                      28M1
                                                                                                                                                (-40C to 85C)
                                                               ATmega168PA-MU                              32M1-A
                                                               ATmega168PA-MUR(5)                          32M1-A
                                                               ATmega168PA-PU                              28P3
                                                               ATmega168PA-AN                              32A
                                                               ATmega168PA-ANR(5)                          32A
                                                                                                                                                   Industrial
             20                        1.8 - 5.5               ATmega168PA-MN                              32M1-A
                                                                                                                                               (-40C to 105C)
                                                               ATmega168PA-MNR(5)                          32M1-A
                                                               ATmega168PA-PN                              28P3
Note:   1.    This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
        2.    Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive).Also Halide free and fully Green.
        3.    See ”Speed Grades” on page 312.
        4.    NiPdAu Lead Finish.
        5.    Tape & Reel.




                                                                            Package Type
 32A                32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1               28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A             32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3               28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




           2020 Microchip Technology Inc.                                         Data Sheet Complete                                       DS40002061B-page 633
                                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

38.7       ATmega328
        Speed (MHz)               Power Supply (V)               Ordering Code(2)                            Package(1)                      Operational Range(6)
                                                                 ATmega328-AU                                32A
                                                                 ATmega328-AUR(5)                            32A
                                                                 ATmega328-MMH(4)                            28M1
                                                                                                                                                     Industrial
           20(3)                         1.8 - 5.5               ATmega328-MMHR(4)(5)                        28M1
                                                                                                                                                  (-40C to 85C)
                                                                 ATmega328-MU                                32M1-A
                                                                 ATmega328-MUR(5)                            32M1-A
                                                                 ATmega328-PU                                28P3
Note:      1.   This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
           2.   Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive).Also Halide free and fully Green.
           3.   See Figure 29-1 on page 312.
           4.   NiPdAu Lead Finish.
           5.   Tape & Reel
           6.   Use ”ATmega328P” on page 635, industrial (-40C to 105C) as the ATmega48A (-40C to 105C) is not presently offered.




                                                                              Package Type
 32A                  32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1                 28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A               32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3                 28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




            2020 Microchip Technology Inc.                                          Data Sheet Complete                                       DS40002061B-page 634
                                                               ATmega48A/PA/88A/PA/168A/PA/328/P

38.8    ATmega328P
    Speed (MHz)(3)              Power Supply (V)               Ordering Code(2)                            Package(1)                        Operational Range
                                                               ATmega328P-AU                               32A
                                                               ATmega328P-AUR(5)                           32A
                                                               ATmega328P-MMH(4)                           28M1
                                                                                                                                                   Industrial
                                                               ATmega328P-MMHR(4)(5)                       28M1
                                                                                                                                                (-40C to 85C)
                                                               ATmega328P-MU                               32M1-A
                                                               ATmega328P-MUR(5)                           32M1-A
             20                        1.8 - 5.5               ATmega328P-PU                               28P3
                                                               ATmega328P-AN                               32A
                                                               ATmega328P-ANR(5)                           32A
                                                                                                                                                   Industrial
                                                               ATmega328P-MN                               32M1-A
                                                                                                                                               (-40C to 105C)
                                                               ATmega328P-MNR(5)                           32M1-A
                                                               ATmega328P-PN                               28P3
Note:   1.    This device can also be supplied in wafer form. Contact your local Microchip sales office for detailed ordering information and minimum quantities.
        2.    Pb-free packaging complies to the European Directive for Restriction of Hazardous Substances (RoHS directive).Also Halide free and fully Green.
        3.    See Figure 29-1 on page 312.
        4.    NiPdAu Lead Finish.
        5.    Tape & Reel.




                                                                            Package Type
 32A                32-lead, (1.0 mm) Plastic Thin Quad Flat Package (TQFP)
 28M1               28-pad, 4 x 4 x 1.0 body, Lead Pitch 0.45 mm Very Thin Plastic Quad Flat No-Lead (VQFN)
 32M1-A             32-pad, 5 x 5 x 1.0 body, Lead Pitch 0.50 mm Thin Plastic Quad Flat No-Lead (VQFN)
 28P3               28-lead, 0.300” Wide, Skinny Plastic Dual Inline Package (SPDIP)




           2020 Microchip Technology Inc.                                         Data Sheet Complete                                       DS40002061B-page 635
                                                          ATmega48A/PA/88A/PA/168A/PA/328/P

39.    Packaging Information

39.1   32A
         /HDG3ODVWLF7KLQ4XDG)ODWSDFN 37 ±[[PP%RG\PP>74)3@
           1RWH     )RUWKHPRVWFXUUHQWSDFNDJHGUDZLQJVSOHDVHVHHWKH0LFURFKLS3DFNDJLQJ6SHFLILFDWLRQORFDWHGDW
                     KWWSZZZPLFURFKLSFRPSDFNDJLQJ


                                                      D
                                                D1




                      e
                                                                        E

                                                                   E1

                      b
                             N

                          NOTE 1
                                        1 2 3                          NOTE 2

                                          α
                      c                                            φ
                                                                            A2                                          A

                            β                                                                                      A1
                                                           L                            L1

                                                                        8QLWV                0,//,0(7(56
                                                            'LPHQVLRQ/LPLWV     0,1            120        0$;
                            1XPEHURI/HDGV                              1                       
                            /HDG3LWFK                                   H                    %6&
                            2YHUDOO+HLJKW                               $         ±              ±         
                            6WDQGRII                                   $                   ±         
                            0ROGHG3DFNDJH7KLFNQHVV                     $                         
                            )RRW/HQJWK                                  /                          
                            )RRWSULQW                                    /                    5()
                            )RRW$QJOH                                   I                             
                            2YHUDOO:LGWK                                (                    %6&
                            2YHUDOO/HQJWK                               '                    %6&
                            0ROGHG3DFNDJH:LGWK                         (                   %6&
                            0ROGHG3DFNDJH/HQJWK                        '                   %6&
                            /HDG7KLFNQHVV                               F                    ±         
                            /HDG:LGWK                                   E                          
                            0ROG'UDIW$QJOH7RS                         D                            
                            0ROG'UDIW$QJOH%RWWRP                      E                            
         1RWHV
          3LQYLVXDOLQGH[IHDWXUHPD\YDU\EXWPXVWEHORFDWHGZLWKLQWKHKDWFKHGDUHD
          &KDPIHUVDWFRUQHUVDUHRSWLRQDOVL]HPD\YDU\
          'LPHQVLRQV'DQG(GRQRWLQFOXGHPROGIODVKRUSURWUXVLRQV0ROGIODVKRUSURWUXVLRQVVKDOOQRWH[FHHGPPSHUVLGH
          'LPHQVLRQLQJDQGWROHUDQFLQJSHU$60(<0
                %6& %DVLF'LPHQVLRQ7KHRUHWLFDOO\H[DFWYDOXHVKRZQZLWKRXWWROHUDQFHV
                5() 5HIHUHQFH'LPHQVLRQXVXDOO\ZLWKRXWWROHUDQFHIRULQIRUPDWLRQSXUSRVHVRQO\
                                                                                                   0LFURFKLS 7HFKQRORJ\ 'UDZLQJ &%




        2020 Microchip Technology Inc.                                 Data Sheet Complete                             DS40002061B-page 636
                                        ATmega48A/PA/88A/PA/168A/PA/328/P


Note:    For the most current package drawings, please see the Microchip Packaging Specification located at
         http://www.microchip.com/packaging




 2020 Microchip Technology Inc.                      Data Sheet Complete                         DS40002061B-page 637
                                          ATmega48A/PA/88A/PA/168A/PA/328/P

39.2   28M1




        2020 Microchip Technology Inc.        Data Sheet Complete   DS40002061B-page 638
                                   ATmega48A/PA/88A/PA/168A/PA/328/P




 2020 Microchip Technology Inc.        Data Sheet Complete   DS40002061B-page 639
                                   ATmega48A/PA/88A/PA/168A/PA/328/P




 2020 Microchip Technology Inc.        Data Sheet Complete   DS40002061B-page 640
                                                    ATmega48A/PA/88A/PA/168A/PA/328/P

39.3   32M1-A
       32-Lead Thin Plastic Quad Flat, No Lead Package (S4B) - 5x5 mm Body [VQFN]
       Punch Singulated; 3.10x3.10 mm Exposed Pad
        Note:    For the most current package drawings, please see the Microchip Packaging Specification located at
                 http://www.microchip.com/packaging


                                                                                                 32X
                                                                                                       0.08 C
                                                      D                              A
                                                                                                      0.10 C
                                                               D1                         B
                    2X
                                            N
                          0.05 C


                       NOTE 1         1
                                      2


                                                                                          E

                         (DATUM B)                                                   E1
                         (DATUM A)


                  2X
                          0.10 C
                                                                                2X
                          2X
                               0.10 C
                                                    TOP VIEW                         0.05 C                                0.05
                                                                                                                           (A3)
                                                                             0.10        C A B
                                                          D2                                                    A2
                                                                                                                A
                                                                                                 SEATING        C
                                                                                                  PLANE
             0.10        C A B
                                                                                                         SIDE VIEW
                                                                                          e
                                                                                          2


                                 E2



                                      2
                                      1                                                   K


                                            N
                          L                                                 32X b
                          NOTE 1                                                0.10          C A B
                                          e 0.50
                                                                                0.05          C
                                                   BOTTOM VIEW
                                                                    Microchip Technology Drawing C04-21400 Rev A Sheet 1 of 2


       © 2019 Microchip Technology Inc.




        2020 Microchip Technology Inc.                             Data Sheet Complete                              DS40002061B-page 641
                                            ATmega48A/PA/88A/PA/168A/PA/328/P


 32-Lead Thin Plastic Quad Flat, No Lead Package (S4B) - 5x5 mm Body [VQFN]
 Punch Singulated; 3.10x3.10 mm Exposed Pad
  Note:     For the most current package drawings, please see the Microchip Packaging Specification located at
            http://www.microchip.com/packaging




                                                         Units              MILLIMETERS
                                              Dimension Limits       MIN        NOM          MAX
                         Number of Terminals              N                       32
                         Pitch                             e                  0.50 BSC
                         Overall Height                   A          0.80        0.85        1.00
                         Standoff                         A1         0.00        0.02        0.05
                         Mold Cap Thickness               A2           -         0.65        0.70
                         Terminal Thickness               A3                  0.20 REF
                         Overall Length                   D                   5.00 BSC
                         Mold Cap Length                  D1                  4.75 BSC
                         Exposed Pad Length               D2         2.95        3.10        3.25
                         Overall Width                    E                   5.00 BSC
                         Mold Cap Width                   E1                  4.75 BSC
                         Exposed Pad Width                E2         2.95        3.10        3.25
                         Terminal Width                    b         0.18        0.23        0.30
                         Terminal Length                   L         0.30        0.40        0.50
                         Terminal-to-Exposed-Pad          K          0.20          -           -
      Notes:
      1. Pin 1 visual index feature may vary, but must be located within the hatched area.
      2. Package is punch singulated
      3. Dimensioning and tolerancing per ASME Y14.5M
             BSC: Basic Dimension. Theoretically exact value shown without tolerances.
             REF: Reference Dimension, usually without tolerance, for information purposes only.


                                                              Microchip Technology Drawing C04-21400 Rev A Sheet 2 of 2


 © 2019 Microchip Technology Inc.




 2020 Microchip Technology Inc.                            Data Sheet Complete                         DS40002061B-page 642
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

 32-Lead Thin Plastic Quad Flat, No Lead Package (S4B) - 5x5 mm Body [VQFN]
 Punch Singulated; 3.10x3.10 mm Exposed Pad
  Note:     For the most current package drawings, please see the Microchip Packaging Specification located at
            http://www.microchip.com/packaging


                                                                 C1
                                                                 X2
                                                                      EV
                                                     32
                                                                                                    ØV

                                         1                                                          G2
                                         2


                          C2 Y2
                                   EV
                                                                                                           G1



                                                                                               Y1



               SILK SCREEN                                                               X1
                                                 E


                                         RECOMMENDED LAND PATTERN
                                                            Units                   MILLIMETERS
                                                 Dimension Limits          MIN          NOM         MAX
                         Contact Pitch                       E                        0.50 BSC
                         Optional Center Pad Width           X2                                     3.25
                         Optional Center Pad Length          Y2                                     3.25
                         Contact Pad Spacing                 C1                         4.90
                         Contact Pad Spacing                 C2                         4.90
                         Contact Pad Width (X32)             X1                                     0.30
                         Contact Pad Length (X32)            Y1                                     0.85
                         Contact Pad to Center Pad (X32)     G1            0.40
                         Contact Pad to Contact Pad (X28)    G2            0.20
                         Thermal Via Diameter                V                          0.33
                         Thermal Via Pitch                   EV                         0.20
      Notes:
      1. Dimensioning and tolerancing per ASME Y14.5M
              BSC: Basic Dimension. Theoretically exact value shown without tolerances.
      2. For best soldering results, thermal vias, if used, should be filled or tented to avoid solder loss during
         reflow process

                                                                                  Microchip Technology Drawing C04-23400 Rev A


 © 2019 Microchip Technology Inc.




 2020 Microchip Technology Inc.                               Data Sheet Complete                                   DS40002061B-page 643
                                                       ATmega48A/PA/88A/PA/168A/PA/328/P

39.4    28P3
       /HDG6NLQQ\3ODVWLF'XDO,Q/LQH 63 ±PLO%RG\>63',3@
         1RWH     )RUWKHPRVWFXUUHQWSDFNDJHGUDZLQJVSOHDVHVHHWKH0LFURFKLS3DFNDJLQJ6SHFLILFDWLRQORFDWHGDW
                   KWWSZZZPLFURFKLSFRPSDFNDJLQJ




                   N

        NOTE 1
                                                                                  E1


                   1    2 3

                                                 D


                                                                                                            E


          A                                                                      A2

                                                                                          L                                c

        A1                        b1
                                  b                                         e                              eB



                                                                      8QLWV                   ,1&+(6
                                                          'LPHQVLRQ/LPLWV       0,1           120           0$;
                          1XPEHURI3LQV                                1                       
                          3LWFK                                         H                     %6&
                          7RSWR6HDWLQJ3ODQH                          $          ±             ±            
                          0ROGHG3DFNDJH7KLFNQHVV                     $                             
                          %DVHWR6HDWLQJ3ODQH                        $                    ±              ±
                          6KRXOGHUWR6KRXOGHU:LGWK                    (                             
                          0ROGHG3DFNDJH:LGWK                         (                             
                          2YHUDOO/HQJWK                                '                          
                          7LSWR6HDWLQJ3ODQH                          /                             
                          /HDG7KLFNQHVV                                F                             
                          8SSHU/HDG:LGWK                             E                             
                          /RZHU/HDG:LGWK                              E                             
                          2YHUDOO5RZ6SDFLQJ                       H%          ±             ±            
       1RWHV
        3LQYLVXDOLQGH[IHDWXUHPD\YDU\EXWPXVWEHORFDWHGZLWKLQWKHKDWFKHGDUHD
        6LJQLILFDQW&KDUDFWHULVWLF
        'LPHQVLRQV'DQG(GRQRWLQFOXGHPROGIODVKRUSURWUXVLRQV0ROGIODVKRUSURWUXVLRQVVKDOOQRWH[FHHGSHUVLGH
        'LPHQVLRQLQJDQGWROHUDQFLQJSHU$60(<0
              %6& %DVLF'LPHQVLRQ7KHRUHWLFDOO\H[DFWYDOXHVKRZQZLWKRXWWROHUDQFHV

                                                                                                 0LFURFKLS 7HFKQRORJ\ 'UDZLQJ &%




          2020 Microchip Technology Inc.                               Data Sheet Complete                               DS40002061B-page 644
                                         ATmega48A/PA/88A/PA/168A/PA/328/P

40.   Errata
      The errata content has been moved to a separate document, ATmega48A/PA/88A/PA/168A/PA/328/P Silicon
      Errata and Data Sheet Clarification, located at: http://www.microchip.com/DS80000855.




       2020 Microchip Technology Inc.              Data Sheet Complete                  DS40002061B-page 645
                                                ATmega48A/PA/88A/PA/168A/PA/328/P

41.    Datasheet Revision History
       Note that the referring page numbers in this section are referred to this document. The referring revision in this
       section are referring to the document revision.

41.1   Rev. B – 09/2020
       Content based on 8271J. The following items list the changes from 8271J to DS40002061B:
 1.    Updated Package Information to Microchip style.
 2.    Updated Ordering Information.
 3.    Errata has been moved to separate document.
 4.    Removed footnote regarding interrupt modes for INT0 and INT1.
       Updated "Reset and Interrupt Vectors in ATmega48A and ATmega48PA", “Reset and Interrupt Vectors in
 5.    ATmega88A and ATmega88PA”, "Reset and Interrupt Vectors in ATmega168A and ATmega168PA" and
       "Reset and Interrupt Vectors in ATmega328 and ATmega328P" tables.
       Updated "8-bit Timer/Counter Block Diagram" in "8-bit Timer/Counter2 with PWM and Asynchronous
 6.
       Operation" section.
 7.    Updated "Analog to Digital Converter Block Schematic Operation" figure.
       Analog Comparator Input Offset Voltage updated in "Common DC characteristics TA = -40C to 105C, VCC =
 8.
       1.8V to 5.5V (unless otherwise noted)" table.


41.2   Rev. A – 10/2018
 1.    Updated the document to Microchip style.

 2.    New Microchip document number. Previous version was Atmel document 8271 rev. J.


41.3   Rev. 8271J – 11/2015
 1.    Updated errata sections:
       ”Errata” on page 645
       ”Errata” on page 645
       ”Errata” on page 645
       ”Errata” on page 645
       ”Errata” on page 645
       ”Errata” on page 645
       ”Errata” on page 645
       ”Errata” on page 645

41.4   Rev. 8271I – 10/2014
 1.    Several headings have been corrected and electrical characteristics for 105°C have been structured.




        2020 Microchip Technology Inc.                       Data Sheet Complete                            DS40002061B-page 646
                                                 ATmega48A/PA/88A/PA/168A/PA/328/P

41.5   Rev. 8271H – 08/2014
 1.     Updated text in section Section 16.9.3 ”Fast PWM Mode” on page 132 concerning compare units allowing
        generation of PWM waveforms (on page 126), referring to table 16-2.
 2.     Updated WDT Assembly code example in Section 10.10.5 ”Watchdog Timer” on page 52 (and onwards)
 3.     Updated footnote 1 for tables giving DC Characteristics in ”ATmega48PA DC Characteristics – Current
        Consumption” on page 324, ”ATmega88PA DC Characteristics – Current Consumption” on page 324,
        ”ATmega168PA DC Characteristics – Current Consumption” on page 325 and ”ATmega328P DC Characteristics –
        Current Consumption” on page 325.
 4.     Figure 31-1 on page 327 has been updated with the correct plot.
 5.     Figure 31-333 on page 502 has been updated with the correct plot.
 6.     Changed description of external interrupt behavior in deep sleep in Section 13. ”External Interrupts” on page 79.
 7.     Added wait delay for tWD_FUSE in Table 28-18 on page 305.
 7.     Updated errata for rev A of 48PA and 88PA in Section 40. on page 645 and Section 40. on page 645.
 8.     Updated back page and footer according to datasheet template of 05/2014

41.6   Rev. 8271G – 02/2013
 1.     Added ”Electrical Characteristics (TA = -40°C to 105°C)” on page 322.
 2.     Added ”ATmega48PA Typical Characteristics – (TA = -40°C to 105°C)” on page 526.
 3.     Added ”ATmega88PA Typical Characteristics – (TA = -40°C to 105°C)” on page 549.
 4.     Added ”ATmega168PA Typical Characteristics – (TA = -40°C to 105°C)” on page 572.
 5.     Added ”ATmega328P Typical Characteristics – (TA = -40°C to 105°C)” on page 597.

41.7   Rev. 8271F – 08/2012
 1.     Added ”DC Characteristics” on page 308. The following tables for DC characteristics - TA = -40C to 105C added:
        Table 29-2 on page 309
        Table 30-3 on page 324
        Table 30-4 on page 325
        Table 30-5 on page 325
 2.     Replaced the following typical characteristics by the plots that include les characteristics at “TA = -40C to 105C”:
        ”ATmega48PA Typical Characteristics” on page 352
        ”ATmega88PA Typical Characteristics” on page 401
        ”ATmega168PA Typical Characteristics” on page 451
        ”ATmega328P Typical Characteristics” on page 501
 3.     Removed the Power Save (Psave) maximum numbers for all devices throughout ”Electrical Characteristics – (TA =
        -40°C to 85°C)” on page 308.
 4.     Changed the powerdown maximum numbers from 8.5 and 3µA to 10 and 5µA (ATmega48PA, ATmega88PA,
        ATmega168PA and ATmega328P).
 5.     Changed the table note “Maximum values are characterized values and not test limits in production” to “Max values
        are test limits in production throughout ”Electrical Characteristics – (TA = -40°C to 85°C)” on page 308.

41.8   Rev. 8271E – 07/2012
 1.     Updated Figure 1-1 on page 12. Overlined “RESET” in 28 MLF top view and in 32 MLF top view.
 2.     Added EEAR9 bit to the ”EEARH and EEARL – The EEPROM Address Register” on page 31 and updated the all bit
        descriptions accordingly.
 3.     Added a footnote “EEAR9 and EEAR8 are unused bits in ATmega48A/48PA and must always be written to zero” to
        ”EEARH and EEARL – The EEPROM Address Register” on page 31.
 4.     Updated Table 18-8 on page 164, “Waveform Generation Mode Bit Description” . WGM2, WGM1 and WGM0
        changed to WGM22, WGM21 and WGM20 respectively.
 5.     Updated ”TCCR2B – Timer/Counter Control Register B” on page 165. bit 2 (CS22) and bit 3 (WGM22) changed
        from R (read only) to R/W (read/write).




        2020 Microchip Technology Inc.                          Data Sheet Complete                           DS40002061B-page 647
                                              ATmega48A/PA/88A/PA/168A/PA/328/P

 6.     Updated the definition of fosc on page 181. fosc is the system clock frequency (not XTAL pin frequency)
 7.     Updated ”SPMCSR – Store Program Memory Control and Status Register” on page 270. Bit 0 renamed SPMEN
        and added bit 5 “SIGRD”.
 8.     Replaced “SELFPRGEN” by “SPMEN” throughout the whole datasheet including in the “code examples”, except in
        ”Program And Data Memory Lock Bits” on page 289 and in ”Fuse Bits” on page 290.
 9.     Updated ”Register Summary” on page 621 to include the bits: SIGRD and SPMEN in the SMPCSR register.
 10.    Updated the Table 30-1 on page 322. Removed the footnote.
 11.    Updated the footnote of the Table 29-13 on page 315. Removed the footnote “Note 2”.
 12.    Updated ”Errata” on page 645. Added “Errata” TWI Data setup time can be too short.

41.9   Rev. 8271D – 05/11
 1.     Added Atmel QTouch Sensing Capability Feature
 2.     Updated ”Register Description” on page 100 with PINxn as R/W.
 3.     Added a footnote to the PINxn, page 100.
 4.     Updated “Ordering Information”,”ATmega328” on page 634. Added “ATmega328-MMH” and “ATmega328-MMHR”.
 5.     Updated “Ordering Information”,”ATmega328P” on page 635. Added “ATmega328P-MMH” and “ATmega328P-
        MMHR”.
 6.     Added “Ordering Information” for ATmega48PA/88PA/168PA/328P @ 105C
 7.     Updated ”Errata” on page 645 and ”Errata” on page 645
 8.     Updated the datasheet according to the Atmel new brand style guide.

41.10 Rev. 8271C – 08/10
 1.     Added 32UFBGA Pinout, Table 1-1 on page 12.
 2.     Updated the “SRAM Data Memory”, Figure 8-3 on page 28.
 3.     Updated ”Ordering Information” on page 628 with CCU and CCUR code related to “32CC1” Package drawing.
 4.     “32CC1” Package drawing added ”Packaging Information” on page 636.

41.11 Rev. 8271B – 04/10
 1.     Updated Table 9-8 with correct value for timer oscillator at xtal2/tos2
 2.     Corrected use of SBIS instructions in assembly code examples.
 3.     Corrected BOD and BODSE bits to R/W in Section 10.11.2 on page 54, Section 12.5 on page 77 and Section 14.4
        on page 100
 4.     Figures for bandgap characterization added, Figure 31-34 on page 344, Figure 31-81 on page 369, Figure 31-128
        on page 394, Figure 31-176 on page 420, Figure 31-223 on page 444, Figure 31-271 on page 470, Figure 31-318
        on page 494 and Figure 31-365 on page 519.
 5.     Updated ”Packaging Information” on page 636 by replacing 28M1 with a correct corresponding package.




        2020 Microchip Technology Inc.                      Data Sheet Complete                       DS40002061B-page 648
                                                     ATmega48A/PA/88A/PA/168A/PA/328/P

41.12 Rev. 8271A – 12/09
 1.    New datasheet 8271 with merged information for ATmega48PA, ATmega88PA, ATmega168PA and ATmega48A,
       ATmega88A andATmega168A. Also included information on ATmega328 and ATmega328P
 2     Changes done:
                ̶           New devices added: ATmega48A/ATmega88A/ATmega168A and ATmega328
                ̶           Updated Feature Description
                ̶           Updated Table 2-1 on page 16
                ̶           Added note for BOD Disable on page 49.
                    ̶       Added note on BOD and BODSE in ”MCUCR – MCU Control Register” on page 100 and ”Register
                            Description” on page 287
                        ̶   Added limitation information for the application ”Boot Loader Support – Read-While-Write Self-
                            Programming” on page 272
                        ̶   Added limitation information for ”Program And Data Memory Lock Bits” on page 289
                        ̶   Added specified DC characteristics
                        ̶   Added typical characteristics
                        ̶   Removed exception information in ”Address Match Unit” on page 222.




       2020 Microchip Technology Inc.                              Data Sheet Complete                       DS40002061B-page 649
                      ATmega48/PA/88A/PA/168A/PA/328/P
DEVELOPMENT SUPPORT
Move a design from concept to production in record time with Microchip’s award-winning development tools. Microchip
tools work together to provide state of the art debugging for any project with easy-to-use Graphical User Interfaces (GUIs)
in our free MPLAB® X and Atmel Studio Integrated Development Environments (IDEs), and our code generation tools.
Providing the ultimate ease-of-use experience, Microchip’s line of programmers, debuggers and emulators work
seamlessly with our software tools. Microchip development boards help evaluate the best silicon device for an application,
while our line of third party tools round out our comprehensive development tool solutions.
Microchip’s MPLAB X and Atmel Studio ecosystems provide a variety of embedded design tools to consider, which sup-
port multiple devices, such as PIC® MCUs, AVR® MCUs, SAM MCUs and dsPIC® DSCs. MPLAB X tools are compatible
with Windows®, Linux® and Mac® operating systems while Atmel Studio tools are compatible with Windows.
Go to the following website for more information and details:
https://www.microchip.com/development-tools/




 2020 Microchip Technology Inc.             Data Sheet Complete                                   DS40002061B-page 650
                      ATmega48/PA/88A/PA/168A/PA/328/P
THE MICROCHIP WEBSITE                                       CUSTOMER SUPPORT
Microchip provides online support via our WWW site at       Users of Microchip products can receive assistance
www.microchip.com. This website is used as a means          through several channels:
to make files and information easily available to           •   Distributor or Representative
customers. Accessible by using your favorite Internet
                                                            •   Local Sales Office
browser, the website contains the following information:
                                                            •   Field Application Engineer (FAE)
• Product Support – Data sheets and errata,
                                                            •   Technical Support
  application notes and sample programs, design
  resources, user’s guides and hardware support             Customers      should     contact   their   distributor,
  documents, latest software releases and archived          representative or Field Application Engineer (FAE) for
  software                                                  support. Local sales offices are also available to help
• General Technical Support – Frequently Asked              customers. A listing of sales offices and locations is
  Questions (FAQ), technical support requests,              included in the back of this document.
  online discussion groups, Microchip consultant            Technical support is available through the website
  program member listing                                    at: http://microchip.com/support
• Business of Microchip – Product selector and
  ordering guides, latest Microchip press releases,
  listing of seminars and events, listings of
  Microchip sales offices, distributors and factory
  representatives

CUSTOMER CHANGE NOTIFICATION
SERVICE
Microchip’s customer notification service helps keep
customers current on Microchip products. Subscribers
will receive e-mail notification whenever there are
changes, updates, revisions or errata related to a
specified product family or development tool of interest.
To register, access the Microchip website at
www.microchip.com. Under “Support”, click on
“Customer Change Notification” and follow the
registration instructions.




 2020 Microchip Technology Inc.                                                             DS40002061B-page 651
Note the following details of the code protection feature on Microchip devices:
•    Microchip products meet the specifications contained in their particular Microchip Data Sheet.

•    Microchip believes that its family of products is secure when used in the intended manner and under normal conditions.

•    There are dishonest and possibly illegal methods being used in attempts to breach the code protection features of the Microchip
     devices. We believe that these methods require using the Microchip products in a manner outside the operating specifications
     contained in Microchip's Data Sheets. Attempts to breach these code protection features, most likely, cannot be accomplished
     without violating Microchip's intellectual property rights.

•    Microchip is willing to work with any customer who is concerned about the integrity of its code.

•    Neither Microchip nor any other semiconductor manufacturer can guarantee the security of its code. Code protection does not
     mean that we are guaranteeing the product is "unbreakable." Code protection is constantly evolving. We at Microchip are
     committed to continuously improving the code protection features of our products. Attempts to break Microchip's code protection
     feature may be a violation of the Digital Millennium Copyright Act. If such acts allow unauthorized access to your software or
     other copyrighted work, you may have a right to sue for relief under that Act.




Information contained in this publication is provided for the sole      Trademarks
purpose of designing with and using Microchip products. Infor-          The Microchip name and logo, the Microchip logo, Adaptec,
mation regarding device applications and the like is provided           AnyRate, AVR, AVR logo, AVR Freaks, BesTime, BitCloud, chipKIT,
only for your convenience and may be superseded by updates.             chipKIT logo, CryptoMemory, CryptoRF, dsPIC, FlashFlex,
                                                                        flexPWR, HELDO, IGLOO, JukeBlox, KeeLoq, Kleer, LANCheck,
It is your responsibility to ensure that your application meets         LinkMD, maXStylus, maXTouch, MediaLB, megaAVR, Microsemi,
with your specifications.                                               Microsemi logo, MOST, MOST logo, MPLAB, OptoLyzer,
                                                                        PackeTime, PIC, picoPower, PICSTART, PIC32 logo, PolarFire,
THIS INFORMATION IS PROVIDED BY MICROCHIP "AS IS".                      Prochip Designer, QTouch, SAM-BA, SenGenuity, SpyNIC, SST,
MICROCHIP MAKES NO REPRESENTATIONS OR WAR-                              SST Logo, SuperFlash, Symmetricom, SyncServer, Tachyon,
RANTIES OF ANY KIND WHETHER EXPRESS OR IMPLIED,                         TempTrackr, TimeSource, tinyAVR, UNI/O, Vectron, and XMEGA
                                                                        are registered trademarks of Microchip Technology Incorporated in
WRITTEN OR ORAL, STATUTORY OR OTHERWISE,                                the U.S.A. and other countries.
RELATED TO THE INFORMATION INCLUDING BUT NOT
LIMITED TO ANY IMPLIED WARRANTIES OF NON-                               APT, ClockWorks, The Embedded Control Solutions Company,
INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A                        EtherSynch, FlashTec, Hyper Speed Control, HyperLight Load,
PARTICULAR PURPOSE OR WARRANTIES RELATED TO                             IntelliMOS, Libero, motorBench, mTouch, Powermite 3, Precision
                                                                        Edge, ProASIC, ProASIC Plus, ProASIC Plus logo, Quiet-Wire,
ITS CONDITION, QUALITY, OR PERFORMANCE.                                 SmartFusion, SyncWorld, Temux, TimeCesium, TimeHub,
                                                                        TimePictra, TimeProvider, Vite, WinPath, and ZL are registered
IN NO EVENT WILL MICROCHIP BE LIABLE FOR ANY INDI-                      trademarks of Microchip Technology Incorporated in the U.S.A.
RECT, SPECIAL, PUNITIVE, INCIDENTAL OR CONSEQUEN-
TIAL LOSS, DAMAGE, COST OR EXPENSE OF ANY KIND                          Adjacent Key Suppression, AKS, Analog-for-the-Digital Age, Any
WHATSOEVER RELATED TO THE INFORMATION OR ITS                            Capacitor, AnyIn, AnyOut, BlueSky, BodyCom, CodeGuard,
                                                                        CryptoAuthentication, CryptoAutomotive, CryptoCompanion,
USE, HOWEVER CAUSED, EVEN IF MICROCHIP HAS
                                                                        CryptoController, dsPICDEM, dsPICDEM.net, Dynamic Average
BEEN ADVISED OF THE POSSIBILITY OR THE DAMAGES                          Matching, DAM, ECAN, EtherGREEN, In-Circuit Serial
ARE FORESEEABLE. TO THE FULLEST EXTENT                                  Programming, ICSP, INICnet, Inter-Chip Connectivity, JitterBlocker,
ALLOWED BY LAW, MICROCHIP'S TOTAL LIABILITY ON                          KleerNet, KleerNet logo, memBrain, Mindi, MiWi, MPASM, MPF,
ALL CLAIMS IN ANY WAY RELATED TO THE INFORMATION                        MPLAB Certified logo, MPLIB, MPLINK, MultiTRAK, NetDetach,
                                                                        Omniscient Code Generation, PICDEM, PICDEM.net, PICkit,
OR ITS USE WILL NOT EXCEED THE AMOUNT OF FEES, IF                       PICtail, PowerSmart, PureSilicon, QMatrix, REAL ICE, Ripple
ANY, THAT YOU HAVE PAID DIRECTLY TO MICROCHIP                           Blocker, SAM-ICE, Serial Quad I/O, SMART-I.S., SQI,
FOR THE INFORMATION. Use of Microchip devices in life sup-              SuperSwitcher, SuperSwitcher II, Total Endurance, TSHARC,
port and/or safety applications is entirely at the buyer's risk, and    USBCheck, VariSense, ViewSpan, WiperLock, Wireless DNA, and
the buyer agrees to defend, indemnify and hold harmless                 ZENA are trademarks of Microchip Technology Incorporated in the
                                                                        U.S.A. and other countries.
Microchip from any and all damages, claims, suits, or expenses
resulting from such use. No licenses are conveyed, implicitly or        SQTP is a service mark of Microchip Technology Incorporated in
otherwise, under any Microchip intellectual property rights             the U.S.A.
unless otherwise stated.                                                The Adaptec logo, Frequency on Demand, Silicon Storage
                                                                        Technology, and Symmcom are registered trademarks of Microchip
                                                                        Technology Inc. in other countries.
                                                                        GestIC is a registered trademark of Microchip Technology Germany
                                                                        II GmbH & Co. KG, a subsidiary of Microchip Technology Inc., in
                                                                        other countries.
                                                                        All other trademarks mentioned herein are property of their
                                                                        respective companies.

                                                                        © 2020, Microchip Technology Incorporated, All Rights Reserved.

For information regarding Microchip’s Quality Management Systems,       ISBN: ISBN: 978-1-5224-6294-1
please visit www.microchip.com/quality.




 2020 Microchip Technology Inc.                                                                               DS40002061B-page 652
                            Worldwide Sales and Service
AMERICAS                    ASIA/PACIFIC            ASIA/PACIFIC                  EUROPE
Corporate Office            Australia - Sydney      India - Bangalore             Austria - Wels
2355 West Chandler Blvd.    Tel: 61-2-9868-6733     Tel: 91-80-3090-4444          Tel: 43-7242-2244-39
Chandler, AZ 85224-6199     China - Beijing         India - New Delhi             Fax: 43-7242-2244-393
Tel: 480-792-7200           Tel: 86-10-8569-7000    Tel: 91-11-4160-8631          Denmark - Copenhagen
Fax: 480-792-7277                                                                 Tel: 45-4450-2828
                            China - Chengdu         India - Pune
Technical Support:                                                                Fax: 45-4485-2829
                            Tel: 86-28-8665-5511    Tel: 91-20-4121-0141
http://www.microchip.com/
                            China - Chongqing       Japan - Osaka                 Finland - Espoo
support                                                                           Tel: 358-9-4520-820
Web Address:                Tel: 86-23-8980-9588    Tel: 81-6-6152-7160
www.microchip.com           China - Dongguan        Japan - Tokyo                 France - Paris
                            Tel: 86-769-8702-9880   Tel: 81-3-6880- 3770          Tel: 33-1-69-53-63-20
Atlanta                                                                           Fax: 33-1-69-30-90-79
Duluth, GA                  China - Guangzhou       Korea - Daegu
Tel: 678-957-9614           Tel: 86-20-8755-8029    Tel: 82-53-744-4301           Germany - Garching
                                                                                  Tel: 49-8931-9700
Fax: 678-957-1455           China - Hangzhou        Korea - Seoul
                            Tel: 86-571-8792-8115   Tel: 82-2-554-7200            Germany - Haan
Austin, TX
                                                                                  Tel: 49-2129-3766400
Tel: 512-257-3370           China - Hong Kong SAR   Malaysia - Kuala Lumpur
                            Tel: 852-2943-5100      Tel: 60-3-7651-7906           Germany - Heilbronn
Boston
                                                                                  Tel: 49-7131-72400
Westborough, MA             China - Nanjing         Malaysia - Penang
Tel: 774-760-0087           Tel: 86-25-8473-2460    Tel: 60-4-227-8870            Germany - Karlsruhe
Fax: 774-760-0088                                                                 Tel: 49-721-625370
                            China - Qingdao         Philippines - Manila
Chicago                     Tel: 86-532-8502-7355   Tel: 63-2-634-9065            Germany - Munich
Itasca, IL                                                                        Tel: 49-89-627-144-0
                            China - Shanghai        Singapore
Tel: 630-285-0071                                                                 Fax: 49-89-627-144-44
                            Tel: 86-21-3326-8000    Tel: 65-6334-8870
Fax: 630-285-0075                                                                 Germany - Rosenheim
                            China - Shenyang        Taiwan - Hsin Chu
Dallas                      Tel: 86-24-2334-2829    Tel: 886-3-577-8366           Tel: 49-8031-354-560
Addison, TX                                                                       Israel - Ra’anana
                            China - Shenzhen        Taiwan - Kaohsiung
Tel: 972-818-7423                                                                 Tel: 972-9-744-7705
                            Tel: 86-755-8864-2200   Tel: 886-7-213-7830
Fax: 972-818-2924                                                                 Italy - Milan
                            China - Suzhou          Taiwan - Taipei
Detroit                                                                           Tel: 39-0331-742611
                            Tel: 86-186-6233-1526   Tel: 886-2-2508-8600
Novi, MI                                                                          Fax: 39-0331-466781
Tel: 248-848-4000           China - Wuhan           Thailand - Bangkok
                            Tel: 86-27-5980-5300    Tel: 66-2-694-1351            Italy - Padova
Houston, TX                                                                       Tel: 39-049-7625286
Tel: 281-894-5983           China - Xian            Vietnam - Ho Chi Minh
                            Tel: 86-29-8833-7252    Tel: 84-28-5448-2100          Netherlands - Drunen
Indianapolis                                                                      Tel: 31-416-690399
Noblesville, IN             China - Xiamen                                        Fax: 31-416-690340
Tel: 317-773-8323           Tel: 86-592-2388138
                                                                                  Norway - Trondheim
Fax: 317-773-5453           China - Zhuhai                                        Tel: 47-7288-4388
Tel: 317-536-2380           Tel: 86-756-3210040
                                                                                  Poland - Warsaw
Los Angeles                                                                       Tel: 48-22-3325737
Mission Viejo, CA
                                                                                  Romania - Bucharest
Tel: 949-462-9523
                                                                                  Tel: 40-21-407-87-50
Fax: 949-462-9608
Tel: 951-273-7800                                                                 Spain - Madrid
                                                                                  Tel: 34-91-708-08-90
Raleigh, NC                                                                       Fax: 34-91-708-08-91
Tel: 919-844-7510
                                                                                  Sweden - Gothenberg
New York, NY                                                                      Tel: 46-31-704-60-40
Tel: 631-435-6000
                                                                                  Sweden - Stockholm
San Jose, CA                                                                      Tel: 46-8-5090-4654
Tel: 408-735-9110
Tel: 408-436-4270                                                                 UK - Wokingham
                                                                                  Tel: 44-118-921-5800
Canada - Toronto                                                                  Fax: 44-118-921-5820
Tel: 905-695-1980
Fax: 905-695-2078




DS40002061B-page 653                                                           2020 Microchip Technology Inc.
                                                                                                        05/14/19
